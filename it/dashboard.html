<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Riepilogo — MyHomesBudget</title>
  <meta name="description" content="Riepilogo finanziario fullscreen con grafici a 12 mesi.">
  <meta name="robots" content="noindex, nofollow">
  <meta name="color-scheme" content="light dark">

  <!-- CSP allineata: aggiungi solo esm.sh e *.supabase.* -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          img-src 'self' https: data:;
          style-src 'self' 'unsafe-inline';
          script-src 'self' 'unsafe-inline' https://esm.sh https://www.googletagmanager.com https://www.google-analytics.com;
          connect-src 'self' https://*.supabase.co https://*.supabase.in https://www.google-analytics.com https://region1.google-analytics.com;
          font-src 'self' https: data:;
          frame-ancestors 'none';
          base-uri 'self';
          form-action 'self'">

  <!-- (opzionale) GA4, come in index -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-LSD3V9G957"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date()); gtag('config', 'G-LSD3V9G957', { anonymize_ip: true });
  </script>

  <link rel="preload" href="/bg.webp" as="image">
  <link rel="icon" href="/favicon.ico">

  <style>
    :root{
      font-family:-apple-system,system-ui,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      --card-border: rgba(0,0,0,.06);
      --ink:#0f1220; --ink-soft:#4d5566;
      --glass: rgba(255,255,255,.58);
      --chip: rgba(255,255,255,.72);
    }
    *{ box-sizing:border-box }
    body{ margin:0; color:var(--ink); background:url("/bg.webp") no-repeat center/cover fixed; }
    body::before{ content:""; position:fixed; inset:0; background:rgba(0,0,0,.08); z-index:-1 }

    /* TOPBAR vetro */
    .topbar{
      position:fixed; top:16px; left:50%; transform:translateX(-50%);
      width:min(1200px,calc(100% - 40px)); z-index:50; pointer-events:none;
      display:flex; align-items:center; justify-content:space-between;
    }
    .logo-link,.top-actions{ pointer-events:auto }
    .logo-link{ display:flex; align-items:center; gap:10px; text-decoration:none }
    .logo-image{ height:32px }
    .logo-text{ font-weight:700; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.35) }
    .top-actions{ display:flex; gap:8px; align-items:center }
    .chip{ background:var(--chip); border:1px solid var(--card-border);
      backdrop-filter:saturate(1.1) blur(6px); -webkit-backdrop-filter:saturate(1.1) blur(3px);
      color:var(--ink); padding:8px 12px; border-radius:12px; font-weight:800; box-shadow:0 8px 24px rgba(0,0,0,.08); }
    .chip.btn{ cursor:pointer; text-decoration:none }
    .chip.btn:hover{ filter:brightness(1.04) }

    /* Layout fullscreen */
    .wrap{ width:min(1200px,calc(100% - 40px)); margin:110px auto 30px auto; display:grid; gap:14px; }
    .grid{ display:grid; gap:14px; grid-template-columns: 1.3fr .7fr; }
    @media (max-width: 1100px){ .grid{ grid-template-columns:1fr } }

    .card{
      background:var(--glass);
      backdrop-filter:saturate(1.1) blur(6px); -webkit-backdrop-filter:saturate(1.1) blur(3px);
      border:1px solid var(--card-border); border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.08);
    }
    .card h2,.card h3{ margin:0 0 8px 0 } .muted{ color:var(--ink-soft) }

    /* KPI pills */
    .kpi{ display:grid; grid-template-columns: repeat(4,1fr); gap:10px }
    @media (max-width: 1100px){ .kpi{ grid-template-columns: repeat(2,1fr) } }
    .pill{ background:rgba(255,255,255,.9); border:1px solid var(--card-border); padding:12px 14px; border-radius:12px; font-weight:900; display:flex; justify-content:space-between; align-items:center; }
    .val{ font-variant-numeric: tabular-nums; }
    .pulse{ animation:pulse .6s ease } @keyframes pulse{0%{transform:scale(1)}45%{transform:scale(1.03)}100%{transform:scale(1)}}

    /* Canvas wrapper: altezza responsiva */
    .h300{ height:300px } .h360{ height:360px } .h240{ height:240px }
  </style>
</head>
<body>
  <!-- TOPBAR -->
  <nav class="topbar">
    <a href="/it/" class="logo-link">
      <img src="/homes.png" alt="Logo" class="logo-image" loading="lazy"><span class="logo-text">MyHomesBudget</span>
    </a>
    <div class="top-actions">
      <select class="chip" id="monthPicker" aria-label="Mese focus"></select>
      <a class="chip btn" href="/it/dashboard.html">Operazioni</a>
      <a class="chip btn" href="/it/dashboard-riepilogo.html">Riepilogo</a>
      <a class="chip btn" href="/it/logout.html">Esci</a>
    </div>
  </nav>

  <main class="wrap">
    <!-- KPI -->
    <section class="card">
      <h2>Riepilogo 12 mesi</h2>
      <p class="muted" id="subtitle">Dinamica mensile da <span id="fromYM"></span> a <span id="toYM"></span></p>
      <div class="kpi" style="margin-top:8px">
        <div class="pill"><span>Entrate (12m)</span><span class="val" id="kIn">€ 0</span></div>
        <div class="pill"><span>Uscite (12m)</span><span class="val" id="kOut">€ 0</span></div>
        <div class="pill"><span>Saldo (12m)</span><span class="val" id="kSaldo">€ 0</span></div>
        <div class="pill"><span>Media Uscite</span><span class="val" id="kAvgOut">€ 0</span></div>
      </div>
    </section>

    <section class="grid">
      <!-- col sx -->
      <section class="card">
        <h3>Trend Entrate/Uscite (12 mesi)</h3>
        <div class="h360"><canvas id="chartTrend"></canvas></div>
      </section>

      <!-- col dx -->
      <aside class="card">
        <h3>Composizione mese selezionato</h3>
        <p class="muted" id="monthTitle">Mese: —</p>
        <div class="h300"><canvas id="chartDonut"></canvas></div>
      </aside>
    </section>

    <section class="grid">
      <section class="card">
        <h3>Saldo mensile</h3>
        <div class="h300"><canvas id="chartSaldo"></canvas></div>
      </section>
      <aside class="card">
        <h3>Top categorie (12 mesi)</h3>
        <div class="h300"><canvas id="chartTopCat"></canvas></div>
      </aside>
    </section>
  </main>

  <script type="module">
    /* ============ CONFIG ============ */
    const CONFIG = {
      SUPABASE_URL: 'YOUR_SUPABASE_URL',
      SUPABASE_ANON_KEY: 'YOUR_SUPABASE_ANON_KEY',
      LOGIN_URL: '/it/login.html',

      // TABELLE
      TABLE_TX: 'transactions',
      TABLE_CATS: 'categories',

      // MAP COLONNE (adattabile ai tuoi nomi)
      COL: {
        tx_id: 'id',
        tx_user: 'user_id',
        tx_date: ['occurred_at','date','when'],
        tx_kind: ['kind','type'],         // 'income' | 'expense' (eventuali 'transfer' vengono ignorati)
        tx_cat: 'category_id',
        tx_sub: 'subcategory_id',
        tx_note: ['note','description'],
        tx_amt: 'amount',

        cat_id: 'id',
        cat_user: 'user_id',
        cat_name: 'name',
        cat_kind: 'kind'
      }
    };

    /* ============ Imports ============ */
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    import Chart from "https://esm.sh/chart.js@4.4.4/auto";

    /* ============ Setup & utils ============ */
    const supabase = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
    const $ = s => document.querySelector(s);
    const fmt = new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR',maximumFractionDigits:2});
    const monthLabel = (ym)=> new Date(ym+'-01').toLocaleDateString('it-IT',{month:'short',year:'numeric'});
    const pick = (row, key)=> {
      const m = CONFIG.COL[key];
      if (Array.isArray(m)) { for (const k of m) if (row && row[k] !== undefined) return row[k]; return undefined; }
      return row ? row[m] : undefined;
    };
    const todayYM = ()=> new Date().toISOString().slice(0,7);
    const addMonths = (ym, delta)=> { const d=new Date(ym+'-01'); d.setMonth(d.getMonth()+delta); return d.toISOString().slice(0,7); };

    // Dom refs
    const el = {
      mp: $('#monthPicker'), fromYM: $('#fromYM'), toYM: $('#toYM'),
      kIn: $('#kIn'), kOut: $('#kOut'), kSaldo: $('#kSaldo'), kAvgOut: $('#kAvgOut'),
      monthTitle: $('#monthTitle')
    };

    // Auth
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) { location.href = CONFIG.LOGIN_URL; throw new Error('Not authenticated'); }
    const USER_ID = user.id;

    // State
    const state = {
      focusYM: (new URLSearchParams(location.search).get('m')) || todayYM(),
      months: [],   // ultimi 12 YM
      tx: [],       // transazioni 12m
      cats: new Map(), // cat_id -> {name,kind}
      rt: null,
      charts: {}
    };

    // Mesi dropdown
    (function initMonths(){
      const now = new Date();
      el.mp.innerHTML = '';
      for (let i=0;i<18;i++){ // 18 per piacere d'uso
        const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
        const ym = d.toISOString().slice(0,7);
        const opt = document.createElement('option'); opt.value=ym; opt.textContent=monthLabel(ym);
        el.mp.appendChild(opt);
      }
      el.mp.value = state.focusYM;
      const from = addMonths(state.focusYM, -11);
      state.months = Array.from({length:12}, (_,i)=> addMonths(from, i));
      el.fromYM.textContent = monthLabel(from);
      el.toYM.textContent   = monthLabel(state.focusYM);
      $('#monthTitle').textContent = 'Mese: ' + monthLabel(state.focusYM);
    })();

    /* ============ Load cataloghi ============ */
    async function loadCategories(){
      const { data } = await supabase.from(CONFIG.TABLE_CATS)
        .select([CONFIG.COL.cat_id,CONFIG.COL.cat_user,CONFIG.COL.cat_name,CONFIG.COL.cat_kind].join(','))
        .eq(CONFIG.COL.cat_user, USER_ID);
      state.cats.clear();
      (data||[]).forEach(c=> state.cats.set(c[CONFIG.COL.cat_id], {name:c[CONFIG.COL.cat_name], kind:(c[CONFIG.COL.cat_kind]||'').toLowerCase()}));
    }

    /* ============ Load transazioni 12m ============ */
    async function loadTx(){
      const start = addMonths(state.focusYM, -11) + '-01';
      const end   = addMonths(state.focusYM, 1) + '-01'; // esclusivo
      const dateCol = Array.isArray(CONFIG.COL.tx_date)?CONFIG.COL.tx_date[0]:CONFIG.COL.tx_date;
      const kindCol = Array.isArray(CONFIG.COL.tx_kind)?CONFIG.COL.tx_kind[0]:CONFIG.COL.tx_kind;

      const sel = [CONFIG.COL.tx_id, CONFIG.COL.tx_user, dateCol, kindCol, CONFIG.COL.tx_cat, CONFIG.COL.tx_amt].join(',');
      const { data, error } = await supabase
        .from(CONFIG.TABLE_TX)
        .select(sel)
        .eq(CONFIG.COL.tx_user, USER_ID)
        .gte(dateCol, start).lt(dateCol, end)
        .order(dateCol, { ascending:true });
      if (error){ console.error(error); return; }

      // Normalizza e filtra eventuali 'transfer'
      state.tx = (data||[])
        .map(r=>({
          id: r[CONFIG.COL.tx_id],
          ym: (r[dateCol]||'').slice(0,7),
          kind: (r[kindCol]||'').toLowerCase(),
          cat: r[CONFIG.COL.tx_cat],
          amt: Number(r[CONFIG.COL.tx_amt]||0)
        }))
        .filter(t => t.kind==='income' || t.kind==='expense');
    }

    /* ============ Compute series ============ */
    function series12m(){
      const byYM = new Map(state.months.map(m=>[m,{in:0,out:0,cat:new Map()}]));
      for (const t of state.tx){
        const b = byYM.get(t.ym); if (!b) continue;
        if (t.kind==='income') b.in += t.amt; else b.out += t.amt;
        if (t.kind==='expense'){
          const nm = state.cats.get(t.cat)?.name || '—';
          b.cat.set(nm, (b.cat.get(nm)||0) + t.amt);
        }
      }
      const labels = state.months.map(monthLabel);
      const inc = state.months.map(m=> byYM.get(m).in);
      const out = state.months.map(m=> byYM.get(m).out);
      const saldo = state.months.map((_,i)=> inc[i]-out[i]);

      // Top categorie globali su 12m
      const aggCat = {};
      for (const m of state.months){
        for (const [nm,val] of byYM.get(m).cat.entries()){
          aggCat[nm]=(aggCat[nm]||0)+val;
        }
      }
      const top = Object.entries(aggCat).sort((a,b)=>b[1]-a[1]).slice(0,6);

      // Donut mese focus
      const catMonth = byYM.get(state.focusYM);
      const donut = catMonth ? Array.from(catMonth.cat.entries()).sort((a,b)=>b[1]-a[1]).slice(0,8) : [];

      // KPI
      const sum = a=> a.reduce((s,x)=>s+x,0);
      const kpi = {
        in: sum(inc), out: sum(out), saldo: sum(saldo), avgOut: Math.round((sum(out)/out.length)||0)
      };

      return { labels, inc, out, saldo, top, donut, kpi };
    }

    /* ============ Charts ============ */
    function buildCharts(){
      const { labels, inc, out, saldo, top, donut, kpi } = series12m();

      // KPI
      el.kIn.textContent    = fmt.format(kpi.in);
      el.kOut.textContent   = fmt.format(kpi.out);
      el.kSaldo.textContent = fmt.format(kpi.saldo);
      el.kAvgOut.textContent= fmt.format(kpi.avgOut);
      [el.kIn,el.kOut,el.kSaldo,el.kAvgOut].forEach(x=>{ x.classList.remove('pulse'); void x.offsetWidth; x.classList.add('pulse'); });

      // Destroy old
      Object.values(state.charts).forEach(ch=> ch?.destroy());

      // Trend Entrate/Uscite
      state.charts.trend = new Chart($('#chartTrend'), {
        type:'line',
        data:{ labels, datasets:[
          { label:'Entrate', data:inc, tension:.35, fill:false },
          { label:'Uscite',  data:out, tension:.35, fill:false }
        ]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} }
      });

      // Saldo mensile
      state.charts.saldo = new Chart($('#chartSaldo'), {
        type:'bar',
        data:{ labels, datasets:[{ label:'Saldo', data:saldo }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
      });

      // Top categorie (12m)
      state.charts.top = new Chart($('#chartTopCat'), {
        type:'bar',
        data:{ labels: top.map(([nm])=>nm), datasets:[{ label:'Uscite', data: top.map(([,v])=>v) }] },
        options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
      });

      // Donut mese selezionato
      state.charts.donut = new Chart($('#chartDonut'), {
        type:'doughnut',
        data:{ labels: donut.map(([nm])=>nm), datasets:[{ label:'Uscite', data: donut.map(([,v])=>v) }] },
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} }
      });
    }

    /* ============ Realtime ============ */
    function subscribeRT(){
      if (state.rt){ supabase.removeChannel(state.rt); state.rt=null; }
      const userCol = CONFIG.COL.tx_user;
      state.rt = supabase.channel('rt_riepilogo_'+USER_ID)
        .on('postgres_changes', { event:'*', schema:'public', table:CONFIG.TABLE_TX, filter:`${userCol}=eq.${USER_ID}` }, async (payload)=>{
          // Ricarica solo se l’evento ricade nella finestra 12m
          const dateCol = Array.isArray(CONFIG.COL.tx_date)?CONFIG.COL.tx_date[0]:CONFIG.COL.tx_date;
          const row = payload.new || payload.old; if (!row) return;
          const ym = (row[dateCol]||'').slice(0,7);
          if (!state.months.includes(ym)) return;
          await loadTx(); buildCharts();
        })
        .subscribe(()=>{/* ok */});
    }

    /* ============ Eventi ============ */
    el.mp.addEventListener('change', async e=>{
      state.focusYM = e.target.value;
      const from = addMonths(state.focusYM, -11);
      state.months = Array.from({length:12}, (_,i)=> addMonths(from, i));
      el.fromYM.textContent = monthLabel(from);
      el.toYM.textContent   = monthLabel(state.focusYM);
      $('#monthTitle').textContent = 'Mese: ' + monthLabel(state.focusYM);
      await loadTx(); buildCharts();
    });

    /* ============ Init ============ */
    await loadCategories();
    await loadTx();
    buildCharts();
    subscribeRT();
  </script>
</body>
</html>
