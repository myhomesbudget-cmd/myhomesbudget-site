<!doctype html>
<html lang="it" data-app="myhomesbudget">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard — MyHomesBudget</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" href="/homes.png" type="image/png" sizes="32x32">

  <style>
    :root{
      --fg:#111;--bg:#f4f7fa;--glass:rgba(255,255,255,.6);
      --card-border:rgba(0,0,0,.08);--shadow:0 10px 30px rgba(0,0,0,.08);
      --radius-lg:16px;--primary-color:#6c5ce7;--danger-color:#d32f2f;--success-color:#2e7d32;
      --warning-color:#f39c12;
      --font-sans:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif;
      --grad:linear-gradient(135deg,#6c5ce7,#00cec9);
      --grad-danger:linear-gradient(135deg,#d32f2f,#ff7675);
    }
    *{box-sizing:border-box}
    html{font-family:var(--font-sans);background-color:var(--bg)}
    body{margin:0;color:var(--fg);background:url("/bg.webp") no-repeat center/cover fixed;min-height:100vh}
    body::before{content:"";position:fixed;inset:0;background:linear-gradient(135deg,rgba(108,92,231,.05),rgba(0,206,201,.05));z-index:-1}

    /* ====== TOPBAR ====== */
    .topbar{position:fixed;top:0;left:0;right:0;height:60px;padding:0 24px;display:flex;align-items:center;justify-content:space-between;background:var(--glass);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-bottom:1px solid var(--card-border);z-index:100}
    .logo-link{display:flex;align-items:center;gap:8px;text-decoration:none}
    .logo-text{font-weight:600;color:#fff;font-size:1.1rem;text-shadow:0 1px 2px rgba(0,0,0,.35)}
    .top-center{ position: absolute; left: 50%; transform: translateX(-50%); }
    .top-actions{display:flex;gap:12px;align-items:center}
    .top-link,.top-btn{display:flex;align-items:center;justify-content:center;height:34px;color:#fff;text-decoration:none;padding:6px 12px;border-radius:10px;font-size:.9rem;font-weight:600;background:var(--grad);border:none;box-shadow:0 4px 12px rgba(0,0,0,.15);transition:transform .2s ease,filter .2s ease,box-shadow .2s ease;cursor:pointer; white-space: nowrap;}
    .top-link:hover,.top-btn:hover{transform:translateY(-2px);filter:brightness(1.08);box-shadow:0 6px 16px rgba(0,0,0,.20)}

    .date-selectors{display:flex;gap:8px}
    .select-wrapper{position:relative;display:flex;align-items:center;height:34px;border-radius:10px;background:var(--grad);box-shadow:0 4px 12px rgba(0,0,0,.15);transition:transform .2s ease,filter .2s ease,box-shadow .2s ease}
    .select-wrapper:hover{transform:translateY(-2px);filter:brightness(1.08);box-shadow:0 6px 16px rgba(0,0,0,.20)}
    .select-wrapper::after{content:'▼';font-size:10px;color:rgba(255,255,255,0.8);position:absolute;right:10px;top:50%;transform:translateY(-50%);pointer-events:none}
    .topbar-select{appearance:none;background:transparent;color:#fff;border:none;padding:6px 28px 6px 12px;font-size:.9rem;font-weight:600;cursor:pointer}
    .topbar-select option{background:#fff;color:#000}
    .topbar-select:disabled{opacity:.7}

    .notification-bell{position:relative}
    #scheduler-btn,#notifications-btn{width:38px;padding:0}
    .notification-badge{position:absolute;top:-5px;right:-5px;background:var(--danger-color);color:#fff;border-radius:50%;width:20px;height:20px;font-size:12px;font-weight:bold;display:none;align-items:center;justify-content:center;border:2px solid #fff}
    .notification-badge.is-visible{display:flex}

    .mobile-menu-toggle{display:none;background:var(--grad);border:none;border-radius:10px;width:40px;height:38px;cursor:pointer;padding:0;z-index:101;box-shadow:0 4px 12px rgba(0,0,0,.15)}
    .mobile-menu-toggle svg{width:24px;height:24px;stroke:#fff;stroke-width:2.5;stroke-linecap:round}
    .visually-hidden{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}

    @media (max-width: 1200px) { .top-center { display: none; } }
    @media (max-width:960px){
      .mobile-menu-toggle{display:block}
      .top-actions{position:fixed;top:70px;right:16px;background:rgba(255,255,255,0.9);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-radius:var(--radius-lg);box-shadow:var(--shadow);padding:16px;flex-direction:column;gap:16px;align-items:stretch;width:220px;transform:translateY(-20px) scale(.95);opacity:0;pointer-events:none;transition:transform .2s ease-out,opacity .2s ease-out;z-index:100;border:1px solid var(--card-border)}
      .top-actions.is-open{transform:translateY(0) scale(1);opacity:1;pointer-events:auto}
      .top-actions .top-link,.top-actions .top-btn,.top-actions .select-wrapper,.top-actions .date-selectors{width:100%;text-align:center;flex-direction:column}
      #scheduler-btn,#notifications-btn{width:100%}
    }

    /* ====== Contenuto Principale ====== */
    main.container{padding:84px 24px 24px;max-width:1280px;margin:0 auto;width:100%}
    .dash-nav{display:flex;gap:8px;border-bottom:1px solid rgba(0,0,0,.1);padding-bottom:12px;margin-bottom:24px}
    .dash-nav a,.dash-nav button{text-decoration:none;padding:8px 16px;border-radius:10px;font-weight:600;transition:all .2s ease;background:var(--grad);color:#fff;box-shadow:0 4px 12px rgba(0,0,0,.1);border:none;font-family:var(--font-sans);font-size:1rem;cursor:pointer}
    .dash-nav a:hover,.dash-nav button:hover{transform:translateY(-2px);filter:brightness(1.08);box-shadow:0 6px 16px rgba(0,0,0,.15)}
    .dash-nav a.is-active,.dash-nav button.is-active{filter:brightness(1.15);box-shadow:0 6px 16px rgba(0,0,0,.20),inset 0 1px 2px rgba(255,255,255,0.2)}
    .content-section{background:rgba(255,255,255,.85);border-radius:var(--radius-lg);padding:16px;border:1px solid var(--card-border);box-shadow:var(--shadow)}

    .dashboard-panel{background:rgba(255,255,255,0.55);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border-radius:var(--radius-lg);padding:24px;border:1px solid var(--card-border);box-shadow:var(--shadow)}
    .dashboard-panel .content-section,.dashboard-panel .summary-card{box-shadow:none;border:none}
    .dashboard-panel .content-section{background:rgba(255,255,255,0.7)}

    /* ====== Layout ====== */
    .dashboard-grid{display:grid;grid-template-columns:1fr;gap:24px}
    @media(min-width:1024px){.dashboard-grid{grid-template-columns:repeat(2,1fr)}}
    .flow-column h2{display:flex;align-items:center;justify-content:space-between;gap:12px;font-size:1.5rem;margin:0 0 16px;padding:0 8px}
    .flow-column.income h2{color:var(--success-color)}
    .flow-column.expense h2{color:var(--danger-color)}

    /* ====== Summary Bars ====== */
    .summary-card{background:#fff;padding:16px;border-radius:var(--radius-lg);margin-bottom:16px}
    .summary-card h3{display:flex;justify-content:space-between;align-items:center;margin:0 0 12px;font-size:1rem;color:#555}
    .summary-total-amount{font-weight:800;font-size:1.2rem}
    .income .summary-total-amount{color:var(--success-color)}
    .expense .summary-total-amount{color:var(--danger-color)}
    .category-summary-bars{display:flex;flex-direction:column;gap:14px;margin-top:16px}
    .category-bar-item{display:flex;flex-direction:column;gap:6px}
    .category-bar-info{display:flex;justify-content:space-between;align-items:center;font-size:.95rem}
    .category-bar-label{display:flex;align-items:center;gap:8px;font-weight:600}
    .category-bar-label .icon{font-size:1.1rem}
    .category-bar-amount{font-weight:700}
    .progress-bar-bg{width:100%;height:10px;background-color:rgba(0,0,0,0.08);border-radius:999px;overflow:hidden}
    .progress-bar-fg{height:100%;border-radius:999px;transition:width .5s ease-out}
    .income .progress-bar-fg{background:linear-gradient(90deg,#00cec9,#81ecec)}
    .expense .progress-bar-fg{background:linear-gradient(90deg,#6c5ce7,#fd79a8)}

    /* ====== Form ====== */
    .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;font-weight:800;color:#fff;transition:transform .2s ease,filter .2s ease,box-shadow .2s ease}
    .btn:hover:not(:disabled){transform:translateY(-2px);filter:brightness(1.08)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-primary{background:var(--grad);box-shadow:0 10px 24px rgba(0,0,0,.18)}
    .btn-primary:hover:not(:disabled){box-shadow:0 14px 28px rgba(0,0,0,.22)}
    .btn-secondary{background:#f0f0f0;color:#555;border:1px solid #ddd;box-shadow:0 4px 8px rgba(0,0,0,0.05)}
    .btn-secondary:hover:not(:disabled){background:#e5e5e5;border-color:#ccc;color:#333}

    .transaction-form{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:flex-end}
    .form-group{display:flex;flex-direction:column}
    .form-group label{font-weight:600;font-size:.9rem;margin-bottom:6px}
    .form-group input,.form-group select{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;background:#fff;font-size:1rem}
    .form-group.full-width{grid-column:1 / -1}
    .form-buttons{grid-column:1 / -1;margin-top:10px}
    .form-buttons.is-editing{display:flex;gap:12px}
    .form-buttons.is-editing #submit-btn{flex-grow:1}

    @media(min-width:1024px){
      .transaction-form{grid-template-columns:repeat(6,1fr);gap:16px}
      .form-group.kind{grid-column:span 1}
      .form-group.note{grid-column:span 3}
      .form-group.amount{grid-column:span 2}
      .form-group.date{grid-column:span 2}
      .form-group.category{grid-column:span 2}
      .form-group.subcategory{grid-column:span 2}
    }

    /* AVANZATE: wrapper sempre visibile */
    #advanced-options-wrapper{display:block;grid-column:1 / -1;background:rgba(0,0,0,0.03);padding:12px;border-radius:10px;margin-top:8px}
    .advanced-options-controls{display:flex;flex-wrap:wrap;gap:20px;align-items:center;margin-bottom:12px}
    .advanced-options-controls label{display:flex;align-items:center;gap:8px;font-weight:600;cursor:pointer}
    .advanced-options-fields{display:none;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px}

    /* ====== Liste ====== */
    .list-title{margin:-16px -16px 16px;padding:12px 16px;font-size:1.1rem;font-weight:700;color:#333;border-bottom:1px solid rgba(0,0,0,0.08);background:rgba(255,255,255,0.4);display:flex;justify-content:space-between;align-items:center}
    .list-total-amount{font-weight:800;font-size:1.2rem}
    .income .list-total-amount{color:var(--success-color)}
    .expense .list-total-amount{color:var(--danger-color)}

    .transaction-list .item{display:grid;grid-template-columns:auto 1fr auto auto;gap:12px;align-items:center;padding:12px 4px;border-bottom:1px solid rgba(0,0,0,.05)}
    .item:last-child{border-bottom:none}
    .item-icon{font-size:1.5rem;flex-shrink:0}
    .item-details{display:flex;flex-direction:column;min-width:0}
    .item-details .note{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .item-details .category{font-size:.9rem;color:#555;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .item-amount{text-align:right;white-space:nowrap;flex-shrink:0}
    .item-amount.expense{color:var(--danger-color);font-weight:700}
    .item-amount.income{color:var(--success-color);font-weight:700}
    .item-actions{display:flex;gap:4px;flex-shrink:0}
    .action-btn{background:var(--grad);color:#fff;border:none;border-radius:8px;padding:6px 10px;font-size:.85rem;font-weight:600;cursor:pointer;transition:filter .2s ease,transform .2s ease}
    .action-btn:hover{filter:brightness(1.1);transform:translateY(-1px)}
    .action-btn.delete{background:var(--grad-danger)}
    .empty-state{text-align:center;padding:40px 20px;color:#777;background:rgba(0,0,0,0.02);border-radius:12px}

    /* Pannello Scadenze */
    #deadlines-section h3{color:var(--warning-color);border-bottom:2px solid var(--warning-color);padding-bottom:8px}
    .deadline-item{display:grid;grid-template-columns:1fr auto auto auto;align-items:center;gap:12px}
    .deadline-item .item-actions{display:flex;gap:4px;align-items:center;justify-content:flex-end}
    .deadline-item .item-amount.expense{color:var(--danger-color)}
    .deadline-item .item-amount.income{color:var(--success-color)}
    .deadline-item .days-left{font-weight:700;color:var(--warning-color)}
    .btn-action-deadline{padding:8px 12px;font-size:.9rem}
    .btn-action-deadline.pay{background:var(--warning-color)}
    .btn-action-deadline.receive{background:var(--success-color)}

    /* ====== Modal base ====== */
    .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;pointer-events:none;transition:opacity .3s ease}
    .modal-overlay.is-visible{opacity:1;pointer-events:auto}
    .modal-content{background:var(--bg);border-radius:var(--radius-lg);padding:24px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto;box-shadow:var(--shadow);transform:scale(.95);transition:transform .3s ease}
    .modal-overlay.is-visible .modal-content{transform:scale(1)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--card-border);padding-bottom:12px;margin-bottom:16px}
    .modal-title{margin:0;font-size:1.3rem}
    .modal-close{background:none;border:none;font-size:2rem;cursor:pointer;color:#888;line-height:1;padding:0}
    .modal-body ul{list-style:none;padding:0;margin:0}
    .modal-body li{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--card-border)}
    .modal-body li:last-child{border-bottom:none}
    .modal-footer{margin-top:20px;display:flex;justify-content:flex-end;gap:12px}
    .modal-footer .btn.delete{background:var(--grad-danger);box-shadow:0 8px 20px rgba(211,47,47,.25)}
    .modal-footer .btn.delete:hover{box-shadow:0 12px 24px rgba(211,47,47,.3)}
    .modal-footer .btn-secondary{background:#f0f0f0;color:#555;border:1px solid #ddd;box-shadow:0 4px 8px rgba(0,0,0,0.05)}
    .modal-footer .btn-secondary:hover{background:#e5e5e5;border-color:#ccc;color:#333}

    /* ====== Modal Lista Movimenti ====== */
    .modal-content-large{max-width:90vw;width:1000px}
    .movements-table-container{max-height:60vh;overflow-y:auto}
    .movements-table{width:100%;border-collapse:collapse}
    .movements-table th,.movements-table td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--card-border);white-space:nowrap}
    .movements-table th{font-weight:700;background-color:rgba(0,0,0,0.05);font-size:.9rem;position:sticky;top:0}
    .movements-table td{font-size:.95rem}
    .movements-table .amount-col{text-align:right;font-weight:700}
    .movements-table .income .amount-col{color:var(--success-color)}
    .movements-table .expense .amount-col{color:var(--danger-color)}
    .movements-summary{margin-top:20px;padding-top:16px;border-top:2px solid var(--card-border);display:flex;justify-content:space-around;font-weight:700}
    .summary-item{text-align:center}
    .summary-label{font-size:.9rem;color:#555}
    .summary-value{font-size:1.2rem}
    .summary-value.total-income{color:var(--success-color)}
    .summary-value.total-expense{color:var(--danger-color)}
    .summary-value.balance{color:var(--fg)}

    /* ====== Modal Animazione ====== */
    .animation-modal-overlay{position:fixed;inset:0;background:rgba(10,25,47,.85);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:2000;opacity:0;pointer-events:none;transition:opacity .3s ease;overflow:hidden}
    .animation-modal-overlay.is-visible{display:flex;opacity:1;pointer-events:auto}
    .animation-container{position:relative;width:300px;height:300px;display:flex;align-items:center;justify-content:center}
    .animation-bg-image{width:100%;height:100%;object-fit:contain;filter:drop-shadow(0 10px 20px rgba(0,0,0,.4))}
    .animation-elements-container{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
    .money-element{position:absolute;background-size:contain;background-repeat:no-repeat;pointer-events:none}
    .money-element.income{top:-60px;left:50%;transform:translateX(-50%);opacity:0;animation:drop-money-fall 1.8s ease-in forwards}
    @keyframes drop-money-fall{0%{transform:translateY(-100px) translateX(-50%) rotate(-20deg);opacity:0}25%{opacity:1}100%{transform:translateY(120px) translateX(-50%) rotate(20deg);opacity:0}}
    .money-element.expense{top:50%;left:50%;transform:translate(-50%,-50%);opacity:1;animation:dematerialize-money 2s forwards}
    @keyframes dematerialize-money{0%{transform:translate(-50%,-50%) scale(1);opacity:1}100%{transform:translate(-50%,-200%) scale(.3);opacity:0;filter:blur(10px)}}

    /* Messaggi stato */
    .status-message{padding:12px 16px;border-radius:10px;margin-top:16px;text-align:center;font-weight:600;opacity:0;transition:opacity .3s ease;grid-column:1 / -1}
    .status-message.is-visible{opacity:1}
    .status-message.success{background-color:var(--success-color);color:#fff}
    .status-message.error{background-color:var(--danger-color);color:#fff}

    /* ====== GOALS ====== */
    #goals-section .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    #goals-plan-info{font-weight:700;color:#666}
    .goal-card{background:#fff;border:1px solid var(--card-border);border-radius:12px;padding:16px;box-shadow:var(--shadow)}
    .goal-card.is-locked .chip,.goal-card.is-locked .goal-input input,.goal-card.is-locked .percentage-input-group input{pointer-events:none;background-color:#f8f9fa;color:#6c757d}
    .goal-title{font-weight:800;color:#444;margin:0 0 4px}
    .goal-subtitle{margin:0 0 12px;color:#666}
    .goal-row{display:grid;grid-template-columns:1fr;gap:12px;align-items:center}
    @media(min-width:768px){.goal-row{grid-template-columns:1fr 1fr auto}}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:999px;background:rgba(0,0,0,.05);font-weight:700;cursor:pointer;user-select:none}
    .chip.is-active{background:var(--grad);color:#fff;box-shadow:0 4px 10px rgba(0,0,0,.12)}
    .goal-method{display:flex;gap:8px;flex-wrap:wrap}
    .goal-input{display:flex;flex-direction:column}
    .goal-input input{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;font-size:1rem;background:#fff}
    .goal-hint{display:block;margin-top:6px;font-size:.85rem;color:#777}
    .goal-confirm{display:flex;gap:8px;justify-content:flex-end;align-items:center}
    .goal-card .link{color:var(--primary-color);font-weight:700;text-decoration:none}

    .percentage-input-group{display:none;align-items:center;gap:8px;margin-top:8px}
    .percentage-input-group.is-visible{display:flex}
    .percentage-input-group input{width:80px;text-align:right}
    .percentage-input-group span{font-weight:700}
  </style>
</head>
<body>
  <!-- Topbar -->
  <nav class="topbar">
    <a href="/it/" class="logo-link">
      <img src="/homes.png" alt="Logo" style="height:32px;border-radius:6px">
      <span class="logo-text">MyHomesBudget</span>
    </a>
    <!-- MODIFICA: Aggiunto div per il bottone abbonamento -->
    <div class="top-center">
        <a href="/it/pricing.html" id="subscription-status-btn" class="top-link" style="display: none;"></a>
    </div>
    <div class="top-nav-right">
      <button id="mobile-menu-btn" class="mobile-menu-toggle" aria-label="Apri menu">
        <svg viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        <span class="visually-hidden">Menu</span>
      </button>
      <div class="top-actions">
        <div class="date-selectors">
          <div class="select-wrapper"><select id="month-selector" class="topbar-select"></select></div>
          <div class="select-wrapper"><select id="year-selector" class="topbar-select"></select></div>
        </div>
        <a href="/it/onboarding.html?edit=1" class="top-link">🎯 Obiettivo</a>
        <button id="scheduler-btn" class="top-btn" aria-label="Apri scadenziario">🗓️</button>
        <button id="notifications-btn" class="top-btn notification-bell" aria-label="Apri notifiche">
          <span>🔔</span>
          <span id="notification-badge" class="notification-badge"></span>
        </button>
        <a href="#" id="logout-btn" class="top-link">Esci</a>
      </div>
    </div>
  </nav>

  <main class="container">
    <!-- MODIFICA: Riorganizzata la navigazione -->
    <nav id="dash-nav" class="dash-nav">
      <a href="/it/profile.html">Profilo</a>
      <a href="/it/dashboard.html" class="is-active" aria-current="page">Operazioni</a>
      <a href="/it/dashboard-riepilogo.html">Riepilogo</a>
      <button id="list-movements-btn">Lista Movimenti</button>
    </nav>

    <!-- Sezione Form -->
    <section class="content-section form-section">
      <h2 id="form-title" style="margin:0 0 16px">Nuova Operazione</h2>
      <form id="transaction-form" class="transaction-form">
        <input type="hidden" id="transaction-id" name="transaction-id">
        <div class="form-group kind">
          <label for="kind">Tipo</label>
          <select id="kind" name="kind" required>
            <option value="expense">Uscita</option>
            <option value="income">Entrata</option>
          </select>
        </div>
        <div class="form-group note">
          <label for="note">Nota</label>
          <input type="text" id="note" name="note" placeholder="Es. Stipendio, Rata Mutuo..." required>
        </div>
        <div class="form-group amount">
          <label for="amount">Importo (€)</label>
          <input type="number" id="amount" name="amount" step="0.01" placeholder="0.00" required>
        </div>
        <div class="form-group date">
          <label for="occurred_at">Data</label>
          <input type="date" id="occurred_at" name="occurred_at" required>
        </div>
        <div class="form-group category">
          <label for="category_id">Categoria</label>
          <select id="category_id" name="category_id" required></select>
        </div>
        <div class="form-group subcategory">
          <label for="subcategory_id">Sottocategoria</label>
          <select id="subcategory_id" name="subcategory_id"></select>
        </div>

        <!-- Opzioni Avanzate -->
        <div id="advanced-options-wrapper">
          <div class="advanced-options-controls">
            <label><input type="radio" name="transaction_type" value="single" checked> Operazione Singola</label>
            <label><input type="radio" name="transaction_type" value="recurring"> 🔄 Ricorrente</label>
            <label><input type="radio" name="transaction_type" value="scheduled"> 🗓️ Imposta Scadenza</label>
          </div>
          <div id="recurring-options" class="advanced-options-fields">
            <div class="form-group">
              <label for="recurring_frequency">Frequenza</label>
              <select id="recurring_frequency" name="recurring_frequency">
                <option value="monthly">Mensile</option>
              </select>
            </div>
            <div class="form-group">
              <label for="recurring_end_date">Termina il</label>
              <input type="date" id="recurring_end_date" name="recurring_end_date">
            </div>
          </div>
          <div id="due-date-options" class="advanced-options-fields">
            <div class="form-group full-width">
              <label for="due_date">Data di Scadenza/Incasso</label>
              <input type="date" id="due_date" name="due_date">
            </div>
          </div>
        </div>

        <div id="form-buttons-container" class="form-buttons">
          <button type="submit" id="submit-btn" class="btn btn-primary" style="width:100%;">Aggiungi</button>
          <button type="button" id="cancel-edit-btn" class="btn btn-secondary" style="display:none;">Annulla</button>
        </div>

        <!-- Messaggi di stato -->
        <div id="status-message" class="status-message" aria-live="polite"></div>
      </form>
    </section>

    <!-- 🎯 Sezione Obiettivi -->
    <section id="goals-section" class="content-section" style="margin-top:12px;">
      <div class="header">
        <h3 style="margin:0;display:flex;align-items:center;gap:8px;">🎯 <span>Obiettivo</span></h3>
        <span id="goals-plan-info"></span>
      </div>
      <div id="goals-list"></div>
    </section>

    <!-- Scadenze -->
    <section id="deadlines-section" class="content-section" style="margin-top:12px;display:none;">
      <h3>🔔 Scadenze & Voci Future (Prossimi 30 giorni)</h3>
      <div id="deadlines-list" class="transaction-list"></div>
    </section>

    <!-- Dati principali -->
    <div class="dashboard-panel" style="margin-top:12px;">
      <div class="dashboard-grid">
        <div class="flow-column income">
          <h2>✅ Entrate Recenti</h2>
          <div id="income-summary" class="summary-card"></div>
          <div id="income-list" class="content-section transaction-list"></div>
        </div>
        <div class="flow-column expense">
          <h2>❌ Uscite Recenti</h2>
          <div id="expense-summary" class="summary-card"></div>
          <div id="expense-list" class="content-section transaction-list"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal Scadenziario -->
  <div id="scheduler-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="scheduler-modal-title" class="modal-title"></h3>
        <button class="modal-close" aria-label="Chiudi modale">&times;</button>
      </div>
      <div id="scheduler-modal-body" class="modal-body transaction-list"></div>
    </div>
  </div>

  <!-- Modal Generico -->
  <div id="generic-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="generic-modal-title" class="modal-title"></h3>
        <button class="modal-close" aria-label="Chiudi modale">&times;</button>
      </div>
      <div id="generic-modal-body" class="modal-body"></div>
      <div id="generic-modal-footer" class="modal-footer"></div>
    </div>
  </div>

  <!-- Modal Animazione -->
  <div id="animation-modal" class="animation-modal-overlay">
    <div class="animation-container">
      <img id="animation-bg-image" class="animation-bg-image" src="" alt="Animazione soldi"/>
      <div class="animation-elements-container"></div>
    </div>
  </div>

  <!-- Modal Lista Movimenti -->
  <div id="movements-modal" class="modal-overlay">
    <div class="modal-content modal-content-large">
      <div class="modal-header">
        <h3 id="movements-modal-title" class="modal-title">Lista Movimenti</h3>
        <button class="modal-close" aria-label="Chiudi modale">&times;</button>
      </div>
      <div id="movements-modal-body" class="modal-body">
        <div class="movements-table-container"></div>
      </div>
      <div id="movements-modal-footer" class="movements-summary"></div>
    </div>
  </div>

  <script type="module">
    import { supabase } from "/it/supabase-client.js";
    window.supabase = supabase;

    // --- STATE ---
    let user = null;
    let allCategories = [];
    let allSubcategories = [];
    let allTransactions = [];
    let userProfile = null;

    const moneyBagImage = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'><defs><filter id='s'><feDropShadow dx='0' dy='2' stdDeviation='2' flood-opacity='.3'/></filter></defs><circle cx='60' cy='60' r='52' fill='%23fdd835' filter='url(%23s)'/><text x='60' y='72' font-size='48' text-anchor='middle' font-family='Arial' fill='%23444'>€</text></svg>";

    // --- DOM ---
    const transactionForm = document.getElementById('transaction-form');
    const kindSelect = document.getElementById('kind');
    const categorySelect = document.getElementById('category_id');
    const subcategorySelect = document.getElementById('subcategory_id');
    const transactionIdInput = document.getElementById('transaction-id');
    const formTitle = document.getElementById('form-title');
    const submitBtn = document.getElementById('submit-btn');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    const formButtonsContainer = document.getElementById('form-buttons-container');
    const logoutBtn = document.getElementById('logout-btn');
    const incomeList = document.getElementById('income-list');
    const expenseList = document.getElementById('expense-list');
    const incomeSummary = document.getElementById('income-summary');
    const expenseSummary = document.getElementById('expense-summary');
    const monthSelector = document.getElementById('month-selector');
    const yearSelector = document.getElementById('year-selector');
    const advancedOptionsWrapper = document.getElementById('advanced-options-wrapper');
    const recurringOptions = document.getElementById('recurring-options');
    const dueDateOptions = document.getElementById('due-date-options');
    const deadlinesSection = document.getElementById('deadlines-section');
    const deadlinesList = document.getElementById('deadlines-list');
    const schedulerBtn = document.getElementById('scheduler-btn');
    const notificationsBtn = document.getElementById('notifications-btn');
    const notificationBadge = document.getElementById('notification-badge');
    const schedulerModal = document.getElementById('scheduler-modal');
    const movementsModal = document.getElementById('movements-modal');
    const listMovementsBtn = document.getElementById('list-movements-btn');
    const goalsSection = document.getElementById('goals-section');
    const goalsList = document.getElementById('goals-list');
    const goalsPlanInfo = document.getElementById('goals-plan-info');
    const statusMessage = document.getElementById('status-message');
    const animationModal = document.getElementById('animation-modal');
    const subscriptionStatusBtn = document.getElementById('subscription-status-btn');

    // --- UTILS ---
    function safeToNumber(v){ const n = (typeof v === 'number') ? v : parseFloat(v); return Number.isFinite(n) ? n : 0; }
    const fmt = (n) => Number(n || 0).toFixed(2);
    const dayMs = 86400000;

    function showStatusMessage(message, type='success', duration=3000){
      statusMessage.textContent = message;
      statusMessage.className = `status-message ${type} is-visible`;
      setTimeout(()=>statusMessage.classList.remove('is-visible'), duration);
    }

    function showModal(title, bodyHtml, buttons=[]){
      const modal = document.getElementById('generic-modal');
      document.getElementById('generic-modal-title').textContent = title;
      document.getElementById('generic-modal-body').innerHTML = bodyHtml;
      const footer = document.getElementById('generic-modal-footer');
      footer.innerHTML = '';
      buttons.forEach(btnInfo=>{
        const button = document.createElement('button');
        button.innerHTML = btnInfo.text;
        button.className = `btn ${btnInfo.class || 'btn-secondary'}`;
        button.onclick = ()=>{
          if (btnInfo.action) btnInfo.action();
          modal.classList.remove('is-visible');
        };
        footer.appendChild(button);
      });
      modal.classList.add('is-visible');
    }

    function showTransactionAnimation(type='income'){
      return new Promise(resolve=>{
        const container = animationModal.querySelector('.animation-elements-container');
        const bgImage = document.getElementById('animation-bg-image');
        container.innerHTML = '';
        bgImage.src = moneyBagImage;
        animationModal.classList.add('is-visible');

        if (type === 'income'){
          const moneyCount = 10;
          for (let i=0;i<moneyCount;i++){
            const money = document.createElement('div');
            money.className = 'money-element income';
            money.style.width = '80px';
            money.style.height = '40px';
            money.style.backgroundImage = `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 50'%3E%3Crect width='100' height='50' rx='5' fill='%2366BB6A'/%3E%3Ccircle cx='50' cy='25' r='15' fill='none' stroke='%23A5D6A7' stroke-width='3'/%3E%3Ctext x='50' y='30' font-family='Arial, sans-serif' font-size='20' fill='%23E8F5E9' text-anchor='middle'%3E€%3C/text%3E%3C/svg%3E")`;
            money.style.left = `${Math.random()*80+10}%`;
            money.style.animationDelay = `${Math.random()*1.2}s`;
            container.appendChild(money);
          }
          setTimeout(()=>{ animationModal.classList.remove('is-visible'); resolve(); }, 2800);
        } else {
          const bill = document.createElement('div');
          bill.className = 'money-element expense';
          bill.style.width = '80px'; bill.style.height = '40px';
          bill.style.backgroundImage = `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 50'%3E%3Crect width='100' height='50' rx='5' fill='%23EF9A9A'/%3E%3Ccircle cx='50' cy='25' r='15' fill='none' stroke='%23FFCDD2' stroke-width='3'/%3E%3Ctext x='50' y='30' font-family='Arial, sans-serif' font-size='20' fill='%23FFEBEE' text-anchor='middle'%3E€%3C/text%3E%3C/svg%3E")`;
          container.appendChild(bill);
          setTimeout(()=>{ animationModal.classList.remove('is-visible'); resolve(); }, 2000);
        }
      });
    }

    function resetFormToCreateMode(){
      formTitle.textContent = "Nuova Operazione";
      submitBtn.textContent = "Aggiungi";
      submitBtn.style.width = '100%';
      transactionIdInput.value = "";
      cancelEditBtn.style.display = 'none';
      formButtonsContainer.classList.remove('is-editing');
      transactionForm.reset();
      document.getElementById('occurred_at').valueAsDate = new Date();
      document.querySelector('input[name="transaction_type"][value="single"]').checked = true;
      advancedOptionsWrapper.style.display = 'block';
      recurringOptions.style.display = 'none';
      dueDateOptions.style.display = 'none';
      updateCategoryDropdown();
    }

    function mapContributionMethodToInternal(method){
      if (method === 'Cifra fissa') return 'fixed';
      if (method === 'Importo variabile') return 'variable';
      if (method === 'Percentuale sulle entrate') return 'percent_income';
      return 'fixed';
    }
    function mapInternalToContributionMethod(internal){
      if (internal === 'fixed') return 'Cifra fissa';
      if (internal === 'variable') return 'Importo variabile';
      if (internal === 'percent_income') return 'Percentuale sulle entrate';
      return 'Cifra fissa';
    }
    function getMethodLabel(method){
      return method === 'fixed' ? 'Importo fisso (€)'
           : method === 'variable' ? 'Importo variabile (€)'
           : 'Accantonamento calcolato (€)';
    }
    function getPlaceholder(method){ return method === 'percent_income' ? '' : '100.00'; }

    function toLocalMidnight(yyyyMmDd){
      if (!yyyyMmDd) return null;
      const [y,m,d] = yyyyMmDd.split('-').map(n=>parseInt(n,10));
      const dt = new Date();
      dt.setFullYear(y, m-1, d);
      dt.setHours(0,0,0,0);
      return dt;
    }

    async function loadGoals(){
      try{
        const { data: profile, error } = await supabase
          .from('profiles')
          .select('goal_type,goal_name,goal_target_amount,goal_target_date,contribution_method,contribution_amount')
          .eq('id', user.id)
          .single();
        if (error && error.code !== 'PGRST116') throw error;
        userProfile = profile;
        renderGoalsUI(profile);
      } catch(err){
        console.error('[Goals] Errore caricamento:', err);
        renderGoalsUI(null);
      }
    }

    function renderGoalsUI(profile){
      goalsSection.style.display = "block";
      if (!profile || !profile.goal_type){
        goalsPlanInfo.textContent = '';
        goalsList.innerHTML = `<div class="goal-card"><div class="goal-title">🎯 <span>Obiettivo non impostato</span></div><p class="goal-subtitle">Non hai ancora configurato un obiettivo. Fallo ora per iniziare!</p><div class="goal-confirm" style="text-align:left;"><a class="btn btn-primary" href="/it/onboarding.html?edit=1">Configura Obiettivo</a></div></div>`;
        return;
      }
      goalsPlanInfo.textContent = '';
      const goal = { id: user.id, name: profile.goal_name, target_amount: profile.goal_target_amount, method: mapContributionMethodToInternal(profile.contribution_method), value: profile.contribution_amount };
      const labelForMethod = getMethodLabel(goal.method);
      const placeholder = getPlaceholder(goal.method);
      const targetHint = goal.target_amount ? `Target: <strong>${fmt(goal.target_amount)}€</strong>` : '';
      goalsList.innerHTML = `<div id="goal-card" class="goal-card"><div class="goal-title">🎯 <span>${profile.goal_type}</span></div><p class="goal-subtitle">${goal.name || 'Risparmio'}</p><div class="goal-row"><div class="goal-method" id="g1-method"><span class="chip ${goal.method==='fixed'?'is-active':''}" data-method="fixed">Somma fissa</span><span class="chip ${goal.method==='variable'?'is-active':''}" data-method="variable">Somma variabile</span><span class="chip ${goal.method==='percent_income'?'is-active':''}" data-method="percent_income">% sulle entrate</span></div><div class="goal-input"><label id="g1-label" style="font-weight:700;display:block;margin-bottom:6px;">${labelForMethod}</label><input id="g1-value" type="number" step="0.01" value="${goal.value || 0}" placeholder="${placeholder}" /><div id="g1-percentage-box" class="percentage-input-group"><input id="g1-percentage-input" type="number" step="0.1" value="${goal.value || 0}" /><span>% di <span id="g1-total-income">0.00</span>€</span></div><span class="goal-hint">${targetHint}</span></div><div class="goal-confirm"><button id="g1-confirm-btn" class="btn btn-primary">Conferma</button><button id="g1-edit-btn" class="btn btn-secondary" style="display:none;">Modifica</button></div></div></div>`;
      bindGoalEditor(goal);
    }

    function bindGoalEditor(goal){
      const card = document.getElementById('goal-card');
      const methodWrap = document.getElementById('g1-method');
      const valueInput = document.getElementById('g1-value');
      const labelEl = document.getElementById('g1-label');
      const confirmBtn = document.getElementById('g1-confirm-btn');
      const editBtn = document.getElementById('g1-edit-btn');
      const percentageBox = document.getElementById('g1-percentage-box');
      const percentageInput = document.getElementById('g1-percentage-input');
      const totalIncomeEl = document.getElementById('g1-total-income');
      if (!card || !methodWrap || !valueInput || !confirmBtn || !editBtn || !percentageBox || !percentageInput || !totalIncomeEl){ console.error("Elementi obiettivi mancanti, impossibile inizializzare."); return; }
      let isLocked = false;
      function updateTotalIncome(){ const totalIncomes = allTransactions.filter(tx => tx.kind === 'income' && tx.is_paid !== false).reduce((sum, tx) => sum + safeToNumber(tx.amount), 0); totalIncomeEl.textContent = fmt(totalIncomes); return totalIncomes; }
      function calculatePercentage(){ const totalIncomes = updateTotalIncome(); const percentage = Number(percentageInput.value); const pct = Number.isFinite(percentage) ? percentage : 0; const calculatedAmount = (totalIncomes * pct) / 100; valueInput.value = fmt(calculatedAmount); }
      function toggleUI(locked){ isLocked = locked; card.classList.toggle('is-locked', locked); confirmBtn.style.display = locked ? 'none' : 'block'; editBtn.style.display = locked ? 'block' : 'none'; percentageInput.readOnly = locked; }
      function updateDisplayForMethod(method){ labelEl.textContent = getMethodLabel(method); valueInput.placeholder = getPlaceholder(method); const isPercent = method === 'percent_income'; percentageBox.classList.toggle('is-visible', isPercent); valueInput.readOnly = isPercent; if (isPercent){ percentageInput.value = goal.value || 0; calculatePercentage(); } else { valueInput.value = goal.value || 0; } }
      methodWrap.addEventListener('click', (e)=>{ if (isLocked) return; const chip = e.target.closest('.chip'); if (!chip) return; Array.from(methodWrap.querySelectorAll('.chip')).forEach(c=>c.classList.remove('is-active')); chip.classList.add('is-active'); updateDisplayForMethod(chip.dataset.method); });
      percentageInput.addEventListener('input', calculatePercentage);
      confirmBtn.addEventListener('click', async ()=>{ const activeChip = methodWrap.querySelector('.chip.is-active'); const method = activeChip ? activeChip.dataset.method : goal.method; const raw = (method === 'percent_income') ? parseFloat(percentageInput.value) : parseFloat(valueInput.value); const val = Number.isFinite(raw) ? raw : 0; const updatePayload = { contribution_method: mapInternalToContributionMethod(method), contribution_amount: val }; const { error } = await supabase.from('profiles').update(updatePayload).eq('id', user.id); if (error){ console.error('Errore aggiornamento obiettivo:', error); showModal('Errore', 'Impossibile salvare le modifiche all\'obiettivo.', [{ text:'Chiudi' }]); return; } userProfile.contribution_method = updatePayload.contribution_method; userProfile.contribution_amount = updatePayload.contribution_amount; goal.method = method; goal.value = val; showStatusMessage('Obiettivo confermato!', 'success'); toggleUI(true); });
      editBtn.addEventListener('click', ()=>toggleUI(false));
      updateDisplayForMethod(goal.method);
      toggleUI(false);
    }

    async function loadInitialData(){
      try{
        const { data: categories, error: cError } = await supabase.from('categories').select('*').eq('created_by', user.id);
        if (cError) throw cError;
        allCategories = categories || [];
        if (allCategories.length){
          const ids = allCategories.map(c=>c.id);
          const { data: subcategories, error: sError } = await supabase.from('subcategories').select('*').in('category_id', ids);
          if (sError) throw sError;
          allSubcategories = subcategories || [];
        }
      } catch (error){
        console.error("Errore nel caricamento dei dati iniziali:", error);
        showModal('Errore', `<p>Impossibile caricare le categorie. Riprova più tardi.</p>`, [{ text:'Chiudi' }]);
      }
    }

    function updateCategoryDropdown(){
      const selectedKind = kindSelect.value;
      const filtered = allCategories.filter(cat => cat.kind === selectedKind);
      categorySelect.innerHTML = '<option value="">Scegli categoria...</option>';
      filtered.forEach(cat => categorySelect.add(new Option(`${cat.icon || ''} ${cat.name}`, cat.id)));
      updateSubcategories();
    }

    function updateSubcategories(selectedSubcategoryId=null){
      const categoryId = categorySelect.value;
      subcategorySelect.innerHTML = '<option value="">Nessuna</option>';
      subcategorySelect.disabled = true;
      if (!categoryId) return;
      const relevant = allSubcategories.filter(sub => String(sub.category_id) === String(categoryId));
      if (relevant.length){
        subcategorySelect.disabled = false;
        relevant.forEach(sub => subcategorySelect.add(new Option(`${sub.icon || ''} ${sub.name}`, sub.id)));
        if (selectedSubcategoryId) subcategorySelect.value = selectedSubcategoryId;
      }
    }

    function renderDashboard(transactions){
      const incomes = transactions.filter(tx => tx.kind === 'income' && tx.is_paid !== false);
      const expenses = transactions.filter(tx => tx.kind === 'expense' && tx.is_paid !== false);
      renderSummary(incomes, incomeSummary, 'income');
      renderList(incomes, incomeList, 'income');
      renderSummary(expenses, expenseSummary, 'expense');
      renderList(expenses, expenseList, 'expense');
      const percentageInputEl = document.getElementById('g1-percentage-input');
      if (percentageInputEl && document.getElementById('g1-percentage-box')?.classList.contains('is-visible')){
        percentageInputEl.dispatchEvent(new Event('input', { bubbles:true }));
      }
    }

    function renderSummary(items, container, kind){
      container.innerHTML = '';
      const categoryMap = allCategories.filter(cat => cat.kind === kind).reduce((acc, cat)=>({ ...acc, [cat.id]: { name:cat.name, icon:cat.icon || (kind==='income'?'💰':'💸'), total:0 } }),{});
      items.forEach(tx => { if (categoryMap[tx.category_id]) categoryMap[tx.category_id].total += safeToNumber(tx.amount); });
      const totalAmount = items.reduce((sum, tx)=> sum + safeToNumber(tx.amount), 0);
      const categoriesToRender = Object.values(categoryMap).filter(cat => cat.total > 0).sort((a,b)=> b.total - a.total).slice(0,5);
      container.style.display = 'block';
      const summaryTitle = kind === 'income' ? '🏆 Top 5 Entrate' : '🏆 Top 5 Uscite';
      let barsHTML = categoriesToRender.map(cat=>{ const percentage = totalAmount > 0 ? (cat.total / totalAmount) * 100 : 0; return `<div class="category-bar-item"><div class="category-bar-info"><span class="category-bar-label"><span class="icon">${cat.icon}</span><span>${cat.name}</span></span><span class="category-bar-amount">${cat.total.toFixed(2)}€</span></div><div class="progress-bar-bg"><div class="progress-bar-fg" style="width:${percentage}%"></div></div></div>`; }).join('');
      const placeholdersNeeded = 5 - categoriesToRender.length;
      if (placeholdersNeeded > 0){ const placeholderHTML = `<div class="category-bar-item" aria-hidden="true"><div class="category-bar-info" style="visibility:hidden;"><span class="category-bar-label"><span class="icon">&nbsp;</span><span>-</span></span><span class="category-bar-amount">&nbsp;</span></div><div class="progress-bar-bg" style="visibility:hidden;"><div class="progress-bar-fg" style="width:0%;"></div></div></div>`; barsHTML += placeholderHTML.repeat(placeholdersNeeded); }
      container.innerHTML = `<h3><span>${summaryTitle}</span><span class="summary-total-amount">${totalAmount.toFixed(2)}€</span></h3><div class="category-summary-bars">${barsHTML}</div>`;
    }

    function renderList(items, container, kind){
      container.innerHTML = '';
      const totalAmount = items.reduce((sum, tx)=> sum + safeToNumber(tx.amount), 0);
      const titleText = kind === 'income' ? 'Movimenti in Entrata' : 'Movimenti in Uscita';
      const titleEl = document.createElement('div');
      titleEl.className = 'list-title';
      titleEl.innerHTML = `<span>${titleText}</span><span class="list-total-amount ${kind}">${totalAmount.toFixed(2)}€</span>`;
      container.appendChild(titleEl);
      if (!items.length){ container.insertAdjacentHTML('beforeend', `<div class="empty-state"><p>Nessun movimento qui.</p></div>`); return; }
      items.forEach(tx=>{
        const cat = tx.categories;
        const sub = tx.subcategories;
        const icon = sub?.icon || cat?.icon || '💸';
        const categoryText = `${cat?.name || 'N/A'}${(sub ? ` / ${sub.name}` : '')}`;
        const amountNum = safeToNumber(tx.amount);
        const recurringIcon = tx.is_recurring_parent ? ' 🔄' : '';
        container.insertAdjacentHTML('beforeend', `<div class="item"><div class="item-icon">${icon}</div><div class="item-details"><span class="note">${tx.note ?? ''}${recurringIcon}</span><span class="category">${categoryText}</span></div><div class="item-amount ${tx.kind}">${tx.kind === 'expense' ? '-' : '+'}${amountNum.toFixed(2)} €</div><div class="item-actions"><button class="action-btn edit-btn" data-id="${tx.id}">✍🏼 Modifica</button><button class="action-btn delete-btn delete" data-id="${tx.id}">🗑️ Elimina</button></div></div>`);
      });
    }

    async function getScheduledTransactions(startDate, endDate){
      try{
        const { data, error } = await supabase.from('transactions').select('*').eq('created_by', user.id).eq('is_paid', false).gte('due_date', startDate.toISOString().split('T')[0]).lte('due_date', endDate.toISOString().split('T')[0]).order('due_date', { ascending:true });
        if (error) throw error;
        return (data || []).map(tx=>({ ...tx, categories: allCategories.find(c => String(c.id) === String(tx.category_id)) || null }));
      } catch (error){ console.error("Errore caricamento scadenze:", error); return []; }
    }

    function renderDeadlinesList(container, transactions){
      if (transactions.length === 0){ container.innerHTML = '<div class="empty-state"><p>Nessuna scadenza in questo periodo.</p></div>'; return; }
      container.innerHTML = '';
      const today = new Date(); today.setHours(0,0,0,0);
      transactions.forEach(tx=>{
        const isIncome = tx.kind === 'income';
        const dueDate = toLocalMidnight(String(tx.due_date));
        const diffTime = (dueDate ? dueDate.getTime() : 0) - today.getTime();
        const diffDays = Math.ceil(diffTime / dayMs);
        const daysLeftText = diffDays < 0 ? 'Scaduta' : (diffDays === 0 ? 'Oggi' : `${diffDays} giorni`);
        const amountClass = isIncome ? 'income' : 'expense';
        const amountSign = isIncome ? '+' : '-';
        const buttonClass = isIncome ? 'receive' : 'pay';
        const buttonText = isIncome ? 'Incassa Ora' : 'Paga Ora';
        container.insertAdjacentHTML('beforeend', `<div class="item deadline-item"><div class="item-details"><span class="note">${tx.note || ''}</span><span class="category">${tx.categories?.name || ''}</span></div><span class="item-amount ${amountClass}">${amountSign}${safeToNumber(tx.amount).toFixed(2)}€</span><span class="days-left">${daysLeftText}</span><div class="item-actions"><button class="action-btn edit-btn" data-id="${tx.id}" aria-label="Modifica ${tx.note}">✍🏼</button><button class="action-btn delete-btn delete" data-id="${tx.id}" aria-label="Elimina ${tx.note}">🗑️</button><button class="btn btn-action-deadline ${buttonClass}" data-id="${tx.id}">${buttonText}</button></div></div>`);
      });
    }

    function renderMovementsListModal(transactions, months){
      const modalBody = document.getElementById('movements-modal-body').querySelector('.movements-table-container');
      const modalFooter = document.getElementById('movements-modal-footer');
      const modalTitle = document.getElementById('movements-modal-title');
      const selectedMonthName = months[monthSelector.value];
      const selectedYear = yearSelector.value;
      modalTitle.textContent = `Estratto Conto - ${selectedMonthName} ${selectedYear}`;
      if (!transactions || transactions.length === 0){ modalBody.innerHTML = '<div class="empty-state"><p>Nessun movimento per il periodo selezionato.</p></div>'; modalFooter.innerHTML = ''; return; }
      const sortedTx = [...transactions].sort((a,b)=> new Date(a.occurred_at) - new Date(b.occurred_at));
      let totalIncome = 0, totalExpense = 0;
      const rows = sortedTx.map(tx=>{ const amount = safeToNumber(tx.amount); if (tx.kind === 'income') totalIncome += amount; else totalExpense += amount; const date = new Date(tx.occurred_at).toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit',year:'numeric'}); const type = tx.kind === 'income' ? 'Entrata' : 'Uscita'; const note = tx.note || '-'; const category = tx.categories?.name || 'N/A'; const subcategory = tx.subcategories?.name || '-'; const amountFormatted = `${tx.kind==='income'?'+':'-'} ${amount.toFixed(2)} €`; return `<tr class="${tx.kind}"><td>${date}</td><td>${type}</td><td>${note}</td><td class="amount-col">${amountFormatted}</td><td>${category}</td><td>${subcategory}</td></tr>`; }).join('');
      modalBody.innerHTML = `<table class="movements-table"><thead><tr><th>Data</th><th>Tipo</th><th>Nota</th><th class="amount-col">Importo</th><th>Categoria</th><th>Sottocategoria</th></tr></thead><tbody>${rows}</tbody></table>`;
      const balance = totalIncome - totalExpense;
      modalFooter.innerHTML = `<div class="summary-item"><div class="summary-label">Totale Entrate</div><div class="summary-value total-income">+ ${totalIncome.toFixed(2)} €</div></div><div class="summary-item"><div class="summary-label">Totale Uscite</div><div class="summary-value total-expense">- ${totalExpense.toFixed(2)} €</div></div><div class="summary-item"><div class="summary-label">Saldo</div><div class="summary-value balance">${balance.toFixed(2)} €</div></div>`;
    }

    async function updateNotifications(){
      const today = new Date();
      const futureDate = new Date(); futureDate.setDate(today.getDate()+7);
      const upcoming = await getScheduledTransactions(today, futureDate);
      if (upcoming.length > 0){ notificationBadge.textContent = upcoming.length; notificationBadge.classList.add('is-visible'); } else { notificationBadge.textContent = ''; notificationBadge.classList.remove('is-visible'); }
    }

    async function loadAllDataForMonth(){
      await loadTransactions();
      const today = new Date();
      const futureDate = new Date(); futureDate.setDate(today.getDate()+30);
      const imminentDeadlines = await getScheduledTransactions(today, futureDate);
      if (imminentDeadlines.length > 0){ deadlinesSection.style.display = 'block'; renderDeadlinesList(deadlinesList, imminentDeadlines); } else { deadlinesSection.style.display = 'none'; }
      updateNotifications();
    }

    async function loadTransactions(){
      monthSelector.disabled = true;
      yearSelector.disabled = true;
      renderDashboard([]);
      try{
        const m = parseInt(monthSelector.value,10);
        const y = parseInt(yearSelector.value,10);
        const monthStart = new Date(Date.UTC(y, m, 1));
        const nextMonthStart = new Date(Date.UTC(y, m+1, 1));
        const startStr = monthStart.toISOString().split('T')[0];
        const nextStartStr = nextMonthStart.toISOString().split('T')[0];
        const { data, error } = await supabase.from('transactions').select('*').eq('created_by', user.id).gte('occurred_at', startStr).lt('occurred_at', nextStartStr).order('occurred_at', { ascending:false });
        if (error) throw error;
        allTransactions = (data || []).map(tx=>({ ...tx, categories: allCategories.find(c => String(c.id) === String(tx.category_id)) || null, subcategories: allSubcategories.find(s => String(s.id) === String(tx.subcategory_id)) || null }));
        renderDashboard(allTransactions);
      } catch (error){
        console.error("Errore transazioni:", error);
        showModal('Errore', `<p>Impossibile caricare le transazioni. Riprova più tardi.</p>`, [{ text:'Chiudi' }]);
      } finally {
        monthSelector.disabled = false;
        yearSelector.disabled = false;
      }
    }

    function handleEdit(id){
      const tx = allTransactions.find(t => String(t.id) === String(id)) || {};
      if (!tx.id){
        supabase.from('transactions').select('*').eq('id', id).single().then(({data, error})=>{ if (error || !data){ showModal('Errore', `<p>Impossibile trovare la transazione da modificare.</p>`, [{ text:'Chiudi' }]); return; } populateAndShowEditForm(data); });
      } else { populateAndShowEditForm(tx); }
      function populateAndShowEditForm(tx){
        if (tx.is_recurring_parent){ showModal('Azione non permessa', `<p>La modifica delle operazioni ricorrenti non è ancora supportata. Elimina la serie e creane una nuova.</p>`, [{ text:'Ho capito' }]); return; }
        formTitle.textContent = "✍️ Modifica Operazione";
        submitBtn.textContent = "Aggiorna";
        submitBtn.style.width = 'auto';
        cancelEditBtn.style.display = 'inline-block';
        formButtonsContainer.classList.add('is-editing');
        transactionIdInput.value = tx.id;
        document.getElementById('kind').value = tx.kind;
        document.getElementById('note').value = tx.note ?? '';
        document.getElementById('amount').value = safeToNumber(tx.amount);
        const dateToUse = tx.is_paid === false ? tx.due_date : tx.occurred_at;
        document.getElementById('occurred_at').value = (dateToUse || '').toString().split('T')[0] || '';
        const type = tx.is_paid === false ? 'scheduled' : 'single';
        document.querySelector(`input[name="transaction_type"][value="${type}"]`).checked = true;
        if (type === 'scheduled'){
          advancedOptionsWrapper.style.display = 'block';
          document.getElementById('due-date-options').style.display = 'grid';
          const dd = (tx.due_date || '').toString();
          document.getElementById('due_date').value = dd.includes('T') ? dd.split('T')[0] : dd;
          recurringOptions.style.display = 'none';
        } else {
          document.getElementById('due-date-options').style.display = 'none';
          recurringOptions.style.display = 'none';
          advancedOptionsWrapper.style.display = 'block';
        }
        updateCategoryDropdown();
        categorySelect.value = tx.category_id ?? '';
        updateSubcategories(tx.subcategory_id ?? null);
        window.scrollTo({ top:0, behavior:'smooth' });
      }
    }

    async function handleDelete(id){
      const { data: txToDelete, error: fetchError } = await supabase.from('transactions').select('is_recurring_parent').eq('id', id).single();
      if (fetchError && fetchError.code !== 'PGRST116'){ console.error("Errore recupero transazione da eliminare:", fetchError); showModal('Errore', 'Impossibile trovare l\'operazione da eliminare.', [{ text:'Chiudi' }]); return; }
      if (!txToDelete) return;
      let message = "<p>Sei sicuro di voler eliminare questa operazione?</p>";
      if (txToDelete.is_recurring_parent){ message = "<p>Questa è un'operazione ricorrente. Eliminando questa, <strong>verranno rimosse anche tutte le occorrenze future</strong>.</p><p>Vuoi procedere?</p>"; }
      showModal("Conferma eliminazione", message, [ { text:'Annulla', class:'btn-secondary' }, { text:'🗑️ Elimina', class:'delete', action: async ()=>{ try{ const { error } = await supabase.rpc('delete_transaction_and_children', { transaction_id_to_delete: id }); if (error) throw error; showStatusMessage('Operazione eliminata con successo!', 'success'); loadAllDataForMonth(); } catch (error){ console.error("Errore durante l'eliminazione via RPC:", error); let userMessage = "Impossibile completare l'eliminazione. Riprova."; if (error.message?.includes('permission denied')){ userMessage = "Errore: Permessi non sufficienti. Verifica le RLS sulla funzione e sulla tabella `transactions`."; } showModal('Errore', `<p>${userMessage}</p><p><small>Dettaglio: ${error.message}</small></p>`, [{ text:'Chiudi' }]); } } } ]);
    }

    async function handleFormSubmit(e){
      e.preventDefault();
      const formData = new FormData(transactionForm);
      const id = formData.get('transaction-id');
      const kind = formData.get('kind');
      if (id){ const kindText = kind === 'income' ? 'entrata' : 'spesa'; showModal(`Conferma Aggiornamento`, `<p>Sei sicuro di voler aggiornare questa ${kindText}?</p>`, [ { text:'Annulla', class:'btn-secondary' }, { text:'Aggiorna', class:'btn-primary', action:()=>saveTransaction(formData) } ]); } else { saveTransaction(formData); }
    }

    async function saveTransaction(formData){
      const id = formData.get('transaction-id');
      const transactionType = formData.get('transaction_type');
      const payload = { kind: formData.get('kind'), note: formData.get('note'), amount: formData.get('amount'), occurred_at: formData.get('occurred_at'), category_id: formData.get('category_id'), subcategory_id: formData.get('subcategory_id') || null, created_by: user.id, is_paid: true, due_date: null };
      if (transactionType === 'scheduled'){ const dueDate = formData.get('due_date') || formData.get('occurred_at'); if (!dueDate){ showModal('Dati mancanti', `<p>Seleziona una data di scadenza/incasso valida.</p>`, [{ text:'Chiudi' }]); return; } payload.due_date = dueDate; payload.is_paid = false; payload.occurred_at = dueDate; }
      try{
        let error;
        if (transactionType === 'recurring' && !id){
          const endDateStr = formData.get('recurring_end_date');
          if (!endDateStr){ showModal('Dati mancanti', `<p>Seleziona una data di fine valida per l'operazione ricorrente.</p>`, [{ text:'Chiudi' }]); return; }
          payload.is_recurring_parent = true;
          const { data: parentData, error: parentError } = await supabase.from('transactions').insert(payload).select().single();
          if (parentError) throw parentError;
          const [y0,m0,d0] = payload.occurred_at.split('-').map(n=>parseInt(n,10));
          const endParts = endDateStr.split('-').map(n=>parseInt(n,10));
          const endDate = new Date(Date.UTC(endParts[0], endParts[1]-1, endParts[2]));
          let current = new Date(Date.UTC(y0, m0-1, d0));
          const children = [];
          while (true){ current.setUTCMonth(current.getUTCMonth()+1); if (current > endDate) break; const yyyy = current.getUTCFullYear(); const mm = String(current.getUTCMonth()+1).padStart(2,'0'); const dd = String(current.getUTCDate()).padStart(2,'0'); const iso = `${yyyy}-${mm}-${dd}`; children.push({ ...payload, is_recurring_parent: false, parent_transaction_id: parentData.id, occurred_at: iso, due_date: iso, is_paid: false }); }
          if (children.length){ const { error: chErr } = await supabase.from('transactions').insert(children); if (chErr) error = chErr; }
        } else {
          const query = id ? supabase.from('transactions').update(payload).eq('id', id) : supabase.from('transactions').insert(payload);
          const { error: singleError } = await query;
          error = singleError;
        }
        if (error) throw error;
        if (!id && transactionType !== 'scheduled'){ if (payload.kind === 'income') await showTransactionAnimation('income'); if (payload.kind === 'expense') await showTransactionAnimation('expense'); }
        showStatusMessage(id ? 'Operazione aggiornata!' : 'Operazione aggiunta!', 'success');
        resetFormToCreateMode();
        loadAllDataForMonth();
      } catch (error){
        console.error("Errore nel salvataggio:", error);
        showModal('Errore di Salvataggio', `<p>Non è stato possibile salvare l'operazione. Controlla i dati e riprova.</p><p><small>Dettaglio: ${error.message}</small></p>`, [{ text:'Chiudi' }]);
      }
    }

    async function handleConfirmDeadline(id){
      showModal( 'Conferma Operazione', '<p>Vuoi registrare questa operazione con la data di oggi?</p>', [ { text: 'Annulla', class: 'btn-secondary' }, { text: 'Conferma', class: 'btn-primary', action: async () => { try { const { error } = await supabase.from('transactions').update({ is_paid: true, occurred_at: new Date().toISOString().split('T')[0] }).eq('id', id); if (error) throw error; loadAllDataForMonth(); } catch (error) { console.error("Errore nell'aggiornamento dell'operazione:", error); showModal('Errore', `<p>Impossibile aggiornare l'operazione. Riprova.</p>`, [{ text: 'Chiudi' }]); } } } ]);
    }

    // --- MODIFICA: Funzioni per il bottone abbonamento ---
    function renderSubscriptionStatus(profile) {
      if (!profile || !profile.plan_type) {
          subscriptionStatusBtn.style.display = 'none';
          return;
      }
      let text = '';
      let link = '#';
      switch(profile.plan_type) {
          case 'starter': case 'trial':
              if (profile.trial_end) {
                  const endDate = new Date(profile.trial_end);
                  const today = new Date(); today.setHours(0,0,0,0);
                  const diffTime = endDate - today;
                  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                  if (diffDays >= 0) {
                      if (diffDays > 10) text = `✨ Sblocca tutto! ${diffDays} giorni rimasti`;
                      else if (diffDays > 3) text = `⏰ L'offerta scade! ${diffDays} giorni rimasti`;
                      else text = diffDays > 1 ? `🔥 Affrettati! Solo ${diffDays} giorni` : `🔥 Ultimo giorno! Aggiorna ora`;
                      link = '/it/pricing.html';
                  } else { text = '😭 Prova Scaduta. Aggiorna ora!'; link = '/it/pricing.html'; }
              } break;
          case 'plus': text = 'MyHomesBudget PLUS'; link = '/it/account.html'; break;
          case 'pro': text = 'MyHomesBudget PRO'; link = '/it/account.html'; break;
      }
      if (text) {
          subscriptionStatusBtn.textContent = text;
          subscriptionStatusBtn.href = link;
          subscriptionStatusBtn.style.display = 'flex';
      } else {
          subscriptionStatusBtn.style.display = 'none';
      }
    }
    function positionSubscriptionButton() {
      const topCenter = document.querySelector('.top-center');
      const topActions = document.querySelector('.top-actions');
      if (!topCenter || !topActions || !subscriptionStatusBtn) return;
      if (window.innerWidth <= 1200) {
          if (subscriptionStatusBtn.parentElement !== topActions) topActions.prepend(subscriptionStatusBtn);
      } else {
          if (subscriptionStatusBtn.parentElement !== topCenter) topCenter.appendChild(subscriptionStatusBtn);
      }
    }

    async function initializePage(){
      try{
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) { location.replace("/it/login.html"); return; }
        user = session.user;
        
        // MODIFICA: Carica il profilo completo per mostrare lo stato dell'abbonamento
        const { data: profile } = await supabase.from('profiles').select('onboarded, plan_type, trial_end').eq('id', user.id).single();
        if (profile && !profile.onboarded) { location.replace("/it/onboarding.html"); return; }
        
        // MODIFICA: Renderizza e posiziona il bottone abbonamento
        renderSubscriptionStatus(profile);
        positionSubscriptionButton();
        window.addEventListener('resize', positionSubscriptionButton);

        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();
        const months = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
        months.forEach((month, index) => monthSelector.add(new Option(month, index)));
        for (let i = currentYear - 2; i <= currentYear + 5; i++) {
          yearSelector.add(new Option(i, i));
        }
        monthSelector.value = currentMonth;
        yearSelector.value = currentYear;

        document.getElementById('occurred_at').valueAsDate = new Date();

        await loadInitialData();
        updateCategoryDropdown();
        await loadGoals();
        await loadAllDataForMonth();

        const mainContainer = document.querySelector('main.container');
        function handleActionClicks(e){
          const target = e.target.closest('button[data-id]');
          if (!target) return;
          const id = target.dataset.id;
          const isModal = target.closest('.modal-overlay');
          if (target.classList.contains('edit-btn')){ handleEdit(id); if (isModal) isModal.classList.remove('is-visible'); } 
          else if (target.classList.contains('delete-btn')){ handleDelete(id); } 
          else if (target.classList.contains('btn-action-deadline')){ handleConfirmDeadline(id); if (isModal) isModal.classList.remove('is-visible'); }
        }
        mainContainer.addEventListener('click', handleActionClicks);
        schedulerModal.addEventListener('click', handleActionClicks);

        kindSelect.addEventListener('change', updateCategoryDropdown);
        categorySelect.addEventListener('change', () => updateSubcategories());
        transactionForm.addEventListener('submit', handleFormSubmit);
        cancelEditBtn.addEventListener('click', resetFormToCreateMode);
        logoutBtn.addEventListener('click', async (e) => { e.preventDefault(); await supabase.auth.signOut(); location.replace("/it/") });
        monthSelector.addEventListener('change', loadAllDataForMonth);
        yearSelector.addEventListener('change', loadAllDataForMonth);

        listMovementsBtn.addEventListener('click', (e) => {
          e.preventDefault();
          renderMovementsListModal(allTransactions, months);
          movementsModal.classList.add('is-visible');
        });

        document.querySelectorAll('input[name="transaction_type"]').forEach(radio=>{
          radio.addEventListener('change', (e)=>{
            const v = e.target.value;
            advancedOptionsWrapper.style.display = 'block';
            recurringOptions.style.display = (v === 'recurring') ? 'grid' : 'none';
            dueDateOptions.style.display = (v === 'scheduled') ? 'grid' : 'none';
          });
        });

        schedulerBtn.addEventListener('click', async () => {
          const selectedMonth = monthSelector.value;
          const selectedYear = yearSelector.value;
          const startDate = new Date(selectedYear, selectedMonth, 1);
          const endDate = new Date(selectedYear, parseInt(selectedMonth)+1, 0);
          const scheduled = await getScheduledTransactions(startDate, endDate);
          schedulerModal.querySelector('.modal-title').textContent = `Scadenziario per ${months[selectedMonth]} ${selectedYear}`;
          renderDeadlinesList(schedulerModal.querySelector('.modal-body'), scheduled);
          schedulerModal.classList.add('is-visible');
        });

        notificationsBtn.addEventListener('click', async () => {
          const today = new Date();
          const futureDate = new Date(); futureDate.setDate(today.getDate()+7);
          const upcoming = await getScheduledTransactions(today, futureDate);
          schedulerModal.querySelector('.modal-title').textContent = `Notifiche (Prossimi 7 giorni)`;
          renderDeadlinesList(schedulerModal.querySelector('.modal-body'), upcoming);
          schedulerModal.classList.add('is-visible');
        });

        document.body.addEventListener('click', (e)=>{
          const modal = e.target.closest('.modal-overlay');
          if (modal && (e.target.classList.contains('modal-overlay') || e.target.closest('.modal-close'))){
            modal.classList.remove('is-visible');
          }
        });

        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const topActions = document.querySelector('.top-actions');
        if (mobileMenuBtn && topActions) {
          mobileMenuBtn.addEventListener('click', (e) => { e.stopPropagation(); topActions.classList.toggle('is-open'); });
          document.addEventListener('click', (e) => { if (!topActions.contains(e.target) && !mobileMenuBtn.contains(e.target)) { topActions.classList.remove('is-open'); } });
        }
      } catch (err){
        console.error("Errore critico durante l'inizializzazione:", err);
        const body = document.querySelector('body');
        if (body){
          body.innerHTML = `<div style="padding:40px;text-align:center;background-color:#fff;border-radius:12px;margin:50px auto;max-width:500px;">
            <h2>Errore Critico</h2>
            <p>Impossibile caricare la dashboard. L'applicazione si è bloccata.</p>
            <p><strong>Dettaglio:</strong> ${err.message}</p>
            <p>Prova a ricaricare la pagina.</p></div>`;
        }
      }
    }

    document.addEventListener('DOMContentLoaded', initializePage);
// === PLAN ENFORCEMENT v2 (read-only senza interferire col rendering) ===
const PLAN_UPGRADE_URL = "/it/pricing.html";
window.__READ_ONLY_MODE__ = false;

// 1) Helpers
function plan_isTrialExpired(profile){
  if (!profile) return false;
  const t = (profile.plan_type || "").toLowerCase();
  if (t !== "starter" && t !== "trial") return false;
  if (!profile.trial_end) return false;
  const end = new Date(profile.trial_end);
  const today = new Date(); today.setHours(0,0,0,0);
  return end < today;
}
function plan_showUpgrade(msg="Questa azione richiede un piano attivo."){
  // usa eventuale modale della pagina, altrimenti fallback
  if (typeof showModal === "function"){
    showModal("Prova scaduta", `
      <p>${msg}</p>
      <p><strong>La tua prova è scaduta.</strong> Aggiorna il piano per continuare.</p>`,
      [
        { text:"Chiudi", class:"btn-secondary" },
        { text:"Aggiorna ora", class:"btn-primary", action:()=>location.href = PLAN_UPGRADE_URL }
      ]
    );
  } else {
    alert("Prova scaduta. Aggiorna il piano per continuare.");
    location.href = PLAN_UPGRADE_URL;
  }
}
function plan_addReadonlyBanner(){
  if (document.getElementById("plan-readonly-banner")) return;
  const host = document.getElementById("dash-nav")?.parentElement || document.querySelector("main.container") || document.body;
  const banner = document.createElement("div");
  banner.id = "plan-readonly-banner";
  banner.style.cssText = "margin:-8px 0 16px 0;padding:12px 16px;border-radius:12px;font-weight:800;color:#fff;background:linear-gradient(135deg,#d32f2f,#ff7675);box-shadow:0 8px 20px rgba(0,0,0,.15);";
  banner.innerHTML = `🔒 Prova scaduta — modalità <u>sola lettura</u>. <a href="${PLAN_UPGRADE_URL}" style="color:#fff;text-decoration:underline;font-weight:900">Aggiorna ora</a>`;
  const nav = document.getElementById("dash-nav");
  if (nav && nav.parentElement){
    nav.parentElement.insertBefore(banner, nav.nextSibling);
  } else {
    host.prepend(banner);
  }
}

// 2) Applica sola-lettura SOLO su controlli di scrittura, senza toccare altro UI
function plan_applyReadOnlyUI(){
  // Form "Nuova Operazione"
  const submitBtn = document.getElementById("submit-btn");
  if (submitBtn){
    submitBtn.disabled = true;
    submitBtn.textContent = "Aggiorna piano per aggiungere";
  }

  // Obiettivo (evita MutationObserver: tocco solo pulsanti noti)
  const goalConfirm = document.getElementById("g1-confirm-btn");
  if (goalConfirm){
    goalConfirm.disabled = true;
    goalConfirm.textContent = "Aggiorna piano per confermare";
  }

  // Non blocchiamo chip/metodi o campi input per evitare side-effects sul rendering.
  plan_addReadonlyBanner();
}

// 3) Intercetta SOLO funzioni che scrivono (se esistono) — nessun listener globale
function plan_guardWrites(){
  const fnNames = ["saveTransaction","handleDelete","handleConfirmDeadline","confirmGoalSettings","saveGoalSettings"];
  fnNames.forEach(name=>{
    const orig = window[name];
    if (typeof orig === "function"){
      window["__orig_"+name] = orig;
      window[name] = async function(...args){
        if (window.__READ_ONLY_MODE__){
          plan_showUpgrade();
          return;
        }
        return await orig.apply(this, args);
      };
    }
  });
}

// 4) Inizializza DOPO che la pagina ha fatto il suo bootstrap
async function plan_initEnforcement(){
  try{
    if (!window.supabase) return;
    // Attendi un attimo che la pagina esegua initializePage() e popoli la UI
    await new Promise(r => setTimeout(r, 600));

    const { data: { session } } = await supabase.auth.getSession();
    if (!session) return;

    const { data: profile, error } = await supabase
      .from("profiles")
      .select("plan_type, trial_end")
      .eq("id", session.user.id)
      .single();
    if (error) { console.warn("[PlanGuard] Profilo non letto:", error); return; }

    const expired = plan_isTrialExpired(profile);
    window.__READ_ONLY_MODE__ = expired;

    if (expired){
      plan_applyReadOnlyUI();
      plan_guardWrites();
    }
  } catch (err){
    console.error("[PlanGuard] Errore init:", err);
  }
}

// Avvio con piccola dilazione per non interferire con il rendering
if (document.readyState === "loading"){
  document.addEventListener("DOMContentLoaded", ()=>setTimeout(plan_initEnforcement, 300));
} else {
  setTimeout(plan_initEnforcement, 300);
}
// === /PLAN ENFORCEMENT v2 ===
</script>
</body>
</html>
