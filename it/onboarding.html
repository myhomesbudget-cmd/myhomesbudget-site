<!doctype html>
<html lang="it" data-app="myhomesbudget">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Configurazione Iniziale — MyHomesBudget</title>
  <meta name="description" content="Configura il tuo profilo in pochi passi per iniziare a gestire il tuo bilancio familiare.">
  <meta name="robots" content="noindex, nofollow">
  <meta name="color-scheme" content="light dark">

  <!-- Guard: se già completata → dashboard (override con ?edit=1) -->
  <script>
    (function(){
      function itPrefix(){
        var m = location.pathname.match(/^\/(it|ita)(\/|$)/i);
        return m ? ("/" + m[1].toLowerCase() + "/") : "/it/";
      }
      var editing = new URLSearchParams(location.search).get('edit') === '1';
      if (editing) return;
      try {
        if (localStorage.getItem('onboarding_completed') === '1') {
          location.replace(itPrefix() + 'dashboard.html');
        }
      } catch(e){}
    })();
  </script>

  <!-- CSP (aggiunto Supabase in connect-src) -->
  <meta http-equiv="Content-Security-Policy"
      content="default-src 'self';
               img-src 'self' https: data:;
               style-src 'self' 'unsafe-inline';
               script-src 'self' 'unsafe-inline'
                          https://www.googletagmanager.com
                          https://www.google-analytics.com
                          https://esm.sh;
               connect-src 'self'
                           https://www.google-analytics.com
                           https://region1.google-analytics.com
                           https://*.supabase.co;
               font-src 'self' https: data:;
               frame-ancestors 'none';
               base-uri 'self';
               form-action 'self'">

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-LSD3V9G957"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-LSD3V9G957', { anonymize_ip: true });
  </script>

  <!-- Performance -->
  <link rel="preload" href="/bg.webp" as="image" imagesrcset="/bg.webp" />
  <link rel="icon" href="/favicon.ico">

  <style>
    :root{
      --fg:#111; --glass:rgba(255,255,255,.58);
      --card-border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.10);
      --radius-lg:16px; --grad:linear-gradient(135deg,#6c5ce7,#00cec9);
    }
    *{box-sizing:border-box}
    html,body{font-family:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif}
    a:focus-visible,button:focus-visible,input:focus-visible{outline:2px solid #00cec9; outline-offset:2px; border-radius:8px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* Sfondo allineato a login/index */
    body{
      margin:0;color:#fff;background:url("/bg.webp") no-repeat center/cover fixed;
      min-height:100vh;display:flex;flex-direction:column;align-items:center;
    }
    body::before{content:"";position:fixed;inset:0;background:rgba(0,0,0,.08);z-index:-1}

    /* Topbar come login */
    .topbar{
      position:fixed;top:16px;left:50%;transform:translateX(-50%);
      width:min(920px,calc(100% - 40px));z-index:20;pointer-events:none;
      display:flex;align-items:center;justify-content:space-between;
    }
    .logo-link,.lang-selector,.top-actions{pointer-events:auto}
    .logo-link{display:flex;align-items:center;gap:8px;text-decoration:none}
    .logo-image{height:32px;border-radius:6px}
    .logo-text{font-weight:600;color:#fff;font-size:1.05rem;text-shadow:0 1px 2px rgba(0,0,0,.35)}
    .lang-selector{font-size:22px;display:flex;gap:8px}
    .lang-selector a{color:#fff;text-decoration:none;padding:6px 10px;border-radius:8px}
    .lang-selector a:hover{background:rgba(255,255,255,.12)}
    .top-actions{display:flex;gap:8px;align-items:center}
    .logout-link{
      color:#fff;text-decoration:none;padding:6px 10px;border-radius:10px;
      background:rgba(0,0,0,.28); border:1px solid rgba(255,255,255,.25);
    }
    .logout-link:hover{background:rgba(0,0,0,.38)}

    /* Pannello onboarding */
    main.panel{
      margin-top:84px; /* stacca dalla topbar */
      width:min(920px,calc(100% - 40px));
      background:var(--glass); color:var(--fg); border-radius:var(--radius-lg);
      padding:clamp(18px,4vw,22px); box-shadow:var(--shadow);
      display:flex;flex-direction:column;gap:16px;
    }

    /* Header del pannello */
    .panel-header{background:rgba(255,255,255,.55);border-radius:12px;padding:14px;border:1px solid var(--card-border)}
    .progress-bar{width:100%;height:8px;background:rgba(0,0,0,.1);border-radius:4px;overflow:hidden}
    .progress-bar-inner{width:0%;height:100%;background:#6c5ce7;transition:width .4s ease}
    .step-indicator{font-size:.9rem;font-weight:600;color:#555;margin-top:8px;text-align:right}

    /* Corpo */
    .step{display:none}
    .step.is-active{display:block;animation:fadeIn .45s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .step-title{text-align:center;margin:6px 0 8px;font-size:clamp(1.5rem,4vw,1.8rem);color:#111}
    .step-description{text-align:center;color:#333;margin:0 auto 16px;max-width:520px}

    .form-group{margin-bottom:16px}
    .options-grid{display:grid;gap:12px}
    @media(min-width:700px){ .options-grid.cols-2{grid-template-columns:1fr 1fr} }

    .option-label{
      display:block;padding:14px;border:2px solid transparent;border-radius:10px;
      background:rgba(255,255,255,.6);transition:.18s ease;cursor:pointer
    }
    .option-label:hover{background:#fff}
    input[type="radio"],input[type="checkbox"]{position:absolute;opacity:0;width:1px;height:1px}
    input[type="radio"]:checked + .option-label,
    input[type="checkbox"]:checked + .option-label{border-color:#6c5ce7;background:#fff}
    .option-label strong{display:block;font-size:1.05rem}
    .option-label span{font-size:.92rem;color:#444}

    .error-message{color:#842029;background:#f8d7da;border:1px solid #f5c2c7;border-radius:8px;padding:8px 10px;font-weight:600;text-align:center;display:none}
    .error-message.show{display:block}

    /* Footer del pannello */
    .panel-footer{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;font-weight:800}
    .btn-primary{background:#6c5ce7;color:#fff;box-shadow:0 8px 22px rgba(0,0,0,.14)}
    .btn-primary:hover{filter:brightness(1.07);transform:translateY(-1px)}
    .btn-secondary{background:#fff;color:#111;border:1px solid rgba(0,0,0,.12)}
    .btn-secondary:hover{background:#f7f7f7}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
  <!-- Topbar -->
  <nav class="topbar" aria-label="Barra superiore">
    <a href="/it/" class="logo-link" title="MyHomesBudget">
      <img src="/homes.png" alt="Logo MyHomesBudget" class="logo-image" loading="lazy">
      <span class="logo-text">MyHomesBudget</span>
    </a>
    <div class="top-actions">
      <span class="lang-selector" aria-label="Selettore lingue">
        <a href="/it/onboarding.html" lang="it" aria-current="page">🇮🇹</a>
        <a href="/en/onboarding.html" lang="en">🇬🇧</a>
        <a href="/es/onboarding.html" lang="es">🇪🇸</a>
      </span>
      <!-- 🔹 Esci -->
      <a href="#" id="logout-btn" class="logout-link" aria-label="Esci">Esci</a>
    </div>
  </nav>

  <!-- Pannello -->
  <main class="panel">
    <div class="panel-header">
      <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-labelledby="step-indicator">
        <div class="progress-bar-inner"></div>
      </div>
      <div id="step-indicator" class="step-indicator" aria-live="polite"></div>
    </div>

    <section id="step-1" class="step is-active" data-step="1" aria-describedby="s1d">
      <h1 class="step-title">Qual è il tuo obiettivo principale?</h1>
      <p id="s1d" class="step-description">Scegliere un obiettivo ci aiuta a personalizzare la tua esperienza.</p>
      <fieldset class="form-group">
        <legend class="sr-only">Scegli un obiettivo</legend>
        <div class="options-grid" id="goal-options">
          <div>
            <input type="radio" id="goal-saving" name="goal" value="Risparmio fisso mensile" aria-describedby="error">
            <label for="goal-saving" class="option-label">
              <strong>💰 Risparmio fisso mensile</strong>
              <span>Accantona una somma specifica ogni mese.</span>
            </label>
          </div>
          <div>
            <input type="radio" id="goal-debts" name="goal" value="Riduzione debiti e Finanziamenti" aria-describedby="error">
            <label for="goal-debts" class="option-label">
              <strong>📉 Riduzione debiti e Finanziamenti</strong>
              <span>Monitora e riduci i tuoi debiti in modo efficace.</span>
            </label>
          </div>
          <div>
            <input type="radio" id="goal-objective" name="goal" value="Raggiungi un obiettivo" aria-describedby="error">
            <label for="goal-objective" class="option-label">
              <strong>🎯 Raggiungi un obiettivo</strong>
              <span>Viaggi, acquisti importanti, progetti personali.</span>
            </label>
          </div>
        </div>
      </fieldset>
    </section>

    <section id="step-2" class="step" data-step="2" aria-describedby="s2d">
      <h1 id="step-2-title" class="step-title">Come vuoi procedere?</h1>
      <p id="s2d" class="step-description">Scegli la modalità che preferisci per gestire le tue finanze.</p>
      <fieldset class="form-group">
        <legend class="sr-only">Scegli una modalità</legend>
        <div class="options-grid" id="method-options">
          <div>
            <input type="radio" id="method-fixed" name="saving_method" value="Cifra fissa" aria-describedby="error">
            <label for="method-fixed" class="option-label">
              <strong>🗓️ Cifra fissa mensile</strong>
              <span>Destina un importo prestabilito ogni mese.</span>
            </label>
          </div>
          <div>
            <input type="radio" id="method-variable" name="saving_method" value="Importo variabile" aria-describedby="error">
            <label for="method-variable" class="option-label">
              <strong>🎛️ Importo variabile</strong>
              <span>Decidi quanto accantonare in base alle tue spese.</span>
            </label>
          </div>
          <div>
            <input type="radio" id="method-percentage" name="saving_method" value="Percentuale sulle entrate" aria-describedby="error">
            <label for="method-percentage" class="option-label">
              <strong>📊 Percentuale sulle entrate</strong>
              <span>Imposta una percentuale fissa da destinare al tuo obiettivo.</span>
            </label>
          </div>
        </div>
      </fieldset>
    </section>

    <section id="step-3" class="step" data-step="3" aria-describedby="s3d">
      <h1 class="step-title">Seleziona le tue categorie di spesa</h1>
      <p id="s3d" class="step-description">Scegli quelle che usi più spesso. Potrai aggiungerle o modificarle in qualsiasi momento.</p>
      <fieldset class="form-group">
        <legend class="sr-only">Scegli le categorie</legend>
        <div class="options-grid cols-2" id="category-options"><!-- popolato via JS --></div>
      </fieldset>
    </section>

    <div id="error" class="error-message" role="alert" aria-live="polite"></div>

    <div class="panel-footer">
      <button id="back-btn" class="btn btn-secondary">Indietro</button>
      <button id="next-btn" class="btn btn-primary">Avanti</button>
    </div>
  </main>

  <!-- 🧩 Supabase: salvataggio profilo/onboarding -->
  <script type="module">
    import { supabase } from "/it/supabase-client.js";

const { data: { user } } = await supabase.auth.getUser();
if (!user) location.replace("/it/login.html");

await supabase.from('profiles').upsert({
  id: user.id,
  onboarding_goal: state.goal,
  onboarding_saving_method: state.saving_method,
  onboarding_categories: state.categories,   // array JS → JSONB
  onboarded: true
});
localStorage.setItem('onboarding_completed','1'); // opzionale
location.replace('/it/dashboard.html');

    // Espongo una funzione globale per il salvataggio: la usa lo script non-module sotto.
    window.mhbSaveOnboarding = async (state) => {
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return false; // utente non loggato → niente DB, ma non bloccare

        const payload = {
          id: user.id,
          email: user.email,
          onboarding_goal: state.goal || null,
          onboarding_saving_method: state.saving_method || null,
          onboarding_categories: state.categories || [],
          onboarded: true
        };

        const { error } = await supabase
          .from("profiles")
          .upsert(payload, { onConflict: "id" });

        if (error) { console.warn("save onboarding error:", error.message); return false; }
        return true;
      } catch (e) {
        console.warn("save onboarding exception:", e?.message || e);
        return false;
      }
    };
  </script>

  <!-- Logica onboarding -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    try { localStorage.setItem('mhb_lang','it'); } catch(e){}

    const ga = (...args) => { try { if (window.gtag) window.gtag(...args); } catch(_){} };

    const TOTAL_STEPS = 3;
    const CATEGORIES = [
      '🏠 Casa','🛠️ Casa Straordinarie','💡 Utenze','🛒 Spesa alimentare','🚗 Auto/Moto',
      '🚌 Trasporti (pubblici/mobilità)','❤️ Salute','🎓 Istruzione/Formazione','⚽ Tempo libero & Sport',
      '🍽️ Ristoranti & Bar','👕 Abbigliamento & Cura personale','👨‍👩‍👧‍👦 Famiglia & Bambini',
      '✈️ Viaggi & Vacanze','🎁 Regali & Donazioni','🐾 Animali domestici','💻 Abbonamenti & Servizi digitali',
      '🧾 Tasse & Tributi','📦 Altro'
    ];

    const backBtn = document.getElementById('back-btn');
    const nextBtn = document.getElementById('next-btn');
    const progressBar = document.querySelector('.progress-bar');
    const progressBarInner = document.querySelector('.progress-bar-inner');
    const stepIndicator = document.getElementById('step-indicator');
    const errorBox = document.getElementById('error');
    const steps = document.querySelectorAll('.step');

    let currentStep = 1;
    const state = { goal: null, saving_method: null, categories: [] };

    function itPrefix(){
      const m = location.pathname.match(/^\/(it|ita)(\/|$)/i);
      return m ? ("/" + m[1].toLowerCase() + "/") : "/it/";
    }
    function showError(msg){ errorBox.textContent = msg || ''; errorBox.classList.toggle('show', !!msg); }

    function populateCategories(){
      const container = document.getElementById('category-options');
      if (!container.childElementCount){
        CATEGORIES.forEach((cat,i) => {
          const id = 'cat-' + i;
          const w = document.createElement('div');
          w.innerHTML = `
            <input type="checkbox" id="${id}" name="category" value="${cat}" aria-describedby="error">
            <label for="${id}" class="option-label"><strong>${cat}</strong></label>
          `;
          container.appendChild(w);
        });
      }
    }

    function loadState(){
      try{
        state.goal = localStorage.getItem('onboarding_goal');
        state.saving_method = localStorage.getItem('onboarding_saving_method');
        const cats = localStorage.getItem('onboarding_categories');
        if (cats) state.categories = JSON.parse(cats) || [];
      }catch(e){}
    }

    function saveState(){
      try{
        if (state.goal) localStorage.setItem('onboarding_goal', state.goal);
        if (state.saving_method) localStorage.setItem('onboarding_saving_method', state.saving_method);
        localStorage.setItem('onboarding_categories', JSON.stringify(state.categories || []));
      }catch(e){}
    }

    function populateFormWithState(){
      if (state.goal){
        const el = document.querySelector(`input[name="goal"][value="${state.goal}"]`);
        if (el) el.checked = true;
      }
      if (state.saving_method){
        const el = document.querySelector(`input[name="saving_method"][value="${state.saving_method}"]`);
        if (el) el.checked = true;
      }
      if (state.categories?.length){
        state.categories.forEach(c => {
          const el = document.querySelector(`input[name="category"][value="${c}"]`);
          if (el) el.checked = true;
        });
      }
    }

    function customizeStep2(){
      const title = document.getElementById('step-2-title');
      const description = document.getElementById('s2d');
      switch (state.goal) {
        case 'Risparmio fisso mensile':
          title.textContent = 'Come vuoi risparmiare?';
          description.textContent = 'Scegli la strategia di risparmio più adatta a te.';
          break;
        case 'Riduzione debiti e Finanziamenti':
          title.textContent = 'Come vuoi affrontare debiti e finanziamenti?';
          description.textContent = 'Scegli un metodo per ridurre le tue uscite mese dopo mese.';
          break;
        case 'Raggiungi un obiettivo':
          title.textContent = 'Come vuoi raggiungere il tuo obiettivo?';
          description.textContent = 'Qualsiasi sia il tuo traguardo, scegli come arrivarci.';
          break;
        default:
          title.textContent = 'Come vuoi procedere?';
          description.textContent = 'Scegli la modalità che preferisci per gestire le tue finanze.';
      }
    }

    function renderStep(n){
      ga('event','onboarding_step_view',{ step: n });

      steps.forEach(s => s.classList.toggle('is-active', parseInt(s.dataset.step,10) === n));
      const progress = n <= TOTAL_STEPS ? ((n - 1) / TOTAL_STEPS) * 100 : 100;
      progressBarInner.style.width = progress + '%';
      progressBar.setAttribute('aria-valuenow', String(progress));
      stepIndicator.textContent = n <= TOTAL_STEPS ? `Passo ${n} di ${TOTAL_STEPS}` : 'Completato!';

      backBtn.style.visibility = (n > 1 && n <= TOTAL_STEPS) ? 'visible' : 'hidden';
      nextBtn.textContent = (n === TOTAL_STEPS) ? 'Fine' : 'Avanti';
      showError('');

      if (n === 2) customizeStep2();
    }

    function validateStep(n){
      showError('');
      if (n === 1){
        const sel = document.querySelector('input[name="goal"]:checked');
        if (!sel){ showError('Per favore, scegli un obiettivo.'); return false; }
        state.goal = sel.value; saveState(); return true;
      }
      if (n === 2){
        const sel = document.querySelector('input[name="saving_method"]:checked');
        if (!sel){ showError('Per favore, scegli una modalità.'); return false; }
        state.saving_method = sel.value; saveState(); return true;
      }
      if (n === 3){
        const sel = [...document.querySelectorAll('input[name="category"]:checked')].map(e=>e.value);
        if (!sel.length){ showError('Per favore, seleziona almeno una categoria.'); return false; }
        state.categories = sel; saveState(); return true;
      }
      return true;
    }

    // 👉 handler async per poter attendere il salvataggio su Supabase
    nextBtn.addEventListener('click', async () => {
      if (!validateStep(currentStep)) return;

      if (currentStep === TOTAL_STEPS){
        try { localStorage.setItem('onboarding_completed','1'); } catch(e){}
        ga('event','onboarding_completed');

        // Salva su DB se possibile (definita dal modulo precedente)
        try {
          if (window.mhbSaveOnboarding) {
            await window.mhbSaveOnboarding(state);
          }
        } catch(e){ console.warn('save onboarding skipped:', e); }

        location.replace(itPrefix() + 'dashboard.html');
        return;
      }
      currentStep++; renderStep(currentStep);
    });

    backBtn.addEventListener('click', () => {
      if (currentStep > 1){ currentStep--; renderStep(currentStep); }
    });

    populateCategories();
    loadState();
    populateFormWithState();
    renderStep(currentStep);
  });
  </script>

  <!-- 🔹 Logout Supabase -->
  <script type="module">
    import { supabase } from "/it/supabase-client.js";

    const logoutBtn = document.getElementById('logout-btn');
    const itPrefix = () => {
      const m = location.pathname.match(/^\/(it|ita)(\/|$)/i);
      return m ? ("/" + m[1].toLowerCase() + "/") : "/it/";
    };

    logoutBtn?.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        if (typeof gtag === 'function') gtag('event','logout',{page:'onboarding',lang:'it'});
        await supabase.auth.signOut();
// opzionale: pulisci solo chiavi locali non persistenti
location.replace('/it/');
      } catch (err) {
        console.warn('Logout error:', err);
      } finally {
        try {
          localStorage.removeItem('onboarding_goal');
          localStorage.removeItem('onboarding_saving_method');
          localStorage.removeItem('onboarding_categories');
          localStorage.removeItem('onboarding_completed');
          localStorage.removeItem('mhb_lang');
          localStorage.removeItem('email_verified');
        } catch(e){}
        location.replace(itPrefix());
      }
    });
  </script>
</body>
</html>
