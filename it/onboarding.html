<!doctype html>
<html lang="it" data-app="myhomesbudget">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <title>Configurazione Obiettivo â€” MyHomesBudget</title>
Â  <meta name="description" content="Configura il tuo profilo in pochi passi per iniziare a gestire il tuo bilancio familiare.">
Â  <meta name="robots" content="noindex, nofollow">
Â  <link rel="icon" href="/favicon.ico">
Â  <style>
Â  Â  :root{
      --fg:#111;--bg:#f4f7fa;--glass:rgba(255,255,255,.6);
      --card-border:rgba(0,0,0,.08);--shadow:0 10px 30px rgba(0,0,0,.08);
      --radius-lg:16px;--primary-color:#6c5ce7;--danger-color:#d32f2f;--success-color:#2e7d32;
      --font-sans:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif;
      --grad: linear-gradient(135deg, #6c5ce7, #00cec9);
    }
Â  Â  *{box-sizing:border-box}
Â  Â  html,body{font-family:var(--font-sans)}
Â  Â  a:focus-visible,button:focus-visible,input:focus-visible,select:focus-visible{outline:2px solid #00cec9; outline-offset:2px; border-radius:8px}
Â  Â  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
Â  Â  body{margin:0;color:var(--fg);background:url("/bg.webp") no-repeat center/cover fixed;min-height:100vh;display:flex;flex-direction:column;align-items:center;}
Â  Â  body::before{content:"";position:fixed;inset:0;background:linear-gradient(135deg, rgba(108,92,231,.05), rgba(0,206,201,.05));z-index:-1}
    
    /* ====== TOPBAR ARMONIZZATA ====== */
    .topbar{position:fixed;top:0;left:0;right:0;height:60px;padding:0 24px;
      display:flex;align-items:center;justify-content:space-between;
      background:var(--glass);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
      border-bottom:1px solid var(--card-border);z-index:100}
    .logo-link{display:flex;align-items:center;gap:8px;text-decoration:none}
    .logo-text{font-weight:600;color:#fff;font-size:1.1rem;text-shadow:0 1px 2px rgba(0,0,0,.35)}
    .top-actions{display:flex;gap:12px;align-items:center}
    .top-link{
      color:#fff;text-decoration:none;padding:6px 12px;border-radius:10px;font-size:.9rem;
      font-weight:600;background: var(--grad);border: none;box-shadow: 0 4px 12px rgba(0,0,0,.15);
      transition: transform 0.2s ease, filter 0.2s ease, box-shadow 0.2s ease;}
    .top-link:hover {transform: translateY(-2px);filter: brightness(1.08);box-shadow: 0 6px 16px rgba(0,0,0,.20);}

    /* ====== PANNELLO PRINCIPALE ====== */
Â  Â  main.panel{margin-top:84px;width:min(920px,calc(100% - 40px));background:rgba(255,255,255,0.7); color:var(--fg); border-radius:var(--radius-lg);padding:clamp(18px,4vw,22px); box-shadow:var(--shadow);display:flex;flex-direction:column;gap:16px;}
Â  Â  .panel-header{background:rgba(255,255,255,.55);border-radius:12px;padding:14px;border:1px solid var(--card-border)}
Â  Â  .progress-bar{width:100%;height:8px;background:rgba(0,0,0,.1);border-radius:4px;overflow:hidden}
Â  Â  .progress-bar-inner{width:0%;height:100%;background:var(--grad);transition:width .4s ease}
Â  Â  .step-indicator{font-size:.9rem;font-weight:600;color:#555;margin-top:8px;text-align:right}
Â  Â  .step{display:none}
Â  Â  .step.is-active{display:block;animation:fadeIn .45s ease}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
Â  Â  .step-title{text-align:center;margin:6px 0 8px;font-size:clamp(1.5rem,4vw,1.8rem);color:#111}
Â  Â  .step-description{text-align:center;color:#333;margin:0 auto 16px;max-width:520px}
Â  Â  .options-grid{display:grid;gap:12px}
Â  Â  .category-columns {display: grid; gap: 24px;}
Â  Â  @media(min-width: 768px) { .category-columns {grid-template-columns: 1fr 1fr;} }
Â  Â  .column h3 { text-align: center; margin-top: 0; color: #333; }
Â  Â  .option-label{display:block;padding:14px;border:2px solid transparent;border-radius:10px;background:rgba(255,255,255,.6);transition:.18s ease;cursor:pointer}
Â  Â  .option-label:hover{background:#fff; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.05);}
Â  Â  input[type="radio"],input[type="checkbox"]{position:absolute;opacity:0;width:1px;height:1px}
Â  Â  input[type="radio"]:checked + .option-label,
Â  Â  input[type="checkbox"]:checked + .option-label{
        border-color:var(--primary-color);
        background:#fff;
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
Â  Â  .option-label strong{display:block;font-size:1.05rem}
Â  Â  .option-label span{font-size:.92rem;color:#444}
Â  Â  .option-details { display: none; grid-template-columns: 1fr auto; gap: 10px; align-items: center; padding: 10px 14px 0; }
Â  Â  input[type="radio"]:checked ~ .option-details { display: grid; }
Â  Â  .input-field { width: 100%; border: 1px solid #ccc; background: #fff; padding: 10px; border-radius: 8px; font-size: 1rem; }
Â  Â  .input-field::placeholder { color: #999; }
Â  Â  .error-message{color:#842029;background:#f8d7da;border:1px solid #f5c2c7;border-radius:8px;padding:8px 10px;font-weight:600;text-align:center;display:none}
Â  Â  .error-message.show{display:block}
Â  Â  .panel-footer{display:flex;justify-content:space-between;align-items:center;gap:12px; margin-top: 16px;}
    
    /* ====== BOTTONI CON VIBE ====== */
Â  Â  .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 24px;font-weight:800; transition: transform 0.2s ease, filter 0.2s ease, box-shadow 0.2s ease;}
    .btn:hover { transform: translateY(-2px); filter: brightness(1.08); }
Â  Â  .btn-primary{
        background: var(--grad);
        color:#fff;
        box-shadow: 0 8px 22px rgba(0,0,0,.18);
    }
    .btn-primary:hover { box-shadow: 0 10px 25px rgba(0,0,0,.22); }
Â  Â  .btn[disabled]{opacity:.6;cursor:not-allowed; transform: none; filter: none; box-shadow: none;}
Â  Â  .btn-secondary{
        background: rgba(255,255,255,0.8);
        color:#111;
        border:1px solid rgba(0,0,0,.08);
        box-shadow: 0 4px 12px rgba(0,0,0,.05);
    }
Â  </style>
</head>
<body>
Â  <nav class="topbar">
Â  Â  <a href="/it/" class="logo-link"><img src="/homes.png" alt="Logo" class="logo-image" style="height:32px;border-radius:6px"><span class="logo-text">MyHomesBudget</span></a>
Â  Â  <div class="top-actions"><a href="#" id="logout-btn" class="top-link">Esci</a></div>
Â  </nav>

Â  <main class="panel">
Â  Â  <div class="panel-header"><div class="progress-bar" role="progressbar"><div class="progress-bar-inner"></div></div><div id="step-indicator" class="step-indicator"></div></div>
Â  Â Â 
Â  Â  <section id="step-1" class="step" data-step="1">
Â  Â  Â  <h1 class="step-title">Qual Ã¨ il tuo obiettivo principale?</h1>
Â  Â  Â  <p class="step-description">Scegliere un obiettivo ci aiuta a personalizzare la tua esperienza e a tracciare i tuoi progressi.</p>
Â  Â  Â  <fieldset class="options-grid">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <input type="radio" id="goal-saving" name="goal_type" value="Risparmio">
Â  Â  Â  Â  Â  <label for="goal-saving" class="option-label"><strong>ğŸ’° Risparmio generico</strong><span>Accantona una somma specifica ogni mese.</span></label>
Â  Â  Â  Â  Â  <div class="option-details">
Â  Â  Â  Â  Â  Â  <input type="text" class="input-field" name="goal_name" value="Risparmio ANNUALE" readonly>
Â  Â  Â  Â  Â  Â  <input type="number" class="input-field" name="goal_target_amount" placeholder="5.000,00" step="100">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <input type="radio" id="goal-debts" name="goal_type" value="Riduzione Debiti">
Â  Â  Â  Â  Â  <label for="goal-debts" class="option-label"><strong>ğŸ“‰ Riduzione debiti</strong><span>Monitora e riduci i tuoi debiti in modo efficace.</span></label>
Â  Â  Â  Â  Â  <div class="option-details">
Â  Â  Â  Â  Â  Â  <input type="text" class="input-field" name="goal_name" placeholder="Es: Estinzione mutuo">
Â  Â  Â  Â  Â  Â  <input type="number" class="input-field" name="goal_target_amount" placeholder="70.000,00" step="1000">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <input type="radio" id="goal-objective" name="goal_type" value="Obiettivo Specifico">
Â  Â  Â  Â  Â  <label for="goal-objective" class="option-label"><strong>ğŸ¯ Raggiungi un obiettivo</strong><span>Viaggi, acquisti importanti, progetti personali.</span></label>
Â  Â  Â  Â  Â  <div class="option-details">
Â  Â  Â  Â  Â  Â  <input type="text" class="input-field" name="goal_name" placeholder="Es: Vacanza a New York">
Â  Â  Â  Â  Â  Â  <input type="number" class="input-field" name="goal_target_amount" placeholder="1.500,00" step="50">
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </fieldset>
Â  Â  </section>
Â  Â Â 
Â  Â  <section id="step-2" class="step" data-step="2">
Â  Â  Â  <h1 class="step-title">Come vuoi raggiungere il tuo obiettivo?</h1>
Â  Â  Â  <p class="step-description">Definisci il tuo contributo mensile. Questo diventerÃ  la base per il tuo budget di risparmio.</p>
Â  Â  Â  <fieldset class="options-grid">
Â  Â  Â  Â  Â <div>
Â  Â  Â  Â  Â  Â  <input type="radio" id="method-fixed" name="contribution_method" value="Cifra fissa">
Â  Â  Â  Â  Â  Â  <label for="method-fixed" class="option-label"><strong>ğŸ—“ï¸ Cifra fissa mensile</strong><span>Destina un importo prestabilito ogni mese.</span></label>
Â  Â  Â  Â  Â  Â  <div class="option-details"><input type="number" class="input-field" name="contribution_amount" placeholder="250,00" step="10"></div>
Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â <div>
Â  Â  Â  Â  Â  Â  <input type="radio" id="method-variable" name="contribution_method" value="Importo variabile">
Â  Â  Â  Â  Â  Â  <label for="method-variable" class="option-label"><strong>ğŸ›ï¸ Importo variabile</strong><span>Decidi quanto accantonare in base alle tue spese.</span></label>
Â  Â  Â  Â  Â  Â  <div class="option-details"><input type="number" class="input-field" name="contribution_amount" placeholder="250,00" step="10"></div>
Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â <div>
Â  Â  Â  Â  Â  Â  <input type="radio" id="method-percentage" name="contribution_method" value="Percentuale sulle entrate">
Â  Â  Â  Â  Â  Â  <label for="method-percentage" class="option-label"><strong>ğŸ“Š Percentuale sulle entrate</strong><span>Imposta una percentuale fissa del tuo reddito.</span></label>
Â  Â  Â  Â  Â  Â  <div class="option-details"><input type="number" class="input-field" name="contribution_amount" placeholder="10" step="1"></div>
Â  Â  Â  Â  Â </div>
Â  Â  Â  </fieldset>
Â  Â  </section>

Â  Â  <section id="step-3" class="step" data-step="3">
Â  Â  Â  Â  <h1 class="step-title">Scegli le tue categorie</h1>
Â  Â  Â  Â  <p class="step-description">Seleziona le voci di entrata e uscita che usi piÃ¹ spesso. Potrai sempre modificarle in seguito.</p>
Â  Â  Â  Â  <fieldset><div class="category-columns"><div class="column"><h3>Entrate</h3><div id="income-category-options" class="options-grid"></div></div><div class="column"><h3>Uscite</h3><div id="expense-category-options" class="options-grid"></div></div></div></fieldset>
Â  Â  </section>
Â  Â Â 
Â  Â  <div id="error" class="error-message"></div>
Â  Â  <div class="panel-footer"><button id="back-btn" class="btn btn-secondary">Indietro</button><button id="next-btn" class="btn btn-primary">Avanti</button></div>
Â  </main>
Â Â 
Â  <script type="module">
Â  Â  import { supabase } from "./supabase-client.js";

Â  Â  const TOTAL_STEPS = 3;
Â  Â  const state = {
Â  Â  Â  Â  goal_type: null, goal_name: null, goal_target_amount: null,
Â  Â  Â  Â  contribution_method: null, contribution_amount: null,
Â  Â  Â  Â  categories: []
Â  Â  };
Â  Â  let currentStep = 1;

Â  Â  const backBtn = document.getElementById('back-btn');
Â  Â  const nextBtn = document.getElementById('next-btn');
Â  Â  const logoutBtn = document.getElementById('logout-btn');
Â  Â  const progressBarInner = document.querySelector('.progress-bar-inner');
Â  Â  const stepIndicator = document.getElementById('step-indicator');
Â  Â  const errorBox = document.getElementById('error');
Â  Â  const steps = document.querySelectorAll('.step');

Â  Â  const itPrefix = () => (location.pathname.match(/^\/(it|ita)(\/|$)/i) ? `/${location.pathname.split('/')[1]}/` : "/it/");
Â  Â  const showError = (msg) => { errorBox.textContent = msg || ''; errorBox.classList.toggle('show', !!msg); };

Â  Â  function renderStep(n) {
Â  Â  Â  Â  steps.forEach(s => s.classList.toggle('is-active', parseInt(s.dataset.step, 10) === n));
Â  Â  Â  Â  const progress = n > 1 ? ((n - 1) / (TOTAL_STEPS - 1)) * 100 : 0;
Â  Â  Â  Â  progressBarInner.style.width = progress + '%';
Â  Â  Â  Â  (progressBarInner.parentElement).setAttribute('aria-valuenow', String(progress));
Â  Â  Â  Â  stepIndicator.textContent = `Passo ${n} di ${TOTAL_STEPS}`;
Â  Â  Â  Â  backBtn.style.visibility = (n > 1) ? 'visible' : 'hidden';
Â  Â  Â  Â  nextBtn.textContent = (n === TOTAL_STEPS) ? 'Fine' : 'Avanti';
Â  Â  Â  Â  showError('');
Â  Â  }

Â  Â  function populateCategoriesFromDB(defaultCategories) {
Â  Â  Â  Â  const incomeContainer = document.getElementById('income-category-options');
Â  Â  Â  Â  const expenseContainer = document.getElementById('expense-category-options');
Â  Â  Â  Â  if (incomeContainer.childElementCount > 0) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  defaultCategories.forEach((cat, i) => {
Â  Â  Â  Â  Â  Â  const id = 'cat-' + i;
Â  Â  Â  Â  Â  Â  const w = document.createElement('div');
Â  Â  Â  Â  Â  Â  w.innerHTML = `<input type="checkbox" id="${id}" name="category" value='${JSON.stringify(cat)}'><label for="${id}" class="option-label"><strong>${cat.icon} ${cat.name}</strong></label>`;
Â  Â  Â  Â  Â  Â  if (cat.kind === 'income') {
Â  Â  Â  Â  Â  Â  Â  Â  incomeContainer.appendChild(w);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  expenseContainer.appendChild(w);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function preselectFormData(goal, budget, userCategories) {
Â  Â  Â  Â  if (goal) {
Â  Â  Â  Â  Â  Â  const typeRadio = document.querySelector(`input[name="goal_type"][value="${goal.goal_type}"]`);
Â  Â  Â  Â  Â  Â  if (typeRadio) {
Â  Â  Â  Â  Â  Â  Â  Â  typeRadio.checked = true;
Â  Â  Â  Â  Â  Â  Â  Â  const parentDiv = typeRadio.closest('div');
Â  Â  Â  Â  Â  Â  Â  Â  if(parentDiv){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  parentDiv.querySelector('input[name="goal_name"]').value = goal.name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  parentDiv.querySelector('input[name="goal_target_amount"]').value = goal.target_amount;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  if (budget) {
Â  Â  Â  Â  Â  Â  const methodRadio = document.querySelector(`input[name="contribution_method"][value="Cifra fissa"]`); // Semplificato
Â  Â  Â  Â  Â  Â  if (methodRadio) {
Â  Â  Â  Â  Â  Â  Â  Â  methodRadio.checked = true;
Â  Â  Â  Â  Â  Â  Â  Â  const parentDiv = methodRadio.closest('div');
Â  Â  Â  Â  Â  Â  Â  Â  if(parentDiv){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â parentDiv.querySelector('input[name="contribution_amount"]').value = budget.amount;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const selectedNames = userCategories.map(c => c.name);
Â  Â  Â  Â  document.querySelectorAll('input[name="category"]').forEach(checkbox => {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const catObj = JSON.parse(checkbox.value);
Â  Â  Â  Â  Â  Â  Â  Â  if (selectedNames.includes(catObj.name)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  checkbox.checked = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch(e) {}
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function validateAndUpdateState(n) {
Â  Â  Â  Â  showError('');
Â  Â  Â  Â  if (n === 1) {
Â  Â  Â  Â  Â  Â  const typeRadio = document.querySelector('input[name="goal_type"]:checked');
Â  Â  Â  Â  Â  Â  if (!typeRadio) { showError('Per favore, scegli un obiettivo.'); return false; }
Â  Â  Â  Â  Â  Â  state.goal_type = typeRadio.value;
Â  Â  Â  Â  Â  Â  const parentDiv = typeRadio.closest('div');
Â  Â  Â  Â  Â  Â  const nameInput = parentDiv.querySelector('input[name="goal_name"]');
Â  Â  Â  Â  Â  Â  const amountInput = parentDiv.querySelector('input[name="goal_target_amount"]');
Â  Â  Â  Â  Â  Â  if (!nameInput || !amountInput) { showError('Errore interno, ricarica la pagina.'); return false; }
Â  Â  Â  Â  Â  Â  if (!nameInput.value.trim()) { showError('Per favore, inserisci un nome per il tuo obiettivo.'); return false; }
Â  Â  Â  Â  Â  Â  if (amountInput.value === '' || parseFloat(amountInput.value) <= 0) { showError('Per favore, inserisci un importo valido.'); return false; }
Â  Â  Â  Â  Â  Â  state.goal_name = nameInput.value.trim();
Â  Â  Â  Â  Â  Â  state.goal_target_amount = parseFloat(amountInput.value);
Â  Â  Â  Â  } else if (n === 2) {
Â  Â  Â  Â  Â  Â  const methodRadio = document.querySelector('input[name="contribution_method"]:checked');
Â  Â  Â  Â  Â  Â  if (!methodRadio) { showError('Per favore, scegli un metodo.'); return false; }
Â  Â  Â  Â  Â  Â  state.contribution_method = methodRadio.value;
Â  Â  Â  Â  Â  Â  const parentDiv = methodRadio.closest('div');
Â  Â  Â  Â  Â  Â  const amountInput = parentDiv.querySelector('input[name="contribution_amount"]');
Â  Â  Â  Â  Â  Â  if (!amountInput || amountInput.value === '' || parseFloat(amountInput.value) <= 0) { showError('Per favore, inserisci un importo o percentuale valida.'); return false; }
Â  Â  Â  Â  Â  Â  state.contribution_amount = parseFloat(amountInput.value);
Â  Â  Â  Â  } else if (n === 3) {
Â  Â  Â  Â  Â  Â  const sel = [...document.querySelectorAll('input[name="category"]:checked')].map(e => JSON.parse(e.value));
Â  Â  Â  Â  Â  Â  if (!sel.length) { showError('Per favore, seleziona almeno una categoria.'); return false; }
Â  Â  Â  Â  Â  Â  state.categories = sel;
Â  Â  Â  Â  }
Â  Â  Â  Â  return true;
Â  Â  }

Â  Â  async function saveOnboardingToSupabase(user, existingUserCategories) {
Â  Â  Â  Â  nextBtn.disabled = true;
Â  Â  Â  Â  nextBtn.textContent = 'Salvataggio...';
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  await supabase.from('goals').upsert({
Â  Â  Â  Â  Â  Â  Â  Â  user_id: user.id,
Â  Â  Â  Â  Â  Â  Â  Â  goal_type: state.goal_type,
Â  Â  Â  Â  Â  Â  Â  Â  name: state.goal_name,
Â  Â  Â  Â  Â  Â  Â  Â  target_amount: state.goal_target_amount,
Â  Â  Â  Â  Â  Â  }, { onConflict: 'user_id' });

Â  Â  Â  Â  Â  Â  const currentMonth = new Date().toISOString().slice(0, 7) + '-01';
Â  Â  Â  Â  Â  Â  await supabase.from('budgets').upsert({
Â  Â  Â  Â  Â  Â  Â  Â  user_id: user.id,
Â  Â  Â  Â  Â  Â  Â  Â  month: currentMonth,
Â  Â  Â  Â  Â  Â  Â  Â  macro_category: 'Risparmi',
Â  Â  Â  Â  Â  Â  Â  Â  amount: state.contribution_amount
Â  Â  Â  Â  Â  Â  }, { onConflict: 'user_id, month, macro_category' });

Â  Â  Â  Â  Â  Â  const existingNames = existingUserCategories.map(c => c.name);
Â  Â  Â  Â  Â  Â  const selectedObjects = state.categories;
Â  Â  Â  Â  Â  Â  const selectedNames = selectedObjects.map(c => c.name);
Â  Â  Â  Â  Â  Â  const categoriesToInsert = selectedObjects.filter(obj => !existingNames.includes(obj.name));
Â  Â  Â  Â  Â  Â  const categoriesToDelete = existingUserCategories.filter(cat => !selectedNames.includes(cat.name));

Â  Â  Â  Â  Â  Â  if (categoriesToDelete.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  const idsToDelete = categoriesToDelete.map(c => c.id);
Â  Â  Â  Â  Â  Â  Â  Â  await supabase.from('categories').delete().in('id', idsToDelete);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  let createdCategories = [];
Â  Â  Â  Â  Â  Â  if (categoriesToInsert.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  const payload = categoriesToInsert.map(obj => ({ name: obj.name, icon: obj.icon, kind: obj.kind, created_by: user.id }));
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await supabase.from('categories').insert(payload).select();
Â  Â  Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â  Â  Â  createdCategories = data;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (createdCategories.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  const { data: defaults, error: defaultsError } = await supabase.from('default_subcategories').select(`name, icon, default_categories ( name )`);
Â  Â  Â  Â  Â  Â  Â  Â  if (defaultsError) throw defaultsError;
Â  Â  Â  Â  Â  Â  Â  Â  const subcategoriesPayload = [];
Â  Â  Â  Â  Â  Â  Â  Â  for (const cat of createdCategories) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const matchingDefaults = defaults.filter(def => def.default_categories.name === cat.name);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (const sub of matchingDefaults) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  subcategoriesPayload.push({ name: sub.name, icon: sub.icon, category_id: cat.id });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (subcategoriesPayload.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await supabase.from('subcategories').insert(subcategoriesPayload);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  await supabase.from("profiles").update({ onboarded: true }).eq('id', user.id);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Errore nel salvataggio:", error);
Â  Â  Â  Â  Â  Â  showError("Si Ã¨ verificato un errore critico. Riprova.");
Â  Â  Â  Â  Â  Â  nextBtn.disabled = false;
Â  Â  Â  Â  Â  Â  nextBtn.textContent = 'Fine';
Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  async function initializePage() {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const { data: { user } } = await supabase.auth.getUser();
Â  Â  Â  Â  Â  Â  if (!user) { location.replace(itPrefix() + "login.html"); return; }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const [profileRes, userCatRes, defaultCatRes, goalRes, budgetRes] = await Promise.all([
Â  Â  Â  Â  Â  Â  Â  Â  supabase.from('profiles').select('*').eq('id', user.id).single(),
Â  Â  Â  Â  Â  Â  Â  Â  supabase.from('categories').select('*').eq('created_by', user.id),
Â  Â  Â  Â  Â  Â  Â  Â  supabase.from('default_categories').select('name, icon, kind').order('id'),
Â  Â  Â  Â  Â  Â  Â  Â  supabase.from('goals').select('*').eq('user_id', user.id).maybeSingle(),
Â  Â  Â  Â  Â  Â  Â  Â  supabase.from('budgets').select('*').eq('user_id', user.id).eq('macro_category', 'Risparmi')
Â  Â  Â  Â  Â  Â  ]);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const results = [profileRes, userCatRes, defaultCatRes, goalRes, budgetRes];
Â  Â  Â  Â  Â  Â  for (const res of results) {
Â  Â  Â  Â  Â  Â  Â  Â  if (res.error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Errore durante il caricamento dati:", res.error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showError("Impossibile caricare i dati. Ricarica la pagina.");Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const profile = profileRes.data;
Â  Â  Â  Â  Â  Â  const userCategories = userCatRes.data || [];
Â  Â  Â  Â  Â  Â  const defaultCategories = defaultCatRes.data || [];
Â  Â  Â  Â  Â  Â  const goal = goalRes.data;
Â  Â  Â  Â  Â  Â  const budget = budgetRes.data && budgetRes.data.length > 0 ? budgetRes.data[0] : null;

Â  Â  Â  Â  Â  Â  const isEditing = new URLSearchParams(location.search).get('edit') === '1';
Â  Â  Â  Â  Â  Â  if (profile && profile.onboarded && !isEditing) {
Â  Â  Â  Â  Â  Â  Â  Â  location.replace(itPrefix() + "dashboard.html");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  populateCategoriesFromDB(defaultCategories);
Â  Â  Â  Â  Â  Â  preselectFormData(goal, budget, userCategories);
Â  Â  Â  Â  Â  Â  renderStep(1);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  nextBtn.addEventListener('click', async () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!validateAndUpdateState(currentStep)) return;
Â  Â  Â  Â  Â  Â  Â  Â  if (currentStep === TOTAL_STEPS) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const success = await saveOnboardingToSupabase(user, userCategories);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (success) location.replace(itPrefix() + 'dashboard.html');
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentStep++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderStep(currentStep);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  backBtn.addEventListener('click', () => { if (currentStep > 1) { currentStep--; renderStep(currentStep); } });
Â  Â  Â  Â  Â  Â  logoutBtn.addEventListener('click', async (e) => { e.preventDefault(); await supabase.auth.signOut(); location.replace(itPrefix()); });
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error("Errore critico di inizializzazione:", e);
Â  Â  Â  Â  Â  Â  showError("Si Ã¨ verificato un errore imprevisto. Ricarica la pagina.");
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  document.addEventListener('DOMContentLoaded', initializePage);
Â  </script>
</body>
</html>

