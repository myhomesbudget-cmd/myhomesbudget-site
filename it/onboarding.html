<!doctype html>
<html lang="it" data-app="myhomesbudget">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Configurazione Iniziale ‚Äî MyHomesBudget</title>
  <meta name="description" content="Configura il tuo profilo in pochi passi per iniziare a gestire il tuo bilancio familiare.">
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" href="/favicon.ico">
  <style>
    :root{--fg:#111;--glass:rgba(255,255,255,.58);--card-border:rgba(0,0,0,.08);--shadow:0 10px 30px rgba(0,0,0,.10);--radius-lg:16px;--primary-color:#6c5ce7;}
    *{box-sizing:border-box}
    html,body{font-family:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif}
    a:focus-visible,button:focus-visible,input:focus-visible{outline:2px solid #00cec9; outline-offset:2px; border-radius:8px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    body{margin:0;color:#fff;background:url("/bg.webp") no-repeat center/cover fixed;min-height:100vh;display:flex;flex-direction:column;align-items:center;}
    body::before{content:"";position:fixed;inset:0;background:rgba(0,0,0,.08);z-index:-1}
    .topbar{position:fixed;top:16px;left:50%;transform:translateX(-50%);width:min(920px,calc(100% - 40px));z-index:20;pointer-events:none;display:flex;align-items:center;justify-content:space-between;}
    .logo-link,.top-actions{pointer-events:auto}
    .logo-link{display:flex;align-items:center;gap:8px;text-decoration:none}
    .logo-image{height:32px;border-radius:6px}
    .logo-text{font-weight:600;color:#fff;font-size:1.05rem;text-shadow:0 1px 2px rgba(0,0,0,.35)}
    .top-actions{display:flex;gap:8px;align-items:center}
    .logout-link{color:#fff;text-decoration:none;padding:6px 10px;border-radius:10px;background:rgba(0,0,0,.28); border:1px solid rgba(255,255,255,.25);}
    .logout-link:hover{background:rgba(0,0,0,.38)}
    main.panel{margin-top:84px;width:min(920px,calc(100% - 40px));background:var(--glass); color:var(--fg); border-radius:var(--radius-lg);padding:clamp(18px,4vw,22px); box-shadow:var(--shadow);display:flex;flex-direction:column;gap:16px;}
    .panel-header{background:rgba(255,255,255,.55);border-radius:12px;padding:14px;border:1px solid var(--card-border)}
    .progress-bar{width:100%;height:8px;background:rgba(0,0,0,.1);border-radius:4px;overflow:hidden}
    .progress-bar-inner{width:0%;height:100%;background:#6c5ce7;transition:width .4s ease}
    .step-indicator{font-size:.9rem;font-weight:600;color:#555;margin-top:8px;text-align:right}
    .step{display:none}
    .step.is-active{display:block;animation:fadeIn .45s ease}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .step-title{text-align:center;margin:6px 0 8px;font-size:clamp(1.5rem,4vw,1.8rem);color:#111}
    .step-description{text-align:center;color:#333;margin:0 auto 16px;max-width:520px}
    .form-group{margin-bottom:16px}
    .options-grid{display:grid;gap:12px}
    @media(min-width:700px){ .options-grid.cols-2{grid-template-columns:1fr 1fr} }
    .option-label{display:block;padding:14px;border:2px solid transparent;border-radius:10px;background:rgba(255,255,255,.6);transition:.18s ease;cursor:pointer}
    .option-label:hover{background:#fff}
    input[type="radio"],input[type="checkbox"]{position:absolute;opacity:0;width:1px;height:1px}
    input[type="radio"]:checked + .option-label,
    input[type="checkbox"]:checked + .option-label{border-color:#6c5ce7;background:#fff}
    .option-label strong{display:block;font-size:1.05rem}
    .option-label span{font-size:.92rem;color:#444}
    .error-message{color:#842029;background:#f8d7da;border:1px solid #f5c2c7;border-radius:8px;padding:8px 10px;font-weight:600;text-align:center;display:none}
    .error-message.show{display:block}
    .panel-footer{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;font-weight:800}
    .btn-primary{background:#6c5ce7;color:#fff;box-shadow:0 8px 22px rgba(0,0,0,.14)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
  <nav class="topbar">
    <a href="/it/" class="logo-link" title="MyHomesBudget"><img src="/homes.png" alt="Logo MyHomesBudget" class="logo-image"><span class="logo-text">MyHomesBudget</span></a>
    <div class="top-actions"><a href="#" id="logout-btn" class="logout-link">Esci</a></div>
  </nav>

  <main class="panel">
    <div class="panel-header"><div class="progress-bar" role="progressbar"><div class="progress-bar-inner"></div></div><div id="step-indicator" class="step-indicator"></div></div>
    <section id="step-1" class="step is-active" data-step="1"><h1 class="step-title">Qual √® il tuo obiettivo principale?</h1><p class="step-description">Scegliere un obiettivo ci aiuta a personalizzare la tua esperienza.</p><fieldset class="form-group"><div class="options-grid" id="goal-options"><div><input type="radio" id="goal-saving" name="goal" value="Risparmio fisso mensile"><label for="goal-saving" class="option-label"><strong>üí∞ Risparmio fisso mensile</strong><span>Accantona una somma specifica ogni mese.</span></label></div><div><input type="radio" id="goal-debts" name="goal" value="Riduzione debiti e Finanziamenti"><label for="goal-debts" class="option-label"><strong>üìâ Riduzione debiti e Finanziamenti</strong><span>Monitora e riduci i tuoi debiti in modo efficace.</span></label></div><div><input type="radio" id="goal-objective" name="goal" value="Raggiungi un obiettivo"><label for="goal-objective" class="option-label"><strong>üéØ Raggiungi un obiettivo</strong><span>Viaggi, acquisti importanti, progetti personali.</span></label></div></div></fieldset></section>
    <section id="step-2" class="step" data-step="2"><h1 id="step-2-title" class="step-title">Come vuoi procedere?</h1><p id="s2d" class="step-description">Scegli la modalit√† che preferisci per gestire le tue finanze.</p><fieldset class="form-group"><div class="options-grid" id="method-options"><div><input type="radio" id="method-fixed" name="saving_method" value="Cifra fissa"><label for="method-fixed" class="option-label"><strong>üóìÔ∏è Cifra fissa mensile</strong><span>Destina un importo prestabilito ogni mese.</span></label></div><div><input type="radio" id="method-variable" name="saving_method" value="Importo variabile"><label for="method-variable" class="option-label"><strong>üéõÔ∏è Importo variabile</strong><span>Decidi quanto accantonare in base alle tue spese.</span></label></div><div><input type="radio" id="method-percentage" name="saving_method" value="Percentuale sulle entrate"><label for="method-percentage" class="option-label"><strong>üìä Percentuale sulle entrate</strong><span>Imposta una percentuale fissa da destinare al tuo obiettivo.</span></label></div></div></fieldset></section>
    <section id="step-3" class="step" data-step="3"><h1 class="step-title">Seleziona le tue categorie di spesa</h1><p class="step-description">Scegli quelle che usi pi√π spesso. Potrai aggiungerle o modificarle in qualsiasi momento.</p><fieldset class="form-group"><div class="options-grid cols-2" id="category-options"></div></fieldset></section>
    <div id="error" class="error-message"></div>
    <div class="panel-footer"><button id="back-btn" class="btn btn-secondary">Indietro</button><button id="next-btn" class="btn btn-primary">Avanti</button></div>
  </main>
  
  <script type="module">
    import { supabase } from "/it/supabase-client.js";

    // --- CONFIGURAZIONE ---
    const CATEGORIES = [
        { name: 'Casa', icon: 'üè†' }, { name: 'Casa ‚Äì Straordinarie', icon: 'üõ†Ô∏è' },
        { name: 'Utenze', icon: 'üí°' }, { name: 'Spesa alimentare', icon: 'üõí' },
        { name: 'Auto/Moto', icon: 'üöó' }, { name: 'Trasporti (pubblici/mobilit√†)', icon: 'üöå' },
        { name: 'Salute', icon: '‚ù§Ô∏è' }, { name: 'Istruzione/Formazione', icon: 'üéì' },
        { name: 'Tempo libero & Sport', icon: '‚öΩ' }, { name: 'Ristoranti & Bar', icon: 'üçΩÔ∏è' },
        { name: 'Abbigliamento & Cura personale', icon: 'üëï' }, { name: 'Famiglia & Bambini', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶' },
        { name: 'Viaggi & Vacanze', icon: '‚úàÔ∏è' }, { name: 'Regali & Donazioni', icon: 'üéÅ' },
        { name: 'Animali domestici', icon: 'üêæ' }, { name: 'Abbonamenti & Servizi digitali', icon: 'üíª' },
        { name: 'Tasse & Tributi', icon: 'üßæ' }, { name: 'Altro', icon: 'üì¶' }
    ];
    const TOTAL_STEPS = 3;

    // --- SELETTORI DOM & STATO ---
    const backBtn = document.getElementById('back-btn');
    const nextBtn = document.getElementById('next-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const errorBox = document.getElementById('error');
    const steps = document.querySelectorAll('.step');
    let currentStep = 1;
    const state = { goal: null, saving_method: null, categories: [] };

    // --- FUNZIONI HELPER ---
    const itPrefix = () => (location.pathname.match(/^\/(it|ita)(\/|$)/i) ? `/${location.pathname.split('/')[1]}/` : "/it/");
    const showError = (msg) => { errorBox.textContent = msg || ''; errorBox.classList.toggle('show', !!msg); };

    // --- FUNZIONI UI ---
    function populateCategories() {
        const container = document.getElementById('category-options');
        if (!container.childElementCount) {
            CATEGORIES.forEach((cat, i) => {
                const id = 'cat-' + i;
                const w = document.createElement('div');
                // Salva l'intero oggetto come stringa JSON nel valore
                w.innerHTML = `<input type="checkbox" id="${id}" name="category" value='${JSON.stringify(cat)}'><label for="${id}" class="option-label"><strong>${cat.icon} ${cat.name}</strong></label>`;
                container.appendChild(w);
            });
        }
    }

    function renderStep(n) {
        steps.forEach(s => s.classList.toggle('is-active', parseInt(s.dataset.step, 10) === n));
        // ... (resto della logica per la progress bar, etc.)
        backBtn.style.visibility = (n > 1) ? 'visible' : 'hidden';
        nextBtn.textContent = (n === TOTAL_STEPS) ? 'Fine' : 'Avanti';
        showError('');
    }

    function validateAndUpdateState(n) {
        showError('');
        if (n === 1) {
            const sel = document.querySelector('input[name="goal"]:checked');
            if (!sel) { showError('Per favore, scegli un obiettivo.'); return false; }
            state.goal = sel.value;
        } else if (n === 2) {
            const sel = document.querySelector('input[name="saving_method"]:checked');
            if (!sel) { showError('Per favore, scegli una modalit√†.'); return false; }
            state.saving_method = sel.value;
        } else if (n === 3) {
            // Converte le stringhe JSON dei valori in oggetti
            const sel = [...document.querySelectorAll('input[name="category"]:checked')].map(e => JSON.parse(e.value));
            if (!sel.length) { showError('Per favore, seleziona almeno una categoria.'); return false; }
            state.categories = sel;
        }
        return true;
    }

    // --- FUNZIONE DI SALVATAGGIO CON LOGICA DI SYNC ---
    async function saveOnboardingToSupabase(user, existingUserCategories) {
        nextBtn.disabled = true;
        nextBtn.textContent = 'Salvataggio...';

        try {
            const existingNames = existingUserCategories.map(c => c.name);
            const selectedObjects = state.categories;
            const selectedNames = selectedObjects.map(c => c.name);

            // Calcola le differenze
            const categoriesToInsert = selectedObjects.filter(obj => !existingNames.includes(obj.name));
            const categoriesToDelete = existingUserCategories.filter(cat => !selectedNames.includes(cat.name));

            // Cancella
            if (categoriesToDelete.length > 0) {
                const idsToDelete = categoriesToDelete.map(c => c.id);
                const { error } = await supabase.from('categories').delete().in('id', idsToDelete);
                if (error) throw error;
            }

            // Inserisci
            let createdCategories = [];
            if (categoriesToInsert.length > 0) {
                const payload = categoriesToInsert.map(obj => ({ name: obj.name, icon: obj.icon, kind: 'expense', created_by: user.id }));
                const { data, error } = await supabase.from('categories').insert(payload).select();
                if (error) throw error;
                createdCategories = data;
            }

            // Crea sottocategorie di default (solo per le categorie appena create)
            if (createdCategories.length > 0) {
                const { data: defaults, error: defaultsError } = await supabase.from('default_subcategories').select(`name, icon, default_categories ( name )`);
                if (defaultsError) throw defaultsError;

                const subcategoriesPayload = [];
                for (const cat of createdCategories) {
                    const matchingDefaults = defaults.filter(def => def.default_categories.name === cat.name);
                    for (const sub of matchingDefaults) {
                        subcategoriesPayload.push({ name: sub.name, icon: sub.icon, category_id: cat.id });
                    }
                }
                if (subcategoriesPayload.length > 0) {
                    const { error } = await supabase.from('subcategories').insert(subcategoriesPayload);
                    if (error) throw error;
                }
            }
            
            // Aggiorna profilo
            const profilePayload = {
                onboarding_goal: state.goal,
                onboarding_saving_method: state.saving_method,
                onboarding_categories: selectedNames,
                onboarded: true
            };
            const { error: profileError } = await supabase.from("profiles").update(profilePayload).eq('id', user.id);
            if (profileError) throw profileError;
            
            return true;

        } catch (error) {
            console.error("Errore nel salvataggio:", error);
            showError("Si √® verificato un errore critico. Riprova.");
            nextBtn.disabled = false;
            nextBtn.textContent = 'Fine';
            return false;
        }
    }
    
    // --- INIZIALIZZAZIONE ---
    async function initializePage() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) { location.replace(itPrefix() + "login.html"); return; }

        const { data: profile, error: pError } = await supabase.from('profiles').select('*').eq('id', user.id).single();
        const { data: userCategories, error: cError } = await supabase.from('categories').select('*').eq('created_by', user.id);
        if (pError || cError) { showError("Impossibile caricare i dati."); return; }

        const isEditing = new URLSearchParams(location.search).get('edit') === '1';
        if (profile.onboarded && !isEditing) { location.replace(itPrefix() + "dashboard.html"); return; }

        state.goal = profile.onboarding_goal;
        state.saving_method = profile.onboarding_saving_method;
        state.categories = userCategories.map(c => ({ name: c.name, icon: c.icon }));
        
        populateCategories();
        
        // Pre-seleziona i checkbox
        const selectedNames = state.categories.map(c => c.name);
        document.querySelectorAll('input[name="category"]').forEach(checkbox => {
            const catObj = JSON.parse(checkbox.value);
            if (selectedNames.includes(catObj.name)) {
                checkbox.checked = true;
            }
        });
        if (state.goal) { const el = document.querySelector(`input[name="goal"][value="${state.goal}"]`); if (el) el.checked = true; }
        if (state.saving_method) { const el = document.querySelector(`input[name="saving_method"][value="${state.saving_method}"]`); if (el) el.checked = true; }

        renderStep(currentStep);
        
        // Event Listeners
        nextBtn.addEventListener('click', async () => {
            if (!validateAndUpdateState(currentStep)) return;
            if (currentStep === TOTAL_STEPS) {
                const success = await saveOnboardingToSupabase(user, userCategories);
                if (success) location.replace(itPrefix() + 'dashboard.html');
            } else {
                currentStep++;
                renderStep(currentStep);
            }
        });
        backBtn.addEventListener('click', () => { if (currentStep > 1) { currentStep--; renderStep(currentStep); } });
        logoutBtn.addEventListener('click', async (e) => { e.preventDefault(); await supabase.auth.signOut(); location.replace(itPrefix()); });
    }
    
    document.addEventListener('DOMContentLoaded', initializePage);
  </script>
</body>
</html>
