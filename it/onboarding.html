<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DIAGNOSTICA ONBOARDING</title>
  <style>
    body { font-family: sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; background-color: #f0f2f5; }
    .message { font-size: 1.5rem; color: #111; background: #fff; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
    .message code { background: #e0e0e0; padding: 4px 8px; border-radius: 4px; }
  </style>
</head>
<body>
  <div id="message" class="message">
    Diagnostica in corso...<br>Apri la console (tasto F12) e ricarica la pagina.
  </div>

  <script type="module">
    import { supabase } from "/it/supabase-client.js";
    const messageEl = document.getElementById('message');

    async function runDiagnostics() {
      try {
        console.log("--- INIZIO TEST DIAGNOSTICO ---");
        
        // Test 0: Connessione a Supabase
        if (!supabase) {
            console.error("ERRORE CRITICO: Il client Supabase non è stato importato correttamente. Controlla il percorso di /it/supabase-client.js");
            messageEl.innerHTML = "ERRORE: Client Supabase non trovato.";
            return;
        }
        console.log("0. Client Supabase importato correttamente.");

        // Test 1: Ottenere l'utente
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
            console.error("ERRORE nel Test 1 (getUser):", userError);
            messageEl.innerHTML = "ERRORE: Impossibile ottenere l'utente. Sei loggato?";
            return;
        }
        console.log("1. Utente ottenuto con successo:", user.id);

        // Test 2: Lettura tabella 'profiles'
        console.log("Inizio Test 2: Lettura 'profiles'...");
        const profileRes = await supabase.from('profiles').select('*').eq('id', user.id).single();
        console.log("Risultato Test 2:", profileRes);
        if (profileRes.error) {
            console.error("--> ERRORE QUI <--- Il Test 2 (profiles) è fallito.", profileRes.error);
            messageEl.innerHTML = "ERRORE nel Test 2 (profiles). Controlla la console.";
            return;
        }
        console.log("Successo Test 2.");

        // Test 3: Lettura tabella 'categories'
        console.log("Inizio Test 3: Lettura 'categories'...");
        const userCatRes = await supabase.from('categories').select('*').eq('created_by', user.id);
        console.log("Risultato Test 3:", userCatRes);
        if (userCatRes.error) {
            console.error("--> ERRORE QUI <--- Il Test 3 (categories) è fallito.", userCatRes.error);
            messageEl.innerHTML = "ERRORE nel Test 3 (categories). Controlla la console.";
            return;
        }
        console.log("Successo Test 3.");

        // Test 4: Lettura tabella 'default_categories'
        console.log("Inizio Test 4: Lettura 'default_categories'...");
        const defaultCatRes = await supabase.from('default_categories').select('name, icon, kind').order('id');
        console.log("Risultato Test 4:", defaultCatRes);
        if (defaultCatRes.error) {
            console.error("--> ERRORE QUI <--- Il Test 4 (default_categories) è fallito.", defaultCatRes.error);
            messageEl.innerHTML = "ERRORE nel Test 4 (default_categories). Controlla la console.";
            return;
        }
        console.log("Successo Test 4.");

        // Test 5: Lettura tabella 'goals'
        console.log("Inizio Test 5: Lettura 'goals'...");
        const goalRes = await supabase.from('goals').select('*').eq('user_id', user.id).maybeSingle();
        console.log("Risultato Test 5:", goalRes);
        if (goalRes.error) {
            console.error("--> ERRORE QUI <--- Il Test 5 (goals) è fallito.", goalRes.error);
            messageEl.innerHTML = "ERRORE nel Test 5 (goals). Controlla la console.";
            return;
        }
        console.log("Successo Test 5.");

        // Test 6: Lettura tabella 'budgets'
        console.log("Inizio Test 6: Lettura 'budgets'...");
        const budgetRes = await supabase.from('budgets').select('*').eq('user_id', user.id);
        console.log("Risultato Test 6:", budgetRes);
        if (budgetRes.error) {
            console.error("--> ERRORE QUI <--- Il Test 6 (budgets) è fallito.", budgetRes.error);
            messageEl.innerHTML = "ERRORE nel Test 6 (budgets). Controlla la console.";
            return;
        }
        console.log("Successo Test 6.");

        console.log("--- FINE TEST DIAGNOSTICO --- Tutte le letture hanno avuto successo.");
        messageEl.innerHTML = "Diagnostica completata con successo!<br>Per favore, invia lo screenshot della console.";

      } catch (e) {
        console.error("ERRORE JAVASCRIPT CRITICO:", e);
        messageEl.innerHTML = "ERRORE JAVASCRIPT CRITICO. Controlla la console.";
      }
    }
    
    document.addEventListener('DOMContentLoaded', runDiagnostics);
  </script>
</body>
</html>
