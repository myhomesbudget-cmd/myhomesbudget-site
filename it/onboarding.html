<!doctype html>
<html lang="it" data-app="myhomesbudget">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Configurazione Iniziale — MyHomesBudget</title>
  <meta name="description" content="Configura il tuo profilo in pochi passi per iniziare a gestire il tuo bilancio familiare.">
  <meta name="robots" content="noindex, nofollow">

  <!-- GA4 (Measurement ID) -->
  <meta name="ga-measurement-id" content="G-LSD3V9G957">

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' https: data:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com;
                 connect-src 'self' https://www.google-analytics.com https://region1.google-analytics.com;
                 font-src 'self' https: data:;
                 frame-ancestors 'none';
                 base-uri 'self';
                 form-action 'self'">

  <!-- Performance -->
  <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
  <link rel="preconnect" href="https://www.google-analytics.com" crossorigin>
  <link rel="icon" href="/favicon.ico">
  <meta name="theme-color" content="#0f0f10">
  <meta name="color-scheme" content="light dark">

  <style>
    :root{font-family:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif}
    *{box-sizing:border-box}
    a:focus-visible,button:focus-visible,input:focus-visible,[tabindex="0"]:focus-visible{outline:2px solid #00cec9;outline-offset:2px;border-radius:6px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .help{display:block;margin-top:6px;font-size:.9rem;color:#555}

    body{
      margin:0;padding:0;color:#fff;
      background:url("/bg.webp") no-repeat center center fixed;
      background-size:cover;
      display:flex;flex-direction:column;min-height:100vh;
    }
    body::before{content:"";position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:-1}

    .onboarding-wrapper{flex-grow:1;display:flex;align-items:center;justify-content:center;padding:24px}
    .onboarding-panel{
      width:100%;max-width:640px;background:rgba(255,255,255,.8);
      backdrop-filter:saturate(1.2) blur(8px);-webkit-backdrop-filter:saturate(1.2) blur(5px);
      color:#111;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.15);
      display:flex;flex-direction:column;
    }
    .panel-header{padding:20px 24px 16px}
    .progress-bar{width:100%;height:8px;background:rgba(0,0,0,.1);border-radius:4px;overflow:hidden}
    .progress-bar-inner{width:0%;height:100%;background:#6c5ce7;transition:width .4s ease}
    .step-indicator{font-size:.9rem;font-weight:600;color:#555;margin-top:8px;text-align:right}

    .panel-body{padding:0 24px 24px;flex-grow:1}
    .step{display:none}
    .step.is-active{display:block;animation:fadeIn .5s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .step-title{font-size:clamp(1.5rem,4vw,1.8rem);margin:0 0 12px;text-align:center}
    .step-description{text-align:center;color:#333;margin:0 auto 24px;max-width:480px}

    .panel-footer{
      padding:16px 24px;background:rgba(0,0,0,.05);border-top:1px solid rgba(0,0,0,.08);
      display:flex;justify-content:space-between;align-items:center;border-bottom-left-radius:16px;border-bottom-right-radius:16px
    }

    .form-group{margin-bottom:16px}
    .options-grid{display:grid;gap:12px}
    .option-label{display:block;padding:16px;border:2px solid transparent;background:rgba(255,255,255,.5);border-radius:8px;cursor:pointer;transition:border-color .2s ease,background-color .2s ease}
    .option-label:hover{background:rgba(255,255,255,.8)}
    input[type="radio"],input[type="checkbox"]{position:absolute;opacity:0;width:1px;height:1px}
    input[type="radio"]:checked + .option-label,
    input[type="checkbox"]:checked + .option-label{border-color:#6c5ce7;background:#fff}
    .option-label strong{display:block;font-size:1.05rem}
    .option-label span{font-size:.9rem;color:#444}

    .input-wrapper{position:relative}
    .input-field{width:100%;padding:12px 16px;font-size:1.1rem;border-radius:8px;border:1px solid rgba(0,0,0,.15);background:rgba(255,255,255,.6)}
    .input-field::placeholder{color:#777}
    .currency-symbol{position:absolute;left:16px;top:50%;transform:translateY(-50%);color:#555;font-weight:600}
    .input-field.has-symbol{padding-left:36px}

    .error-message{color:#d63031;font-size:.9rem;font-weight:600;margin-top:8px;text-align:center}

    .btn{padding:10px 20px;font-size:1rem;font-weight:700;border-radius:8px;border:none;cursor:pointer;text-decoration:none;transition:background-color .2s ease,opacity .2s ease}
    .btn-primary{background:#6c5ce7;color:#fff}
    .btn-primary:hover{background:#5a4cdb}
    .btn-secondary{background:transparent;color:#333}
    .btn-secondary:hover{background:rgba(0,0,0,.08)}
    .btn[disabled]{opacity:.5;cursor:not-allowed}

    .recap-list{list-style:none;padding:0;text-align:left;margin:20px 0}
    .recap-list li{padding:8px 0;border-bottom:1px solid rgba(0,0,0,.1)}
    .recap-list li:last-child{border-bottom:none}
    .recap-list strong{color:#6c5ce7}
    .recap-categories{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px}
    .recap-categories span{background:rgba(0,0,0,.07);padding:4px 8px;border-radius:6px;font-size:.9rem}

    @media (prefers-reduced-motion: reduce){
      .step.is-active,.progress-bar-inner{animation:none;transition:none}
    }
  </style>
</head>
<body>

  <div class="onboarding-wrapper">
    <main class="onboarding-panel">
      <div class="panel-header">
        <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" aria-labelledby="step-indicator">
          <div class="progress-bar-inner"></div>
        </div>
        <div id="step-indicator" class="step-indicator" aria-live="polite"></div>
      </div>

      <div class="panel-body">
        <!-- Step 1: Obiettivo -->
        <section id="step-1" class="step is-active" data-step="1" aria-describedby="step1-desc">
          <h1 class="step-title">Qual è il tuo obiettivo principale?</h1>
          <p id="step1-desc" class="step-description">Scegliere un obiettivo ci aiuta a personalizzare la tua esperienza.</p>
          <fieldset class="form-group">
            <legend class="sr-only">Scegli un obiettivo</legend>
            <div class="options-grid" id="goal-options">
              <div>
                <input type="radio" id="goal-saving" name="goal" value="Risparmio fisso mensile" aria-describedby="step1-desc error-container">
                <label for="goal-saving" class="option-label">
                  <strong>💰 Risparmio fisso mensile</strong>
                  <span>Accantona una somma specifica ogni mese.</span>
                </label>
              </div>
              <div>
                <input type="radio" id="goal-debts" name="goal" value="Riduzione debiti" aria-describedby="step1-desc error-container">
                <label for="goal-debts" class="option-label">
                  <strong>📉 Riduzione debiti</strong>
                  <span>Monitora e riduci i tuoi debiti in modo efficace.</span>
                </label>
              </div>
              <div>
                <input type="radio" id="goal-control" name="goal" value="Controllo spese" aria-describedby="step1-desc error-container">
                <label for="goal-control" class="option-label">
                  <strong>🧮 Controllo spese</strong>
                  <span>Tieni sotto controllo le uscite mensili.</span>
                </label>
              </div>
            </div>
          </fieldset>
        </section>

        <!-- Step 2: Redditi fissi -->
        <section id="step-2" class="step" data-step="2" aria-describedby="step2-desc">
          <h1 class="step-title" id="step2-title">Qual è il tuo reddito fisso mensile?</h1>
          <p id="step2-desc" class="step-description">Inserisci l’importo netto. Potrai modificarlo in qualsiasi momento.</p>

          <div class="form-group">
            <label for="income-main">Reddito mensile netto</label>
            <div class="input-wrapper">
              <span class="currency-symbol">€</span>
              <input id="income-main" name="income" type="text" inputmode="decimal"
                     class="input-field has-symbol"
                     placeholder="0,00"
                     aria-describedby="income-help error-container"
                     autocomplete="off">
            </div>
            <small id="income-help" class="help">Usa numeri (es. 2.000 oppure 2.000,50).</small>
          </div>
        </section>

        <!-- Step 3: Categorie -->
        <section id="step-3" class="step" data-step="3" aria-describedby="step3-desc">
          <h1 class="step-title">Seleziona le tue categorie di spesa</h1>
          <p id="step3-desc" class="step-description">Scegli quelle che usi più spesso. Potrai aggiungerle o modificarle in seguito.</p>
          <fieldset class="form-group">
            <legend class="sr-only">Scegli le categorie</legend>
            <div class="options-grid" id="category-options" style="grid-template-columns: 1fr 1fr;">
              <!-- Popolate da JS -->
            </div>
          </fieldset>
        </section>

        <!-- Step 4: Riepilogo -->
        <section id="step-4" class="step" data-step="4">
          <h1 class="step-title">Configurazione completata!</h1>
          <p class="step-description">Ecco un riepilogo delle tue scelte. Sei pronto per iniziare.</p>
          <ul class="recap-list">
            <li><strong>Obiettivo:</strong> <span id="recap-goal"></span></li>
            <li><strong>Reddito fisso mensile:</strong> <span id="recap-income"></span></li>
            <li><strong>Categorie iniziali:</strong> <div id="recap-categories" class="recap-categories"></div></li>
          </ul>
        </section>

        <div id="error-container" role="alert" aria-live="polite" class="error-message"></div>
      </div>

      <div class="panel-footer">
        <button id="back-btn" class="btn btn-secondary">Indietro</button>
        <button id="next-btn" class="btn btn-primary">Avanti</button>
      </div>
    </main>
  </div>

<script>
(function bootstrap(){
  // Se onboarding già completato, vai alla dashboard
  try {
    if (localStorage.getItem('onboarding_completed') === '1') {
      location.replace('/dashboard.html');
      return;
    }
  } catch(e){}

  // GA4: carica ID da <meta name="ga-measurement-id">
  const GA_ID = 'G-LSD3V9G957';
  const s = document.createElement('script');
  s.async = true;
  s.src = "https://www.googletagmanager.com/gtag/js?id=" + GA_ID;
  document.head.appendChild(s);
  window.dataLayer = window.dataLayer || [];
  window.gtag = function(){ dataLayer.push(arguments); };
  gtag('js', new Date());
  gtag('config', GA_ID, { anonymize_ip: true });
})();
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const TOTAL_STEPS = 3; // 1: Goal, 2: Income, 3: Categories (4 = Recap)
  const CATEGORIES = [
    '🏠 Casa','💡 Utenze','🛒 Spesa alimentare','🚗 Trasporti',
    '❤️ Salute','🎓 Istruzione','⚽ Tempo libero','📦 Altro'
  ];

  const backBtn = document.getElementById('back-btn');
  const nextBtn = document.getElementById('next-btn');
  const progressBar = document.querySelector('.progress-bar');
  const progressBarInner = document.querySelector('.progress-bar-inner');
  const stepIndicator = document.getElementById('step-indicator');
  const errorContainer = document.getElementById('error-container');
  const steps = document.querySelectorAll('.step');
  const incomeInput = document.getElementById('income-main');

  let currentStep = 1;
  const state = { goal: null, income: null, categories: [] };

  // Utils euro it-IT
  function parseEuro(value) {
    if (typeof value !== 'string') value = String(value ?? '');
    const normalized = value.replace(/\s/g,'').replace(/\./g,'').replace(',', '.');
    const num = Number(normalized);
    return Number.isFinite(num) ? num : NaN;
  }
  function formatEuroPlain(num) {
    try {
      return new Intl.NumberFormat('it-IT',{minimumFractionDigits:2, maximumFractionDigits:2}).format(num);
    } catch { return String(num); }
  }

  // Storage
  function loadState() {
    try {
      const g = localStorage.getItem('onboarding_goal');
      const i = localStorage.getItem('onboarding_income');
      const c = localStorage.getItem('onboarding_categories');
      if (g) state.goal = g;
      if (i && !isNaN(parseFloat(i))) state.income = parseFloat(i);
      if (c) state.categories = JSON.parse(c);
    } catch(e){}
  }
  function saveState() {
    try {
      if (state.goal) localStorage.setItem('onboarding_goal', state.goal);
      if (Number.isFinite(state.income)) localStorage.setItem('onboarding_income', String(state.income));
      if (Array.isArray(state.categories)) localStorage.setItem('onboarding_categories', JSON.stringify(state.categories));
    } catch(e){}
  }

  function populateCategories() {
    const container = document.getElementById('category-options');
    CATEGORIES.forEach(cat => {
      const div = document.createElement('div');
      const id = `cat-${cat.replace(/\W+/g,'')}`;
      div.innerHTML = `
        <input type="checkbox" id="${id}" name="category" value="${cat}">
        <label for="${id}" class="option-label"><strong>${cat}</strong></label>
      `;
      container.appendChild(div);
    });
  }

  function renderStep(stepNumber) {
    gtag('event','onboarding_step_view',{ step: stepNumber });

    steps.forEach(step => {
      step.classList.toggle('is-active', parseInt(step.dataset.step,10) === stepNumber);
    });

    const progress = stepNumber <= TOTAL_STEPS ? ((stepNumber - 1) / TOTAL_STEPS) * 100 : 100;
    progressBarInner.style.width = `${progress}%`;
    progressBar.setAttribute('aria-valuenow', String(progress));

    stepIndicator.textContent = stepNumber <= TOTAL_STEPS ? `Passo ${stepNumber} di ${TOTAL_STEPS}` : 'Completato!';
    backBtn.style.visibility = stepNumber > 1 && stepNumber <= TOTAL_STEPS ? 'visible' : 'hidden';
    nextBtn.textContent = stepNumber === TOTAL_STEPS ? 'Fine' : 'Avanti';
    document.querySelector('.panel-footer').style.display = stepNumber > TOTAL_STEPS ? 'none' : 'flex';

    populateFormWithState();
    errorContainer.textContent = '';
  }

  function populateFormWithState() {
    if (state.goal) {
      const goalInput = document.querySelector(`input[name="goal"][value="${state.goal}"]`);
      if (goalInput) goalInput.checked = true;
    }
    if (Number.isFinite(state.income) && incomeInput) {
      incomeInput.value = formatEuroPlain(state.income);
    }
    if (state.categories?.length) {
      state.categories.forEach(cat => {
        const el = document.querySelector(`input[name="category"][value="${cat}"]`);
        if (el) el.checked = true;
      });
    }
    const t = document.getElementById('step2-title');
    if (t) {
      if (state.goal === 'Risparmio fisso mensile') t.textContent = 'Quanto guadagni al mese (netto)?';
      else if (state.goal === 'Riduzione debiti') t.textContent = 'Qual è il tuo reddito netto mensile?';
      else if (state.goal === 'Controllo spese') t.textContent = 'Indica il tuo reddito netto mensile';
      else t.textContent = 'Qual è il tuo reddito fisso mensile?';
    }
  }

  function renderRecap() {
    document.getElementById('recap-goal').textContent = state.goal || 'Non specificato';
    document.getElementById('recap-income').textContent =
      Number.isFinite(state.income) ? `€ ${formatEuroPlain(state.income)}` : 'Non specificato';

    const categoriesContainer = document.getElementById('recap-categories');
    categoriesContainer.innerHTML = '';
    state.categories.forEach(cat => {
      const span = document.createElement('span');
      span.textContent = cat;
      categoriesContainer.appendChild(span);
    });

    const panelBody = document.querySelector('.panel-body');
    const dashboardLink = document.createElement('a');
    dashboardLink.href = 'dashboard.html';
    dashboardLink.className = 'btn btn-primary';
    dashboardLink.textContent = 'Vai alla dashboard';
    dashboardLink.style.marginTop = '24px';
    panelBody.appendChild(dashboardLink);
  }

  function invalidate(msg, field) {
    errorContainer.textContent = msg || '';
    if (field) field.setAttribute('aria-invalid','true');
    return false;
  }
  function clearInvalid(field) {
    if (field) field.removeAttribute('aria-invalid');
  }

  function validateStep(stepNumber) {
    errorContainer.textContent = '';
    switch (stepNumber) {
      case 1: {
        const selected = document.querySelector('input[name="goal"]:checked');
        if (!selected) return invalidate('Per favore, scegli un obiettivo.');
        state.goal = selected.value;
        saveState();
        return true;
      }
      case 2: {
        clearInvalid(incomeInput);
        const raw = incomeInput?.value ?? '';
        const num = parseEuro(raw);
        if (!Number.isFinite(num) || num <= 0) {
          return invalidate('Inserisci un importo valido maggiore di 0.', incomeInput);
        }
        state.income = Number(num.toFixed(2));
        incomeInput.value = formatEuroPlain(state.income);
        saveState();
        return true;
      }
      case 3: {
        const selected = [...document.querySelectorAll('input[name="category"]:checked')].map(el => el.value);
        if (selected.length === 0) return invalidate('Seleziona almeno una categoria.');
        state.categories = selected;
        saveState();
        return true;
      }
      default: return true;
    }
  }

  incomeInput?.addEventListener('blur', () => {
    const num = parseEuro(incomeInput.value);
    if (Number.isFinite(num)) {
      incomeInput.value = formatEuroPlain(Number(num.toFixed(2)));
      clearInvalid(incomeInput);
    }
  });

  nextBtn.addEventListener('click', () => {
    if (!validateStep(currentStep)) return;

    if (currentStep === TOTAL_STEPS) {
      try { localStorage.setItem('onboarding_completed', '1'); } catch {}
      gtag('event','onboarding_completed');
    }

    currentStep++;
    if (currentStep > TOTAL_STEPS) renderRecap();
    renderStep(currentStep);
  });

  backBtn.addEventListener('click', () => {
    if (currentStep > 1) {
      currentStep--;
      renderStep(currentStep);
    }
  });

  populateCategories();
  loadState();
  renderStep(currentStep);
});
</script>

</body>
</html>
