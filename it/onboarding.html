<!doctype html>
<html lang="it" data-app="myhomesbudget">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Configurazione Iniziale ‚Äî MyHomesBudget</title>
  <meta name="description" content="Configura il tuo profilo in pochi passi per iniziare a gestire il tuo bilancio familiare.">
  <meta name="robots" content="noindex, nofollow">

  <!-- Guard: se onboarding gi√† completato, salta alla dashboard della stessa lingua -->
  <script>
    (function(){
      function langPrefix(){
        var m = location.pathname.match(/^\/(it|ita|en|es)(\/|$)/i);
        return m ? ("/" + m[1].toLowerCase() + "/") : "/";
      }
      var prefix = langPrefix();
      try {
        if (localStorage.getItem('onboarding_completed') === '1') {
          location.replace(prefix + 'dashboard.html');
        }
      } catch(e){}
    })();
  </script>

  <!-- CSP coerente -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' https: data:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com;
                 connect-src 'self' https://www.google-analytics.com https://region1.google-analytics.com;
                 font-src 'self' https: data:;
                 frame-ancestors 'none';
                 base-uri 'self';
                 form-action 'self'">

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-LSD3V9G957"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-LSD3V9G957', { anonymize_ip: true });
  </script>

  <!-- Performance -->
  <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
  <link rel="preconnect" href="https://www.google-analytics.com" crossorigin>
  <link rel="icon" href="/favicon.ico">
  <meta name="theme-color" content="#0f0f10">
  <meta name="color-scheme" content="light dark">

  <style>
    /* === STILI BASE === */
    :root{font-family:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif}
    *{box-sizing:border-box}
    a:focus-visible,button:focus-visible,input:focus-visible,[tabindex="0"]:focus-visible{outline:2px solid #00cec9; outline-offset:2px; border-radius:6px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    body{
      margin:0;padding:0;color:#fff;
      background:url("/bg.webp") no-repeat center center fixed;
      background-size:cover;
      display:flex; flex-direction:column; min-height:100vh;
    }
    body::before{content:"";position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:-1}

    /* === LAYOUT === */
    .onboarding-wrapper{ flex-grow:1; display:flex; align-items:center; justify-content:center; padding:24px; }
    .onboarding-panel{
      width:100%; max-width:640px;
      background:rgba(255,255,255,.8);
      backdrop-filter:saturate(1.2) blur(8px); -webkit-backdrop-filter:saturate(1.2) blur(6px);
      color:#111; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,.15);
      display:flex; flex-direction:column; overflow:hidden;
    }
    .panel-header{ padding:20px 24px 16px; background:rgba(255,255,255,.55); border-bottom:1px solid rgba(0,0,0,.08); }
    .progress-bar{ width:100%; height:8px; background:rgba(0,0,0,.1); border-radius:4px; overflow:hidden; }
    .progress-bar-inner{ width:0%; height:100%; background:#6c5ce7; transition:width .4s ease; }
    .step-indicator{ font-size:.9rem; font-weight:600; color:#555; margin-top:8px; text-align:right; }

    .panel-body{ padding:0 24px 24px; flex-grow:1; }
    .step{ display:none; }
    .step.is-active{ display:block; animation:fadeIn .5s ease; }
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .step-title{ font-size:clamp(1.5rem,4vw,1.8rem); margin:0 0 12px; text-align:center; }
    .step-description{ text-align:center; color:#333; margin:0 auto 24px; max-width:480px; }

    .panel-footer{
      padding:16px 24px; background:rgba(0,0,0,.05); border-top:1px solid rgba(0,0,0,.08);
      display:flex; justify-content:space-between; align-items:center;
      border-bottom-left-radius:16px; border-bottom-right-radius:16px;
    }

    /* === FORM CONTROLLI === */
    .form-group{ margin-bottom:16px; }
    .options-grid{ display:grid; gap:12px; }
    .option-label{
      display:block; padding:16px; border:2px solid transparent;
      background:rgba(255,255,255,.5); border-radius:8px; cursor:pointer;
      transition:border-color .2s ease, background-color .2s ease;
    }
    .option-label:hover{ background:rgba(255,255,255,.8); }
    input[type="radio"],input[type="checkbox"]{ position:absolute; opacity:0; width:1px; height:1px; }
    input[type="radio"]:checked + .option-label,
    input[type="checkbox"]:checked + .option-label{ border-color:#6c5ce7; background:#fff; }
    .option-label strong{ display:block; font-size:1.05rem; }
    .option-label span{ font-size:.9rem; color:#444; }

    .error-message{ color:#d63031; font-size:.9rem; font-weight:600; margin-top:8px; text-align:center; }

    .btn{ padding:10px 20px; font-size:1rem; font-weight:700; border-radius:8px; border:none; cursor:pointer; text-decoration:none; transition:background-color .2s ease, opacity .2s ease; }
    .btn-primary{ background:#6c5ce7; color:#fff; }
    .btn-primary:hover{ background:#5a4cdb; }
    .btn-secondary{ background:transparent; color:#333; }
    .btn-secondary:hover{ background:rgba(0,0,0,.08); }
    .btn[disabled]{ opacity:.5; cursor:not-allowed; }

    /* === RECAP === */
    .recap-list{ list-style:none; padding:0; text-align:left; margin:20px 0; }
    .recap-list li{ padding:8px 0; border-bottom:1px solid rgba(0,0,0,.1); }
    .recap-list li:last-child{ border-bottom:none; }
    .recap-list strong{ color:#6c5ce7; }
    .recap-categories{ display:flex; flex-wrap:wrap; gap:8px; margin-top:4px; }
    .recap-categories span{ background:rgba(0,0,0,.07); padding:4px 8px; border-radius:6px; font-size:.9rem; }

    @media (prefers-reduced-motion: reduce){
      .step.is-active,.progress-bar-inner{ animation:none; transition:none; }
    }
  </style>
</head>
<body>

  <div class="onboarding-wrapper">
    <main class="onboarding-panel">
      <div class="panel-header">
        <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-labelledby="step-indicator">
          <div class="progress-bar-inner"></div>
        </div>
        <div id="step-indicator" class="step-indicator" aria-live="polite"></div>
      </div>

      <div class="panel-body">
        <!-- Step 1: Obiettivo -->
        <section id="step-1" class="step is-active" data-step="1" aria-describedby="step1-desc">
          <h1 class="step-title">Qual √® il tuo obiettivo principale?</h1>
          <p id="step1-desc" class="step-description">Scegliere un obiettivo ci aiuta a personalizzare la tua esperienza.</p>
          <fieldset class="form-group">
            <legend class="sr-only">Scegli un obiettivo</legend>
            <div class="options-grid" id="goal-options">
              <div>
                <input type="radio" id="goal-saving" name="goal" value="Risparmio fisso mensile" aria-describedby="step1-desc error-container">
                <label for="goal-saving" class="option-label">
                  <strong>üí∞ Risparmio fisso mensile</strong>
                  <span>Accantona una somma specifica ogni mese.</span>
                </label>
              </div>
              <div>
                <input type="radio" id="goal-debts" name="goal" value="Riduzione debiti e Finanziamenti" aria-describedby="step1-desc error-container">
                <label for="goal-debts" class="option-label">
                  <strong>üìâ Riduzione debiti e Finanziamenti</strong>
                  <span>Monitora e riduci i tuoi debiti in modo efficace.</span>
                </label>
              </div>
              <div>
                <input type="radio" id="goal-objective" name="goal" value="Raggiungi un obiettivo" aria-describedby="step1-desc error-container">
                <label for="goal-objective" class="option-label">
                  <strong>üéØ Raggiungi un obiettivo</strong>
                  <span>Viaggi, acquisti importanti, progetti personali.</span>
                </label>
              </div>
            </div>
          </fieldset>
        </section>

        <!-- Step 2: Modalit√† -->
        <section id="step-2" class="step" data-step="2" aria-describedby="step2-desc">
          <h1 id="step-2-title" class="step-title">Come vuoi procedere?</h1>
          <p id="step2-desc" class="step-description">Scegli la modalit√† che preferisci per gestire le tue finanze.</p>
          <fieldset class="form-group">
            <legend class="sr-only">Scegli una modalit√†</legend>
            <div class="options-grid" id="method-options">
              <div>
                <input type="radio" id="method-fixed" name="saving_method" value="Cifra fissa" aria-describedby="step2-desc error-container">
                <label for="method-fixed" class="option-label">
                  <strong>üóìÔ∏è Cifra fissa mensile</strong>
                  <span>Destina un importo prestabilito ogni mese.</span>
                </label>
              </div>
              <div>
                <input type="radio" id="method-variable" name="saving_method" value="Importo variabile" aria-describedby="step2-desc error-container">
                <label for="method-variable" class="option-label">
                  <strong>üéõÔ∏è Importo variabile</strong>
                  <span>Decidi quanto accantonare in base alle tue spese.</span>
                </label>
              </div>
              <div>
                <input type="radio" id="method-percentage" name="saving_method" value="Percentuale sulle entrate" aria-describedby="step2-desc error-container">
                <label for="method-percentage" class="option-label">
                  <strong>üìä Percentuale sulle entrate</strong>
                  <span>Imposta una percentuale fissa da destinare al tuo obiettivo.</span>
                </label>
              </div>
            </div>
          </fieldset>
        </section>

        <!-- Step 3: Categorie -->
        <section id="step-3" class="step" data-step="3" aria-describedby="step3-desc">
          <h1 class="step-title">Seleziona le tue categorie di spesa</h1>
          <p id="step3-desc" class="step-description">Scegli quelle che usi pi√π spesso. Potrai aggiungerle o modificarle in qualsiasi momento.</p>
          <fieldset class="form-group">
            <legend class="sr-only">Scegli le categorie</legend>
            <div class="options-grid" id="category-options" style="grid-template-columns: 1fr 1fr;">
              <!-- Popolate da JS -->
            </div>
          </fieldset>
        </section>

        <!-- Step 4: Riepilogo -->
        <section id="step-4" class="step" data-step="4">
          <h1 class="step-title">Configurazione completata!</h1>
          <p class="step-description">Ecco un riepilogo delle tue scelte. Sei pronto per iniziare a prendere il controllo delle tue finanze.</p>
          <ul class="recap-list">
            <li><strong>Obiettivo:</strong> <span id="recap-goal"></span></li>
            <li><strong>Modalit√†:</strong> <span id="recap-method"></span></li>
            <li><strong>Categorie iniziali:</strong> <div id="recap-categories" class="recap-categories"></div></li>
          </ul>
        </section>

        <div id="error-container" role="alert" aria-live="polite" class="error-message"></div>
      </div>

      <div class="panel-footer">
        <button id="back-btn" class="btn btn-secondary">Indietro</button>
        <button id="next-btn" class="btn btn-primary">Avanti</button>
      </div>
    </main>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // === CONFIG ===
  const TOTAL_STEPS = 3; // 1 Obiettivo, 2 Modalit√†, 3 Categorie (4 = Riepilogo)
  const CATEGORIES = [
    'üè† Casa','üõ†Ô∏è Casa Straordinarie','üí° Utenze','üõí Spesa alimentare','üöó Auto/Moto',
    'üöå Trasporti (pubblici/mobilit√†)','‚ù§Ô∏è Salute','üéì Istruzione/Formazione','‚öΩ Tempo libero & Sport',
    'üçΩÔ∏è Ristoranti & Bar','üëï Abbigliamento & Cura personale','üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Famiglia & Bambini',
    '‚úàÔ∏è Viaggi & Vacanze','üéÅ Regali & Donazioni','üêæ Animali domestici','üíª Abbonamenti & Servizi digitali',
    'üßæ Tasse & Tributi','üì¶ Altro'
  ];

  // === DOM refs ===
  const backBtn = document.getElementById('back-btn');
  const nextBtn = document.getElementById('next-btn');
  const progressBar = document.querySelector('.progress-bar');
  const progressBarInner = document.querySelector('.progress-bar-inner');
  const stepIndicator = document.getElementById('step-indicator');
  const errorContainer = document.getElementById('error-container');
  const steps = document.querySelectorAll('.step');

  // === State ===
  let currentStep = 1;
  const state = { goal: null, saving_method: null, categories: [] };

  // Helpers
  function langPrefix(){
    const m = location.pathname.match(/^\/(it|ita|en|es)(\/|$)/i);
    return m ? ("/" + m[1].toLowerCase() + "/") : "/";
  }

  function populateCategories() {
    const container = document.getElementById('category-options');
    CATEGORIES.forEach((cat, i) => {
      const id = `cat-${i}-${cat.replace(/\W+/g,'')}`;
      const div = document.createElement('div');
      div.innerHTML = `
        <input type="checkbox" id="${id}" name="category" value="${cat}" aria-describedby="error-container">
        <label for="${id}" class="option-label"><strong>${cat}</strong></label>
      `;
      container.appendChild(div);
    });
  }

  function loadState() {
    try {
      state.goal = localStorage.getItem('onboarding_goal');
      state.saving_method = localStorage.getItem('onboarding_saving_method');
      const savedCategories = localStorage.getItem('onboarding_categories');
      if (savedCategories) state.categories = JSON.parse(savedCategories);
    } catch(e){}
  }

  function populateFormWithState() {
    if (state.goal) {
      const goalInput = document.querySelector(`input[name="goal"][value="${state.goal}"]`);
      if (goalInput) goalInput.checked = true;
    }
    if (state.saving_method) {
      const methodInput = document.querySelector(`input[name="saving_method"][value="${state.saving_method}"]`);
      if (methodInput) methodInput.checked = true;
    }
    if (state.categories?.length) {
      state.categories.forEach(cat => {
        const el = document.querySelector(`input[name="category"][value="${cat}"]`);
        if (el) el.checked = true;
      });
    }
  }

  function customizeStep2() {
    const title = document.getElementById('step-2-title');
    const description = document.getElementById('step-2-description');
    switch (state.goal) {
      case 'Risparmio fisso mensile':
        title.textContent = 'Come vuoi risparmiare?';
        description.textContent = 'Scegli la strategia di risparmio pi√π adatta a te.';
        break;
      case 'Riduzione debiti e Finanziamenti':
        title.textContent = 'Come vuoi affrontare debiti e finanziamenti?';
        description.textContent = 'Scegli un metodo per ridurre le tue uscite mese dopo mese.';
        break;
      case 'Raggiungi un obiettivo':
        title.textContent = 'Come vuoi raggiungere il tuo obiettivo?';
        description.textContent = 'Qualsiasi sia il tuo traguardo, scegli come arrivarci.';
        break;
      default:
        title.textContent = 'Come vuoi procedere?';
        description.textContent = 'Scegli la modalit√† che preferisci per gestire le tue finanze.';
    }
  }

  function renderStep(stepNumber) {
    // GA4: evento vista step
    gtag('event','onboarding_step_view',{ step: stepNumber });

    steps.forEach(step => {
      step.classList.toggle('is-active', parseInt(step.dataset.step,10) === stepNumber);
    });

    if (stepNumber === 2) customizeStep2();

    const progress = stepNumber <= TOTAL_STEPS ? ((stepNumber - 1) / TOTAL_STEPS) * 100 : 100;
    progressBarInner.style.width = progress + '%';
    progressBar.setAttribute('aria-valuenow', String(progress));

    stepIndicator.textContent = stepNumber <= TOTAL_STEPS ? `Passo ${stepNumber} di ${TOTAL_STEPS}` : 'Completato!';

    backBtn.style.visibility = (stepNumber > 1 && stepNumber <= TOTAL_STEPS) ? 'visible' : 'hidden';
    nextBtn.textContent = (stepNumber === TOTAL_STEPS) ? 'Fine' : 'Avanti';

    if (stepNumber > TOTAL_STEPS) {
      document.querySelector('.panel-footer').style.display = 'none';
      renderRecap();
    } else {
      document.querySelector('.panel-footer').style.display = 'flex';
    }

    populateFormWithState();
    errorContainer.textContent = '';
  }

  function renderRecap() {
    document.getElementById('recap-goal').textContent = state.goal || 'Non specificato';
    document.getElementById('recap-method').textContent = state.saving_method || 'Non specificata';
    const categoriesContainer = document.getElementById('recap-categories');
    categoriesContainer.innerHTML = '';
    state.categories.forEach(cat => {
      const span = document.createElement('span');
      span.textContent = cat;
      categoriesContainer.appendChild(span);
    });

    // CTA -> dashboard della stessa lingua
    const panelBody = document.querySelector('.panel-body');
    const dashboardLink = document.createElement('a');
    dashboardLink.href = langPrefix() + 'dashboard.html';
    dashboardLink.className = 'btn btn-primary';
    dashboardLink.textContent = 'Vai alla dashboard';
    dashboardLink.style.marginTop = '24px';
    dashboardLink.addEventListener('click', () => {
      gtag('event','onboarding_completed'); // extra tracking (gi√† inviato alla fine dello step 3)
    });
    panelBody.appendChild(dashboardLink);
  }

  // Validazione
  function validateStep(stepNumber) {
    errorContainer.textContent = '';
    switch (stepNumber) {
      case 1: {
        const selected = document.querySelector('input[name="goal"]:checked');
        if (!selected) {
          errorContainer.textContent = 'Per favore, scegli un obiettivo.';
          return false;
        }
        state.goal = selected.value;
        localStorage.setItem('onboarding_goal', state.goal);
        return true;
      }
      case 2: {
        const selected = document.querySelector('input[name="saving_method"]:checked');
        if (!selected) {
          errorContainer.textContent = 'Per favore, scegli una modalit√†.';
          return false;
        }
        state.saving_method = selected.value;
        localStorage.setItem('onboarding_saving_method', state.saving_method);
        return true;
      }
      case 3: {
        const selected = [...document.querySelectorAll('input[name="category"]:checked')].map(el => el.value);
        if (!selected.length) {
          errorContainer.textContent = 'Per favore, seleziona almeno una categoria.';
          return false;
        }
        state.categories = selected;
        localStorage.setItem('onboarding_categories', JSON.stringify(state.categories));
        return true;
      }
      default: return true;
    }
  }

  // Event handlers
  nextBtn.addEventListener('click', () => {
    if (!validateStep(currentStep)) return;

    // Se stiamo chiudendo lo step 3, marca completato e invia evento GA4
    if (currentStep === TOTAL_STEPS) {
      try { localStorage.setItem('onboarding_completed','1'); } catch(e){}
      gtag('event','onboarding_completed');
    }

    currentStep++;
    renderStep(currentStep);
  });

  backBtn.addEventListener('click', () => {
    if (currentStep > 1) {
      currentStep--;
      renderStep(currentStep);
    }
  });

  // Init
  populateCategories();
  loadState();
  renderStep(currentStep);
});
</script>

</body>
</html>
