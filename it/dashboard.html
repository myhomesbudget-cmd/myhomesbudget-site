<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard — MyHomesBudget</title>
  <meta name="robots" content="noindex, nofollow">
  <meta name="color-scheme" content="light dark">
  <meta name="description" content="Riepilogo mensile di entrate, uscite, risparmio e avanzamento obiettivi.">

  <!-- CSP: coerente con index + permessi per Chart.js e Supabase -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' https: data:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com https://esm.sh;
                 connect-src 'self' https://*.supabase.co https://www.google-analytics.com https://region1.google-analytics.com;
                 font-src 'self' https: data:;
                 frame-ancestors 'none';
                 base-uri 'self';
                 form-action 'self'">

  <!-- (opzionale) GA4 come nella index -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-LSD3V9G957"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-LSD3V9G957', { anonymize_ip: true });
  </script>

  <!-- Preload background come index -->
  <link rel="preload" href="/bg.webp" as="image" imagesrcset="/bg.webp"/>
  <link rel="icon" href="/favicon.ico">

  <style>
    :root{
      font-family:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif;
      --grad: linear-gradient(135deg,#6c5ce7,#00cec9);
      --card-border: rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    a:focus-visible,button:focus-visible{outline:2px solid #00cec9; outline-offset:2px; border-radius:8px}
    body{
      margin:0;padding:0;color:#111;
      background:url("/bg.webp") no-repeat center/cover fixed;
    }
    body::before{content:"";position:fixed;inset:0;background:rgba(0,0,0,.08);z-index:-1}

    /* TOPBAR (riuso stile index) */
    .topbar{
      position:fixed;top:16px;left:50%;transform:translateX(-50%);
      width:min(1100px,calc(100% - 40px));z-index:50;pointer-events:none;
      display:flex;align-items:center;justify-content:space-between;
    }
    .logo-link,.top-actions{pointer-events:auto}
    .logo-link{display:flex;align-items:center;gap:8px;text-decoration:none}
    .logo-image{height:32px}
    .logo-text{font-weight:600;color:#fff;font-size:1.05rem;text-shadow:0 1px 2px rgba(0,0,0,.35)}
    .top-actions{display:flex;gap:8px;align-items:center}
    .top-chip{
      background:rgba(255,255,255,.65); backdrop-filter:saturate(1.1) blur(6px);
      -webkit-backdrop-filter:saturate(1.1) blur(3px);
      border:1px solid var(--card-border); color:#111; padding:8px 12px; border-radius:12px; font-weight:800;
      box-shadow:0 8px 24px rgba(0,0,0,.08);
    }
    .btn{ cursor:pointer; text-decoration:none }
    .btn:hover{ filter:brightness(1.06) }

    .wrap{width:min(1100px,calc(100% - 40px)); margin:110px auto 22px auto;}
    .grid{display:grid; gap:14px; grid-template-columns: 240px 1fr 320px;}
    @media(max-width:1024px){ .grid{grid-template-columns:1fr} }

    /* Card glass come index */
    .card{
      background:rgba(255,255,255,0.50);
      backdrop-filter:saturate(1.1) blur(5px); -webkit-backdrop-filter:saturate(1.1) blur(2px);
      color:#111; padding:16px; border-radius:16px; border:1px solid var(--card-border);
      box-shadow:0 10px 30px rgba(0,0,0,.08);
    }
    .card h3{margin:0 0 8px}
    .muted{color:#444; opacity:.9; font-size:.95rem}
    .kpi{font-weight:900; font-size:1.6rem}

    /* Sidebar sinistra */
    .menu{display:flex;flex-direction:column;gap:8px}
    .menu a{
      text-decoration:none; padding:10px 12px; border-radius:12px;
      background:rgba(255,255,255,.85); border:1px solid var(--card-border); color:#111; font-weight:800;
    }
    .menu a:hover{background:rgba(255,255,255,.95)}

    /* Colonna centrale */
    .grid-main{display:grid; gap:14px}
    .cards3{display:grid; gap:14px; grid-template-columns: repeat(3, minmax(0,1fr));}
    @media(max-width:1024px){ .cards3{grid-template-columns:1fr} }
    .chart-box{height:280px; display:flex; align-items:center; justify-content:center}
    canvas{max-width:100%; max-height:100%}

    .grid2{display:grid; gap:14px; grid-template-columns:1fr 1fr}
    @media(max-width:1024px){ .grid2{grid-template-columns:1fr} }
    table{width:100%; border-collapse:collapse}
    th,td{padding:10px 12px; border-bottom:1px solid rgba(0,0,0,.06); text-align:left}
    th{font-size:.8rem; text-transform:uppercase; letter-spacing:.4px; color:#333}

    /* Colonna destra obiettivo */
    .battery{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .cell{width:26px;height:16px;border:2px solid #1b1d21;border-radius:3px;position:relative;overflow:hidden}
    .cell::after{content:"";position:absolute;right:-6px;top:4px;width:4px;height:8px;background:#1b1d21;border-radius:1px}
    .fill{height:100%;width:60%;background:linear-gradient(90deg,#9bffb4,#29c281)}
    .fill.mid{width:35%;background:linear-gradient(90deg,#ffd36e,#ff9f43)}
    .fill.low{width:15%;background:linear-gradient(90deg,#ff8a8a,#ff5b5b)}
  </style>
</head>
<body>
  <!-- TOPBAR -->
  <nav class="topbar" aria-label="Barra superiore">
    <a href="/it/" class="logo-link" title="MyHomesBudget">
      <img src="/homes.png" alt="Logo MyHomesBudget" class="logo-image" loading="lazy">
      <span class="logo-text">MyHomesBudget</span>
    </a>
    <div class="top-actions">
      <span class="top-chip" id="trial-banner">FREE · 30 giorni</span>
      <select class="top-chip" id="monthPicker" aria-label="Seleziona mese">
        <option value="2025-09">Set 2025</option><option value="2025-08">Ago 2025</option><option value="2025-07">Lug 2025</option>
      </select>
      <a class="top-chip btn" href="/it/operazioni.html">Operazioni</a>
      <a class="top-chip btn" href="/it/riepilogo.html">Riepilogo</a>
      <a class="top-chip btn" href="/it/impostazioni.html">Impostazioni</a>
      <a class="top-chip btn" href="/it/logout.html" id="logout-btn">Esci</a>
    </div>
  </nav>

  <main class="wrap">
    <div class="grid">
      <!-- SIDEBAR -->
      <aside class="card">
        <h3>Benvenuto</h3>
        <div class="menu" aria-label="Menu">
          <a href="/it/obiettivo.html">Conf. Obiettivo</a>
          <a href="/it/operazioni.html">Operazioni</a>
          <a href="/it/report.html">Report</a>
          <a href="/it/export-csv.html">Export CSV</a>
          <a href="/it/export-pdf.html">Export PDF</a>
        </div>
      </aside>

      <!-- MAIN -->
      <section class="grid-main">
        <!-- 3 grafici principali -->
        <div class="cards3">
          <article class="card">
            <h3>BUDGET — (Σ Entrate) − (Σ Spese + Quota Risparmio)</h3>
            <div class="chart-box"><canvas id="chartResiduo" width="320" height="280"></canvas></div>
            <div class="muted" id="legendResiduo">Entrate: €0 • Spese: €0 • Risparmio: €0</div>
          </article>

          <article class="card">
            <h3>ENTRATE — Σ somma mensile</h3>
            <div class="chart-box"><canvas id="chartEntrate" width="320" height="280"></canvas></div>
            <div class="kpi">Entrate: <span id="entrateTot">€0</span></div>
          </article>

          <article class="card">
            <h3>USCITE — Σ somma mensile</h3>
            <div class="chart-box"><canvas id="chartUscite" width="320" height="280"></canvas></div>
            <div class="kpi">Uscite: <span id="usciteTot">€0</span></div>
          </article>
        </div>

        <!-- Tabelle -->
        <div class="grid2">
          <article class="card">
            <h3>Entrate — per categoria</h3>
            <div style="max-height:260px;overflow:auto">
              <table aria-label="Riepilogo entrate per categoria">
                <thead><tr><th>Categoria</th><th>Importo</th></tr></thead>
                <tbody id="tblEntrate"></tbody>
              </table>
            </div>
          </article>

          <article class="card">
            <h3>Uscite — per categoria</h3>
            <div style="max-height:260px;overflow:auto">
              <table aria-label="Riepilogo uscite per categoria">
                <thead><tr><th>Categoria</th><th>Importo</th></tr></thead>
                <tbody id="tblUscite"></tbody>
              </table>
            </div>
          </article>
        </div>
      </section>

      <!-- OBIETTIVO -->
      <aside class="card">
        <h3>Il tuo obiettivo</h3>
        <div class="battery"><div class="cell"><div class="fill"></div></div><b>Alto</b></div>
        <div class="battery"><div class="cell"><div class="fill mid"></div></div><b>Medio</b></div>
        <div class="battery"><div class="cell"><div class="fill low"></div></div><b>Basso</b></div>

        <div class="card" style="margin-top:12px">
          <h3>Importo raggiunto</h3>
          <div class="kpi" id="obiettivoRaggiunto">€0</div>
          <div class="muted">Restante al raggiungimento</div>
          <div class="muted">Restante (€): <b id="obiettivoMancanteEuro">—</b></div>
          <div class="muted">Restante (%): <b id="obiettivoMancantePerc">—</b></div>
        </div>
      </aside>
    </div>
  </main>

  <!-- Chart.js -->
  <script type="module">
    import { Chart, DoughnutController, LineController, ArcElement, LineElement, PointElement, LinearScale, CategoryScale, Tooltip, Legend } from "https://esm.sh/chart.js@4";
    Chart.register(DoughnutController, LineController, ArcElement, LineElement, PointElement, LinearScale, CategoryScale, Tooltip, Legend);

    const fmt = new Intl.NumberFormat('it-IT', { style:'currency', currency:'EUR', maximumFractionDigits:0 });
    // ===== Dati demo (sostituisci con fetch da Supabase) =====
    const state = {
      mese: "2025-09",
      entrate: [{categoria:"Stipendio",importo:2100},{categoria:"Extra",importo:250},{categoria:"Affitti",importo:450}],
      uscite:  [{categoria:"Casa",importo:820},{categoria:"Alimentari",importo:380},{categoria:"Trasporti",importo:160},{categoria:"Svago",importo:210},{categoria:"Utenze",importo:240}],
      quotaRisparmio: 300,
      obiettivo:{target:5000,raggiunto:2150}
    };
    const sum = a => a.reduce((t,x)=>t+x.importo,0);
    const totEntrate = sum(state.entrate), totUscite = sum(state.uscite);
    const residuo = Math.max(totEntrate - (totUscite + state.quotaRisparmio), 0);
    document.getElementById('entrateTot').textContent = fmt.format(totEntrate);
    document.getElementById('usciteTot').textContent  = fmt.format(totUscite);
    document.getElementById('legendResiduo').textContent =
      `Entrate: ${fmt.format(totEntrate)} • Spese: ${fmt.format(totUscite)} • Risparmio: ${fmt.format(state.quotaRisparmio)}`;

    // Tabelle
    const renderRows = (id, rows)=> {
      document.getElementById(id).innerHTML = rows.map(r=>`<tr><td>${r.categoria}</td><td><b>${fmt.format(r.importo)}</b></td></tr>`).join('');
    };
    renderRows('tblEntrate', state.entrate);
    renderRows('tblUscite', state.uscite);

    // Obiettivo
    const {target,raggiunto} = state.obiettivo;
    const mancante = Math.max(target - raggiunto, 0);
    const manPerc  = Math.round((mancante / Math.max(target,1))*100);
    document.getElementById('obiettivoRaggiunto').textContent = fmt.format(raggiunto);
    document.getElementById('obiettivoMancanteEuro').textContent = fmt.format(mancante);
    document.getElementById('obiettivoMancantePerc').textContent = manPerc + "%";

    // Chart helper
    const donut = (el, labels, data, colors) => new Chart(document.getElementById(el), {
      type:'doughnut',
      data:{ labels, datasets:[{ data, backgroundColor: colors, borderWidth:0 }] },
      options:{ responsive:true, cutout:'65%', plugins:{ legend:{display:false}, tooltip:{callbacks:{label: c=> `${c.label}: ${fmt.format(c.parsed)}`}} } }
    });

    // Residuo (impegnato vs residuo)
    donut('chartResiduo',
      ['Impegnato','Residuo'],
      [ Math.max(totEntrate - residuo,0), residuo ],
      ['#e8eef9','#29c281']
    );

    // Entrate/Uscite per categoria
    donut('chartEntrate', state.entrate.map(x=>x.categoria), state.entrate.map(x=>x.importo),
      ['#6c5ce7','#8a97ff','#a5afff','#c2caff','#dee2ff']);
    donut('chartUscite', state.uscite.map(x=>x.categoria), state.uscite.map(x=>x.importo),
      ['#ff5b5b','#ff7f7f','#ff9a9a','#ffb3b3','#ffd1d1']);
  </script>
</body>
</html>
