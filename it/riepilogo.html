<!doctype html>
<html lang="it" data-app="myhomesbudget">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Riepilogo — MyHomesBudget</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" href="/homes.png" type="image/png" sizes="32x32">

  <style>
    :root{
      --fg:#111;--bg:#f4f7fa;--glass:rgba(255,255,255,0.6);
      --card-border:rgba(0,0,0,0.08);--shadow:0 10px 30px rgba(0,0,0,0.08);
      --radius-lg:16px;--primary-color:#6c5ce7;--danger-color:#d32f2f;--success-color:#2e7d32;
      --warning-color:#f39c12;
      --font-sans:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif;
      --grad:linear-gradient(135deg,#6c5ce7,#00cec9);
      --grad-danger:linear-gradient(135deg,#d32f2f,#ff7675);
      --grad-warning: linear-gradient(135deg,#f39c12,#fdd835);
    }
    *{box-sizing:border-box}
    html{font-family:var(--font-sans);background-color:var(--bg)}
    html, body { position: relative; }
    body{
      margin:0;
      color:var(--fg);
      min-height:100svh;
      -webkit-overflow-scrolling:touch;
    }
    
    /* Background identico */
    #bg{position:fixed;inset:0;z-index:-1;pointer-events:none}
    #bg img{
      width:100%;height:100%;
      object-fit:cover;object-position:center;
      image-rendering:auto;
      transform:translateZ(0);will-change:transform;
      filter:none;
    }
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:linear-gradient(135deg,rgba(108,92,231,0.05),rgba(0,206,201,0.05));
      z-index:0;
      pointer-events:none;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
    
    @media (pointer: coarse) {
      body { background-attachment: scroll !important; }
    }

    /* ====== TOPBAR identica ====== */
    .topbar{position:fixed;top:0;left:0;right:0;height:60px;padding:0 24px;display:flex;align-items:center;justify-content:space-between;background:var(--glass);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-bottom:1px solid var(--card-border); z-index: 1200;}
    .logo-link{display:flex;align-items:center;gap:8px;text-decoration:none}
    .logo-text{font-weight:600;color:#fff;font-size:1.1rem;text-shadow:0 1px 2px rgba(0,0,0,0.35)}
    .top-center{ position: absolute; left: 50%; transform: translateX(-50%); }
    .top-actions{display:flex;gap:12px;align-items:center}
    .top-link, .top-btn{display:flex;align-items:center;justify-content:center;height:34px;color:#fff;text-decoration:none;padding:6px 12px;border-radius:10px;font-size:.9rem;font-weight:600;background:var(--grad);border:none;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:transform .2s ease,filter .2s ease,box-shadow .2s ease;cursor:pointer; white-space: nowrap;}
    .top-link:hover, .top-btn:hover{transform:translateY(-2px);filter:brightness(1.08);box-shadow:0 6px 16px rgba(0,0,0,0.20)}

    .date-selectors{display:flex;gap:8px}
    .select-wrapper{position:relative;display:flex;align-items:center;height:34px;border-radius:10px;background:var(--grad);box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:transform .2s ease,filter .2s ease,box-shadow .2s ease}
    .select-wrapper:hover{transform:translateY(-2px);filter:brightness(1.08);box-shadow:0 6px 16px rgba(0,0,0,0.20)}
    .select-wrapper::after{content:'▼';font-size:10px;color:rgba(255,255,255,0.8);position:absolute;right:10px;top:50%;transform:translateY(-50%);pointer-events:none}
    .topbar-select{appearance:none;background:transparent;color:#fff;border:none;padding:6px 28px 6px 12px;font-size:.9rem;font-weight:600;cursor:pointer}
    .topbar-select option{background:#fff;color:#000}
    .topbar-select:disabled{opacity:0.7}

    .mobile-menu-toggle{display:none;background:var(--grad);border:none;border-radius:10px;width:40px;height:38px;cursor:pointer;padding:0;z-index:1230;box-shadow:0 4px 12px rgba(0,0,0,0.15)}
    .mobile-menu-toggle svg{width:24px;height:24px;stroke:#fff;stroke-width:2.5;stroke-linecap:round}
    .visually-hidden{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}

    @media (max-width: 1200px) { .top-center { display: none; } }
    @media (max-width:960px){
      .mobile-menu-toggle{display:block}
      .top-actions{position:fixed;top:70px;right:16px;background:rgba(255,255,255,0.9);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-radius:var(--radius-lg);box-shadow:var(--shadow);padding:16px;flex-direction:column;gap:16px;align-items:stretch;width:220px;transform:translateY(-20px) scale(.95);opacity:0;pointer-events:none;transition:transform .2s ease-out,opacity .2s ease-out;z-index:1220;border:1px solid var(--card-border)}
      .top-actions.is-open{transform:translateY(0) scale(1);opacity:1;pointer-events:auto}
      .top-actions .top-link,.top-actions .top-btn,.top-actions .select-wrapper,.top-actions .date-selectors{width:100%;text-align:center;flex-direction:column}
    }

    /* ====== Contenuto Principale ====== */
    main.container{padding: 72px 24px 24px;max-width:1280px;margin:0 auto;width:100%; position: relative; z-index: 1;}
    
    .dash-nav{display:flex;align-items:center;gap:8px;border-bottom:1px solid rgba(0,0,0,0.1);padding-bottom:12px;margin-bottom:24px}
    .dash-nav a, .dash-nav button{text-decoration:none;padding:8px 16px;border-radius:10px;font-weight:600;transition:all .2s ease;background:var(--grad);color:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.1);border:none;font-family:var(--font-sans);font-size:1rem;cursor:pointer}
    .dash-nav a:hover, .dash-nav button:hover{transform:translateY(-2px);filter:brightness(1.08);box-shadow:0 6px 16px rgba(0,0,0,0.15)}
    .dash-nav a.is-active, .dash-nav button.is-active{filter:brightness(1.15);box-shadow:0 6px 16px rgba(0,0,0,0.20),inset 0 1px 2px rgba(255,255,255,0.2)}

    /* Mobile accordion cards */
    .dash-card {
      border-radius: 12px;
      padding: 0;
      margin-block: 10px;
      overflow: hidden;
      border: 1px solid var(--card-border);
      background: rgba(255,255,255,0.85);
      box-shadow: var(--shadow);
    }
    
    .dash-card__header {
      min-height: 44px;
      padding: 10px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      font-size: 1.2rem;
      font-weight: 700;
      cursor: pointer;
      background: rgba(255,255,255,0.9);
      border-bottom: 1px solid var(--card-border);
      list-style: none;
    }
    
    .dash-card__header::after {
      content: "";
      width: 10px;
      height: 10px;
      border-right: 2px solid currentColor;
      border-bottom: 2px solid currentColor;
      transform: rotate(-45deg);
      transition: transform 0.2s ease;
      flex-shrink: 0;
    }
    
    .dash-card[open] .dash-card__header::after {
      transform: rotate(45deg);
    }
    
    .dash-card__title {
      flex: 1;
      color: var(--fg);
    }
    
    .dash-card__content {
      padding: 12px 14px;
    }

    @media (max-width: 480px) {
      main.container {
        padding-left: 12px;
        padding-right: 12px;
        padding-top: 72px; 
        padding-bottom: 12px;
      }
    }

    @media (min-width: 1025px) {
      .dash-card { margin-block:24px; }
      .dash-card__header { display:flex; }
      .dash-card__content { padding:24px; }
    }

    /* ====== KPI Cards ====== */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .kpi-card {
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-radius: var(--radius-lg);
      padding: 20px;
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow);
      text-align: center;
      transition: transform .2s ease, box-shadow .2s ease;
    }

    .kpi-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 36px rgba(0,0,0,0.12);
    }

    .kpi-card__icon {
      font-size: 2.5rem;
      margin-bottom: 8px;
      display: block;
    }

    .kpi-card__label {
      font-size: 0.85rem;
      font-weight: 700;
      color: #555;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .kpi-card__value {
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 4px;
    }

    .kpi-card__value.positive {
      color: var(--success-color);
    }

    .kpi-card__value.negative {
      color: var(--danger-color);
    }

    .kpi-card__value.neutral {
      background: var(--grad);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .kpi-card__subtitle {
      font-size: 0.75rem;
      color: #777;
    }

    /* ====== Charts Grid ====== */
    .charts-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      margin-bottom: 24px;
    }

    @media (min-width: 768px) {
      .charts-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      .chart-full-width {
        grid-column: 1 / -1;
      }
    }

    .chart-card {
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-radius: var(--radius-lg);
      padding: 20px;
      border: 1px solid var(--card-border);
      box-shadow: var(--shadow);
    }

    .chart-card__title {
      font-size: 1.2rem;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chart-container {
      position: relative;
      height: 300px;
    }

    .chart-container.tall {
      height: 350px;
    }

    /* ====== Progress Section ====== */
    .progress-item {
      margin-bottom: 20px;
      padding: 16px;
      background: rgba(255,255,255,0.6);
      border-radius: 12px;
      border: 1px solid var(--card-border);
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .progress-name {
      font-weight: 700;
      font-size: 1.05rem;
      color: var(--fg);
    }

    .progress-amount {
      font-size: 0.9rem;
      color: #555;
      font-weight: 600;
    }

    .progress-bar-container {
      height: 12px;
      background: rgba(0,0,0,0.08);
      border-radius: 999px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: var(--grad);
      border-radius: 999px;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ====== Table ====== */
    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      padding: 12px;
      font-size: 0.85rem;
      font-weight: 700;
      color: #555;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid var(--card-border);
      background: rgba(0,0,0,0.02);
    }

    td {
      padding: 12px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    tr:hover {
      background: rgba(108,92,231,0.04);
    }

    .amount-expense {
      color: var(--danger-color);
      font-weight: 700;
    }

    .amount-income {
      color: var(--success-color);
      font-weight: 700;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #777;
    }

    .empty-state__icon {
      font-size: 3rem;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    /* Loading */
    #boot-loader {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(244,247,250,0.95);
      z-index: 3000;
      flex-direction: column;
      gap: 12px;
    }

    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid rgba(0,0,0,0.15);
      border-top-color: #6c5ce7;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body>
  <div id="bg" aria-hidden="true"><img src="/bg.webp" alt=""></div>
  
  <!-- Loading -->
  <div id="boot-loader">
    <div class="spinner"></div>
    <div style="font-weight:700;color:#333;">Caricamento dati...</div>
  </div>

  <!-- Topbar identica -->
  <nav class="topbar">
    <a href="/it/" class="logo-link">
      <img src="/homes.png" alt="Logo" style="height:32px;border-radius:6px">
      <span class="logo-text">MyHomesBudget</span>
    </a>
    <div class="top-nav-right">
      <button id="mobile-menu-btn" class="mobile-menu-toggle" aria-label="Apri menu">
        <svg viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
      </button>
      <div class="top-actions">
        <div class="date-selectors">
          <div class="select-wrapper"><select id="month-selector" class="topbar-select"></select></div>
          <div class="select-wrapper"><select id="year-selector" class="topbar-select"></select></div>
        </div>
        <a href="/it/onboarding.html?from=dashboard&force=1&step=1" class="top-link">🎯 Obiettivo</a>
        <a href="#" id="logout-btn" class="top-link">Esci</a>
      </div>
    </div>
  </nav>

  <main class="container">
    <!-- Nav -->
    <nav class="dash-nav">
      <a href="/it/profile.html">Profilo</a>
      <a href="/it/dashboard.html">Operazioni</a>
      <a href="/it/dashboard-riepilogo.html" class="is-active" aria-current="page">📊 Riepilogo</a>
    </nav>

    <!-- KPI Cards -->
    <div class="kpi-grid">
      <div class="kpi-card">
        <span class="kpi-card__icon">💰</span>
        <div class="kpi-card__label">Entrate Totali</div>
        <div class="kpi-card__value positive" id="kpi-income">€0.00</div>
        <div class="kpi-card__subtitle">mese selezionato</div>
      </div>
      <div class="kpi-card">
        <span class="kpi-card__icon">💸</span>
        <div class="kpi-card__label">Uscite Totali</div>
        <div class="kpi-card__value negative" id="kpi-expenses">€0.00</div>
        <div class="kpi-card__subtitle">mese selezionato</div>
      </div>
      <div class="kpi-card">
        <span class="kpi-card__icon">💵</span>
        <div class="kpi-card__label">Saldo Mese</div>
        <div class="kpi-card__value neutral" id="kpi-balance">€0.00</div>
        <div class="kpi-card__subtitle">entrate - uscite</div>
      </div>
      <div class="kpi-card">
        <span class="kpi-card__icon">📈</span>
        <div class="kpi-card__label">Tasso Risparmio</div>
        <div class="kpi-card__value neutral" id="kpi-savings-rate">0%</div>
        <div class="kpi-card__subtitle">% risparmiata</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts-grid">
      <!-- Income vs Expenses -->
      <div class="chart-card">
        <div class="chart-card__title">
          <span>⚖️ Entrate vs Uscite</span>
        </div>
        <div class="chart-container">
          <canvas id="income-expenses-chart"></canvas>
        </div>
      </div>

      <!-- Category Breakdown -->
      <div class="chart-card">
        <div class="chart-card__title">
          <span>🎯 Distribuzione per Categoria</span>
        </div>
        <div class="chart-container">
          <canvas id="category-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Trend Chart -->
    <div class="charts-grid">
      <div class="chart-card chart-full-width">
        <div class="chart-card__title">
          <span>📊 Trend Ultimi 12 Mesi</span>
        </div>
        <div class="chart-container tall">
          <canvas id="trend-chart"></canvas>
        </div>
      </div>
    </div>

    <!-- Goals Progress -->
    <details class="dash-card" id="goals-section" style="display:none;" open>
      <summary class="dash-card__header">
        <span class="dash-card__title">🎯 Progress Obiettivi</span>
      </summary>
      <div class="dash-card__content" id="goals-container"></div>
    </details>

    <!-- Upcoming Deadlines -->
    <details class="dash-card" open>
      <summary class="dash-card__header">
        <span class="dash-card__title">🔔 Prossime Scadenze</span>
      </summary>
      <div class="dash-card__content">
        <div class="table-container">
          <table id="deadlines-table">
            <thead>
              <tr>
                <th>Data</th>
                <th>Descrizione</th>
                <th>Categoria</th>
                <th style="text-align:right">Importo</th>
              </tr>
            </thead>
            <tbody id="deadlines-tbody">
              <tr>
                <td colspan="4" class="empty-state">
                  <div class="empty-state__icon">📅</div>
                  <p>Nessuna scadenza nel mese selezionato</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </details>
  </main>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  
  <!-- Main App -->
  <script type="module">
    import { supabase } from "/it/supabase-client.js";

    const MESI_ITA = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];

    let user = null;
    let userProfile = null;
    let selectedMonth = new Date().getMonth();
    let selectedYear = new Date().getFullYear();
    let incomeExpensesChart = null;
    let categoryChart = null;
    let trendChart = null;

    async function init() {
      try {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          location.replace("/it/login.html");
          return;
        }
        user = session.user;

        const { data: profile } = await supabase.from('profiles').select('*').eq('id', user.id).single();
        userProfile = profile;

        initSelectors();
        initMobileMenu();
        initLogout();
        await loadAllDataForMonth();
        
        document.getElementById('boot-loader').style.display = 'none';
      } catch (error) {
        console.error('Init error:', error);
        alert('Errore nel caricamento. Riprova.');
      }
    }

    function initSelectors() {
      const monthSelect = document.getElementById('month-selector');
      const yearSelect = document.getElementById('year-selector');

      MESI_ITA.forEach((month, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = month;
        if (index === selectedMonth) option.selected = true;
        monthSelect.appendChild(option);
      });

      const currentYear = new Date().getFullYear();
      for (let year = currentYear - 2; year <= currentYear; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === selectedYear) option.selected = true;
        yearSelect.appendChild(option);
      }

      monthSelect.addEventListener('change', async (e) => {
        selectedMonth = parseInt(e.target.value);
        await loadAllDataForMonth();
      });

      yearSelect.addEventListener('change', async (e) => {
        selectedYear = parseInt(e.target.value);
        await loadAllDataForMonth();
      });
    }

    function initMobileMenu() {
      const menuBtn = document.getElementById('mobile-menu-btn');
      const topActions = document.querySelector('.top-actions');
      menuBtn?.addEventListener('click', () => topActions.classList.toggle('is-open'));
    }

    function initLogout() {
      document.getElementById('logout-btn').addEventListener('click', async (e) => {
        e.preventDefault();
        await supabase.auth.signOut();
        location.replace('/it/login.html');
      });
    }

    function getMonthBoundaries(year, month) {
      const monthStart = new Date(Date.UTC(year, month, 1));
      const nextMonthStart = new Date(Date.UTC(year, month + 1, 1));
      const startStr = monthStart.toISOString().split('T')[0];
      const nextStartStr = nextMonthStart.toISOString().split('T')[0];
      const daysInMonth = new Date(Date.UTC(year, month + 1, 0)).getUTCDate();
      const endStr = new Date(Date.UTC(year, month, daysInMonth)).toISOString().split('T')[0];
      return { startStr, nextStartStr, endStr };
    }

    async function loadAllDataForMonth() {
      try {
        const { startStr, nextStartStr, endStr } = getMonthBoundaries(selectedYear, selectedMonth);

        const [
          { data: transactions },
          { data: categories },
          { data: deadlines },
          { data: goals }
        ] = await Promise.all([
          supabase.from('transactions').select('*').eq('created_by', user.id).gte('occurred_at', startStr).lt('occurred_at', nextStartStr).order('occurred_at', { ascending: false }),
          supabase.from('categories').select('*').or(`created_by.eq.${user.id},created_by.is.null`),
          supabase.from('transactions').select('*, categories(*), subcategories(*)').eq('created_by', user.id).eq('is_paid', false).gte('due_date', startStr).lte('due_date', endStr).order('due_date', { ascending: true }),
          userProfile?.plan_type === 'pro' ? supabase.from('obiettivi').select('*').eq('user_id', user.id) : Promise.resolve({ data: [] })
        ]);

        updateKPIs(transactions || []);
        await updateCharts(transactions || [], categories || []);
        updateDeadlines(deadlines || []);
        await updateGoalsProgress(goals || []);
      } catch (error) {
        console.error('Load data error:', error);
      }
    }

    function updateKPIs(transactions) {
      const income = transactions.filter(t => t.kind === 'income' && t.is_paid !== false).reduce((sum, t) => sum + (t.amount || 0), 0);
      const expenses = transactions.filter(t => t.kind === 'expense' && t.is_paid !== false).reduce((sum, t) => sum + (t.amount || 0), 0);
      const balance = income - expenses;
      const savingsRate = income > 0 ? (Math.max(0, balance) / income * 100) : 0;

      document.getElementById('kpi-income').textContent = `€${income.toFixed(2)}`;
      document.getElementById('kpi-expenses').textContent = `€${expenses.toFixed(2)}`;
      
      const balanceEl = document.getElementById('kpi-balance');
      balanceEl.textContent = `€${balance.toFixed(2)}`;
      balanceEl.className = `kpi-card__value ${balance >= 0 ? 'positive' : 'negative'}`;
      
      document.getElementById('kpi-savings-rate').textContent = `${savingsRate.toFixed(1)}%`;
    }

    async function updateCharts(transactions, categories) {
      updateIncomeExpensesChart(transactions);
      updateCategoryChart(transactions, categories);
      await updateTrendChart();
    }

    function updateIncomeExpensesChart(transactions) {
      const ctx = document.getElementById('income-expenses-chart');
      const weeks = ['Sett. 1', 'Sett. 2', 'Sett. 3', 'Sett. 4', 'Sett. 5'];
      const incomeByWeek = [0, 0, 0, 0, 0];
      const expensesByWeek = [0, 0, 0, 0, 0];

      transactions.forEach(t => {
        if (t.is_paid === false) return;
        const day = new Date(t.occurred_at).getDate();
        const weekIndex = Math.min(Math.floor((day - 1) / 7), 4);
        if (t.kind === 'income') incomeByWeek[weekIndex] += t.amount || 0;
        else if (t.kind === 'expense') expensesByWeek[weekIndex] += t.amount || 0;
      });

      if (incomeExpensesChart) incomeExpensesChart.destroy();

      incomeExpensesChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: weeks,
          datasets: [
            {
              label: 'Entrate',
              data: incomeByWeek,
              backgroundColor: 'rgba(46, 125, 50, 0.8)',
              borderColor: 'rgba(46, 125, 50, 1)',
              borderWidth: 2,
              borderRadius: 8,
            },
            {
              label: 'Uscite',
              data: expensesByWeek,
              backgroundColor: 'rgba(211, 47, 47, 0.8)',
              borderColor: 'rgba(211, 47, 47, 1)',
              borderWidth: 2,
              borderRadius: 8,
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { 
                color: '#333',
                font: { weight: 600, size: 13 }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#555', font: { weight: 600 } },
              grid: { color: 'rgba(0,0,0,0.06)' }
            },
            x: {
              ticks: { color: '#555', font: { weight: 600 } },
              grid: { display: false }
            }
          }
        }
      });
    }

    function updateCategoryChart(transactions, categories) {
      const ctx = document.getElementById('category-chart');
      const categoryMap = {};
      categories.forEach(cat => { categoryMap[cat.id] = cat.name; });

      const expensesByCategory = {};
      transactions.forEach(t => {
        if (t.kind === 'expense' && t.is_paid !== false && t.category_id) {
          const catName = categoryMap[t.category_id] || 'Altro';
          expensesByCategory[catName] = (expensesByCategory[catName] || 0) + (t.amount || 0);
        }
      });

      const sortedCategories = Object.entries(expensesByCategory).sort((a, b) => b[1] - a[1]).slice(0, 6);
      const labels = sortedCategories.map(([name]) => name);
      const data = sortedCategories.map(([, amount]) => amount);
      const colors = ['#6c5ce7', '#00cec9', '#fd79a8', '#f39c12', '#2e7d32', '#d32f2f'];

      if (categoryChart) categoryChart.destroy();

      categoryChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: colors,
            borderColor: '#fff',
            borderWidth: 3,
            hoverOffset: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { 
                color: '#333',
                font: { weight: 600, size: 12 },
                padding: 12
              }
            }
          }
        }
      });
    }

    async function updateTrendChart() {
      const ctx = document.getElementById('trend-chart');
      const months = [];
      const incomeData = [];
      const expensesData = [];

      for (let i = 11; i >= 0; i--) {
        const d = new Date(selectedYear, selectedMonth - i, 1);
        const year = d.getFullYear();
        const month = d.getMonth();
        months.push(MESI_ITA[month]);

        const { startStr, nextStartStr } = getMonthBoundaries(year, month);
        const { data: transactions } = await supabase.from('transactions').select('amount, kind, is_paid').eq('created_by', user.id).gte('occurred_at', startStr).lt('occurred_at', nextStartStr);

        const income = (transactions || []).filter(t => t.kind === 'income' && t.is_paid !== false).reduce((sum, t) => sum + (t.amount || 0), 0);
        const expenses = (transactions || []).filter(t => t.kind === 'expense' && t.is_paid !== false).reduce((sum, t) => sum + (t.amount || 0), 0);

        incomeData.push(income);
        expensesData.push(expenses);
      }

      if (trendChart) trendChart.destroy();

      trendChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: months,
          datasets: [
            {
              label: 'Entrate',
              data: incomeData,
              borderColor: '#2e7d32',
              backgroundColor: 'rgba(46, 125, 50, 0.1)',
              tension: 0.4,
              borderWidth: 3,
              pointRadius: 5,
              pointHoverRadius: 7,
              fill: true
            },
            {
              label: 'Uscite',
              data: expensesData,
              borderColor: '#d32f2f',
              backgroundColor: 'rgba(211, 47, 47, 0.1)',
              tension: 0.4,
              borderWidth: 3,
              pointRadius: 5,
              pointHoverRadius: 7,
              fill: true
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { 
                color: '#333',
                font: { weight: 600, size: 13 }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: '#555', font: { weight: 600 } },
              grid: { color: 'rgba(0,0,0,0.06)' }
            },
            x: {
              ticks: { color: '#555', font: { weight: 600 } },
              grid: { display: false }
            }
          }
        }
      });
    }

    function updateDeadlines(deadlines) {
      const tbody = document.getElementById('deadlines-tbody');
      
      if (!deadlines || deadlines.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="empty-state">
              <div class="empty-state__icon">📅</div>
              <p>Nessuna scadenza nel mese selezionato</p>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = deadlines.map(d => {
        const date = new Date(d.due_date).toLocaleDateString('it-IT', { day: '2-digit', month: 'short' });
        const category = d.categories?.name || 'N/A';
        const note = d.note || 'Scadenza';
        const amount = d.amount || 0;
        const amountClass = d.kind === 'income' ? 'amount-income' : 'amount-expense';
        const sign = d.kind === 'income' ? '+' : '-';
        
        return `
          <tr>
            <td>${date}</td>
            <td>${note}</td>
            <td>${category}</td>
            <td class="${amountClass}" style="text-align:right">${sign}€${amount.toFixed(2)}</td>
          </tr>
        `;
      }).join('');
    }

    async function updateGoalsProgress(goals) {
      const section = document.getElementById('goals-section');
      const container = document.getElementById('goals-container');

      const hasMainGoal = userProfile?.goal_name && userProfile?.goal_target_amount;
      const hasProGoals = userProfile?.plan_type === 'pro' && goals && goals.length > 0;

      if (!hasMainGoal && !hasProGoals) {
        section.style.display = 'none';
        return;
      }

      section.style.display = 'block';
      let html = '';

      if (hasMainGoal) {
        const { startStr } = getMonthBoundaries(selectedYear, 0);
        const { nextStartStr } = getMonthBoundaries(selectedYear, selectedMonth);
        const { data: ytdTransactions } = await supabase.from('transactions').select('amount, kind, is_paid').eq('created_by', user.id).gte('occurred_at', startStr).lt('occurred_at', nextStartStr);

        const ytdIncome = (ytdTransactions || []).filter(t => t.kind === 'income' && t.is_paid !== false).reduce((sum, t) => sum + (t.amount || 0), 0);
        const ytdExpenses = (ytdTransactions || []).filter(t => t.kind === 'expense' && t.is_paid !== false).reduce((sum, t) => sum + (t.amount || 0), 0);
        const ytdSavings = Math.max(0, ytdIncome - ytdExpenses);
        const target = userProfile.goal_target_amount;
        const progress = Math.min(100, (ytdSavings / target) * 100);

        html += `
          <div class="progress-item">
            <div class="progress-header">
              <span class="progress-name">🎯 ${userProfile.goal_name}</span>
              <span class="progress-amount">€${ytdSavings.toFixed(2)} / €${target.toFixed(2)}</span>
            </div>
            <div class="progress-bar-container">
              <div class="progress-bar" style="width: ${progress}%"></div>
            </div>
          </div>
        `;
      }

      if (hasProGoals) {
        goals.forEach(goal => {
          const saved = 0;
          const target = goal.importo_target || 0;
          const progress = target > 0 ? Math.min(100, (saved / target) * 100) : 0;

          html += `
            <div class="progress-item">
              <div class="progress-header">
                <span class="progress-name">🎯 ${goal.nome_obiettivo || 'Obiettivo'}</span>
                <span class="progress-amount">€${saved.toFixed(2)} / €${target.toFixed(2)}</span>
              </div>
              <div class="progress-bar-container">
                <div class="progress-bar" style="width: ${progress}%"></div>
              </div>
            </div>
          `;
        });
      }

      container.innerHTML = html;
    }

    init();
  </script>
</body>
</html>
