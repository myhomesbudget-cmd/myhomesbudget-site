-- Schema applicativo
create schema if not exists app;

-- Utenti â†” Household
create table if not exists app.households (
  id uuid primary key default gen_random_uuid(),
  name text,
  created_at timestamptz default now()
);

create table if not exists app.household_members (
  household_id uuid references app.households(id) on delete cascade,
  user_id uuid not null references auth.users(id) on delete cascade,
  role text default 'owner',
  primary key (household_id, user_id),
  created_at timestamptz default now()
);

-- Conti
create table if not exists app.accounts (
  id uuid primary key default gen_random_uuid(),
  household_id uuid not null references app.households(id) on delete cascade,
  name text not null,
  type text check (type in ('checking','savings','cash')) default 'checking',
  currency text default 'EUR',
  archived boolean default false,
  created_at timestamptz default now()
);

-- Categorie e sottocategorie
create table if not exists app.categories (
  id uuid primary key default gen_random_uuid(),
  household_id uuid not null references app.households(id) on delete cascade,
  kind text not null check (kind in ('income','expense')),
  name text not null,
  is_system boolean default false,
  unique (household_id, kind, name)
);

create table if not exists app.subcategories (
  id uuid primary key default gen_random_uuid(),
  category_id uuid not null references app.categories(id) on delete cascade,
  name text not null,
  unique (category_id, name)
);

-- Transazioni
create table if not exists app.transactions (
  id uuid primary key default gen_random_uuid(),
  household_id uuid not null references app.households(id) on delete cascade,
  account_id uuid not null references app.accounts(id) on delete restrict,
  kind text not null check (kind in ('income','expense')),
  category_id uuid references app.categories(id) on delete set null,
  subcategory_id uuid references app.subcategories(id) on delete set null,
  amount numeric(14,2) not null check (amount >= 0),
  currency text not null default 'EUR',
  occurred_at timestamptz not null,
  note text,
  created_by uuid references auth.users(id) on delete set null,
  created_at timestamptz default now()
);

-- View "enriched" per la dashboard
create or replace view app.v_transactions_enriched as
select
  t.id,
  t.household_id,
  t.account_id,
  t.kind,
  t.amount,
  t.currency,
  t.occurred_at,
  t.note,
  c.name as category_name,
  s.name as subcategory_name
from app.transactions t
left join app.categories c on c.id = t.category_id
left join app.subcategories s on s.id = t.subcategory_id;

-- Indici utili
create index if not exists idx_tx_household_date on app.transactions(household_id, occurred_at);
create index if not exists idx_tx_kind on app.transactions(kind);

-- RLS (abilita e consenti solo al proprio household)
alter table app.household_members enable row level security;
alter table app.accounts enable row level security;
alter table app.categories enable row level security;
alter table app.subcategories enable row level security;
alter table app.transactions enable row level security;

-- Policy helper: household_ids dell'utente
-- Nota: in Supabase puoi usare auth.uid()
create policy "members can read their households"
on app.household_members for select
using ( user_id = auth.uid() );

create policy "members can read accounts"
on app.accounts for select
using ( household_id in (select household_id from app.household_members where user_id = auth.uid()) );

create policy "members can read categories"
on app.categories for select
using ( household_id in (select household_id from app.household_members where user_id = auth.uid()) );

create policy "members can upsert categories"
on app.categories for insert with check (
  household_id in (select household_id from app.household_members where user_id = auth.uid())
);
create policy "members can upsert categories upd"
on app.categories for update using (
  household_id in (select household_id from app.household_members where user_id = auth.uid())
);

create policy "members can read subcategories"
on app.subcategories for select
using (
  category_id in (select id from app.categories where household_id in (select household_id from app.household_members where user_id = auth.uid()))
);
create policy "members can upsert subcategories"
on app.subcategories for insert with check (
  category_id in (select id from app.categories where household_id in (select household_id from app.household_members where user_id = auth.uid()))
);

create policy "members can read transactions"
on app.transactions for select
using ( household_id in (select household_id from app.household_members where user_id = auth.uid()) );

create policy "members can insert transactions"
on app.transactions for insert with check (
  household_id in (select household_id from app.household_members where user_id = auth.uid())
);

create policy "members can delete transactions"
on app.transactions for delete using (
  household_id in (select household_id from app.household_members where user_id = auth.uid())
);
