<!doctype html>
<html lang="it" data-app="myhomesbudget">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Riepilogo â€” MyHomesBudget</title>
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" href="/favicon.ico">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--fg:#111;--glass:rgba(255,255,255,.58);--card-border:rgba(0,0,0,.08);--shadow:0 10px 30px rgba(0,0,0,.10);--radius-lg:16px;--primary-color:#6c5ce7;}
    *{box-sizing:border-box}
    html,body{font-family:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif}
    a:focus-visible,button:focus-visible,input:focus-visible,select:focus-visible{outline:2px solid #00cec9; outline-offset:2px; border-radius:8px}
    body{margin:0;color:#fff;background:url("/bg.webp") no-repeat center/cover fixed;min-height:100vh;display:flex;flex-direction:column;align-items:center;}
    body::before{content:"";position:fixed;inset:0;background:rgba(0,0,0,.08);z-index:-1}
    .topbar{position:fixed;top:16px;left:50%;transform:translateX(-50%);width:min(920px,calc(100% - 40px));z-index:20;pointer-events:none;display:flex;align-items:center;justify-content:space-between;}
    .logo-link,.top-actions{pointer-events:auto}
    .logo-link{display:flex;align-items:center;gap:8px;text-decoration:none}
    .logo-image{height:32px;border-radius:6px}
    .logo-text{font-weight:600;color:#fff;font-size:1.05rem;text-shadow:0 1px 2px rgba(0,0,0,.35)}
    .top-actions{display:flex;gap:8px;align-items:center}
    .top-link{color:#fff;text-decoration:none;padding:6px 10px;border-radius:10px;background:rgba(0,0,0,.28); border:1px solid rgba(255,255,255,.25);font-size: 0.9rem; font-weight: 600;}.top-link:hover{background:rgba(0,0,0,.38)}
    main.panel{margin-top:84px;width:min(920px,calc(100% - 40px));background:var(--glass); color:var(--fg); border-radius:var(--radius-lg);padding:clamp(18px,4vw,22px); box-shadow:var(--shadow);display:flex;flex-direction:column;gap:20px;}
    h1, h2, h3 { color: #111; }
    .dash-nav {display: flex;gap: 8px;border-bottom: 1px solid rgba(0,0,0,0.1);padding-bottom: 12px;}.dash-nav a {text-decoration: none;color: #333;padding: 8px 16px;border-radius: 10px;font-weight: 600;}.dash-nav a.is-active {background-color: #fff;color: var(--primary-color);box-shadow: 0 4px 12px rgba(0,0,0,0.08);}
    .content-section {background: rgba(255,255,255,.55);border-radius:12px;padding:16px;border:1px solid var(--card-border);}
    .summary-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;}
    .summary-card {background: #fff; padding: 16px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);}
    .summary-card .title {font-weight: 600; color: #555; margin: 0 0 8px 0; font-size: 1rem;}
    .summary-card .value {font-size: 2rem; font-weight: 800; color: #111; line-height: 1.1;}
    .value.income {color: #2e7d32;}
    .value.expense {color: #d32f2f;}
    .value.loading {color: #999; font-size: 1.5rem;}
  </style>
</head>
<body>
  <nav class="topbar">
    <a href="/it/" class="logo-link"><img src="/homes.png" alt="Logo" class="logo-image"><span class="logo-text">MyHomesBudget</span></a>
    <div class="top-actions">
      <a href="/it/onboarding.html?edit=1" class="top-link">Impostazioni</a>
      <a href="#" id="logout-btn" class="top-link">Esci</a>
    </div>
  </nav>

  <main class="panel">
    <nav id="dash-nav" class="dash-nav">
      <a href="/it/dashboard.html">Operazioni</a>
      <a href="/it/dashboard-riepilogo.html" class="is-active" aria-current="page">Riepilogo</a>
    </nav>

    <section class="content-section">
      <h2>Riepilogo del Mese Corrente</h2>
      <div class="summary-grid">
        <div class="summary-card"><h3 class="title">Entrate</h3><p id="total-income" class="value income loading">Caricamento...</p></div>
        <div class="summary-card"><h3 class="title">Uscite</h3><p id="total-expenses" class="value expense loading">Caricamento...</p></div>
        <div class="summary-card"><h3 class="title">Saldo Rimanente</h3><p id="remaining-budget" class="value loading">Caricamento...</p></div>
      </div>
    </section>

    <section class="content-section">
        <h2>Spese Mensili (Ultimi 12 mesi)</h2>
        <div style="height: 300px;">
            <canvas id="monthlyExpensesChart"></canvas>
        </div>
    </section>

  </main>
  
  <script type="module">
    import { supabase } from "/it/supabase-client.js";

    const incomeEl = document.getElementById('total-income');
    const expensesEl = document.getElementById('total-expenses');
    const budgetEl = document.getElementById('remaining-budget');
    const logoutBtn = document.getElementById('logout-btn');
    const chartCanvas = document.getElementById('monthlyExpensesChart');

    const formatCurrency = (value) => new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(value);

    function renderMonthlyExpensesChart(data) {
        const labels = data.map(row => new Date(row.month_start).toLocaleDateString('it-IT', { month: 'short', year: '2-digit' }));
        const values = data.map(row => row.total_expenses);

        new Chart(chartCanvas, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Spese Mensili',
                    data: values,
                    backgroundColor: 'rgba(108, 92, 231, 0.8)',
                    borderColor: 'rgba(108, 92, 231, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: { y: { beginAtZero: true } },
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    async function initializePage() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { location.replace("/it/login.html"); return; }

      // --- 1. Carica dati per il riepilogo mensile ---
      // MODIFICA: La funzione ora accetta l'ID utente
      const { data: summaryData, error: summaryError } = await supabase.rpc('get_monthly_summary', { user_id_param: user.id });
      if (summaryError) {
        console.error("Errore riepilogo:", summaryError);
      } else {
        incomeEl.textContent = formatCurrency(summaryData.totalIncome);
        expensesEl.textContent = formatCurrency(summaryData.totalExpenses);
        budgetEl.textContent = formatCurrency(summaryData.remainingBudget);
      }
      incomeEl.classList.remove('loading');
      expensesEl.classList.remove('loading');
      budgetEl.classList.remove('loading');

      // --- 2. Carica dati per il grafico a barre ---
      // MODIFICA: Passiamo l'ID utente alla funzione
      const { data: chartData, error: chartError } = await supabase.rpc('get_monthly_expenses_timeseries', { user_id_param: user.id });
      if (chartError) {
        console.error("Errore dati grafico:", chartError);
      } else if (chartData) {
        renderMonthlyExpensesChart(chartData);
      }

      // --- 3. Logica Logout ---
      logoutBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        await supabase.auth.signOut();
        location.replace("/it/");
      });
    }

    document.addEventListener('DOMContentLoaded', initializePage);
  </script>

</body>
</html>
