<!doctype html>
<html lang="it" data-app="myhomesbudget">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard ‚Äî MyHomesBudget</title>
  <meta name="description" content="La tua situazione a colpo d‚Äôocchio: obiettivo, metodo e categorie iniziali.">
  <meta name="robots" content="noindex, nofollow">

  <!-- Guard: consenti accesso solo dopo onboarding -->
  <script>
    (function(){
      function langPrefix(){
        var m = location.pathname.match(/^\/(it|ita|en|es)(\/|$)/i);
        return m ? ("/" + m[1].toLowerCase() + "/") : "/";
      }
      var prefix = langPrefix();
      try {
        if (localStorage.getItem('onboarding_completed') !== '1') {
          location.replace(prefix + 'onboarding.html');
        }
      } catch(e){
        location.replace(prefix + 'onboarding.html');
      }
    })();
  </script>

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' https: data:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com;
                 connect-src 'self' https://www.google-analytics.com https://region1.google-analytics.com;
                 font-src 'self' https: data:;
                 frame-ancestors 'none';
                 base-uri 'self';
                 form-action 'self'">

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-LSD3V9G957"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-LSD3V9G957', { anonymize_ip: true });
  </script>

  <!-- Perf -->
  <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
  <link rel="preconnect" href="https://www.google-analytics.com" crossorigin>
  <link rel="icon" href="/favicon.ico">
  <meta name="theme-color" content="#0f0f10">
  <meta name="color-scheme" content="light dark">

  <style>
    :root{font-family:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif}
    *{box-sizing:border-box}
    a:focus-visible,button:focus-visible,[role="button"]:focus-visible{outline:2px solid #00cec9; outline-offset:2px; border-radius:6px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    body{
      margin:0;padding:0;color:#fff;
      background:url("/bg.webp") no-repeat center center fixed;
      background-size:cover;min-height:100vh;display:flex;flex-direction:column;
    }
    body::before{content:"";position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:-1}

    header.appbar{
      display:flex;align-items:center;justify-content:space-between;
      padding:14px 20px; backdrop-filter:saturate(1.2) blur(8px);
      -webkit-backdrop-filter:saturate(1.2) blur(8px);
      background:rgba(255,255,255,.08); border-bottom:1px solid rgba(255,255,255,.12);
    }
    header .brand{font-weight:800;letter-spacing:.2px}
    header nav a{color:#fff;text-decoration:none;margin-left:14px;opacity:.9}
    header nav a:hover{opacity:1}

    main.wrapper{flex:1;display:flex;justify-content:center;align-items:flex-start;padding:24px}
    .panel{
      width:100%;max-width:1000px;color:#111;background:rgba(255,255,255,.85);
      border-radius:18px;box-shadow:0 10px 40px rgba(0,0,0,.15);
      backdrop-filter:saturate(1.2) blur(8px); -webkit-backdrop-filter:saturate(1.2) blur(6px);
      overflow:hidden;
    }
    .panel .header{padding:20px 24px;border-bottom:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.55)}
    .panel .header h1{margin:0;font-size:clamp(1.4rem,3vw,1.8rem)}
    .panel .body{padding:20px 24px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{
      background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:14px;box-shadow:0 2px 14px rgba(0,0,0,.05);
      padding:16px;display:flex;flex-direction:column;gap:8px;min-height:120px
    }
    .card h3{margin:0 0 6px;font-size:1.05rem}
    .muted{color:#555;font-size:.95rem}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{background:rgba(0,0,0,.06);border-radius:999px;padding:6px 10px;font-size:.9rem}
    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{border:none;cursor:pointer;font-weight:700;border-radius:10px;padding:10px 14px;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:#6c5ce7;color:#fff}
    .btn-secondary{background:rgba(0,0,0,.06);color:#111}
    .btn:hover{opacity:.95}
    footer.note{padding:12px 24px;color:#ddd;font-size:.9rem;text-align:center}

    @media (max-width:920px){
      .grid{grid-template-columns:repeat(6,1fr)}
    }
    @media (max-width:640px){
      .grid{grid-template-columns:repeat(1,1fr)}
    }
    @media (prefers-reduced-motion: reduce){
      *{animation:none !important; transition:none !important}
    }
  </style>
</head>
<body>

  <!-- App bar -->
  <header class="appbar" role="banner">
    <div class="brand">üè† <strong>MyHomesBudget</strong></div>
    <nav aria-label="Principale">
      <a href="/ita/dashboard.html">Dashboard</a>
      <a href="/ita/paywall.html">Piani</a>
      <a href="/ita/index.html">Home</a>
    </nav>
  </header>

  <!-- Panel -->
  <main class="wrapper">
    <section class="panel" aria-labelledby="dash-title">
      <div class="header">
        <h1 id="dash-title">La tua dashboard</h1>
        <p id="dash-sub" class="muted"></p>
      </div>

      <div class="body">
        <div class="grid" role="region" aria-label="Riepilogo">
          <div class="card" style="grid-column: span 4;">
            <h3>Obiettivo</h3>
            <div id="goal" class="muted">‚Äî</div>
          </div>

          <div class="card" style="grid-column: span 4;">
            <h3>Metodo / Reddito</h3>
            <div id="methodOrIncome" class="muted">‚Äî</div>
          </div>

          <div class="card" style="grid-column: span 4;">
            <h3>Categorie iniziali</h3>
            <div id="cats" class="chips"></div>
          </div>

          <div class="card" style="grid-column: span 8;">
            <h3>Azioni rapide</h3>
            <div class="actions">
              <a class="btn btn-primary" href="/ita/onboarding.html" id="edit-setup" role="button">Rivedi configurazione</a>
              <button class="btn btn-secondary" id="add-income" type="button">+ Entrata</button>
              <button class="btn btn-secondary" id="add-expense" type="button">+ Spesa</button>
            </div>
            <p class="muted" id="ctx-hint"></p>
          </div>

          <div class="card" style="grid-column: span 4;">
            <h3>Stato</h3>
            <div class="muted" id="status" aria-live="polite">‚Äî</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="note">
    <span id="dev-links" class="sr-only" aria-hidden="true"></span>
  </footer>

  <script>
    // Helpers lingua & path
    function langPrefix(){
      var m = location.pathname.match(/^\/(it|ita|en|es)(\/|$)/i);
      return m ? ("/" + m[1].toLowerCase() + "/") : "/";
    }
    const prefix = langPrefix();

    // GA4: evento vista dashboard
    gtag('event','dashboard_view');

    // Leggi stato onboarding
    const state = {
      goal: null,
      saving_method: null,
      income: null,
      categories: []
    };
    try {
      state.goal = localStorage.getItem('onboarding_goal');
      state.saving_method = localStorage.getItem('onboarding_saving_method');
      const inc = localStorage.getItem('onboarding_income');
      if (inc && !isNaN(parseFloat(inc))) state.income = parseFloat(inc);
      const cats = localStorage.getItem('onboarding_categories');
      if (cats) state.categories = JSON.parse(cats);
    } catch(e){}

    // Render UI
    (function render(){
      const goalEl = document.getElementById('goal');
      const methodOrIncomeEl = document.getElementById('methodOrIncome');
      const catsEl = document.getElementById('cats');
      const sub = document.getElementById('dash-sub');
      const status = document.getElementById('status');
      const ctxHint = document.getElementById('ctx-hint');

      sub.textContent = 'Riepilogo della tua configurazione iniziale.';

      goalEl.textContent = state.goal || 'Non impostato';
      if (state.income != null && isFinite(state.income)) {
        try {
          methodOrIncomeEl.textContent = 'Reddito: ‚Ç¨ ' + new Intl.NumberFormat('it-IT',{minimumFractionDigits:2, maximumFractionDigits:2}).format(state.income);
        } catch(_) { methodOrIncomeEl.textContent = 'Reddito: ‚Ç¨ ' + state.income; }
      } else if (state.saving_method) {
        methodOrIncomeEl.textContent = 'Metodo: ' + state.saving_method;
      } else {
        methodOrIncomeEl.textContent = '‚Äî';
      }

      catsEl.innerHTML = '';
      if (Array.isArray(state.categories) && state.categories.length) {
        state.categories.forEach(c => {
          const s = document.createElement('span');
          s.className = 'chip';
          s.textContent = c;
          catsEl.appendChild(s);
        });
        status.textContent = 'Configurazione completata. Puoi iniziare a registrare movimenti.';
        ctxHint.textContent = 'Consiglio: imposta prima le entrate fisse e poi le spese ricorrenti.';
      } else {
        const empty = document.createElement('span');
        empty.className = 'muted';
        empty.textContent = 'Nessuna categoria selezionata.';
        catsEl.appendChild(empty);
        status.textContent = 'Configurazione incompleta: seleziona almeno una categoria.';
        ctxHint.textContent = 'Clicca ‚ÄúRivedi configurazione‚Äù per completare le categorie.';
      }
    })();

    // Azioni rapide (solo eventi + placeholder)
    document.getElementById('add-income').addEventListener('click', function(){
      gtag('event','dashboard_quick_action_click',{action:'add_income'});
      alert('Placeholder: qui aprirai il modale/flow per aggiungere un‚Äôentrata.');
    });
    document.getElementById('add-expense').addEventListener('click', function(){
      gtag('event','dashboard_quick_action_click',{action:'add_expense'});
      alert('Placeholder: qui aprirai il modale/flow per aggiungere una spesa.');
    });
    document.getElementById('edit-setup').addEventListener('click', function(){
      gtag('event','dashboard_quick_action_click',{action:'edit_setup'});
    });
  </script>
</body>
</html>
