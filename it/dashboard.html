<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>MyHomesBudget — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
    header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:16px; }
    .cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:16px; }
    .card { border:1px solid #eee; border-radius:12px; padding:16px; box-shadow: 0 1px 2px rgba(0,0,0,.04); background:#fff; }
    .muted { color:#666; font-size:14px }
    form input, form select, form button { padding:10px 12px; border-radius:8px; border:1px solid #ddd; }
    form { display:grid; grid-template-columns: 1fr 120px 160px 160px auto; gap:8px; align-items:center; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px; border-bottom:1px solid #eee; text-align:left; }
    .right { text-align:right; }
    .total { font-weight:700; }
    .actions { display:flex; gap:8px; align-items:center; }
    .btn { cursor:pointer; border:1px solid #ddd; border-radius:8px; padding:8px 12px; background:#fafafa; }
    .btn:hover { background:#f1f1f1; }

    /* ===== TRIAL BANNER ===== */
    .trial-banner {
      display:none; margin:12px 0 16px; padding:12px 14px; border-radius:12px;
      background:#ffffff; border:1px solid rgba(0,0,0,.10); box-shadow:0 6px 18px rgba(0,0,0,.06); color:#111;
    }
    .trial-banner strong { font-weight:700; }
    .trial-cta {
      text-decoration:none; background:#111; color:#fff; padding:8px 12px; border-radius:10px;
      display:inline-block; margin-left:10px;
    }
    .trial-cta:hover { filter:brightness(1.08); }
  </style>
</head>
<body>
  <header>
    <div>
      <h1 style="margin:0;">Dashboard</h1>
      <div class="muted">Le tue spese personali su Supabase</div>
    </div>
    <div class="actions">
      <span id="user-email" class="muted"></span>
      <button id="logout" class="btn">Esci</button>
    </div>
  </header>

  <!-- ===== TRIAL BANNER (si mostra solo durante i 30 giorni) ===== -->
  <div id="trial-banner" class="trial-banner">
    <span id="trial-text"><!-- filled by JS --></span>
    <a id="trial-cta" class="trial-cta" href="#">Scegli un piano</a>
  </div>

  <div class="cards" style="margin-bottom:16px;">
    <div class="card">
      <h3 style="margin-top:0;">Aggiungi spesa</h3>
      <form id="add-form">
        <input id="desc" type="text" placeholder="Descrizione" required />
        <input id="amount" type="number" step="0.01" min="0" placeholder="Importo €" required />
        <select id="category">
          <option value="">Categoria</option>
          <option>Cibo</option>
          <option>Casa</option>
          <option>Trasporti</option>
          <option>Salute</option>
          <option>Svago</option>
          <option>Altro</option>
        </select>
        <input id="date" type="date" />
        <button type="submit" class="btn">Salva</button>
      </form>
      <div id="form-msg" class="muted" style="margin-top:8px;"></div>
    </div>

    <div class="card">
      <h3 style="margin-top:0;">Spese per categoria</h3>
      <canvas id="pie"></canvas>
    </div>

    <div class="card">
      <h3 style="margin-top:0;">Andamento mensile</h3>
      <canvas id="line"></canvas>
    </div>
  </div>

  <div class="card">
    <h3 style="margin-top:0;">Elenco spese</h3>
    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>Descrizione</th>
          <th>Categoria</th>
          <th class="right">Importo (€)</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
      <tfoot>
        <tr>
          <td colspan="3" class="right total">Totale</td>
          <td class="right total" id="total">0,00</td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Client Supabase -->
  <script type="module" src="/it/supabase-client.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script type="module">
    import { supabase } from "/it/supabase-client.js";

    /* ========= Protezione accesso ========= */
    const lang = location.pathname.split('/')[1] || 'it';
    const goLogin = () => location.replace(`/${lang}/login.html`);

    // 1) Controllo immediato della sessione
    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user) {
      goLogin();
      throw new Error('No session'); // interrompe il resto
    }
    const user = session.user;
    const emailEl = document.getElementById('user-email');
    if (emailEl) emailEl.textContent = user.email;

    // 2) Se lo stato cambia (logout/expire) → torna al login
    supabase.auth.onAuthStateChange((_event, s) => {
      if (!s?.user) goLogin();
    });

    /* ========= TRIAL BANNER ========= */
    (function showTrialBanner() {
      const i18n = {
        it: {
          text: d => `Ti restano <strong>${d}</strong> giorni di prova.`,
          cta : 'Scegli un piano',
          url : '/it/#pricing'
        },
        en: {
          text: d => `You have <strong>${d}</strong> trial days left.`,
          cta : 'Choose a plan',
          url : '/en/#pricing'
        },
        es: {
          text: d => `Te quedan <strong>${d}</strong> días de prueba.`,
          cta : 'Elige un plan',
          url : '/es/#pricing'
        }
      }[lang] || {
        text: d => `Ti restano <strong>${d}</strong> giorni di prova.`,
        cta : 'Scegli un piano',
        url : '/it/#pricing'
      };

      const meta = user.user_metadata || {};
      const plan = meta.plan || 'trial';
      const startedISO = meta.trial_started_at;
      if (plan !== 'trial' || !startedISO) return;

      const start = new Date(startedISO);
      const MS = 24 * 60 * 60 * 1000;
      const passed = Math.floor((Date.now() - start.getTime()) / MS);
      const left = Math.max(0, 30 - passed);

      if (left <= 0) return; // prova scaduta → non mostrare (puoi cambiare logica in futuro)

      const banner = document.getElementById('trial-banner');
      const txt = document.getElementById('trial-text');
      const cta = document.getElementById('trial-cta');

      txt.innerHTML = i18n.text(left);
      cta.textContent = i18n.cta;
      cta.href = i18n.url;
      banner.style.display = 'block';
    })();

    /* ========= Logout ========= */
    document.getElementById('logout').addEventListener('click', async () => {
      await supabase.auth.signOut();
      goLogin();
    });

    /* ========= Utils ========= */
    const fmt = (n) => (n ?? 0).toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const parseDate = (s) => s ? new Date(s) : new Date();

    /* ========= Stato grafici ========= */
    let pieChart, lineChart;

    /* ========= Carica spese ========= */
    async function loadExpenses() {
      const { data, error } = await supabase
        .from('expenses')
        .select('id, description, amount, category, created_at')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false });

      if (error) {
        console.error(error);
        return;
      }

      renderTable(data);
      renderCharts(data);
    }

    function renderTable(items) {
      const tbody = document.getElementById('rows');
      tbody.innerHTML = '';
      let total = 0;

      items.forEach(r => {
        const tr = document.createElement('tr');
        const d = new Date(r.created_at);
        total += Number(r.amount) || 0;

        tr.innerHTML = `
          <td>${d.toLocaleDateString('it-IT')}</td>
          <td>${r.description ?? ''}</td>
          <td>${r.category ?? ''}</td>
          <td class="right">${fmt(Number(r.amount))}</td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('total').textContent = fmt(total);
    }

    function renderCharts(items) {
      // Aggrega per categoria
      const byCat = {};
      items.forEach(r => {
        const c = r.category || 'Altro';
        byCat[c] = (byCat[c] || 0) + Number(r.amount || 0);
      });
      const catLabels = Object.keys(byCat);
      const catData = Object.values(byCat);

      // Aggrega per mese (YYYY-MM)
      const byMonth = {};
      items.forEach(r => {
        const d = new Date(r.created_at);
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        byMonth[key] = (byMonth[key] || 0) + Number(r.amount || 0);
      });
      const monthLabels = Object.keys(byMonth).sort();
      const monthData = monthLabels.map(k => byMonth[k]);

      // Pie
      const pieCtx = document.getElementById('pie');
      if (pieChart) pieChart.destroy();
      pieChart = new Chart(pieCtx, {
        type: 'pie',
        data: { labels: catLabels, datasets: [{ data: catData }] },
        options: { plugins: { legend: { position: 'bottom' } } }
      });

      // Line
      const lineCtx = document.getElementById('line');
      if (lineChart) lineChart.destroy();
      lineChart = new Chart(lineCtx, {
        type: 'line',
        data: { labels: monthLabels, datasets: [{ label: '€ / mese', data: monthData, tension: .3 }] },
        options: { scales: { y: { ticks: { callback: v => fmt(v) }}}}
      });
    }

    /* ========= Inserimento nuova spesa ========= */
    document.getElementById('add-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const desc = document.getElementById('desc').value.trim();
      const amount = Number(document.getElementById('amount').value);
      const category = document.getElementById('category').value || 'Altro';
      const dateVal = document.getElementById('date').value;
      const created_at = parseDate(dateVal).toISOString();

      const msg = document.getElementById('form-msg');
      msg.textContent = 'Salvataggio...';

      const { error } = await supabase.from('expenses').insert({
        description: desc,
        amount,
        category,
        created_at,
        user_id: user.id // RLS: fondamentale
      });

      if (error) {
        msg.textContent = 'Errore: ' + error.message;
      } else {
        e.target.reset();
        msg.textContent = 'Salvata!';
        loadExpenses();
        setTimeout(() => msg.textContent = '', 1500);
      }
    });

    // Caricamento iniziale
    loadExpenses();
  </script>
</body>
</html>
