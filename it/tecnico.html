<!doctype html>
<html lang="it" data-app="myhomesbudget">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Riepilogo — MyHomesBudget</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" href="/favicon.ico" />
  
  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    :root{
      --fg:#111;--bg:#f4f7fa;--glass:rgba(255,255,255,.6);
      --card-border:rgba(0,0,0,.08);--shadow:0 10px 30px rgba(0,0,0,.08);
      --radius-lg:16px;--primary-color:#6c5ce7;--danger-color:#d32f2f;--success-color:#2e7d32;
      --warning-color:#f39c12;
      --font-sans:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif;
      --grad:linear-gradient(135deg,#6c5ce7,#00cec9);
      --grad-danger:linear-gradient(135deg,#d32f2f,#ff7675);
      --grad-success:linear-gradient(135deg,#2e7d32,#4caf50);
      --grad-warning:linear-gradient(135deg,#f39c12,#f1c40f);
    }
    
    *{box-sizing:border-box}
    html{font-family:var(--font-sans);background-color:var(--bg);scroll-behavior:smooth}
    body{
      margin:0;
      color:var(--fg);
      background: url("/bg.webp") no-repeat center/cover;
      background-attachment: scroll;
      min-height:100svh;
      overflow-x:hidden;
      position:relative;
    }
    body::before{content:"";position:absolute;inset:0;background:linear-gradient(135deg,rgba(108,92,231,.05),rgba(0,206,201,.05));z-index:-1}

    /* ===== PARTICLE SYSTEM ===== */
    .particles-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
      overflow: hidden;
    }
    
    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: var(--primary-color);
      border-radius: 50%;
      opacity: 0.6;
      animation: float 6s infinite ease-in-out;
    }
    
    .particle:nth-child(2n) { background: var(--success-color); animation-duration: 8s; }
    .particle:nth-child(3n) { background: var(--warning-color); animation-duration: 10s; }
    .particle:nth-child(4n) { background: var(--danger-color); animation-duration: 7s; }
    
    @keyframes float {
      0%, 100% { transform: translateY(100vh) translateX(0px) rotate(0deg); opacity: 0; }
      10% { opacity: 0.6; }
      90% { opacity: 0.6; }
      50% { transform: translateY(50vh) translateX(100px) rotate(180deg); }
    }

    /* ===== MORPHING SHAPES ===== */
    .morphing-shape {
      position: absolute;
      width: 200px;
      height: 200px;
      background: linear-gradient(45deg, rgba(108,92,231,0.1), rgba(0,206,201,0.1));
      border-radius: 50%;
      animation: morph 8s infinite ease-in-out;
      z-index: 1;
    }
    
    .shape-1 { top: 10%; right: 10%; animation-delay: 0s; }
    .shape-2 { bottom: 20%; left: 5%; animation-delay: 2s; }
    .shape-3 { top: 60%; right: 30%; animation-delay: 4s; }
    
    @keyframes morph {
      0%, 100% { 
        border-radius: 50%; 
        transform: rotate(0deg) scale(1); 
      }
      25% { 
        border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%; 
        transform: rotate(90deg) scale(1.2); 
      }
      50% { 
        border-radius: 70% 30% 30% 70% / 70% 70% 30% 30%; 
        transform: rotate(180deg) scale(0.8); 
      }
      75% { 
        border-radius: 40% 60% 60% 40% / 60% 40% 60% 40%; 
        transform: rotate(270deg) scale(1.1); 
      }
    }

    /* ===== LOADING SYSTEM ===== */
    .boot-loader{
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:var(--bg);display:flex;align-items:center;justify-content:center;
      z-index:10000;transition:opacity .5s ease;
    }
    .boot-loader.is-hidden{opacity:0;pointer-events:none}
    .loader-content{text-align:center}
    .loader-spinner{width:40px;height:40px;border:4px solid rgba(108,92,231,.2);
      border-top:4px solid #6c5ce7;border-radius:50%;
      animation:spin 1s linear infinite;margin:0 auto 20px}
    .loader-text{font-size:1.1rem;font-weight:600;color:var(--fg)}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* ===== TOPBAR ===== */
    .topbar{position:fixed;top:0;left:0;right:0;height:60px;padding:0 24px;display:flex;align-items:center;justify-content:space-between;background:var(--glass);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-bottom:1px solid var(--card-border);z-index:100}
    .logo-link{display:flex;align-items:center;gap:8px;text-decoration:none}
    .logo-text{font-weight:600;color:#fff;font-size:1.1rem;text-shadow:0 1px 2px rgba(0,0,0,.35)}
    .top-center{position:absolute;left:50%;transform:translateX(-50%)}
    .top-actions{display:flex;gap:12px;align-items:center}
    .top-link,.top-btn{display:flex;align-items:center;justify-content:center;height:34px;color:#fff;text-decoration:none;padding:6px 12px;border-radius:10px;font-size:.9rem;font-weight:600;background:var(--grad);border:none;box-shadow:0 4px 12px rgba(0,0,0,.15);transition:transform .2s ease,filter .2s ease,box-shadow .2s ease;cursor:pointer;white-space:nowrap}
    .top-link:hover,.top-btn:hover{transform:translateY(-2px);filter:brightness(1.08);box-shadow:0 6px 16px rgba(0,0,0,.20)}

    .date-selectors{display:flex;gap:8px}
    .select-wrapper{position:relative;display:flex;align-items:center;height:34px;border-radius:10px;background:var(--grad);box-shadow:0 4px 12px rgba(0,0,0,.15);transition:transform .2s ease,filter .2s ease,box-shadow .2s ease}
    .select-wrapper:hover{transform:translateY(-2px);filter:brightness(1.08);box-shadow:0 6px 16px rgba(0,0,0,.20)}
    .select-wrapper::after{content:'▼';font-size:10px;color:rgba(255,255,255,0.8);position:absolute;right:10px;top:50%;transform:translateY(-50%);pointer-events:none}
    .topbar-select{appearance:none;background:transparent;color:#fff;border:none;padding:6px 28px 6px 12px;font-size:.9rem;font-weight:600;cursor:pointer}
    .topbar-select option{background:#fff;color:#000}

    /* ===== MAIN CONTENT ===== */
    main.container{padding:84px 24px 24px;max-width:1400px;margin:0 auto;width:100%;position:relative;z-index:2}
    .page-header{text-align:center;margin-bottom:40px;opacity:0;transform:translateY(30px);animation:slideInDown 1s ease-out 0.2s forwards}
    .page-title{font-size:2.5rem;font-weight:800;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin:0 0 10px}
    .page-subtitle{font-size:1.1rem;color:#666;margin:0}

    /* ===== 3D FLIPPABLE CARDS ===== */
    .dashboard-grid{display:grid;grid-template-columns:1fr;gap:24px;margin-bottom:40px}
    @media(min-width:768px){.dashboard-grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:1200px){.dashboard-grid{grid-template-columns:repeat(4,1fr)}}

    .summary-card{
      background:rgba(255,255,255,0.9);
      border-radius:var(--radius-lg);
      border:1px solid var(--card-border);
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
      cursor:pointer;
      perspective:1000px;
      height:200px;
      opacity:0;
      transform:translateY(50px);
      transition:all 0.3s ease;
    }

    .summary-card.scroll-visible{
      opacity:1;
      transform:translateY(0);
    }

    .card-inner{
      position:relative;
      width:100%;
      height:100%;
      text-align:center;
      transition:transform 0.8s;
      transform-style:preserve-3d;
    }

    .summary-card:hover .card-inner{
      transform:rotateY(180deg);
    }

    .card-front, .card-back{
      position:absolute;
      width:100%;
      height:100%;
      backface-visibility:hidden;
      padding:24px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
    }

    .card-back{
      transform:rotateY(180deg);
      background:linear-gradient(135deg, rgba(108,92,231,0.1), rgba(0,206,201,0.1));
    }

    /* ===== HOVER EFFECTS & GLOW ===== */
    .summary-card::before{
      content:'';position:absolute;top:0;left:0;right:0;height:4px;
      background:var(--grad);
      transition:height 0.3s ease;
    }

    .summary-card:hover{
      transform:translateY(-10px) scale(1.02);
      box-shadow:0 25px 50px rgba(0,0,0,.15);
    }

    .summary-card:hover::before{
      height:100%;
      opacity:0.1;
    }

    .summary-card.income::before{background:var(--grad-success)}
    .summary-card.expense::before{background:var(--grad-danger)}
    .summary-card.balance::before{background:var(--grad)}
    .summary-card.goal::before{background:var(--grad-warning)}

    /* ===== RIPPLE EFFECT ===== */
    .ripple{
      position:absolute;
      border-radius:50%;
      background:rgba(255,255,255,0.6);
      transform:scale(0);
      animation:ripple-animation 0.6s linear;
      pointer-events:none;
    }

    @keyframes ripple-animation{
      to{
        transform:scale(4);
        opacity:0;
      }
    }

    /* ===== DONUT CHARTS ===== */
    .card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .card-title{font-size:1rem;font-weight:600;color:#666;display:flex;align-items:center;gap:8px}
    .card-icon{font-size:1.5rem}

    .donut-container{
      position:relative;
      width:80px;
      height:80px;
      margin:10px auto;
    }

    .donut-svg{
      width:100%;
      height:100%;
      transform:rotate(-90deg);
    }

    .donut-track{
      fill:none;
      stroke:rgba(0,0,0,0.1);
      stroke-width:8;
    }

    .donut-progress{
      fill:none;
      stroke-width:8;
      stroke-linecap:round;
      transition:stroke-dasharray 2s ease-out;
    }

    .donut-text{
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%);
      font-size:0.9rem;
      font-weight:700;
      text-align:center;
    }

    .card-value{font-size:1.8rem;font-weight:800;margin:8px 0;line-height:1.2}
    .card-subtitle{font-size:0.9rem;color:#999;margin:0}

    .income .donut-progress{stroke:var(--success-color)}
    .expense .donut-progress{stroke:var(--danger-color)}
    .balance .donut-progress{stroke:var(--primary-color)}
    .goal .donut-progress{stroke:var(--warning-color)}

    .income .card-value{color:var(--success-color)}
    .expense .card-value{color:var(--danger-color)}
    .balance .card-value{color:var(--primary-color)}
    .goal .card-value{color:var(--warning-color)}

    /* ===== BACK SIDE INSIGHTS ===== */
    .insight-icon{font-size:2rem;margin-bottom:10px}
    .insight-title{font-size:1.1rem;font-weight:600;margin-bottom:8px}
    .insight-text{font-size:0.9rem;color:#666;line-height:1.4}

    /* ===== INTERACTIVE PROGRESS BARS ===== */
    .progress-container{margin-top:16px;cursor:pointer}
    .progress-bar{height:8px;background:rgba(0,0,0,0.1);border-radius:999px;overflow:hidden;position:relative}
    
    .progress-fill{
      height:100%;
      border-radius:999px;
      transition:width 2s cubic-bezier(0.4, 0, 0.2, 1);
      position:relative;
    }

    .progress-fill::after{
      content:'';
      position:absolute;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      animation:shimmer 2s infinite;
    }

    @keyframes shimmer{
      0%{transform:translateX(-100%)}
      100%{transform:translateX(100%)}
    }

    .goal .progress-fill{background:var(--grad-warning)}

    /* ===== CHARTS SECTION ===== */
    .charts-section{margin:40px 0;opacity:0;transform:translateY(50px)}
    .charts-section.scroll-visible{opacity:1;transform:translateY(0);transition:all 0.8s ease}
    
    .section-title{font-size:1.8rem;font-weight:700;margin:0 0 24px;color:var(--fg)}
    .charts-grid{display:grid;grid-template-columns:1fr;gap:24px}
    @media(min-width:1024px){.charts-grid{grid-template-columns:2fr 1fr}}

    .chart-card{
      background:rgba(255,255,255,0.9);
      border-radius:var(--radius-lg);
      padding:24px;
      border:1px solid var(--card-border);
      box-shadow:var(--shadow);
      transition:all 0.3s ease;
      cursor:pointer;
    }

    .chart-card:hover{
      transform:translateY(-5px);
      box-shadow:0 20px 40px rgba(0,0,0,.12);
    }

    .chart-title{font-size:1.3rem;font-weight:600;margin:0 0 20px;color:var(--fg)}
    .chart-container{position:relative;height:300px}

    /* ===== MAIN DONUT CHART ===== */
    .donut-chart{width:100%;height:100%;position:relative}
    .donut-svg-main{width:100%;height:100%}
    .donut-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
    .donut-total{font-size:2rem;font-weight:800;color:var(--fg)}
    .donut-label{font-size:0.9rem;color:#666;margin-top:4px}

    /* ===== CHART LEGEND ===== */
    .chart-legend{margin-top:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px}
    .legend-item{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:0.9rem;
      padding:8px;
      border-radius:8px;
      transition:all 0.3s ease;
      cursor:pointer;
    }

    .legend-item:hover{
      background:rgba(0,0,0,0.05);
      transform:translateX(5px);
    }

    .legend-color{width:12px;height:12px;border-radius:3px;flex-shrink:0}
    .legend-text{flex:1;font-weight:500}
    .legend-amount{font-weight:700;color:var(--fg)}

    /* ===== CATEGORY PROGRESS BARS ===== */
    .category-item{
      margin-bottom:16px;
      padding:12px;
      border-radius:8px;
      transition:all 0.3s ease;
      cursor:pointer;
    }

    .category-item:hover{
      background:rgba(0,0,0,0.05);
      transform:scale(1.02);
    }

    .category-item.clicked{
      animation:categoryPulse 0.6s ease-out;
    }

    @keyframes categoryPulse{
      0%{transform:scale(1)}
      50%{transform:scale(1.05);background:rgba(108,92,231,0.1)}
      100%{transform:scale(1)}
    }

    /* ===== RECENT TRANSACTIONS ===== */
    .transactions-section{margin:40px 0;opacity:0;transform:translateY(50px)}
    .transactions-section.scroll-visible{opacity:1;transform:translateY(0);transition:all 0.8s ease 0.4s}

    .transactions-card{
      background:rgba(255,255,255,0.9);
      border-radius:var(--radius-lg);
      padding:24px;
      border:1px solid var(--card-border);
      box-shadow:var(--shadow);
    }

    .transaction-item{
      display:flex;
      align-items:center;
      gap:16px;
      padding:12px 0;
      border-bottom:1px solid rgba(0,0,0,0.05);
      transition:all 0.3s ease;
      cursor:pointer;
      opacity:0;
      transform:translateX(-30px);
    }

    .transaction-item.scroll-visible{
      opacity:1;
      transform:translateX(0);
    }

    .transaction-item:hover{
      background:rgba(0,0,0,0.02);
      padding-left:16px;
      border-radius:8px;
    }

    .transaction-item:last-child{border-bottom:none}
    .transaction-icon{font-size:1.5rem;width:40px;text-align:center;flex-shrink:0}
    .transaction-details{flex:1;min-width:0}
    .transaction-description{font-weight:600;margin:0 0 4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .transaction-meta{font-size:0.85rem;color:#666}
    .transaction-amount{font-weight:700;font-size:1.1rem;flex-shrink:0}
    .transaction-amount.positive{color:var(--success-color)}
    .transaction-amount.negative{color:var(--danger-color)}

    /* ===== EMPTY STATES ===== */
    .empty-state{
      text-align:center;
      padding:40px 20px;
      color:#777;
      background:rgba(0,0,0,0.02);
      border-radius:12px;
      margin:20px 0;
    }
    .empty-state h3{margin:0 0 12px;font-size:1.2rem;color:#555}
    .empty-state p{margin:0;font-size:0.95rem}

    /* ===== SCROLL ANIMATIONS ===== */
    .scroll-fade{
      opacity:0;
      transform:translateY(30px);
      transition:all 0.8s ease;
    }

    .scroll-fade.visible{
      opacity:1;
      transform:translateY(0);
    }

    /* ===== ANIMATED COUNTERS ===== */
    .counter{
      display:inline-block;
    }

    /* ===== RESPONSIVE ===== */
    @media(max-width:768px){
      .page-title{font-size:2rem}
      .dashboard-grid{grid-template-columns:1fr;gap:16px}
      .charts-grid{grid-template-columns:1fr}
      .card-value{font-size:1.5rem}
      main.container{padding:84px 16px 24px}
      .topbar{padding:0 16px}
      .top-actions{flex-direction:column;gap:8px}
      .date-selectors{flex-direction:column;gap:8px;width:100%}
      .select-wrapper{width:100%}
      .morphing-shape{width:100px;height:100px}
    }

    /* ===== STATUS MESSAGE ===== */
    .status-message{
      position:fixed;bottom:20px;right:20px;
      padding:12px 20px;border-radius:8px;
      font-weight:600;color:#fff;
      transform:translateY(100px);opacity:0;
      transition:all .3s ease;z-index:1000;
    }
    .status-message.is-visible{transform:translateY(0);opacity:1}
    .status-message.success{background:var(--success-color)}
    .status-message.error{background:var(--danger-color)}
    .status-message.warning{background:var(--warning-color)}
  </style>
</head>
<body>
  <!-- Particle System -->
  <div class="particles-container" id="particles-container"></div>
  
  <!-- Morphing Shapes -->
  <div class="morphing-shape shape-1"></div>
  <div class="morphing-shape shape-2"></div>
  <div class="morphing-shape shape-3"></div>

  <!-- Boot Loader -->
  <div id="boot-loader" class="boot-loader">
    <div class="loader-content">
      <div class="loader-spinner"></div>
      <p class="loader-text">Caricamento dati...</p>
    </div>
  </div>

  <!-- Top Bar -->
  <nav class="topbar">
    <a href="/dashboard.html" class="logo-link">
      <span class="logo-text">🏠 MyHomesBudget</span>
    </a>
    
    <div class="top-center">
      <div class="date-selectors">
        <div class="select-wrapper">
          <select id="month-selector" class="topbar-select">
            <!-- Populated by JS -->
          </select>
        </div>
        <div class="select-wrapper">
          <select id="year-selector" class="topbar-select">
            <!-- Populated by JS -->
          </select>
        </div>
      </div>
    </div>

    <div class="top-actions">
      <a href="/dashboard.html" class="top-link">📊 Dashboard</a>
      <button id="logout-btn" class="top-btn">Esci</button>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="container">
    <div class="page-header">
      <h1 class="page-title">📈 Riepilogo Finanziario</h1>
      <p class="page-subtitle">Analisi dettagliata delle tue finanze</p>
    </div>

    <!-- Summary Cards with 3D Flip -->
    <div id="summary-content" class="dashboard-grid">
      <div class="summary-card income">
        <div class="card-inner">
          <div class="card-front">
            <div class="card-header">
              <div class="card-title">
                <span class="card-icon">💰</span>
                Entrate Totali
              </div>
            </div>
            <div class="donut-container">
              <svg class="donut-svg" viewBox="0 0 100 100">
                <circle class="donut-track" cx="50" cy="50" r="40"></circle>
                <circle class="donut-progress" id="income-donut" cx="50" cy="50" r="40" stroke-dasharray="0 251.2"></circle>
              </svg>
              <div class="donut-text">
                <div id="income-percentage">0%</div>
              </div>
            </div>
            <p id="income-value" class="card-value">€0.00</p>
            <p class="card-subtitle">Questo mese</p>
          </div>
          <div class="card-back">
            <div class="insight-icon">📊</div>
            <div class="insight-title">Analisi Entrate</div>
            <div id="income-insight" class="insight-text">Le tue entrate mostrano un trend positivo rispetto al mese scorso</div>
          </div>
        </div>
      </div>

      <div class="summary-card expense">
        <div class="card-inner">
          <div class="card-front">
            <div class="card-header">
              <div class="card-title">
                <span class="card-icon">💸</span>
                Uscite Totali
              </div>
            </div>
            <div class="donut-container">
              <svg class="donut-svg" viewBox="0 0 100 100">
                <circle class="donut-track" cx="50" cy="50" r="40"></circle>
                <circle class="donut-progress" id="expense-donut" cx="50" cy="50" r="40" stroke-dasharray="0 251.2"></circle>
              </svg>
              <div class="donut-text">
                <div id="expense-percentage">0%</div>
              </div>
            </div>
            <p id="expense-value" class="card-value">€0.00</p>
            <p class="card-subtitle">Questo mese</p>
          </div>
          <div class="card-back">
            <div class="insight-icon">⚠️</div>
            <div class="insight-title">Controllo Spese</div>
            <div id="expense-insight" class="insight-text">Monitora le tue spese per rimanere nel budget</div>
          </div>
        </div>
      </div>

      <div class="summary-card balance">
        <div class="card-inner">
          <div class="card-front">
            <div class="card-header">
              <div class="card-title">
                <span class="card-icon">⚖️</span>
                Saldo
              </div>
            </div>
            <div class="donut-container">
              <svg class="donut-svg" viewBox="0 0 100 100">
                <circle class="donut-track" cx="50" cy="50" r="40"></circle>
                <circle class="donut-progress" id="balance-donut" cx="50" cy="50" r="40" stroke-dasharray="0 251.2"></circle>
              </svg>
              <div class="donut-text">
                <div id="balance-percentage">0%</div>
              </div>
            </div>
            <p id="balance-value" class="card-value">€0.00</p>
            <p class="card-subtitle">Differenza entrate/uscite</p>
          </div>
          <div class="card-back">
            <div class="insight-icon">💡</div>
            <div class="insight-title">Situazione Finanziaria</div>
            <div id="balance-insight" class="insight-text">Il tuo saldo riflette la gestione delle finanze</div>
          </div>
        </div>
      </div>

      <div class="summary-card goal">
        <div class="card-inner">
          <div class="card-front">
            <div class="card-header">
              <div class="card-title">
                <span class="card-icon">🎯</span>
                Obiettivo
              </div>
            </div>
            <div class="donut-container">
              <svg class="donut-svg" viewBox="0 0 100 100">
                <circle class="donut-track" cx="50" cy="50" r="40"></circle>
                <circle class="donut-progress" id="goal-donut" cx="50" cy="50" r="40" stroke-dasharray="0 251.2"></circle>
              </svg>
              <div class="donut-text">
                <div id="goal-percentage">0%</div>
              </div>
            </div>
            <p id="goal-value" class="card-value">€0.00</p>
            <p id="goal-name" class="card-subtitle">Nessun obiettivo</p>
          </div>
          <div class="card-back">
            <div class="insight-icon">🚀</div>
            <div class="insight-title">Progressi Obiettivo</div>
            <div id="goal-insight" class="insight-text">Continua così per raggiungere il tuo obiettivo!</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts Section -->
    <section class="charts-section scroll-fade">
      <h2 class="section-title">📊 Analisi per Categoria</h2>
      <div class="charts-grid">
        <div class="chart-card">
          <h3 class="chart-title">Distribuzione Spese</h3>
          <div class="chart-container">
            <div id="expenses-chart" class="donut-chart">
              <!-- Chart will be generated here -->
            </div>
          </div>
          <div id="expenses-legend" class="chart-legend">
            <!-- Legend will be generated here -->
          </div>
        </div>

        <div class="chart-card">
          <h3 class="chart-title">Top 5 Categorie</h3>
          <div id="top-categories-list">
            <!-- Top categories will be listed here -->
          </div>
        </div>
      </div>
    </section>

    <!-- Recent Transactions -->
    <section class="transactions-section scroll-fade">
      <h2 class="section-title">💳 Transazioni Recenti</h2>
      <div class="transactions-card">
        <div id="recent-transactions">
          <!-- Recent transactions will be listed here -->
        </div>
      </div>
    </section>
  </main>

  <!-- Status Message -->
  <div id="status-message" class="status-message" aria-live="polite"></div>

  <script>
    // Initialize Supabase
    const SUPABASE_URL = "https://upcusjlumfeadgbhziwq.supabase.co";
    const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwY3Vzamx1bWZlYWRnYmh6aXdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0MTAzMTgsImV4cCI6MjA3MTk4NjMxOH0.U3cukTOaAZCPOF9f0mnyO00ghRgrzxwPx6GwqKuZmCM";
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
      auth: {
        storage: localStorage,
        persistSession: true,
        autoRefreshToken: true,
      }
    });

    // Global state
    let user = null;
    let allCategories = [];
    let currentData = null;

    // DOM elements
    const bootLoader = document.getElementById('boot-loader');
    const monthSelector = document.getElementById('month-selector');
    const yearSelector = document.getElementById('year-selector');
    const summaryContent = document.getElementById('summary-content');
    const statusMessage = document.getElementById('status-message');
    const logoutBtn = document.getElementById('logout-btn');

    // ===== UTILITY FUNCTIONS =====
    function safeToNumber(v) { 
      const n = (typeof v === 'number') ? v : parseFloat(String(v).replace(',', '.')); 
      return Number.isFinite(n) ? n : 0; 
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('it-IT', {
        style: 'currency',
        currency: 'EUR',
        minimumFractionDigits: 2
      }).format(amount);
    }

    function escapeHTML(s) {
      return String(s ?? '')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    function showStatusMessage(message, type = 'success', duration = 3000) {
      statusMessage.textContent = message;
      statusMessage.className = `status-message ${type} is-visible`;
      setTimeout(() => statusMessage.classList.remove('is-visible'), duration);
    }

    // ===== PARTICLE SYSTEM =====
    function createParticles() {
      const container = document.getElementById('particles-container');
      const particleCount = 50;
      
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 6 + 's';
        particle.style.animationDuration = (6 + Math.random() * 4) + 's';
        container.appendChild(particle);
      }
    }

    // ===== RIPPLE EFFECT =====
    function createRipple(e) {
      const button = e.currentTarget;
      const circle = document.createElement('span');
      const diameter = Math.max(button.clientWidth, button.clientHeight);
      const radius = diameter / 2;
      
      circle.style.width = circle.style.height = `${diameter}px`;
      circle.style.left = `${e.clientX - button.offsetLeft - radius}px`;
      circle.style.top = `${e.clientY - button.offsetTop - radius}px`;
      circle.classList.add('ripple');
      
      const ripple = button.getElementsByClassName('ripple')[0];
      if (ripple) {
        ripple.remove();
      }
      
      button.appendChild(circle);
    }

    // ===== SCROLL ANIMATIONS =====
    const observerOptions = {
      threshold: 0.1,
      rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('scroll-visible');
        }
      });
    }, observerOptions);

    function initScrollAnimations() {
      document.querySelectorAll('.scroll-fade, .summary-card, .transaction-item').forEach(el => {
        observer.observe(el);
      });
    }

    // ===== ANIMATED COUNTERS =====
    function animateCounter(element, targetValue, duration = 2000, formatter = (v) => formatCurrency(v)) {
      const startValue = 0;
      const startTime = performance.now();
      
      function updateCounter(currentTime) {
        const elapsedTime = currentTime - startTime;
        const progress = Math.min(elapsedTime / duration, 1);
        
        // Easing function (easeOutQuart)
        const easedProgress = 1 - Math.pow(1 - progress, 4);
        
        const currentValue = startValue + (targetValue - startValue) * easedProgress;
        element.textContent = formatter(currentValue);
        
        if (progress < 1) {
          requestAnimationFrame(updateCounter);
        } else {
          element.textContent = formatter(targetValue);
        }
      }
      
      requestAnimationFrame(updateCounter);
    }

    // ===== DONUT CHART ANIMATIONS =====
    function animateDonut(elementId, percentage, delay = 0) {
      setTimeout(() => {
        const circle = document.getElementById(elementId);
        if (circle) {
          const circumference = 2 * Math.PI * 40; // radius = 40
          const strokeDasharray = (percentage / 100) * circumference;
          circle.style.strokeDasharray = `${strokeDasharray} ${circumference}`;
        }
      }, delay);
    }

    // ===== INITIALIZE DATE SELECTORS =====
    function initializeDateSelectors() {
      const currentDate = new Date();
      const currentMonth = currentDate.getMonth();
      const currentYear = currentDate.getFullYear();
      
      // Populate months
      const months = [
        'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno',
        'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'
      ];
      
      monthSelector.innerHTML = '';
      months.forEach((month, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = month;
        if (index === currentMonth) option.selected = true;
        monthSelector.appendChild(option);
      });
      
      // Populate years (last 5 years + next 2)
      yearSelector.innerHTML = '';
      for (let year = currentYear - 5; year <= currentYear + 2; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === currentYear) option.selected = true;
        yearSelector.appendChild(option);
      }
    }

    // ===== LOAD CATEGORIES =====
    async function loadCategories() {
      try {
        const { data: categories, error } = await supabase
          .from('categories')
          .select('*')
          .eq('created_by', user.id);
        
        if (error) throw error;
        allCategories = categories || [];
      } catch (error) {
        console.error("Errore nel caricamento delle categorie:", error);
      }
    }

    // ===== LOAD TRANSACTIONS FOR PERIOD =====
    async function loadTransactionsForPeriod(month, year) {
      try {
        const startDate = new Date(year, month, 1);
        const endDate = new Date(year, month + 1, 0, 23, 59, 59);
        
        const { data: transactions, error } = await supabase
          .from('transactions')
          .select(`
            *,
            categories(name, icon),
            subcategories(name, icon)
          `)
          .eq('created_by', user.id)
          .gte('occurred_at', startDate.toISOString())
          .lte('occurred_at', endDate.toISOString())
          .eq('is_paid', true)
          .order('occurred_at', { ascending: false });

        if (error) throw error;
        return transactions || [];
      } catch (error) {
        console.error("Errore nel caricamento delle transazioni:", error);
        return [];
      }
    }

    // ===== LOAD GOALS =====
    async function loadGoals() {
      try {
        const { data: goals, error } = await supabase
          .from('goals')
          .select('name, target_amount, current_amount')
          .eq('user_id', user.id)
          .eq('active', true)
          .limit(1)
          .maybeSingle();

        if (error && error.code !== 'PGRST116') throw error;
        return goals;
      } catch (error) {
        console.error("Errore nel caricamento degli obiettivi:", error);
        return null;
      }
    }

    // ===== RENDER SUMMARY CARDS =====
    function renderSummaryCards(data) {
      const incomeEl = document.getElementById('income-value');
      const expenseEl = document.getElementById('expense-value');
      const balanceEl = document.getElementById('balance-value');
      const goalValueEl = document.getElementById('goal-value');
      const goalNameEl = document.getElementById('goal-name');

      // Calculate percentages for donuts
      const maxAmount = Math.max(data.totalIncome, data.totalExpenses);
      const incomePercentage = maxAmount > 0 ? (data.totalIncome / maxAmount) * 100 : 0;
      const expensePercentage = maxAmount > 0 ? (data.totalExpenses / maxAmount) * 100 : 0;
      const balancePercentage = data.balance >= 0 ? 
        (maxAmount > 0 ? (Math.abs(data.balance) / maxAmount) * 100 : 0) : 
        (maxAmount > 0 ? (Math.abs(data.balance) / maxAmount) * 100 : 0);

      // Update percentage displays
      document.getElementById('income-percentage').textContent = Math.round(incomePercentage) + '%';
      document.getElementById('expense-percentage').textContent = Math.round(expensePercentage) + '%';
      document.getElementById('balance-percentage').textContent = Math.round(balancePercentage) + '%';

      // Animate counters
      setTimeout(() => {
        animateCounter(incomeEl, data.totalIncome, 2000);
        animateCounter(expenseEl, data.totalExpenses, 2000);
        animateCounter(balanceEl, data.balance, 2000, (v) => {
          return formatCurrency(v);
        });
      }, 500);

      // Animate donuts
      animateDonut('income-donut', incomePercentage, 800);
      animateDonut('expense-donut', expensePercentage, 1000);
      animateDonut('balance-donut', balancePercentage, 1200);

      // Update balance color
      balanceEl.style.color = data.balance >= 0 ? 'var(--success-color)' : 'var(--danger-color)';

      // Update insights
      document.getElementById('income-insight').textContent = 
        data.totalIncome > 2000 ? "Ottime entrate questo mese! 💪" : 
        data.totalIncome > 1000 ? "Entrate nella media 📊" : "Cerca di aumentare le entrate 📈";

      document.getElementById('expense-insight').textContent = 
        data.totalExpenses > data.totalIncome ? "Attenzione: spese superiori alle entrate ⚠️" : 
        "Spese sotto controllo! 👍";

      document.getElementById('balance-insight').textContent = 
        data.balance > 500 ? "Ottima gestione finanziaria! 🎉" : 
        data.balance > 0 ? "Situazione equilibrata ⚖️" : "Necessario rivedere il budget ⚠️";

      // Goal data
      if (data.goal) {
        setTimeout(() => {
          animateCounter(goalValueEl, data.goal.current_amount, 2000);
        }, 700);
        goalNameEl.textContent = data.goal.name;
        
        const progress = data.goal.target_amount > 0 
          ? (data.goal.current_amount / data.goal.target_amount) * 100 
          : 0;
        
        document.getElementById('goal-percentage').textContent = Math.round(progress) + '%';
        animateDonut('goal-donut', progress, 1400);

        document.getElementById('goal-insight').textContent = 
          progress >= 100 ? "Obiettivo raggiunto! 🎯🎉" : 
          progress >= 75 ? "Quasi al traguardo! 🚀" : 
          progress >= 50 ? "A metà strada! 💪" : 
          progress >= 25 ? "Buon inizio! 👍" : "Inizia a risparmiare! 💰";
      } else {
        goalValueEl.textContent = formatCurrency(0);
        goalNameEl.textContent = 'Nessun obiettivo';
        document.getElementById('goal-percentage').textContent = '0%';
        document.getElementById('goal-insight').textContent = "Imposta un obiettivo per iniziare! 🎯";
      }
    }

    // ===== RENDER EXPENSES CHART =====
    function renderExpensesChart(categories) {
      const chartContainer = document.getElementById('expenses-chart');
      const legendContainer = document.getElementById('expenses-legend');
      
      if (!categories || categories.length === 0) {
        chartContainer.innerHTML = '<div class="empty-state"><h3>Nessuna spesa</h3><p>Non ci sono spese da visualizzare per questo periodo.</p></div>';
        legendContainer.innerHTML = '';
        return;
      }

      const total = categories.reduce((sum, cat) => sum + cat.amount, 0);
      const colors = ['#6c5ce7', '#00cec9', '#fd79a8', '#fdcb6e', '#e17055', '#74b9ff', '#a29bfe'];
      
      // Create SVG donut chart
      const size = 200;
      const radius = 70;
      const center = size / 2;
      let currentAngle = 0;
      
      let svgPaths = '';
      let legendHTML = '';
      
      categories.forEach((category, index) => {
        const percentage = (category.amount / total) * 100;
        const sliceAngle = (category.amount / total) * 360;
        
        // Calculate path for donut slice
        const startAngle = currentAngle;
        const endAngle = currentAngle + sliceAngle;
        
        const x1 = center + radius * Math.cos((startAngle - 90) * Math.PI / 180);
        const y1 = center + radius * Math.sin((startAngle - 90) * Math.PI / 180);
        const x2 = center + radius * Math.cos((endAngle - 90) * Math.PI / 180);
        const y2 = center + radius * Math.sin((endAngle - 90) * Math.PI / 180);
        
        const largeArcFlag = sliceAngle > 180 ? 1 : 0;
        
        const pathData = [
          `M ${center} ${center}`,
          `L ${x1} ${y1}`,
          `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2}`,
          'Z'
        ].join(' ');
        
        const color = colors[index % colors.length];
        
        svgPaths += `<path d="${pathData}" fill="${color}" stroke="#fff" stroke-width="2" opacity="0" style="animation: fadeIn 0.6s ease-out ${index * 0.2}s forwards"/>`;
        
        // Legend item
        legendHTML += `
          <div class="legend-item" style="animation-delay: ${index * 0.1}s">
            <div class="legend-color" style="background-color:${color}"></div>
            <span class="legend-text">${escapeHTML(category.name)}</span>
            <span class="legend-amount">${formatCurrency(category.amount)}</span>
          </div>
        `;
        
        currentAngle += sliceAngle;
      });
      
      chartContainer.innerHTML = `
        <svg class="donut-svg-main" viewBox="0 0 ${size} ${size}">
          ${svgPaths}
          <circle cx="${center}" cy="${center}" r="40" fill="white" stroke="none"/>
        </svg>
        <div class="donut-center">
          <div class="donut-total counter">${formatCurrency(total)}</div>
          <div class="donut-label">Totale Spese</div>
        </div>
      `;
      
      legendContainer.innerHTML = legendHTML;
      
      // Add click handlers for legend items
      legendContainer.querySelectorAll('.legend-item').forEach(item => {
        item.addEventListener('click', createRipple);
      });
    }

    // ===== RENDER TOP CATEGORIES =====
    function renderTopCategories(categories) {
      const container = document.getElementById('top-categories-list');
      
      if (!categories || categories.length === 0) {
        container.innerHTML = '<div class="empty-state"><h3>Nessuna categoria</h3><p>Non ci sono categorie da visualizzare.</p></div>';
        return;
      }

      const topCategories = categories.slice(0, 5);
      const maxAmount = Math.max(...topCategories.map(cat => cat.amount));
      
      let html = '';
      topCategories.forEach((category, index) => {
        const percentage = maxAmount > 0 ? (category.amount / maxAmount) * 100 : 0;
        const icon = category.icon || '💸';
        
        html += `
          <div class="category-item" data-category="${escapeHTML(category.name)}" style="animation-delay: ${index * 0.1}s; opacity: 0; animation: fadeInUp 0.6s ease-out ${index * 0.1}s forwards;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
              <span style="display: flex; align-items: center; gap: 8px; font-weight: 600;">
                <span style="font-size: 1.2rem;">${escapeHTML(icon)}</span>
                ${escapeHTML(category.name)}
              </span>
              <span class="counter" style="font-weight: 700; color: var(--danger-color);">${formatCurrency(category.amount)}</span>
            </div>
            <div class="progress-container">
              <div class="progress-bar">
                <div class="progress-fill" style="background: var(--grad-danger); width: 0%; transition: width 2s ease-out ${index * 0.2}s;"></div>
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
      
      // Animate progress bars
      setTimeout(() => {
        topCategories.forEach((category, index) => {
          const percentage = maxAmount > 0 ? (category.amount / maxAmount) * 100 : 0;
          const progressBar = container.children[index]?.querySelector('.progress-fill');
          if (progressBar) {
            progressBar.style.width = percentage + '%';
          }
        });
      }, 500);
      
      // Add click handlers
      container.querySelectorAll('.category-item').forEach(item => {
        item.addEventListener('click', function(e) {
          this.classList.add('clicked');
          createRipple(e);
          setTimeout(() => this.classList.remove('clicked'), 600);
        });
      });
    }

    // ===== RENDER RECENT TRANSACTIONS =====
    function renderRecentTransactions(transactions) {
      const container = document.getElementById('recent-transactions');
      
      if (!transactions || transactions.length === 0) {
        container.innerHTML = '<div class="empty-state"><h3>Nessuna transazione</h3><p>Non ci sono transazioni recenti da visualizzare.</p></div>';
        return;
      }

      const recentTx = transactions.slice(0, 10);
      
      let html = '';
      recentTx.forEach((tx, index) => {
        const isIncome = tx.kind === 'income';
        const amount = safeToNumber(tx.amount);
        const categoryName = tx.categories?.name || 'Altro';
        const categoryIcon = tx.categories?.icon || (isIncome ? '💰' : '💸');
        const date = new Date(tx.occurred_at).toLocaleDateString('it-IT', { 
          day: '2-digit', 
          month: 'short' 
        });
        
        html += `
          <div class="transaction-item" style="animation-delay: ${index * 0.1}s">
            <div class="transaction-icon">${escapeHTML(categoryIcon)}</div>
            <div class="transaction-details">
              <h4 class="transaction-description">${escapeHTML(tx.note || 'Transazione')}</h4>
              <p class="transaction-meta">${date} • ${escapeHTML(categoryName)}</p>
            </div>
            <div class="transaction-amount ${isIncome ? 'positive' : 'negative'}">
              ${isIncome ? '+' : '-'}${formatCurrency(amount)}
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
      
      // Add click handlers
      container.querySelectorAll('.transaction-item').forEach(item => {
        item.addEventListener('click', createRipple);
      });
    }

    // ===== MAIN DATA LOADING FUNCTION =====
    async function loadSummaryData() {
      try {
        monthSelector.disabled = true;
        yearSelector.disabled = true;
        
        const selectedMonth = parseInt(monthSelector.value);
        const selectedYear = parseInt(yearSelector.value);
        
        // Load all data in parallel
        const [transactions, goal] = await Promise.all([
          loadTransactionsForPeriod(selectedMonth, selectedYear),
          loadGoals()
        ]);

        // Process transactions
        const incomeTransactions = transactions.filter(t => t.kind === 'income');
        const expenseTransactions = transactions.filter(t => t.kind === 'expense');
        
        const totalIncome = incomeTransactions.reduce((sum, t) => sum + safeToNumber(t.amount), 0);
        const totalExpenses = expenseTransactions.reduce((sum, t) => sum + safeToNumber(t.amount), 0);
        const balance = totalIncome - totalExpenses;

        // Group expenses by category
        const categoryExpenses = {};
        expenseTransactions.forEach(tx => {
          const categoryName = tx.categories?.name || 'Altro';
          const categoryIcon = tx.categories?.icon || '💸';
          if (!categoryExpenses[categoryName]) {
            categoryExpenses[categoryName] = { 
              name: categoryName, 
              icon: categoryIcon, 
              amount: 0 
            };
          }
          categoryExpenses[categoryName].amount += safeToNumber(tx.amount);
        });

        const expenseCategories = Object.values(categoryExpenses)
          .sort((a, b) => b.amount - a.amount);

        // Prepare summary data
        currentData = {
          totalIncome,
          totalExpenses,
          balance,
          goal,
          expenseCategories,
          transactions,
          period: {
            month: selectedMonth,
            year: selectedYear
          }
        };

        // Render all components
        renderSummaryCards(currentData);
        renderExpensesChart(expenseCategories);
        renderTopCategories(expenseCategories);
        renderRecentTransactions(transactions);

        // Trigger scroll animations
        setTimeout(() => {
          document.querySelectorAll('.summary-card').forEach((card, index) => {
            card.style.animationDelay = `${index * 0.1}s`;
            card.classList.add('scroll-visible');
          });
        }, 500);

      } catch (error) {
        console.error("Errore nel caricamento dei dati:", error);
        showStatusMessage("Errore nel caricamento dei dati", "error");
      } finally {
        monthSelector.disabled = false;
        yearSelector.disabled = false;
      }
    }

    // ===== AUTHENTICATION AND INITIALIZATION =====
    async function initializeApp() {
      try {
        // Check authentication
        const { data: { user: authUser }, error: authError } = await supabase.auth.getUser();
        
        if (authError || !authUser) {
          console.log('User not authenticated, redirecting...');
          window.location.href = '/';
          return;
        }

        user = authUser;
        console.log('User authenticated:', user.email);

        // Initialize particle system and animations
        createParticles();
        initScrollAnimations();

        // Initialize UI
        initializeDateSelectors();
        
        // Load categories
        await loadCategories();
        
        // Load initial data
        await loadSummaryData();
        
        // Set up event listeners
        monthSelector.addEventListener('change', loadSummaryData);
        yearSelector.addEventListener('change', loadSummaryData);
        
        // Add ripple effects to clickable elements
        document.querySelectorAll('.summary-card, .chart-card').forEach(card => {
          card.addEventListener('click', createRipple);
        });
        
        logoutBtn.addEventListener('click', async () => {
          await supabase.auth.signOut();
          window.location.href = '/';
        });

        // Hide loader
        bootLoader.classList.add('is-hidden');
        
        showStatusMessage("Dati caricati con successo!", "success");

      } catch (error) {
        console.error('Initialization error:', error);
        showStatusMessage("Errore durante l'inizializzazione", "error");
        
        // Hide loader even on error
        bootLoader.classList.add('is-hidden');
      }
    }

    // Add fadeIn animation for chart paths
    const style = document.createElement('style');
    style.textContent = `
      @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.8); }
        to { opacity: 0.9; transform: scale(1); }
      }
      
      @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      @keyframes slideInDown {
        from { opacity: 0; transform: translateY(-30px); }
        to { opacity: 1; transform: translateY(0); }
      }
    `;
    document.head.appendChild(style);

    // Start the app
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
