<!doctype html>
<html lang="it" data-app="myhomesbudget">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Il Mio Account â€” MyHomesBudget</title>
  <meta name="robots" content="noindex, nofollow" />
  
  <!-- Three.js (Versione stabile per compatibilitÃ ) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <style>
    /* === VARIABILI DI STILE === */
    :root {
      --fg: #111;
      --bg: #f4f7fa;
      --glass: rgba(255,255,255,.6);
      --card-border: rgba(0,0,0,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius-lg: 16px;
      --primary-color: #6c5ce7;
      --grad: linear-gradient(135deg, #6c5ce7, #00cec9);
    }

    * { box-sizing: border-box; }
    html { font-family: -apple-system, system-ui, sans-serif; background-color: var(--bg); }
    
    body {
      margin: 0;
      color: var(--fg);
      background: url("/bg.webp") no-repeat center/cover fixed;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    body::before {
      content: ""; position: fixed; inset: 0;
      background: linear-gradient(135deg, rgba(108,92,231,.05), rgba(0,206,201,.05));
      z-index: -1;
    }

    /* ====== TOPBAR ====== */
    .topbar {
      position: fixed; top: 0; left: 0; right: 0; height: 60px; padding: 0 24px;
      display: flex; align-items: center; justify-content: space-between;
      background: var(--glass); backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--card-border); z-index: 100;
    }
    .logo-link { display: flex; align-items: center; gap: 8px; text-decoration: none; }
    .logo-text { font-weight: 600; color: #333; font-size: 1.1rem; }
    
    .top-link {
      display: flex; align-items: center; justify-content: center; height: 34px;
      color: #fff; text-decoration: none; padding: 6px 12px; border-radius: 10px;
      font-size: .9rem; font-weight: 600; background: var(--grad);
      border: none; box-shadow: 0 4px 12px rgba(0,0,0,.15);
      cursor: pointer; transition: transform 0.2s;
    }
    .top-link:hover { transform: translateY(-2px); }

    /* ====== LAYOUT ====== */
    main.container {
      padding: 100px 24px 40px; 
      max-width: 1000px; 
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 85vh;
    }

    /* AREA 3D */
    .character-stage {
      width: 100%;
      height: 500px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
    }
    
    #canvas-container {
      width: 100%; height: 100%;
      display: block;
    }

    /* MESSAGGIO FLUTTUANTE */
    .message-bubble {
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(8px);
      padding: 24px 40px;
      border-radius: 30px;
      font-weight: 800;
      font-size: 1.3rem;
      color: #333;
      box-shadow: 0 15px 40px rgba(0,0,0,0.1);
      border: 1px solid rgba(255,255,255,0.5);
      text-align: center;
      margin-top: -60px; 
      z-index: 10;
      opacity: 0;
      transform: translateY(20px) scale(0.9);
      transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      max-width: 600px;
    }
    .message-bubble.visible { opacity: 1; transform: translateY(0) scale(1); }
    .message-bubble strong { color: var(--primary-color); }

    .cta-upgrade {
      margin-top: 15px;
      display: inline-block;
      padding: 10px 20px;
      background: #333;
      color: #fff;
      text-decoration: none;
      border-radius: 50px;
      font-size: 1rem;
      transition: transform 0.2s;
    }
    .cta-upgrade:hover { transform: scale(1.05); }

    /* SIMULATORE (Per debug/demo) */
    .plan-simulator {
      margin-top: 50px;
      background: rgba(255,255,255,0.5);
      padding: 15px;
      border-radius: 16px;
      border: 1px solid var(--card-border);
    }
    .tier-switcher { display: flex; gap: 10px; justify-content: center; margin-top: 5px; }
    .tier-btn {
      padding: 6px 12px; border: 1px solid #ddd; background: #fff;
      border-radius: 8px; cursor: pointer; font-weight: 600; color: #666;
      font-size: 0.8rem;
    }
    .tier-btn:hover { background: #eee; }

    /* Loading Overlay */
    #loader-overlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      background: rgba(244,247,250,0.8); z-index: 20;
      font-weight: 700; color: #666;
    }
  </style>
</head>
<body>

  <nav class="topbar">
    <a href="index.html" class="logo-link">
      <img src="/homes.png" alt="Logo" style="height:32px;border-radius:6px;"> 
      <span class="logo-text">MyHomesBudget</span>
    </a>
    <div class="top-nav-right">
      <!-- Link corretto alla dashboard -->
      <a href="dashboard.html" class="top-link">
        <i class="ph ph-arrow-left" style="margin-right:8px"></i> Dashboard
      </a>
    </div>
  </nav>

  <main class="container">
    
    <div class="character-stage">
      <div id="loader-overlay">Caricamento personaggio...</div>
      <div id="canvas-container"></div>
    </div>

    <div id="status-message" class="message-bubble">
      <!-- Il contenuto viene iniettato via JS -->
    </div>

    <!-- Simulatore per testare le animazioni (puoi rimuoverlo in produzione) -->
    <div class="plan-simulator">
      <p style="font-size:0.75rem; text-transform:uppercase; color:#999; font-weight:700; margin:0 0 5px 0;">Test Animazioni:</p>
      <div class="tier-switcher">
        <button class="tier-btn" onclick="setTierAnimation('starter')">Starter (Triste)</button>
        <button class="tier-btn" onclick="setTierAnimation('plus')">Plus (Ride)</button>
        <button class="tier-btn" onclick="setTierAnimation('pro')">Pro (Eccitato)</button>
      </div>
    </div>

  </main>

  <script type="module">
    import { supabase } from "/it/supabase-client.js";

    // --- 1. SCENA 3D ---
    const container = document.getElementById('canvas-container');
    const loader = document.getElementById('loader-overlay');
    const scene = new THREE.Scene();
    
    const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.set(0, 0.5, 5.5);

    const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    container.appendChild(renderer.domElement);

    // Luci
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
    scene.add(ambientLight);
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight.position.set(3, 5, 5);
    dirLight.castShadow = true;
    scene.add(dirLight);
    
    // --- 2. ROBOT (Geometrie Semplici) ---
    const botGroup = new THREE.Group();
    scene.add(botGroup);

    // Materiali
    const mainMat = new THREE.MeshStandardMaterial({ color: 0xecf0f1, roughness: 0.3, metalness: 0.1 });
    const accentMat = new THREE.MeshStandardMaterial({ color: 0xbdc3c7, roughness: 0.2 });
    const darkMat = new THREE.MeshStandardMaterial({ color: 0x2c3e50 });

    // Corpo
    const body = new THREE.Mesh(new THREE.SphereGeometry(0.9, 32, 32), mainMat);
    body.scale.set(1, 0.85, 1);
    body.castShadow = true;
    botGroup.add(body);

    // Testa (Gruppo separato per muoverla)
    const headGroup = new THREE.Group();
    headGroup.position.y = 0.75;
    botGroup.add(headGroup);

    const head = new THREE.Mesh(new THREE.SphereGeometry(0.65, 32, 32), mainMat);
    head.castShadow = true;
    headGroup.add(head);

    // Visiera
    const visor = new THREE.Mesh(new THREE.SphereGeometry(0.56, 32, 32, 0, 6.3, 0, 1.1), accentMat);
    visor.rotation.x = -Math.PI / 2;
    visor.position.y = 0.14;
    headGroup.add(visor);

    // Occhi
    const leftEye = new THREE.Mesh(new THREE.SphereGeometry(0.12, 16, 16), darkMat);
    leftEye.scale.set(1, 1.5, 0.5);
    leftEye.position.set(-0.22, 0.15, 0.52);
    leftEye.rotation.x = -0.2;
    visor.add(leftEye);

    const rightEye = new THREE.Mesh(new THREE.SphereGeometry(0.12, 16, 16), darkMat);
    rightEye.scale.set(1, 1.5, 0.5);
    rightEye.position.set(0.22, 0.15, 0.52);
    rightEye.rotation.x = -0.2;
    visor.add(rightEye);

    // Braccia
    const armGeo = new THREE.SphereGeometry(0.22, 16, 16);
    
    const armRightGroup = new THREE.Group(); 
    armRightGroup.position.set(0.9, 0.1, 0);
    botGroup.add(armRightGroup);
    const armRight = new THREE.Mesh(armGeo, mainMat);
    armRight.scale.set(1, 1.8, 1);
    armRightGroup.add(armRight);
    
    // Pollice DX (Visibile solo in PRO)
    const thumbGeo = new THREE.CylinderGeometry(0.06, 0.06, 0.25, 8);
    const thumb = new THREE.Mesh(thumbGeo, mainMat);
    thumb.position.set(0, 0.3, 0.1);
    thumb.rotation.x = 0.4;
    armRight.add(thumb);
    thumb.visible = false;

    const armLeftGroup = new THREE.Group(); 
    armLeftGroup.position.set(-0.9, 0.1, 0);
    botGroup.add(armLeftGroup);
    const armLeft = new THREE.Mesh(armGeo, mainMat);
    armLeft.scale.set(1, 1.8, 1);
    armLeftGroup.add(armLeft);

    // Ombra
    const shadowPlane = new THREE.Mesh(
        new THREE.PlaneGeometry(2.5, 2.5), 
        new THREE.MeshBasicMaterial({ color: 0x000000, transparent: true, opacity: 0.15 })
    );
    shadowPlane.rotation.x = -Math.PI / 2;
    shadowPlane.position.y = -1.1;
    
    // Texture sfumata per ombra (generata via canvas)
    const canvas = document.createElement('canvas');
    canvas.width = 64; canvas.height = 64;
    const ctx = canvas.getContext('2d');
    const grd = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
    grd.addColorStop(0, 'rgba(0,0,0,1)');
    grd.addColorStop(1, 'rgba(0,0,0,0)');
    ctx.fillStyle = grd; ctx.fillRect(0,0,64,64);
    const shadowTex = new THREE.CanvasTexture(canvas);
    shadowPlane.material.map = shadowTex;
    shadowPlane.material.alphaMap = shadowTex;
    
    botGroup.add(shadowPlane);

    // --- 3. LOGICA ANIMAZIONE ---
    let currentPlan = 'loading'; 
    let time = 0;

    function animate() {
      requestAnimationFrame(animate);
      time += 0.05;

      if (currentPlan === 'starter') {
         // --- TRISTE ---
         // Testa bassa e ciondolante
         headGroup.rotation.x = THREE.MathUtils.lerp(headGroup.rotation.x, 0.5, 0.05);
         headGroup.rotation.y = Math.sin(time * 0.5) * 0.1; 
         
         // Corpo basso e fermo
         botGroup.position.y = THREE.MathUtils.lerp(botGroup.position.y, -0.3 + Math.sin(time)*0.02, 0.1);
         
         // Braccia penzoloni
         armRightGroup.rotation.z = THREE.MathUtils.lerp(armRightGroup.rotation.z, 0, 0.1);
         armRightGroup.position.y = THREE.MathUtils.lerp(armRightGroup.position.y, -0.2, 0.1);
         
         armLeftGroup.rotation.z = THREE.MathUtils.lerp(armLeftGroup.rotation.z, 0, 0.1);
         armLeftGroup.position.y = THREE.MathUtils.lerp(armLeftGroup.position.y, -0.2, 0.1);

         thumb.visible = false;

      } else if (currentPlan === 'plus') {
         // --- FELICE ---
         // Testa alta
         headGroup.rotation.x = THREE.MathUtils.lerp(headGroup.rotation.x, -0.2, 0.05);
         // Ride (vibra veloce verticalmente)
         headGroup.position.y = 0.75 + Math.abs(Math.sin(time * 15)) * 0.02; 
         
         // Corpo saltella piano
         botGroup.position.y = Math.sin(time * 3) * 0.1;

         // Braccia aperte (Accoglienza)
         armRightGroup.rotation.z = THREE.MathUtils.lerp(armRightGroup.rotation.z, 0.5, 0.1);
         armLeftGroup.rotation.z = THREE.MathUtils.lerp(armLeftGroup.rotation.z, -0.5, 0.1);
         
         // Reset posizioni
         armRightGroup.position.y = THREE.MathUtils.lerp(armRightGroup.position.y, 0.1, 0.1);
         armLeftGroup.position.y = THREE.MathUtils.lerp(armLeftGroup.position.y, 0.1, 0.1);

         thumb.visible = false;

      } else if (currentPlan === 'pro') {
         // --- ECCITATO ---
         // Testa energica
         headGroup.rotation.x = Math.sin(time * 3) * 0.1 - 0.1;
         headGroup.rotation.y = Math.sin(time) * 0.2;
         headGroup.position.y = 0.75; 

         // Salto alto (JUMP!)
         const jump = Math.abs(Math.sin(time * 5));
         botGroup.position.y = (jump * 0.5) - 0.2;
         botGroup.rotation.y = Math.sin(time) * 0.2; // Twist corpo

         // Braccia in alto!
         armRightGroup.rotation.z = THREE.MathUtils.lerp(armRightGroup.rotation.z, 2.8, 0.1);
         armRightGroup.position.y = THREE.MathUtils.lerp(armRightGroup.position.y, 0.5, 0.1);
         
         armLeftGroup.rotation.z = THREE.MathUtils.lerp(armLeftGroup.rotation.z, -2.8, 0.1);
         armLeftGroup.position.y = THREE.MathUtils.lerp(armLeftGroup.position.y, 0.5, 0.1);
         
         thumb.visible = true;
      }

      // Ombra dinamica
      shadowPlane.material.opacity = 0.2 - (botGroup.position.y + 0.3) * 0.2;
      
      renderer.render(scene, camera);
    }
    animate();

    // --- 4. LOGICA DI BUSINESS ---
    
    // Funzione globale per il simulatore
    window.setTierAnimation = function(tier) {
      currentPlan = tier.toLowerCase();
      updateUI(tier.toLowerCase());
    }

    function updateUI(plan) {
      const bubble = document.getElementById('status-message');
      let msg = "";
      let color = 0xbdc3c7;
      let emissive = 0x000000;

      if (plan === 'starter' || plan === 'trial') {
        // TRISTE
        msg = `
          <div>ðŸ˜”</div>
          <div style="margin:10px 0; font-size:1.1rem;">Il tuo piano Ã¨ <strong>Starter</strong>.</div>
          <div style="font-weight:400; font-size:0.95rem; color:#666;">Ti stai perdendo report avanzati e obiettivi multipli.</div>
          <a href="pricing.html" class="cta-upgrade" style="background: #f39c12;">Passa a PLUS âž”</a>
        `;
        color = 0x7f8c8d; // Grigio spento
        currentPlan = 'starter'; // Forza stato animazione

      } else if (plan === 'plus') {
        // FELICE
        msg = `
          <div>ðŸ˜„</div>
          <div style="margin:10px 0; font-size:1.1rem;">Grande! Sei un utente <strong>PLUS</strong>.</div>
          <div style="font-weight:400; font-size:0.95rem; color:#666;">Hai sbloccato molto, ma il vero potere Ã¨ nel Pro.</div>
          <a href="pricing.html" class="cta-upgrade" style="background: #8e44ad;">Passa a PRO âž”</a>
        `;
        color = 0xf1c40f; // Oro
        emissive = 0x333300;
        currentPlan = 'plus';

      } else if (plan === 'pro') {
        // ECCITATO
        msg = `
          <div>ðŸš€</div>
          <div style="margin:10px 0; font-size:1.1rem;">WOW! Sei un utente <strong>PRO</strong>!</div>
          <div style="font-weight:400; font-size:0.95rem; color:#666;">Hai il massimo della potenza. Grazie per il supporto!</div>
        `;
        color = 0x9b59b6; // Viola
        emissive = 0x220022;
        currentPlan = 'pro';
      }

      // Aggiorna colore robot
      accentMat.color.setHex(color);
      accentMat.emissive.setHex(emissive);

      // Aggiorna testo con animazione
      bubble.classList.remove('visible');
      setTimeout(() => {
        bubble.innerHTML = msg;
        bubble.classList.add('visible');
      }, 300);
    }

    async function init() {
      try {
        // 1. Ottieni utente
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
           // Se non loggato, manda a login (o mostra starter per demo)
           window.location.href = 'login.html';
           return;
        }
        
        // 2. Leggi Profilo dal DB
        const { data: profile, error } = await supabase
          .from('profiles')
          .select('plan_type')
          .eq('id', session.user.id)
          .single();
          
        if (error) throw error;

        loader.style.display = 'none';
        
        // 3. Aggiorna Scena
        const plan = profile?.plan_type || 'starter';
        console.log("Piano utente:", plan);
        updateUI(plan);

      } catch (err) {
        console.error("Errore caricamento:", err);
        loader.textContent = "Errore caricamento profilo.";
        // Fallback visuale
        updateUI('starter');
      }
    }

    // Gestione resize
    window.addEventListener('resize', () => {
      camera.aspect = container.clientWidth / container.clientHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(container.clientWidth, container.clientHeight);
    });

    // Avvio
    init();

  </script>
</body>
</html>
