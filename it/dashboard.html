<!doctype html>
<html lang="it" data-app="myhomesbudget">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard — MyHomesBudget</title>
  <meta name="description" content="Gestisci le tue finanze, traccia le spese e raggiungi i tuoi obiettivi.">
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" href="/favicon.ico">
  <style>
    :root{
      --fg:#111;--glass:rgba(255,255,255,.58);--card-border:rgba(0,0,0,.08);
      --shadow:0 10px 30px rgba(0,0,0,.10);--radius-lg:16px;--primary-color:#6c5ce7;
    }
    *{box-sizing:border-box}
    html,body{font-family:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif}
    a:focus-visible,button:focus-visible,input:focus-visible,select:focus-visible{
      outline:2px solid #00cec9; outline-offset:2px; border-radius:8px
    }
    body{
      margin:0;color:#fff;background:url("/bg.webp") no-repeat center/cover fixed;
      min-height:100vh;display:flex;flex-direction:column;align-items:center;
    }
    body::before{content:"";position:fixed;inset:0;background:rgba(0,0,0,.08);z-index:-1}

    /* Topbar “glass” come dashboard-riepilogo */
    .topbar{
      position:fixed;top:16px;left:50%;transform:translateX(-50%);
      width:min(1120px,calc(100% - 40px));z-index:20;
      background:var(--glass);backdrop-filter:saturate(1.4) blur(6px);
      border:1px solid rgba(0,0,0,.08);box-shadow:var(--shadow);border-radius:14px;
      display:grid;grid-template-columns: 1fr auto 1fr;align-items:center;
      gap:10px;padding:10px 12px;
    }
    .tb-left,.tb-center,.tb-right{display:flex;align-items:center}
    .tb-left{justify-content:flex-start}
    .tb-center{justify-content:center}
    .tb-right{justify-content:flex-end;gap:8px}
    .logo-link{display:flex;align-items:center;gap:8px;text-decoration:none}
    .logo-image{height:32px;border-radius:6px}
    .logo-text{font-weight:600;color:#111;font-size:1.05rem}
    .month-picker{
      display:flex;align-items:center;gap:8px;background:#fff;border:1px solid var(--card-border);
      padding:8px 10px;border-radius:10px;color:#111
    }
    .month-picker label{font-weight:700;font-size:.9rem}
    .month-picker input[type="month"]{
      border:0;background:transparent;outline:none;color:#111;font-weight:600
    }
    .top-link{
      color:#111;text-decoration:none;padding:8px 12px;border-radius:10px;background:#fff;
      border:1px solid var(--card-border);font-size:.9rem;font-weight:700
    }
    .top-link:hover{filter:brightness(0.96)}

    main.panel{
      margin-top:96px;width:min(1120px,calc(100% - 40px));
      background:var(--glass); color:var(--fg); border-radius:var(--radius-lg);
      padding:clamp(18px,4vw,22px); box-shadow:var(--shadow);display:flex;flex-direction:column;gap:20px;
    }
    h1, h2, h3 { color: #111; }

    .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;font-weight:800;transition:all .2s ease;}
    .btn-primary{background:var(--primary-color);color:#fff;box-shadow:0 8px 22px rgba(0,0,0,.14)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    .dash-nav{display:flex;gap:8px;border-bottom:1px solid rgba(0,0,0,0.1);padding-bottom:12px}
    .dash-nav a{text-decoration:none;color:#333;padding:8px 16px;border-radius:10px;font-weight:600}
    .dash-nav a.is-active{background-color:#fff;color:var(--primary-color);box-shadow:0 4px 12px rgba(0,0,0,0.08)}

    .content-section{background:rgba(255,255,255,.55);border-radius:12px;padding:16px;border:1px solid var(--card-border);}
    .transaction-form{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:flex-end}
    @media (min-width: 920px){.transaction-form{grid-template-columns: repeat(3, 1fr) auto;}}
    .form-group{display:flex;flex-direction:column}
    .form-group.full-width{grid-column:1 / -1}
    .form-group label{font-weight:600;font-size:.9rem;margin-bottom:6px}
    .form-group input,.form-group select{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;background:#fff;font-size:1rem}

    .transaction-list .item{display:grid;grid-template-columns:auto 1fr auto auto;gap:12px;align-items:center;padding:12px 4px;border-bottom:1px solid rgba(0,0,0,0.05)}
    .item-icon{font-size:1.5rem;flex-shrink:0}
    .item-details{display:flex;flex-direction:column;min-width:0}
    .item-details .note{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .item-details .category{font-size:.9rem;color:#555;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .item-amount{text-align:right;white-space:nowrap;flex-shrink:0}
    .item-amount.expense{color:#d32f2f;font-weight:700}
    .item-amount.income{color:#2e7d32;font-weight:700}
    .item-actions{display:flex;gap:4px;flex-shrink:0}
    .action-btn{background-color:rgba(0,0,0,0.05);color:#555;border:1px solid rgba(0,0,0,0.1);border-radius:8px;padding:6px 10px;font-size:.85rem;font-weight:600;cursor:pointer;transition:background-color .2s ease, color .2s ease;white-space:nowrap}
    .action-btn:hover{background-color:var(--primary-color);color:#fff;border-color:var(--primary-color)}
    .action-btn.delete{background-color:#f8d7da;color:#842029;border-color:#f5c2c7}
    .action-btn.delete:hover{background-color:#dc3545;color:#fff;border-color:#dc3545}
    .empty-state{text-align:center;padding:40px;color:#555}
  </style>
</head>
<body>
  <!-- Topbar allineata alla “riepilogo” -->
  <header class="topbar" role="banner">
    <div class="tb-left">
      <a href="/it/" class="logo-link" title="MyHomesBudget">
        <img src="/homes.png" alt="Logo" class="logo-image"><span class="logo-text">MyHomesBudget</span>
      </a>
    </div>
    <div class="tb-center">
      <div class="month-picker">
        <label for="month">Mese</label>
        <input type="month" id="month" name="month" aria-label="Selettore mese">
      </div>
    </div>
    <nav class="tb-right" aria-label="Azioni">
      <a href="/it/onboarding.html?edit=1" class="top-link">Impostazioni</a>
      <a href="#" id="logout-btn" class="top-link">Esci</a>
    </nav>
  </header>

  <main class="panel">
    <!-- Banner piano/trial -->
    <div id="plan-banner" role="status" aria-live="polite"></div>

    <nav id="dash-nav" class="dash-nav">
      <a href="/it/dashboard.html" class="is-active" aria-current="page">Operazioni</a>
      <a href="/it/dashboard-riepilogo.html">Riepilogo</a>
    </nav>

    <section class="content-section">
      <h2 id="form-title">Nuova Transazione</h2>
      <form id="transaction-form" class="transaction-form">
        <input type="hidden" id="transaction-id" name="transaction-id">
        <div class="form-group full-width">
          <label for="kind">Tipo</label>
          <select id="kind" name="kind" required>
            <option value="expense">Uscita</option>
            <option value="income">Entrata</option>
            <option value="transfer">Trasferimento</option>
          </select>
        </div>
        <div class="form-group full-width">
          <label for="note">Nota</label>
          <input type="text" id="note" name="note" placeholder="Es. Caffè al bar" required>
        </div>
        <div class="form-group">
          <label for="amount">Importo (€)</label>
          <input type="number" id="amount" name="amount" step="0.01" placeholder="0.00" required>
        </div>
        <div class="form-group">
          <label for="occurred_at">Data</label>
          <input type="date" id="occurred_at" name="occurred_at" required>
        </div>
        <div class="form-group">
          <label for="category_id">Categoria</label>
          <select id="category_id" name="category_id" required>
            <option value="">Scegli...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="subcategory_id">Sottocategoria</label>
          <select id="subcategory_id" name="subcategory_id">
            <option value="">Scegli...</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary" style="grid-column: 1 / -1; margin-top: 10px;">Aggiungi</button>
      </form>
    </section>

    <section class="content-section">
      <h2>Movimenti Recenti</h2>
      <div id="transaction-list" class="transaction-list">
        <div class="empty-state"><p>Nessuna transazione registrata.</p></div>
      </div>
    </section>
  </main>
  
  <script type="module">
    import { supabase } from "/it/supabase-client.js";

    const monthInput = document.getElementById('month');
    const transactionForm = document.getElementById('transaction-form');
    const kindSelect = document.getElementById('kind');
    const categorySelect = document.getElementById('category_id');
    const subcategorySelect = document.getElementById('subcategory_id');
    const transactionIdInput = document.getElementById('transaction-id');
    const formTitle = document.getElementById('form-title');
    const transactionList = document.getElementById('transaction-list');
    const logoutBtn = document.getElementById('logout-btn');
    let user = null;
    let allCategories = [];
    let allSubcategories = [];
    let allTransactions = [];
    let Plan = null; // modulo piani (import lazy)
    let selectedMonth = null; // "YYYY-MM"

    function safeToNumber(v){ const n=(typeof v==='number')?v:parseFloat(v); return Number.isFinite(n)?n:0; }

    // Helpers mese → inizio/fine (ISO)
    function monthBounds(ym){
      const [y,m] = ym.split('-').map(Number);
      const start = new Date(Date.UTC(y, m-1, 1));
      const end   = new Date(Date.UTC(y, m, 1)); // esclusivo
      return {start: start.toISOString(), end: end.toISOString()};
    }
    function setDefaultMonth(){
      const urlM = new URLSearchParams(location.search).get('m');
      const today = new Date();
      const ym = urlM && /^\d{4}-\d{2}$/.test(urlM) ? urlM
                : `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
      monthInput.value = ym;
      selectedMonth = ym;
    }
    function updateUrlMonth(){
      const p = new URLSearchParams(location.search);
      p.set('m', selectedMonth);
      history.replaceState(null, '', `${location.pathname}?${p.toString()}`);
    }

    async function loadInitialData() {
      const { data: categories, error: cError } =
        await supabase.from('categories').select('*').eq('created_by', user.id);
      if (cError) { console.error("Errore caricamento categorie:", cError); return; }
      allCategories = categories || [];

      if (allCategories.length > 0) {
        const categoryIds = allCategories.map(c => c.id);
        const { data: subcategories, error: sError } =
          await supabase.from('subcategories').select('*').in('category_id', categoryIds);
        if (sError) { console.error("Errore caricamento sottocategorie:", sError); return; }
        allSubcategories = subcategories || [];
      }
    }

    function updateCategoryDropdown() {
      const selectedKind = kindSelect.value;
      const filteredCategories = allCategories.filter(cat => cat.kind === selectedKind);
      categorySelect.innerHTML = '<option value="">Scegli categoria...</option>';
      filteredCategories.forEach(cat => {
        const option = new Option(`${cat.icon} ${cat.name}`, cat.id);
        categorySelect.add(option);
      });
      updateSubcategories();
    }

    function updateSubcategories(selectedSubcategoryId = null) {
      const selectedCategoryId = categorySelect.value;
      subcategorySelect.innerHTML = '<option value="">Nessuna</option>';
      subcategorySelect.disabled = true;
      if (!selectedCategoryId) return;

      const relevantSubcategories =
        allSubcategories.filter(sub => String(sub.category_id) === String(selectedCategoryId));

      if (relevantSubcategories.length > 0) {
        subcategorySelect.disabled = false;
        relevantSubcategories.forEach(sub => {
          const option = new Option(`${sub.icon} ${sub.name}`, sub.id);
          subcategorySelect.add(option);
        });
        if (selectedSubcategoryId) subcategorySelect.value = selectedSubcategoryId;
      }
    }

    async function loadTransactions() {
      const { start, end } = monthBounds(selectedMonth);
      const { data, error } = await supabase.from('transactions')
        .select(`*, categories(name, icon), subcategories(name, icon)`)
        .eq('created_by', user.id)
        .gte('occurred_at', start).lt('occurred_at', end)
        .order('occurred_at', { ascending: false });
      if (error) { console.error("Errore caricamento transazioni:", error); return; }

      allTransactions = data || [];
      transactionList.innerHTML = '';
      if (allTransactions.length === 0) {
        transactionList.innerHTML = `<div class="empty-state"><p>Nessuna transazione per il mese selezionato.</p></div>`;
        return;
      }

      allTransactions.forEach(tx => {
        const item = document.createElement('div');
        item.className = 'item';
        const cat = tx.categories;
        const sub = tx.subcategories;
        const icon = sub?.icon || cat?.icon || '💸';
        const categoryText = `${cat?.name || 'N/A'}${sub ? ` / ${sub.name}` : ''}`;
        const amountNum = safeToNumber(tx.amount);
        
        item.innerHTML = `
          <div class="item-icon">${icon}</div>
          <div class="item-details">
            <span class="note">${tx.note ?? ''}</span>
            <span class="category">${categoryText}</span>
          </div>
          <div class="item-amount ${tx.kind}">
            ${tx.kind === 'expense' ? '-' : ''}${amountNum.toFixed(2)} €
          </div>
          <div class="item-actions">
            <button class="action-btn edit-btn" data-id="${tx.id}" title="Modifica">Modifica</button>
            <button class="action-btn delete-btn delete" data-id="${tx.id}" title="Elimina">Elimina</button>
          </div>
        `;
        transactionList.appendChild(item);
      });
    }
    
    function handleEdit(id) {
      const tx = allTransactions.find(t => String(t.id) === String(id));
      if (!tx) return;
      formTitle.textContent = "Modifica Transazione";
      transactionIdInput.value = tx.id;
      document.getElementById('kind').value = tx.kind;
      document.getElementById('note').value = tx.note ?? '';
      document.getElementById('amount').value = safeToNumber(tx.amount);
      document.getElementById('occurred_at').value = (tx.occurred_at || '').split('T')[0] || '';
      updateCategoryDropdown();
      categorySelect.value = tx.category_id ?? '';
      updateSubcategories(tx.subcategory_id ?? null);
      window.scrollTo(0, 0);
    }

    async function handleDelete(id) {
      if (Plan && !(await Plan.assertCanWrite("delete-transaction"))) return;
      if (!confirm("Sei sicuro di voler eliminare questa transazione?")) return;
      const { error } = await supabase.from('transactions').delete().eq('id', id);
      if (error) { 
        console.error("Errore eliminazione:", error);
        alert("Impossibile eliminare la transazione."); 
      } else { 
        loadTransactions(); 
      }
    }
    
    async function handleFormSubmit(event) {
      event.preventDefault();
      if (Plan && !(await Plan.assertCanWrite("add-or-update-transaction"))) return;

      const formData = new FormData(transactionForm);
      const id = formData.get('transaction-id');
      const subcategory_id = formData.get('subcategory_id') || null;

      const payload = {
        kind: formData.get('kind'),
        note: formData.get('note'),
        amount: formData.get('amount'),
        occurred_at: formData.get('occurred_at'),
        category_id: formData.get('category_id'),
        subcategory_id,
        created_by: user.id
      };

      const { error } = id 
        ? await supabase.from('transactions').update(payload).eq('id', id)
        : await supabase.from('transactions').insert(payload);
      
      if (error) {
        console.error("Errore salvataggio:", error);
        alert("Si è verificato un errore. Riprova.");
      } else {
        transactionForm.reset();
        formTitle.textContent = "Nuova Transazione";
        transactionIdInput.value = "";
        document.getElementById('occurred_at').valueAsDate = new Date();
        updateCategoryDropdown();
        loadTransactions();
      }
    }

    async function initializePage() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { location.replace("/it/login.html"); return; }
      user = session.user;

      // Import del modulo piani + banner
      try {
        Plan = await import("/js/plan.js");
        await Plan.mountPlanBanner();
      } catch (e) {
        console.warn("plan.js non caricato:", e);
        Plan = null;
      }

      // Onboarding (invariato)
      const { data: profile, error: pErr } =
        await supabase.from('profiles').select('onboarded').eq('id', user.id).single();
      if (!pErr && profile && !profile.onboarded) {
        if (new URLSearchParams(window.location.search).get('edit') !== '1') {
          location.replace("/it/onboarding.html");
          return;
        }
      }

      // Mese di default (da URL ?m=YYYY-MM o mese corrente)
      setDefaultMonth();
      updateUrlMonth();

      document.getElementById('occurred_at').valueAsDate = new Date();
      await loadInitialData();
      updateCategoryDropdown();
      await loadTransactions();
      
      // Eventi UI
      kindSelect.addEventListener('change', updateCategoryDropdown);
      categorySelect.addEventListener('change', () => updateSubcategories());
      transactionForm.addEventListener('submit', handleFormSubmit);
      logoutBtn.addEventListener('click', async (e) => {
        e.preventDefault(); await supabase.auth.signOut(); location.replace("/it/");
      });
      transactionList.addEventListener('click', (event) => {
        const target = event.target.closest('.action-btn');
        if (!target) return;
        const id = target.dataset.id;
        if (target.classList.contains('edit-btn')) handleEdit(id);
        else if (target.classList.contains('delete-btn')) handleDelete(id);
      });
      monthInput.addEventListener('change', async () => {
        selectedMonth = monthInput.value;
        updateUrlMonth();
        await loadTransactions();
      });
    }

    document.addEventListener('DOMContentLoaded', initializePage);
  </script>
</body>
</html>
