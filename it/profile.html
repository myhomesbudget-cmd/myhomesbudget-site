<!DOCTYPE html>
<html lang="it" data-app="myhomesbudget">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Il Tuo Profilo ‚Äî MyHomesBudget</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" href="/homes.png" type="image/png" sizes="32x32" />

  <style>
    :root{
      --fg:#111;--bg:#f4f7fa;--glass:rgba(255,255,255,.6);
      --card-border:rgba(0,0,0,.08);--shadow:0 15px 35px rgba(0,0,0,.1);
      --radius-lg:16px;--radius-xl:28px;--primary-color:#6c5ce7;--danger-color:#d32f2f;--success-color:#2e7d32;--warning-color:#f39c12;
      --font-sans:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif;
      --grad:linear-gradient(135deg,#6c5ce7,#00cec9);
      --grad-danger:linear-gradient(135deg,#d32f2f,#ff7675);
      --panel-sheen:linear-gradient(180deg,rgba(255,255,255,.94),rgba(255,255,255,.76));
    }
    *{box-sizing:border-box}
    html{font-family:var(--font-sans);background-color:var(--bg)}
    body{margin:0;color:var(--fg);background:url("/bg.webp") no-repeat center/cover fixed;min-height:100vh;display:flex;flex-direction:column;overflow-x:hidden}
    body::before{content:"";position:fixed;inset:0;background:linear-gradient(135deg,rgba(108,92,231,.05),rgba(0,206,201,.05));z-index:-1}

    /* TOPBAR (invariata) */
    .topbar{position:fixed;top:0;left:0;right:0;height:60px;padding:0 16px;display:flex;align-items:center;justify-content:space-between;background:var(--glass);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-bottom:1px solid var(--card-border);z-index:100}
    .logo-link{display:flex;align-items:center;gap:8px;text-decoration:none}
    .logo-text{font-weight:600;color:#fff;font-size:1.1rem;text-shadow:0 1px 2px rgba(0,0,0,.35)}
    .top-center{position:absolute;left:50%;transform:translateX(-50%)}
    .top-actions{display:flex;gap:12px;align-items:center}
    .top-link,.top-btn{display:flex;align-items:center;justify-content:center;height:34px;color:#fff;text-decoration:none;padding:6px 12px;border-radius:10px;font-size:.9rem;font-weight:600;background:var(--grad);border:none;box-shadow:0 4px 12px rgba(0,0,0,.15);transition:transform .2s ease,filter .2s ease,box-shadow .2s ease;cursor:pointer;white-space:nowrap}
    .top-link:hover,.top-btn:hover{transform:translateY(-2px);filter:brightness(1.08);box-shadow:0 6px 16px rgba(0,0,0,.20)}
    .notification-bell{position:relative}
    #scheduler-btn,#notifications-btn{width:38px;padding:0}
    .notification-badge{position:absolute;top:-5px;right:-5px;background:var(--danger-color);color:#fff;border-radius:50%;width:20px;height:20px;font-size:12px;font-weight:bold;display:flex;align-items:center;justify-content:center;border:2px solid #fff;display:none}
    .notification-badge.is-visible{display:flex}
    .mobile-menu-toggle{display:none;background:var(--grad);border:none;border-radius:10px;width:40px;height:38px;cursor:pointer;padding:0;z-index:101;box-shadow:0 4px 12px rgba(0,0,0,.15)}
    .mobile-menu-toggle svg{width:24px;height:24px;stroke:#fff;stroke-width:2.5;stroke-linecap:round}
    @media (max-width:1200px){.top-center{display:none}}
    @media (max-width:960px){.mobile-menu-toggle{display:block}.top-actions{position:fixed;top:70px;right:16px;background:rgba(255,255,255,0.9);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-radius:var(--radius-lg);box-shadow:var(--shadow);padding:16px;flex-direction:column;gap:16px;align-items:stretch;width:220px;transform:translateY(-20px) scale(.95);opacity:0;pointer-events:none;transition:transform .2s ease-out,opacity .2s ease-out;z-index:100;border:1px solid var(--card-border)}.top-actions.is-open{transform:translateY(0) scale(1);opacity:1;pointer-events:auto}.top-actions .top-link,.top-actions .top-btn{width:100%;text-align:center}#scheduler-btn,#notifications-btn{width:100%}}

    /* MAIN */
    main.container{padding:16px;padding-top:72px;width:100%;max-width:1280px;margin:0 auto;flex-grow:1;display:flex;flex-direction:column}
    .dash-nav{display:flex;flex-wrap:wrap;gap:8px;border-bottom:1px solid rgba(0,0,0,.1);padding-bottom:12px;margin-bottom:24px}
    .dash-nav a{text-decoration:none;padding:8px 16px;border-radius:10px;font-weight:600;transition:all .2s ease;background:rgba(255,255,255,.7);color:var(--fg);border:1px solid var(--card-border);box-shadow:0 4px 12px rgba(0,0,0,.05)}
    .dash-nav a:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,.1)}
    .dash-nav a.is-active{background:var(--grad);color:#fff;box-shadow:0 6px 16px rgba(0,0,0,.20),inset 0 1px 2px rgba(255,255,255,0.2)}

    /* AVATAR NOT CLIPPED ‚Äî Nuovo layout del pannello */
    @keyframes fadeInUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}

    .dashboard-panel{
      position:relative;max-width:880px;width:100%;margin:40px auto 32px;
      padding:96px 24px 24px; /* spazio per avatar flottante */
      border-radius:var(--radius-xl);
      background:var(--panel-sheen);
      backdrop-filter:blur(16px) saturate(140%);-webkit-backdrop-filter:blur(16px) saturate(140%);
      border:1px solid rgba(255,255,255,.55);
      box-shadow:0 18px 45px rgba(0,0,0,.12),inset 0 1px 0 rgba(255,255,255,.65);
      overflow:visible; /* fondamentale: niente taglio avatar */
      animation:fadeInUp .45s ease-out both
    }
    /* cornice luminosa */
    .dashboard-panel::before{content:"";position:absolute;inset:-1.5px;border-radius:calc(var(--radius-xl) + 2px);padding:1.5px;background:linear-gradient(135deg,rgba(108,92,231,.35),rgba(0,206,201,.35));-webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none}
    /* alone aurora */
    .dashboard-panel::after{content:"";position:absolute;left:50%;top:0;width:1200px;height:220px;transform:translateX(-50%);background:radial-gradient(520px 120px at 50% 0%, rgba(108,92,231,.18), rgba(0,206,201,.10) 40%, transparent 70%);filter:blur(10px);pointer-events:none}

    /* Avatar flottante centrato, fuori dal raggio della card */
    .profile-avatar{position:absolute;top:0;left:50%;transform:translate(-50%, -50%);width:120px;height:120px;border-radius:50%;background:#fff;border:4px solid rgba(255,255,255,.95);box-shadow:0 16px 35px rgba(0,0,0,.18)}
    .profile-avatar img{width:100%;height:100%;border-radius:50%;object-fit:cover}
    .profile-avatar::after{content:"";position:absolute;inset:-8px;border-radius:50%;background:conic-gradient(from 0deg, rgba(108,92,231,.4), rgba(0,206,201,.4), rgba(108,92,231,.4));filter:blur(10px);opacity:.45}
    .profile-avatar .avatar-overlay{position:absolute;inset:0;background:rgba(0,0,0,.45);border-radius:50%;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .25s ease;cursor:pointer}
    .profile-avatar:hover .avatar-overlay{opacity:1}
    .profile-avatar .avatar-loader{width:32px;height:32px;border:4px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;display:none}
    .profile-avatar .avatar-overlay.is-loading{opacity:1}
    .profile-avatar .avatar-overlay.is-loading .avatar-loader{display:block}
    .profile-avatar .avatar-overlay.is-loading svg{display:none}
    .profile-avatar input{display:none}

    .profile-header{display:flex;flex-direction:column;align-items:center;text-align:center;margin-top:8px}
    .profile-name{font-size:2rem;font-weight:800;margin:12px 0 6px;text-shadow:0 1px 0 rgba(255,255,255,.6)}
    .profile-plan{font-size:.9rem;font-weight:800;color:var(--primary-color);background:rgba(255,255,255,.96);padding:6px 16px;border-radius:999px;border:1px solid rgba(0,0,0,.06);box-shadow:inset 0 1px 0 rgba(255,255,255,.85),0 6px 14px rgba(0,0,0,.06)}

    .profile-content{margin-top:18px;display:grid;gap:16px}
    .profile-section-title{text-align:center;font-weight:700;color:#586073;margin-bottom:8px;font-size:.9rem;text-transform:uppercase;letter-spacing:1px}

    .profile-info-row{display:flex;justify-content:space-between;align-items:center;background:linear-gradient(180deg,rgba(255,255,255,.92),rgba(255,255,255,.74));border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:12px 16px;transition:all .2s ease;box-shadow:0 6px 18px rgba(0,0,0,.05),inset 0 1px 0 rgba(255,255,255,.85)}
    .profile-info-row:hover{box-shadow:0 10px 26px rgba(0,0,0,.08),inset 0 1px 0 rgba(255,255,255,.95);transform:translateY(-1px)}
    .info-label{font-weight:700;color:#2a3047;display:flex;align-items:center;gap:8px;font-size:.95rem}
    .info-value{font-weight:700;font-size:1.05rem}

    .personal-info-grid{display:grid;grid-template-columns:1fr;gap:12px}
    .info-field{background:linear-gradient(180deg,rgba(255,255,255,.95),rgba(255,255,255,.78));border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:12px;transition:all .2s ease;box-shadow:0 6px 18px rgba(0,0,0,.05),inset 0 1px 0 rgba(255,255,255,.9)}
    .info-field:hover{box-shadow:0 10px 26px rgba(0,0,0,.08),inset 0 1px 0 rgba(255,255,255,1);transform:translateY(-1px)}
    .info-field label{font-size:.82rem;font-weight:800;color:#5a5f7a;margin-bottom:4px}
    .info-field .data-display{font-size:1.05rem;font-weight:700;color:#222;text-align:center;min-height:24px}
    .info-field .data-display.is-empty{color:#8a8fa6;font-style:italic}
    .info-field .data-input{display:none;width:100%;padding:10px 12px;border-radius:12px;border:1px solid #dcdfea;background:#fff;font-size:1rem;text-align:center}
    .is-editing .info-field .data-display{display:none}
    .is-editing .info-field .data-input{display:block}

    .profile-actions{display:flex;justify-content:center;gap:14px;margin-top:6px}
    .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 22px;font-weight:900;font-size:1rem;transition:transform .15s ease,filter .15s ease,box-shadow .15s ease}
    .btn:hover{transform:translateY(-1px);filter:brightness(1.03)}
    .btn-primary{background:var(--grad);color:#fff;box-shadow:0 14px 26px rgba(0,0,0,.18)}
    .btn-secondary{background:#f5f6f8;border:1px solid #e6e8ef;color:#2a3047;box-shadow:0 6px 14px rgba(0,0,0,.06)}
    #save-button{display:none}

    /* Toast & Modal (invariati) */
    .status-toast{position:fixed;top:80px;left:50%;transform:translateX(-50%);padding:12px 24px;border-radius:999px;color:#fff;font-weight:600;box-shadow:0 10px 25px rgba(0,0,0,.2);z-index:1001;opacity:0;visibility:hidden;transition:opacity .3s ease, top .3s ease, visibility .3s ease}
    .status-toast.show{top:90px;opacity:1;visibility:visible}
    .status-toast.success{background:var(--success-color)}
    .status-toast.error{background:var(--danger-color)}

    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;pointer-events:none;transition:opacity .3s ease}
    .modal-overlay.is-visible{opacity:1;pointer-events:auto}
    .modal-content{background:var(--bg);border-radius:var(--radius-lg);padding:24px;width:90%;max-width:700px;max-height:80vh;overflow-y:auto;box-shadow:var(--shadow);transform:scale(.95);transition:transform .3s ease}
    .modal-overlay.is-visible .modal-content{transform:scale(1)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--card-border);padding-bottom:12px;margin-bottom:16px}
    .modal-title{margin:0;font-size:1.2rem}
    .modal-close{background:none;border:none;font-size:2rem;cursor:pointer;color:#888;line-height:1;padding:0}
    .deadline-item{display:grid;grid-template-columns:1fr auto auto;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--card-border)}
    .deadline-item:last-child{border-bottom:none}
    .item-details{display:flex;flex-direction:column;min-width:0}
    .item-details .note{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .item-details .category{font-size:.9rem;color:#555;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .item-amount{text-align:right;white-space:nowrap;font-weight:900}
    .item-amount.expense{color:var(--danger-color)}
    .item-amount.income{color:var(--success-color)}
    .days-left{font-weight:900;color:var(--warning-color)}

    @media(min-width:640px){.personal-info-grid{grid-template-columns:1fr 1fr}}
    @media(min-width:768px){.topbar{padding:0 24px}main.container{padding:24px;padding-top:84px}}
  </style>
</head>
<body>
  <div id="status-toast" class="status-toast"></div>

  <nav class="topbar">
    <a href="/it/dashboard.html" class="logo-link">
      <img src="/homes.png" alt="Logo" style="height:32px;border-radius:6px" />
      <span class="logo-text">MyHomesBudget</span>
    </a>
    <div class="top-center">
      <a href="/it/pricing.html" id="subscription-status-btn" class="top-link" style="display:none;"></a>
    </div>
    <div class="top-nav-right">
      <button id="mobile-menu-btn" class="mobile-menu-toggle" aria-label="Apri menu">
        <svg viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <div class="top-actions">
        <a href="/it/onboarding.html?edit=1" class="top-link">üéØ Obiettivo</a>
        <button id="scheduler-btn" class="top-btn" aria-label="Apri scadenziario">üóìÔ∏è</button>
        <button id="notifications-btn" class="top-btn notification-bell" aria-label="Apri notifiche">
          <span>üîî</span>
          <span id="notification-badge" class="notification-badge"></span>
        </button>
        <a href="#" id="logout-btn" class="top-link">Esci</a>
      </div>
    </div>
  </nav>

  <main class="container">
    <nav id="dash-nav" class="dash-nav">
      <a href="/it/profile.html" class="is-active" aria-current="page">Profilo</a>
      <a href="/it/dashboard.html">Operazioni</a>
      <a href="/it/dashboard-riepilogo.html">Riepilogo</a>
    </nav>

    <div class="dashboard-panel">
      <!-- Avatar fluttuante: non verr√† mai tagliato -->
      <div id="avatar-container" class="profile-avatar"></div>
      <!-- Il resto del contenuto viene iniettato da JS sotto -->
      <div class="profile-header">
        <h1 id="user-name" class="profile-name">...</h1>
        <div id="plan-type" class="profile-plan">...</div>
      </div>
      <div class="profile-content" id="profile-dynamic"></div>
    </div>
  </main>

  <!-- Modal -->
  <div id="details-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title" class="modal-title"></h3>
        <button class="modal-close">&times;</button>
      </div>
      <div id="modal-body" class="modal-body"></div>
    </div>
  </div>

  <script type="module">
    import { supabase } from "/it/supabase-client.js";

    let currentUser = null;
    const emptyPlaceholder = 'Non impostato';
    const toast = document.getElementById('status-toast');
    const MAX_AVATAR_SIZE_MB = 2;
    const detailsModal = document.getElementById('details-modal');
    const notificationBadge = document.getElementById('notification-badge');
    const subscriptionStatusBtn = document.getElementById('subscription-status-btn');

    function showToast(message, type='success'){
      toast.textContent = message; toast.className = `status-toast ${type} show`; setTimeout(()=>toast.classList.remove('show'), 3000);
    }

    function buildSections(){
      document.getElementById('profile-dynamic').innerHTML = `
        <section>
          <div class="profile-info-row">
            <span class="info-label">üìß Mail di Registrazione</span>
            <span id="user-email" class="info-value">...</span>
          </div>
        </section>
        <section>
          <h2 class="profile-section-title">‚ú® Dettagli</h2>
          <div style="display:grid;gap:12px;">
            <div class="profile-info-row">
              <span class="info-label">üí≥ Abbonamento</span>
              <span id="plan-type-detail" class="info-value">...</span>
            </div>
            <div class="profile-info-row">
              <span class="info-label">üéØ Obiettivo Configurato</span>
              <span id="goal-name" class="info-value">...</span>
            </div>
          </div>
        </section>
        <section>
          <h2 class="profile-section-title">üë§ Informazioni Personali</h2>
          <div id="personal-info-form" class="personal-info-grid">
            <div class="info-field">
              <label>üßë Genere</label>
              <div class="data-display"></div>
              <select class="data-input" id="gender-input">
                <option value="">Non specificato</option>
                <option value="Uomo">Uomo</option>
                <option value="Donna">Donna</option>
                <option value="Altro">Altro</option>
              </select>
            </div>
            <div class="info-field">
              <label>üéÇ Data di Nascita</label>
              <div class="data-display"></div>
              <input type="date" class="data-input" id="birthdate-input" />
            </div>
            <div class="info-field">
              <label>üåç Paese</label>
              <div class="data-display"></div>
              <input type="text" class="data-input" id="country-input" placeholder="Es. Italia" />
            </div>
            <div class="info-field">
              <label>üì± Numero di Telefono</label>
              <div class="data-display"></div>
              <input type="tel" class="data-input" id="phone-input" placeholder="Es. +39 123..." />
            </div>
          </div>
        </section>
        <div class="profile-actions">
          <button id="edit-button" class="btn btn-secondary">Modifica</button>
          <button id="save-button" class="btn btn-primary">Salva Modifiche</button>
        </div>`;
    }

    function renderProfileData(profile, details){
      // avatar (clic per scegliere immagine)
      const avatarEl = document.getElementById('avatar-container');
      avatarEl.innerHTML = `
        <img id="profile-pic" alt="Immagine del profilo" src="${profile?.avatar_url || `https://placehold.co/128x128/6c5ce7/FFFFFF?text=${(profile?.name||'U').charAt(0)}`}">
        <label for="avatar-upload" class="avatar-overlay">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>
          <div class="avatar-loader"></div>
        </label>
        <input type="file" id="avatar-upload" accept="image/*">`;
      document.getElementById('avatar-upload').addEventListener('change', uploadAvatar);

      // text fields
      document.getElementById('user-name').textContent = profile?.name || 'Utente';
      document.getElementById('plan-type').textContent = profile?.plan_type || 'STANDARD';
      document.getElementById('user-email').textContent = currentUser?.email || '...';
      document.getElementById('plan-type-detail').textContent = profile?.plan_type || 'STANDARD';
      document.getElementById('goal-name').textContent = profile?.goal_name || 'Nessun obiettivo';

      // personal details
      const d = details || {};
      const form = document.getElementById('personal-info-form');
      const genderDisplay = form.querySelector('.info-field:nth-child(1) .data-display');
      genderDisplay.textContent = d.gender || emptyPlaceholder; genderDisplay.classList.toggle('is-empty', !d.gender);
      document.getElementById('gender-input').value = d.gender || '';

      const birthDisplay = form.querySelector('.info-field:nth-child(2) .data-display');
      birthDisplay.textContent = d.birthdate ? new Date(d.birthdate).toLocaleDateString('it-IT') : emptyPlaceholder; birthDisplay.classList.toggle('is-empty', !d.birthdate);
      document.getElementById('birthdate-input').value = d.birthdate || '';

      const countryDisplay = form.querySelector('.info-field:nth-child(3) .data-display');
      countryDisplay.textContent = d.country || emptyPlaceholder; countryDisplay.classList.toggle('is-empty', !d.country);
      document.getElementById('country-input').value = d.country || '';

      const phoneDisplay = form.querySelector('.info-field:nth-child(4) .data-display');
      phoneDisplay.textContent = d.phone || emptyPlaceholder; phoneDisplay.classList.toggle('is-empty', !d.phone);
      document.getElementById('phone-input').value = d.phone || '';
    }

    async function uploadAvatar(event){
      const input = event.target; if (!currentUser || !input.files?.length) return;
      const file = input.files[0];
      if (file.size > MAX_AVATAR_SIZE_MB * 1024 * 1024){ showToast(`Il file √® troppo grande. Limite: ${MAX_AVATAR_SIZE_MB}MB.`, 'error'); input.value=''; return; }
      const fileExt = file.name.split('.').pop(); const filePath = `${currentUser.id}.${fileExt}`;
      const overlay = document.querySelector('.avatar-overlay'); overlay.classList.add('is-loading');
      try {
        const { error: uploadError } = await supabase.storage.from('avatars').upload(filePath, file, { upsert: true });
        if (uploadError) throw uploadError;
        const { data: urlData } = supabase.storage.from('avatars').getPublicUrl(filePath, { transform: { ts: Date.now() } });
        if (!urlData?.publicUrl) throw new Error('URL non trovato');
        const publicUrl = urlData.publicUrl;
        const { error: dbError } = await supabase.from('profiles').update({ avatar_url: publicUrl }).eq('id', currentUser.id);
        if (dbError) throw dbError;
        document.getElementById('profile-pic').src = publicUrl; showToast('Immagine del profilo aggiornata!', 'success');
      } catch (e){ console.error(e); showToast('Errore nell\'aggiornamento dell\'immagine.', 'error'); }
      finally { overlay.classList.remove('is-loading'); input.value=''; }
    }

    async function saveUserData(){
      if (!currentUser) return;
      const saveButton = document.getElementById('save-button'); saveButton.disabled = true; saveButton.textContent = 'Salvataggio...';
      const dataToSave = { id: currentUser.id, gender: document.getElementById('gender-input').value || null, birthdate: document.getElementById('birthdate-input').value || null, country: document.getElementById('country-input').value || null, phone: document.getElementById('phone-input').value || null };
      const { data, error } = await supabase.from('personal_details').upsert(dataToSave).select().single();
      saveButton.disabled = false; saveButton.textContent = 'Salva Modifiche';
      if (error){ console.error('Errore durante il salvataggio:', error); showToast('Errore durante il salvataggio.', 'error'); return; }
      showToast('Profilo aggiornato con successo!', 'success');
      const { data: currentProfile } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
      renderProfileData(currentProfile, data); toggleEditMode(false);
    }

    function toggleEditMode(isEditing){
      document.getElementById('personal-info-form').classList.toggle('is-editing', isEditing);
      document.getElementById('edit-button').style.display = isEditing ? 'none' : 'block';
      document.getElementById('save-button').style.display = isEditing ? 'block' : 'none';
    }

    function renderSubscriptionStatus(profile){
      if (!profile?.plan_type){ subscriptionStatusBtn.style.display='none'; return; }
      let text='', link='#';
      switch(profile.plan_type){
        case 'starter': case 'trial':
          if (profile.trial_end){
            const endDate=new Date(profile.trial_end); const today=new Date(); today.setHours(0,0,0,0);
            const diffDays=Math.ceil((endDate - today)/(1000*60*60*24));
            if (diffDays >= 0){
              if (diffDays > 10) text = `‚ú® Sblocca tutto! ${diffDays} giorni rimasti`;
              else if (diffDays > 3) text = `‚è∞ L'offerta scade! ${diffDays} giorni rimasti`;
              else text = diffDays>1 ? `üî• Affrettati! Solo ${diffDays} giorni` : `üî• Ultimo giorno! Aggiorna ora`;
              link='/it/pricing.html';
            } else { text='üò≠ Prova Scaduta. Aggiorna ora!'; link='/it/pricing.html'; }
          }
          break;
        case 'plus': text='MyHomesBudget PLUS'; link='/it/account.html'; break;
        case 'pro': text='MyHomesBudget PRO'; link='/it/account.html'; break;
      }
      if (text){ subscriptionStatusBtn.textContent=text; subscriptionStatusBtn.href=link; subscriptionStatusBtn.style.display='flex'; }
      else { subscriptionStatusBtn.style.display='none'; }
    }

    function positionSubscriptionButton(){
      const topCenter=document.querySelector('.top-center'); const topActions=document.querySelector('.top-actions');
      if (window.innerWidth <= 1200){ if (subscriptionStatusBtn.parentElement !== topActions) topActions.prepend(subscriptionStatusBtn); }
      else { if (subscriptionStatusBtn.parentElement !== topCenter) topCenter.appendChild(subscriptionStatusBtn); }
    }

    const safeToNumber = v => { const n=parseFloat(v); return Number.isFinite(n)?n:0; };

    async function getScheduledTransactions(startDate,endDate){
      const { data, error } = await supabase.from('transactions').select(`*, categories(name, icon)`).eq('created_by', currentUser.id).eq('is_paid', false).gte('due_date', startDate.toISOString().split('T')[0]).lte('due_date', endDate.toISOString().split('T')[0]).order('due_date',{ascending:true});
      if (error){ console.error("Errore scadenze:", error); return []; } return data;
    }

    function renderDeadlinesList(container, transactions){
      if (!transactions.length){ container.innerHTML='<div style="padding:32px 12px;text-align:center;color:#5a5f7a">Nessuna scadenza in questo periodo.</div>'; return; }
      const today=new Date(); today.setHours(0,0,0,0);
      container.innerHTML = transactions.map(tx=>{
        const due=new Date(tx.due_date); const diff=Math.ceil((due-today)/(1000*60*60*24));
        const days = diff<0?'Scaduta':(diff===0?'Oggi':`${diff} giorni`);
        const cls = tx.kind==='income'?'income':'expense'; const sign = tx.kind==='income'?'+':'-';
        return `<div class="deadline-item"><div class="item-details"><span class="note">${tx.note}</span><span class="category">${tx.categories?.name||''}</span></div><span class="item-amount ${cls}">${sign}${safeToNumber(tx.amount).toFixed(2)}‚Ç¨</span><span class="days-left">${days}</span></div>`;
      }).join('');
    }

    async function updateNotifications(){
      const today=new Date(); const futureDate=new Date(); futureDate.setDate(today.getDate()+7);
      const upcoming = await getScheduledTransactions(today, futureDate);
      if (upcoming.length){ notificationBadge.textContent = upcoming.length; notificationBadge.classList.add('is-visible'); }
      else { notificationBadge.classList.remove('is-visible'); }
    }

    async function initializePage(){
      const { data:{ session }, error:sessionError } = await supabase.auth.getSession();
      if (sessionError || !session){ window.location.href='/it/login.html'; return; }
      currentUser = session.user;

      const [profileResponse, detailsResponse] = await Promise.all([
        supabase.from('profiles').select('*').eq('id', currentUser.id).single(),
        supabase.from('personal_details').select('*').eq('id', currentUser.id).single()
      ]);
      if (profileResponse.error && profileResponse.error.code!=='PGRST116'){ console.error('Errore profilo:', profileResponse.error); showToast('Impossibile caricare il profilo.','error'); return; }
      if (detailsResponse.error && detailsResponse.error.code!=='PGRST116'){ console.error('Errore dettagli:', detailsResponse.error); }

      buildSections();
      renderProfileData(profileResponse.data, detailsResponse.data);
      renderSubscriptionStatus(profileResponse.data);
      positionSubscriptionButton();
      updateNotifications();

      document.getElementById('edit-button').addEventListener('click', ()=>toggleEditMode(true));
      document.getElementById('save-button').addEventListener('click', saveUserData);
      document.getElementById('logout-btn').addEventListener('click', async (e)=>{ e.preventDefault(); await supabase.auth.signOut(); window.location.href = '/it/'; });

      document.getElementById('scheduler-btn').addEventListener('click', async ()=>{
        const today=new Date(); const future=new Date(); future.setDate(today.getDate()+30);
        const scheduled = await getScheduledTransactions(today, future);
        detailsModal.querySelector('.modal-title').textContent = 'Scadenziario (Prossimi 30 giorni)';
        renderDeadlinesList(detailsModal.querySelector('#modal-body'), scheduled);
        detailsModal.classList.add('is-visible');
      });
      document.getElementById('notifications-btn').addEventListener('click', async ()=>{
        const today=new Date(); const future=new Date(); future.setDate(today.getDate()+7);
        const upcoming = await getScheduledTransactions(today, future);
        detailsModal.querySelector('.modal-title').textContent = 'Notifiche (Prossimi 7 giorni)';
        renderDeadlinesList(detailsModal.querySelector('#modal-body'), upcoming);
        detailsModal.classList.add('is-visible');
      });
      detailsModal.addEventListener('click',(e)=>{ if (e.target.classList.contains('modal-overlay') || e.target.closest('.modal-close')) detailsModal.classList.remove('is-visible'); });

      const mobileMenuBtn=document.getElementById('mobile-menu-btn');
      const topActions=document.querySelector('.top-actions');
      if (mobileMenuBtn && topActions){
        mobileMenuBtn.addEventListener('click', (e)=>{ e.stopPropagation(); topActions.classList.toggle('is-open'); });
        document.addEventListener('click', (e)=>{ if (!topActions.contains(e.target) && !mobileMenuBtn.contains(e.target)) topActions.classList.remove('is-open'); });
      }
      window.addEventListener('resize', positionSubscriptionButton);
    }

    document.addEventListener('DOMContentLoaded', initializePage);
  </script>
</body>
</html>
