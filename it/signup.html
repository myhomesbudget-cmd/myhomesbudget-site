<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inizia la prova gratuita — MyHomesBudget</title>
  <meta name="description" content="30 giorni gratis. Nessuna carta richiesta. Cancella quando vuoi.">

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy"
  content="default-src 'self';
           img-src 'self' https: data:;
           style-src 'self' 'unsafe-inline';
           script-src 'self' 'unsafe-inline' https://esm.sh;
           connect-src 'self' https://*.supabase.co https://*.supabase.in wss://*.supabase.co wss://*.supabase.in;
           font-src 'self' https: data:;
           frame-ancestors 'none';
           base-uri 'self';
           form-action 'self'">

  <link rel="preload" href="/bg.webp" as="image" imagesrcset="/bg.webp" />

  <style>
    :root{ font-family:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif; }
    *{ box-sizing:border-box; }            /* evita sporgenze */

    /* ===== background (uguale alla Home) ===== */
    body{
      margin:0; color:#fff;
      background:url("/bg.webp") no-repeat center center fixed;
      background-size:cover;
    }
    body::before{
      content:""; position:fixed; inset:0;
      background:rgba(0,0,0,.05);       /* overlay leggero come Home */
      z-index:-1;
    }

    /* ===== layout (uguale alla Home) ===== */
    .page{ max-width:960px; margin:0 auto; padding:24px; }

    .bar{
      display:flex; align-items:center; justify-content:space-between;
      gap:16px; margin-bottom:8px;
    }
    .brand{
      display:flex; gap:10px; align-items:center; text-decoration:none; color:#fff;
    }
    .brand img{ height:26px; border-radius:6px; }
    .brand span{ font-weight:700; letter-spacing:.2px; }

    .top-link a{
      color:#fff; text-decoration:none; opacity:.9;
      padding:6px 10px; border-radius:8px;
    }
    .top-link a:hover{ background:rgba(255,255,255,.12); }

    h1{
      margin:6px 0 6px; font-size:clamp(1.9rem, 3.8vw, 2.6rem); font-weight:800;
      text-shadow:0 1px 3px rgba(0,0,0,.4);     /* come Home */
    }
    .subtitle{
      margin:0 0 16px; color:#e9eef6; opacity:.95;
      text-shadow:0 1px 3px rgba(0,0,0,.4);
    }

    /* ===== pannello form (stesso “vetro” della Home) ===== */
    .card{
      background:rgba(255,255,255,.50);
      backdrop-filter:saturate(1.1) blur(5px);
      -webkit-backdrop-filter:saturate(1.1) blur(2px);
      color:#111;
      padding:18px 18px 20px; border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.08);
    }

    /* Griglia campi: 2 colonne su desktop, 1 su mobile */
    .grid{
      display:grid; gap:12px;
      grid-template-columns:1fr;
    }
    @media(min-width:820px){
      .grid{ grid-template-columns:1fr 1fr; }
    }
    .full{ grid-column:1 / -1; }

    label{ display:block; margin:10px 0 6px; font-weight:700; color:#111; }
    .helper{ margin-top:6px; color:#666; font-size:.95rem; }

    input[type="text"], input[type="email"], input[type="password"]{
      width:100%;
      padding:12px 14px; border-radius:10px;
      border:1px solid #ddd;
      background:#fff; color:#111; font-size:1rem;
      outline:none;
    }
    input:focus{ box-shadow:0 0 0 3px rgba(0,0,0,.06); }

    hr.sep{
      border:0; height:1px; margin:16px 0;
      background:linear-gradient(90deg, transparent, rgba(0,0,0,.12), transparent);
    }

    /* ===== piani (coerenti con card Home) ===== */
    .plans{ display:grid; gap:12px; padding:0; border:0; }
    .plan{ display:flex; align-items:flex-start; gap:10px; }
    .plan input{ margin-top:4px; }
    .plan .box{
      flex:1; padding:12px; border-radius:12px;
      border:1px solid rgba(0,0,0,.08);
      background:rgba(255,255,255,.50);
      backdrop-filter:saturate(1.1) blur(5px);
      -webkit-backdrop-filter:saturate(1.1) blur(2px);
      color:#111;
      transition:.18s ease;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
    }
    .plan strong{ display:block; margin-bottom:2px; }
    .plan input:checked + .box{
      border-color: rgba(0,0,0,.2);
      box-shadow:0 14px 32px rgba(0,0,0,.12);
      background:rgba(255,255,255,.62);
    }

    /* ===== azioni / messaggi ===== */
    .actions{ display:flex; justify-content:flex-end; margin-top:12px; }
    .btn{
      cursor:pointer; background:#111; color:#fff; font-weight:700;
      padding:12px 16px; border:none; border-radius:12px;
      transition:transform .12s ease, filter .12s ease, box-shadow .12s ease;
      box-shadow:0 10px 24px rgba(0,0,0,.15);
    }
    .btn:hover{ filter:brightness(1.08); transform:translateY(-1px); box-shadow:0 14px 28px rgba(0,0,0,.2); }

    .msg{
      margin-top:12px; font-size:.95rem; font-weight:600;
      padding:10px 12px; border-radius:8px;
    }
    .msg.ok  { color:#0f5132; background:#d1e7dd; border:1px solid #badbcc; }
    .msg.err { color:#842029; background:#f8d7da; border:1px solid #f5c2c7; }

    .footer{ margin:16px 0 2px; color:#e6e6e6; }
    .footer a{ color:#fff; }
  </style>
</head>
<body>
  <div class="page">
    <!-- barra -->
    <div class="bar">
      <a class="brand" href="/it/">
        <img src="/homes.png" alt="MyHomesBudget">
        <span>MyHomesBudget</span>
      </a>
      <div class="top-link">Hai già un account? <a href="/it/login.html">Accedi</a></div>
    </div>

    <h1>Inizia la prova gratuita</h1>
    <p class="subtitle">30 giorni gratis · Nessuna carta richiesta · Cancella quando vuoi</p>

    <form id="signup-form" class="card" autocomplete="on" novalidate>
      <div class="grid">
        <div class="col">
          <label for="name">Nome</label>
          <input id="name" type="text" placeholder="Es. Marco" required>
          <div class="helper">Lo useremo per darti un benvenuto personalizzato.</div>
        </div>

        <div class="col">
          <label for="email">Email</label>
          <input id="email" type="email" placeholder="nome@dominio.it" required>
        </div>

        <div class="full">
          <label for="password">Password</label>
          <input id="password" type="password"
                 placeholder="Min. 8 caratteri, almeno una lettera e un numero"
                 minlength="8" required>
          <div class="helper">Minimo 8 caratteri, almeno una lettera e un numero.</div>
        </div>
      </div>

      <hr class="sep">

      <fieldset class="plans">
        <legend class="sr-only" style="position:absolute;left:-9999px">Scegli il tuo piano</legend>

        <label class="plan">
          <input type="radio" name="plan" value="trial" checked />
          <div class="box">
            <strong>Prova Gratuita — 30 giorni</strong>
            Nessuna carta richiesta. Potrai scegliere un piano dopo la prova.
          </div>
        </label>

        <label class="plan">
          <input type="radio" name="plan" value="monthly" />
          <div class="box">
            <strong>Mensile — 2,99€ / mese</strong>
            Accesso completo. Disdici quando vuoi.
          </div>
        </label>

        <label class="plan">
          <input type="radio" name="plan" value="lifetime" />
          <div class="box">
            <strong>Una tantum — 19,99€ per sempre</strong>
            Paghi una sola volta. Aggiornamenti inclusi.
          </div>
        </label>
      </fieldset>

      <div class="actions">
        <button type="submit" class="btn">Crea account</button>
      </div>

      <div id="form-msg" class="msg" role="status" aria-live="polite"></div>
    </form>

    <div class="footer">
      © MyHomesBudget — <a href="/it/privacy.html">Privacy</a> · <a href="/it/terms.html">Termini</a>
    </div>
  </div>

  <!-- JS: identico (signUp + messaggi) con minime aggiunte funzionali -->
  <script type="module">
    import { supabase } from '/it/supabase-client.js';

    const form = document.getElementById('signup-form');
    const msg  = document.getElementById('form-msg');

    // (Facoltativo) allinea la lingua al resto dell'app
    try { localStorage.setItem('mhb_lang','it'); } catch(e){}

    // Helper: prefisso lingua coerente /it/ o /ita/
    const itPrefix = () => {
      const m = location.pathname.match(/^\/(it|ita)(\/|$)/i);
      return m ? ("/" + m[1].toLowerCase() + "/") : "/it/";
    };

    // Redirect post-auth: onboarding se non completata, altrimenti dashboard
    function postAuthRedirect(){
      try {
        if (localStorage.getItem('onboarding_completed') === '1') {
          location.replace(itPrefix() + 'dashboard.html');
        } else {
          location.replace(itPrefix() + 'onboarding.html');
        }
      } catch(e){
        location.replace(itPrefix() + 'onboarding.html');
      }
    }

    // Se già autenticato, porta subito a onboarding/dashboard
    (async () => {
      const { data:{ session } } = await supabase.auth.getSession();
      if (session?.user) postAuthRedirect();
    })();

    // Pre-seleziona piano da querystring ?plan=monthly|lifetime|trial
    (function presetPlanFromQuery(){
      const plan = new URLSearchParams(location.search).get('plan');
      if (!plan) return;
      const radio = form.querySelector(`input[name="plan"][value="${plan}"]`);
      if (radio) radio.checked = true;
    })();

    function show(type, text){
      msg.className = 'msg ' + (type === 'error' ? 'err' : 'ok');
      msg.textContent = text;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const name     = document.getElementById('name').value.trim();
      const email    = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      const plan     = form.plan.value;

      // validazione rapida lato client
      const okLen  = password.length >= 8;
      const okChar = /[A-Za-z]/.test(password);
      const okNum  = /[0-9]/.test(password);
      if(!(okLen && okChar && okNum)){
        show('error','La password deve avere almeno 8 caratteri, una lettera e un numero.');
        return;
      }

      show('ok','Creazione account in corso...');

      // Imposta redirect della mail verso index con ?verified=1
      const emailRedirectTo = `${window.location.origin}${itPrefix()}index.html?verified=1`;

      const { data, error } = await supabase.auth.signUp({
        email, password,
        options: {
          data: { name, plan },
          emailRedirectTo
        }
      });

      if (error) {
        show('error', error.message);
        return;
      }

      // Se la policy NON richiede conferma email e la sessione esiste, vai subito
      if (data?.session?.access_token) {
        postAuthRedirect();
        return;
      }

      show('ok','Ti abbiamo inviato una mail di conferma. Controlla la tua casella di posta.');
      form.reset();
    });
  </script>
</body>
</html>
