<!doctype html>
<html lang="it" data-app="myhomesbudget">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard — MyHomesBudget</title>
  <meta name="description" content="Gestisci le tue finanze, traccia le spese e raggiungi i tuoi obiettivi.">
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" href="/favicon.ico">
  <style>
    /* CSS Invariato */
    :root{--fg:#111;--glass:rgba(255,255,255,.58);--card-border:rgba(0,0,0,.08);--shadow:0 10px 30px rgba(0,0,0,.10);--radius-lg:16px;--primary-color:#6c5ce7;}
    *{box-sizing:border-box}
    html,body{font-family:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif}
    a:focus-visible,button:focus-visible,input:focus-visible,select:focus-visible{outline:2px solid #00cec9; outline-offset:2px; border-radius:8px}
    body{margin:0;color:#fff;background:url("/bg.webp") no-repeat center/cover fixed;min-height:100vh;display:flex;flex-direction:column;align-items:center;}
    body::before{content:"";position:fixed;inset:0;background:rgba(0,0,0,.08);z-index:-1}
    .topbar{position:fixed;top:16px;left:50%;transform:translateX(-50%);width:min(920px,calc(100% - 40px));z-index:20;pointer-events:none;display:flex;align-items:center;justify-content:space-between;}
    .logo-link,.top-actions{pointer-events:auto}
    .logo-link{display:flex;align-items:center;gap:8px;text-decoration:none}
    .logo-image{height:32px;border-radius:6px}
    .logo-text{font-weight:600;color:#fff;font-size:1.05rem;text-shadow:0 1px 2px rgba(0,0,0,.35)}
    .top-actions{display:flex;gap:8px;align-items:center}
    .top-link{color:#fff;text-decoration:none;padding:6px 10px;border-radius:10px;background:rgba(0,0,0,.28); border:1px solid rgba(255,255,255,.25);font-size: 0.9rem; font-weight: 600;}.top-link:hover{background:rgba(0,0,0,.38)}
    main.panel{margin-top:84px;width:min(920px,calc(100% - 40px));background:var(--glass); color:var(--fg); border-radius:var(--radius-lg);padding:clamp(18px,4vw,22px); box-shadow:var(--shadow);display:flex;flex-direction:column;gap:20px;}
    h1, h2, h3 { color: #111; }
    .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;font-weight:800;transition: all .2s ease;}.btn-primary{background:var(--primary-color);color:#fff;box-shadow:0 8px 22px rgba(0,0,0,.14)}.btn[disabled]{opacity:.6;cursor:not-allowed}
    .dash-nav {display: flex;gap: 8px;border-bottom: 1px solid rgba(0,0,0,0.1);padding-bottom: 12px;}.dash-nav a {text-decoration: none;color: #333;padding: 8px 16px;border-radius: 10px;font-weight: 600;}.dash-nav a.is-active {background-color: #fff;color: var(--primary-color);box-shadow: 0 4px 12px rgba(0,0,0,0.08);}
    .content-section {background: rgba(255,255,255,.55);border-radius:12px;padding:16px;border:1px solid var(--card-border);}
    .transaction-form {display: grid;grid-template-columns: 1fr 1fr;gap: 12px;align-items: flex-end;}@media (min-width: 820px) {.transaction-form {grid-template-columns: repeat(3, 1fr) auto;}}
    .form-group { display: flex; flex-direction: column; }.form-group.full-width { grid-column: 1 / -1; }.form-group label { font-weight: 600; font-size: 0.9rem; margin-bottom: 6px; }.form-group input, .form-group select {width: 100%;padding: 10px;border-radius: 8px;border: 1px solid #ccc;background: #fff;font-size: 1rem;}
    .transaction-list .item {display: grid; grid-template-columns: auto 1fr auto auto; gap: 12px; align-items: center; padding: 12px 4px; border-bottom: 1px solid rgba(0,0,0,0.05); }
    .item-icon { font-size: 1.5rem; flex-shrink: 0; }
    .item-details { display: flex; flex-direction: column; min-width: 0; }
    .item-details .note { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .item-details .category { font-size: 0.9rem; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .item-amount { text-align: right; white-space: nowrap; flex-shrink: 0; }
    .item-amount.expense { color: #d32f2f; font-weight: 700; }
    .item-amount.income { color: #2e7d32; font-weight: 700; }
    .item-actions { display: flex; gap: 4px; flex-shrink: 0; }
    .action-btn { background-color: rgba(0,0,0,0.05); color: #555; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; padding: 6px 10px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s ease, color 0.2s ease; white-space: nowrap; }
    .action-btn:hover { background-color: var(--primary-color); color: #fff; border-color: var(--primary-color); }
    .action-btn.delete { background-color: #f8d7da; color: #842029; border-color: #f5c2c7; }
    .action-btn.delete:hover { background-color: #dc3545; color: #fff; border-color: #dc3545; }
    .empty-state { text-align: center; padding: 40px; color: #555; }
  </style>
</head>
<body>
  <nav class="topbar">
    <a href="/it/" class="logo-link"><img src="/homes.png" alt="Logo" class="logo-image"><span class="logo-text">MyHomesBudget</span></a>
    <div class="top-actions">
      <a href="/it/onboarding.html?edit=1" class="top-link">Impostazioni</a>
      <a href="#" id="logout-btn" class="top-link">Esci</a>
    </div>
  </nav>

  <main class="panel">
    <nav id="dash-nav" class="dash-nav">
      <a href="/it/dashboard.html" class="is-active" aria-current="page">Operazioni</a>
      <a href="/it/dashboard-riepilogo.html">Riepilogo</a>
    </nav>
    <section class="content-section">
      <h2 id="form-title">Nuova Transazione</h2>
      <form id="transaction-form" class="transaction-form">
        <input type="hidden" id="transaction-id" name="transaction-id">
        <div class="form-group full-width">
          <label for="kind">Tipo</label>
          <select id="kind" name="kind" required>
            <option value="expense">Uscita</option>
            <option value="income">Entrata</option>
            <option value="transfer">Trasferimento</option>
          </select>
        </div>
        <div class="form-group full-width"><label for="note">Nota</label><input type="text" id="note" name="note" placeholder="Es. Caffè al bar" required></div>
        <div class="form-group"><label for="amount">Importo (€)</label><input type="number" id="amount" name="amount" step="0.01" placeholder="0.00" required></div>
        <div class="form-group"><label for="occurred_at">Data</label><input type="date" id="occurred_at" name="occurred_at" required></div>
        <div class="form-group"><label for="category_id">Categoria</label><select id="category_id" name="category_id" required><option value="">Scegli...</option></select></div>
        <div class="form-group"><label for="subcategory_id">Sottocategoria</label><select id="subcategory_id" name="subcategory_id"><option value="">Scegli...</option></select></div>
        <button type="submit" class="btn btn-primary" style="grid-column: 1 / -1; margin-top: 10px;">Aggiungi</button>
      </form>
    </section>
    <section class="content-section">
      <h2>Movimenti Recenti</h2>
      <div id="transaction-list" class="transaction-list"><div class="empty-state"><p>Nessuna transazione registrata.</p></div></div>
    </section>
  </main>
  
  <script type="module">
    import { supabase } from "/it/supabase-client.js";

    // --- SELETTORI DOM & STATO ---
    const transactionForm = document.getElementById('transaction-form');
    const kindSelect = document.getElementById('kind'); // Selettore per il tipo
    const categorySelect = document.getElementById('category_id');
    const subcategorySelect = document.getElementById('subcategory_id');
    // ... (altri selettori come prima)
    const transactionIdInput = document.getElementById('transaction-id');
    const formTitle = document.getElementById('form-title');
    const transactionList = document.getElementById('transaction-list');
    const logoutBtn = document.getElementById('logout-btn');
    let user = null;
    let allCategories = [];
    let allSubcategories = [];
    let allTransactions = [];

    // --- FUNZIONI ---
    async function loadInitialData() {
      // Carica TUTTE le categorie e sottocategorie dell'utente una sola volta
      const { data: categories, error: cError } = await supabase.from('categories').select('*').eq('created_by', user.id);
      if (cError) { console.error("Errore caricamento categorie:", cError); return; }
      allCategories = categories;

      if (allCategories.length > 0) {
        const categoryIds = allCategories.map(c => c.id);
        const { data: subcategories, error: sError } = await supabase.from('subcategories').select('*').in('category_id', categoryIds);
        if (sError) { console.error("Errore caricamento sottocategorie:", sError); return; }
        allSubcategories = subcategories;
      }
    }

    /**
     * NUOVA FUNZIONE: Popola il menu delle categorie filtrando per tipo (kind)
     */
    function updateCategoryDropdown() {
      const selectedKind = kindSelect.value;
      
      // Filtra le categorie globali in base al tipo selezionato
      const filteredCategories = allCategories.filter(cat => cat.kind === selectedKind);

      categorySelect.innerHTML = '<option value="">Scegli categoria...</option>';
      filteredCategories.forEach(cat => {
        const option = new Option(`${cat.icon} ${cat.name}`, cat.id);
        categorySelect.add(option);
      });

      // Aggiorna anche le sottocategorie, che ora saranno vuote
      updateSubcategories();
    }

    // `updateSubcategories` e `loadTransactions` rimangono quasi identiche
    function updateSubcategories(selectedSubcategoryId = null) {
      // ... (logica invariata)
    }
    async function loadTransactions() {
      // ... (logica invariata)
    }
    
    // Le funzioni per Modifica ed Elimina rimangono identiche
    function handleEdit(id) { /* ... */ }
    async function handleDelete(id) { /* ... */ }
    
    // La funzione di submit rimane identica
    async function handleFormSubmit(event) { /* ... */ }

    // --- INIZIALIZZAZIONE ---
    async function initializePage() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { location.replace("/it/login.html"); return; }
      user = session.user;
      
      // ... (Controllo onboarding come prima)
      
      document.getElementById('occurred_at').valueAsDate = new Date();
      
      // Carica TUTTI i dati iniziali
      await loadInitialData();
      
      // Popola i menu a tendina per la prima volta
      updateCategoryDropdown();
      updateSubcategories();

      // Carica le transazioni
      await loadTransactions();
      
      // --- EVENT LISTENERS ---
      
      // ASCOLTATORE CHIAVE: Quando cambio il TIPO, aggiorno le categorie
      kindSelect.addEventListener('change', updateCategoryDropdown);
      
      // Gli altri listener rimangono invariati
      categorySelect.addEventListener('change', () => updateSubcategories());
      transactionForm.addEventListener('submit', handleFormSubmit);
      logoutBtn.addEventListener('click', async (e) => { e.preventDefault(); await supabase.auth.signOut(); location.replace("/it/"); });
      transactionList.addEventListener('click', (event) => { /* ... */ });
    }

    // Le funzioni complete che sono rimaste invariate per brevità
    // (Devi assicurarti che siano presenti nel tuo script finale)
    /*
    function updateSubcategories(selectedSubcategoryId = null) { ... }
    async function loadTransactions() { ... }
    function handleEdit(id) { ... }
    async function handleDelete(id) { ... }
    async function handleFormSubmit(event) { ... }
    */

    document.addEventListener('DOMContentLoaded', initializePage);
  </script>
</body>
</html>
