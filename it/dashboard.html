<!doctype html>
<html lang="it" data-app="myhomesbudget">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard — MyHomesBudget</title>
  <meta name="description" content="Gestisci le tue finanze, traccia le spese e raggiungi i tuoi obiettivi.">
  <meta name="robots" content="noindex, nofollow">
  <meta name="color-scheme" content="light dark">

  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' https: data:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self' 'unsafe-inline' https://esm.sh;
                 connect-src 'self' https://*.supabase.co;
                 font-src 'self' https: data:;
                 frame-ancestors 'none';
                 base-uri 'self';
                 form-action 'self'">

  <link rel="icon" href="/favicon.ico">

  <style>
    /* Stessi stili base di onboarding.html per coerenza */
    :root{
      --fg:#111; --glass:rgba(255,255,255,.58);
      --card-border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.10);
      --radius-lg:16px; --grad:linear-gradient(135deg,#6c5ce7,#00cec9);
      --primary-color: #6c5ce7;
    }
    *{box-sizing:border-box}
    html,body{font-family:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif}
    a:focus-visible,button:focus-visible,input:focus-visible,select:focus-visible{outline:2px solid #00cec9; outline-offset:2px; border-radius:8px}
    
    body{
      margin:0;color:#fff;background:url("/bg.webp") no-repeat center/cover fixed;
      min-height:100vh;display:flex;flex-direction:column;align-items:center;
    }
    body::before{content:"";position:fixed;inset:0;background:rgba(0,0,0,.08);z-index:-1}

    .topbar{
      position:fixed;top:16px;left:50%;transform:translateX(-50%);
      width:min(920px,calc(100% - 40px));z-index:20;pointer-events:none;
      display:flex;align-items:center;justify-content:space-between;
    }
    .logo-link,.top-actions{pointer-events:auto}
    .logo-link{display:flex;align-items:center;gap:8px;text-decoration:none}
    .logo-image{height:32px;border-radius:6px}
    .logo-text{font-weight:600;color:#fff;font-size:1.05rem;text-shadow:0 1px 2px rgba(0,0,0,.35)}
    .top-actions{display:flex;gap:8px;align-items:center}
    .logout-link{
      color:#fff;text-decoration:none;padding:6px 10px;border-radius:10px;
      background:rgba(0,0,0,.28); border:1px solid rgba(255,255,255,.25);
    }
    .logout-link:hover{background:rgba(0,0,0,.38)}
    
    main.panel{
      margin-top:84px;
      width:min(920px,calc(100% - 40px));
      background:var(--glass); color:var(--fg); border-radius:var(--radius-lg);
      padding:clamp(18px,4vw,22px); box-shadow:var(--shadow);
      display:flex;flex-direction:column;gap:20px;
    }
    
    h1, h2, h3 { color: #111; }
    .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;font-weight:800;transition: all .2s ease;}
    .btn-primary{background:var(--primary-color);color:#fff;box-shadow:0 8px 22px rgba(0,0,0,.14)}
    .btn-primary:hover{filter:brightness(1.07);transform:translateY(-1px)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    
    /* Stili Dashboard */
    .dash-nav {
      display: flex;
      gap: 8px;
      border-bottom: 1px solid rgba(0,0,0,0.1);
      padding-bottom: 12px;
    }
    .dash-nav a {
      text-decoration: none;
      color: #333;
      padding: 8px 16px;
      border-radius: 10px;
      font-weight: 600;
    }
    .dash-nav a.is-active {
      background-color: #fff;
      color: var(--primary-color);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .content-section {
      background: rgba(255,255,255,.55);
      border-radius:12px;
      padding:16px;
      border:1px solid var(--card-border);
    }

    .transaction-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items: flex-end;
    }
    @media (min-width: 820px) {
      .transaction-form {
        grid-template-columns: repeat(3, 1fr) auto;
      }
    }
    .form-group { display: flex; flex-direction: column; }
    .form-group.full-width { grid-column: 1 / -1; }
    .form-group label { font-weight: 600; font-size: 0.9rem; margin-bottom: 6px; }
    .form-group input, .form-group select {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff;
      font-size: 1rem;
    }
    
    .transaction-list-header {
      margin-top: 24px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    .transaction-list .item {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 12px;
      align-items: center;
      padding: 12px 4px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    .transaction-list .item:last-child { border-bottom: none; }
    .item-icon { font-size: 1.5rem; }
    .item-details { display: flex; flex-direction: column; }
    .item-details .note { font-weight: 600; }
    .item-details .category { font-size: 0.9rem; color: #555; }
    .item-amount { text-align: right; }
    .item-amount.expense { color: #d32f2f; font-weight: 700; }
    .item-amount.income { color: #2e7d32; font-weight: 700; }
    .empty-state { text-align: center; padding: 40px; color: #555; }

  </style>
</head>
<body>
  <nav class="topbar">
    <a href="/it/" class="logo-link">
      <img src="/homes.png" alt="Logo MyHomesBudget" class="logo-image">
      <span class="logo-text">MyHomesBudget</span>
    </a>
    <div class="top-actions">
      <a href="#" id="logout-btn" class="logout-link">Esci</a>
    </div>
  </nav>

  <main class="panel">
    
    <nav id="dash-nav" class="dash-nav">
      <a href="/it/dashboard.html" class="is-active" aria-current="page">Operazioni</a>
      <a href="/it/dashboard-riepilogo.html">Riepilogo</a>
    </nav>

    <section class="content-section">
      <h2>Nuova Transazione</h2>
      <form id="transaction-form" class="transaction-form">
        <div class="form-group full-width">
          <label for="kind">Tipo</label>
          <select id="kind" name="kind" required>
            <option value="expense">Uscita</option>
            <option value="income">Entrata</option>
          </select>
        </div>
        <div class="form-group full-width">
          <label for="note">Nota</label>
          <input type="text" id="note" name="note" placeholder="Es. Caffè al bar" required>
        </div>
        <div class="form-group">
          <label for="amount">Importo (€)</label>
          <input type="number" id="amount" name="amount" step="0.01" placeholder="0.00" required>
        </div>
        <div class="form-group">
          <label for="occurred_at">Data</label>
          <input type="date" id="occurred_at" name="occurred_at" required>
        </div>
        <div class="form-group">
          <label for="category_id">Categoria</label>
          <select id="category_id" name="category_id" required>
            <option value="">Scegli una categoria...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="subcategory_id">Sottocategoria (opzionale)</label>
          <select id="subcategory_id" name="subcategory_id">
            <option value="">Scegli una sottocategoria...</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary" style="grid-column: 1 / -1; margin-top: 10px;">Aggiungi</button>
      </form>
    </section>

    <section class="content-section">
      <h2 class="transaction-list-header">Movimenti Recenti</h2>
      <div id="transaction-list" class="transaction-list">
        <div class="empty-state">
          <p>Nessuna transazione ancora registrata.</p>
        </div>
      </div>
    </section>
    
  </main>
  
  <script type="module">
    import { supabase } from "/it/supabase-client.js";

    // --- VARIABILI GLOBALI E SELETTORI ---
    const transactionForm = document.getElementById('transaction-form');
    const transactionList = document.getElementById('transaction-list');
    const categorySelect = document.getElementById('category_id');
    const subcategorySelect = document.getElementById('subcategory_id');
    const logoutBtn = document.getElementById('logout-btn');
    
    let user = null;
    let allCategories = [];
    let allSubcategories = [];

    // --- FUNZIONI PRINCIPALI ---

    /**
     * Carica dal DB le categorie e sottocategorie create dall'utente.
     */
    async function loadCategories() {
      // Nota: in un'app reale, filtreremmo per utente (created_by = user.id)
      const { data: categories, error: catError } = await supabase.from('categories').select('*');
      const { data: subcategories, error: subcatError } = await supabase.from('subcategories').select('*');

      if (catError || subcatError) {
        console.error("Errore caricamento categorie:", catError || subcatError);
        return;
      }
      
      allCategories = categories;
      allSubcategories = subcategories;

      categorySelect.innerHTML = '<option value="">Scegli una categoria...</option>';
      allCategories.forEach(cat => {
        const option = new Option(cat.name, cat.id);
        categorySelect.add(option);
      });
    }

    /**
     * Aggiorna il menu a tendina delle sottocategorie quando una categoria viene selezionata.
     */
    function updateSubcategories() {
      const selectedCategoryId = categorySelect.value;
      subcategorySelect.innerHTML = '<option value="">Scegli una sottocategoria...</option>';
      
      if (!selectedCategoryId) return;

      const relevantSubcategories = allSubcategories.filter(sub => sub.category_id === selectedCategoryId);
      relevantSubcategories.forEach(sub => {
        const option = new Option(sub.name, sub.id);
        subcategorySelect.add(option);
      });
    }

    /**
     * Carica e visualizza le ultime transazioni dell'utente.
     */
    async function loadTransactions() {
      const { data, error } = await supabase
        .from('transactions')
        .select(`
          *,
          categories ( name ),
          subcategories ( name )
        `)
        .eq('created_by', user.id)
        .order('occurred_at', { ascending: false })
        .limit(10);
      
      if (error) {
        console.error("Errore caricamento transazioni:", error);
        return;
      }

      transactionList.innerHTML = ''; // Pulisci la lista
      
      if (data.length === 0) {
        transactionList.innerHTML = `<div class="empty-state"><p>Nessuna transazione ancora registrata.</p></div>`;
        return;
      }

      data.forEach(tx => {
        const item = document.createElement('div');
        item.className = 'item';
        
        const categoryName = tx.categories ? tx.categories.name : 'N/A';
        const subCategoryName = tx.subcategories ? ` / ${tx.subcategories.name}` : '';
        const icon = tx.kind === 'income' ? '🟢' : '🔴';

        item.innerHTML = `
          <div class="item-icon">${icon}</div>
          <div class="item-details">
            <span class="note">${tx.note}</span>
            <span class="category">${categoryName}${subCategoryName}</span>
          </div>
          <div class="item-amount ${tx.kind}">
            ${tx.kind === 'expense' ? '-' : ''}${tx.amount.toFixed(2)} €
          </div>
        `;
        transactionList.appendChild(item);
      });
    }
    
    /**
     * Gestisce il salvataggio di una nuova transazione.
     */
    async function handleFormSubmit(event) {
      event.preventDefault();
      const formData = new FormData(transactionForm);
      const subcategory_id = formData.get('subcategory_id') || null; // Invia null se vuoto

      const { error } = await supabase.from('transactions').insert({
        kind: formData.get('kind'),
        note: formData.get('note'),
        amount: formData.get('amount'),
        occurred_at: formData.get('occurred_at'),
        category_id: formData.get('category_id'),
        subcategory_id: subcategory_id,
        created_by: user.id
      });

      if (error) {
        console.error("Errore salvataggio transazione:", error);
        alert("Si è verificato un errore. Riprova.");
      } else {
        transactionForm.reset();
        // Imposta la data di oggi come default per il prossimo inserimento
        document.getElementById('occurred_at').valueAsDate = new Date();
        loadTransactions(); // Ricarica la lista per mostrare il nuovo elemento
      }
    }

    // --- INIZIALIZZAZIONE ---

    async function initializePage() {
      // 1. Controlla utente e profilo
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        location.replace("/it/login.html");
        return;
      }
      user = session.user;

      const { data: profile } = await supabase
        .from('profiles')
        .select('onboarded')
        .eq('id', user.id)
        .single();
      
      if (profile && !profile.onboarded) {
        location.replace("/it/onboarding.html");
        return;
      }
      
      // 2. Imposta valori di default
      document.getElementById('occurred_at').valueAsDate = new Date();
      
      // 3. Carica i dati e imposta gli event listener
      await loadCategories();
      await loadTransactions();
      
      categorySelect.addEventListener('change', updateSubcategories);
      transactionForm.addEventListener('submit', handleFormSubmit);
      
      logoutBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        await supabase.auth.signOut();
        location.replace("/it/");
      });
    }

    // Avvia l'applicazione
    document.addEventListener('DOMContentLoaded', initializePage);
  </script>

</body>
</html>
