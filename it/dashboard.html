<!doctype html>
<html lang="it" data-app="myhomesbudget">
<head>
  <!-- === Supabase bootstrap (singleton + session gate) =================== -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // üîß usa i tuoi valori reali (o iniettabili da window.__SUPABASE_*__)
    const SUPABASE_URL  = window.__SUPABASE_URL__  || "https://upcusjlumfeadgbhziwq.supabase.co";
    const SUPABASE_ANON = window.__SUPABASE_ANON__ || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwY3Vzamx1bWZlYWRnYmh6aXdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0MTAzMTgsImV4cCI6MjA3MTk4NjMxOH0.U3cukTOaAZCPOF9f0mnyO00ghRgrzxwPx6GwqKuZmCM";

    // evita client doppi tra pi√π script
    if (!window.__sb) {
      window.__sb = createClient(SUPABASE_URL, SUPABASE_ANON, {
        auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
      });
    }

    // utility: promise ‚Äúclient pronto + sessione disponibile‚Äù
    window.__sbReady = (async () => {
      const sb = window.__sb;
      const { data: { session } } = await sb.auth.getSession();

      if (!session) {
        const redirect = location.pathname + location.search + location.hash;
        location.href = `/it/login.html?redirect=${encodeURIComponent(redirect)}`;
        throw new Error("No session: redirecting to login");
      }

      // emetti un evento utile se serve altrove
      document.dispatchEvent(new CustomEvent("mhb:sb-ready", { detail: { sb, session } }));
      return { sb, session };
    })();
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard ‚Äî MyHomesBudget</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" href="/favicon.ico" />

  <style>
    :root{
      --fg:#111;--bg:#f4f7fa;--glass:rgba(255,255,255,.6);
      --card-border:rgba(0,0,0,.08);--shadow:0 10px 30px rgba(0,0,0,.08);
      --radius-lg:16px;--primary-color:#6c5ce7;--danger-color:#d32f2f;--success-color:#2e7d32;
      --warning-color:#f39c12;--font-sans:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif;
      --grad:linear-gradient(135deg,#6c5ce7,#00cec9);--grad-danger:linear-gradient(135deg,#d32f2f,#ff7675);
    }
    *{box-sizing:border-box}
    html{font-family:var(--font-sans);background-color:var(--bg)}
    body{margin:0;color:var(--fg);background:url("/bg.webp") no-repeat center/cover fixed;min-height:100vh}
    body::before{content:"";position:fixed;inset:0;background:linear-gradient(135deg,rgba(108,92,231,.05),rgba(0,206,201,.05));z-index:-1}

    /* topbar */
    .topbar{position:fixed;top:0;left:0;right:0;height:60px;padding:0 24px;display:flex;align-items:center;justify-content:space-between;background:var(--glass);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-bottom:1px solid var(--card-border);z-index:100}
    .logo-link{display:flex;align-items:center;gap:8px;text-decoration:none}
    .logo-text{font-weight:600;color:#fff;font-size:1.1rem;text-shadow:0 1px 2px rgba(0,0,0,.35)}
    .top-actions{display:flex;gap:12px;align-items:center}
    .top-link,.top-btn{display:flex;align-items:center;justify-content:center;height:34px;color:#fff;text-decoration:none;padding:6px 12px;border-radius:10px;font-size:.9rem;font-weight:600;background:var(--grad);border:none;box-shadow:0 4px 12px rgba(0,0,0,.15);transition:.2s;cursor:pointer}
    .top-link:hover,.top-btn:hover{transform:translateY(-2px);filter:brightness(1.08);box-shadow:0 6px 16px rgba(0,0,0,.2)}
    .date-selectors{display:flex;gap:8px}
    .select-wrapper{position:relative;display:flex;align-items:center;height:34px;border-radius:10px;background:var(--grad);box-shadow:0 4px 12px rgba(0,0,0,.15);transition:.2s}
    .select-wrapper:hover{transform:translateY(-2px);filter:brightness(1.08);box-shadow:0 6px 16px rgba(0,0,0,.2)}
    .select-wrapper::after{content:'‚ñº';font-size:10px;color:rgba(255,255,255,.8);position:absolute;right:10px;top:50%;transform:translateY(-50%);pointer-events:none}
    .topbar-select{appearance:none;background:transparent;color:#fff;border:none;padding:6px 28px 6px 12px;font-size:.9rem;font-weight:600;cursor:pointer}
    .topbar-select option{background:#fff;color:#000}
    .notification-bell{position:relative}
    #scheduler-btn,#notifications-btn{width:38px;padding:0}
    .notification-badge{position:absolute;top:-5px;right:-5px;background:var(--danger-color);color:#fff;border-radius:50%;width:20px;height:20px;font-size:12px;font-weight:bold;display:flex;align-items:center;justify-content:center;border:2px solid #fff;display:none}
    .notification-badge.is-visible{display:flex}
    .mobile-menu-toggle{display:none;background:var(--grad);border:none;border-radius:10px;width:40px;height:38px;cursor:pointer;padding:0;z-index:101;box-shadow:0 4px 12px rgba(0,0,0,.15)}
    .mobile-menu-toggle svg{width:24px;height:24px;stroke:#fff;stroke-width:2.5;stroke-linecap:round}
    .visually-hidden{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}
    @media (max-width:960px){.mobile-menu-toggle{display:block}.top-actions{position:fixed;top:70px;right:16px;background:rgba(255,255,255,.9);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-radius:var(--radius-lg);box-shadow:var(--shadow);padding:16px;flex-direction:column;gap:16px;align-items:stretch;width:220px;transform:translateY(-20px) scale(.95);opacity:0;pointer-events:none;transition:.2s;z-index:100;border:1px solid var(--card-border)}.top-actions.is-open{transform:translateY(0) scale(1);opacity:1;pointer-events:auto}.top-actions .top-link,.top-actions .top-btn,.top-actions .select-wrapper,.top-actions .date-selectors{width:100%;text-align:center;flex-direction:column}#scheduler-btn,#notifications-btn{width:100%}}

    /* layout */
    main.container{padding:84px 24px 24px;max-width:1280px;margin:0 auto;width:100%}
    .dash-nav{display:flex;gap:8px;border-bottom:1px solid rgba(0,0,0,.1);padding-bottom:12px;margin-bottom:24px}
    .dash-nav a,.dash-nav button{text-decoration:none;padding:8px 16px;border-radius:10px;font-weight:600;transition:.2s;background:var(--grad);color:#fff;box-shadow:0 4px 12px rgba(0,0,0,.1);border:none;font-family:var(--font-sans);font-size:1rem;cursor:pointer}
    .dash-nav a:hover,.dash-nav button:hover{transform:translateY(-2px);filter:brightness(1.08);box-shadow:0 6px 16px rgba(0,0,0,.15)}
    .dash-nav a.is-active,.dash-nav button.is-active{filter:brightness(1.15);box-shadow:0 6px 16px rgba(0,0,0,.20),inset 0 1px 2px rgba(255,255,255,.2)}
    .content-section{background:rgba(255,255,255,.85);border-radius:var(--radius-lg);padding:16px;border:1px solid var(--card-border);box-shadow:var(--shadow)}
    .dashboard-panel{background:rgba(255,255,255,.55);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border-radius:var(--radius-lg);padding:24px;border:1px solid var(--card-border);box-shadow:var(--shadow)}
    .dashboard-grid{display:grid;grid-template-columns:1fr;gap:24px}
    @media (min-width:1024px){.dashboard-grid{grid-template-columns:repeat(2,1fr)}}
    .flow-column h2{display:flex;align-items:center;justify-content:space-between;gap:12px;font-size:1.5rem;margin:0 0 16px;padding:0 8px}
    .flow-column.income h2{color:var(--success-color)}.flow-column.expense h2{color:var(--danger-color)}

    /* summary bars */
    .summary-card{background:#fff;padding:16px;border-radius:var(--radius-lg);margin-bottom:16px}
    .summary-card h3{display:flex;justify-content:space-between;align-items:center;margin:0 0 12px;font-size:1rem;color:#555}
    .summary-total-amount{font-weight:800;font-size:1.2rem}
    .income .summary-total-amount{color:var(--success-color)}.expense .summary-total-amount{color:var(--danger-color)}
    .category-summary-bars{display:flex;flex-direction:column;gap:14px;margin-top:16px}
    .category-bar-item{display:flex;flex-direction:column;gap:6px}
    .category-bar-info{display:flex;justify-content:space-between;align-items:center;font-size:.95rem}
    .category-bar-label{display:flex;align-items:center;gap:8px;font-weight:600}
    .category-bar-label .icon{font-size:1.1rem}
    .category-bar-amount{font-weight:700}
    .progress-bar-bg{width:100%;height:10px;background:rgba(0,0,0,.08);border-radius:999px;overflow:hidden}
    .progress-bar-fg{height:100%;border-radius:999px;transition:width .5s ease-out}
    .income .progress-bar-fg{background:linear-gradient(90deg,#00cec9,#81ecec)}
    .expense .progress-bar-fg{background:linear-gradient(90deg,#6c5ce7,#fd79a8)}

    /* form */
    .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;font-weight:800;color:#fff;transition:.2s}
    .btn:hover{transform:translateY(-2px);filter:brightness(1.08)}
    .btn-primary{background:var(--grad);box-shadow:0 10px 24px rgba(0,0,0,.18)}
    .btn-primary:hover{box-shadow:0 14px 28px rgba(0,0,0,.22)}
    .btn-secondary{background:#f0f0f0;color:#555;border:1px solid #ddd;box-shadow:0 4px 8px rgba(0,0,0,.05)}
    .btn-secondary:hover{background:#e5e5e5;border-color:#ccc;color:#333}
    .transaction-form{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:flex-end}
    .form-group{display:flex;flex-direction:column}
    .form-group label{font-weight:600;font-size:.9rem;margin-bottom:6px}
    .form-group input,.form-group select{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;background:#fff;font-size:1rem}
    .form-group.full-width{grid-column:1 / -1}
    .form-buttons{grid-column:1 / -1;margin-top:10px}
    .form-buttons.is-editing{display:flex;gap:12px}
    .form-buttons.is-editing #submit-btn{flex-grow:1}
    @media(min-width:1024px){.transaction-form{grid-template-columns:repeat(6,1fr);gap:16px}.form-group.kind{grid-column:span 1}.form-group.note{grid-column:span 3}.form-group.amount{grid-column:span 2}.form-group.date{grid-column:span 2}.form-group.category{grid-column:span 2}.form-group.subcategory{grid-column:span 2}}

    #advanced-options-wrapper{display:none;grid-column:1 / -1;background:rgba(0,0,0,.03);padding:12px;border-radius:10px;margin-top:8px}
    .advanced-options-controls{display:flex;flex-wrap:wrap;gap:20px;align-items:center;margin-bottom:12px}
    .advanced-options-controls label{display:flex;align-items:center;gap:8px;font-weight:600;cursor:pointer}
    .advanced-options-fields{display:none;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px}

    /* lists */
    .list-title{margin:-16px -16px 16px;padding:12px 16px;font-size:1.1rem;font-weight:700;color:#333;border-bottom:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.4);display:flex;justify-content:space-between;align-items:center}
    .list-total-amount{font-weight:800;font-size:1.2rem}
    .income .list-total-amount{color:var(--success-color)}.expense .list-total-amount{color:var(--danger-color)}
    .transaction-list .item{display:grid;grid-template-columns:auto 1fr auto auto;gap:12px;align-items:center;padding:12px 4px;border-bottom:1px solid rgba(0,0,0,.05)}
    .item:last-child{border-bottom:none}
    .item-icon{font-size:1.5rem;flex-shrink:0}
    .item-details{display:flex;flex-direction:column;min-width:0}
    .item-details .note{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .item-details .category{font-size:.9rem;color:#555;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .item-amount{text-align:right;white-space:nowrap;flex-shrink:0}
    .item-amount.expense{color:var(--danger-color);font-weight:700}
    .item-amount.income{color:var(--success-color);font-weight:700}
    .item-actions{display:flex;gap:4px;flex-shrink:0}
    .action-btn{background:var(--grad);color:#fff;border:none;border-radius:8px;padding:6px 10px;font-size:.85rem;font-weight:600;cursor:pointer;transition:.2s}
    .action-btn:hover{filter:brightness(1.1);transform:translateY(-1px)}
    .action-btn.delete{background:var(--grad-danger)}
    .empty-state{text-align:center;padding:40px 20px;color:#777;background:rgba(0,0,0,0.02);border-radius:12px}

    /* deadlines */
    #deadlines-section h3{color:var(--warning-color);border-bottom:2px solid var(--warning-color);padding-bottom:8px}
    .deadline-item{display:grid;grid-template-columns:1fr auto auto auto;align-items:center;gap:12px}
    .deadline-item .item-actions{display:flex;gap:4px;align-items:center;justify-content:flex-end}
    .deadline-item .item-amount.expense{color:var(--danger-color)}
    .deadline-item .item-amount.income{color:var(--success-color)}
    .deadline-item .days-left{font-weight:700;color:var(--warning-color)}
    .btn-action-deadline{padding:8px 12px;font-size:.9rem}
    .btn-action-deadline.pay{background:var(--warning-color)}
    .btn-action-deadline.receive{background:var(--success-color)}

    /* modals + animation */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;pointer-events:none;transition:opacity .3s}
    .modal-overlay.is-visible{opacity:1;pointer-events:auto}
    .modal-content{background:var(--bg);border-radius:var(--radius-lg);padding:24px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto;box-shadow:var(--shadow);transform:scale(.95);transition:transform .3s}
    .modal-overlay.is-visible .modal-content{transform:scale(1)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--card-border);padding-bottom:12px;margin-bottom:16px}
    .modal-title{margin:0;font-size:1.3rem}
    .modal-close{background:none;border:none;font-size:2rem;cursor:pointer;color:#888;line-height:1;padding:0}
    .modal-footer{margin-top:20px;display:flex;justify-content:flex-end;gap:12px}
    .modal-footer .btn.delete{background:var(--grad-danger);box-shadow:0 8px 20px rgba(211,47,47,.25)}
    .modal-footer .btn.delete:hover{box-shadow:0 12px 24px rgba(211,47,47,.3)}

    .modal-content-large{max-width:90vw;width:1000px}
    .movements-table-container{max-height:60vh;overflow-y:auto}
    .movements-table{width:100%;border-collapse:collapse}
    .movements-table th,.movements-table td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--card-border);white-space:nowrap}
    .movements-table th{font-weight:700;background:rgba(0,0,0,.05);font-size:.9rem;position:sticky;top:0}
    .movements-summary{margin-top:20px;padding-top:16px;border-top:2px solid var(--card-border);display:flex;justify-content:space-around;font-weight:700}
    .summary-item{text-align:center}.summary-label{font-size:.9rem;color:#555}.summary-value{font-size:1.2rem}
    .summary-value.total-income{color:var(--success-color)}.summary-value.total-expense{color:var(--danger-color)}
    
    .animation-modal-overlay { position: fixed; inset: 0; z-index: 2000; display: flex; align-items: center; justify-content: center; pointer-events: none; opacity: 0; transition: opacity .3s; }
    .animation-modal-overlay.is-visible { opacity: 1; }
    .animation-container { position: relative; width: 300px; height: 300px; }
    .animation-bg-image { width: 100%; height: 100%; object-fit: contain; }
    .animation-elements-container { position: absolute; inset: 0; }
    .money-element { position: absolute; background-size: contain; background-repeat: no-repeat; }
    .money-element.income { animation: rain-in 1.5s ease-out forwards; }
    .money-element.expense { animation: fly-out 1.2s ease-in forwards; }
    @keyframes rain-in { 0% { transform: translateY(-150px) scale(0.8); opacity: 0; } 100% { transform: translateY(0) scale(1); opacity: 1; } }
    @keyframes fly-out { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(180px) scale(0.5); opacity: 0; } }

    /* status message */
    .status-message{padding:12px 16px;border-radius:10px;margin-top:16px;text-align:center;font-weight:600;opacity:0;transition:opacity .3s;grid-column:1 / -1}
    .status-message.is-visible{opacity:1}
    .status-message.success{background:var(--success-color);color:#fff}
    .status-message.error{background:var(--danger-color);color:#fff}

    /* goals UI */
    #goals-section .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    #goals-plan-info{font-weight:700;color:#666}
    .goal-card{background:#fff;border:1px solid var(--card-border);border-radius:12px;padding:16px;box-shadow:var(--shadow)}
    .goal-title{font-weight:800;color:#444;margin:0 0 4px}
    .goal-subtitle{margin:0 0 12px;color:#666}
    .goal-row{display:grid;grid-template-columns:1fr 1fr auto;gap:12px;align-items:center}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border-radius:999px;background:rgba(0,0,0,.05);font-weight:700;cursor:pointer;user-select:none}
    .chip.is-active{background:var(--grad);color:#fff;box-shadow:0 4px 10px rgba(0,0,0,.12)}
    .goal-method{display:flex;gap:8px;flex-wrap:wrap}
    .goal-input input{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;font-size:1rem;background:#fff}
    .goal-hint{display:block;margin-top:6px;font-size:.85rem;color:#777}
    .goal-confirm{text-align:right}
    .goal-locked{opacity:.7}
  </style>
</head>
<body>
  <!-- Topbar -->
  <nav class="topbar">
    <a href="/it/" class="logo-link"><img src="/homes.png" alt="Logo" style="height:32px;border-radius:6px"><span class="logo-text">MyHomesBudget</span></a>
    <div class="top-nav-right">
      <button id="mobile-menu-btn" class="mobile-menu-toggle" aria-label="Apri menu">
        <svg viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        <span class="visually-hidden">Menu</span>
      </button>
      <div class="top-actions">
        <div class="date-selectors">
          <div class="select-wrapper"><select id="month-selector" class="topbar-select"></select></div>
          <div class="select-wrapper"><select id="year-selector" class="topbar-select"></select></div>
        </div>
        <a href="/it/onboarding.html?edit=1" class="top-link">üéØ Obiettivo</a>
        <button id="scheduler-btn" class="top-btn" aria-label="Apri scadenziario">üóìÔ∏è</button>
        <button id="notifications-btn" class="top-btn notification-bell" aria-label="Apri notifiche">
          <span>üîî</span><span id="notification-badge" class="notification-badge"></span>
        </button>
        <!-- MIGLIORIA: Usato <button> per un'azione, semanticamente pi√π corretto -->
        <button id="logout-btn" class="top-btn">Esci</button>
      </div>
    </div>
  </nav>

  <main class="container">
    <nav id="dash-nav" class="dash-nav">
      <a href="/it/dashboard.html" class="is-active" aria-current="page">Operazioni</a>
      <a href="/it/dashboard-riepilogo.html">Riepilogo</a>
      <button id="list-movements-btn">Lista Movimenti</button>
    </nav>

    <!-- Form operazione -->
    <section class="content-section form-section">
      <h2 id="form-title" style="margin:0 0 16px">Nuova Operazione</h2>
      <form id="transaction-form" class="transaction-form">
        <input type="hidden" id="transaction-id" name="transaction-id">
        <div class="form-group kind"><label for="kind">Tipo</label><select id="kind" name="kind" required><option value="expense">Uscita</option><option value="income">Entrata</option></select></div>
        <div class="form-group note"><label for="note">Nota</label><input type="text" id="note" name="note" placeholder="Es. Stipendio, Rata Mutuo..." required></div>
        <div class="form-group amount"><label for="amount">Importo (‚Ç¨)</label><input type="number" id="amount" name="amount" step="0.01" placeholder="0.00" required></div>
        <div class="form-group date"><label for="occurred_at">Data</label><input type="date" id="occurred_at" name="occurred_at" required></div>
        <div class="form-group category"><label for="category_id">Categoria</label><select id="category_id" name="category_id" required></select></div>
        <div class="form-group subcategory"><label for="subcategory_id">Sottocategoria</label><select id="subcategory_id" name="subcategory_id"></select></div>

        <!-- Opzioni Avanzate -->
        <div id="advanced-options-wrapper">
          <div class="advanced-options-controls">
            <label><input type="radio" name="transaction_type" value="single" checked> Operazione Singola</label>
            <label><input type="radio" name="transaction_type" value="recurring"> üîÑ Ricorrente</label>
            <label><input type="radio" name="transaction_type" value="scheduled"> üóìÔ∏è Imposta Scadenza</label>
          </div>
          <div id="recurring-options" class="advanced-options-fields">
            <div class="form-group"><label for="recurring_frequency">Frequenza</label><select id="recurring_frequency" name="recurring_frequency"><option value="monthly">Mensile</option></select></div>
            <div class="form-group"><label for="recurring_end_date">Termina il</label><input type="date" id="recurring_end_date" name="recurring_end_date"></div>
          </div>
          <div id="due-date-options" class="advanced-options-fields">
            <div class="form-group full-width"><label for="due_date">Data di Scadenza/Incasso</label><input type="date" id="due_date" name="due_date"></div>
          </div>
        </div>

        <div id="form-buttons-container" class="form-buttons">
          <button type="submit" id="submit-btn" class="btn btn-primary" style="width:100%;">Aggiungi</button>
          <button type="button" id="cancel-edit-btn" class="btn btn-secondary" style="display:none;">Annulla</button>
        </div>

        <div id="status-message" class="status-message" aria-live="polite"></div>
      </form>
    </section>

    <!-- üéØ Obiettivi -->
    <section id="goals-section" class="content-section" style="margin-top:12px;">
      <div class="header">
        <h3 style="margin:0;display:flex;align-items:center;gap:8px;">üéØ <span>Obiettivi</span></h3>
        <span id="goals-plan-info"></span>
      </div>
      <div id="goals-list"></div>
    </section>

    <!-- Scadenze -->
    <section id="deadlines-section" class="content-section" style="margin-top:12px;display:none;">
      <h3>üîî Scadenze & Voci Future (Prossimi 30 giorni)</h3>
      <div id="deadlines-list" class="transaction-list"></div>
    </section>

    <!-- Pannello principali -->
    <div class="dashboard-panel" style="margin-top:12px;">
      <div class="dashboard-grid">
        <div class="flow-column income"><h2>‚úÖ Entrate Recenti</h2><div id="income-summary" class="summary-card"></div><div id="income-list" class="content-section transaction-list"></div></div>
        <div class="flow-column expense"><h2>‚ùå Uscite Recenti</h2><div id="expense-summary" class="summary-card"></div><div id="expense-list" class="content-section transaction-list"></div></div>
      </div>
    </div>
  </main>

  <!-- Modali (scheduler / generico / animazione / lista movimenti) -->
  <div id="scheduler-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h3 class="modal-title"></h3><button class="modal-close" aria-label="Chiudi modale">&times;</button></div><div class="modal-body transaction-list"></div></div></div>
  <div id="generic-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h3 id="generic-modal-title" class="modal-title"></h3><button class="modal-close" aria-label="Chiudi modale">&times;</button></div><div id="generic-modal-body" class="modal-body"></div><div id="generic-modal-footer" class="modal-footer"></div></div></div>
  <div id="animation-modal" class="animation-modal-overlay"><div class="animation-container"><img id="animation-bg-image" class="animation-bg-image" src="" alt="Animazione soldi"/><div class="animation-elements-container"></div></div></div>
  <div id="movements-modal" class="modal-overlay"><div class="modal-content modal-content-large"><div class="modal-header"><h3 id="movements-modal-title" class="modal-title">Lista Movimenti</h3><button class="modal-close" aria-label="Chiudi modale">&times;</button></div><div id="movements-modal-body" class="modal-body"><div class="movements-table-container"></div></div><div id="movements-modal-footer" class="movements-summary"></div></div></div>

  <!-- =========================== PAGE LOGIC (RIFACTORIZZATA) =========================== -->
  <script type="module">
    // usa sempre il client singleton
    const { sb, session } = await window.__sbReady;
    window.sb = sb; // opzionale per debug

    // ----- CONSTANTS & CONFIG -----
    const KIND_INCOME = 'income';
    const KIND_EXPENSE = 'expense';
    const TYPE_SINGLE = 'single';
    const TYPE_RECURRING = 'recurring';
    const TYPE_SCHEDULED = 'scheduled';
    const CLASS_VISIBLE = 'is-visible';
    const MONTHS = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
    
    // ----- STATE -----
    let user = session.user;
    let allCategories = [];
    let allSubcategories = [];
    let allTransactions = [];

    // ----- DOM ELEMENTS (Miglioria: Raggruppati per pulizia) -----
    const DOM = {
      transactionForm: document.getElementById('transaction-form'),
      kindSelect: document.getElementById('kind'),
      categorySelect: document.getElementById('category_id'),
      subcategorySelect: document.getElementById('subcategory_id'),
      transactionIdInput: document.getElementById('transaction-id'),
      formTitle: document.getElementById('form-title'),
      submitBtn: document.getElementById('submit-btn'),
      cancelEditBtn: document.getElementById('cancel-edit-btn'),
      formButtonsContainer: document.getElementById('form-buttons-container'),
      logoutBtn: document.getElementById('logout-btn'),
      incomeList: document.getElementById('income-list'),
      expenseList: document.getElementById('expense-list'),
      incomeSummary: document.getElementById('income-summary'),
      expenseSummary: document.getElementById('expense-summary'),
      monthSelector: document.getElementById('month-selector'),
      yearSelector: document.getElementById('year-selector'),
      advancedOptionsWrapper: document.getElementById('advanced-options-wrapper'),
      recurringOptions: document.getElementById('recurring-options'),
      dueDateOptions: document.getElementById('due-date-options'),
      deadlinesSection: document.getElementById('deadlines-section'),
      deadlinesList: document.getElementById('deadlines-list'),
      schedulerBtn: document.getElementById('scheduler-btn'),
      notificationsBtn: document.getElementById('notifications-btn'),
      notificationBadge: document.getElementById('notification-badge'),
      schedulerModal: document.getElementById('scheduler-modal'),
      movementsModal: document.getElementById('movements-modal'),
      listMovementsBtn: document.getElementById('list-movements-btn'),
      goalsSection: document.getElementById('goals-section'),
      goalsList: document.getElementById('goals-list'),
      goalsPlanInfo: document.getElementById('goals-plan-info'),
      statusMessage: document.getElementById('status-message'),
      animationModal: document.getElementById('animation-modal'),
      dashboardPanel: document.querySelector('.dashboard-panel'),
      mobileMenuBtn: document.getElementById('mobile-menu-btn'),
      topActions: document.querySelector('.top-actions')
    };

    // ----- UTILS -----
    const fmt = (n)=>Number(n||0).toFixed(2);
    const moneyBagImage = `data:image/svg+xml;base64,PHN2ZyB3aWR0aD0nMTAwJyBoZWlnaHQ9JzEwMCcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJz48Y2lyY2xlIGN4PSc1MCcgY3k9JzYwJyByPSczMCcgZmlsbD0nI2UwZScvPjxwYXRoIGQ9J00zNSAyMGg0MGM0IDAgNiA0IDUgOGwtNSA5SDEwbC01LTljLTEtNCAxLTggNS04eicgZmlsbD0nI2M2OGQyNycvPjwvc3ZnPg==`;

    function safeToNumber(v){const n=(typeof v==='number')?v:parseFloat(v);return Number.isFinite(n)?n:0}
    function showStatusMessage(message,type='success',duration=3000){
      DOM.statusMessage.textContent=message;
      DOM.statusMessage.className=`status-message ${type} ${CLASS_VISIBLE}`;
      setTimeout(()=>DOM.statusMessage.classList.remove(CLASS_VISIBLE),duration);
    }
    function showModal(title,bodyHtml,buttons=[]){
      const modal=document.getElementById('generic-modal');
      document.getElementById('generic-modal-title').textContent=title;
      document.getElementById('generic-modal-body').innerHTML=bodyHtml;
      const footer=document.getElementById('generic-modal-footer');footer.innerHTML='';
      buttons.forEach(info=>{const b=document.createElement('button');b.innerHTML=info.text;b.className=`btn ${info.class||'btn-secondary'}`;b.onclick=()=>{info.action&&info.action();modal.classList.remove(CLASS_VISIBLE)};footer.appendChild(b)});
      modal.classList.add(CLASS_VISIBLE);
    }

    // ----- GOALS -----
    const getMethodLabel = (m)=> m==='fixed'?'Importo fisso (‚Ç¨)':m==='variable'?'Importo variabile (‚Ç¨)':'Percentuale sulle entrate (%)';
    const getPlaceholder  = (m)=> m==='percent_income'?'10 ‚Üí significa 10%':'100.00';
    function getDisplayValue(goal){
      const m=goal.goal_method||'fixed';
      if(m==='fixed') return Number(goal.fixed_amount ?? goal.target_amount) || 0;
      if(m==='variable') return Number(goal.variable_amount)||0;
      return Number(goal.percent_income)||0;
    }

    async function loadGoals(){
      const { data, error, status } = await sb.rpc("get_dashboard_goals");
      if(error){ console.error("[Goals] RPC error",{error,status}); renderGoalsUI([]); return; }
      const goals = Array.isArray(data) ? data : [];
      renderGoalsUI(goals);
    }

    function renderGoalsUI(goals){
      DOM.goalsSection.style.display="block";

      if(!goals || goals.length===0){
        DOM.goalsPlanInfo.textContent='';
        DOM.goalsList.innerHTML=`
          <div class="goal-card">
            <div class="goal-title">üéØ <span>Obiettivo</span></div>
            <p class="goal-subtitle">Nessun obiettivo recuperato. Puoi configurarlo adesso.</p>
            <div class="goal-row">
              <div class="goal-method" role="tablist" aria-label="Metodo di accantonamento (solo esempio)">
                <span class="chip is-active">Somma fissa</span>
                <span class="chip">Somma variabile</span>
                <span class="chip">% sulle entrate</span>
              </div>
              <div class="goal-input">
                <input type="number" placeholder="100.00" step="0.01" />
                <span class="goal-hint">Imposta o modifica dall‚ÄôOnboarding.</span>
              </div>
              <div class="goal-confirm"><a class="btn btn-primary" href="/it/onboarding.html?edit=1">Configura</a></div>
            </div>
          </div>`;
        return;
      }

      const plan = goals.find(g=>g.plan_type)?.plan_type || '';
      const activeGoals = goals.filter(g=>g.active);
      const countActive = activeGoals.length;
      const maxGoals = goals[0]?.max_goals ?? '';
      DOM.goalsPlanInfo.textContent = plan ? `Piano: ${plan.toUpperCase()} ‚Ä¢ Attivi: ${countActive}/${maxGoals||''}` : '';

      const g1 = activeGoals[0] || goals[0];
      const method = g1.goal_method || 'fixed';
      const valueForMethod = getDisplayValue(g1);

      const editCard = `
        <div class="goal-card" style="margin-bottom:12px;">
          <div class="goal-title">üéØ <span>Obiettivo 1</span></div>
          <p class="goal-subtitle">${g1.name || 'Risparmio'}</p>
          <div class="goal-row">
            <div class="goal-method" id="g1-method">
              <span class="chip ${method==='fixed'?'is-active':''}" data-method="fixed">Somma fissa</span>
              <span class="chip ${method==='variable'?'is-active':''}" data-method="variable">Somma variabile</span>
              <span class="chip ${method==='percent_income'?'is-active':''}" data-method="percent_income">% sulle entrate</span>
            </div>
            <div class="goal-input">
              <label id="g1-label" style="font-weight:700;display:block;margin-bottom:6px;">${getMethodLabel(method)}</label>
              <input id="g1-value" type="number" step="0.01" value="${valueForMethod}" placeholder="${getPlaceholder(method)}"/>
              <span class="goal-hint">Target: <strong>${fmt(g1.target_amount)}‚Ç¨</strong></span>
            </div>
            <div class="goal-confirm"><button id="g1-save" class="btn btn-primary">Salva</button></div>
          </div>
        </div>`;
      let extraCards='';
      const isPro=(plan||'').toLowerCase()==='pro';
      activeGoals.slice(1).forEach((g,idx)=>{
        extraCards += `
          <div class="goal-card ${!isPro?'goal-locked':''}">
            <div class="goal-title">üéØ <span>Obiettivo ${idx+2}</span></div>
            <p class="goal-subtitle">${g.name || 'Risparmio'}</p>
            <div class="goal-row" style="grid-template-columns:1fr auto;">
              <div><div class="goal-hint" style="margin:0;">Target: <strong>${fmt(g.target_amount)}‚Ç¨</strong></div></div>
              <div class="goal-confirm">${!isPro?`<a class="btn btn-primary" href="/it/pricing.html">Sblocca con PRO</a>`:`<a class="btn btn-primary" href="/it/onboarding.html?edit=1">Modifica</a>`}</div>
            </div>
          </div>`;
      });

      DOM.goalsList.innerHTML = editCard + extraCards;
      bindGoalEditor(g1);
    }

    function bindGoalEditor(goal){
      const methodWrap=document.getElementById('g1-method');
      const valueInput=document.getElementById('g1-value');
      const saveBtn=document.getElementById('g1-save');
      const labelEl=document.getElementById('g1-label');
      if(!methodWrap||!valueInput||!saveBtn) return;

      methodWrap.addEventListener('click',(e)=>{
        const chip=e.target.closest('.chip'); if(!chip) return;
        [...methodWrap.querySelectorAll('.chip')].forEach(c=>c.classList.remove('is-active'));
        chip.classList.add('is-active');
        const m=chip.dataset.method;
        labelEl.textContent=getMethodLabel(m);
        valueInput.placeholder=getPlaceholder(m);
        if(m==='fixed') valueInput.value=Number(goal.fixed_amount ?? goal.target_amount) || 0;
        else if(m==='variable') valueInput.value=Number(goal.variable_amount)||0;
        else valueInput.value=Number(goal.percent_income)||0;
      });

      saveBtn.addEventListener('click', async ()=>{
        const activeChip=methodWrap.querySelector('.chip.is-active');
        const method=activeChip?activeChip.dataset.method:(goal.goal_method||'fixed');
        const val=parseFloat(valueInput.value); const value=Number.isFinite(val)?val:0;

        const patch={ method, goal_method:method, fixed_amount:null, variable_amount:null, percent_income:null };
        if(method==='fixed') patch.fixed_amount=value;
        else if(method==='variable') patch.variable_amount=value;
        else patch.percent_income=value;

        const { error } = await sb.from('goals').update(patch).eq('id',goal.id);
        if(error){ console.error('Errore aggiornamento obiettivo:',error); showModal('Errore',"Impossibile salvare le modifiche all'obiettivo.",[{text:'Chiudi'}]); return; }
        Object.assign(goal,patch);
        showStatusMessage('Obiettivo aggiornato con successo!','success');
      });
    }

    // ----- DATA LOAD (categorie/tx/scadenze) -----
    async function loadInitialData(){
      try{
        const { data:categories, error:cErr } = await sb.from('categories').select('*').eq('created_by',user.id);
        if(cErr) throw cErr;
        allCategories=categories||[];
        if(allCategories.length){
          const ids=allCategories.map(c=>c.id);
          const { data:subs, error:sErr } = await sb.from('subcategories').select('*').in('category_id',ids);
          if(sErr) throw sErr;
          allSubcategories=subs||[];
        }
      }catch(e){ console.error("Errore caricamento categorie:",e); showModal('Errore','<p>Impossibile caricare le categorie.</p>',[{text:'Chiudi'}]); }
    }
    function updateCategoryDropdown(){
      const selectedKind=DOM.kindSelect.value;
      DOM.advancedOptionsWrapper.style.display='block';
      const filtered=allCategories.filter(c=>c.kind===selectedKind);
      DOM.categorySelect.innerHTML='<option value="">Scegli categoria...</option>';
      filtered.forEach(c=>DOM.categorySelect.add(new Option(`${c.icon||''} ${c.name}`,c.id)));
      updateSubcategories();
    }
    function updateSubcategories(selected=null){
      const categoryId=DOM.categorySelect.value;
      DOM.subcategorySelect.innerHTML='<option value="">Nessuna</option>'; DOM.subcategorySelect.disabled=true;
      if(!categoryId) return;
      const relevant=allSubcategories.filter(s=>String(s.category_id)===String(categoryId));
      if(relevant.length){ DOM.subcategorySelect.disabled=false; relevant.forEach(s=>DOM.subcategorySelect.add(new Option(`${s.icon||''} ${s.name}`,s.id))); if(selected) DOM.subcategorySelect.value=selected; }
    }
    // ----- DATA RENDERING -----
    function renderSummary(items,container,kind){
      container.innerHTML='';
      const catMap=allCategories.filter(c=>c.kind===kind).reduce((a,c)=>{a[c.id]={name:c.name,icon:c.icon||(kind===KIND_INCOME?'üí∞':'üí∏'),total:0};return a;}, {});
      items.forEach(tx=>{ if(catMap[tx.category_id]) catMap[tx.category_id].total += safeToNumber(tx.amount); });
      const total = items.reduce((s,tx)=>s+safeToNumber(tx.amount),0);
      const top = Object.values(catMap).filter(c=>c.total>0).sort((a,b)=>b.total-a.total).slice(0,5);
      const title = kind===KIND_INCOME ?'üèÜ Top 5 Entrate':'üèÜ Top 5 Uscite';
      let bars = top.map(c=>{
        const perc = total>0 ? (c.total/total)*100 : 0;
        return `<div class="category-bar-item"><div class="category-bar-info"><span class="category-bar-label"><span class="icon">${c.icon}</span><span>${c.name}</span></span><span class="category-bar-amount">${fmt(c.total)}‚Ç¨</span></div><div class="progress-bar-bg"><div class="progress-bar-fg" style="width:${perc}%"></div></div></div>`;
      }).join('');
      const placeholders = 5 - top.length;
      if(placeholders>0){
        const ph = `<div class="category-bar-item" aria-hidden="true"><div class="category-bar-info" style="visibility:hidden;"><span class="category-bar-label"><span class="icon">&nbsp;</span><span>-</span></span><span class="category-bar-amount">&nbsp;</span></div><div class="progress-bar-bg" style="visibility:hidden;"><div class="progress-bar-fg" style="width:0%"></div></div></div>`;
        bars += ph.repeat(placeholders);
      }
      container.innerHTML = `<h3><span>${title}</span><span class="summary-total-amount">${fmt(total)}‚Ç¨</span></h3><div class="category-summary-bars">${bars}</div>`;
    }
    function renderList(items,container,kind){
      container.innerHTML='';
      const total = items.reduce((s,tx)=>s+safeToNumber(tx.amount),0);
      const head = document.createElement('div');
      head.className='list-title';
      head.innerHTML = `<span>${kind===KIND_INCOME?'Movimenti in Entrata':'Movimenti in Uscita'}</span><span class="list-total-amount ${kind}">${fmt(total)}‚Ç¨</span>`;
      container.appendChild(head);
      if(!items.length){ container.insertAdjacentHTML('beforeend','<div class="empty-state"><p>Nessun movimento qui.</p></div>'); return; }
      items.forEach(tx=>{
        const cat=tx.categories; const sub=tx.subcategories;
        const icon=sub?.icon || cat?.icon || 'üí∏';
        const categoryText=`${cat?.name||'N/A'}${sub?` / ${sub.name}`:''}`;
        const amountNum=safeToNumber(tx.amount);
        const recurringIcon=tx.is_recurring_parent?' üîÑ':'';
        container.insertAdjacentHTML('beforeend',`
          <div class="item">
            <div class="item-icon">${icon}</div>
            <div class="item-details"><span class="note">${tx.note??''}${recurringIcon}</span><span class="category">${categoryText}</span></div>
            <div class="item-amount ${tx.kind}">${tx.kind===KIND_EXPENSE?'-':'+'}${amountNum.toFixed(2)} ‚Ç¨</div>
            <div class="item-actions"><button class="action-btn edit-btn" data-id="${tx.id}">‚úçüèº Modifica</button><button class="action-btn delete-btn delete" data-id="${tx.id}">üóëÔ∏è Elimina</button></div>
          </div>`);
      });
    }
    function renderDashboard(transactions){
      const incomes=transactions.filter(t=>t.kind===KIND_INCOME && t.is_paid!==false);
      const expenses=transactions.filter(t=>t.kind===KIND_EXPENSE && t.is_paid!==false);
      renderSummary(incomes,DOM.incomeSummary,KIND_INCOME); renderList(incomes,DOM.incomeList,KIND_INCOME);
      renderSummary(expenses,DOM.expenseSummary,KIND_EXPENSE); renderList(expenses,DOM.expenseList,KIND_EXPENSE);
    }
    
    async function getScheduledTransactions(startDate,endDate){
      try{
        const { data, error } = await sb.from('transactions')
          .select(`*, categories(name, icon)`)
          .eq('created_by',user.id)
          .eq('is_paid',false)
          .gte('due_date',startDate.toISOString().split('T')[0])
          .lte('due_date',endDate.toISOString().split('T')[0])
          .order('due_date',{ascending:true});
        if(error) throw error;
        return data;
      }catch(e){ console.error("Errore caricamento scadenze:",e); return []; }
    }
    function renderDeadlinesList(container,transactions){
      if(transactions.length===0){ container.innerHTML='<div class="empty-state"><p>Nessuna scadenza in questo periodo.</p></div>'; return; }
      container.innerHTML=''; const today=new Date(); today.setHours(0,0,0,0);
      transactions.forEach(tx=>{
        const isIncome=tx.kind===KIND_INCOME; const dueDate=new Date(tx.due_date);
        const diffDays=Math.ceil((dueDate - today)/(1000*60*60*24));
        const daysLeft=diffDays<0?'Scaduta':(diffDays===0?'Oggi':`${diffDays} giorni`);
        container.insertAdjacentHTML('beforeend',`
          <div class="item deadline-item">
            <div class="item-details"><span class="note">${tx.note||''}</span><span class="category">${tx.categories?.name||''}</span></div>
            <span class="item-amount ${isIncome?'income':'expense'}">${isIncome?'+':'-'}${fmt(tx.amount)}‚Ç¨</span>
            <span class="days-left">${daysLeft}</span>
            <div class="item-actions">
              <button class="action-btn edit-btn" data-id="${tx.id}" aria-label="Modifica ${tx.note}">‚úçüèº</button>
              <button class="action-btn delete-btn delete" data-id="${tx.id}" aria-label="Elimina ${tx.note}">üóëÔ∏è</button>
              <button class="btn btn-action-deadline ${isIncome?'receive':'pay'}" data-id="${tx.id}">${isIncome?'Incassa Ora':'Paga Ora'}</button>
            </div>
          </div>`);
      });
    }

    function renderMovementsListModal(transactions,months){
      const modalBody=document.getElementById('movements-modal-body').querySelector('.movements-table-container');
      const modalFooter=document.getElementById('movements-modal-footer');
      const modalTitle=document.getElementById('movements-modal-title');
      const selMonthName=months[DOM.monthSelector.value]; const selYear=DOM.yearSelector.value;
      modalTitle.textContent=`Estratto Conto - ${selMonthName} ${selYear}`;
      if(!transactions||!transactions.length){ modalBody.innerHTML='<div class="empty-state"><p>Nessun movimento per il periodo selezionato.</p></div>'; modalFooter.innerHTML=''; return; }

      const sorted=[...transactions].sort((a,b)=>new Date(a.occurred_at)-new Date(b.occurred_at));
      let totIn=0, totOut=0;
      const rows=sorted.map(tx=>{
        const amount=safeToNumber(tx.amount); const isIn=tx.kind===KIND_INCOME; if(isIn) totIn+=amount; else totOut+=amount;
        const date=new Date(tx.occurred_at).toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit',year:'numeric'});
        return `<tr class="${tx.kind}"><td>${date}</td><td>${isIn?'Entrata':'Uscita'}</td><td>${tx.note||'-'}</td><td class="amount-col">${isIn?'+':'-'} ${fmt(amount)} ‚Ç¨</td><td>${tx.categories?.name||'N/A'}</td><td>${tx.subcategories?.name||'-'}</td></tr>`;
      }).join('');
      modalBody.innerHTML=`<table class="movements-table"><thead><tr><th>Data</th><th>Tipo</th><th>Nota</th><th class="amount-col">Importo</th><th>Categoria</th><th>Sottocategoria</th></tr></thead><tbody>${rows}</tbody></table>`;
      const balance=totIn - totOut;
      modalFooter.innerHTML=`<div class="summary-item"><div class="summary-label">Totale Entrate</div><div class="summary-value total-income">+ ${fmt(totIn)} ‚Ç¨</div></div><div class="summary-item"><div class="summary-label">Totale Uscite</div><div class="summary-value total-expense">- ${fmt(totOut)} ‚Ç¨</div></div><div class="summary-item"><div class="summary-label">Saldo</div><div class="summary-value balance">${fmt(balance)} ‚Ç¨</div></div>`;
    }

    // ----- Animazione -----
    function showTransactionAnimation(type=KIND_INCOME){
      return new Promise(resolve=>{
        const container=DOM.animationModal.querySelector('.animation-elements-container');
        const bg=document.getElementById('animation-bg-image'); container.innerHTML=''; bg.src=moneyBagImage;
        DOM.animationModal.classList.add(CLASS_VISIBLE);
        if(type===KIND_INCOME){
          for(let i=0;i<10;i++){ const d=document.createElement('div'); d.className='money-element income'; d.style.width='80px'; d.style.height='40px'; d.style.backgroundImage=`url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 50'%3E%3Crect width='100' height='50' rx='5' fill='%2366BB6A'/%3E%3Ccircle cx='50' cy='25' r='15' fill='none' stroke='%23A5D6A7' stroke-width='3'/%3E%3Ctext x='50' y='30' font-family='Arial' font-size='20' fill='%23E8F5E9' text-anchor='middle'%3E‚Ç¨%3C/text%3E%3C/svg%3E")`; d.style.left=`${Math.random()*80+10}%`; d.style.animationDelay=`${Math.random()*1.2}s`; container.appendChild(d);}
          setTimeout(()=>{DOM.animationModal.classList.remove(CLASS_VISIBLE);resolve();},2800);
        }else{
          const d=document.createElement('div'); d.className='money-element expense'; d.style.width='80px'; d.style.height='40px'; d.style.backgroundImage=`url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 50'%3E%3Crect width='100' height='50' rx='5' fill='%23EF9A9A'/%3E%3Ccircle cx='50' cy='25' r='15' fill='none' stroke='%23FFCDD2' stroke-width='3'/%3E%3Ctext x='50' y='30' font-family='Arial' font-size='20' fill='%23FFEBEE' text-anchor='middle'%3E‚Ç¨%3C/text%3E%3C/svg%3E")`; container.appendChild(d);
          setTimeout(()=>{DOM.animationModal.classList.remove(CLASS_VISIBLE);resolve();},2000);
        }
      });
    }

    // ----- CRUD Transazioni -----
    function resetFormToCreateMode(){
      DOM.formTitle.textContent="Nuova Operazione"; DOM.submitBtn.textContent="Aggiungi"; DOM.submitBtn.style.width='100%';
      DOM.transactionIdInput.value=""; DOM.cancelEditBtn.style.display='none'; DOM.formButtonsContainer.classList.remove('is-editing');
      DOM.transactionForm.reset(); document.getElementById('occurred_at').valueAsDate=new Date();
      document.querySelector(`input[name="transaction_type"][value="${TYPE_SINGLE}"]`).checked=true;
      DOM.recurringOptions.style.display='none';
      DOM.dueDateOptions.style.display='none';
      updateCategoryDropdown();
    }

    // Miglioria: La funzione ora ritorna i dati per essere usata con Promise.all
    async function loadTransactions(){
      const m = Number(DOM.monthSelector.value), y = Number(DOM.yearSelector.value);
      const start = new Date(y, m, 1);
      const end = new Date(y, m + 1, 0, 23, 59, 59);
      try {
        const { data, error } = await sb.from('transactions')
          .select(`*, categories(name, icon), subcategories(name, icon)`)
          .eq('created_by', user.id)
          .gte('occurred_at', start.toISOString())
          .lte('occurred_at', end.toISOString())
          .order('occurred_at', { ascending: false });
        if (error) throw error;
        return data || [];
      } catch (e) {
        console.error("Errore transazioni:", e);
        showModal('Errore', '<p>Impossibile caricare le transazioni.</p>', [{ text: 'Chiudi' }]);
        return []; // Ritorna array vuoto in caso di errore
      }
    }
    
    // Miglioria: Caricamento dati ottimizzato con Promise.all
    async function loadAllDataForMonth() {
      DOM.monthSelector.disabled = true;
      DOM.yearSelector.disabled = true;
      renderDashboard([]); // Pulisce la dashboard durante il caricamento
    
      const today = new Date();
      const future = new Date();
      future.setDate(today.getDate() + 30);
    
      try {
        const [transactions, imminent] = await Promise.all([
          loadTransactions(),
          getScheduledTransactions(today, future)
        ]);
    
        allTransactions = transactions; // Aggiorna lo stato globale
        renderDashboard(allTransactions);
    
        if (imminent.length) {
          DOM.deadlinesSection.style.display = 'block';
          renderDeadlinesList(DOM.deadlinesList, imminent);
        } else {
          DOM.deadlinesSection.style.display = 'none';
        }
        updateNotifications();
      } catch (e) {
        console.error("Errore nel caricamento dati del mese:", e);
      } finally {
        DOM.monthSelector.disabled = false;
        DOM.yearSelector.disabled = false;
      }
    }

    function handleEdit(id){
      const tx=allTransactions.find(t=>String(t.id)===String(id))||{};
      if(!tx.id){
        sb.from('transactions').select('*').eq('id',id).single().then(({data,error})=>{
          if(error||!data){ showModal('Errore','<p>Impossibile trovare la transazione da modificare.</p>',[{text:'Chiudi'}]); return; }
          populateAndShowEditForm(data);
        });
      }else{ populateAndShowEditForm(tx); }
    }
    function populateAndShowEditForm(tx){
      if(tx.is_recurring_parent){
        showModal('Azione non permessa','<p>La modifica delle operazioni ricorrenti non √® ancora supportata.</p>',[{text:'Ho capito'}]); return;
      }
      DOM.formTitle.textContent="‚úçÔ∏è Modifica Operazione"; DOM.submitBtn.textContent="Aggiorna"; DOM.submitBtn.style.width='auto';
      DOM.cancelEditBtn.style.display='inline-block'; DOM.formButtonsContainer.classList.add('is-editing');
      DOM.transactionIdInput.value=tx.id; DOM.kindSelect.value=tx.kind;
      document.getElementById('note').value=tx.note??''; document.getElementById('amount').value=safeToNumber(tx.amount);
      const dateToUse=tx.is_paid===false?tx.due_date:tx.occurred_at; document.getElementById('occurred_at').value=(dateToUse||'').split('T')[0]||'';
      const type=tx.is_paid===false?TYPE_SCHEDULED:TYPE_SINGLE;
      document.querySelector(`input[name="transaction_type"][value="${type}"]`).checked=true;
      if(type===TYPE_SCHEDULED){ DOM.dueDateOptions.style.display='grid'; document.getElementById('due_date').value=tx.due_date; }
      else DOM.dueDateOptions.style.display='none';
      updateCategoryDropdown(); DOM.categorySelect.value=tx.category_id ?? ''; updateSubcategories(tx.subcategory_id ?? null);
      window.scrollTo({top:0,behavior:'smooth'});
    }
    async function handleDelete(id){
      const { data:tx } = await sb.from('transactions').select('is_recurring_parent').eq('id',id).single();
      if(!tx) return;
      let msg = "<p>Sei sicuro di voler eliminare questa operazione?</p>";
      if(tx.is_recurring_parent) msg="<p>Questa √® un'operazione ricorrente. Eliminandola, verranno rimosse anche le occorrenze future non pagate.</p><p>Vuoi procedere?</p>";
      showModal('Conferma eliminazione',msg,[
        {text:'Annulla',class:'btn-secondary'},
        {text:'üóëÔ∏è Elimina',class:'delete',action:async()=>{
          try{
            if(tx.is_recurring_parent){ const { error:e1 } = await sb.from('transactions').delete().eq('parent_transaction_id',id); if(e1) throw e1; }
            const { error:e2 } = await sb.from('transactions').delete().eq('id',id); if(e2) throw e2;
            loadAllDataForMonth();
          }catch(e){ console.error("Errore eliminazione:",e); showModal('Errore','<p>Impossibile completare l\'eliminazione.</p>',[{text:'Chiudi'}]); }
        }}]);
    }
    async function handleFormSubmit(e){
      e.preventDefault();
      const fd=new FormData(DOM.transactionForm); const id=fd.get('transaction-id'); const kind=fd.get('kind');
      if(id){
        showModal('Conferma Aggiornamento',`<p>Sei sicuro di voler aggiornare questa ${kind===KIND_INCOME?'entrata':'spesa'}?</p>`,[
          {text:'Annulla',class:'btn-secondary'},
          {text:'Aggiorna',class:'btn-primary',action:()=>saveTransaction(fd)}
        ]);
      }else{ saveTransaction(fd); }
    }
    async function saveTransaction(fd){
      const id=fd.get('transaction-id'); const txType=fd.get('transaction_type');
      const payload={
        kind:fd.get('kind'), note:fd.get('note'), amount:fd.get('amount'), occurred_at:fd.get('occurred_at'),
        category_id:fd.get('category_id'), subcategory_id:fd.get('subcategory_id')||null,
        created_by:user.id, is_paid:true, due_date:null
      };
      if(txType===TYPE_SCHEDULED){
        const due=fd.get('due_date')||fd.get('occurred_at');
        if(!due){ showModal('Dati mancanti','<p>Seleziona una data valida.</p>',[{text:'Chiudi'}]); return; }
        payload.due_date=due; payload.is_paid=false; payload.occurred_at=due;
      }
      try{
        let error;
        if(txType===TYPE_RECURRING && !id){
          const endStr=fd.get('recurring_end_date'); if(!endStr){ showModal('Dati mancanti','<p>Seleziona una data di fine valida.</p>',[{text:'Chiudi'}]); return; }
          const endDate=new Date(endStr); payload.is_recurring_parent=true;
          const { data:parent, error:pe } = await sb.from('transactions').insert(payload).select().single(); if(pe) throw pe;
          const items=[]; let cur=new Date(payload.occurred_at); cur.setMonth(cur.getMonth()+1);
          while(cur<=endDate){ items.push({...payload,is_recurring_parent:false,parent_transaction_id:parent.id,occurred_at:new Date(cur).toISOString().split('T')[0]}); cur.setMonth(cur.getMonth()+1); }
          if(items.length){ const { error:ce } = await sb.from('transactions').insert(items); if(ce) error=ce; }
        }else{
          const q=id? sb.from('transactions').update(payload).eq('id',id) : sb.from('transactions').insert(payload);
          const { error:e } = await q; error=e;
        }
        if(error) throw error;

        if(payload.kind===KIND_INCOME && !id && txType!==TYPE_SCHEDULED) await showTransactionAnimation(KIND_INCOME);
        else if(payload.kind===KIND_EXPENSE && !id && txType!==TYPE_SCHEDULED) await showTransactionAnimation(KIND_EXPENSE);

        showStatusMessage(id?'Operazione aggiornata!':'Operazione aggiunta!','success');
        resetFormToCreateMode(); loadAllDataForMonth();
      }catch(e){ console.error("Errore salvataggio:",e); showModal('Errore di Salvataggio',`<p>Non √® stato possibile salvare l'operazione.</p><p><small>${e.message||e}</small></p>`,[{text:'Chiudi'}]); }
    }
    function handleDeadlineActions(e){
      const btn=e.target.closest('button[data-id]'); if(!btn) return;
      const id=btn.dataset.id; const isModal=btn.closest('.modal-overlay');
      if(btn.classList.contains('edit-btn')){ handleEdit(id); if(isModal) isModal.classList.remove(CLASS_VISIBLE); }
      else if(btn.classList.contains('delete-btn')) handleDelete(id);
      else if(btn.classList.contains('btn-action-deadline')){ handleConfirmDeadline(id); if(isModal) isModal.classList.remove(CLASS_VISIBLE); }
    }
    async function handleConfirmDeadline(id){
      showModal('Conferma Operazione','<p>Vuoi registrare questa operazione con la data di oggi?</p>',[
        {text:'Annulla',class:'btn-secondary'},
        {text:'Conferma',class:'btn-primary',action:async()=>{
          try{ const { error } = await sb.from('transactions').update({is_paid:true,occurred_at:new Date().toISOString().split('T')[0]}).eq('id',id); if(error) throw error; loadAllDataForMonth(); }
          catch(e){ console.error("Errore aggiornamento:",e); showModal('Errore','<p>Impossibile aggiornare l\'operazione.</p>',[{text:'Chiudi'}]); }
        }}]);
    }

    async function updateNotifications(){
      const today=new Date(); const future=new Date(); future.setDate(today.getDate()+7);
      const upcoming=await getScheduledTransactions(today,future);
      if(upcoming.length){ DOM.notificationBadge.textContent=upcoming.length; DOM.notificationBadge.classList.add(CLASS_VISIBLE); }
      else DOM.notificationBadge.classList.remove(CLASS_VISIBLE);
    }

    // ----- PAGE INITIALIZATION (Miglioria: Suddiviso in funzioni pi√π piccole) -----
    
    /** Popola i selettori di data (mese e anno) */
    function populateDateSelectors() {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();
        
        MONTHS.forEach((m, i) => DOM.monthSelector.add(new Option(m, i)));
        for (let y = currentYear - 2; y <= currentYear + 5; y++) {
            DOM.yearSelector.add(new Option(y, y));
        }
        
        DOM.monthSelector.value = currentMonth;
        DOM.yearSelector.value = currentYear;
        document.getElementById('occurred_at').valueAsDate = new Date();
    }
    
    /** Associa tutti gli event listener agli elementi del DOM */
    function setupEventListeners() {
      DOM.kindSelect.addEventListener('change', updateCategoryDropdown);
      DOM.categorySelect.addEventListener('change', () => updateSubcategories());
      DOM.transactionForm.addEventListener('submit', handleFormSubmit);
      DOM.cancelEditBtn.addEventListener('click', resetFormToCreateMode);
      DOM.logoutBtn.addEventListener('click', async (e) => { e.preventDefault(); await sb.auth.signOut(); location.replace('/it/'); });
      DOM.monthSelector.addEventListener('change', loadAllDataForMonth);
      DOM.yearSelector.addEventListener('change', loadAllDataForMonth);

      DOM.dashboardPanel.addEventListener('click', (ev) => {
        const t = ev.target.closest('.action-btn'); if (!t) return;
        const id = t.dataset.id;
        if (t.classList.contains('edit-btn')) handleEdit(id);
        else if (t.classList.contains('delete-btn')) handleDelete(id);
      });

      DOM.deadlinesList.addEventListener('click', handleDeadlineActions);
      DOM.schedulerModal.addEventListener('click', handleDeadlineActions);

      DOM.listMovementsBtn.addEventListener('click', (e) => {
        e.preventDefault();
        renderMovementsListModal(allTransactions, MONTHS);
        DOM.movementsModal.classList.add(CLASS_VISIBLE);
      });

      document.querySelectorAll('input[name="transaction_type"]').forEach(r => r.addEventListener('change', e => {
        DOM.recurringOptions.style.display = e.target.value === TYPE_RECURRING ? 'grid' : 'none';
        DOM.dueDateOptions.style.display = e.target.value === TYPE_SCHEDULED ? 'grid' : 'none';
      }));

      DOM.schedulerBtn.addEventListener('click', async () => {
        const m = DOM.monthSelector.value, y = DOM.yearSelector.value;
        const start = new Date(y, m, 1);
        const end = new Date(y, Number(m) + 1, 0);
        const scheduled = await getScheduledTransactions(start, end);
        DOM.schedulerModal.querySelector('.modal-title').textContent = `Scadenziario per ${MONTHS[m]} ${y}`;
        renderDeadlinesList(DOM.schedulerModal.querySelector('.modal-body'), scheduled);
        DOM.schedulerModal.classList.add(CLASS_VISIBLE);
      });

      DOM.notificationsBtn.addEventListener('click', async () => {
        const today = new Date();
        const future = new Date();
        future.setDate(today.getDate() + 7);
        const upcoming = await getScheduledTransactions(today, future);
        DOM.schedulerModal.querySelector('.modal-title').textContent = `Notifiche (Prossimi 7 giorni)`;
        renderDeadlinesList(DOM.schedulerModal.querySelector('.modal-body'), upcoming);
        DOM.schedulerModal.classList.add(CLASS_VISIBLE);
      });

      document.body.addEventListener('click', (e) => {
        const modal = e.target.closest('.modal-overlay');
        if (modal && (e.target.classList.contains('modal-overlay') || e.target.closest('.modal-close'))) {
          modal.classList.remove(CLASS_VISIBLE);
        }
      });
      
      if (DOM.mobileMenuBtn && DOM.topActions) {
        DOM.mobileMenuBtn.addEventListener('click', (e) => { e.stopPropagation(); DOM.topActions.classList.toggle('is-open'); });
        document.addEventListener('click', (e) => { if (!DOM.topActions.contains(e.target) && !DOM.mobileMenuBtn.contains(e.target)) DOM.topActions.classList.remove('is-open'); });
      }
    }
    
    /** Funzione principale di avvio della pagina */
    async function initializePage() {
      // 1. Verifica sessione e profilo utente
      const { data: { session: currentSession } } = await sb.auth.getSession();
      if (!currentSession) { location.replace('/it/login.html'); return; }
      user = currentSession.user;

      const { data: profile } = await sb.from('profiles').select('onboarded').eq('id', user.id).single();
      if (profile && !profile.onboarded) { location.replace('/it/onboarding.html'); return; }

      // 2. Setup della UI statica
      populateDateSelectors();

      // 3. Carica dati essenziali per il form
      await loadInitialData();
      updateCategoryDropdown();

      // 4. Carica i dati principali in parallelo per velocit√† (Miglioria)
      await Promise.all([
          loadGoals(),
          loadAllDataForMonth()
      ]);
      
      // 5. Attacca tutti gli event listeners
      setupEventListeners();
    }

    // Avvia l'applicazione quando il DOM √® pronto
    document.addEventListener('DOMContentLoaded', initializePage);
  </script>
</body>
</html>
