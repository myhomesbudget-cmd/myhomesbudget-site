<!doctype html><meta charset="utf-8">
<title>Reindirizzamentoâ€¦</title>
<meta name="robots" content="noindex">
<style>body{font-family:system-ui;margin:40px;text-align:center}</style>

<script type="module">
  import { supabase } from "/it/supabase-client.js";

  const lang = (localStorage.getItem('mhb_lang') || 'it');
  const go = (p) => location.replace(`/${lang}/${p}.html`);

  try {
    // Piccolo delay: consente a Supabase di completare l'handshake del magic link
    await new Promise(r => setTimeout(r, 50));

    const { data:{ session } } = await supabase.auth.getSession();
    if (!session?.user) return go('login');

    const uid = session.user.id;

    // 1) Sorgente primaria: localStorage
    let completed = (localStorage.getItem('onboarding_completed') === '1');

    // 2) Fallback opzionale: Supabase (se hai creato la tabella onboarding_settings)
    if (!completed) {
      try {
        const { data: onb, error } = await supabase
          .from('onboarding_settings')
          .select('completed')
          .eq('user_id', uid)
          .single();

        if (!error && onb?.completed) {
          completed = true;
          try { localStorage.setItem('onboarding_completed', '1'); } catch(e){}
        }
      } catch(e) {
        // Tabella non esiste o altro errore: ignora e prosegui verso onboarding
      }
    }

    return completed ? go('dashboard') : go('onboarding');
  } catch (e) {
    go('login');
  }
</script>
