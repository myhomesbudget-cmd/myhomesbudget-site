<!DOCTYPE html>
<html lang="it" data-app="myhomesbudget">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Il Tuo Profilo â€” MyHomesBudget</title>
    <meta name="robots" content="noindex, nofollow" />
    <link rel="icon" href="/homes.png" type="image/png" sizes="32x32">

    <!-- Stile unificato dall'app -->
    <style>
      :root{
        --fg:#111;--bg:#f4f7fa;--glass:rgba(255,255,255,.6);
        --card-border:rgba(0,0,0,.08);--shadow:0 10px 30px rgba(0,0,0,.08);
        --radius-lg:16px;--primary-color:#6c5ce7;--danger-color:#d32f2f;--success-color:#2e7d32;
        --warning-color:#f39c12;
        --font-sans:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif;
        --grad:linear-gradient(135deg,#6c5ce7,#00cec9);
        --grad-danger:linear-gradient(135deg,#d32f2f,#ff7675);
      }
      *{box-sizing:border-box}
      html{font-family:var(--font-sans);background-color:var(--bg)}
      body{margin:0;color:var(--fg);background:url("/bg.webp") no-repeat center/cover fixed;min-height:100vh}
      body::before{content:"";position:fixed;inset:0;background:linear-gradient(135deg,rgba(108,92,231,.05),rgba(0,206,201,.05));z-index:-1}

      /* ====== TOPBAR ====== */
      .topbar{position:fixed;top:0;left:0;right:0;height:60px;padding:0 24px;display:flex;align-items:center;justify-content:space-between;background:var(--glass);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-bottom:1px solid var(--card-border);z-index:100}
      .logo-link{display:flex;align-items:center;gap:8px;text-decoration:none}
      .logo-text{font-weight:600;color:#333;font-size:1.1rem;text-shadow:0 1px 2px rgba(255,255,255,.5)}
      .top-actions{display:flex;gap:12px;align-items:center}
      .top-link,.top-btn{display:flex;align-items:center;justify-content:center;height:34px;color:#fff;text-decoration:none;padding:6px 12px;border-radius:10px;font-size:.9rem;font-weight:600;background:var(--grad);border:none;box-shadow:0 4px 12px rgba(0,0,0,.15);transition:transform .2s ease,filter .2s ease,box-shadow .2s ease;cursor:pointer}
      .top-link:hover,.top-btn:hover{transform:translateY(-2px);filter:brightness(1.08);box-shadow:0 6px 16px rgba(0,0,0,.20)}
      .mobile-menu-toggle{display:none;background:var(--grad);border:none;border-radius:10px;width:40px;height:38px;cursor:pointer;padding:0;z-index:101;box-shadow:0 4px 12px rgba(0,0,0,.15)}
      .mobile-menu-toggle svg{width:24px;height:24px;stroke:#fff;stroke-width:2.5;stroke-linecap:round}

      @media (max-width:960px){
        .mobile-menu-toggle{display:block}
        .top-actions{position:fixed;top:70px;right:16px;background:rgba(255,255,255,0.9);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-radius:var(--radius-lg);box-shadow:var(--shadow);padding:16px;flex-direction:column;gap:16px;align-items:stretch;width:220px;transform:translateY(-20px) scale(.95);opacity:0;pointer-events:none;transition:transform .2s ease-out,opacity .2s ease-out;z-index:100;border:1px solid var(--card-border)}
        .top-actions.is-open{transform:translateY(0) scale(1);opacity:1;pointer-events:auto}
        .top-actions .top-link,.top-actions .top-btn{width:100%;text-align:center;}
      }

      /* ====== Contenuto Principale ====== */
      main.container{padding:84px 24px 24px;max-width:1280px;margin:0 auto;width:100%}
      .dash-nav{display:flex;flex-wrap: wrap;gap:8px;border-bottom:1px solid rgba(0,0,0,.1);padding-bottom:12px;margin-bottom:24px}
      .dash-nav a{text-decoration:none;padding:8px 16px;border-radius:10px;font-weight:600;transition:all .2s ease;background:rgba(255,255,255,.7);color:var(--fg);border:1px solid var(--card-border);box-shadow:0 4px 12px rgba(0,0,0,.05);}
      .dash-nav a:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,.1)}
      .dash-nav a.is-active{background:var(--grad);color:#fff;box-shadow:0 6px 16px rgba(0,0,0,.20),inset 0 1px 2px rgba(255,255,255,0.2)}
      
      .dashboard-panel{background:rgba(255,255,255,0.55);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border-radius:var(--radius-lg);padding:24px;border:1px solid var(--card-border);box-shadow:var(--shadow); max-width: 800px; margin: 0 auto;}

      /* Stili specifici per la pagina profilo */
      .profile-header{display:flex;flex-direction:column;align-items:center;text-align:center;margin-top:-90px;}
      .profile-avatar{position:relative;width:128px;height:128px;border:4px solid rgba(255,255,255,0.8);border-radius:50%;box-shadow:var(--shadow);}
      .profile-avatar img{width:100%;height:100%;border-radius:50%;object-fit:cover;}
      .profile-avatar label{position:absolute;inset:0;background:rgba(0,0,0,0.5);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;opacity:0;transition:opacity .2s ease;}
      .profile-avatar label:hover{opacity:1;}
      .profile-avatar input{display:none;}
      .profile-name{font-size:2rem;font-weight:700;margin:16px 0 8px;}
      .profile-plan{font-size:0.9rem;font-weight:700;color: var(--primary-color);background:rgba(255,255,255,0.9);padding:6px 16px;border-radius:999px;border:1px solid var(--card-border);}

      .profile-content{margin-top:40px;display:grid;gap:30px;}
      .profile-section-title{text-align:center;font-weight:600;color:#555;margin-bottom:12px;font-size:0.9rem;text-transform:uppercase;letter-spacing:1px;}
      .profile-info-row{display:flex;justify-content:space-between;align-items:center;background:rgba(255,255,255,0.7);border:1px solid var(--card-border);border-radius:12px;padding:12px 16px;}
      .info-label{font-weight:600;color:#444;}
      .info-value{font-weight:500;font-size:1.1rem;}

      .personal-info-grid{display:grid;grid-template-columns:1fr;gap:12px;}
      @media(min-width: 640px) { .personal-info-grid{grid-template-columns:1fr 1fr;} }
      .info-field{background:rgba(255,255,255,0.7);border:1px solid var(--card-border);border-radius:12px;padding:12px;}
      .info-field label{font-size:0.8rem;font-weight:600;color:#666;display:block;margin-bottom:4px;}
      .info-field .data-display{font-size:1.1rem;font-weight:500;color:#333;min-height:24px;} /* min-height evita scatti del layout */
      .info-field .data-display.is-empty{color:#888;font-style:italic;}
      .info-field .data-input{display:none;width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;background:#fff;font-size:1rem;font-family:var(--font-sans);}

      .profile-actions{display:flex;justify-content:center;gap:16px;margin-top:32px;}
      .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 24px;font-weight:800;font-size:1rem;transition:transform .2s ease,filter .2s ease,box-shadow .2s ease}
      .btn:hover:not(:disabled){transform:translateY(-2px);filter:brightness(1.08)}
      .btn:disabled{opacity:.6;cursor:not-allowed;}
      .btn-primary{background:var(--grad);color:#fff;box-shadow:0 10px 24px rgba(0,0,0,.18)}
      .btn-primary:hover:not(:disabled){box-shadow:0 14px 28px rgba(0,0,0,.22)}
      .btn-secondary{background:#f0f0f0;color:#555;border:1px solid #ddd;box-shadow:0 4px 8px rgba(0,0,0,0.05)}
      .btn-secondary:hover:not(:disabled){background:#e5e5e5;border-color:#ccc;color:#333}
      #save-button{display:none;}
    </style>
</head>
<body>
    <nav class="topbar">
      <a href="/it/dashboard.html" class="logo-link">
          <img src="/homes.png" alt="Logo" style="height:32px;border-radius:6px">
          <span class="logo-text">MyHomesBudget</span>
      </a>
      <div class="top-nav-right">
          <button id="mobile-menu-btn" class="mobile-menu-toggle" aria-label="Apri menu">
              <svg viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
          </button>
          <div class="top-actions">
              <a href="/it/onboarding.html?edit=1" class="top-link">ðŸŽ¯ Obiettivo</a>
              <a href="#" id="logout-btn" class="top-link">Esci</a>
          </div>
      </div>
    </nav>

    <main class="container">
        <nav id="dash-nav" class="dash-nav">
          <a href="/it/dashboard.html">Operazioni</a>
          <a href="/it/dashboard-riepilogo.html">Riepilogo</a>
          <a href="/it/profile.html" class="is-active" aria-current="page">Profilo</a>
        </nav>

        <div class="dashboard-panel">
            <div class="profile-header">
                <div class="profile-avatar">
                    <img id="profile-pic" src="https://placehold.co/128x128/eeeeee/333333?text=..." alt="Immagine del profilo">
                    <label for="avatar-upload">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>
                        <input type="file" id="avatar-upload" accept="image/*">
                    </label>
                </div>
                <h1 id="user-name" class="profile-name">Caricamento...</h1>
                <div id="plan-type" class="profile-plan">...</div>
            </div>

            <div class="profile-content">
                <section>
                    <div class="profile-info-row">
                        <span class="info-label">Mail di Registrazione</span>
                        <span id="user-email" class="info-value">...</span>
                    </div>
                </section>

                <section>
                  <h2 class="profile-section-title">Dettagli</h2>
                  <div style="display:grid; gap:12px;">
                    <div class="profile-info-row">
                        <span class="info-label">Abbonamento</span>
                        <span id="plan-type-detail" class="info-value">...</span>
                    </div>
                    <div class="profile-info-row">
                        <span class="info-label">Obiettivo Configurato</span>
                        <span id="goal-name" class="info-value">...</span>
                    </div>
                  </div>
                </section>

                <section>
                    <h2 class="profile-section-title">Informazioni Personali</h2>
                    <div id="personal-info-form" class="personal-info-grid">
                        <div class="info-field">
                            <label>Genere</label>
                            <div class="data-display is-empty">...</div>
                            <select class="data-input" id="gender-input">
                                <option value="">Non specificato</option>
                                <option value="Uomo">Uomo</option>
                                <option value="Donna">Donna</option>
                                <option value="Altro">Altro</option>
                            </select>
                        </div>
                        <div class="info-field">
                            <label>Data di Nascita</label>
                            <div class="data-display is-empty">...</div>
                            <input type="date" class="data-input" id="birthdate-input">
                        </div>
                        <div class="info-field">
                            <label>Paese</label>
                            <div class="data-display is-empty">...</div>
                            <input type="text" placeholder="Es. Italia" class="data-input" id="country-input">
                        </div>
                        <div class="info-field">
                            <label>Numero di Telefono</label>
                            <div class="data-display is-empty">...</div>
                            <input type="tel" placeholder="Es. +39 123..." class="data-input" id="phone-input">
                        </div>
                    </div>
                </section>

                <div class="profile-actions">
                    <button id="edit-button" class="btn btn-secondary">Modifica</button>
                    <button id="save-button" class="btn btn-primary">Salva Modifiche</button>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { supabase } from "/it/supabase-client.js";
        
        // --- VARIABILI GLOBALI ---
        let currentUser = null;
        const emptyPlaceholder = 'Non impostato';

        // --- FUNZIONI DI RENDER ---
        function renderProfileData(profile, details) {
            // Dati dalla tabella 'profiles'
            document.getElementById('user-name').textContent = profile?.name || 'Utente';
            document.getElementById('plan-type').textContent = profile?.plan_type || 'STANDARD';
            document.getElementById('user-email').textContent = currentUser?.email || '...';
            document.getElementById('plan-type-detail').textContent = profile?.plan_type || 'STANDARD';
            document.getElementById('goal-name').textContent = profile?.goal_name || 'Nessun obiettivo';
            document.getElementById('profile-pic').src = profile?.avatar_url || `https://placehold.co/128x128/6c5ce7/FFFFFF?text=${(profile?.name || 'U').charAt(0)}`;
            
            // Dati dalla tabella 'personal_details'
            const form = document.getElementById('personal-info-form');
            const detailsData = details || {}; // Oggetto vuoto se i dettagli sono null

            const genderDisplay = form.querySelector('.info-field:nth-child(1) .data-display');
            genderDisplay.textContent = detailsData.gender || emptyPlaceholder;
            genderDisplay.classList.toggle('is-empty', !detailsData.gender);
            document.getElementById('gender-input').value = detailsData.gender || '';

            const birthdateDisplay = form.querySelector('.info-field:nth-child(2) .data-display');
            birthdateDisplay.textContent = detailsData.birthdate ? new Date(detailsData.birthdate).toLocaleDateString('it-IT') : 'Non impostata';
            birthdateDisplay.classList.toggle('is-empty', !detailsData.birthdate);
            document.getElementById('birthdate-input').value = detailsData.birthdate || '';

            const countryDisplay = form.querySelector('.info-field:nth-child(3) .data-display');
            countryDisplay.textContent = detailsData.country || emptyPlaceholder;
            countryDisplay.classList.toggle('is-empty', !detailsData.country);
            document.getElementById('country-input').value = detailsData.country || '';

            const phoneDisplay = form.querySelector('.info-field:nth-child(4) .data-display');
            phoneDisplay.textContent = detailsData.phone || emptyPlaceholder;
            phoneDisplay.classList.toggle('is-empty', !detailsData.phone);
            document.getElementById('phone-input').value = detailsData.phone || '';
        }

        // --- LOGICA DI INTERAZIONE ---
        async function saveUserData() {
            if (!currentUser) return;
            
            const saveButton = document.getElementById('save-button');
            saveButton.disabled = true;
            saveButton.textContent = 'Salvataggio...';

            const dataToSave = {
                id: currentUser.id, // Chiave primaria per l'upsert
                gender: document.getElementById('gender-input').value || null,
                birthdate: document.getElementById('birthdate-input').value || null,
                country: document.getElementById('country-input').value || null,
                phone: document.getElementById('phone-input').value || null,
            };
            
            // Usa upsert per inserire se non esiste, o aggiornare se esiste
            const { data, error } = await supabase
                .from('personal_details')
                .upsert(dataToSave)
                .select()
                .single();

            saveButton.disabled = false;
            saveButton.textContent = 'Salva Modifiche';

            if (error) {
                console.error('Errore durante il salvataggio:', error);
                alert('Si Ã¨ verificato un errore. Riprova.');
                return;
            }

            console.log("Dati salvati con successo!", data);
            
            // Aggiorna la UI con i dati del profilo e i nuovi dettagli salvati
            const { data: currentProfile } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
            renderProfileData(currentProfile, data);

            toggleEditMode(false);
        }

        function toggleEditMode(isEditing) {
            const infoFields = document.querySelectorAll('.info-field');
            document.getElementById('edit-button').style.display = isEditing ? 'none' : 'block';
            document.getElementById('save-button').style.display = isEditing ? 'block' : 'none';

            infoFields.forEach(field => {
                field.querySelector('.data-display').style.display = isEditing ? 'none' : 'block';
                field.querySelector('.data-input').style.display = isEditing ? 'block' : 'none';
            });
        }
        
        // --- INIZIALIZZAZIONE PAGINA ---
        async function initializePage() {
            // 1. Controlla l'autenticazione dell'utente
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();
            if (sessionError || !session) {
                window.location.href = '/it/login.html';
                return;
            }
            currentUser = session.user;

            // 2. Carica i dati in parallelo da 'profiles' e 'personal_details'
            const [profileResponse, detailsResponse] = await Promise.all([
                supabase.from('profiles').select('*').eq('id', currentUser.id).single(),
                supabase.from('personal_details').select('*').eq('id', currentUser.id).single()
            ]);

            // Gestione errori di caricamento
            if (profileResponse.error && profileResponse.error.code !== 'PGRST116') {
                 console.error("Errore caricamento profilo:", profileResponse.error);
                 alert("Impossibile caricare il profilo.");
                 return;
            }
             if (detailsResponse.error && detailsResponse.error.code !== 'PGRST116') {
                 console.error("Errore caricamento dettagli personali:", detailsResponse.error);
            }
            
            // 3. Mostra i dati caricati sulla pagina
            renderProfileData(profileResponse.data, detailsResponse.data);

            // 4. Aggiungi gli event listener
            document.getElementById('edit-button').addEventListener('click', () => toggleEditMode(true));
            document.getElementById('save-button').addEventListener('click', saveUserData);
            document.getElementById('logout-btn').addEventListener('click', async (e) => { 
                e.preventDefault(); 
                await supabase.auth.signOut(); 
                window.location.href = "/it/"; 
            });

            // Gestione menu mobile
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const topActions = document.querySelector('.top-actions');
            if (mobileMenuBtn && topActions) {
              mobileMenuBtn.addEventListener('click', (e) => { e.stopPropagation(); topActions.classList.toggle('is-open'); });
              document.addEventListener('click', (e) => { if (!topActions.contains(e.target) && !mobileMenuBtn.contains(e.target)) { topActions.classList.remove('is-open'); } });
            }
        }

        // Avvia l'inizializzazione al caricamento del DOM
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
