<!doctype html>
<html lang="it" data-app="myhomesbudget">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard — MyHomesBudget</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" href="/favicon.ico" />

  <style>
    :root{
      /* Theme */
      --fg:#0f1220; --fg-soft:#4b5563; --bg:#f4f7fa;
      --primary:#6c5ce7; --primary-ink:#fff;
      --danger:#dc3545; --success:#2e7d32;
      --glass: rgba(255,255,255,.62); --glass-strong: rgba(255,255,255,.86);
      --card-border: rgba(15,18,32,.08); --shadow: 0 12px 32px rgba(15,18,32,.10);
      --radius:16px; --radius-sm:10px;
      --font:-apple-system,system-ui,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      --focus: 0 0 0 3px rgba(108,92,231,.25);
    }
    *{box-sizing:border-box}
    html{font-family:var(--font);background-color:var(--bg)}
    body{
      margin:0; color:var(--fg);
      background:url("/bg.webp") no-repeat center/cover fixed;
      min-height:100vh;
    }
    body::before{
      content:""; position:fixed; inset:0; z-index:-1;
      background:
        radial-gradient(1200px 800px at 10% 20%, rgba(108,92,231,.10), transparent 60%),
        radial-gradient(1000px 900px at 90% 80%, rgba(0,206,201,.10), transparent 55%);
      mix-blend-mode:multiply;
    }

    /* ===== Topbar glass (coerente con riepilogo) ===== */
    .topbar{
      position:fixed; inset:0 0 auto 0; height:64px; padding:0 20px;
      display:flex; align-items:center; justify-content:space-between;
      background:var(--glass); backdrop-filter:blur(12px) saturate(1.1);
      -webkit-backdrop-filter:blur(12px) saturate(1.1);
      border-bottom:1px solid var(--card-border); z-index:50;
    }
    .logo-link{display:flex; align-items:center; gap:10px; text-decoration:none}
    .logo-link img{height:32px; border-radius:8px}
    .logo-text{font-weight:700; color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.35)}
    .top-actions{display:flex; gap:10px; align-items:center}
    .top-link{
      color:#fff; text-decoration:none; padding:8px 12px; border-radius:12px;
      background:rgba(0,0,0,.28); border:1px solid rgba(255,255,255,.25); font-weight:700;
    }
    .top-link:hover{background:rgba(0,0,0,.38)}
    #month-selector{
      background:var(--glass-strong); border:1px solid var(--card-border);
      padding:6px 10px; border-radius:10px; font-weight:700;
    }

    /* Centratura banner trial */
    .top-center{position:absolute; left:50%; transform:translateX(-50%); display:flex; align-items:center}
    #trial-banner{
      display:none; align-items:center; gap:10px;
      background:linear-gradient(135deg,#6c5ce7,#00cec9); color:#fff;
      padding:8px 12px; border-radius:999px; font-weight:800;
      box-shadow:0 8px 24px rgba(0,0,0,.16);
    }
    #trial-banner a{
      background:#fff; color:var(--primary); text-decoration:none;
      padding:4px 10px; border-radius:999px; font-size:.85rem; font-weight:900;
    }

    /* ===== Layout ===== */
    main.container{ width:min(1080px,calc(100% - 40px)); margin:92px auto 24px; }
    .dash-nav{ display:flex; gap:8px; padding-bottom:10px; margin-bottom:16px; border-bottom:1px solid var(--card-border); }
    .dash-nav a{ text-decoration:none; color:var(--fg-soft); padding:8px 14px; border-radius:12px; font-weight:800 }
    .dash-nav a.is-active{ background:var(--glass-strong); color:var(--primary); border:1px solid var(--card-border); box-shadow:var(--shadow) }

    .card{
      background:var(--glass-strong);
      border:1px solid var(--card-border); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:16px;
    }
    .card h2{ margin:0 0 6px }
    .muted{ color:var(--fg-soft) }

    /* ===== Form ===== */
    .transaction-form{ display:grid; gap:12px; grid-template-columns: 1fr 1fr; align-items:flex-end; }
    @media(min-width:900px){ .transaction-form{ grid-template-columns: repeat(3,1fr) auto } }
    .form-group{ display:flex; flex-direction:column }
    .form-group.full-width{ grid-column:1 / -1 }
    .form-group label{ font-weight:800; font-size:.9rem; color:var(--fg-soft); margin-bottom:6px }
    .form-group input, .form-group select{
      background:#fff; border:1px solid rgba(15,18,32,.14); border-radius:12px;
      padding:12px 12px; font-size:1rem; outline:none;
    }
    .form-group input:focus, .form-group select:focus{ box-shadow: var(--focus); border-color: transparent; }
    .btn{
      cursor:pointer; border:none; border-radius:14px; padding:14px 18px;
      font-weight:900; transition:transform .06s ease, filter .2s ease;
    }
    .btn:active{ transform:translateY(1px) }
    .btn-primary{ background:var(--primary); color:var(--primary-ink); box-shadow:0 10px 24px rgba(108,92,231,.25) }
    .btn-primary[disabled]{ opacity:.6; cursor:not-allowed }

    /* ===== Lista ===== */
    .transaction-list .item{
      display:grid; grid-template-columns: auto 1fr auto auto; gap:12px;
      align-items:center; padding:12px 6px; border-bottom:1px solid rgba(15,18,32,.06);
      animation:fadeIn .25s ease;
    }
    @keyframes fadeIn{ from{opacity:.0; transform:translateY(-3px)} to{opacity:1; transform:translateY(0)} }
    .item-icon{ font-size:1.4rem; width:28px; text-align:center; }
    .item-details{ min-width:0 }
    .item-details .note{ font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .item-details .category{ font-size:.9rem; color:var(--fg-soft); white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .item-amount{ font-variant-numeric:tabular-nums; font-weight:900; text-align:right; min-width:110px }
    .item-amount.expense{ color:var(--danger) }
    .item-amount.income{ color:var(--success) }
    .item-actions{ display:flex; gap:6px }
    .action-btn{
      background:#fff; color:#222; border:1px solid rgba(15,18,32,.12);
      border-radius:10px; padding:7px 11px; font-size:.85rem; font-weight:800; cursor:pointer;
    }
    .action-btn:hover{ background:var(--primary); color:#fff; border-color:var(--primary) }
    .action-btn.delete{ background:#fde2e6; color:#b02a37; border-color:#f9c2c8 }
    .action-btn.delete:hover{ background:var(--danger); color:#fff; border-color:var(--danger) }
    .empty-state{ text-align:center; padding:40px; color:var(--fg-soft) }

    /* ===== Toast ===== */
    .toast{ position:fixed; left:50%; bottom:24px; transform:translateX(-50%);
      display:none; z-index:60; }
    .toast .msg{ background:#111; color:#fff; padding:12px 16px; border-radius:12px; font-weight:900; box-shadow:0 10px 24px rgba(0,0,0,.25) }
    .show{ display:block }

    /* Micro badge per stato/modifica */
    .pill{
      background:rgba(0,0,0,.04); border:1px solid rgba(0,0,0,.08);
      padding:6px 10px; border-radius:999px; font-weight:800; font-size:.85rem;
    }
  </style>
</head>
<body>
  <!-- Topbar -->
  <nav class="topbar">
    <a href="/it/" class="logo-link">
      <img src="/homes.png" alt="Logo"><span class="logo-text">MyHomesBudget</span>
    </a>

    <div class="top-center">
      <div id="trial-banner">
        <span id="trial-days-left"></span>
        <a href="/it/paywall.html">Aggiorna piano</a>
      </div>
    </div>

    <div class="top-actions">
      <select id="month-selector" aria-label="Seleziona mese"></select>
      <a href="/it/dashboard.html" class="top-link">Operazioni</a>
      <a href="/it/onboarding.html?edit=1" class="top-link">Impostazioni</a>
      <a href="#" id="logout-btn" class="top-link">Esci</a>
    </div>
  </nav>

  <main class="container">
    <nav id="dash-nav" class="dash-nav">
      <a href="/it/dashboard.html" class="is-active" aria-current="page">Operazioni</a>
      <a href="/it/dashboard-riepilogo.html">Riepilogo</a>
    </nav>

    <!-- Card: Form -->
    <section class="card">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:6px">
        <h2 id="form-title" style="margin:0">Nuova Transazione</h2>
        <span id="form-status" class="pill" style="display:none">Modifica</span>
      </div>

      <form id="transaction-form" class="transaction-form" autocomplete="off">
        <input type="hidden" id="transaction-id" name="transaction-id">

        <div class="form-group full-width">
          <label for="kind">Tipo</label>
          <select id="kind" name="kind" required>
            <option value="expense">Uscita</option>
            <option value="income">Entrata</option>
            <option value="transfer">Trasferimento</option>
          </select>
        </div>

        <div class="form-group full-width">
          <label for="note">Nota</label>
          <input type="text" id="note" name="note" placeholder="Es. Caffè al bar" required>
        </div>

        <div class="form-group">
          <label for="amount">Importo (€)</label>
          <input type="number" id="amount" name="amount" step="0.01" placeholder="0,00" required>
        </div>

        <div class="form-group">
          <label for="occurred_at">Data</label>
          <input type="date" id="occurred_at" name="occurred_at" required>
        </div>

        <div class="form-group">
          <label for="category_id">Categoria</label>
          <select id="category_id" name="category_id" required>
            <option value="">Scegli categoria…</option>
          </select>
        </div>

        <div class="form-group">
          <label for="subcategory_id">Sottocategoria</label>
          <select id="subcategory_id" name="subcategory_id">
            <option value="">Nessuna</option>
          </select>
        </div>

        <button type="submit" class="btn btn-primary" style="grid-column:1 / -1; margin-top:6px">
          <span id="btn-text">Aggiungi</span>
        </button>
      </form>
    </section>

    <!-- Card: Lista -->
    <section class="card" style="margin-top:16px">
      <h2 style="margin:0 0 8px">Movimenti Recenti</h2>
      <div id="transaction-list" class="transaction-list">
        <div class="empty-state"><p>Nessuna transazione registrata.</p></div>
      </div>
    </section>
  </main>

  <!-- Toast minimalista -->
  <div class="toast" id="toast"><div class="msg" id="toast-msg">Fatto</div></div>

  <script type="module">
    /*
      Nota importante:
      - Mantengo TUTTI gli id e la logica esistente (Supabase, filtri, eventi).
      - Aggiungo solo micro-UX (toast, loading sul bottone, badge "Modifica").
      - Coerenza visiva: stessa topbar e glass del riepilogo.
    */
    import { supabase } from "/it/supabase-client.js";

    const transactionForm = document.getElementById('transaction-form');
    const kindSelect = document.getElementById('kind');
    const categorySelect = document.getElementById('category_id');
    const subcategorySelect = document.getElementById('subcategory_id');
    const transactionIdInput = document.getElementById('transaction-id');
    const formTitle = document.getElementById('form-title');
    const formStatus = document.getElementById('form-status');
    const transactionList = document.getElementById('transaction-list');
    const logoutBtn = document.getElementById('logout-btn');
    const toastEl = document.getElementById('toast');
    const toastMsg = document.getElementById('toast-msg');
    const btnText = document.getElementById('btn-text');

    let user = null;
    let allCategories = [];
    let allSubcategories = [];
    let allTransactions = [];

    /* ---------- Micro-helpers UI ---------- */
    const nfmt = new Intl.NumberFormat('it-IT', { minimumFractionDigits:2, maximumFractionDigits:2 });
    const showToast = (msg)=>{ toastMsg.textContent = msg; toastEl.classList.add('show'); setTimeout(()=> toastEl.classList.remove('show'), 1600); };
    const setBusy = (busy)=>{ btnText.textContent = busy ? 'Salvataggio…' : (transactionIdInput.value ? 'Salva modifiche' : 'Aggiungi'); transactionForm.querySelector('button[type="submit"]').disabled = !!busy; };
    const safeToNumber = (v)=> Number.isFinite(v) ? v : Number.parseFloat(v ?? 0) || 0;

    /* ---------- Trial banner (coerente col riepilogo) ---------- */
    function handleTrialStatus(profile){
      const banner = document.getElementById('trial-banner');
      const text = document.getElementById('trial-days-left');
      if (!profile || profile.plan_type !== 'trial' || !profile.trial_end){ banner.style.display='none'; return; }
      const trialEnd = new Date(profile.trial_end);
      const today = new Date(); today.setHours(0,0,0,0);
      const diffDays = Math.ceil((trialEnd.getTime() - today.getTime()) / 86400000);
      if (diffDays >= 0){
        banner.style.display = 'flex';
        text.textContent = diffDays === 0 ? "Ultimo giorno di prova!"
          : diffDays === 1 ? "Manca 1 giorno alla fine della prova."
          : `Mancano ${diffDays} giorni alla fine della prova.`;
      }else{
        alert("La tua prova è terminata. Scegli un piano per continuare.");
        location.replace("/it/paywall.html");
      }
    }

    /* ---------- Data layer invariato ---------- */
    async function loadInitialData(){
      const { data: categories, error: cError } =
        await supabase.from('categories').select('*').eq('created_by', user.id);
      if (cError){ console.error("Errore categorie:", cError); return; }
      allCategories = categories || [];

      if (allCategories.length){
        const ids = allCategories.map(c => c.id);
        const { data: subcategories, error: sError } =
          await supabase.from('subcategories').select('*').in('category_id', ids);
        if (sError){ console.error("Errore sottocategorie:", sError); return; }
        allSubcategories = subcategories || [];
      }
    }

    function updateCategoryDropdown(){
      const selectedKind = kindSelect.value;
      const filtered = allCategories.filter(cat => cat.kind === selectedKind);
      categorySelect.innerHTML = '<option value="">Scegli categoria…</option>';
      filtered.forEach(cat => categorySelect.add(new Option(`${cat.icon ?? ''} ${cat.name}`, cat.id)));
      updateSubcategories();
    }

    function updateSubcategories(selectedSubcategoryId = null){
      const categoryId = categorySelect.value;
      subcategorySelect.innerHTML = '<option value="">Nessuna</option>';
      subcategorySelect.disabled = true;
      if (!categoryId) return;
      const relevant = allSubcategories.filter(sub => String(sub.category_id) === String(categoryId));
      if (relevant.length){
        subcategorySelect.disabled = false;
        relevant.forEach(sub => subcategorySelect.add(new Option(`${sub.icon ?? ''} ${sub.name}`, sub.id)));
        if (selectedSubcategoryId) subcategorySelect.value = selectedSubcategoryId;
      }
    }

    async function loadTransactions(){
      // skeleton leggero
      transactionList.innerHTML =
        `<div class="item"><div class="item-icon">⏳</div><div class="item-details"><span class="note">Carico movimenti…</span><span class="category muted">Attendi un secondo</span></div></div>`;

      const { data, error } = await supabase.from('transactions')
        .select(`*, categories(name, icon), subcategories(name, icon)`)
        .eq('created_by', user.id)
        .order('occurred_at', { ascending: false })
        .limit(15);
      if (error){ console.error("Errore transazioni:", error); transactionList.innerHTML = `<div class="empty-state"><p>Impossibile caricare i movimenti.</p></div>`; return; }

      allTransactions = data || [];
      transactionList.innerHTML = '';
      if (!allTransactions.length){
        transactionList.innerHTML = `<div class="empty-state"><p>Nessuna transazione registrata.</p></div>`;
        return;
      }

      allTransactions.forEach(tx => {
        const item = document.createElement('div');
        item.className = 'item';
        const cat = tx.categories; const sub = tx.subcategories;
        const icon = sub?.icon || cat?.icon || '💸';
        const categoryText = `${cat?.name || 'N/A'}${sub ? ` / ${sub.name}` : ''}`;
        const amountNum = safeToNumber(tx.amount);

        item.innerHTML = `
          <div class="item-icon">${icon}</div>
          <div class="item-details">
            <span class="note">${tx.note ?? ''}</span>
            <span class="category">${categoryText}</span>
          </div>
          <div class="item-amount ${tx.kind}">
            ${tx.kind === 'expense' ? '-' : ''}${nfmt.format(amountNum)} €
          </div>
          <div class="item-actions">
            <button class="action-btn edit-btn" data-id="${tx.id}">Modifica</button>
            <button class="action-btn delete-btn delete" data-id="${tx.id}">Elimina</button>
          </div>
        `;
        transactionList.appendChild(item);
      });
    }

    function handleEdit(id){
      const tx = allTransactions.find(t => String(t.id) === String(id));
      if (!tx) return;
      formTitle.textContent = "Modifica Transazione";
      formStatus.style.display = 'inline-block';
      transactionIdInput.value = tx.id;
      kindSelect.value = tx.kind;
      document.getElementById('note').value = tx.note ?? '';
      document.getElementById('amount').value = safeToNumber(tx.amount);
      document.getElementById('occurred_at').value = (tx.occurred_at || '').split('T')[0] || '';
      updateCategoryDropdown();
      categorySelect.value = tx.category_id ?? '';
      updateSubcategories(tx.subcategory_id ?? null);
      window.scrollTo({ top:0, behavior:'smooth' });
      setBusy(false);
      btnText.textContent = 'Salva modifiche';
    }

    async function handleDelete(id){
      if (!confirm("Eliminare questa transazione?")) return;
      const { error } = await supabase.from('transactions').delete().eq('id', id);
      if (error){ console.error("Errore eliminazione:", error); alert("Impossibile eliminare."); }
      else{ showToast('Eliminata ✔'); loadTransactions(); }
    }

    async function handleFormSubmit(e){
      e.preventDefault();
      setBusy(true);

      const id = transactionIdInput.value;
      const payload = {
        kind: kindSelect.value,
        note: document.getElementById('note').value,
        amount: document.getElementById('amount').value,
        occurred_at: document.getElementById('occurred_at').value,
        category_id: categorySelect.value,
        subcategory_id: subcategorySelect.value || null,
        created_by: user.id
      };

      const { error } = id
        ? await supabase.from('transactions').update(payload).eq('id', id)
        : await supabase.from('transactions').insert(payload);

      setBusy(false);

      if (error){
        console.error("Errore salvataggio:", error);
        alert("Errore. Verifica i campi e riprova.");
        return;
      }

      // reset UX
      transactionForm.reset();
      formTitle.textContent = "Nuova Transazione";
      formStatus.style.display = 'none';
      transactionIdInput.value = "";
      document.getElementById('occurred_at').valueAsDate = new Date();
      updateCategoryDropdown();
      showToast(id ? 'Modificata ✔' : 'Aggiunta ✔');
      loadTransactions();
    }

    async function initializePage(){
      const { data: { session } } = await supabase.auth.getSession();
      if (!session){ location.replace("/it/login.html"); return; }
      user = session.user;

      // profilo per onboarding + banner
      const { data: profile, error: pErr } =
        await supabase.from('profiles').select('onboarded, plan_type, trial_end').eq('id', user.id).single();
      if (pErr) console.warn("lettura profilo:", pErr?.message);
      handleTrialStatus(profile);

      if (profile && !profile.onboarded){
        if (new URLSearchParams(location.search).get('edit') !== '1'){
          location.replace("/it/onboarding.html");
          return;
        }
      }

      // Mese selector (estetico, coerente col riepilogo)
      const monthSelector = document.getElementById('month-selector');
      for (let i = 0; i < 12; i++){
        const d = new Date(); d.setMonth(d.getMonth()-i);
        const value = d.toISOString().slice(0,7) + '-01';
        const label = d.toLocaleDateString('it-IT',{month:'long', year:'numeric'});
        monthSelector.add(new Option(label, value));
      }

      document.getElementById('occurred_at').valueAsDate = new Date();
      await loadInitialData();
      updateCategoryDropdown();
      await loadTransactions();

      kindSelect.addEventListener('change', updateCategoryDropdown);
      categorySelect.addEventListener('change', () => updateSubcategories());
      transactionForm.addEventListener('submit', handleFormSubmit);
      logoutBtn.addEventListener('click', async (e) => { e.preventDefault(); await supabase.auth.signOut(); location.replace("/it/"); });

      transactionList.addEventListener('click', (ev)=>{
        const t = ev.target.closest('.action-btn'); if (!t) return;
        const id = t.dataset.id;
        if (t.classList.contains('edit-btn')) handleEdit(id);
        else if (t.classList.contains('delete-btn')) handleDelete(id);
      });
    }

    document.addEventListener('DOMContentLoaded', initializePage);
  </script>
</body>
</html>
