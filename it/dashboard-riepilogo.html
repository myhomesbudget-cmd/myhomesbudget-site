<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Riepilogo — MyHomesBudget</title>
  <meta name="robots" content="noindex, nofollow">
  <meta name="color-scheme" content="light dark">

  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' https: data:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com https://esm.sh;
                 connect-src 'self' https://*.supabase.co https://www.google-analytics.com https://region1.google-analytics.com;
                 font-src 'self' https: data:;
                 frame-ancestors 'none'; base-uri 'self'; form-action 'self'">

  <link rel="preload" href="/bg.webp" as="image" imagesrcset="/bg.webp"/>
  <link rel="icon" href="/favicon.ico">

  <style>
    :root{ font-family:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif; --grad:linear-gradient(135deg,#6c5ce7,#00cec9); --card-border:rgba(0,0,0,.06); }
    *{box-sizing:border-box}
    body{ margin:0; padding:0; color:#111; background:url("/bg.webp") no-repeat center/cover fixed; }
    body::before{content:"";position:fixed;inset:0;background:rgba(0,0,0,.08);z-index:-1}

    .topbar{
      position:fixed;top:16px;left:50%;transform:translateX(-50%);
      width:min(1100px,calc(100% - 40px));z-index:50;pointer-events:none;
      display:flex;align-items:center;justify-content:space-between;
    }
    .logo-link,.top-actions{pointer-events:auto}
    .logo-link{display:flex;align-items:center;gap:8px;text-decoration:none}
    .logo-image{height:32px}
    .logo-text{font-weight:600;color:#fff;font-size:1.05rem;text-shadow:0 1px 2px rgba(0,0,0,.35)}
    .top-actions{display:flex;gap:8px;align-items:center}
    .top-chip{
      background:rgba(255,255,255,.65); backdrop-filter:saturate(1.1) blur(6px);
      -webkit-backdrop-filter:saturate(1.1) blur(3px);
      border:1px solid var(--card-border); color:#111; padding:8px 12px; border-radius:12px; font-weight:800;
      box-shadow:0 8px 24px rgba(0,0,0,.08);
    }
    .wrap{width:min(1100px,calc(100% - 40px)); margin:110px auto 22px auto;}
    .card{
      background:rgba(255,255,255,0.50);
      backdrop-filter:saturate(1.1) blur(5px); -webkit-backdrop-filter:saturate(1.1) blur(2px);
      color:#111; padding:16px; border-radius:16px; border:1px solid var(--card-border);
      box-shadow:0 10px 30px rgba(0,0,0,.08);
    }
    .grid{display:grid; gap:14px; grid-template-columns:1fr 1fr}
    @media(max-width:1000px){ .grid{grid-template-columns:1fr} }
    .chart-box{height:340px; display:flex; align-items:center; justify-content:center}
    canvas{max-width:100%; max-height:100%}
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .kpi{font-weight:900;font-size:1.6rem}
    table{width:100%; border-collapse:collapse}
    th,td{padding:10px 12px; border-bottom:1px solid rgba(0,0,0,.06); text-align:left}
    th{font-size:.8rem; text-transform:uppercase; letter-spacing:.4px; color:#333}
  </style>
</head>
<body>
  <nav class="topbar" aria-label="Barra superiore">
    <a href="/it/" class="logo-link" title="MyHomesBudget">
      <img src="/homes.png" alt="Logo MyHomesBudget" class="logo-image" loading="lazy">
      <span class="logo-text">MyHomesBudget</span>
    </a>
    <div class="top-actions">
      <select class="top-chip" id="periodo" aria-label="Periodo">
        <option value="1m">Mensile</option>
        <option value="3m">Ultimi 3 mesi</option>
        <option value="6m">Ultimi 6 mesi</option>
        <option value="12m" selected>Ultimi 12 mesi</option>
        <option value="ytd">Anno in corso</option>
      </select>
      <a class="top-chip" href="/it/dashboard.html">Dashboard</a>
      <a class="top-chip" href="/it/operazioni.html">Operazioni</a>
      <a class="top-chip" href="/it/impostazioni.html">Impostazioni</a>
      <a class="top-chip" href="/it/logout.html">Esci</a>
    </div>
  </nav>

  <main class="wrap">
    <!-- Trend 12 mesi + ripartizione per categorie -->
    <section class="grid">
      <article class="card">
        <h3>Andamento uscite — ultimi 12 mesi</h3>
        <div class="chart-box"><canvas id="trendUscite"></canvas></div>
        <div class="kpi">Totale periodo: <span id="uscitePeriodo">€0</span></div>
      </article>

      <article class="card">
        <h3>Ripartizione uscite — periodo selezionato</h3>
        <div class="chart-box"><canvas id="donutUscite"></canvas></div>
        <div class="kpi">Categorie: <span id="numCat">0</span></div>
      </article>
    </section>

    <!-- Tabelle sintetiche -->
    <section class="grid" style="margin-top:14px">
      <article class="card">
        <h3>Top 10 categorie per spesa</h3>
        <div style="max-height:280px;overflow:auto">
          <table><thead><tr><th>Categoria</th><th>Importo</th></tr></thead><tbody id="tblTopCat"></tbody></table>
        </div>
      </article>

      <article class="card">
        <h3>Mensilità (uscite)</h3>
        <div style="max-height:280px;overflow:auto">
          <table><thead><tr><th>Mese</th><th>Importo</th></tr></thead><tbody id="tblMensilita"></tbody></table>
        </div>
      </article>
    </section>
  </main>

  <script type="module">
    import { Chart, LineController, LineElement, PointElement, LinearScale, CategoryScale, DoughnutController, ArcElement, Tooltip, Legend } from "https://esm.sh/chart.js@4";
    Chart.register(LineController, LineElement, PointElement, LinearScale, CategoryScale, DoughnutController, ArcElement, Tooltip, Legend);

    const fmt = new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR',maximumFractionDigits:0});

    // ===== Dati demo 12 mesi; sostituisci con query Supabase/materialized view =====
    const mesi = ["Ott","Nov","Dic","Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set"];
    const uscite12 = [820,760,890,840,910,860,920,950,880,910,870,940];
    const ripCat = [
      {cat:"Casa",v:920},{cat:"Alimentari",v:480},{cat:"Trasporti",v:210},{cat:"Utenze",v:260},{cat:"Svago",v:230},{cat:"Altro",v:180}
    ];

    // KPI
    const totPeriodo = uscite12.reduce((a,b)=>a+b,0);
    document.getElementById('uscitePeriodo').textContent = fmt.format(totPeriodo);
    document.getElementById('numCat').textContent = String(ripCat.length);

    // Tabelle
    document.getElementById('tblTopCat').innerHTML =
      ripCat.sort((a,b)=>b.v-a.v).slice(0,10).map(r=>`<tr><td>${r.cat}</td><td><b>${fmt.format(r.v)}</b></td></tr>`).join('');

    document.getElementById('tblMensilita').innerHTML =
      mesi.map((m,i)=>`<tr><td>${m}</td><td><b>${fmt.format(uscite12[i])}</b></td></tr>`).join('');

    // Linea 12 mesi (uscite)
    new Chart(document.getElementById('trendUscite'), {
      type:'line',
      data:{
        labels: mesi,
        datasets:[{ label:'Uscite', data:uscite12, fill:false, tension:.25, pointRadius:3, borderWidth:2 }]
      },
      options:{
        responsive:true,
        plugins:{ legend:{display:false}, tooltip:{callbacks:{ label:c=> fmt.format(c.parsed.y)}} },
        scales:{ y:{ ticks:{ callback: v=> fmt.format(v).replace('€','€ ') } } }
      }
    });

    // Donut categorie
    new Chart(document.getElementById('donutUscite'), {
      type:'doughnut',
      data:{
        labels: ripCat.map(r=>r.cat),
        datasets:[{ data:ripCat.map(r=>r.v), borderWidth:0,
          backgroundColor:['#ff5b5b','#ff7f7f','#ff9a9a','#ffb3b3','#ffd1d1','#ffe3e3']
        }]
      },
      options:{ responsive:true, cutout:'65%', plugins:{ legend:{display:false}, tooltip:{callbacks:{label:c=> `${c.label}: ${fmt.format(c.parsed)}`}} } }
    });
  </script>
</body>
</html>
