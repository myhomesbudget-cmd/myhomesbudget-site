<!doctype html>
<html lang="it" data-app="myhomesbudget">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard — MyHomesBudget</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" href="/favicon.ico" />

  <style>
    :root{
      --fg:#111;--bg:#f4f7fa;--glass:rgba(255,255,255,.6);
      --card-border:rgba(0,0,0,.08);--shadow:0 10px 30px rgba(0,0,0,.08);
      --radius-lg:16px;--primary-color:#6c5ce7;--danger-color:#d32f2f;--success-color:#2e7d32;
      --warning-color:#f39c12;
      --font-sans:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif;
      --grad:linear-gradient(135deg,#6c5ce7,#00cec9);
      --grad-danger:linear-gradient(135deg,#d32f2f,#ff7675);
    }
    *{box-sizing:border-box}
    html{font-family:var(--font-sans);background-color:var(--bg)}
    body{margin:0;color:var(--fg);background:url("/bg.webp") no-repeat center/cover fixed;min-height:100vh}
    body::before{content:"";position:fixed;inset:0;background:linear-gradient(135deg,rgba(108,92,231,.05),rgba(0,206,201,.05));z-index:-1}

    /* TOPBAR */
    .topbar{position:fixed;top:0;left:0;right:0;height:60px;padding:0 24px;display:flex;align-items:center;justify-content:space-between;background:var(--glass);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-bottom:1px solid var(--card-border);z-index:100}
    .logo-link{display:flex;align-items:center;gap:8px;text-decoration:none}
    .logo-text{font-weight:600;color:#fff;font-size:1.1rem;text-shadow:0 1px 2px rgba(0,0,0,.35)}
    .top-actions{display:flex;gap:12px;align-items:center}
    .top-link,.top-btn{display:flex;align-items:center;justify-content:center;height:34px;color:#fff;text-decoration:none;padding:6px 12px;border-radius:10px;font-size:.9rem;font-weight:600;background:var(--grad);border:none;box-shadow:0 4px 12px rgba(0,0,0,.15);transition:.2s;cursor:pointer}
    .top-link:hover,.top-btn:hover{transform:translateY(-2px);filter:brightness(1.08);box-shadow:0 6px 16px rgba(0,0,0,.20)}
    .date-selectors{display:flex;gap:8px}
    .select-wrapper{position:relative;display:flex;align-items:center;height:34px;border-radius:10px;background:var(--grad);box-shadow:0 4px 12px rgba(0,0,0,.15);transition:.2s}
    .select-wrapper:hover{transform:translateY(-2px);filter:brightness(1.08);box-shadow:0 6px 16px rgba(0,0,0,.20)}
    .select-wrapper::after{content:'▼';font-size:10px;color:rgba(255,255,255,.8);position:absolute;right:10px;top:50%;transform:translateY(-50%);pointer-events:none}
    .topbar-select{appearance:none;background:transparent;color:#fff;border:none;padding:6px 28px 6px 12px;font-size:.9rem;font-weight:600;cursor:pointer}
    .topbar-select option{background:#fff;color:#000}
    .notification-bell{position:relative}
    #scheduler-btn,#notifications-btn{width:38px;padding:0}
    .notification-badge{position:absolute;top:-5px;right:-5px;background:var(--danger-color);color:#fff;border-radius:50%;width:20px;height:20px;font-size:12px;font-weight:700;display:none;align-items:center;justify-content:center;border:2px solid #fff}
    .notification-badge.is-visible{display:flex}
    .mobile-menu-toggle{display:none;background:var(--grad);border:none;border-radius:10px;width:40px;height:38px;cursor:pointer;padding:0;z-index:101;box-shadow:0 4px 12px rgba(0,0,0,.15)}
    .mobile-menu-toggle svg{width:24px;height:24px;stroke:#fff;stroke-width:2.5;stroke-linecap:round}
    .visually-hidden{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}
    @media (max-width:960px){
      .mobile-menu-toggle{display:block}
      .top-actions{position:fixed;top:70px;right:16px;background:rgba(255,255,255,.9);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-radius:var(--radius-lg);box-shadow:var(--shadow);padding:16px;flex-direction:column;gap:16px;align-items:stretch;width:220px;transform:translateY(-20px) scale(.95);opacity:0;pointer-events:none;transition:.2s;z-index:100;border:1px solid var(--card-border)}
      .top-actions.is-open{transform:translateY(0) scale(1);opacity:1;pointer-events:auto}
      .top-actions .top-link,.top-actions .top-btn,.top-actions .select-wrapper,.top-actions .date-selectors{width:100%;text-align:center;flex-direction:column}
      #scheduler-btn,#notifications-btn{width:100%}
    }

    /* LAYOUT */
    main.container{padding:84px 24px 24px;max-width:1280px;margin:0 auto;width:100%}
    .dash-nav{display:flex;gap:8px;border-bottom:1px solid rgba(0,0,0,.1);padding-bottom:12px;margin-bottom:24px;flex-wrap: wrap;}
    .dash-nav a,.dash-nav button{text-decoration:none;padding:8px 16px;border-radius:10px;font-weight:600;transition:.2s;background:var(--grad);color:#fff;box-shadow:0 4px 12px rgba(0,0,0,.1);border:none;font-family:var(--font-sans);font-size:1rem;cursor:pointer}
    .dash-nav a:hover,.dash-nav button:hover{transform:translateY(-2px);filter:brightness(1.08);box-shadow:0 6px 16px rgba(0,0,0,.15)}
    .dash-nav a.is-active,.dash-nav button.is-active{filter:brightness(1.15);box-shadow:0 6px 16px rgba(0,0,0,.20), inset 0 1px 2px rgba(255,255,255,.2)}
    .content-section{background:rgba(255,255,255,.85);border-radius:var(--radius-lg);padding:16px;border:1px solid var(--card-border);box-shadow:var(--shadow)}
    .dashboard-panel{background:rgba(255,255,255,.55);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border-radius:var(--radius-lg);padding:24px;border:1px solid var(--card-border);box-shadow:var(--shadow)}
    .dashboard-panel .content-section,.dashboard-panel .summary-card{box-shadow:none;border:none}
    .dashboard-panel .content-section{background:rgba(255,255,255,.7)}
    .dashboard-grid{display:grid;grid-template-columns:1fr;gap:24px}
    @media(min-width:1024px){.dashboard-grid{grid-template-columns:repeat(2,1fr)}}
    .flow-column h2{display:flex;align-items:center;justify-content:space-between;gap:12px;font-size:1.5rem;margin:0 0 16px;padding:0 8px}
    .flow-column.income h2{color:var(--success-color)}
    .flow-column.expense h2{color:var(--danger-color)}

    /* SUMMARY BARS */
    .summary-card{background:#fff;padding:16px;border-radius:var(--radius-lg);margin-bottom:16px}
    .summary-card h3{display:flex;justify-content:space-between;align-items:center;margin:0 0 12px;font-size:1rem;color:#555}
    .summary-total-amount{font-weight:800;font-size:1.2rem}
    .income .summary-total-amount{color:var(--success-color)}
    .expense .summary-total-amount{color:var(--danger-color)}
    .category-summary-bars{display:flex;flex-direction:column;gap:14px;margin-top:16px}
    .category-bar-item{display:flex;flex-direction:column;gap:6px}
    .category-bar-info{display:flex;justify-content:space-between;align-items:center;font-size:.95rem}
    .category-bar-label{display:flex;align-items:center;gap:8px;font-weight:600}
    .category-bar-amount{font-weight:700}
    .progress-bar-bg{width:100%;height:10px;background:rgba(0,0,0,.08);border-radius:999px;overflow:hidden}
    .progress-bar-fg{height:100%;border-radius:999px;transition:width .5s ease-out}
    .income .progress-bar-fg{background:linear-gradient(90deg,#00cec9,#81ecec)}
    .expense .progress-bar-fg{background:linear-gradient(90deg,#6c5ce7,#fd79a8)}

    /* FORM transazioni */
    .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;font-weight:800;color:#fff;transition:.2s}
    .btn:hover{transform:translateY(-2px);filter:brightness(1.08)}
    .btn-primary{background:var(--grad);box-shadow:0 10px 24px rgba(0,0,0,.18)}
    .btn-primary:hover{box-shadow:0 14px 28px rgba(0,0,0,.22)}
    .btn-secondary{background:#f0f0f0;color:#555;border:1px solid #ddd;box-shadow:0 4px 8px rgba(0,0,0,.05)}
    .btn-secondary:hover{background:#e5e5e5;border-color:#ccc;color:#333}
    .transaction-form{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:flex-end}
    .form-group{display:flex;flex-direction:column}
    .form-group label{font-weight:600;font-size:.9rem;margin-bottom:6px}
    .form-group input,.form-group select{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;background:#fff;font-size:1rem}
    .form-group.full-width{grid-column:1 / -1}
    .form-buttons{grid-column:1 / -1;margin-top:10px}
    .form-buttons.is-editing{display:flex;gap:12px}
    .form-buttons.is-editing #submit-btn{flex-grow:1}
    @media(min-width:1024px){.transaction-form{grid-template-columns:repeat(6,1fr);gap:16px}.form-group.kind{grid-column:span 1}.form-group.note{grid-column:span 3}.form-group.amount{grid-column:span 2}.form-group.date{grid-column:span 2}.form-group.category{grid-column:span 2}.form-group.subcategory{grid-column:span 2}}
    #advanced-options-wrapper{display:none;grid-column:1 / -1;background:rgba(0,0,0,.03);padding:12px;border-radius:10px;margin-top:8px}
    .advanced-options-controls{display:flex;flex-wrap:wrap;gap:20px;align-items:center;margin-bottom:12px}
    .advanced-options-controls label{display:flex;align-items:center;gap:8px;font-weight:600;cursor:pointer}
    .advanced-options-fields{display:none;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px}

    /* LIST */
    .list-title{margin:-16px -16px 16px;padding:12px 16px;font-size:1.1rem;font-weight:700;color:#333;border-bottom:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.4);display:flex;justify-content:space-between;align-items:center}
    .list-total-amount{font-weight:800;font-size:1.2rem}
    .income .list-total-amount{color:var(--success-color)}
    .expense .list-total-amount{color:var(--danger-color)}
    .transaction-list .item{display:grid;grid-template-columns:auto 1fr auto auto;gap:12px;align-items:center;padding:12px 4px;border-bottom:1px solid rgba(0,0,0,.05)}
    .item:last-child{border-bottom:none}
    .item-icon{font-size:1.5rem;flex-shrink:0}
    .item-details{display:flex;flex-direction:column;min-width:0}
    .item-details .note{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .item-details .category{font-size:.9rem;color:#555;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .item-amount{text-align:right;white-space:nowrap;flex-shrink:0}
    .item-amount.expense{color:var(--danger-color);font-weight:700}
    .item-amount.income{color:var(--success-color);font-weight:700}
    .item-actions{display:flex;gap:4px;flex-shrink:0}
    .action-btn{background:var(--grad);color:#fff;border:none;border-radius:8px;padding:6px 10px;font-size:.85rem;font-weight:600;cursor:pointer;transition:.2s}
    .action-btn:hover{filter:brightness(1.1);transform:translateY(-1px)}
    .action-btn.delete{background:var(--grad-danger)}
    .empty-state{text-align:center;padding:40px 20px;color:#777;background:rgba(0,0,0,.02);border-radius:12px}

    /* DEADLINES */
    #deadlines-section h3{color:var(--warning-color);border-bottom:2px solid var(--warning-color);padding-bottom:8px}
    .deadline-item{display:grid;grid-template-columns:1fr auto auto auto;align-items:center;gap:12px}
    .deadline-item .item-actions{display:flex;gap:4px;align-items:center;justify-content:flex-end}
    .deadline-item .item-amount.expense{color:var(--danger-color)}
    .deadline-item .item-amount.income{color:var(--success-color)}
    .deadline-item .days-left{font-weight:700;color:var(--warning-color)}
    .btn-action-deadline{padding:8px 12px;font-size:.9rem}
    .btn-action-deadline.pay{background:var(--warning-color)}
    .btn-action-deadline.receive{background:var(--success-color)}

    /* GENERIC MODAL */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;pointer-events:none;transition:.3s}
    .modal-overlay.is-visible{opacity:1;pointer-events:auto}
    .modal-content{background:var(--bg);border-radius:var(--radius-lg);padding:24px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto;box-shadow:var(--shadow);transform:scale(.95);transition:.3s}
    .modal-overlay.is-visible .modal-content{transform:scale(1)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--card-border);padding-bottom:12px;margin-bottom:16px}
    .modal-title{margin:0;font-size:1.3rem}
    .modal-close{background:none;border:none;font-size:2rem;cursor:pointer;color:#888;line-height:1;padding:0}
    .modal-body ul{list-style:none;padding:0;margin:0}
    .modal-body li{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--card-border)}
    .modal-body li:last-child{border-bottom:none}
    .modal-footer{margin-top:20px;display:flex;justify-content:flex-end;gap:12px}
    .modal-footer .btn.delete{background:var(--grad-danger);box-shadow:0 8px 20px rgba(211,47,47,.25)}
    .modal-footer .btn.delete:hover{box-shadow:0 12px 24px rgba(211,47,47,.3)}
    .modal-footer .btn-secondary{background:#f0f0f0;color:#555;border:1px solid #ddd;box-shadow:0 4px 8px rgba(0,0,0,.05)}
    .modal-footer .btn-secondary:hover{background:#e5e5e5;border-color:#ccc;color:#333}

    /* MOVEMENTS MODAL */
    .modal-content-large{max-width:90vw;width:1000px}
    .movements-table-container{max-height:60vh;overflow-y:auto}
    .movements-table{width:100%;border-collapse:collapse}
    .movements-table th,.movements-table td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--card-border);white-space:nowrap}
    .movements-table th{font-weight:700;background:rgba(0,0,0,.05);font-size:.9rem;position:sticky;top:0}
    .movements-table .amount-col{text-align:right;font-weight:700}
    .movements-table .income .amount-col{color:var(--success-color)}
    .movements-table .expense .amount-col{color:var(--danger-color)}
    .movements-summary{margin-top:20px;padding-top:16px;border-top:2px solid var(--card-border);display:flex;justify-content:space-around;font-weight:700}

    /* STATUS message */
    .status-message{padding:12px 16px;border-radius:10px;margin-top:16px;text-align:center;font-weight:600;opacity:0;transition:.3s;grid-column:1 / -1}
    .status-message.is-visible{opacity:1}
    .status-message.success{background:var(--success-color);color:#fff}
    .status-message.error{background:var(--danger-color);color:#fff}

    /* GOALS UI */
    #goals-section .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    #goals-plan-info{font-weight:700;color:#666}
    .goal-card{background:#fff;border:1px solid var(--card-border);border-radius:12px;padding:16px;box-shadow:var(--shadow)}
    .goal-title{font-weight:800;color:#444;margin:0 0 4px;display:flex;align-items:center;gap:10px}
    .goal-subtitle{margin:0 0 12px;color:#666}
    .goal-row{display:grid;grid-template-columns:1fr 1fr auto;gap:12px;align-items:center}
    .chip{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px 12px;border-radius:999px;background:rgba(0,0,0,.05);font-weight:800;cursor:pointer;user-select:none;min-width:120px}
    .chip.is-active{background:var(--grad);color:#fff;box-shadow:0 4px 10px rgba(0,0,0,.12)}
    .goal-method{display:flex;gap:10px;flex-wrap:wrap}
    .goal-input label{font-weight:800;display:block;margin-bottom:6px}
    .goal-input input{width:100%;padding:12px;border:1px solid #ccc;border-radius:10px;font-size:1rem;background:#fff;text-align:center;font-weight:800}
    .goal-input .muted{opacity:.75}
    .goal-hint{display:block;margin-top:6px;font-size:.85rem;color:#777}
    .goal-confirm{text-align:right;display:flex;gap:10px;justify-content:flex-end}
    .goal-locked .goal-method, .goal-locked .goal-input {opacity:.8;pointer-events:none}
    .goal-actions-link{font-size:.8rem;color:#666;text-transform:uppercase;font-weight:800;text-decoration:none;justify-self:end}
  </style>
</head>
<body>
  <!-- Topbar -->
  <nav class="topbar">
    <a href="/it/" class="logo-link"><img src="/homes.png" alt="Logo" style="height:32px;border-radius:6px"><span class="logo-text">MyHomesBudget</span></a>
    <div class="top-nav-right">
      <button id="mobile-menu-btn" class="mobile-menu-toggle" aria-label="Apri menu">
        <svg viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        <span class="visually-hidden">Menu</span>
      </button>
      <div class="top-actions">
        <div class="date-selectors">
          <div class="select-wrapper"><select id="month-selector" class="topbar-select"></select></div>
          <div class="select-wrapper"><select id="year-selector" class="topbar-select"></select></div>
        </div>
        <a href="/it/onboarding.html?edit=1" class="top-link">🎯 Obiettivo</a>
        <button id="scheduler-btn" class="top-btn" aria-label="Apri scadenziario">🗓️</button>
        <button id="notifications-btn" class="top-btn notification-bell" aria-label="Apri notifiche"><span>🔔</span><span id="notification-badge" class="notification-badge"></span></button>
        <a href="#" id="logout-btn" class="top-link">Esci</a>
      </div>
    </div>
  </nav>

  <main class="container">
    <nav id="dash-nav" class="dash-nav">
      <a href="/it/dashboard.html" class="is-active" aria-current="page">Operazioni</a>
      <a href="/it/dashboard-riepilogo.html">Riepilogo</a>
      <button id="list-movements-btn">Lista Movimenti</button>
    </nav>

    <!-- Form -->
    <section class="content-section form-section">
      <h2 id="form-title" style="margin:0 0 16px">Nuova Operazione</h2>
      <form id="transaction-form" class="transaction-form">
        <input type="hidden" id="transaction-id" name="transaction-id">
        <div class="form-group kind"><label for="kind">Tipo</label><select id="kind" name="kind" required><option value="expense">Uscita</option><option value="income">Entrata</option></select></div>
        <div class="form-group note"><label for="note">Nota</label><input type="text" id="note" name="note" placeholder="Es. Stipendio, Rata Mutuo..." required></div>
        <div class="form-group amount"><label for="amount">Importo (€)</label><input type="number" id="amount" name="amount" step="0.01" placeholder="0.00" required></div>
        <div class="form-group date"><label for="occurred_at">Data</label><input type="date" id="occurred_at" name="occurred_at" required></div>
        <div class="form-group category"><label for="category_id">Categoria</label><select id="category_id" name="category_id" required></select></div>
        <div class="form-group subcategory"><label for="subcategory_id">Sottocategoria</label><select id="subcategory_id" name="subcategory_id"></select></div>

        <div id="advanced-options-wrapper">
          <div class="advanced-options-controls">
            <label><input type="radio" name="transaction_type" value="single" checked> Operazione Singola</label>
            <label><input type="radio" name="transaction_type" value="recurring"> 🔄 Ricorrente</label>
            <label><input type="radio" name="transaction_type" value="scheduled"> 🗓️ Imposta Scadenza</label>
          </div>
          <div id="recurring-options" class="advanced-options-fields">
            <div class="form-group"><label for="recurring_frequency">Frequenza</label><select id="recurring_frequency" name="recurring_frequency"><option value="monthly">Mensile</option></select></div>
            <div class="form-group"><label for="recurring_end_date">Termina il</label><input type="date" id="recurring_end_date" name="recurring_end_date"></div>
          </div>
          <div id="due-date-options" class="advanced-options-fields">
            <div class="form-group full-width"><label for="due_date">Data di Scadenza/Incasso</label><input type="date" id="due_date" name="due_date"></div>
          </div>
        </div>
        <div id="form-buttons-container" class="form-buttons">
          <button type="submit" id="submit-btn" class="btn btn-primary" style="width:100%;">Aggiungi</button>
          <button type="button" id="cancel-edit-btn" class="btn btn-secondary" style="display:none;">Annulla</button>
        </div>
        <div id="status-message" class="status-message" aria-live="polite"></div>
      </form>
    </section>

    <!-- 🎯 Obiettivi -->
    <section id="goals-section" class="content-section" style="margin-top:12px;">
      <div class="header">
        <h3 style="margin:0;display:flex;align-items:center;gap:8px;">🎯 <span>Obiettivi</span></h3>
        <a href="/it/onboarding.html?edit=1" class="goal-actions-link">Modifica obiettivo</a>
      </div>
      <div id="goals-list"></div>
    </section>

    <!-- Scadenze -->
    <section id="deadlines-section" class="content-section" style="margin-top:12px;display:none;">
      <h3>🔔 Scadenze & Voci Future (Prossimi 30 giorni)</h3>
      <div id="deadlines-list" class="transaction-list"></div>
    </section>

    <!-- Dati principali -->
    <div class="dashboard-panel" style="margin-top:12px;">
      <div class="dashboard-grid">
        <div class="flow-column income"><h2>✅ Entrate Recenti</h2><div id="income-summary" class="summary-card"></div><div id="income-list" class="content-section transaction-list"></div></div>
        <div class="flow-column expense"><h2>❌ Uscite Recenti</h2><div id="expense-summary" class="summary-card"></div><div id="expense-list" class="content-section transaction-list"></div></div>
      </div>
    </div>
  </main>

  <!-- Modals -->
  <div id="scheduler-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h3 id="scheduler-modal-title" class="modal-title"></h3><button class="modal-close" aria-label="Chiudi modale">&times;</button></div><div id="scheduler-modal-body" class="modal-body transaction-list"></div></div></div>
  <div id="generic-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h3 id="generic-modal-title" class="modal-title"></h3><button class="modal-close" aria-label="Chiudi modale">&times;</button></div><div id="generic-modal-body" class="modal-body"></div><div id="generic-modal-footer" class="modal-footer"></div></div></div>
  <div id="movements-modal" class="modal-overlay"><div class="modal-content modal-content-large"><div class="modal-header"><h3 id="movements-modal-title" class="modal-title">Lista Movimenti</h3><button class="modal-close" aria-label="Chiudi modale">&times;</button></div><div id="movements-modal-body" class="modal-body"><div class="movements-table-container"></div></div><div id="movements-modal-footer" class="movements-summary"></div></div></div>

  <script type="module">
    import { supabase } from "/it/supabase-client.js";
    window.supabase = supabase;

    // ---- STATE ----
    let user = null;
    let allCategories = [];
    let allSubcategories = [];
    let allTransactions = [];
    let goalsData = [];
    let isGoalEditing = false;

    // ---- DOM ELEMENTS ----
    const transactionForm = document.getElementById('transaction-form');
    const kindSelect = document.getElementById('kind');
    const categorySelect = document.getElementById('category_id');
    const subcategorySelect = document.getElementById('subcategory_id');
    const transactionIdInput = document.getElementById('transaction-id');
    const formTitle = document.getElementById('form-title');
    const submitBtn = document.getElementById('submit-btn');
    const cancelEditBtn = document.getElementById('cancel-edit-btn');
    const formButtonsContainer = document.getElementById('form-buttons-container');
    const logoutBtn = document.getElementById('logout-btn');
    const incomeList = document.getElementById('income-list');
    const expenseList = document.getElementById('expense-list');
    const incomeSummary = document.getElementById('income-summary');
    const expenseSummary = document.getElementById('expense-summary');
    const monthSelector = document.getElementById('month-selector');
    const yearSelector = document.getElementById('year-selector');
    const advancedOptionsWrapper = document.getElementById('advanced-options-wrapper');
    const deadlinesSection = document.getElementById('deadlines-section');
    const deadlinesList = document.getElementById('deadlines-list');
    const notificationsBtn = document.getElementById('notifications-btn');
    const notificationBadge = document.getElementById('notification-badge');
    const goalsList = document.getElementById('goals-list');
    const statusMessage = document.getElementById('status-message');

    // ---- UTILS ----
    const euro = (n) => (Number(n||0)).toLocaleString('it-IT',{style:'currency',currency:'EUR'});
    const toNum = (v) => Number.isFinite(v) ? v : Number.parseFloat(String(v).replace(',','.')) || 0;

    function showModal(title, bodyHtml, buttons = []) {
      const modal = document.getElementById('generic-modal');
      document.getElementById('generic-modal-title').textContent = title;
      document.getElementById('generic-modal-body').innerHTML = bodyHtml;
      const footer = document.getElementById('generic-modal-footer');
      footer.innerHTML = '';
      buttons.forEach(b=>{
        const btn=document.createElement('button');
        btn.className='btn '+(b.class||'btn-secondary');
        btn.textContent=b.text;
        btn.onclick=()=>{ if(b.action) b.action(); modal.classList.remove('is-visible'); };
        footer.appendChild(btn);
      });
      modal.classList.add('is-visible');
    }

    function showStatusMessage(message, type='success', duration=3000){
      statusMessage.textContent = message;
      statusMessage.className = `status-message ${type} is-visible`;
      setTimeout(() => statusMessage.classList.remove('is-visible'), duration);
    }

    // ---- GOALS LOGIC ----
    const methodLabel = (m)=> m==='fixed'?'Importo fisso (€)': m==='variable'?'Importo variabile (€)':'Percentuale sulle entrate (%)';
    const methodPlaceholder = (m)=> m==='percent'?'10 → 10%':'100,00';

    async function loadGoals(){
      try{
        const { data: goal, error: gErr } = await supabase.from('goals').select('*').eq('user_id', user.id).order('updated_at',{ascending:false}).limit(1).maybeSingle();
        if(gErr) throw gErr;
        if(!goal){ renderGoalsUI(null); return; }

        const { data: gms, error: sErr } = await supabase.from('goal_method_state').select('*').eq('goal_id', goal.id).maybeSingle();
        if(sErr) throw sErr;

        goalsData = [{ ...goal, goal_method: gms?.method ?? 'fixed', fixed_amount: gms?.fixed_amount ?? null, percent_value: gms?.percent_value ?? null }];
        renderGoalsUI(goalsData[0]);
      }catch(err){
        console.error('[Goals] Load error:', err);
        renderGoalsUI(null);
      }
    }

    function monthIncomeTotal(){
      return (allTransactions||[]).filter(t => t.kind==='income').reduce((s,t)=> s + toNum(t.amount), 0);
    }

    function computeEuroFor(goal, method, param){
      if(method==='percent') return (toNum(param)/100) * monthIncomeTotal();
      if(method==='fixed' || method==='variable') return toNum(param);
      return 0;
    }

    function renderGoalsUI(goal){
      if(!goal){
        goalsList.innerHTML = `<div class="goal-card"><p>Nessun obiettivo impostato. <a href="/it/onboarding.html?edit=1">Configuralo ora</a>.</p></div>`;
        return;
      }
      const m = goal.goal_method || 'fixed';
      const paramVal = m==='percent' ? (goal.percent_value ?? 10) : (goal.fixed_amount ?? goal.target_amount ?? 0);
      const euroVal = computeEuroFor(goal, m, paramVal);

      goalsList.innerHTML = `
        <div class="goal-card" id="goal1-card">
          <p class="goal-subtitle" style="margin:0 0 12px;"><strong>${goal.name || 'Risparmio'}</strong> — Target: <strong>${euro(goal.target_amount||0)}</strong></p>
          <div class="goal-row">
            <div class="goal-method" id="g1-method">
              <span class="chip ${m==='fixed'?'is-active':''}" data-method="fixed">CIFRA FISSA</span>
              <span class="chip ${m==='variable'?'is-active':''}" data-method="variable">CIFRA VARIABILE</span>
              <span class="chip ${m==='percent'?'is-active':''}" data-method="percent">% ENTRATE</span>
            </div>
            <div class="goal-input">
              <label id="g1-param-label" class="visually-hidden">${methodLabel(m)}</label>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                <input id="g1-param" type="number" step="0.01" value="${toNum(paramVal)}" placeholder="${methodPlaceholder(m)}" aria-label="${methodLabel(m)}">
                <input id="g1-euro" type="text" value="${euro(euroVal)}" class="muted" readonly aria-label="Valore in Euro">
              </div>
              <span class="goal-hint" id="g1-hint">${m==='percent' ? 'Sulle entrate del mese.' : 'Valore mensile.'}</span>
            </div>
            <div class="goal-confirm">
              <button id="g1-edit" class="btn btn-secondary" type="button">Modifica</button>
              <button id="g1-confirm" class="btn btn-primary" type="button" style="display:none;">Conferma</button>
            </div>
          </div>
        </div>`;
      bindGoalEditor(goal);
      setGoalLocked(true);
    }

    function setGoalLocked(lock){
      isGoalEditing = !lock;
      const card = document.getElementById('goal1-card');
      if (!card) return;
      
      const param = document.getElementById('g1-param');
      const editBtn = document.getElementById('g1-edit');
      const confirmBtn = document.getElementById('g1-confirm');

      param.readOnly = lock;
      card.classList.toggle('goal-locked', lock);
      
      editBtn.textContent = lock ? 'Modifica' : 'Annulla';
      confirmBtn.style.display = lock ? 'none' : 'inline-flex';
    }

    function bindGoalEditor(goal){
      const methodWrap = document.getElementById('g1-method');
      const param = document.getElementById('g1-param');
      const euroBox = document.getElementById('g1-euro');
      const hint = document.getElementById('g1-hint');
      const editBtn = document.getElementById('g1-edit');
      const confirmBtn = document.getElementById('g1-confirm');

      const refreshEuro = ()=>{
        const activeMethod = methodWrap.querySelector('.chip.is-active')?.dataset.method || 'fixed';
        euroBox.value = euro(computeEuroFor(goal, activeMethod, param.value));
      };

      methodWrap.addEventListener('click', (e)=>{
        if(!isGoalEditing) return;
        const chip = e.target.closest('.chip'); if(!chip) return;
        methodWrap.querySelectorAll('.chip').forEach(c=>c.classList.remove('is-active'));
        chip.classList.add('is-active');
        const m = chip.dataset.method;
        param.placeholder = methodPlaceholder(m);
        hint.textContent = m==='percent' ? 'Sulle entrate del mese.' : 'Valore mensile.';
        refreshEuro();
      });

      param.addEventListener('input', refreshEuro);
      editBtn.addEventListener('click', () => setGoalLocked(isGoalEditing));

      confirmBtn.addEventListener('click', async ()=>{
        const active = methodWrap.querySelector('.chip.is-active')?.dataset.method || 'fixed';
        const rawVal = toNum(param.value);
        const euroValue = computeEuroFor(goal, active, rawVal);

        const payload = { goal_id: goal.id, method: active, fixed_amount: (active!=='percent' ? rawVal : null), percent_value: (active==='percent' ? rawVal : null) };
        const { error } = await supabase.from('goal_method_state').upsert(payload, { onConflict: 'goal_id' });
        
        if (error) {
          showStatusMessage('Errore salvataggio metodo', 'error');
          return;
        }

        showStatusMessage('Obiettivo aggiornato!', 'success');
        setGoalLocked(true);
        Object.assign(goalsData[0], { goal_method: active, fixed_amount: payload.fixed_amount, percent_value: payload.percent_value });
      });
    }

    function refreshGoalBoxEuroIfAny(){
      if(document.getElementById('goal1-card')){
        const method = document.querySelector('#g1-method .chip.is-active')?.dataset.method || 'fixed';
        const paramVal = document.getElementById('g1-param').value;
        document.getElementById('g1-euro').value = euro(computeEuroFor(goalsData[0], method, paramVal));
      }
    }

    // ---- TRANSACTIONS LOGIC ----
    async function loadInitialData(){
      try {
        const { data: categories, error: catError } = await supabase.from('categories').select('*').eq('created_by', user.id);
        if(catError) throw catError;
        allCategories = categories || [];

        if(allCategories.length){
          const { data: subcategories, error: subCatError } = await supabase.from('subcategories').select('*').in('category_id', allCategories.map(c=>c.id));
          if(subCatError) throw subCatError;
          allSubcategories = subcategories || [];
        }
      } catch(e) {
        showModal('Errore Caricamento', '<p>Impossibile caricare categorie e sottocategorie.</p>');
      }
    }

    function updateCategoryDropdown(){
      const selectedKind = kindSelect.value;
      advancedOptionsWrapper.style.display='block';
      categorySelect.innerHTML = '<option value="">Scegli categoria...</option>' + allCategories
        .filter(c => c.kind === selectedKind)
        .map(cat => `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`)
        .join('');
      updateSubcategories();
    }

    function updateSubcategories(selectedSubcategoryId = null){
      const categoryId = categorySelect.value;
      subcategorySelect.innerHTML = '<option value="">Nessuna</option>';
      subcategorySelect.disabled = true;
      if(!categoryId) return;
      const relevant = allSubcategories.filter(s => String(s.category_id) === String(categoryId));
      if(relevant.length){
        subcategorySelect.disabled = false;
        subcategorySelect.innerHTML += relevant.map(sub => `<option value="${sub.id}">${sub.icon} ${sub.name}</option>`).join('');
        if(selectedSubcategoryId) subcategorySelect.value = selectedSubcategoryId;
      }
    }

    async function loadTransactions(){
      monthSelector.disabled = true;
      yearSelector.disabled = true;
      const selectedMonth = monthSelector.value;
      const selectedYear = yearSelector.value;
      const startDate = new Date(selectedYear, selectedMonth, 1).toISOString();
      const endDate = new Date(selectedYear, Number(selectedMonth)+1, 0, 23, 59, 59).toISOString();
      try {
        const { data, error } = await supabase.from('transactions')
          .select(`*, categories(name, icon), subcategories(name, icon)`)
          .eq('created_by', user.id)
          .gte('occurred_at', startDate)
          .lte('occurred_at', endDate)
          .order('occurred_at',{ascending:false});
        if (error) throw error;
        allTransactions = data || [];
        renderDashboard(allTransactions);
      } catch (e) {
        showModal('Errore Caricamento', '<p>Impossibile caricare le transazioni.</p>');
        renderDashboard([]);
      } finally {
        monthSelector.disabled = false;
        yearSelector.disabled = false;
      }
    }
    
    function resetForm() {
        transactionForm.reset();
        transactionIdInput.value = '';
        document.getElementById('occurred_at').valueAsDate = new Date();
        formTitle.textContent = 'Nuova Operazione';
        submitBtn.textContent = 'Aggiungi';
        cancelEditBtn.style.display = 'none';
        formButtonsContainer.classList.remove('is-editing');
        updateCategoryDropdown();
    }

    async function saveTransaction(formData) {
        const id = formData.get('transaction-id');
        const payload = {
            created_by: user.id,
            kind: formData.get('kind'),
            note: formData.get('note'),
            amount: toNum(formData.get('amount')),
            occurred_at: formData.get('occurred_at'),
            category_id: formData.get('category_id'),
            subcategory_id: formData.get('subcategory_id') || null,
        };
        if (id) payload.id = id;

        const { error } = await supabase.from('transactions').upsert(payload);

        if (error) {
            console.error('Save error:', error);
            showStatusMessage('Errore nel salvataggio.', 'error');
        } else {
            showStatusMessage(id ? 'Operazione aggiornata!' : 'Operazione aggiunta!', 'success');
            resetForm();
            await loadAllDataForMonth();
        }
    }

    function populateAndShowEditForm(txId) {
        const tx = allTransactions.find(t => String(t.id) === String(txId));
        if (!tx) return;

        transactionIdInput.value = tx.id;
        kindSelect.value = tx.kind;
        document.getElementById('note').value = tx.note;
        document.getElementById('amount').value = tx.amount;
        document.getElementById('occurred_at').value = tx.occurred_at.split('T')[0];
        
        updateCategoryDropdown();
        setTimeout(() => {
          categorySelect.value = tx.category_id;
          updateSubcategories(tx.subcategory_id);
        }, 100);

        formTitle.textContent = 'Modifica Operazione';
        submitBtn.textContent = 'Salva Modifiche';
        cancelEditBtn.style.display = 'block';
        formButtonsContainer.classList.add('is-editing');
        window.scrollTo(0, 0);
    }
    
    async function handleDelete(id) {
        showModal(
            'Conferma Eliminazione',
            '<p>Sei sicuro di voler eliminare questa operazione? L\'azione è irreversibile.</p>',
            [
                { text: 'Annulla' },
                { text: 'Elimina', class: 'btn-primary delete', action: async () => {
                    const { error } = await supabase.from('transactions').delete().match({ id: id, created_by: user.id });
                    if (error) {
                        showStatusMessage('Errore durante l\'eliminazione.', 'error');
                    } else {
                        showStatusMessage('Operazione eliminata.', 'success');
                        await loadAllDataForMonth();
                    }
                }}
            ]
        );
    }

    function renderDashboard(transactions) {
      const incomes = transactions.filter(tx=>tx.kind==='income');
      const expenses = transactions.filter(tx=>tx.kind==='expense');
      renderSummary(incomes, incomeSummary, 'income');
      renderList(incomes, incomeList, 'income');
      renderSummary(expenses, expenseSummary, 'expense');
      renderList(expenses, expenseList, 'expense');
      refreshGoalBoxEuroIfAny();
    }

    function renderSummary(items, container, kind) {
        const totalAmount = items.reduce((s,tx)=>s+toNum(tx.amount),0);
        const categoryMap = allCategories.filter(cat => cat.kind === kind)
            .reduce((acc, cat) => ({...acc, [cat.id]: { name: cat.name, icon: cat.icon || '💸', total: 0 }}), {});

        items.forEach(tx => {
            if (categoryMap[tx.category_id]) {
                categoryMap[tx.category_id].total += toNum(tx.amount);
            }
        });
        
        const categoriesToRender = Object.values(categoryMap).filter(c=>c.total > 0).sort((a,b)=>b.total-a.total).slice(0, 5);
        const summaryTitle = kind === 'income' ? '🏆 Top 5 Entrate' : '🏆 Top 5 Uscite';
        
        const barsHTML = categoriesToRender.map(cat => {
            const percentage = totalAmount > 0 ? (cat.total / totalAmount) * 100 : 0;
            return `<div class="category-bar-item">
                <div class="category-bar-info">
                    <span class="category-bar-label"><span class="icon">${cat.icon}</span><span>${cat.name}</span></span>
                    <span class="category-bar-amount">${euro(cat.total)}</span>
                </div>
                <div class="progress-bar-bg"><div class="progress-bar-fg" style="width:${percentage}%"></div></div>
            </div>`;
        }).join('');

        container.innerHTML = `<h3><span>${summaryTitle}</span><span class="summary-total-amount">${euro(totalAmount)}</span></h3><div class="category-summary-bars">${barsHTML}</div>`;
    }

    function renderList(items, container, kind) {
        const totalAmount = items.reduce((s, tx) => s + toNum(tx.amount), 0);
        let content = `<div class="list-title"><span>Movimenti in ${kind === 'income' ? 'Entrata' : 'Uscita'}</span><span class="list-total-amount ${kind}">${euro(totalAmount)}</span></div>`;
        
        if (!items.length) {
            content += '<div class="empty-state"><p>Nessun movimento qui.</p></div>';
        } else {
            content += items.map(tx => {
                const cat = tx.categories;
                const sub = tx.subcategories;
                const icon = sub?.icon || cat?.icon || '💸';
                const categoryText = `${cat?.name || 'N/A'}` + (sub ? ` / ${sub.name}` : '');
                const amountNum = toNum(tx.amount);
                return `
                  <div class="item" data-id="${tx.id}">
                    <div class="item-icon">${icon}</div>
                    <div class="item-details"><span class="note">${tx.note ?? ''}</span><span class="category">${categoryText}</span></div>
                    <div class="item-amount ${tx.kind}">${tx.kind==='expense'?'-':'+'}${euro(amountNum)}</div>
                    <div class="item-actions">
                        <button class="action-btn edit-btn" data-id="${tx.id}">✍🏼</button>
                        <button class="action-btn delete-btn delete" data-id="${tx.id}">🗑️</button>
                    </div>
                  </div>`;
            }).join('');
        }
        container.innerHTML = content;
    }

    async function loadAllDataForMonth() {
      await loadTransactions();
      // Qui andrebbe la logica per scadenze e notifiche se necessaria
    }

    // ---- INITIALIZATION ----
    async function initializePage() {
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      if (!session || sessionError) {
          location.replace("/it/login.html");
          return;
      }
      user = session.user;

      const { data: profile } = await supabase.from('profiles').select('onboarded').eq('id', user.id).single();
      if (profile && !profile.onboarded) {
          location.replace("/it/onboarding.html");
          return;
      }

      const now = new Date();
      const months = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
      months.forEach((m, i) => monthSelector.add(new Option(m, i)));
      for (let y = now.getFullYear() - 2; y <= now.getFullYear() + 5; y++) yearSelector.add(new Option(y, y));
      monthSelector.value = now.getMonth();
      yearSelector.value = now.getFullYear();

      await loadInitialData();
      resetForm();
      await loadGoals();
      await loadAllDataForMonth();

      // ---- EVENT LISTENERS ----
      kindSelect.addEventListener('change', updateCategoryDropdown);
      categorySelect.addEventListener('change', () => updateSubcategories());
      transactionForm.addEventListener('submit', (e) => {
        e.preventDefault();
        saveTransaction(new FormData(transactionForm));
      });
      cancelEditBtn.addEventListener('click', resetForm);
      logoutBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        await supabase.auth.signOut();
        location.replace("/it/");
      });
      monthSelector.addEventListener('change', loadAllDataForMonth);
      yearSelector.addEventListener('change', loadAllDataForMonth);

      document.body.addEventListener('click', (e) => {
        const modal = e.target.closest('.modal-overlay');
        if (modal && (e.target.classList.contains('modal-overlay') || e.target.closest('.modal-close'))) {
          modal.classList.remove('is-visible');
        }
        
        const editBtn = e.target.closest('.edit-btn');
        if (editBtn) {
            populateAndShowEditForm(editBtn.dataset.id);
        }

        const deleteBtn = e.target.closest('.delete-btn');
        if (deleteBtn) {
            handleDelete(deleteBtn.dataset.id);
        }
      });
      
      document.getElementById('list-movements-btn').addEventListener('click', (e) => {
        const modal = document.getElementById('movements-modal');
        const modalBody = modal.querySelector('.movements-table-container');
        const modalFooter = document.getElementById('movements-modal-footer');
        document.getElementById('movements-modal-title').textContent = `Estratto Conto - ${months[monthSelector.value]} ${yearSelector.value}`;
        
        if (allTransactions.length === 0) {
            modalBody.innerHTML = '<div class="empty-state"><p>Nessun movimento per questo mese.</p></div>';
            modalFooter.innerHTML = '';
        } else {
            const tableRows = allTransactions.map(tx => `
              <tr class="${tx.kind}">
                <td>${new Date(tx.occurred_at).toLocaleDateString('it-IT')}</td>
                <td>${tx.kind === 'income' ? 'Entrata' : 'Uscita'}</td>
                <td>${tx.note || '-'}</td>
                <td>${(tx.categories?.name || 'N/A') + (tx.subcategories ? ` / ${tx.subcategories.name}`: '')}</td>
                <td class="amount-col">${euro(tx.amount)}</td>
              </tr>`).join('');

            modalBody.innerHTML = `<table class="movements-table"><thead><tr><th>Data</th><th>Tipo</th><th>Nota</th><th>Categoria</th><th class="amount-col">Importo</th></tr></thead><tbody>${tableRows}</tbody></table>`;
            
            const totalIncome = allTransactions.filter(t => t.kind === 'income').reduce((s, t) => s + toNum(t.amount), 0);
            const totalExpense = allTransactions.filter(t => t.kind === 'expense').reduce((s, t) => s + toNum(t.amount), 0);
            const balance = totalIncome - totalExpense;
            modalFooter.innerHTML = `<span>Tot. Entrate: <strong style="color:var(--success-color)">${euro(totalIncome)}</strong></span><span>Tot. Uscite: <strong style="color:var(--danger-color)">${euro(totalExpense)}</strong></span><span>Saldo: <strong style="color:${balance >= 0 ? 'var(--success-color)' : 'var(--danger-color)'}">${euro(balance)}</strong></span>`;
        }
        modal.classList.add('is-visible');
      });

      const mobileMenuBtn = document.getElementById('mobile-menu-btn');
      const topActions = document.querySelector('.top-actions');
      mobileMenuBtn.addEventListener('click', (e) => { e.stopPropagation(); topActions.classList.toggle('is-open'); });
      document.addEventListener('click', (e) => { if (!topActions.contains(e.target) && !mobileMenuBtn.contains(e.target)) topActions.classList.remove('is-open'); });
    }

    document.addEventListener('DOMContentLoaded', initializePage);
  </script>
</body>
</html>

