<!DOCTYPE html>
<html lang="it" data-app="myhomesbudget">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Il Tuo Profilo ‚Äî MyHomesBudget</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" href="/homes.png" type="image/png" sizes="32x32" />

  <style>
    :root{
      --fg:#0f1220;--bg:#eef3f9;--ink2:#41465b;
      --glass:rgba(255,255,255,.52);--glass-strong:rgba(255,255,255,.78);
      --border:rgba(15,18,32,.10);--shadow:0 20px 60px rgba(15,18,32,.16);
      --r-xl:28px;--r-lg:18px;--r-md:14px;--r-sm:10px;
      --primary:#6c5ce7;--mint:#00d1b2;--danger:#d05b6a;--success:#2e7d32;--warning:#f39c12;
      --grad:linear-gradient(135deg,#6c5ce7 0%,#00d1b2 100%);
      --panel-sheen:linear-gradient(180deg,rgba(255,255,255,.85),rgba(255,255,255,.58));
      --font:-apple-system,system-ui,"Segoe UI",Roboto,Inter,Arial,sans-serif;
    }
    *{box-sizing:border-box}
    html{font-family:var(--font);background:var(--bg);color:var(--fg)}
    body{margin:0;min-height:100vh;display:flex;flex-direction:column;background:url("/bg.webp") center/cover fixed}
    body::before{content:"";position:fixed;inset:0;background:linear-gradient(135deg,rgba(108,92,231,.06),rgba(0,209,178,.06));z-index:-1}

    /* Topbar */
    .topbar{position:fixed;top:0;left:0;right:0;height:60px;padding:0 16px;display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.65);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-bottom:1px solid var(--border);z-index:100}
    .logo-link{display:flex;gap:8px;align-items:center;text-decoration:none}
    .logo-text{font-weight:800;color:#1f2335}
    .top-center{position:absolute;left:50%;transform:translateX(-50%)}
    .top-actions{display:flex;gap:10px;align-items:center}
    .top-link,.top-btn{display:flex;align-items:center;justify-content:center;height:34px;padding:6px 12px;border-radius:12px;border:1px solid rgba(15,18,32,.08);font-weight:800;font-size:.9rem;text-decoration:none;background:#fff;color:#1f2335;box-shadow:0 6px 16px rgba(15,18,32,.06)}
    .notification-bell{position:relative}
    #scheduler-btn,#notifications-btn{min-width:38px;padding:0}
    .notification-badge{position:absolute;top:-6px;right:-6px;background:var(--danger);color:#fff;border-radius:999px;min-width:20px;height:20px;font-size:12px;font-weight:800;display:none;align-items:center;justify-content:center;border:2px solid #fff}
    .notification-badge.is-visible{display:flex}

    /* Container */
    main.container{padding:16px;padding-top:78px;max-width:1400px;margin:0 auto;width:100%;flex:1;display:flex;flex-direction:column}
    .dash-nav{display:flex;gap:8px;flex-wrap:wrap;border-bottom:1px solid rgba(15,18,32,.08);padding-bottom:12px;margin-bottom:22px}
    .dash-nav a{text-decoration:none;padding:8px 14px;border-radius:12px;font-weight:800;background:#fff;border:1px solid rgba(15,18,32,.08);color:#1f2335;box-shadow:0 6px 14px rgba(15,18,32,.06)}
    .dash-nav a.is-active{background:var(--grad);color:#fff;border:1px solid rgba(255,255,255,.6)}

    /* ===== Board a 2 colonne ===== */
    .board{display:grid;grid-template-columns:1.2fr .8fr;gap:18px;align-items:start}
    @media (max-width: 1024px){.board{grid-template-columns:1fr}}

    .card{background:var(--panel-sheen);backdrop-filter:blur(18px) saturate(150%);-webkit-backdrop-filter:blur(18px) saturate(150%);border:1px solid rgba(255,255,255,.55);box-shadow:var(--shadow),inset 0 1px 0 rgba(255,255,255,.8);border-radius:var(--r-xl)}

    /* ===== Card profilo (sinistra) ===== */
    .profile-card{position:relative;padding:32px 24px 20px}
    .profile-head{display:grid;grid-template-columns:auto 1fr;gap:16px;align-items:center}
    .avatar{position:relative;width:180px;height:180px;border-radius:20px;overflow:hidden;background:#fff;border:6px solid rgba(255,255,255,.96);box-shadow:0 22px 46px rgba(15,18,32,.18)}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .avatar::after{content:"";position:absolute;inset:-10px;border-radius:22px;background:conic-gradient(from 0deg, rgba(108,92,231,.35), rgba(0,209,178,.35), rgba(255,122,162,.32), rgba(108,92,231,.35));filter:blur(14px)}

    .identity{display:flex;flex-direction:column;gap:6px}
    .name{font-size:2rem;font-weight:900;letter-spacing:.2px;text-shadow:0 1px 0 rgba(255,255,255,.7)}
    .plan{width:max-content;background:var(--glass-strong);border:1px solid rgba(15,18,32,.06);border-radius:999px;padding:6px 12px;font-weight:900}

    .meta{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px}
    .meta .item{background:rgba(255,255,255,.92);border:1px solid rgba(15,18,32,.06);border-radius:14px;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;font-weight:700}

    .section-title{margin:18px 2px 10px;font-size:.95rem;text-transform:uppercase;letter-spacing:1px;color:#59607a;font-weight:900}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
    .field{background:rgba(255,255,255,.94);border:1px solid rgba(15,18,32,.06);border-radius:14px;padding:12px}
    .label{font-size:.82rem;color:#6a6f85;font-weight:900;margin-bottom:4px}
    .value{font-size:1.1rem;font-weight:900}
    .value.is-empty{color:#8a8fa6;font-style:italic}
    .input{display:none;width:100%;padding:10px 12px;border-radius:12px;border:1px solid #dcdfea;background:#fff;font-size:1rem}
    .is-editing .value{display:none}
    .is-editing .input{display:block}

    .actions{display:flex;gap:12px;justify-content:flex-end;margin-top:16px}
    .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 22px;font-weight:900}
    .btn-primary{background:var(--grad);color:#fff;box-shadow:0 16px 32px rgba(92,131,255,.28)}
    .btn-secondary{background:#fff;border:1px solid rgba(15,18,32,.12);color:#2a3047;box-shadow:0 8px 16px rgba(15,18,32,.06)}

    /* ===== Colonna destra: widget ===== */
    .widgets{display:grid;grid-template-columns:1fr;gap:18px}
    .widget{background:var(--panel-sheen);backdrop-filter:blur(18px) saturate(150%);-webkit-backdrop-filter:blur(18px) saturate(150%);border:1px solid rgba(255,255,255,.55);box-shadow:var(--shadow),inset 0 1px 0 rgba(255,255,255,.8);border-radius:var(--r-xl);padding:18px}
    .widget h4{margin:0 0 12px;font-size:1rem;color:#4a5070;font-weight:900}
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .calendar .day{padding:8px 0;text-align:center;border-radius:10px;background:rgba(255,255,255,.9);border:1px solid rgba(15,18,32,.06);font-weight:700}
    .events .event{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;background:rgba(255,255,255,.92);border:1px solid rgba(15,18,32,.06);border-radius:12px;padding:10px 12px}

    /* Toast */
    .status-toast{position:fixed;top:80px;left:50%;transform:translateX(-50%);padding:12px 22px;border-radius:999px;color:#fff;font-weight:800;box-shadow:0 12px 28px rgba(15,18,32,.25);z-index:1001;opacity:0;visibility:hidden;transition:opacity .25s ease, top .25s ease, visibility .25s ease}
    .status-toast.show{top:90px;opacity:1;visibility:visible}
    .status-toast.success{background:var(--success)}
    .status-toast.error{background:var(--danger)}
  </style>
</head>
<body>
  <div id="status-toast" class="status-toast"></div>

  <nav class="topbar">
    <a href="/it/dashboard.html" class="logo-link"><img src="/homes.png" alt="Logo" style="height:32px;border-radius:8px"/><span class="logo-text">MyHomesBudget</span></a>
    <div class="top-center"><a id="subscription-status-btn" href="/it/pricing.html" class="top-link" style="display:none;"></a></div>
    <div class="top-actions">
      <a href="/it/onboarding.html?edit=1" class="top-link">üéØ Obiettivo</a>
      <button id="scheduler-btn" class="top-btn">üóìÔ∏è</button>
      <button id="notifications-btn" class="top-btn notification-bell">üîî<span id="notification-badge" class="notification-badge"></span></button>
      <a href="#" id="logout-btn" class="top-link">Esci</a>
    </div>
  </nav>

  <main class="container">
    <nav class="dash-nav">
      <a href="/it/profile.html" class="is-active" aria-current="page">Profilo</a>
      <a href="/it/dashboard.html">Operazioni</a>
      <a href="/it/dashboard-riepilogo.html">Riepilogo</a>
    </nav>

    <section class="board">
      <!-- COLONNA SINISTRA -->
      <article class="card profile-card">
        <div class="profile-head">
          <div id="avatar-container" class="avatar"></div>
          <div class="identity">
            <div id="user-name" class="name">‚Äî</div>
            <div id="plan-type" class="plan">‚Äî</div>
          </div>
        </div>

        <h4 class="section-title">Contatti & Dettagli</h4>
        <div class="meta">
          <div class="item"><span>üìß Email</span><span id="user-email">‚Äî</span></div>
          <div class="item"><span>üéØ Obiettivo</span><span id="goal-name">‚Äî</span></div>
        </div>

        <h4 class="section-title">Informazioni personali</h4>
        <div id="personal-info-form" class="grid">
          <div class="field"><div class="label">üßë Genere</div><div class="value"></div><select id="gender-input" class="input"><option value="">Non specificato</option><option>Uomo</option><option>Donna</option><option>Altro</option></select></div>
          <div class="field"><div class="label">üéÇ Data di Nascita</div><div class="value"></div><input id="birthdate-input" type="date" class="input"/></div>
          <div class="field"><div class="label">üåç Paese</div><div class="value"></div><input id="country-input" class="input" placeholder="Es. Italia"/></div>
          <div class="field"><div class="label">üì± Numero di Telefono</div><div class="value"></div><input id="phone-input" class="input" placeholder="Es. +39 123..."/></div>
        </div>

        <div class="actions">
          <button id="edit-button" class="btn btn-secondary">Modifica</button>
          <button id="save-button" class="btn btn-primary" style="display:none">Salva Modifiche</button>
        </div>
      </article>

      <!-- COLONNA DESTRA (solo UI, no logica nuova) -->
      <aside class="widgets">
        <section class="widget">
          <h4>Calendario (UI)</h4>
          <div class="calendar" aria-hidden="true">
            <div class="day">Mo</div><div class="day">Tu</div><div class="day">We</div><div class="day">Th</div><div class="day">Fr</div><div class="day">Sa</div><div class="day">Su</div>
            <div class="day">1</div><div class="day">2</div><div class="day">3</div><div class="day">4</div><div class="day">5</div><div class="day">6</div><div class="day">7</div>
            <div class="day">8</div><div class="day">9</div><div class="day">10</div><div class="day">11</div><div class="day">12</div><div class="day">13</div><div class="day">14</div>
          </div>
        </section>
        <section class="widget events">
          <h4>Prossime Attivit√†</h4>
          <div class="event"><span>Revisione budget mensile</span><span>üóìÔ∏è 28/09</span></div>
          <div class="event" style="margin-top:8px"><span>Pagamento mutuo</span><span>üóìÔ∏è 05/10</span></div>
        </section>
      </aside>
    </section>
  </main>

  <div id="status-toast" class="status-toast"></div>

  <script type="module">
    import { supabase } from "/it/supabase-client.js";
    let currentUser=null; const toast=document.getElementById('status-toast'); const MAX_MB=2; const badge=document.getElementById('notification-badge'); const planBtn=document.getElementById('subscription-status-btn');
    const showToast=(m,t='success')=>{toast.textContent=m;toast.className=`status-toast ${t} show`;setTimeout(()=>toast.classList.remove('show'),3000)};

    function renderProfileData(profile, details){
      const avatar=document.getElementById('avatar-container');
      avatar.innerHTML=`<img id="profile-pic" src="${profile?.avatar_url||`https://placehold.co/360x360/6c5ce7/FFFFFF?text=${(profile?.name||'U').charAt(0)}`}" alt="Avatar"/><label for="avatar-upload" class="avatar-overlay" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.45);opacity:0;transition:.25s;border-radius:18px;cursor:pointer"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg></label><input id="avatar-upload" type="file" accept="image/*" style="display:none">`;
      avatar.addEventListener('mouseenter',()=>avatar.querySelector('.avatar-overlay').style.opacity=1);
      avatar.addEventListener('mouseleave',()=>avatar.querySelector('.avatar-overlay').style.opacity=0);
      document.getElementById('avatar-upload').addEventListener('change', uploadAvatar);

      document.getElementById('user-name').textContent=profile?.name||'Utente';
      document.getElementById('plan-type').textContent=profile?.plan_type||'starter';
      document.getElementById('user-email').textContent=currentUser?.email||'‚Ä¶';
      document.getElementById('goal-name').textContent=profile?.goal_name||'Nessun obiettivo';

      const form=document.getElementById('personal-info-form'); const d=details||{};
      const g=form.querySelector('.field:nth-child(1) .value'); g.textContent=d.gender||'Non impostato'; g.classList.toggle('is-empty',!d.gender); document.getElementById('gender-input').value=d.gender||'';
      const b=form.querySelector('.field:nth-child(2) .value'); b.textContent=d.birthdate?new Date(d.birthdate).toLocaleDateString('it-IT'):'Non impostata'; b.classList.toggle('is-empty',!d.birthdate); document.getElementById('birthdate-input').value=d.birthdate||'';
      const c=form.querySelector('.field:nth-child(3) .value'); c.textContent=d.country||'Non impostato'; c.classList.toggle('is-empty',!d.country); document.getElementById('country-input').value=d.country||'';
      const p=form.querySelector('.field:nth-child(4) .value'); p.textContent=d.phone||'Non impostato'; p.classList.toggle('is-empty',!d.phone); document.getElementById('phone-input').value=d.phone||'';
    }

    async function uploadAvatar(e){
      const input=e.target; if(!currentUser||!input.files?.length) return; const file=input.files[0]; if(file.size>MAX_MB*1024*1024){showToast(`Limite ${MAX_MB}MB`, 'error'); input.value=''; return}
      const ext=file.name.split('.').pop(); const path=`${currentUser.id}.${ext}`;
      try{ const { error:upErr }=await supabase.storage.from('avatars').upload(path,file,{upsert:true}); if(upErr) throw upErr; const { data:urlData }=supabase.storage.from('avatars').getPublicUrl(path,{transform:{ts:Date.now()}}); const url=urlData?.publicUrl; if(!url) throw new Error('URL mancante'); const { error:dbErr }=await supabase.from('profiles').update({avatar_url:url}).eq('id',currentUser.id); if(dbErr) throw dbErr; document.getElementById('profile-pic').src=url; showToast('Immagine aggiornata!')} catch(err){console.error(err); showToast('Errore immagine','error')} finally{ input.value=''}
    }

    function toggleEditMode(on){ const form=document.getElementById('personal-info-form'); form.classList.toggle('is-editing',on); document.getElementById('edit-button').style.display=on?'none':'inline-flex'; document.getElementById('save-button').style.display=on?'inline-flex':'none' }

    async function saveUserData(){
      const btn=document.getElementById('save-button'); btn.disabled=true; btn.textContent='Salvataggio...';
      const payload={ id:currentUser.id, gender:document.getElementById('gender-input').value||null, birthdate:document.getElementById('birthdate-input').value||null, country:document.getElementById('country-input').value||null, phone:document.getElementById('phone-input').value||null };
      const { data, error }=await supabase.from('personal_details').upsert(payload).select().single(); btn.disabled=false; btn.textContent='Salva Modifiche'; if(error){showToast('Errore durante il salvataggio','error');return} showToast('Profilo aggiornato!'); const { data:prof }=await supabase.from('profiles').select('*').eq('id',currentUser.id).single(); renderProfileData(prof, data); toggleEditMode(false)
    }

    function renderSubscriptionStatus(profile){ if(!profile?.plan_type){planBtn.style.display='none';return} let text='',link='#'; if(['starter','trial'].includes(profile.plan_type)){ if(profile.trial_end){ const end=new Date(profile.trial_end); const today=new Date(); today.setHours(0,0,0,0); const diff=Math.ceil((end-today)/(1000*60*60*24)); if(diff>=0){ text= diff>10?`‚ú® Sblocca tutto! ${diff} giorni rimasti`: diff>3?`‚è∞ L'offerta scade! ${diff} giorni rimasti`:`üî• Ultimo giorno!`; link='/it/pricing.html' } else { text='üò≠ Prova scaduta. Aggiorna ora!'; link='/it/pricing.html' } } } else if(profile.plan_type==='plus'){text='MyHomesBudget PLUS';link='/it/account.html'} else if(profile.plan_type==='pro'){text='MyHomesBudget PRO';link='/it/account.html'} if(text){planBtn.textContent=text; planBtn.href=link; planBtn.style.display='flex'} else planBtn.style.display='none' }

    async function initialize(){
      const { data:{ session } } = await supabase.auth.getSession(); if(!session){window.location.href='/it/login.html';return} currentUser=session.user
      const [pr,dr]=await Promise.all([ supabase.from('profiles').select('*').eq('id',currentUser.id).single(), supabase.from('personal_details').select('*').eq('id',currentUser.id).single() ])
      renderProfileData(pr.data, dr.data); renderSubscriptionStatus(pr.data)
      document.getElementById('edit-button').addEventListener('click',()=>toggleEditMode(true))
      document.getElementById('save-button').addEventListener('click',saveUserData)
      document.getElementById('logout-btn').addEventListener('click', async (e)=>{e.preventDefault(); await supabase.auth.signOut(); window.location.href='/it/'})
    }
    document.addEventListener('DOMContentLoaded', initialize)
  </script>
</body>
</html>
