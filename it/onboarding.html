<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Configurazione iniziale — Onboarding</title>
  <meta name="description" content="Imposta obiettivi, metodo e categorie per iniziare con il piede giusto.">
  <meta name="robots" content="noindex, nofollow">
  <meta name="color-scheme" content="light dark">
  <script>document.documentElement.classList.add('js');</script>

  <!-- CSP identica alla tua baseline; aggiungi solo ciò che già usi -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' https: data:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self' 'unsafe-inline' https://esm.sh;
                 connect-src 'self' https://*.supabase.co;
                 base-uri 'self';
                 form-action 'self'">

  <style>
    :root{
      /* Palette coerente con la tua app: neutri soft + accenti */
      --bg: rgba(255,255,255,0.6);
      --bg-dark: rgba(20,20,25,0.5);
      --glass: rgba(255,255,255,0.32);
      --glass-dark: rgba(30,30,40,0.38);
      --border: rgba(0,0,0,0.08);
      --border-dark: rgba(255,255,255,0.08);
      --txt: #111;
      --txt-dim: #555;
      --txt-inv: #fff;
      --brand: #5b8cff;     /* accento “calmo” */
      --brand-2: #7dd3fc;   /* accento secondario */
      --ok: #22c55e;
      --warn: #f59e0b;
      --danger: #ef4444;
      --radius: 16px;
      --radius-lg: 20px;
      --shadow: 0 8px 30px rgba(0,0,0,0.10);
    }
    @media (prefers-color-scheme: dark) {
      :root{
        --bg: var(--bg-dark);
        --glass: var(--glass-dark);
        --border: var(--border-dark);
        --txt: #f5f7fb;
        --txt-dim: #cfd3dc;
      }
    }

    /* Full-width glass topbar, come richiesto nel tuo layout */
    .topbar{
      position: sticky; top: 0; z-index: 50;
      display:flex; align-items:center; gap:16px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      background: var(--glass);
      border-bottom: 1px solid var(--border);
      padding: 10px 16px;
    }
    .topbar .left { flex: 1; display:flex; align-items:center; gap:12px; }
    .topbar .center { flex: 1; display:flex; justify-content:center; }
    .topbar .right { flex: 1; display:flex; justify-content:flex-end; gap:8px; }
    .badge{
      padding: 4px 10px; border-radius: 999px;
      font-size:12px; border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.25));
    }

    .page{
      max-width: 980px; margin: 24px auto; padding: 0 16px 56px;
    }

    /* Stepper */
    .stepper{
      display:flex; align-items:center; gap:12px; margin: 18px 0 24px;
    }
    .step{
      display:flex; align-items:center; gap:10px;
      padding: 10px 14px; border-radius: 999px;
      border:1px solid var(--border);
      background: var(--glass);
      transition:.25s ease;
    }
    .step[data-active="true"]{
      border-color: var(--brand);
      box-shadow: inset 0 0 0 1px rgba(91,140,255,.2);
    }
    .step .dot{
      width:10px; height:10px; border-radius:50%;
      background: var(--border);
    }
    .step[data-active="true"] .dot{ background: var(--brand); }

    /* Cards selezionabili */
    .grid{ display:grid; gap:14px; }
    @media(min-width: 860px){ .grid.cols-3{ grid-template-columns: repeat(3, 1fr);} .grid.cols-2{ grid-template-columns: repeat(2, 1fr);} }

    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.25));
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      cursor:pointer;
      transition: transform .15s ease, border-color .2s ease, box-shadow .2s ease;
    }
    .card:hover{ transform: translateY(-1px); }
    .card[data-selected="true"]{
      border-color: var(--brand);
      box-shadow: 0 6px 20px rgba(91,140,255,.15);
    }
    .card h3{ margin: 0 0 6px; font-size: 16px; }
    .card p{ margin: 0; font-size: 13px; color: var(--txt-dim); }

    .section{ margin: 18px 0 8px; font-weight:600; }
    .row{ display:grid; gap:12px; }
    @media(min-width:700px){ .row.cols-3{ grid-template-columns: repeat(3, 1fr);} .row.cols-2{ grid-template-columns: repeat(2, 1fr);} }

    input[type="text"], input[type="number"], input[type="date"]{
      width:100%; padding:12px 12px; border-radius: 12px;
      border:1px solid var(--border); background: rgba(255,255,255,.5);
      color: var(--txt);
    }
    .hint{ font-size:12px; color: var(--txt-dim); margin-top:6px;}

    /* Chips categorie */
    .chips{ display:flex; flex-wrap: wrap; gap:8px; }
    .chip{
      padding:8px 12px; border:1px solid var(--border);
      border-radius: 999px; cursor:pointer; font-size:13px;
      background: linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.2));
    }
    .chip[data-selected="true"]{
      border-color: var(--brand);
      box-shadow: inset 0 0 0 1px rgba(91,140,255,.18);
    }

    /* Nav bottom */
    .nav{
      display:flex; justify-content:space-between; gap:12px; margin-top: 22px;
    }
    .btn{
      appearance:none; border:1px solid var(--border); border-radius: 12px;
      padding:12px 16px; background: var(--glass); cursor:pointer;
      transition:.2s ease; font-weight:600;
    }
    .btn.primary{
      border-color: transparent;
      background: linear-gradient(90deg, var(--brand), var(--brand-2));
      color: var(--txt-inv);
    }
    .btn:disabled{ opacity:.6; cursor: not-allowed; }

    /* Review */
    .review{
      border:1px solid var(--border); border-radius: var(--radius-lg);
      padding:16px; background: linear-gradient(180deg, rgba(255,255,255,.7), rgba(255,255,255,.3));
    }
    .kv{ display:grid; grid-template-columns: 220px 1fr; gap:8px; font-size:14px; }
    .kv b{ color: var(--txt); }
    .spacer{ height:12px; }

    /* Toast */
    .toast{
      position: fixed; left:50%; bottom:20px; transform: translateX(-50%);
      background:#111; color:#fff; padding:10px 14px; border-radius:12px; opacity:0; pointer-events:none;
      transition:.25s ease; z-index:9999;
    }
    .toast[data-show="true"]{ opacity:1; transform: translateX(-50%) translateY(-4px); }
  </style>
</head>
<body>
  <!-- Topbar glass -->
  <header class="topbar">
    <div class="left">
      <div class="badge">Onboarding</div>
      <div id="editBadge" class="badge" style="display:none;">Modifica</div>
    </div>
    <div class="center">
      <div class="badge">Step <span id="stepNow">1</span>/3</div>
    </div>
    <div class="right">
      <!-- Azioni standard: es. lingue / esci se le usi globali -->
      <a class="badge" href="/it/index.html">Home</a>
    </div>
  </header>

  <main class="page">
    <h1 style="margin:0 0 6px;">Configura i tuoi obiettivi</h1>
    <p class="hint" style="margin:0 0 10px;">Un flusso rapido in tre passi. Tutto modificabile in seguito.</p>

    <!-- Stepper -->
    <div class="stepper" aria-hidden="true">
      <div class="step" data-step="1" data-active="true"><div class="dot"></div> Obiettivo</div>
      <div class="step" data-step="2"><div class="dot"></div> Metodo</div>
      <div class="step" data-step="3"><div class="dot"></div> Categorie</div>
    </div>

    <!-- STEP 1: Obiettivo -->
    <section id="step1">
      <div class="section">Scegli il tipo di obiettivo</div>
      <div class="grid cols-3" data-group="goal_type">
        <div class="card" data-value="generic_savings">
          <h3>Risparmio generico</h3>
          <p>Mettere da parte ogni mese, senza una destinazione fissa.</p>
        </div>
        <div class="card" data-value="debt_reduction">
          <h3>Riduzione debiti</h3>
          <p>Strategie “valanga” o “palla di neve” per liberarli in ordine.</p>
        </div>
        <div class="card" data-value="specific_goal">
          <h3>Obiettivo specifico</h3>
          <p>Vacanza, auto, fondo emergenze… con target & scadenza.</p>
        </div>
      </div>

      <div id="goal_specific_fields" style="display:none; margin-top:16px;">
        <div class="row cols-3">
          <div>
            <label class="section">Nome obiettivo</label>
            <input id="goal_name" type="text" placeholder="Es. Vacanza Zanzibar">
          </div>
          <div>
            <label class="section">Target (€)</label>
            <input id="target_amount" type="number" min="0" step="0.01" placeholder="Es. 2500">
            <div class="hint">Serve per calcolare la quota mensile consigliata.</div>
          </div>
          <div>
            <label class="section">Data target</label>
            <input id="target_date" type="date">
          </div>
        </div>
        <div class="hint" id="suggest_box" style="margin-top:8px;"></div>
      </div>

      <div class="nav">
        <button class="btn" disabled>Indietro</button>
        <button id="to2" class="btn primary">Continua</button>
      </div>
    </section>

    <!-- STEP 2: Metodo -->
    <section id="step2" style="display:none;">
      <div class="section">Come vuoi accantonare?</div>
      <div class="grid cols-3" data-group="method">
        <div class="card" data-value="fixed_amount">
          <h3>Importo fisso</h3>
          <p>La stessa cifra ogni mese. Disciplina pura.</p>
        </div>
        <div class="card" data-value="income_percent">
          <h3>% sulle entrate</h3>
          <p>Es. 20% di ciò che guadagni. Adatta e flessibile.</p>
        </div>
        <div class="card" data-value="variable_amount">
          <h3>Importo variabile</h3>
          <p>Decidi mese per mese quanto mettere da parte.</p>
        </div>
      </div>

      <div id="method_fields" style="margin-top:16px;">
        <div class="row cols-3" id="fixed_wrap" style="display:none;">
          <div>
            <label class="section">Importo mensile (€)</label>
            <input id="monthly_amount" type="number" min="0" step="0.01" placeholder="Es. 200">
          </div>
        </div>
        <div class="row cols-3" id="percent_wrap" style="display:none;">
          <div>
            <label class="section">Percentuale %</label>
            <input id="income_percent" type="number" min="1" max="60" step="1" placeholder="Es. 20">
            <div class="hint">Suggerimento: 20% è un buon inizio.</div>
          </div>
        </div>
      </div>

      <div class="nav">
        <button id="back1" class="btn">Indietro</button>
        <button id="to3" class="btn primary">Continua</button>
      </div>
    </section>

    <!-- STEP 3: Categorie -->
    <section id="step3" style="display:none;">
      <div class="row cols-2">
        <div>
          <div class="section">Entrate</div>
          <div class="chips" data-kind="income">
            <div class="chip" data-code="stipendio">Stipendio</div>
            <div class="chip" data-code="bonus">Bonus</div>
            <div class="chip" data-code="freelance">Freelance</div>
            <div class="chip" data-code="rendite">Rendite</div>
          </div>
        </div>
        <div>
          <div class="section">Uscite</div>
          <div class="chips" data-kind="expense">
            <div class="chip" data-code="affitto">Affitto/Mutuo</div>
            <div class="chip" data-code="spesa_alimentare">Spesa</div>
            <div class="chip" data-code="utenze">Utenze</div>
            <div class="chip" data-code="trasporti">Trasporti</div>
            <div class="chip" data-code="svago">Svago</div>
          </div>
        </div>
      </div>

      <div class="spacer"></div>
      <div class="review" id="review" aria-live="polite">
        <div class="section" style="margin:0;">Riepilogo</div>
        <div class="kv">
          <div><b>Tipo obiettivo</b></div><div id="kv_goal_type">—</div>
          <div><b>Nome/Target</b></div><div id="kv_goal_meta">—</div>
          <div><b>Metodo</b></div><div id="kv_method">—</div>
          <div><b>Parametri</b></div><div id="kv_method_meta">—</div>
          <div><b>Categorie entrata</b></div><div id="kv_inc">—</div>
          <div><b>Categorie uscita</b></div><div id="kv_exp">—</div>
        </div>
      </div>

      <div class="nav">
        <button id="back2" class="btn">Indietro</button>
        <button id="confirmBtn" class="btn primary">Conferma e salva</button>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite">Salvato</div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const supabase = createClient(window.__SUPABASE_URL__, window.__SUPABASE_ANON__);

    // ---------- Vibe helpers ----------
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const state = {
      step: 1,
      goal_type: null,
      goal_name: '',
      target_amount: null,
      target_date: null,
      method: null,
      monthly_amount: null,
      income_percent: null,
      income: new Set(),
      expense: new Set()
    };

    const isEdit = new URLSearchParams(location.search).get('edit') === '1';

    function toast(msg){
      const el = $('#toast'); el.textContent = msg; el.dataset.show = "true";
      setTimeout(()=> el.dataset.show = "false", 1800);
    }
    function setStep(n){
      state.step = n;
      $('#stepNow').textContent = n;
      // toggle sections
      ['#step1','#step2','#step3'].forEach((sel, i)=>{
        $(sel).style.display = (i+1===n)?'block':'none';
      });
      // stepper dots
      $$('.stepper .step').forEach(st => {
        st.dataset.active = (Number(st.dataset.step) === n) ? "true": "false";
      });
      // badge edit
      if(isEdit) $('#editBadge').style.display = 'inline-flex';
      // aggiorna review (quando visibile)
      if(n === 3) renderReview();
    }

    // ---------- Selectable Cards ----------
    function bindCards(){
      // goal_type
      $$('.grid[data-group="goal_type"] .card').forEach(card=>{
        card.addEventListener('click', ()=>{
          $$('.grid[data-group="goal_type"] .card').forEach(c=>c.dataset.selected="false");
          card.dataset.selected = "true";
          state.goal_type = card.dataset.value;
          $('#goal_specific_fields').style.display = (state.goal_type === 'specific_goal')?'block':'none';
          computeSuggestion();
        });
      });
      // method
      $$('.grid[data-group="method"] .card').forEach(card=>{
        card.addEventListener('click', ()=>{
          $$('.grid[data-group="method"] .card').forEach(c=>c.dataset.selected="false");
          card.dataset.selected = "true";
          state.method = card.dataset.value;
          $('#fixed_wrap').style.display = (state.method === 'fixed_amount' || state.method === 'variable_amount') ? 'grid' : 'none';
          $('#percent_wrap').style.display = (state.method === 'income_percent') ? 'grid' : 'none';
        });
      });
    }

    // ---------- Chips ----------
    function bindChips(){
      $$('.chips .chip').forEach(ch=>{
        ch.addEventListener('click', ()=>{
          const kind = ch.closest('.chips').dataset.kind; // income | expense
          const code = ch.dataset.code;
          const set = state[kind];
          if(ch.dataset.selected === "true"){
            ch.dataset.selected = "false"; set.delete(code);
          }else{
            ch.dataset.selected = "true"; set.add(code);
          }
          if(state.step===3) renderReview();
        });
      });
    }

    // ---------- Inputs ----------
    function bindInputs(){
      $('#goal_name').addEventListener('input', e=>{ state.goal_name = e.target.value; computeSuggestion(); });
      $('#target_amount').addEventListener('input', e=>{ state.target_amount = numOrNull(e.target.value); computeSuggestion(); });
      $('#target_date').addEventListener('input', e=>{ state.target_date = e.target.value || null; computeSuggestion(); });
      $('#monthly_amount').addEventListener('input', e=>{ state.monthly_amount = numOrNull(e.target.value); if(state.step===3) renderReview(); });
      $('#income_percent').addEventListener('input', e=>{ state.income_percent = numOrNull(e.target.value); if(state.step===3) renderReview(); });
    }

    function numOrNull(v){ const n=Number(v); return Number.isFinite(n)?n:null; }

    function monthsBetween(nowISO, futureISO){
      if(!futureISO) return null;
      const now = new Date(nowISO);
      const fut = new Date(futureISO);
      let months = (fut.getFullYear()-now.getFullYear())*12 + (fut.getMonth()-now.getMonth());
      // se il giorno del futuro è sotto l'oggi, riduci di 1 per stimare "mesi interi residui"
      if(fut.getDate() < now.getDate()) months -= 1;
      return Math.max(1, months);
    }

    function computeSuggestion(){
      if(state.goal_type !== 'specific_goal'){ $('#suggest_box').textContent = ""; return; }
      const m = monthsBetween(new Date().toISOString(), state.target_date);
      if(state.target_amount && m){
        const perMonth = Math.ceil((state.target_amount / m) * 100) / 100;
        $('#suggest_box').textContent = `Suggerimento: per raggiungere €${state.target_amount} entro ${state.target_date} servono ~€${perMonth}/mese.`;
      }else{
        $('#suggest_box').textContent = "";
      }
    }

    // ---------- Review ----------
    function renderReview(){
      $('#kv_goal_type').textContent = ({
        generic_savings: 'Risparmio generico',
        debt_reduction: 'Riduzione debiti',
        specific_goal: 'Obiettivo specifico'
      }[state.goal_type] || '—');

      if(state.goal_type === 'specific_goal'){
        const bits = [];
        if(state.goal_name) bits.push(`Nome: ${state.goal_name}`);
        if(state.target_amount!=null) bits.push(`Target: €${state.target_amount}`);
        if(state.target_date) bits.push(`Data: ${state.target_date}`);
        $('#kv_goal_meta').textContent = bits.join(' — ') || '—';
      }else{
        $('#kv_goal_meta').textContent = '—';
      }

      $('#kv_method').textContent = ({
        fixed_amount: 'Importo fisso',
        income_percent: '% sulle entrate',
        variable_amount: 'Importo variabile'
      }[state.method] || '—');

      if(state.method === 'income_percent' && state.income_percent!=null){
        $('#kv_method_meta').textContent = `Percentuale: ${state.income_percent}%`;
      }else if((state.method==='fixed_amount'||state.method==='variable_amount') && state.monthly_amount!=null){
        $('#kv_method_meta').textContent = `Importo: €${state.monthly_amount}/mese`;
      }else{
        $('#kv_method_meta').textContent = '—';
      }

      $('#kv_inc').textContent = state.income.size ? Array.from(state.income).join(', ') : '—';
      $('#kv_exp').textContent = state.expense.size ? Array.from(state.expense).join(', ') : '—';
    }

    // ---------- Nav ----------
    function bindNav(){
      $('#to2').addEventListener('click', ()=>{
        if(!state.goal_type){ toast('Seleziona un tipo di obiettivo'); return; }
        setStep(2);
      });
      $('#to3').addEventListener('click', ()=>{
        if(!state.method){ toast('Seleziona un metodo'); return; }
        // con percent serve valore, con fixed/variable se inserito lo leggiamo (non obbligatorio)
        setStep(3);
      });
      $('#back1').addEventListener('click', ()=> setStep(1));
      $('#back2').addEventListener('click', ()=> setStep(2));
    }

    // ---------- Preload per edit=1 ----------
    async function preloadIfEdit(){
      if(!isEdit) return;
      const { data: { user } } = await supabase.auth.getUser();
      if(!user) return;

      // goal
      const { data: goal } = await supabase
        .from('app_goals')
        .select('*')
        .eq('user_id', user.id)
        .order('updated_at', { ascending:false })
        .limit(1)
        .maybeSingle();

      if(goal){
        state.goal_type = goal.goal_type;
        // attiva card
        if(state.goal_type){
          const card = document.querySelector(`.grid[data-group="goal_type"] .card[data-value="${state.goal_type}"]`);
          if(card) card.dataset.selected = "true";
        }
        if(goal.goal_type === 'specific_goal'){
          $('#goal_specific_fields').style.display = 'block';
          $('#goal_name').value = goal.goal_name || '';
          $('#target_amount').value = goal.target_amount ?? '';
          $('#target_date').value = goal.target_date ?? '';
          state.goal_name = goal.goal_name || '';
          state.target_amount = goal.target_amount ?? null;
          state.target_date = goal.target_date ?? null;
          computeSuggestion();
        }

        // method
        const { data: method } = await supabase
          .from('app_goal_method')
          .select('*')
          .eq('goal_id', goal.id)
          .maybeSingle();

        if(method){
          state.method = method.method;
          const mcard = document.querySelector(`.grid[data-group="method"] .card[data-value="${state.method}"]`);
          if(mcard) mcard.dataset.selected = "true";

          if(method.method === 'income_percent'){
            $('#percent_wrap').style.display = 'grid';
            $('#income_percent').value = method.income_percent ?? '';
            state.income_percent = method.income_percent ?? null;
          }else{
            $('#fixed_wrap').style.display = 'grid';
            $('#monthly_amount').value = method.monthly_amount ?? '';
            state.monthly_amount = method.monthly_amount ?? null;
          }
        }

        // categories
        const { data: cats } = await supabase
          .from('app_user_categories')
          .select('kind, category_code')
          .eq('user_id', user.id);

        if(cats){
          cats.forEach(c=>{
            const chip = document.querySelector(`.chips[data-kind="${c.kind}"] .chip[data-code="${c.category_code}"]`);
            if(chip){ chip.dataset.selected = "true"; state[c.kind].add(c.category_code); }
          });
        }
      }

      $('#editBadge').style.display = 'inline-flex';
    }

    // ---------- Save ----------
    async function saveOnboarding(){
      const { data: { user } } = await supabase.auth.getUser();
      if(!user){ toast('Accedi per salvare'); return; }

      // Scrittura “pulita” e compatibile
      // 1) UPSERT goal (un record per user_id)
      const { data: goalRow, error: eg } = await supabase
        .from('app_goals')
        .upsert([{
          user_id: user.id,
          goal_type: state.goal_type,
          goal_name: state.goal_name || null,
          target_amount: state.target_amount,
          target_date: state.target_date
        }], { onConflict: 'user_id' })
        .select()
        .maybeSingle();
      if(eg){ console.error(eg); toast('Errore salvataggio obiettivo'); return; }

      // 2) UPSERT method (1:1 su goal_id)
      const { error: em } = await supabase
        .from('app_goal_method')
        .upsert([{
          goal_id: goalRow.id,
          method: state.method,
          monthly_amount: (state.method==='income_percent') ? null : state.monthly_amount,
          income_percent: (state.method==='income_percent') ? state.income_percent : null
        }], { onConflict: 'goal_id' });
      if(em){ console.error(em); toast('Errore salvataggio metodo'); return; }

      // 3) Categorie (wipe & insert dell’istantanea selezionata)
      await supabase.from('app_user_categories').delete().eq('user_id', user.id);
      const rows = [
        ...Array.from(state.income).map(code => ({ user_id: user.id, kind:'income', category_code: code })),
        ...Array.from(state.expense).map(code => ({ user_id: user.id, kind:'expense', category_code: code }))
      ];
      if(rows.length){
        const { error: ec } = await supabase.from('app_user_categories').insert(rows);
        if(ec){ console.error(ec); toast('Errore salvataggio categorie'); return; }
      }

      // 4) Stato onboarding
      await supabase.from('app_onboarding_state')
        .upsert([{ user_id: user.id, completed: true, last_step: 3 }], { onConflict: 'user_id' });

      toast('Onboarding salvato');
      // Redirect “soft”: portiamo in app
      setTimeout(()=> location.href = '/app/dashboard.html', 600);
    }

    // ---------- Boot ----------
    bindCards(); bindChips(); bindInputs(); bindNav();
    setStep(1);
    preloadIfEdit();

    // Actions
    $('#confirmBtn').addEventListener('click', saveOnboarding);
  </script>
</body>
</html>
