<!doctype html>
<html lang="it" data-app="myhomesbudget">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard — MyHomesBudget</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" href="/homes.png" type="image/png" sizes="32x32">

  <style>
    :root{
      --fg:#111;--bg:#f4f7fa;--glass:rgba(255,255,255,.6);
      --card-border:rgba(0,0,0,.08);--shadow:0 10px 30px rgba(0,0,0,.08);
      --radius-lg:16px;--primary-color:#6c5ce7;--danger-color:#d32f2f;--success-color:#2e7d32;
      --warning-color:#f39c12;
      --font-sans:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif;
      --grad:linear-gradient(135deg,#6c5ce7,#00cec9);
      --grad-danger:linear-gradient(135deg,#d32f2f,#ff7675);
    }
    *{box-sizing:border-box}
    html{font-family:var(--font-sans);background-color:var(--bg)}
    body{margin:0;color:var(--fg);background:url("/bg.webp") no-repeat center/cover fixed;min-height:100vh}
    body::before{content:"";position:fixed;inset:0;background:linear-gradient(135deg,rgba(108,92,231,.05),rgba(0,206,201,.05));z-index:-1}

    .topbar{position:fixed;top:0;left:0;right:0;height:60px;padding:0 24px;display:flex;align-items:center;justify-content:space-between;background:var(--glass);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-bottom:1px solid var(--card-border);z-index:100}
    .logo-link{display:flex;align-items:center;gap:8px;text-decoration:none}
    .logo-text{font-weight:600;color:#fff;font-size:1.1rem;text-shadow:0 1px 2px rgba(0,0,0,.35)}
    .top-actions{display:flex;gap:12px;align-items:center}
    .top-link,.top-btn{display:flex;align-items:center;justify-content:center;height:34px;color:#fff;text-decoration:none;padding:6px 12px;border-radius:10px;font-size:.9rem;font-weight:600;background:var(--grad);border:none;box-shadow:0 4px 12px rgba(0,0,0,.15);cursor:pointer; white-space: nowrap;}
    .date-selectors{display:flex;gap:8px}
    .select-wrapper{position:relative;display:flex;align-items:center;height:34px;border-radius:10px;background:var(--grad);box-shadow:0 4px 12px rgba(0,0,0,.15)}
    .select-wrapper::after{content:'▼';font-size:10px;color:rgba(255,255,255,0.8);position:absolute;right:10px;top:50%;transform:translateY(-50%);pointer-events:none}
    .topbar-select{appearance:none;background:transparent;color:#fff;border:none;padding:6px 28px 6px 12px;font-size:.9rem;font-weight:600;cursor:pointer}
    .topbar-select option{background:#fff;color:#000}
    main.container{padding:84px 24px 24px;max-width:1280px;margin:0 auto;width:100%}
    .dash-nav{display:flex;gap:8px;border-bottom:1px solid rgba(0,0,0,.1);padding-bottom:12px;margin-bottom:24px}
    .dash-nav a,.dash-nav button{text-decoration:none;padding:8px 16px;border-radius:10px;font-weight:600;background:var(--grad);color:#fff;box-shadow:0 4px 12px rgba(0,0,0,.1);border:none;font-family:var(--font-sans);font-size:1rem;cursor:pointer}
    .content-section{background:rgba(255,255,255,.85);border-radius:var(--radius-lg);padding:16px;border:1px solid var(--card-border);box-shadow:var(--shadow)}
    .dashboard-panel{background:rgba(255,255,255,0.55);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border-radius:var(--radius-lg);padding:24px;border:1px solid var(--card-border);box-shadow:var(--shadow)}
    .dashboard-grid{display:grid;grid-template-columns:1fr;gap:24px}@media(min-width:1024px){.dashboard-grid{grid-template-columns:repeat(2,1fr)}}
    .flow-column h2{font-size:1.5rem;margin:0 0 16px;padding:0 8px}
    .income h2{color:var(--success-color)}
    .expense h2{color:var(--danger-color)}
    .summary-card{background:#fff;padding:16px;border-radius:var(--radius-lg);margin-bottom:16px}
    .summary-card h3{display:flex;justify-content:space-between;align-items:center;margin:0;font-size:1rem;color:#555}
    .summary-total-amount{font-weight:800;font-size:1.2rem}
    .income .summary-total-amount{color:var(--success-color)}
    .expense .summary-total-amount{color:var(--danger-color)}
    .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;font-weight:800;color:#fff;transition:all .2s ease}
    .btn:hover:not(:disabled) { transform: translateY(-2px); filter: brightness(1.08); }
    .btn-primary{background:var(--grad);box-shadow:0 10px 24px rgba(0,0,0,.18)}
    .btn-secondary{background:#f0f0f0;color:#555;border:1px solid #ddd;box-shadow:0 4px 8px rgba(0,0,0,0.05)}
    .transaction-form{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:flex-end}
    .form-group{display:flex;flex-direction:column}
    .form-group label{font-weight:600;font-size:.9rem;margin-bottom:6px}
    .form-group input,.form-group select{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;background:#fff;font-size:1rem}
    .form-buttons{grid-column:1 / -1;margin-top:10px}
    .transaction-list .item{display:grid;grid-template-columns:1fr auto;gap:12px;padding:12px 4px;border-bottom:1px solid rgba(0,0,0,.05)}
    .item-details .note{font-weight:600}.item-details .category{font-size:.9rem;color:#555}
    .item-amount.expense{color:var(--danger-color);font-weight:700}
    .item-amount.income{color:var(--success-color);font-weight:700}
    .empty-state, .diagnostic-card{text-align:center;padding:24px;background:rgba(0,0,0,0.02);border-radius:12px;margin:16px 0;}
    .diagnostic-card.error { background-color: #ffebee; border-left: 5px solid var(--danger-color); color: #333; text-align: left; }
    .diagnostic-card p { margin: 0; } .diagnostic-card .details { font-size: 0.8rem; color: #555; margin-top: 8px; font-family: monospace; }
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;pointer-events:none;transition:opacity .3s ease}
    .modal-overlay.is-visible{opacity:1;pointer-events:auto}
    .modal-content{background:var(--bg);border-radius:var(--radius-lg);padding:24px;width:90%;max-width:500px;box-shadow:var(--shadow);transform:scale(.95);transition:transform .3s ease}
    .modal-overlay.is-visible .modal-content{transform:scale(1)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--card-border);padding-bottom:12px;margin-bottom:16px}
    .modal-title{margin:0;font-size:1.3rem}
    .modal-close{background:none;border:none;font-size:2rem;cursor:pointer;color:#888;padding:0}
    .modal-footer{margin-top:20px;display:flex;justify-content:flex-end;gap:12px}
    .status-message{padding:12px;border-radius:10px;margin-top:16px;text-align:center;font-weight:600;grid-column:1 / -1; color: #fff;}
    .status-message.success{background-color:var(--success-color)}
    .status-message.error{background-color:var(--danger-color)}

    /* --- Stili Nuova Sezione Obiettivi --- */
    #goals-section .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    #goals-list{display:flex;flex-direction:column;gap:20px;}
    .goal-card{background:#fff;border-radius:12px;padding:16px 20px;box-shadow:var(--shadow); overflow: hidden;}
    .goal-card-header{display:flex;justify-content:space-between;align-items:center;gap:16px;}
    .goal-title{font-size:1.2rem;font-weight:700;margin:0;color:#333}
    .goal-card-main{margin-top:16px; display: grid; grid-template-columns: 1fr; gap: 16px;}
    @media(min-width: 600px) { .goal-card-main { grid-template-columns: 1fr 1fr; } }
    .goal-progress-display, .goal-contribution-display{background: #f8f9fa; padding: 12px; border-radius: 8px; border: 1px solid #e9ecef;}
    .goal-progress-display h4, .goal-contribution-display h4 { margin: 0 0 8px; font-size: 0.9rem; color: #555; font-weight: 600; }
    .progress-bar-bg{width:100%;height:12px;background-color:rgba(0,0,0,0.08);border-radius:999px;overflow:hidden}
    .progress-bar-fg{height:100%;border-radius:999px;transition:width .5s ease-out; background: var(--grad)}
    .progress-text{font-weight:600;margin-top:8px;text-align:right;color:#333; font-size: 0.9rem;}
    .contribution-amount { font-size: 1.5rem; font-weight: 800; color: var(--primary-color); }
    .contribution-details { font-size: 0.85rem; color: #666; margin-top: 4px; }
    .goal-card-footer{margin-top:16px;display:flex;justify-content:center;}
    .goal-editor{max-height:0;opacity:0;visibility: hidden; transition: all .4s ease; border-top: 1px solid var(--card-border); margin-top: 0; padding-top: 0;}
    .goal-card.is-editing .goal-editor{max-height:500px;opacity:1;visibility: visible; margin-top:16px;padding-top:16px;}
    .editor-grid{display:grid;gap:16px;}
    .chip-group{display:flex;gap:8px;}
    .chip{padding:8px 12px;border-radius:999px;background:rgba(0,0,0,0.05);font-weight:600;cursor:pointer;user-select:none;transition: all .2s ease;}
    .chip.is-active{background:var(--grad);color:#fff;box-shadow:0 4px 10px rgba(0,0,0,.12)}
    .editor-actions{display:flex;gap:12px;justify-content:flex-end; margin-top: 16px;}
  </style>
</head>
<body>
  <nav class="topbar">
    <a href="/it/" class="logo-link"><img src="/homes.png" alt="Logo" style="height:32px;border-radius:6px"><span class="logo-text">MyHomesBudget</span></a>
    <div class="top-actions">
      <div class="date-selectors">
        <div class="select-wrapper"><select id="month-selector" class="topbar-select"></select></div>
        <div class="select-wrapper"><select id="year-selector" class="topbar-select"></select></div>
      </div>
      <a href="/it/onboarding.html?edit=1" class="top-link">🎯 Obiettivo</a>
      <a href="#" id="logout-btn" class="top-link">Esci</a>
    </div>
  </nav>

  <main class="container">
    <nav id="dash-nav" class="dash-nav"><a href="/it/profile.html">Profilo</a><a href="/it/dashboard.html" class="is-active">Operazioni</a></nav>

    <section class="content-section form-section">
      <h2 style="margin:0 0 16px">Nuova Operazione</h2>
      <form id="transaction-form" class="transaction-form">
        <div class="form-group"><label for="kind">Tipo</label><select id="kind" name="kind" required><option value="expense">Uscita</option><option value="income">Entrata</option></select></div>
        <div class="form-group"><label for="note">Nota</label><input type="text" id="note" name="note" required></div>
        <div class="form-group"><label for="amount">Importo (€)</label><input type="number" id="amount" name="amount" step="0.01" required></div>
        <div class="form-group"><label for="occurred_at">Data</label><input type="date" id="occurred_at" name="occurred_at" required></div>
        <div class="form-group"><label for="category_id">Categoria</label><select id="category_id" name="category_id" required></select></div>
        <div class="form-buttons"><button type="submit" class="btn btn-primary" style="width:100%;">Aggiungi</button></div>
      </form>
    </section>

    <section id="goals-section" class="content-section" style="margin-top:12px;">
      <div class="header">
        <h3 style="margin:0;">🎯 I Tuoi Obiettivi</h3>
        <button id="add-goal-btn" class="btn btn-primary" style="display: none; padding: 8px 14px; font-size: 0.9rem;">+ Aggiungi Obiettivo</button>
      </div>
      <div id="goals-list"><div class="empty-state">Caricamento obiettivi...</div></div>
    </section>

    <div class="dashboard-panel" style="margin-top:12px;">
      <div class="dashboard-grid">
        <div class="flow-column income"><h2>✅ Entrate</h2><div id="income-summary" class="summary-card"></div><div id="income-list" class="content-section transaction-list"></div></div>
        <div class="flow-column expense"><h2>❌ Uscite</h2><div id="expense-summary" class="summary-card"></div><div id="expense-list" class="content-section transaction-list"></div></div>
      </div>
    </div>
  </main>

  <div id="generic-modal" class="modal-overlay"><div class="modal-content"><div class="modal-header"><h3 id="generic-modal-title" class="modal-title"></h3><button class="modal-close">&times;</button></div><div id="generic-modal-body"></div><div id="generic-modal-footer"></div></div></div>
  
  <script type="module">
    import { supabase } from "/it/supabase-client.js";
    
    let user = null, allCategories = [], allTransactions = [], userProfile = null;

    const $ = (selector) => document.querySelector(selector);
    const fmt = (n) => Number(n || 0).toFixed(2);
    const safeToNumber = (v) => { const n = parseFloat(String(v).replace(',', '.')); return isFinite(n) ? n : 0; };

    function showModal(title, bodyHtml, buttons = []) {
      $('#generic-modal-title').textContent = title;
      $('#generic-modal-body').innerHTML = bodyHtml;
      const footer = $('#generic-modal-footer');
      footer.innerHTML = '';
      buttons.forEach(b => {
        const btn = document.createElement('button');
        btn.textContent = b.text;
        btn.className = `btn ${b.class || 'btn-secondary'}`;
        btn.onclick = () => { b.action?.(); if (!b.keepOpen) $('#generic-modal').classList.remove('is-visible'); };
        footer.appendChild(btn);
      });
      $('#generic-modal').classList.add('is-visible');
    }

    // --- LOGICA TRANSAZIONI ---
    async function loadInitialData() {
        const [{data: cats, error: catErr}, {data: trans, error: transErr}] = await Promise.all([
            supabase.from('categories').select('*').eq('user_id', user.id),
            loadTransactionsForCurrentMonth()
        ]);
        if (catErr) console.error('Error loading categories:', catErr);
        if (transErr) console.error('Error loading transactions:', transErr);
        allCategories = cats || [];
        allTransactions = trans || [];
        renderDashboard(allTransactions);
        updateCategoryDropdown();
    }
    
    function updateCategoryDropdown() {
        const kind = $('#kind').value;
        const filtered = allCategories.filter(c => c.kind === kind);
        $('#category_id').innerHTML = '<option value="">Seleziona</option>' + filtered.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }

    async function handleFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        try {
            const { error } = await supabase.from('transactions').insert({ user_id: user.id, ...data });
            if (error) throw error;
            form.reset();
            $('#occurred_at').valueAsDate = new Date();
            await refreshData();
        } catch (error) { alert(`Errore: ${error.message}`); }
    }

    async function loadTransactionsForCurrentMonth() {
        const year = $('#year-selector').value;
        const month = $('#month-selector').value;
        const startDate = `${year}-${String(parseInt(month) + 1).padStart(2, '0')}-01`;
        const endDate = new Date(year, parseInt(month) + 1, 0).toISOString().split('T')[0];
        return supabase.from('transactions').select(`*, category:category_id(name)`).eq('user_id', user.id).gte('occurred_at', startDate).lte('occurred_at', endDate);
    }

    function renderDashboard(transactions) {
        const incomes = transactions.filter(tx => tx.kind === 'income');
        const expenses = transactions.filter(tx => tx.kind === 'expense');
        const renderList = (items, container) => container.innerHTML = items.length === 0 ? `<div class="empty-state">Nessuna operazione.</div>` : items.map(item => `<div class="item"><div class="item-details"><div class="note">${item.note}</div><div class="category">${item.category?.name || ''}</div></div><div class="item-amount ${item.kind}">${fmt(item.amount)}€</div></div>`).join('');
        const renderSummary = (items, container, kind) => container.innerHTML = `<h3><span>Totale ${kind}</span><span class="summary-total-amount">${fmt(items.reduce((sum, i) => sum + safeToNumber(i.amount), 0))}€</span></h3>`;
        renderList(incomes, $('#income-list'));
        renderSummary(incomes, $('#income-summary'), 'Entrate');
        renderList(expenses, $('#expense-list'));
        renderSummary(expenses, $('#expense-summary'), 'Uscite');
    }

    // --- LOGICA OBIETTIVI (DEFINITIVA) ---
    async function migrateOnboardingGoalIfNeeded() {
        if (!userProfile?.goal_name) return;
        const { count, error } = await supabase.from('obiettivi').select('id', { count: 'exact', head: true }).eq('user_id', user.id);
        if (error) { console.error("Goal check failed:", error); return; }
        if (count === 0) {
            console.log("Migrating goal from onboarding...");
            await supabase.from('obiettivi').insert({ user_id: user.id, nome_obiettivo: userProfile.goal_name, importo_target: userProfile.goal_target_amount, importo_mensile: userProfile.contribution_amount, metodo_contribuzione: userProfile.contribution_method || 'Cifra fissa' });
        }
    }

    async function loadAndRenderGoals() {
        const { data: goals, error } = await supabase.from('obiettivi').select('*').eq('user_id', user.id);
        const goalsList = $('#goals-list');
        if (error) {
            goalsList.innerHTML = `<div class="diagnostic-card error"><p><strong>Errore Caricamento Obiettivi</strong></p><p class="details">${error.message}. Assicurati che le policy RLS siano attive.</p></div>`;
            return;
        }
        $('#add-goal-btn').style.display = userProfile?.plan_type === 'pro' ? 'block' : 'none';
        if (!goals || goals.length === 0) {
            goalsList.innerHTML = `<div class="empty-state">Nessun obiettivo impostato. ${userProfile?.plan_type === 'pro' ? 'Clicca su "+ Aggiungi Obiettivo" per crearne uno.' : '<a href="/it/onboarding.html?edit=1">Creane uno ora!</a>'}</div>`;
            return;
        }
        goalsList.innerHTML = '';
        goals.forEach(goal => {
            const card = document.createElement('div');
            card.className = 'goal-card';
            card.id = `goal-card-${goal.id}`;
            goalsList.appendChild(card);
            renderGoalCard(card, goal, goals.length > 1);
        });
    }

    function renderGoalCard(cardElement, goal, canDelete) {
        const totalIncomes = allTransactions.filter(tx => tx.kind === 'income').reduce((sum, tx) => sum + safeToNumber(tx.amount), 0);
        let contributionAmount = safeToNumber(goal.importo_mensile);
        let contributionDetail = `Importo fisso mensile`;
        if (goal.metodo_contribuzione === 'Percentuale sulle entrate') {
            contributionAmount = totalIncomes * (safeToNumber(goal.importo_mensile) / 100);
            contributionDetail = `${goal.importo_mensile}% delle entrate (${fmt(totalIncomes)}€)`;
        }

        cardElement.innerHTML = `
            <div class="goal-card-header">
                <h4 class="goal-title">${goal.nome_obiettivo}</h4>
                <button class="btn btn-secondary" style="padding:6px 12px;" onclick="window.toggleGoalEditor(${goal.id})">Gestisci</button>
            </div>
            <div class="goal-card-main">
                <div class="goal-progress-display">
                    <h4>Progresso</h4>
                    <div class="progress-bar-bg"><div class="progress-bar-fg" id="progress-bar-${goal.id}"></div></div>
                    <div class="progress-text" id="progress-text-${goal.id}">...</div>
                </div>
                <div class="goal-contribution-display">
                    <h4>Prossimo Risparmio</h4>
                    <div class="contribution-amount">${fmt(contributionAmount)}€</div>
                    <div class="contribution-details">${contributionDetail}</div>
                </div>
            </div>
            <div class="goal-card-footer">
                <button class="btn btn-primary" style="width: 100%;" onclick="window.recordSaving(${goal.id}, ${contributionAmount})">✅ Registra Risparmio di ${fmt(contributionAmount)}€</button>
            </div>
            <div class="goal-editor">
                <div class="editor-grid">
                    <div class="form-group">
                        <label>Metodo di Contribuzione</label>
                        <div class="chip-group">
                            <span class="chip ${goal.metodo_contribuzione === 'Cifra fissa' ? 'is-active' : ''}" data-method="Cifra fissa">Cifra fissa</span>
                            <span class="chip ${goal.metodo_contribuzione === 'Percentuale sulle entrate' ? 'is-active' : ''}" data-method="Percentuale sulle entrate">% sulle entrate</span>
                        </div>
                    </div>
                    <div class="form-group" id="editor-amount-${goal.id}">
                        <label>Importo Fisso (€)</label>
                        <input type="number" class="goal-editor-amount" value="${goal.importo_mensile || ''}" step="0.01">
                    </div>
                    <div class="form-group" id="editor-percent-${goal.id}" style="display:none;">
                        <label>Percentuale (%)</label>
                        <input type="number" class="goal-editor-percent" value="${goal.importo_mensile || ''}" step="0.1">
                        <small>Corrisponde a: <strong id="percent-preview-${goal.id}">0.00€</strong></small>
                    </div>
                </div>
                <div class="editor-actions">
                    ${canDelete ? `<button class="btn btn-secondary" style="background:var(--danger-color);color:#fff;" onclick="window.deleteGoal(${goal.id})">Elimina</button>` : ''}
                    <button class="btn btn-primary" onclick="window.saveGoalChanges(${goal.id})">Salva Modifiche</button>
                </div>
            </div>
        `;
        updateGoalProgress(goal.id);
        setupGoalEditor(goal.id);
    }
    
    function setupGoalEditor(goalId) {
        const card = $(`#goal-card-${goalId}`);
        const chips = card.querySelectorAll('.chip');
        const amountGroup = $(`#editor-amount-${goalId}`);
        const percentGroup = $(`#editor-percent-${goalId}`);
        const percentInput = card.querySelector('.goal-editor-percent');
        const percentPreview = $(`#percent-preview-${goalId}`);

        const updateEditorView = (method) => {
            const isPercent = method === 'Percentuale sulle entrate';
            amountGroup.style.display = isPercent ? 'none' : 'block';
            percentGroup.style.display = isPercent ? 'block' : 'none';
            if (isPercent) updatePercentPreview();
        };
        
        const updatePercentPreview = () => {
            const totalIncomes = allTransactions.filter(tx => tx.kind === 'income').reduce((sum, tx) => sum + safeToNumber(tx.amount), 0);
            const percentValue = safeToNumber(percentInput.value);
            percentPreview.textContent = `${fmt(totalIncomes * (percentValue / 100))}€`;
        };

        chips.forEach(chip => chip.addEventListener('click', () => {
            chips.forEach(c => c.classList.remove('is-active'));
            chip.classList.add('is-active');
            updateEditorView(chip.dataset.method);
        }));
        
        percentInput.addEventListener('input', updatePercentPreview);
        updateEditorView(card.querySelector('.chip.is-active').dataset.method);
    }
    
    async function updateGoalProgress(goalId) {
        const [{data: savings, error: sErr}, {data: goal, error: gErr}] = await Promise.all([
            supabase.from('risparmi').select('importo').eq('obiettivo_id', goalId),
            supabase.from('obiettivi').select('importo_target').eq('id', goalId).single()
        ]);
        if (sErr || gErr) return;
        const totalSaved = savings.reduce((sum, s) => sum + safeToNumber(s.importo), 0);
        const targetAmount = safeToNumber(goal.importo_target);
        const percentage = targetAmount > 0 ? Math.min((totalSaved / targetAmount) * 100, 100) : 0;
        $(`#progress-bar-${goalId}`).style.width = `${percentage}%`;
        $(`#progress-text-${goalId}`).textContent = `${fmt(totalSaved)}€ ${targetAmount > 0 ? `/ ${fmt(targetAmount)}€` : ''}`;
    }
    
    window.toggleGoalEditor = (goalId) => $(`#goal-card-${goalId}`).classList.toggle('is-editing');
    
    window.saveGoalChanges = async (goalId) => {
        const card = $(`#goal-card-${goalId}`);
        const activeChip = card.querySelector('.chip.is-active');
        const newMethod = activeChip.dataset.method;
        const newAmount = newMethod === 'Cifra fissa' ? card.querySelector('.goal-editor-amount').value : card.querySelector('.goal-editor-percent').value;
        const { error } = await supabase.from('obiettivi').update({ metodo_contribuzione: newMethod, importo_mensile: safeToNumber(newAmount) }).eq('id', goalId);
        if (error) alert('Errore nel salvataggio');
        else {
            card.classList.remove('is-editing');
            await refreshData();
        }
    };

    window.recordSaving = (goalId, amount) => {
        showModal('Conferma Risparmio', `Stai per registrare un risparmio di <strong>${fmt(amount)}€</strong>. Vuoi procedere?`, [
            { text: 'Annulla' },
            { text: 'Conferma', class: 'btn-primary', async action() {
                const { error } = await supabase.from('risparmi').insert({ user_id: user.id, obiettivo_id: goalId, importo: amount });
                if (error) alert(`Errore: ${error.message}`);
                else await refreshData();
            }}
        ]);
    };

    window.deleteGoal = (goalId) => {
         showModal('Conferma Eliminazione', `Sei sicuro di voler eliminare questo obiettivo?`, [
            { text: 'Annulla' },
            { text: 'Elimina', class: 'btn-primary', style:'background:var(--grad-danger)', async action() {
                const { error } = await supabase.from('obiettivi').delete().eq('id', goalId);
                if (error) alert(`Errore: ${error.message}`);
                else await refreshData();
            }}
        ]);
    };

    $('#add-goal-btn').addEventListener('click', () => {
        showModal('Nuovo Obiettivo', `
            <div class="form-group" style="margin-bottom: 1rem;"><label>Nome Obiettivo</label><input id="new-goal-name" type="text" placeholder="Es. Vacanze 2026"></div>
            <div class="form-group" style="margin-bottom: 1rem;"><label>Obiettivo Finale (€, opzionale)</label><input id="new-goal-target" type="number" step="0.01"></div>
            <div class="form-group"><label>Importo Fisso Mensile (€)</label><input id="new-goal-amount" type="number" step="0.01"></div>
        `, [
            { text: 'Annulla' },
            { text: 'Crea', class: 'btn-primary', async action() {
                const nome = $('#new-goal-name').value;
                if (!nome) { alert('Il nome è obbligatorio.'); return; }
                const { error } = await supabase.from('obiettivi').insert({ user_id: user.id, nome_obiettivo: nome, importo_target: safeToNumber($('#new-goal-target').value) || null, importo_mensile: safeToNumber($('#new-goal-amount').value) || 0, metodo_contribuzione: 'Cifra fissa' });
                if (error) alert('Errore creazione obiettivo.');
                else await refreshData();
            }}
        ]);
    });

    async function refreshData() {
        const { data, error } = await loadTransactionsForCurrentMonth();
        if (error) console.error(error);
        else {
            allTransactions = data || [];
            renderDashboard(allTransactions);
            await loadAndRenderGoals();
        }
    }

    // --- INIZIALIZZAZIONE PAGINA ---
    async function initializePage() {
      try {
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        if (sessionError || !session) { window.location.replace("/it/login.html"); return; }
        user = session.user;
        
        const { data: profile, error: profileError } = await supabase.from('profiles').select('*').eq('id', user.id).single();
        if (profileError || !profile) throw new Error("Profilo utente non trovato o irraggiungibile. Controlla le policy RLS per la tabella 'profiles'.");
        if (!profile.onboarded) { window.location.replace("/it/onboarding.html"); return; }
        userProfile = profile;

        const now = new Date();
        const months = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
        months.forEach((m, i) => $('#month-selector').add(new Option(m, i)));
        for (let i = now.getFullYear() - 2; i <= now.getFullYear() + 1; i++) { $('#year-selector').add(new Option(i, i)); }
        $('#month-selector').value = now.getMonth();
        $('#year-selector').value = now.getFullYear();
        $('#occurred_at').valueAsDate = new Date();
        
        await loadInitialData();
        await migrateOnboardingGoalIfNeeded();
        await loadAndRenderGoals();

        $('#transaction-form').addEventListener('submit', handleFormSubmit);
        $('#kind').addEventListener('change', updateCategoryDropdown);
        $('#logout-btn').addEventListener('click', async (e) => { e.preventDefault(); await supabase.auth.signOut(); window.location.replace("/it/"); });
        $('#month-selector').addEventListener('change', refreshData);
        $('#year-selector').addEventListener('change', refreshData);
        $('#generic-modal').addEventListener('click', (e) => { if (e.target.classList.contains('modal-overlay') || e.target.closest('.modal-close')) $('#generic-modal').classList.remove('is-visible'); });

      } catch (err) {
        console.error("Errore critico:", err);
        $('main.container').innerHTML = `<div class="diagnostic-card error"><h2>Errore Critico</h2><p>${err.message}</p><p>Prova a ricaricare la pagina. Se il problema persiste, controlla le policy RLS nel tuo progetto Supabase.</p></div>`;
      }
    }

    document.addEventListener('DOMContentLoaded', initializePage);
  </script>
</body>
</html>
