<!doctype html>
<html lang="it" data-app="myhomesbudget">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Configurazione Iniziale ‚Äî MyHomesBudget</title>
  <style>
    :root{--fg:#111;--glass:rgba(255,255,255,.58);--card-border:rgba(0,0,0,.08);--shadow:0 10px 30px rgba(0,0,0,.10);--radius-lg:16px;--primary-color:#6c5ce7;}
    *{box-sizing:border-box}
    html,body{font-family:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif}
    a:focus-visible,button:focus-visible,input:focus-visible{outline:2px solid #00cec9; outline-offset:2px; border-radius:8px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    body{margin:0;color:#fff;background:url("/bg.webp") no-repeat center/cover fixed;min-height:100vh;display:flex;flex-direction:column;align-items:center;}
    body::before{content:"";position:fixed;inset:0;background:rgba(0,0,0,.08);z-index:-1}
    .topbar{position:fixed;top:16px;left:50%;transform:translateX(-50%);width:min(920px,calc(100% - 40px));z-index:20;display:flex;align-items:center;justify-content:space-between;}
    .logo-link,.top-actions{pointer-events:auto}
    .logo-text{font-weight:600;color:#fff;font-size:1.05rem;text-shadow:0 1px 2px rgba(0,0,0,.35)}
    .logout-link{color:#fff;text-decoration:none;padding:6px 10px;border-radius:10px;background:rgba(0,0,0,.28); border:1px solid rgba(255,255,255,.25);}
    main.panel{margin-top:84px;width:min(920px,calc(100% - 40px));background:var(--glass); color:var(--fg); border-radius:var(--radius-lg);padding:clamp(18px,4vw,22px); box-shadow:var(--shadow);display:flex;flex-direction:column;gap:16px;}
    .panel-header{background:rgba(255,255,255,.55);border-radius:12px;padding:14px;border:1px solid var(--card-border)}
    .progress-bar{width:100%;height:8px;background:rgba(0,0,0,.1);border-radius:4px;overflow:hidden}
    .progress-bar-inner{width:0%;height:100%;background:var(--primary-color);transition:width .4s ease}
    .step-indicator{font-size:.9rem;font-weight:600;color:#555;margin-top:8px;text-align:right}
    .step{display:none}
    .step.is-active{display:block;animation:fadeIn .45s ease}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .step-title{text-align:center;margin:6px 0 8px;font-size:clamp(1.5rem,4vw,1.8rem);color:#111}
    .step-description{text-align:center;color:#333;margin:0 auto 16px;max-width:520px}
    .options-grid{display:grid;gap:12px}
    .option-label{display:block;padding:14px;border:2px solid transparent;border-radius:10px;background:rgba(255,255,255,.6);transition:.18s ease;cursor:pointer}
    .option-label:hover{background:#fff}
    input[type="radio"],input[type="checkbox"]{position:absolute;opacity:0;width:1px;height:1px}
    input[type="radio"]:checked + .option-label{border-color:var(--primary-color);background:#fff}
    .option-label strong{display:block;font-size:1.05rem}
    .option-label span{font-size:.92rem;color:#444}
    /* Stili per i nuovi input */
    .option-details { display: none; grid-template-columns: 1fr auto; gap: 10px; align-items: center; padding: 10px 14px 0; }
    input[type="radio"]:checked ~ .option-details { display: grid; }
    .input-field { width: 100%; border: 1px solid #ccc; background: #fff; padding: 10px; border-radius: 8px; font-size: 1rem; }
    .input-field::placeholder { color: #999; }
    .error-message{color:#842029;background:#f8d7da;border:1px solid #f5c2c7;border-radius:8px;padding:8px 10px;font-weight:600;text-align:center;display:none}
    .error-message.show{display:block}
    .panel-footer{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;font-weight:800}
    .btn-primary{background:var(--primary-color);color:#fff;box-shadow:0 8px 22px rgba(0,0,0,.14)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
  <nav class="topbar">
    <a href="/it/" class="logo-link"><img src="/homes.png" alt="Logo" class="logo-image" style="height:32px; border-radius:6px;"><span class="logo-text">MyHomesBudget</span></a>
    <div class="top-actions"><a href="#" id="logout-btn" class="logout-link">Esci</a></div>
  </nav>

  <main class="panel">
    <div class="panel-header"><div class="progress-bar" role="progressbar"><div class="progress-bar-inner"></div></div><div id="step-indicator" class="step-indicator"></div></div>
    
    <section id="step-1" class="step" data-step="1">
      <h1 class="step-title">Qual √® il tuo obiettivo principale?</h1>
      <p class="step-description">Scegliere un obiettivo ci aiuta a personalizzare la tua esperienza e a tracciare i tuoi progressi.</p>
      <fieldset class="options-grid">
        <div>
          <input type="radio" id="goal-saving" name="goal_type" value="Risparmio fisso mensile">
          <label for="goal-saving" class="option-label"><strong>üí∞ Risparmio fisso mensile</strong><span>Accantona una somma specifica ogni mese.</span></label>
          <div class="option-details">
            <input type="text" class="input-field" name="goal_name" value="Risparmio" readonly>
            <input type="number" class="input-field" name="goal_target_amount" placeholder="5.000,00 ‚Ç¨" step="100">
          </div>
        </div>
        <div>
          <input type="radio" id="goal-debts" name="goal_type" value="Riduzione debiti e Finanziamenti">
          <label for="goal-debts" class="option-label"><strong>üìâ Riduzione debiti e Finanziamenti</strong><span>Monitora e riduci i tuoi debiti in modo efficace.</span></label>
          <div class="option-details">
            <input type="text" class="input-field" name="goal_name" placeholder="Es: Estinzione mutuo">
            <input type="number" class="input-field" name="goal_target_amount" placeholder="70.000,00 ‚Ç¨" step="1000">
          </div>
        </div>
        <div>
          <input type="radio" id="goal-objective" name="goal_type" value="Raggiungi un obiettivo">
          <label for="goal-objective" class="option-label"><strong>üéØ Raggiungi un obiettivo</strong><span>Viaggi, acquisti importanti, progetti personali.</span></label>
          <div class="option-details">
            <input type="text" class="input-field" name="goal_name" placeholder="Es: Vacanza a New York">
            <input type="number" class="input-field" name="goal_target_amount" placeholder="1.500,00 ‚Ç¨" step="50">
          </div>
        </div>
      </fieldset>
    </section>
    
    <section id="step-2" class="step" data-step="2">
      <h1 class="step-title">Come vuoi raggiungere il tuo obiettivo?</h1>
      <p class="step-description">Definisci il tuo contributo mensile. Questo diventer√† la base per il tuo budget di risparmio.</p>
      <fieldset class="options-grid">
         <div>
            <input type="radio" id="method-fixed" name="contribution_method" value="Cifra fissa">
            <label for="method-fixed" class="option-label"><strong>üóìÔ∏è Cifra fissa mensile</strong><span>Destina un importo prestabilito ogni mese.</span></label>
            <div class="option-details"><input type="number" class="input-field" name="contribution_amount" placeholder="250,00 ‚Ç¨" step="10"></div>
         </div>
         <div>
            <input type="radio" id="method-variable" name="contribution_method" value="Importo variabile">
            <label for="method-variable" class="option-label"><strong>üéõÔ∏è Importo variabile</strong><span>Decidi quanto accantonare in base alle tue spese.</span></label>
            <div class="option-details"><input type="number" class="input-field" name="contribution_amount" placeholder="250,00 ‚Ç¨" step="10"></div>
         </div>
         <div>
            <input type="radio" id="method-percentage" name="contribution_method" value="Percentuale sulle entrate">
            <label for="method-percentage" class="option-label"><strong>üìä Percentuale sulle entrate</strong><span>Imposta una percentuale fissa da destinare al tuo obiettivo.</span></label>
            <div class="option-details"><input type="number" class="input-field" name="contribution_amount" placeholder="10,00 %" step="1"></div>
         </div>
      </fieldset>
    </section>

    <section id="step-3" class="step" data-step="3">
        <h1 class="step-title">Scegli le tue categorie</h1>
        <p class="step-description">Seleziona le voci di entrata e uscita che usi pi√π spesso. Potrai sempre modificarle in seguito.</p>
        <fieldset><div class="category-columns"><div class="column"><h3>Entrate</h3><div id="income-category-options" class="options-grid"></div></div><div class="column"><h3>Uscite</h3><div id="expense-category-options" class="options-grid"></div></div></div></fieldset>
    </section>
    
    <div id="error" class="error-message"></div>
    <div class="panel-footer"><button id="back-btn" class="btn btn-secondary">Indietro</button><button id="next-btn" class="btn btn-primary">Avanti</button></div>
  </main>
  
  <script type="module">
    import { supabase } from "/it/supabase-client.js";

    const TOTAL_STEPS = 3;
    // ... selettori e stato ...
    const state = {
        goal_type: null,
        goal_name: null,
        goal_target_amount: 0,
        contribution_method: null,
        contribution_amount: 0,
        categories: []
    };

    function validateAndUpdateState(n) {
        showError('');
        if (n === 1) {
            const typeRadio = document.querySelector('input[name="goal_type"]:checked');
            if (!typeRadio) { showError('Per favore, scegli un obiettivo.'); return false; }
            state.goal_type = typeRadio.value;
            
            const parentDiv = typeRadio.parentElement;
            const nameInput = parentDiv.querySelector('input[name="goal_name"]');
            const amountInput = parentDiv.querySelector('input[name="goal_target_amount"]');

            if (!nameInput.value.trim()) { showError('Per favore, inserisci un nome per il tuo obiettivo.'); return false; }
            if (!amountInput.value || parseFloat(amountInput.value) <= 0) { showError('Per favore, inserisci un importo valido.'); return false; }
            
            state.goal_name = nameInput.value.trim();
            state.goal_target_amount = parseFloat(amountInput.value);
        } else if (n === 2) {
            const methodRadio = document.querySelector('input[name="contribution_method"]:checked');
            if (!methodRadio) { showError('Per favore, scegli un metodo.'); return false; }
            state.contribution_method = methodRadio.value;

            const parentDiv = methodRadio.parentElement;
            const amountInput = parentDiv.querySelector('input[name="contribution_amount"]');

            if (!amountInput.value || parseFloat(amountInput.value) <= 0) { showError('Per favore, inserisci un importo o percentuale valida.'); return false; }
            state.contribution_amount = parseFloat(amountInput.value);
        } else if (n === 3) {
            // ... logica invariata per le categorie
        }
        return true;
    }

    async function saveOnboardingToSupabase(user, existingUserCategories) {
        nextBtn.disabled = true;
        nextBtn.textContent = 'Salvataggio...';

        try {
            // 1. SALVA L'OBIETTIVO A LUNGO TERMINE
            // Usiamo upsert per gestire sia la creazione che la modifica
            const { error: goalError } = await supabase.from('goals').upsert({
                user_id: user.id,
                goal_type: state.goal_type,
                name: state.goal_name,
                target_amount: state.goal_target_amount
            }, { onConflict: 'user_id' }); // Assumiamo 1 obiettivo per utente, da modificare se ne vuoi di pi√π
            
            if (goalError) throw goalError;

            // 2. SALVA IL BUDGET MENSILE PER I RISPARMI
            const currentMonth = new Date().toISOString().slice(0, 7) + '-01'; // Es: '2025-09-01'
            const { error: budgetError } = await supabase.from('budgets').upsert({
                user_id: user.id,
                month: currentMonth,
                macro_category: 'Risparmi',
                amount: state.contribution_amount // Qui per ora inseriamo solo la cifra fissa, la % andrebbe calcolata sul reddito
            }, { onConflict: 'user_id, month, macro_category' });

            if (budgetError) throw budgetError;
            
            // 3. SINCRONIZZA CATEGORIE E SOTTOCATEGORIE (logica invariata)
            // ... (tutta la logica di sync che abbiamo gi√† costruito)
            
            // 4. AGGIORNA IL PROFILO
            // ... (logica di update profilo invariata)

            return true;
        } catch (error) {
            console.error("Errore nel salvataggio:", error);
            showError("Si √® verificato un errore critico. Riprova.");
            nextBtn.disabled = false;
            nextBtn.textContent = 'Fine';
            return false;
        }
    }
    
    // Il resto dello script (initializePage, renderStep, etc.) andr√† adattato
    // per pre-popolare i nuovi campi e gestire la logica.
    
  </script>
</body>
</html>
