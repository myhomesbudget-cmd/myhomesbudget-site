<!doctype html>
<html lang="it" data-app="myhomesbudget">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard — MyHomesBudget</title>
  <meta name="description" content="Gestisci le tue finanze, traccia le spese e raggiungi i tuoi obiettivi.">
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" href="/favicon.ico">
  <style>
    :root{
      --fg:#111; --glass:rgba(255,255,255,.58); --card-border:rgba(0,0,0,.08);
      --shadow:0 10px 30px rgba(0,0,0,.10); --radius-lg:16px; --primary-color:#6c5ce7;
    }
    *{box-sizing:border-box}
    html,body{font-family:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif}
    a:focus-visible,button:focus-visible,input:focus-visible,select:focus-visible{
      outline:2px solid #00cec9; outline-offset:2px; border-radius:8px
    }
    body{
      margin:0;color:#fff;background:url("/bg.webp") no-repeat center/cover fixed;
      min-height:100vh;display:flex;flex-direction:column;align-items:center;
    }
    body::before{content:"";position:fixed;inset:0;background:rgba(0,0,0,.08);z-index:-1}

    /* ===== Appbar identica alla riepilogo (full-width) ===== */
    .appbar{position:fixed; top:16px; left:0; right:0; padding:0 12px; z-index:50;}
    .appbar-inner{
      height:54px; display:grid; grid-template-columns:1fr auto 1fr; align-items:center;
      max-width:1200px; margin:0 auto; padding:8px 12px;
      background:var(--glass); backdrop-filter:blur(10px);
      border:1px solid var(--card-border); border-radius:14px; box-shadow:var(--shadow);
    }
    .brand{display:flex; align-items:center; gap:8px; text-decoration:none; color:#111; font-weight:700;}
    .brand img{height:28px; border-radius:6px}
    .appbar-actions{display:flex; justify-content:flex-end; gap:8px}
    .top-link{
      color:#111; text-decoration:none; padding:6px 10px; border-radius:10px;
      background:rgba(0,0,0,.05); border:1px solid rgba(0,0,0,.08); font-size:.9rem; font-weight:600;
    }
    .top-link:hover{background:rgba(0,0,0,.12)}
    .appbar-center{display:flex; justify-content:center; align-items:center; gap:10px}

    /* pillola banner piano */
    #plan-banner{display:none}
    .plan-pill{
      display:inline-flex; align-items:center; gap:10px; padding:8px 12px;
      background:#fff; color:#111; border:1px solid var(--card-border);
      border-radius:12px; box-shadow:0 6px 16px rgba(0,0,0,.08); font-weight:600;
    }
    .plan-pill .cta{margin-left:8px; background:var(--primary-color); color:#fff;
      border:none; border-radius:10px; padding:6px 10px; font-weight:800; cursor:pointer}
    .plan-pill .cta:hover{filter:brightness(1.05)}

    /* ===== Contenuto ===== */
    main.panel{
      margin-top:96px; /* lascia spazio alla appbar fissa */
      width:min(920px, calc(100% - 40px));
      background:var(--glass); color:var(--fg); border-radius:var(--radius-lg);
      padding:clamp(18px,4vw,22px); box-shadow:var(--shadow);
      display:flex; flex-direction:column; gap:20px;
    }
    h1, h2, h3 { color:#111; }

    .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;font-weight:800;transition:all .2s ease;}
    .btn-primary{background:var(--primary-color);color:#fff;box-shadow:0 8px 22px rgba(0,0,0,.14)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    .dash-nav{display:flex;gap:8px;border-bottom:1px solid rgba(0,0,0,0.1);padding-bottom:12px;}
    .dash-nav a{text-decoration:none;color:#333;padding:8px 16px;border-radius:10px;font-weight:600;}
    .dash-nav a.is-active{background:#fff;color:var(--primary-color);box-shadow:0 4px 12px rgba(0,0,0,0.08);}

    .content-section{background:rgba(255,255,255,.55);border-radius:12px;padding:16px;border:1px solid var(--card-border);}
    .transaction-form{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:flex-end;}
    @media (min-width: 820px){.transaction-form{grid-template-columns:repeat(3, 1fr) auto;}}
    .form-group{display:flex; flex-direction:column;}
    .form-group.full-width{grid-column:1 / -1;}
    .form-group label{font-weight:600; font-size:.9rem; margin-bottom:6px;}
    .form-group input,.form-group select{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;background:#fff;font-size:1rem;}

    .transaction-list .item{display:grid; grid-template-columns:auto 1fr auto auto; gap:12px; align-items:center; padding:12px 4px; border-bottom:1px solid rgba(0,0,0,0.05);}
    .item-icon{font-size:1.5rem;flex-shrink:0;}
    .item-details{display:flex; flex-direction:column; min-width:0;}
    .item-details .note{font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .item-details .category{font-size:.9rem; color:#555; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .item-amount{text-align:right; white-space:nowrap; flex-shrink:0;}
    .item-amount.expense{color:#d32f2f; font-weight:700;}
    .item-amount.income{color:#2e7d32; font-weight:700;}
    .item-actions{display:flex; gap:4px; flex-shrink:0;}
    .action-btn{background:rgba(0,0,0,0.05); color:#555; border:1px solid rgba(0,0,0,0.1); border-radius:8px; padding:6px 10px; font-size:.85rem; font-weight:600; cursor:pointer; transition:background-color .2s ease, color .2s ease; white-space:nowrap;}
    .action-btn:hover{background:var(--primary-color); color:#fff; border-color:var(--primary-color);}
    .action-btn.delete{background:#f8d7da; color:#842029; border-color:#f5c2c7;}
    .action-btn.delete:hover{background:#dc3545; color:#fff; border-color:#dc3545;}
    .empty-state{text-align:center; padding:40px; color:#555;}
  </style>
</head>
<body>

  <!-- ===== Fascia superiore full-width ===== -->
  <header class="appbar" role="navigation" aria-label="Barra superiore">
    <div class="appbar-inner">
      <!-- sinistra: logo -->
      <a href="/it/" class="brand">
        <img src="/homes.png" alt="" /><span>MyHomesBudget</span>
      </a>

      <!-- centro: banner piano (iniettato da /js/plan.js) -->
      <div class="appbar-center">
        <div id="plan-banner"></div>
      </div>

      <!-- destra: azioni -->
      <div class="appbar-actions">
        <a href="/it/dashboard.html" class="top-link" aria-current="page">Operazioni</a>
        <a href="/it/onboarding.html?edit=1" class="top-link">Impostazioni</a>
        <a href="#" id="logout-btn" class="top-link">Esci</a>
      </div>
    </div>
  </header>

  <main class="panel">
    <nav id="dash-nav" class="dash-nav" aria-label="Sezioni pagina">
      <a href="/it/dashboard.html" class="is-active">Operazioni</a>
      <a href="/it/dashboard-riepilogo.html">Riepilogo</a>
    </nav>

    <section class="content-section">
      <h2 id="form-title">Nuova Transazione</h2>
      <form id="transaction-form" class="transaction-form">
        <input type="hidden" id="transaction-id" name="transaction-id">
        <div class="form-group full-width">
          <label for="kind">Tipo</label>
          <select id="kind" name="kind" required>
            <option value="expense">Uscita</option>
            <option value="income">Entrata</option>
            <option value="transfer">Trasferimento</option>
          </select>
        </div>
        <div class="form-group full-width">
          <label for="note">Nota</label>
          <input type="text" id="note" name="note" placeholder="Es. Caffè al bar" required>
        </div>
        <div class="form-group">
          <label for="amount">Importo (€)</label>
          <input type="number" id="amount" name="amount" step="0.01" placeholder="0.00" required>
        </div>
        <div class="form-group">
          <label for="occurred_at">Data</label>
          <input type="date" id="occurred_at" name="occurred_at" required>
        </div>
        <div class="form-group">
          <label for="category_id">Categoria</label>
          <select id="category_id" name="category_id" required>
            <option value="">Scegli...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="subcategory_id">Sottocategoria</label>
          <select id="subcategory_id" name="subcategory_id">
            <option value="">Scegli...</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary" style="grid-column:1 / -1; margin-top:10px;">Aggiungi</button>
      </form>
    </section>

    <section class="content-section">
      <h2>Movimenti Recenti</h2>
      <div id="transaction-list" class="transaction-list">
        <div class="empty-state"><p>Nessuna transazione registrata.</p></div>
      </div>
    </section>
  </main>

  <script type="module">
    import { supabase } from "/it/supabase-client.js";

    const transactionForm = document.getElementById('transaction-form');
    const kindSelect = document.getElementById('kind');
    const categorySelect = document.getElementById('category_id');
    const subcategorySelect = document.getElementById('subcategory_id');
    const transactionIdInput = document.getElementById('transaction-id');
    const formTitle = document.getElementById('form-title');
    const transactionList = document.getElementById('transaction-list');
    const logoutBtn = document.getElementById('logout-btn');

    let user = null;
    let allCategories = [];
    let allSubcategories = [];
    let allTransactions = [];
    let Plan = null; // modulo gating/banner (opzionale)

    const safeToNumber = v => {
      const n = (typeof v === 'number') ? v : parseFloat(v);
      return Number.isFinite(n) ? n : 0;
    };

    async function loadInitialData() {
      const { data: categories, error: cError } =
        await supabase.from('categories').select('*').eq('created_by', user.id);
      if (cError) { console.error("Errore caricamento categorie:", cError); return; }
      allCategories = categories || [];

      if (allCategories.length > 0) {
        const ids = allCategories.map(c => c.id);
        const { data: subcategories, error: sError } =
          await supabase.from('subcategories').select('*').in('category_id', ids);
        if (sError) { console.error("Errore caricamento sottocategorie:", sError); return; }
        allSubcategories = subcategories || [];
      }
    }

    function updateCategoryDropdown() {
      const selectedKind = kindSelect.value;
      const filtered = allCategories.filter(cat => cat.kind === selectedKind);
      categorySelect.innerHTML = '<option value="">Scegli categoria...</option>';
      filtered.forEach(cat => categorySelect.add(new Option(`${cat.icon} ${cat.name}`, cat.id)));
      updateSubcategories();
    }

    function updateSubcategories(selectedSubId = null) {
      const catId = categorySelect.value;
      subcategorySelect.innerHTML = '<option value="">Nessuna</option>';
      subcategorySelect.disabled = true;
      if (!catId) return;
      const list = allSubcategories.filter(s => String(s.category_id) === String(catId));
      if (list.length) {
        subcategorySelect.disabled = false;
        list.forEach(s => subcategorySelect.add(new Option(`${s.icon} ${s.name}`, s.id)));
        if (selectedSubId) subcategorySelect.value = selectedSubId;
      }
    }

    async function loadTransactions() {
      const { data, error } = await supabase
        .from('transactions')
        .select(`*, categories(name, icon), subcategories(name, icon)`)
        .eq('created_by', user.id)
        .order('occurred_at', { ascending: false })
        .limit(15);
      if (error) { console.error("Errore caricamento transazioni:", error); return; }
      allTransactions = data || [];
      transactionList.innerHTML = '';
      if (!allTransactions.length) {
        transactionList.innerHTML = `<div class="empty-state"><p>Nessuna transazione registrata.</p></div>`;
        return;
      }
      allTransactions.forEach(tx => {
        const cat = tx.categories, sub = tx.subcategories;
        const icon = sub?.icon || cat?.icon || '💸';
        const catText = `${cat?.name || 'N/A'}${sub ? ` / ${sub.name}` : ''}`;
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = `
          <div class="item-icon">${icon}</div>
          <div class="item-details">
            <span class="note">${tx.note ?? ''}</span>
            <span class="category">${catText}</span>
          </div>
          <div class="item-amount ${tx.kind}">
            ${tx.kind === 'expense' ? '-' : ''}${safeToNumber(tx.amount).toFixed(2)} €
          </div>
          <div class="item-actions">
            <button class="action-btn edit-btn" data-id="${tx.id}">Modifica</button>
            <button class="action-btn delete-btn delete" data-id="${tx.id}">Elimina</button>
          </div>`;
        transactionList.appendChild(el);
      });
    }

    function handleEdit(id) {
      const tx = allTransactions.find(t => String(t.id) === String(id));
      if (!tx) return;
      formTitle.textContent = "Modifica Transazione";
      transactionIdInput.value = tx.id;
      kindSelect.value = tx.kind;
      document.getElementById('note').value = tx.note ?? '';
      document.getElementById('amount').value = safeToNumber(tx.amount);
      document.getElementById('occurred_at').value = (tx.occurred_at || '').split('T')[0] || '';
      updateCategoryDropdown();
      categorySelect.value = tx.category_id ?? '';
      updateSubcategories(tx.subcategory_id ?? null);
      window.scrollTo(0, 0);
    }

    async function handleDelete(id) {
      if (Plan && !(await Plan.assertCanWrite("delete-transaction"))) return;
      if (!confirm("Sei sicuro di voler eliminare questa transazione?")) return;
      const { error } = await supabase.from('transactions').delete().eq('id', id);
      if (error) { console.error("Errore eliminazione:", error); alert("Impossibile eliminare la transazione."); }
      else loadTransactions();
    }

    async function handleFormSubmit(e) {
      e.preventDefault();
      if (Plan && !(await Plan.assertCanWrite("add-or-update-transaction"))) return;

      const f = new FormData(transactionForm);
      const id = f.get('transaction-id');
      const payload = {
        kind: f.get('kind'),
        note: f.get('note'),
        amount: f.get('amount'),
        occurred_at: f.get('occurred_at'),
        category_id: f.get('category_id'),
        subcategory_id: f.get('subcategory_id') || null,
        created_by: user.id
      };
      const { error } = id
        ? await supabase.from('transactions').update(payload).eq('id', id)
        : await supabase.from('transactions').insert(payload);
      if (error) { console.error("Errore salvataggio:", error); alert("Si è verificato un errore. Riprova."); }
      else {
        transactionForm.reset();
        formTitle.textContent = "Nuova Transazione";
        transactionIdInput.value = "";
        document.getElementById('occurred_at').valueAsDate = new Date();
        updateCategoryDropdown();
        loadTransactions();
      }
    }

    async function initializePage() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) { location.replace("/it/login.html"); return; }
      user = session.user;

      // prova a caricare /js/plan.js e monta il banner nella fascia
      try {
        Plan = await import("/js/plan.js");
        if (Plan?.mountPlanBanner) {
          const target = document.querySelector('#plan-banner');
          // mountPlanBanner accetta anche {target} se l’hai prevista; altrimenti usa l’id
          const mounted = await Plan.mountPlanBanner({ target });
          if (mounted) {
            target.classList.add('plan-pill');
            target.style.display = 'inline-flex';
          }
        }
      } catch (e) { console.warn("plan.js non caricato:", e); Plan = null; }

      // onboarding (comportamento invariato)
      const { data: profile } =
        await supabase.from('profiles').select('onboarded').eq('id', user.id).single();
      if (profile && !profile.onboarded) {
        if (new URLSearchParams(window.location.search).get('edit') !== '1') {
          location.replace("/it/onboarding.html"); return;
        }
      }

      document.getElementById('occurred_at').valueAsDate = new Date();
      await loadInitialData();
      updateCategoryDropdown();
      await loadTransactions();

      kindSelect.addEventListener('change', updateCategoryDropdown);
      categorySelect.addEventListener('change', () => updateSubcategories());
      transactionForm.addEventListener('submit', handleFormSubmit);
      logoutBtn.addEventListener('click', async (e) => { e.preventDefault(); await supabase.auth.signOut(); location.replace("/it/"); });

      transactionList.addEventListener('click', (e) => {
        const btn = e.target.closest('.action-btn'); if (!btn) return;
        const id = btn.dataset.id;
        if (btn.classList.contains('edit-btn')) handleEdit(id);
        else if (btn.classList.contains('delete-btn')) handleDelete(id);
      });
    }

    document.addEventListener('DOMContentLoaded', initializePage);
  </script>
</body>
</html>
