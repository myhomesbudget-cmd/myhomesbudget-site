<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reset your password â€” MyHomesBudget</title>
  <meta name="description" content="Set a new password to access your MyHomesBudget account.">
  <meta name="color-scheme" content="light dark">
  <script>document.documentElement.classList.add('js');</script>

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    img-src 'self' https: data:;
    style-src 'self' 'unsafe-inline';
    script-src 'self' 'unsafe-inline' https://esm.sh;
    connect-src 'self' https://*.supabase.co https://*.supabase.in wss://*.supabase.co wss://*.supabase.in;
    font-src 'self' https: data:;
    frame-ancestors 'none';
    base-uri 'self';
    form-action 'self';
  ">

  <!-- hreflang -->
  <link rel="canonical" href="https://www.myhomesbudget.com/en/reset-password.html" />
  <link rel="alternate" href="https://www.myhomesbudget.com/it/reset-password.html" hreflang="it" />
  <link rel="alternate" href="https://www.myhomesbudget.com/en/reset-password.html" hreflang="en" />
  <link rel="alternate" href="https://www.myhomesbudget.com/es/reset-password.html" hreflang="es" />
  <link rel="alternate" href="https://www.myhomesbudget.com/reset-password.html" hreflang="x-default" />

  <link rel="preload" href="/bg.webp" as="image">
  <link rel="icon" href="/favicon.ico">

  <style>
    :root{ --fg:#111; --glass:rgba(255,255,255,.58); --card-border:rgba(0,0,0,.06);
           --shadow:0 10px 30px rgba(0,0,0,.10); --radius-lg:16px;
           --grad:linear-gradient(135deg,#6c5ce7,#00cec9); }
    *{box-sizing:border-box}
    html,body{font-family:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif}
    body{margin:0;color:#fff;background:url('/bg.webp') no-repeat center/cover fixed;
         min-height:100vh;display:flex;align-items:center;justify-content:center;}
    body::before{content:'';position:fixed;inset:0;background:rgba(0,0,0,.08);z-index:-1}
    .topbar{position:fixed;top:16px;left:50%;transform:translateX(-50%);
            width:min(920px,calc(100% - 40px));display:flex;justify-content:flex-start;}
    .logo-link{display:flex;gap:8px;align-items:center;text-decoration:none;color:#fff;pointer-events:auto}
    .logo-image{height:32px}
    .logo-text{font-weight:600;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,.35)}

    .panel{width:min(920px,calc(100% - 40px));background:var(--glass);color:var(--fg);
           border-radius:var(--radius-lg);padding:clamp(18px,4vw,26px);box-shadow:var(--shadow);}
    .header{text-align:center;margin-bottom:16px}
    .header h1{margin:0;color:#111;font-size:clamp(1.6rem,4vw,2rem);text-shadow:0 1px 3px rgba(0,0,0,.35)}
    .header p{margin:8px 0 0;color:#222}

    form{max-width:560px;margin:0 auto;display:grid;gap:12px}
    .field{display:grid;gap:6px}
    label{color:#111;font-weight:700}
    input[type="password"]{border:1px solid var(--card-border);border-radius:10px;padding:12px;
                           background:rgba(255,255,255,.9);font-size:1rem;color:#111;}
    .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;background:var(--grad);
         color:#fff;font-weight:800;font-size:1rem;box-shadow:0 8px 22px rgba(0,0,0,.14);
         text-shadow:0 1px 0 rgba(0,0,0,.18);transition:transform .15s ease,filter .15s ease;}
    .btn:hover{filter:brightness(1.07);transform:translateY(-1px)}

    .msg{margin:6px auto 0;font-size:.95rem;font-weight:600;padding:10px 12px;border-radius:8px;max-width:560px}
    .ok{color:#0f5132;background:#d1e7dd;border:1px solid #badbcc}
    .err{color:#842029;background:#f8d7da;border:1px solid #f5c2c7}
    .muted{color:#333;text-align:center;margin-top:8px}
    .hint{color:#333;font-size:.95rem;margin:0;text-align:center}
  </style>
</head>
<body>
  <nav class="topbar" aria-label="Top bar">
    <a href="/en/" class="logo-link" title="MyHomesBudget">
      <img src="/homes.png" alt="MyHomesBudget logo" class="logo-image"><span class="logo-text">MyHomesBudget</span>
    </a>
  </nav>

  <main class="panel">
    <header class="header">
      <h1>Reset your password</h1>
      <p>Set a new password to access your account again.</p>
    </header>

    <div id="notice" class="msg err" style="display:none"></div>

    <form id="reset-form" style="display:none">
      <div class="field">
        <label for="npw">New password</label>
        <input id="npw" type="password" minlength="8" placeholder="Min. 8 characters" required>
      </div>
      <div class="field">
        <label for="cpw">Confirm password</label>
        <input id="cpw" type="password" minlength="8" placeholder="Repeat the new password" required>
      </div>
      <button class="btn" type="submit">Reset password</button>
      <p class="hint">The reset link is valid for 1 hour.</p>
    </form>

    <div id="done" class="msg ok" style="display:none">Password updated successfully. You can now <a href="/en/login.html">sign in</a>.</div>
    <p class="muted" id="help" style="display:none">
      Invalid or expired link? <a href="/en/login.html">Go back to sign in</a> and request a new reset.
    </p>
  </main>

  <script type="module">
    import { supabase } from '/en/supabase-client.js';

    const notice = document.getElementById('notice');
    const form   = document.getElementById('reset-form');
    const done   = document.getElementById('done');
    const help   = document.getElementById('help');
    const show = el => el.style.display = '';
    const hide = el => el.style.display = 'none';
    const alertErr = msg => { notice.textContent = msg; show(notice); };

    const frag = new URLSearchParams(location.hash.slice(1));
    const access_token  = frag.get('access_token');
    const refresh_token = frag.get('refresh_token');

    async function primeSession(){
      try{
        if (access_token && refresh_token) {
          const { data, error } = await supabase.auth.setSession({ access_token, refresh_token });
          if (error) throw error;
          return !!data.session;
        }
        const { data:{ session } } = await supabase.auth.getSession();
        return !!session;
      }catch{ return false; }
    }

    const ok = await primeSession();
    if (ok) { hide(notice); show(form); } else { alertErr('Recovery session is invalid or expired.'); show(help); }

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      hide(notice);
      const pw  = document.getElementById('npw').value.trim();
      const cpw = document.getElementById('cpw').value.trim();
      if (pw.length < 8) return alertErr('Password must be at least 8 characters.');
      if (pw !== cpw)   return alertErr('Passwords do not match.');
      const { error } = await supabase.auth.updateUser({ password: pw });
      if (error) return alertErr(error.message || 'Unable to update the password.');
      hide(form); show(done); show(help);
    });
  </script>
</body>
</html>
