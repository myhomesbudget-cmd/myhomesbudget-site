<!doctype html>
<html lang="it" data-app="myhomesbudget">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Riepilogo ‚Äî MyHomesBudget</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" href="/favicon.ico" />
  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --fg:#111; --bg:#f4f7fa; --glass:rgba(255,255,255,.6);
      --card-border:rgba(0,0,0,.08); --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius-lg:16px; --primary-color:#6c5ce7; --danger-color:#d32f2f;
      --success-color:#2e7d32; --warning-color:#f39c12;
      --font-sans:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif;
      --grad:linear-gradient(135deg,#6c5ce7,#00cec9);
      --grad-danger:linear-gradient(135deg,#d32f2f,#ff7675);
      --grad-success:linear-gradient(135deg,#2e7d32,#4caf50);
      --grad-warning:linear-gradient(135deg,#f39c12,#f1c40f);
    }

    *{box-sizing:border-box}
    html{font-family:var(--font-sans);background-color:var(--bg);scroll-behavior:smooth}
    body{
      margin:0;color:var(--fg);
      background:url("/bg.webp") no-repeat center/cover;
      background-attachment:scroll; min-height:100svh; overflow-x:hidden; position:relative;
    }
    body::before{content:"";position:absolute;inset:0;background:linear-gradient(135deg,rgba(108,92,231,.05),rgba(0,206,201,.05));z-index:-1}

    /* ===== PARTICLE SYSTEM ===== */
    .particles-container{position:fixed;inset:0;pointer-events:none;z-index:1;overflow:hidden}
    .particle{position:absolute;width:4px;height:4px;background:var(--primary-color);border-radius:50%;opacity:.6;animation:float 6s infinite ease-in-out}
    .particle:nth-child(2n){background:var(--success-color);animation-duration:8s}
    .particle:nth-child(3n){background:var(--warning-color);animation-duration:10s}
    .particle:nth-child(4n){background:var(--danger-color);animation-duration:7s}
    @keyframes float{0%,100%{transform:translateY(100vh) translateX(0) rotate(0);opacity:0}10%,90%{opacity:.6}50%{transform:translateY(50vh) translateX(100px) rotate(180deg)}}

    /* ===== MORPHING SHAPES ===== */
    .morphing-shape{position:absolute;width:200px;height:200px;background:linear-gradient(45deg,rgba(108,92,231,0.1),rgba(0,206,201,0.1));border-radius:50%;animation:morph 8s infinite ease-in-out;z-index:1}
    .shape-1{top:10%;right:10%} .shape-2{bottom:20%;left:5%} .shape-3{top:60%;right:30%}
    @keyframes morph{0%,100%{border-radius:50%;transform:rotate(0) scale(1)}
      25%{border-radius:30% 70% 70% 30%/30% 30% 70% 70%;transform:rotate(90deg) scale(1.2)}
      50%{border-radius:70% 30% 30% 70%/70% 70% 30% 30%;transform:rotate(180deg) scale(.8)}
      75%{border-radius:40% 60% 60% 40%/60% 40% 60% 40%;transform:rotate(270deg) scale(1.1)}}

    /* ===== LOADER ===== */
    .boot-loader{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:10000;transition:opacity .5s ease}
    .boot-loader.is-hidden{opacity:0;pointer-events:none}
    .loader-content{text-align:center}
    .loader-spinner{width:40px;height:40px;border:4px solid rgba(108,92,231,.2);border-top:4px solid #6c5ce7;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
    .loader-text{font-size:1.1rem;font-weight:600;color:var(--fg)}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* ===== TOPBAR ===== */
    .topbar{position:fixed;top:0;left:0;right:0;height:60px;padding:0 24px;display:flex;align-items:center;justify-content:space-between;background:var(--glass);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-bottom:1px solid var(--card-border);z-index:100}
    .logo-link{display:flex;align-items:center;gap:8px;text-decoration:none}
    .logo-text{font-weight:600;color:#fff;font-size:1.1rem;text-shadow:0 1px 2px rgba(0,0,0,.35)}
    .top-center{position:absolute;left:50%;transform:translateX(-50%)}
    .top-actions{display:flex;gap:12px;align-items:center}
    .top-link,.top-btn{display:flex;align-items:center;justify-content:center;height:34px;color:#fff;text-decoration:none;padding:6px 12px;border-radius:10px;font-size:.9rem;font-weight:600;background:var(--grad);border:none;box-shadow:0 4px 12px rgba(0,0,0,.15);transition:transform .2s ease,filter .2s ease,box-shadow .2s ease;cursor:pointer;white-space:nowrap}
    .top-link:hover,.top-btn:hover{transform:translateY(-2px);filter:brightness(1.08);box-shadow:0 6px 16px rgba(0,0,0,.20)}
    .date-selectors{display:flex;gap:8px}
    .select-wrapper{position:relative;display:flex;align-items:center;height:34px;border-radius:10px;background:var(--grad);box-shadow:0 4px 12px rgba(0,0,0,.15);transition:transform .2s ease,filter .2s ease,box-shadow .2s ease}
    .select-wrapper:hover{transform:translateY(-2px);filter:brightness(1.08);box-shadow:0 6px 16px rgba(0,0,0,.20)}
    .select-wrapper::after{content:'‚ñº';font-size:10px;color:rgba(255,255,255,0.8);position:absolute;right:10px;top:50%;transform:translateY(-50%);pointer-events:none}
    .topbar-select{appearance:none;background:transparent;color:#fff;border:none;padding:6px 28px 6px 12px;font-size:.9rem;font-weight:600;cursor:pointer}
    .topbar-select option{background:#fff;color:#000}

    /* ===== MAIN ===== */
    main.container{padding:84px 24px 24px;max-width:1400px;margin:0 auto;width:100%;position:relative;z-index:2}
    .page-header{text-align:center;margin-bottom:40px;opacity:0;transform:translateY(30px);animation:slideInDown 1s ease-out .2s forwards}
    .page-title{font-size:2.3rem;font-weight:800;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin:0 0 10px}
    .page-subtitle{font-size:1.05rem;color:#666;margin:0}

    /* ===== GRID ===== */
    .dashboard-grid{display:grid;grid-template-columns:1fr;gap:24px;margin-bottom:40px}
    @media(min-width:768px){.dashboard-grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:1200px){.dashboard-grid{grid-template-columns:repeat(4,1fr)}}

    /* ===== CARDS (flip solo desktop) ===== */
    .summary-card{background:rgba(255,255,255,0.9);border-radius:var(--radius-lg);border:1px solid var(--card-border);box-shadow:var(--shadow);position:relative;overflow:hidden;cursor:pointer;perspective:1000px;height:200px;opacity:0;transform:translateY(50px);transition:transform .3s ease, box-shadow .3s ease, opacity .3s ease}
    .summary-card.scroll-visible{opacity:1;transform:translateY(0)}
    .card-inner{position:relative;width:100%;height:100%;text-align:center;transition:transform .8s;transform-style:preserve-3d}
    @media (hover:hover) and (pointer:fine){
      .summary-card:hover .card-inner{transform:rotateY(180deg)}
      .summary-card:hover{transform:translateY(-10px) scale(1.02);box-shadow:0 25px 50px rgba(0,0,0,.15)}
      .summary-card:hover::before{height:100%;opacity:.1}
    }
    .card-front,.card-back{position:absolute;inset:0;backface-visibility:hidden;padding:24px;display:flex;flex-direction:column;justify-content:center;align-items:center}
    .card-back{transform:rotateY(180deg);background:linear-gradient(135deg,rgba(108,92,231,0.1),rgba(0,206,201,0.1))}
    .summary-card::before{content:"";position:absolute;left:0;right:0;top:0;height:4px;background:var(--grad);transition:height .3s ease}
    .summary-card.income::before{background:var(--grad-success)}
    .summary-card.expense::before{background:var(--grad-danger)}
    .summary-card.balance::before{background:var(--grad)}
    .summary-card.goal::before{background:var(--grad-warning)}
    .card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .card-title{font-size:1rem;font-weight:600;color:#666;display:flex;align-items:center;gap:8px}
    .card-icon{font-size:1.5rem}
    .donut-container{position:relative;width:80px;height:80px;margin:10px auto}
    .donut-svg{width:100%;height:100%;transform:rotate(-90deg)}
    .donut-track{fill:none;stroke:rgba(0,0,0,0.1);stroke-width:8}
    .donut-progress{fill:none;stroke-width:8;stroke-linecap:round;transition:stroke-dasharray 2s ease-out}
    .donut-text{position:absolute;inset:0;display:grid;place-items:center;font-size:.9rem;font-weight:700;text-align:center}
    .card-value{font-size:1.8rem;font-weight:800;margin:8px 0;line-height:1.2}
    .card-subtitle{font-size:.9rem;color:#999;margin:0}
    .income .donut-progress{stroke:var(--success-color)} .expense .donut-progress{stroke:var(--danger-color)} .balance .donut-progress{stroke:var(--primary-color)} .goal .donut-progress{stroke:var(--warning-color)}
    .income .card-value{color:var(--success-color)} .expense .card-value{color:var(--danger-color)} .balance .card-value{color:var(--primary-color)} .goal .card-value{color:var(--warning-color)}

    /* ===== CHARTS ===== */
    .charts-section{margin:40px 0;opacity:0;transform:translateY(50px)}
    .charts-section.scroll-visible{opacity:1;transform:translateY(0);transition:all .8s ease}
    .section-title{font-size:1.6rem;font-weight:700;margin:0 0 24px;color:var(--fg)}
    .charts-grid{display:grid;grid-template-columns:1fr;gap:24px}
    @media(min-width:1024px){.charts-grid{grid-template-columns:2fr 1fr}}
    .chart-card{background:rgba(255,255,255,0.9);border-radius:var(--radius-lg);padding:24px;border:1px solid var(--card-border);box-shadow:var(--shadow);transition:transform .3s ease, box-shadow .3s ease;cursor:pointer}
    @media (hover:hover) and (pointer:fine){.chart-card:hover{transform:translateY(-5px);box-shadow:0 20px 40px rgba(0,0,0,.12)}}
    .chart-title{font-size:1.2rem;font-weight:600;margin:0 0 16px;color:var(--fg)}
    .chart-container{position:relative;height:300px}
    .donut-chart{width:100%;height:100%;position:relative}
    .donut-svg-main{width:100%;height:100%}
    .donut-center{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
    .donut-total{font-size:1.8rem;font-weight:800;color:var(--fg)}
    .donut-label{font-size:.9rem;color:#666;margin-top:4px}
    .chart-legend{margin-top:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px}
    .legend-item{display:flex;align-items:center;gap:8px;font-size:.9rem;padding:8px;border-radius:8px;transition:transform .2s ease, background .2s ease;cursor:pointer}
    @media (hover:hover) and (pointer:fine){.legend-item:hover{background:rgba(0,0,0,0.05);transform:translateX(5px)}}
    .legend-color{width:12px;height:12px;border-radius:3px;flex-shrink:0}
    .legend-text{flex:1;font-weight:500}
    .legend-amount{font-weight:700;color:var(--fg)}

    /* ===== CATEGORIES ===== */
    .category-item{margin-bottom:16px;padding:12px;border-radius:8px;transition:transform .2s ease, background .2s ease;cursor:pointer}
    @media (hover:hover) and (pointer:fine){.category-item:hover{background:rgba(0,0,0,0.05);transform:scale(1.02)}}
    .category-item.clicked{animation:categoryPulse .6s ease-out}
    @keyframes categoryPulse{0%{transform:scale(1)}50%{transform:scale(1.05);background:rgba(108,92,231,0.1)}100%{transform:scale(1)}}

    /* ===== TRANSAZIONI ===== */
    .transactions-section{margin:40px 0;opacity:0;transform:translateY(50px)}
    .transactions-section.scroll-visible{opacity:1;transform:translateY(0);transition:all .8s ease .4s}
    .transactions-card{background:rgba(255,255,255,0.9);border-radius:var(--radius-lg);padding:24px;border:1px solid var(--card-border);box-shadow:var(--shadow)}
    .transaction-item{display:flex;align-items:center;gap:16px;padding:12px 0;border-bottom:1px solid rgba(0,0,0,0.05);transition:padding-left .2s ease, background .2s ease;cursor:pointer;opacity:0;transform:translateX(-30px)}
    .transaction-item.scroll-visible{opacity:1;transform:translateX(0)}
    @media (hover:hover) and (pointer:fine){.transaction-item:hover{background:rgba(0,0,0,0.02);padding-left:16px;border-radius:8px}}
    .transaction-item:last-child{border-bottom:none}
    .transaction-icon{font-size:1.5rem;width:40px;text-align:center;flex-shrink:0}
    .transaction-details{flex:1;min-width:0}
    .transaction-description{font-weight:600;margin:0 0 4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .transaction-meta{font-size:.85rem;color:#666}
    .transaction-amount{font-weight:700;font-size:1.1rem;flex-shrink:0}
    .transaction-amount.positive{color:var(--success-color)}
    .transaction-amount.negative{color:var(--danger-color)}

    /* ===== EMPTY ===== */
    .empty-state{text-align:center;padding:40px 20px;color:#777;background:rgba(0,0,0,0.02);border-radius:12px;margin:20px 0}
    .empty-state h3{margin:0 0 12px;font-size:1.1rem;color:#555}
    .empty-state p{margin:0;font-size:.95rem}

    /* ===== RIPPLE ===== */
    .ripple{position:absolute;border-radius:50%;background:rgba(255,255,255,0.6);transform:scale(0);animation:ripple-animation .6s linear;pointer-events:none}
    @keyframes ripple-animation{to{transform:scale(4);opacity:0}}

    /* ===== SCROLL FADE ===== */
    .scroll-fade{opacity:0;transform:translateY(30px);transition:all .8s ease}
    .scroll-fade.visible{opacity:1;transform:translateY(0)}

    /* ===== RESPONSIVE ===== */
    @media(max-width:768px){
      .page-title{font-size:2rem}
      .dashboard-grid{grid-template-columns:1fr;gap:16px}
      .charts-grid{grid-template-columns:1fr}
      .card-value{font-size:1.5rem}
      main.container{padding:84px 16px 24px}
      .topbar{padding:0 16px}
      .top-actions{flex-direction:column;gap:8px}
      .date-selectors{flex-direction:column;gap:8px;width:100%}
      .select-wrapper{width:100%}
      .morphing-shape{width:100px;height:100px}
    }

    /* ===== STATUS MSG ===== */
    .status-message{position:fixed;bottom:20px;right:20px;padding:12px 20px;border-radius:8px;font-weight:600;color:#fff;transform:translateY(100px);opacity:0;transition:all .3s ease;z-index:1000}
    .status-message.is-visible{transform:translateY(0);opacity:1}
    .status-message.success{background:var(--success-color)}
    .status-message.error{background:var(--danger-color)}
    .status-message.warning{background:var(--warning-color)}

    /* ===== ACCESSIBILIT√Ä / RIDUZIONE MOTION ===== */
    :focus-visible{outline:3px solid #7aa2ff;outline-offset:2px}
    @media (prefers-reduced-motion: reduce){
      *{animation-duration:.001ms !important;animation-iteration-count:1 !important;transition-duration:.001ms !important;scroll-behavior:auto !important}
    }
  </style>
</head>
<body>
  <!-- Particle System -->
  <div class="particles-container" id="particles-container"></div>
  <!-- Morphing Shapes -->
  <div class="morphing-shape shape-1"></div>
  <div class="morphing-shape shape-2"></div>
  <div class="morphing-shape shape-3"></div>

  <!-- Boot Loader -->
  <div id="boot-loader" class="boot-loader">
    <div class="loader-content">
      <div class="loader-spinner"></div>
      <p class="loader-text">Caricamento dati...</p>
    </div>
  </div>

  <!-- Top Bar -->
  <nav class="topbar" aria-label="Barra superiore">
    <a href="/dashboard.html" class="logo-link">
      <span class="logo-text">üè† MyHomesBudget</span>
    </a>
    <div class="top-center">
      <div class="date-selectors">
        <div class="select-wrapper">
          <select id="month-selector" class="topbar-select" aria-label="Seleziona mese"></select>
        </div>
        <div class="select-wrapper">
          <select id="year-selector" class="topbar-select" aria-label="Seleziona anno"></select>
        </div>
      </div>
    </div>
    <div class="top-actions">
      <a href="/dashboard.html" class="top-link">üìä Dashboard</a>
      <button id="logout-btn" class="top-btn" type="button">Esci</button>
    </div>
  </nav>

  <!-- Main -->
  <main class="container">
    <div class="page-header">
      <h1 class="page-title">üìà Riepilogo Finanziario</h1>
      <p class="page-subtitle">Analisi dettagliata delle tue finanze</p>
    </div>

    <!-- Summary Cards -->
    <div id="summary-content" class="dashboard-grid">
      <div class="summary-card income" role="button" tabindex="24" aria-label="Entrate totali">
        <div class="card-inner">
          <div class="card-front">
            <div class="card-header">
              <div class="card-title"><span class="card-icon">üí∞</span>Entrate Totali</div>
            </div>
            <div class="donut-container">
              <svg class="donut-svg" viewBox="0 0 100 100" aria-hidden="true">
                <circle class="donut-track" cx="50" cy="50" r="40"></circle>
                <circle class="donut-progress" id="income-donut" cx="50" cy="50" r="40" stroke-dasharray="0 251.2"></circle>
              </svg>
              <div class="donut-text"><div id="income-percentage">0%</div></div>
            </div>
            <p id="income-value" class="card-value">‚Ç¨0.00</p>
            <p class="card-subtitle">Questo mese</p>
          </div>
          <div class="card-back" aria-hidden="true">
            <div class="insight-icon">üìä</div>
            <div class="insight-title">Analisi Entrate</div>
            <div id="income-insight" class="insight-text">Le tue entrate mostrano un trend positivo rispetto al mese scorso</div>
          </div>
        </div>
      </div>

      <div class="summary-card expense" role="button" tabindex="0" aria-label="Uscite totali">
        <div class="card-inner">
          <div class="card-front">
            <div class="card-header">
              <div class="card-title"><span class="card-icon">üí∏</span>Uscite Totali</div>
            </div>
            <div class="donut-container">
              <svg class="donut-svg" viewBox="0 0 100 100" aria-hidden="true">
                <circle class="donut-track" cx="50" cy="50" r="40"></circle>
                <circle class="donut-progress" id="expense-donut" cx="50" cy="50" r="40" stroke-dasharray="0 251.2"></circle>
              </svg>
              <div class="donut-text"><div id="expense-percentage">0%</div></div>
            </div>
            <p id="expense-value" class="card-value">‚Ç¨0.00</p>
            <p class="card-subtitle">Questo mese</p>
          </div>
          <div class="card-back" aria-hidden="true">
            <div class="insight-icon">‚ö†Ô∏è</div>
            <div class="insight-title">Controllo Spese</div>
            <div id="expense-insight" class="insight-text">Monitora le tue spese per rimanere nel budget</div>
          </div>
        </div>
      </div>

      <div class="summary-card balance" role="button" tabindex="0" aria-label="Saldo">
        <div class="card-inner">
          <div class="card-front">
            <div class="card-header">
              <div class="card-title"><span class="card-icon">‚öñÔ∏è</span>Saldo</div>
            </div>
            <div class="donut-container">
              <svg class="donut-svg" viewBox="0 0 100 100" aria-hidden="true">
                <circle class="donut-track" cx="50" cy="50" r="40"></circle>
                <circle class="donut-progress" id="balance-donut" cx="50" cy="50" r="40" stroke-dasharray="0 251.2"></circle>
              </svg>
              <div class="donut-text"><div id="balance-percentage">0%</div></div>
            </div>
            <p id="balance-value" class="card-value">‚Ç¨0.00</p>
            <p class="card-subtitle">Differenza entrate/uscite</p>
          </div>
          <div class="card-back" aria-hidden="true">
            <div class="insight-icon">üí°</div>
            <div class="insight-title">Situazione Finanziaria</div>
            <div id="balance-insight" class="insight-text">Il tuo saldo riflette la gestione delle finanze</div>
          </div>
        </div>
      </div>

      <div class="summary-card goal" role="button" tabindex="0" aria-label="Obiettivo">
        <div class="card-inner">
          <div class="card-front">
            <div class="card-header">
              <div class="card-title"><span class="card-icon">üéØ</span>Obiettivo</div>
            </div>
            <div class="donut-container">
              <svg class="donut-svg" viewBox="0 0 100 100" aria-hidden="true">
                <circle class="donut-track" cx="50" cy="50" r="40"></circle>
                <circle class="donut-progress" id="goal-donut" cx="50" cy="50" r="40" stroke-dasharray="0 251.2"></circle>
              </svg>
              <div class="donut-text"><div id="goal-percentage">0%</div></div>
            </div>
            <p id="goal-value" class="card-value">‚Ç¨0.00</p>
            <p id="goal-name" class="card-subtitle">Nessun obiettivo</p>
          </div>
          <div class="card-back" aria-hidden="true">
            <div class="insight-icon">üöÄ</div>
            <div class="insight-title">Progressi Obiettivo</div>
            <div id="goal-insight" class="insight-text">Continua cos√¨ per raggiungere il tuo obiettivo!</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <section class="charts-section scroll-fade" aria-label="Analisi per categoria">
      <h2 class="section-title">üìä Analisi per Categoria</h2>
      <div class="charts-grid">
        <div class="chart-card">
          <h3 class="chart-title">Distribuzione Spese</h3>
          <div class="chart-container">
            <div id="expenses-chart" class="donut-chart"></div>
          </div>
          <div id="expenses-legend" class="chart-legend"></div>
        </div>
        <div class="chart-card">
          <h3 class="chart-title">Top 5 Categorie</h3>
          <div id="top-categories-list"></div>
        </div>
      </div>
    </section>

    <!-- Recent Transactions -->
    <section class="transactions-section scroll-fade" aria-label="Transazioni recenti">
      <h2 class="section-title">üí≥ Transazioni Recenti</h2>
      <div class="transactions-card">
        <div id="recent-transactions"></div>
      </div>
    </section>
  </main>

  <!-- Status Message -->
  <div id="status-message" class="status-message" aria-live="polite"></div>

  <script>
    /* SUMMARY FIX - 25/09/2025 */

    // === Supabase ===
    const SUPABASE_URL = "https://upcusjlumfeadgbhziwq.supabase.co";
    const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwY3Vzamx1bWZlYWRnYmh6aXdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0MTAzMTgsImV4cCI6MjA3MTk4NjMxOH0.U3cukTOaAZCPOF9f0mnyO00ghRgrzxwPx6GwqKuZmCM";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
      auth: { storage: localStorage, persistSession: true, autoRefreshToken: true }
    });

    // === Stato/DOM ===
    let user = null, allCategories = [], currentData = null;
    const bootLoader = document.getElementById('boot-loader');
    const monthSelector = document.getElementById('month-selector');
    const yearSelector = document.getElementById('year-selector');
    const statusMessage = document.getElementById('status-message');
    const logoutBtn = document.getElementById('logout-btn');

    // === Utils ===
    const safeToNumber = v => {
      const n = (typeof v === 'number') ? v : parseFloat(String(v).replace(',', '.'));
      return Number.isFinite(n) ? n : 0;
    };
    const formatCurrency = amount => new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR',minimumFractionDigits:2}).format(amount);
    const escapeHTML = s => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    const showStatusMessage = (message, type='success', duration=3000) => {
      statusMessage.textContent = message;
      statusMessage.className = `status-message ${type} is-visible`;
      setTimeout(()=>statusMessage.classList.remove('is-visible'), duration);
    };

    // === Particelle (ridotte su mobile) ===
    function createParticles() {
      const isMobile = window.matchMedia('(max-width: 480px)').matches;
      const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
      const particleCount = prefersReduced ? 0 : (isMobile ? 14 : 36);
      const container = document.getElementById('particles-container');
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random()*100 + '%';
        particle.style.animationDelay = (Math.random()*6) + 's';
        particle.style.animationDuration = (6 + Math.random()*4) + 's';
        container.appendChild(particle);
      }
    }

    // === Ripple (coordinate corrette, touch-friendly) ===
    function createRipple(e) {
      const el = e.currentTarget;
      const rect = el.getBoundingClientRect();
      const diameter = Math.max(rect.width, rect.height);
      const radius = diameter/2;

      const cx = (e.clientX ?? e.touches?.[0]?.clientX) - rect.left;
      const cy = (e.clientY ?? e.touches?.[0]?.clientY) - rect.top;

      const circle = document.createElement('span');
      circle.className = 'ripple';
      circle.style.width = circle.style.height = `${diameter}px`;
      circle.style.left = `${cx - radius}px`;
      circle.style.top  = `${cy - radius}px`;

      el.querySelector('.ripple')?.remove();
      el.appendChild(circle);
    }

    // === Scroll animations ===
    const observer = new IntersectionObserver(entries => {
      entries.forEach(entry => { if (entry.isIntersecting) entry.target.classList.add('scroll-visible'); });
    }, { threshold: .1, rootMargin: '0px 0px -50px 0px' });

    function initScrollAnimations() {
      document.querySelectorAll('.scroll-fade, .summary-card, .transaction-item').forEach(el => observer.observe(el));
    }

    // === Contatori ===
    function animateCounter(element, targetValue, duration=2000, formatter=(v)=>formatCurrency(v)) {
      const startValue = 0, startTime = performance.now();
      function update(t){
        const p = Math.min((t-startTime)/duration,1);
        const eased = 1 - Math.pow(1-p,4);
        const val = startValue + (targetValue-startValue)*eased;
        element.textContent = formatter(val);
        if (p < 1) requestAnimationFrame(update); else element.textContent = formatter(targetValue);
      }
      requestAnimationFrame(update);
    }

    // === Donut ===
    function animateDonut(elementId, percentage, delay=0) {
      setTimeout(() => {
        const circle = document.getElementById(elementId);
        if (!circle) return;
        const C = 2 * Math.PI * 40;
        circle.style.strokeDasharray = `${(percentage/100)*C} ${C}`;
      }, delay);
    }

    // === Date selectors ===
    function initializeDateSelectors() {
      const now = new Date(); const m = now.getMonth(); const y = now.getFullYear();
      const months = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
      monthSelector.innerHTML = months.map((name, idx)=>`<option value="${idx}" ${idx===m?'selected':''}>${name}</option>`).join('');
      yearSelector.innerHTML = Array.from({length:8},(_,i)=>y-5+i).map(yr=>`<option value="${yr}" ${yr===y?'selected':''}>${yr}</option>`).join('');
    }

    // === Categories (opzionale per icone) ===
    async function loadCategories() {
      try {
        const { data, error } = await supabase.from('categories').select('*').eq('created_by', user.id);
        if (error) throw error; allCategories = data || [];
      } catch (err) { console.error('Errore categorie:', err); }
    }

    // === Transactions per periodo ===
    async function loadTransactionsForPeriod(month, year) {
      try {
        const start = new Date(year, month, 1);
        const nextMonth = new Date(year, month + 1, 1);
        const startISO = start.toISOString();
        const nextMonthISO = nextMonth.toISOString();

        const { data, error } = await supabase
          .from('transactions')
          .select(`
            *,
            categories:category_id(name, icon),
            subcategories:subcategory_id(name, icon)
          `)
          .eq('created_by', user.id)
          .gte('occurred_at', startISO)
          .lt('occurred_at', nextMonthISO)
          .eq('is_paid', true)
          .order('occurred_at', { ascending: false });

        if (error) throw error;
        return data || [];
      } catch (err) {
        console.error('Errore transazioni:', err);
        return [];
      }
    }

    // === Goals ===
    async function loadGoals() {
      try {
        const { data, error } = await supabase
          .from('goals')
          .select('name, target_amount, current_amount')
          .eq('user_id', user.id)
          .eq('active', true)
          .limit(1)
          .maybeSingle();
        if (error && error.code !== 'PGRST116') throw error;
        return data;
      } catch (err) { console.error('Errore goals:', err); return null; }
    }

    // === Render summary cards ===
    function renderSummaryCards(data) {
      const incomeEl = document.getElementById('income-value');
      const expenseEl = document.getElementById('expense-value');
      const balanceEl = document.getElementById('balance-value');
      const goalValueEl = document.getElementById('goal-value');
      const goalNameEl = document.getElementById('goal-name');

      const maxAmount = Math.max(data.totalIncome, data.totalExpenses, Math.abs(data.balance));
      const incomePct = maxAmount>0 ? (data.totalIncome/maxAmount)*100 : 0;
      const expensePct = maxAmount>0 ? (data.totalExpenses/maxAmount)*100 : 0;
      const balancePct = maxAmount>0 ? (Math.abs(data.balance)/maxAmount)*100 : 0;

      document.getElementById('income-percentage').textContent = Math.round(incomePct) + '%';
      document.getElementById('expense-percentage').textContent = Math.round(expensePct) + '%';
      document.getElementById('balance-percentage').textContent = Math.round(balancePct) + '%';

      setTimeout(()=>{ animateCounter(incomeEl, data.totalIncome, 1500); }, 300);
      setTimeout(()=>{ animateCounter(expenseEl, data.totalExpenses, 1500); }, 450);
      setTimeout(()=>{ animateCounter(balanceEl, data.balance, 1500, (v)=>formatCurrency(v)); }, 600);

      animateDonut('income-donut', incomePct, 500);
      animateDonut('expense-donut', expensePct, 700);
      animateDonut('balance-donut', balancePct, 900);

      balanceEl.style.color = data.balance >= 0 ? 'var(--success-color)' : 'var(--danger-color)';

      document.getElementById('income-insight').textContent =
        data.totalIncome > 2000 ? "Ottime entrate questo mese! üí™" :
        data.totalIncome > 1000 ? "Entrate nella media üìä" : "Cerca di aumentare le entrate üìà";

      document.getElementById('expense-insight').textContent =
        data.totalExpenses > data.totalIncome ? "Attenzione: spese superiori alle entrate ‚ö†Ô∏è" : "Spese sotto controllo! üëç";

      document.getElementById('balance-insight').textContent =
        data.balance > 500 ? "Ottima gestione finanziaria! üéâ" :
        data.balance > 0 ? "Situazione equilibrata ‚öñÔ∏è" : "Necessario rivedere il budget ‚ö†Ô∏è";

      if (data.goal) {
        setTimeout(()=>animateCounter(goalValueEl, data.goal.current_amount, 1500), 700);
        goalNameEl.textContent = data.goal.name;
        const progress = data.goal.target_amount>0 ? (data.goal.current_amount/data.goal.target_amount)*100 : 0;
        document.getElementById('goal-percentage').textContent = Math.round(progress) + '%';
        animateDonut('goal-donut', progress, 1100);
        document.getElementById('goal-insight').textContent =
          progress>=100 ? "Obiettivo raggiunto! üéØüéâ" :
          progress>=75 ? "Quasi al traguardo! üöÄ" :
          progress>=50 ? "A met√† strada! üí™" :
          progress>=25 ? "Buon inizio! üëç" : "Inizia a risparmiare! üí∞";
      } else {
        goalValueEl.textContent = formatCurrency(0);
        goalNameEl.textContent = 'Nessun obiettivo';
        document.getElementById('goal-percentage').textContent = '0%';
        document.getElementById('goal-insight').textContent = "Imposta un obiettivo per iniziare! üéØ";
      }
    }

    // === Chart spese donut + legenda ===
    function renderExpensesChart(categories) {
      const chartContainer = document.getElementById('expenses-chart');
      const legendContainer = document.getElementById('expenses-legend');
      if (!categories || categories.length === 0) {
        chartContainer.innerHTML = '<div class="empty-state"><h3>Nessuna spesa</h3><p>Non ci sono spese per questo periodo.</p></div>';
        legendContainer.innerHTML = ''; return;
      }
      const total = categories.reduce((s,c)=>s + c.amount, 0);
      const colors = ['#6c5ce7','#00cec9','#fd79a8','#fdcb6e','#e17055','#74b9ff','#a29bfe'];

      const size = 200, radius = 70, center = size/2; let currentAngle = 0, svgPaths = '', legendHTML = '';
      categories.forEach((cat, i)=>{
        const slice = (cat.amount/total)*360, start=currentAngle, end=currentAngle+slice;
        const x1 = center + radius * Math.cos((start-90)*Math.PI/180);
        const y1 = center + radius * Math.sin((start-90)*Math.PI/180);
        const x2 = center + radius * Math.cos((end-90)*Math.PI/180);
        const y2 = center + radius * Math.sin((end-90)*Math.PI/180);
        const laf = slice>180 ? 1 : 0;
        const path = `M ${center} ${center} L ${x1} ${y1} A ${radius} ${radius} 0 ${laf} 1 ${x2} ${y2} Z`;
        const color = colors[i%colors.length];
        svgPaths += `<path d="${path}" fill="${color}" stroke="#fff" stroke-width="2" opacity="0" style="animation: fadeIn .6s ease-out ${i*0.2}s forwards"/>`;
        legendHTML += `
          <div class="legend-item" style="animation-delay:${i*0.1}s">
            <div class="legend-color" style="background-color:${color}"></div>
            <span class="legend-text">${escapeHTML(cat.name)}</span>
            <span class="legend-amount">${formatCurrency(cat.amount)}</span>
          </div>`;
        currentAngle += slice;
      });

      chartContainer.innerHTML = `
        <svg class="donut-svg-main" viewBox="0 0 ${size} ${size}">
          ${svgPaths}
          <circle cx="${center}" cy="${center}" r="40" fill="white" stroke="none"></circle>
        </svg>
        <div class="donut-center">
          <div class="donut-total counter">${formatCurrency(total)}</div>
          <div class="donut-label">Totale Spese</div>
        </div>`;
      legendContainer.innerHTML = legendHTML;

      legendContainer.querySelectorAll('.legend-item').forEach(item => item.addEventListener('click', createRipple));
    }

    // === Top categories ===
    function renderTopCategories(categories) {
      const container = document.getElementById('top-categories-list');
      if (!categories || categories.length===0) {
        container.innerHTML = '<div class="empty-state"><h3>Nessuna categoria</h3><p>Non ci sono categorie da visualizzare.</p></div>'; return;
      }
      const top = categories.slice(0,5);
      const max = Math.max(...top.map(c=>c.amount));
      container.innerHTML = top.map((c,i)=>{
        const pct = max>0 ? (c.amount/max)*100 : 0;
        const icon = c.icon || 'üí∏';
        return `
          <div class="category-item" data-category="${escapeHTML(c.name)}" style="animation-delay:${i*0.1}s;opacity:0;animation:fadeInUp .6s ease-out ${i*0.1}s forwards;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
              <span style="display:flex;align-items:center;gap:8px;font-weight:600;"><span style="font-size:1.2rem;">${escapeHTML(icon)}</span>${escapeHTML(c.name)}</span>
              <span class="counter" style="font-weight:700;color:var(--danger-color);">${formatCurrency(c.amount)}</span>
            </div>
            <div class="progress-container"><div class="progress-bar"><div class="progress-fill" style="background:var(--grad-danger);width:0%;transition:width 2s ease-out ${i*0.2}s;"></div></div></div>
          </div>`;
      }).join('');

      setTimeout(()=>{ top.forEach((c,i)=>{ const el=container.children[i]?.querySelector('.progress-fill'); if(el){ el.style.width = (max>0 ? (c.amount/max)*100 : 0) + '%'; } }); }, 500);
      container.querySelectorAll('.category-item').forEach(el=>{
        el.addEventListener('click', e=>{ el.classList.add('clicked'); createRipple(e); setTimeout(()=>el.classList.remove('clicked'), 600); });
      });
    }

    // === Transazioni recenti ===
    function renderRecentTransactions(transactions) {
      const container = document.getElementById('recent-transactions');
      if (!transactions || transactions.length===0) {
        container.innerHTML = '<div class="empty-state"><h3>Nessuna transazione</h3><p>Non ci sono transazioni recenti da visualizzare.</p></div>'; return;
      }
      const recent = transactions.slice(0,10);
      container.innerHTML = recent.map((tx,i)=>{
        const raw = safeToNumber(tx.amount);
        const abs = Math.abs(raw);
        const isIncome = (tx.kind==='income') || raw>0;
        const sign = isIncome ? '+' : '-';
        const categoryName = tx.categories?.name || 'Altro';
        const categoryIcon = tx.categories?.icon || (isIncome ? 'üí∞' : 'üí∏');
        const date = new Date(tx.occurred_at).toLocaleDateString('it-IT',{day:'2-digit',month:'short'});
        return `
          <div class="transaction-item" style="animation-delay:${i*0.1}s">
            <div class="transaction-icon">${escapeHTML(categoryIcon)}</div>
            <div class="transaction-details">
              <h4 class="transaction-description">${escapeHTML(tx.note || 'Transazione')}</h4>
              <p class="transaction-meta">${date} ‚Ä¢ ${escapeHTML(categoryName)}</p>
            </div>
            <div class="transaction-amount ${isIncome ? 'positive':'negative'}">${sign}${formatCurrency(abs)}</div>
          </div>`;
      }).join('');
      container.querySelectorAll('.transaction-item').forEach(el=>el.addEventListener('click', createRipple));
    }

    // === Caricamento dati principale ===
    async function loadSummaryData() {
      try{
        monthSelector.disabled = true; yearSelector.disabled = true;
        const m = parseInt(monthSelector.value); const y = parseInt(yearSelector.value);
        const [transactions, goal] = await Promise.all([ loadTransactionsForPeriod(m, y), loadGoals() ]);

        const incomeTx = transactions.filter(t => t.kind==='income' || safeToNumber(t.amount) > 0);
        const expenseTx = transactions.filter(t => t.kind==='expense' || safeToNumber(t.amount) < 0);

        const totalIncome = incomeTx.reduce((s,t)=>s + Math.abs(safeToNumber(t.amount)), 0);
        const totalExpenses = expenseTx.reduce((s,t)=>s + Math.abs(safeToNumber(t.amount)), 0);
        const balance = totalIncome - totalExpenses;

        const categoryExpenses = {};
        expenseTx.forEach(tx=>{
          const name = tx.categories?.name || 'Altro';
          const icon = tx.categories?.icon || 'üí∏';
          categoryExpenses[name] ??= { name, icon, amount:0 };
          categoryExpenses[name].amount += Math.abs(safeToNumber(tx.amount));
        });
        const expenseCategories = Object.values(categoryExpenses).sort((a,b)=>b.amount-a.amount);

        currentData = { totalIncome, totalExpenses, balance, goal, expenseCategories, transactions,
          period:{ month:m, year:y } };

        renderSummaryCards(currentData);
        renderExpensesChart(expenseCategories);
        renderTopCategories(expenseCategories);
        renderRecentTransactions(transactions);

        setTimeout(()=>{
          document.querySelectorAll('.summary-card').forEach((card,i)=>{
            card.style.animationDelay = `${i*0.1}s`;
            card.classList.add('scroll-visible');
          });
        }, 400);

      } catch(err){
        console.error('Errore caricamento dati:', err);
        showStatusMessage('Errore nel caricamento dei dati', 'error');
      } finally{
        monthSelector.disabled = false; yearSelector.disabled = false;
      }
    }

    // === Init ===
    async function initializeApp() {
      try{
        const { data:{ user:authUser }, error:authError } = await supabase.auth.getUser();
        if (authError || !authUser) { window.location.href = '/'; return; }
        user = authUser;

        createParticles();
        initScrollAnimations();
        initializeDateSelectors();
        await loadCategories();
        await loadSummaryData();

        monthSelector.addEventListener('change', loadSummaryData);
        yearSelector.addEventListener('change', loadSummaryData);

        document.querySelectorAll('.summary-card, .chart-card').forEach(card=>{
          card.addEventListener('click', createRipple);
          card.addEventListener('touchstart', createRipple, { passive:true });
          card.addEventListener('keydown', e=>{ if(e.key==='Enter' || e.key===' '){ card.click(); e.preventDefault(); } });
        });

        logoutBtn.addEventListener('click', async ()=>{ await supabase.auth.signOut(); window.location.href='/'; });

        bootLoader.classList.add('is-hidden');
        // safety: nascondi loader comunque
        setTimeout(()=>bootLoader.classList.add('is-hidden'), 4000);

        showStatusMessage('Dati caricati con successo!', 'success');
      } catch(err){
        console.error('Initialization error:', err);
        showStatusMessage("Errore durante l'inizializzazione", 'error');
        bootLoader.classList.add('is-hidden');
      }
    }

    // Animazioni chiave
    (function addKeyframes(){
      const style = document.createElement('style');
      style.textContent = `
        @keyframes fadeIn { from{opacity:0;transform:scale(.8)} to{opacity:.9;transform:scale(1)} }
        @keyframes fadeInUp { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
        @keyframes slideInDown { from{opacity:0;transform:translateY(-30px)} to{opacity:1;transform:translateY(0)} }
      `;
      document.head.appendChild(style);
    })();

    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
