<!doctype html>
<html lang="it" data-app="myhomesbudget">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard — MyHomesBudget</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" href="/favicon.ico" />

  <style>
    :root{
      --fg:#111;--bg:#f4f7fa;--glass:rgba(255,255,255,.6);
      --card-border:rgba(0,0,0,.08);--shadow:0 10px 30px rgba(0,0,0,.08);
      --radius-lg:16px;--primary-color:#6c5ce7;--danger-color:#d32f2f;--success-color:#2e7d32;
      --font-sans:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif;
      --ai-glow: 0 0 15px rgba(108, 92, 231, 0.5);
    }
    *{box-sizing:border-box}
    html{font-family:var(--font-sans);background-color:var(--bg)}
    body{margin:0;color:var(--fg);background:url("/bg.webp") no-repeat center/cover fixed;min-height:100vh}
    body::before{content:"";position:fixed;inset:0;background:linear-gradient(135deg, rgba(108,92,231,.05), rgba(0,206,201,.05));z-index:-1}

    /* ====== TOPBAR ====== */
    .topbar{position:fixed;top:0;left:0;right:0;height:60px;padding:0 24px;
      display:flex;align-items:center;justify-content:space-between;
      background:var(--glass);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);
      border-bottom:1px solid var(--card-border);z-index:100}
    .logo-link{display:flex;align-items:center;gap:8px;text-decoration:none}
    .logo-text{font-weight:600;color:#fff;font-size:1.1rem;text-shadow:0 1px 2px rgba(0,0,0,.35)}
    .top-actions{display:flex;gap:12px;align-items:center}
    .top-link{color:#fff;text-decoration:none;padding:6px 12px;border-radius:10px;
      background:rgba(0,0,0,.28);border:1px solid rgba(255,255,255,.25);font-size:.9rem;font-weight:600}
    #month-selector{background:rgba(255,255,255,.8);border-radius:8px;border:1px solid rgba(0,0,0,.1);padding:4px 8px;font-weight:600}
    #month-selector:disabled { opacity: 0.7; }
    .top-center{position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;gap:12px}
    #trial-banner{display:none;align-items:center;gap:10px;background:linear-gradient(135deg,#6c5ce7,#00cec9);color:#fff;padding:8px 12px;border-radius:999px;font-weight:700;box-shadow:0 6px 16px rgba(0,0,0,.15)}
    #trial-banner a{background:#fff;color:var(--primary-color);text-decoration:none;padding:4px 10px;border-radius:999px;font-size:.85rem;font-weight:800}

    /* ====== Contenuto Principale ====== */
    main.container{padding:84px 24px 24px;max-width:1280px;margin:0 auto;width:100%}
    .dash-nav{display:flex;gap:8px;border-bottom:1px solid rgba(0,0,0,.1);padding-bottom:12px;margin-bottom:24px}
    .dash-nav a{text-decoration:none;color:#333;padding:8px 16px;border-radius:10px;font-weight:600}
    .dash-nav a.is-active{background:#fff;color:var(--primary-color);box-shadow:0 4px 12px rgba(0,0,0,.08)}
    .content-section{background:rgba(255,255,255,.85);border-radius:var(--radius-lg);padding:24px;border:1px solid var(--card-border);box-shadow:var(--shadow)}

    /* ====== Layout Dashboard & Colonne ====== */
    .dashboard-grid{display:grid;grid-template-columns:1fr;gap:24px}
    @media(min-width: 1024px){.dashboard-grid{grid-template-columns:repeat(2, 1fr);}.form-section{grid-column:1 / -1}}
    .flow-column h2{display:flex;align-items:center;justify-content:space-between;gap:12px;font-size:1.5rem;margin:0 0 16px}
    .flow-column.income h2{color:var(--success-color)}
    .flow-column.expense h2{color:var(--danger-color)}

    /* ====== Card Riepilogo Categorie ====== */
    .summary-card{background:#fff;padding:16px;border-radius:var(--radius-lg);box-shadow:0 4px 15px rgba(0,0,0,.05);margin-bottom:16px}
    .summary-card h3{margin:0 0 12px;font-size:1rem;color:#555}
    .category-summary{display:flex;flex-wrap:wrap;gap:10px}
    .category-tag{display:flex;align-items:center;gap:6px;background:rgba(0,0,0,.05);padding:6px 10px;border-radius:8px;font-size:0.9rem}
    .category-tag .icon{font-size:1.1rem}
    .category-tag .name{font-weight:600;color:#333}
    .category-tag .total{font-weight:700}
    .income .category-tag .total{color:var(--success-color)}
    .expense .category-tag .total{color:var(--danger-color)}

    /* ====== Form Compatto ====== */
    .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;font-weight:800;transition:.2s}
    .btn-primary{background:var(--primary-color);color:#fff;box-shadow:0 8px 22px rgba(0,0,0,.14)}
    .transaction-form{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:flex-end}
    .form-group{display:flex;flex-direction:column}
    .form-group label{font-weight:600;font-size:.9rem;margin-bottom:6px}
    .form-group input,.form-group select{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;background:#fff;font-size:1rem}
    .form-group.kind, .form-group.note{grid-column:1 / -1}
    .transaction-form button{grid-column:1 / -1;margin-top:10px}
    @media(min-width: 1024px){.transaction-form{grid-template-columns:repeat(6, 1fr);gap:16px}.form-group.kind{grid-column:span 1}.form-group.note{grid-column:span 3}.form-group.amount{grid-column:span 2}.form-group.date{grid-column:span 2}.form-group.category{grid-column:span 2}.form-group.subcategory{grid-column:span 2}}

    /* ====== Stili Lista Transazioni (Invariati) ====== */
    .transaction-list .item{display:grid;grid-template-columns:auto 1fr auto auto;gap:12px;align-items:center;padding:12px 4px;border-bottom:1px solid rgba(0,0,0,.05)}
    .item:last-child{border-bottom:none}
    .item-icon{font-size:1.5rem;flex-shrink:0}
    .item-details{display:flex;flex-direction:column;min-width:0}
    .item-details .note{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .item-details .category{font-size:.9rem;color:#555;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .item-amount{text-align:right;white-space:nowrap;flex-shrink:0}
    .item-amount.expense{color:var(--danger-color);font-weight:700}
    .item-amount.income{color:var(--success-color);font-weight:700}
    .item-actions{display:flex;gap:4px;flex-shrink:0}
    .action-btn{background:rgba(0,0,0,.05);color:#555;border:1px solid rgba(0,0,0,.1);border-radius:8px;padding:6px 10px;font-size:.85rem;font-weight:600;cursor:pointer}
    .action-btn:hover{background:var(--primary-color);color:#fff;border-color:var(--primary-color)}
    .action-btn.delete{background:#f8d7da;color:#842029;border-color:#f5c2c7}
    .action-btn.delete:hover{background:#dc3545;color:#fff;border-color:#dc3545}
    .empty-state{text-align:center;padding:40px 20px;color:#777;background:rgba(0,0,0,0.02);border-radius:12px}

    /* ====== ✨ VIBE UPGRADE: Stili per Funzionalità IA ✨ ====== */
    .btn-ai{background:linear-gradient(135deg, var(--primary-color), #a29bfe);color:white;border:none;padding:6px 12px;border-radius:8px;font-size:0.9rem;font-weight:700;cursor:pointer;transition:all 0.2s ease;box-shadow:0 4px 10px rgba(108, 92, 231, 0.3)}
    .btn-ai:hover{transform:translateY(-1px);box-shadow:var(--ai-glow)}
    .btn-ai:disabled{opacity:0.6;cursor:not-allowed}
    .input-with-button{display:flex;align-items:center;gap:8px}
    .input-with-button input{flex-grow:1}
    .btn-ai-small{padding:6px;width:38px;height:38px;font-size:1.2rem;border-radius:8px;flex-shrink:0;line-height:1}
    .note-suggestions{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .suggestion-tag{background:rgba(108, 92, 231, 0.1);color:var(--primary-color);padding:4px 10px;border-radius:12px;font-size:0.85rem;font-weight:600;cursor:pointer}
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;padding:16px;backdrop-filter:blur(5px)}
    .modal-content{background:var(--bg);color:var(--fg);border-radius:var(--radius-lg);padding:24px;width:100%;max-width:600px;box-shadow:var(--shadow);position:relative;max-height:90vh;overflow-y:auto}
    .modal-close{position:absolute;top:10px;right:10px;background:none;border:none;font-size:2rem;cursor:pointer;color:#888}
    #modal-body h3{margin-top:0}
    #modal-body ul{padding-left:20px}
    #modal-body li{margin-bottom:10px}
    .loader{width:48px;height:48px;border:5px solid var(--primary-color);border-bottom-color:transparent;border-radius:50%;display:inline-block;box-sizing:border-box;animation:rotation 1s linear infinite;margin:20px auto;display:block}
    @keyframes rotation{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <!-- ⚡️ VIBE CHANGE: Topbar più pulita e funzionale ⚡️ -->
  <nav class="topbar">
    <a href="/it/" class="logo-link"><img src="/homes.png" alt="Logo" style="height:32px;border-radius:6px"><span class="logo-text">MyHomesBudget</span></a>
    <div class="top-center"><div id="trial-banner"><span id="trial-days-left"></span><a href="/it/paywall.html">Aggiorna piano</a></div></div>
    <div class="top-actions">
      <select id="month-selector" aria-label="Seleziona mese"></select>
      <a href="/it/onboarding.html?edit=1" class="top-link">Modifica Obiettivo</a>
      <a href="#" id="logout-btn" class="top-link">Esci</a>
    </div>
  </nav>

  <main class="container">
    <nav id="dash-nav" class="dash-nav"><a href="/it/dashboard.html" class="is-active" aria-current="page">Operazioni</a><a href="/it/dashboard-riepilogo.html">Riepilogo</a></nav>

    <!-- Sezione Form con Copilota IA (invariata) -->
    <section class="content-section form-section">
      <h2 id="form-title" style="margin:0 0 16px">Nuova Transazione</h2>
      <form id="transaction-form" class="transaction-form">
        <input type="hidden" id="transaction-id" name="transaction-id">
        <div class="form-group kind"><label for="kind">Tipo</label><select id="kind" name="kind" required><option value="expense">Uscita</option><option value="income">Entrata</option><option value="transfer">Trasferimento</option></select></div>
        <div class="form-group note"><label for="note">Nota</label><div class="input-with-button"><input type="text" id="note" name="note" placeholder="Es. Caffè al bar" required><button type="button" id="suggest-note-btn" class="btn-ai btn-ai-small" title="Suggerisci nota con IA">✨</button></div><div id="note-suggestions" class="note-suggestions"></div></div>
        <div class="form-group amount"><label for="amount">Importo (€)</label><input type="number" id="amount" name="amount" step="0.01" placeholder="0.00" required></div>
        <div class="form-group date"><label for="occurred_at">Data</label><input type="date" id="occurred_at" name="occurred_at" required></div>
        <div class="form-group category"><label for="category_id">Categoria</label><select id="category_id" name="category_id" required></select></div>
        <div class="form-group subcategory"><label for="subcategory_id">Sottocategoria</label><select id="subcategory_id" name="subcategory_id"></select></div>
        <button type="submit" class="btn btn-primary">Aggiungi</button>
      </form>
    </section>

    <!-- Griglia Dashboard con Analisi IA (invariata) -->
    <div class="dashboard-grid" style="margin-top: 24px;">
      <div class="flow-column income"><h2>✅ Entrate Recenti</h2><div id="income-summary" class="summary-card"></div><div id="income-list" class="content-section transaction-list"></div></div>
      <div class="flow-column expense"><h2><span>❌ Uscite Recenti</span> <button id="analyze-expenses-btn" class="btn-ai">✨ Analizza Spese</button></h2><div id="expense-summary" class="summary-card"></div><div id="expense-list" class="content-section transaction-list"></div></div>
    </div>
  </main>
  
  <!-- Modal per Risultati IA (invariato) -->
  <div id="gemini-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content"><button id="modal-close-btn" class="modal-close">&times;</button><div id="modal-body"></div></div>
  </div>

  <script type="module">
    import { supabase } from "/it/supabase-client.js";

    // --- Elementi DOM (con aggiunte per IA) ---
    const transactionForm = document.getElementById('transaction-form');
    const kindSelect = document.getElementById('kind');
    const categorySelect = document.getElementById('category_id');
    const subcategorySelect = document.getElementById('subcategory_id');
    const transactionIdInput = document.getElementById('transaction-id');
    const formTitle = document.getElementById('form-title');
    const logoutBtn = document.getElementById('logout-btn');
    const incomeList = document.getElementById('income-list');
    const expenseList = document.getElementById('expense-list');
    const incomeSummary = document.getElementById('income-summary');
    const expenseSummary = document.getElementById('expense-summary');
    const monthSelector = document.getElementById('month-selector'); // Aggiunto per un accesso più facile
    // IA
    const analyzeExpensesBtn = document.getElementById('analyze-expenses-btn');
    const suggestNoteBtn = document.getElementById('suggest-note-btn');
    const noteInput = document.getElementById('note');
    const noteSuggestionsContainer = document.getElementById('note-suggestions');
    const geminiModal = document.getElementById('gemini-modal');
    const modalBody = document.getElementById('modal-body');
    const modalCloseBtn = document.getElementById('modal-close-btn');

    let user = null;
    let allCategories = [];
    let allSubcategories = [];
    let allTransactions = [];

    // --- Funzione API Gemini (invariata) ---
    async function callGemini(systemPrompt, userPrompt, retries = 3, delay = 1000) { /* ...codice invariato... */ }
    
    // --- Gestione Dati e Rendering (con loadTransactions modificato) ---
    function handleTrialStatus(profile){ /* ...codice invariato... */ }
    function safeToNumber(v){ const n=(typeof v==='number')?v:parseFloat(v);return Number.isFinite(n)?n:0}
    async function loadInitialData(){ /* ...codice invariato... */ }
    function updateCategoryDropdown(){ /* ...codice invariato... */ }
    function updateSubcategories(selectedSubcategoryId=null){ /* ...codice invariato... */ }
    function renderDashboard(transactions){ /* ...codice invariato... */ }
    function renderSummary(items,container,kind){ /* ...codice invariato... */ }
    function renderList(items,container){ /* ...codice invariato... */ }

    // ⚡️ VIBE CHANGE: loadTransactions ora è una macchina del tempo ⚡️
    async function loadTransactions() {
        monthSelector.disabled = true;
        renderDashboard([]); // Svuota subito per dare un feedback visivo

        const selectedMonth = monthSelector.value;

        let query = supabase.from('transactions')
            .select(`*, categories(name, icon), subcategories(name, icon)`)
            .eq('created_by', user.id)
            .order('occurred_at', { ascending: false });
        
        if (selectedMonth) {
            const startDate = new Date(selectedMonth);
            const endDate = new Date(startDate.getFullYear(), startDate.getMonth() + 1, 0, 23, 59, 59);

            query = query
                .gte('occurred_at', startDate.toISOString())
                .lte('occurred_at', endDate.toISOString());
        } else {
            // Fallback nel caso (improbabile) non ci sia un mese selezionato
            query = query.limit(30);
        }
        
        const { data, error } = await query;
        
        monthSelector.disabled = false;

        if (error) {
            console.error("Errore transazioni:", error);
            return;
        }
        allTransactions = data || [];
        renderDashboard(allTransactions);
    }

    function handleEdit(id){ /* ...codice invariato... */ }
    async function handleDelete(id){ /* ...codice invariato... */ }
    async function handleFormSubmit(e){ /* ...codice invariato... */ }
    
    // --- Logica IA (invariata) ---
    function showModal(content){modalBody.innerHTML=content;geminiModal.style.display='flex'}
    function hideModal(){geminiModal.style.display='none'}
    async function handleAnalyzeExpenses(){/* ...codice invariato... */}
    async function handleSuggestNote(){/* ...codice invariato... */}

    // --- Inizializzazione pagina (con listener aggiornati) ---
    async function initializePage() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session){ location.replace("/it/login.html"); return; }
      user = session.user;
      
      const { data: profile } = await supabase.from('profiles').select('onboarded, plan_type, trial_end').eq('id', user.id).single();
      handleTrialStatus(profile);
      if (profile && !profile.onboarded && new URLSearchParams(location.search).get('edit')!=='1'){location.replace("/it/onboarding.html");return;}

      // Popola il selettore del mese
      for (let i = 0; i < 12; i++){
        const d = new Date(); d.setMonth(d.getMonth()-i);
        const value = d.toISOString().slice(0,7) + '-01';
        const label = d.toLocaleDateString('it-IT',{month:'long', year:'numeric'});
        monthSelector.add(new Option(label, value));
      }

      document.getElementById('occurred_at').valueAsDate=new Date();
      await loadInitialData();
      updateCategoryDropdown();
      await loadTransactions(); // Carica i dati per il mese corrente (default)

      // Listener originali
      kindSelect.addEventListener('change', updateCategoryDropdown);
      categorySelect.addEventListener('change', () => updateSubcategories());
      transactionForm.addEventListener('submit', handleFormSubmit);
      logoutBtn.addEventListener('click', async(e)=>{e.preventDefault();await supabase.auth.signOut();location.replace("/it/")});
      document.querySelector('.dashboard-grid').addEventListener('click',(ev)=>{const t=ev.target.closest('.action-btn');if(!t)return;const id=t.dataset.id;if(t.classList.contains('edit-btn'))handleEdit(id);else if(t.classList.contains('delete-btn'))handleDelete(id)});
      
      // ✨ Nuovi Listener ✨
      monthSelector.addEventListener('change', loadTransactions); // Il selettore ora controlla i dati
      analyzeExpensesBtn.addEventListener('click', handleAnalyzeExpenses);
      suggestNoteBtn.addEventListener('click', handleSuggestNote);
      modalCloseBtn.addEventListener('click', hideModal);
      geminiModal.addEventListener('click', (e) => {if (e.target === geminiModal) hideModal()});
    }

    document.addEventListener('DOMContentLoaded', initializePage);

    // --- Funzioni Copiate (per mantenere l'integrità del blocco) ---
    async function callGemini(systemPrompt, userPrompt, retries = 3, delay = 1000) { const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`; const payload = { contents: [{ parts: [{ text: userPrompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] }, }; try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) { if (response.status === 429 && retries > 0) { await new Promise(res => setTimeout(res, delay)); return callGemini(systemPrompt, userPrompt, retries - 1, delay * 2); } throw new Error(`API Error: ${response.statusText}`); } const result = await response.json(); const candidate = result.candidates?.[0]; if (candidate && candidate.content?.parts?.[0]?.text) { return candidate.content.parts[0].text; } else { console.warn("Struttura risposta inattesa:", result); throw new Error("Risposta non valida dall'API Gemini."); } } catch (error) { console.error("Errore chiamata Gemini:", error); throw error; } }
    function handleTrialStatus(profile){const banner=document.getElementById('trial-banner');const text=document.getElementById('trial-days-left');if(!profile||profile.plan_type!=='trial'||!profile.trial_end){banner.style.display='none';return}const trialEnd=new Date(profile.trial_end);const today=new Date();today.setHours(0,0,0,0);const diffDays=Math.ceil((trialEnd.getTime()-today.getTime())/864e5);if(diffDays>=0){banner.style.display='flex';text.textContent=diffDays===0?"Ultimo giorno di prova!":diffDays===1?"Manca 1 giorno alla fine della prova.":`Mancano ${diffDays} giorni alla fine della prova.`}else{alert("La tua prova è terminata. Scegli un piano per continuare.");location.replace("/it/paywall.html")}}
    async function loadInitialData(){const{data:categories,error:cError}=await supabase.from('categories').select('*').eq('created_by',user.id);if(cError){console.error("Errore categorie:",cError);return}allCategories=categories||[];if(allCategories.length){const ids=allCategories.map(c=>c.id);const{data:subcategories,error:sError}=await supabase.from('subcategories').select('*').in('category_id',ids);if(sError){console.error("Errore sottocategorie:",sError);return}allSubcategories=subcategories||[]}}
    function updateCategoryDropdown(){const selectedKind=kindSelect.value;const filtered=allCategories.filter(cat=>cat.kind===selectedKind);categorySelect.innerHTML='<option value="">Scegli categoria...</option>';filtered.forEach(cat=>categorySelect.add(new Option(`${cat.icon} ${cat.name}`,cat.id)));updateSubcategories()}
    function updateSubcategories(selectedSubcategoryId=null){const categoryId=categorySelect.value;subcategorySelect.innerHTML='<option value="">Nessuna</option>';subcategorySelect.disabled=true;if(!categoryId)return;const relevant=allSubcategories.filter(sub=>String(sub.category_id)===String(categoryId));if(relevant.length){subcategorySelect.disabled=false;relevant.forEach(sub=>subcategorySelect.add(new Option(`${sub.icon} ${sub.name}`,sub.id)));if(selectedSubcategoryId)subcategorySelect.value=selectedSubcategoryId}}
    function renderDashboard(transactions){const incomes=transactions.filter(tx=>tx.kind==='income');const expenses=transactions.filter(tx=>tx.kind==='expense');renderSummary(incomes,incomeSummary,'income');renderList(incomes,incomeList);renderSummary(expenses,expenseSummary,'expense');renderList(expenses,expenseList)}
    function renderSummary(items,container,kind){container.innerHTML='';if(!items.length){container.style.display='none';return}container.style.display='block';const summary=items.reduce((acc,tx)=>{const catId=tx.category_id;const cat=tx.categories;if(!cat)return acc;if(!acc[catId]){acc[catId]={name:cat.name,icon:cat.icon||'💰',total:0}}acc[catId].total+=safeToNumber(tx.amount);return acc},{});const totalAmount=items.reduce((sum,tx)=>sum+safeToNumber(tx.amount),0);const summaryTitle=kind==='income'?'Riepilogo Entrate':'Riepilogo Uscite';let tagsHTML=Object.values(summary).sort((a,b)=>b.total-a.total).map(cat=>`<div class="category-tag"><span class="icon">${cat.icon}</span><span class="name">${cat.name}</span><span class="total">${cat.total.toFixed(2)}€</span></div>`).join('');container.innerHTML=`<h3>${summaryTitle} (Totale: ${totalAmount.toFixed(2)}€)</h3><div class="category-summary">${tagsHTML}</div>`}
    function renderList(items,container){container.innerHTML='';if(!items.length){container.innerHTML=`<div class="empty-state"><p>Nessun movimento qui.</p></div>`;return}items.forEach(tx=>{const item=document.createElement('div');item.className='item';const cat=tx.categories;const sub=tx.subcategories;const icon=sub?.icon||cat?.icon||'💸';const categoryText=`${cat?.name||'N/A'}${(sub?` / ${sub.name}`:'')}`;const amountNum=safeToNumber(tx.amount);item.innerHTML=`<div class="item-icon">${icon}</div><div class="item-details"><span class="note">${tx.note??''}</span><span class="category">${categoryText}</span></div><div class="item-amount ${tx.kind}">${tx.kind==='expense'?'-':''}${amountNum.toFixed(2)} €</div><div class="item-actions"><button class="action-btn edit-btn" data-id="${tx.id}">Modifica</button><button class="action-btn delete-btn delete" data-id="${tx.id}">Elimina</button></div>`;container.appendChild(item)})}
    function handleEdit(id){const tx=allTransactions.find(t=>String(t.id)===String(id));if(!tx)return;formTitle.textContent="Modifica Transazione";transactionIdInput.value=tx.id;document.getElementById('kind').value=tx.kind;document.getElementById('note').value=tx.note??'';document.getElementById('amount').value=safeToNumber(tx.amount);document.getElementById('occurred_at').value=(tx.occurred_at||'').split('T')[0]||'';updateCategoryDropdown();categorySelect.value=tx.category_id??'';updateSubcategories(tx.subcategory_id??null);window.scrollTo({top:0,behavior:'smooth'})}
    async function handleDelete(id){if(!confirm("Eliminare questa transazione?"))return;const{error}=await supabase.from('transactions').delete().eq('id',id);if(error){console.error("Errore eliminazione:",error);alert("Impossibile eliminare.")}else{loadTransactions()}}
    async function handleFormSubmit(e){e.preventDefault();const formData=new FormData(transactionForm);const id=formData.get('transaction-id');const payload={kind:formData.get('kind'),note:formData.get('note'),amount:formData.get('amount'),occurred_at:formData.get('occurred_at'),category_id:formData.get('category_id'),subcategory_id:formData.get('subcategory_id')||null,created_by:user.id};const{error}=id?await supabase.from('transactions').update(payload).eq('id',id):await supabase.from('transactions').insert(payload);if(error){console.error("Errore salvataggio:",error);alert("Errore. Riprova.")}else{transactionForm.reset();formTitle.textContent="Nuova Transazione";transactionIdInput.value="";document.getElementById('occurred_at').valueAsDate=new Date();updateCategoryDropdown();loadTransactions()}}
    async function handleAnalyzeExpenses(){this.disabled=!0;this.textContent='Analizzo...';showModal('<div class="loader"></div>');const e=allTransactions.filter(t=>t.kind==="expense");if(e.length<3){showModal("<h3>Ops!</h3><p>Aggiungi almeno 3 uscite per ricevere un'analisi utile.</p>");this.disabled=!1;this.innerHTML="✨ Analizza Spese";return}const t=e.map(e=>{const t=e.categories?.name||"N/D";return`- ${e.amount.toFixed(2)}€ in ${t}: ${e.note}`}).join("\n"),s=`Sei un amichevole e incoraggiante consulente finanziario per un'app di budgeting chiamata MyHomesBudget. Analizza le spese dell'utente e offri 3 consigli pratici, brevi e personalizzati. Non dare consigli generici come "spendi meno". Sii specifico e positivo. Rispondi in italiano e usa markdown per la formattazione (es. grassetto per i punti chiave, liste puntate).`,a=`Ciao! Ecco la lista delle mie recenti uscite:\n\n${t}\n\nPotresti darmi qualche consiglio per migliorare la gestione delle mie finanze? Grazie!`;try{const e=await callGemini(s,a),t=e.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\n/g,"<br>");showModal(`<h3>✨ I Tuoi Consigli Personalizzati ✨</h3>${t}`)}catch(e){showModal("<h3>Si è verificato un errore</h3><p>Non è stato possibile ottenere l'analisi. Riprova più tardi.</p>")}finally{this.disabled=!1;this.innerHTML="✨ Analizza Spese"}}
    async function handleSuggestNote(){const e=categorySelect.value;if(!e)return;this.disabled=!0;noteSuggestionsContainer.innerHTML="";const t=allCategories.find(t=>String(t.id)===e);if(!t){this.disabled=!1;return}const s=`Sei un assistente per un'app di budgeting. Il tuo compito è suggerire delle note comuni per una transazione, data una categoria. Rispondi SOLO con una lista di 3-4 suggerimenti separati da virgola, senza altre frasi o spiegazioni. Esempio: Benzina,Biglietto treno,Parcheggio`,a=`La categoria è: ${t.name}`;try{const e=(await callGemini(s,a)).split(",").map(e=>e.trim());e.forEach(e=>{const t=document.createElement("div");t.className="suggestion-tag",t.textContent=e,t.onclick=()=>{noteInput.value=e,noteSuggestionsContainer.innerHTML=""},noteSuggestionsContainer.appendChild(t)})}catch(e){console.error("Errore suggerimento nota:",e)}finally{this.disabled=!1}}

  </script>
</body>
</html>
