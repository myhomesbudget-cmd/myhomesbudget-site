<!doctype html>
<html lang="it" data-app="myhomesbudget">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <title>Dashboard â€” MyHomesBudget</title>
Â  <meta name="robots" content="noindex, nofollow" />
Â  <link rel="icon" href="/homes.png" type="image/png" sizes="32x32">

Â  <style>
Â  Â  :root{
Â  Â  Â  --fg:#111;--bg:#f4f7fa;--glass:rgba(255,255,255,.6);
Â  Â  Â  --card-border:rgba(0,0,0,.08);--shadow:0 10px 30px rgba(0,0,0,.08);
Â  Â  Â  --radius-lg:16px;--primary-color:#6c5ce7;--danger-color:#d32f2f;--success-color:#2e7d32;
Â  Â  Â  --warning-color:#f39c12;
Â  Â  Â  --font-sans:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif;
Â  Â  Â  --grad:linear-gradient(135deg,#6c5ce7,#00cec9);
Â  Â  Â  --grad-danger:linear-gradient(135deg,#d32f2f,#ff7675);
Â  Â  }
Â  Â  *{box-sizing:border-box}
Â  Â  html{font-family:var(--font-sans);background-color:var(--bg)}
Â  Â  body{
Â  Â  Â  margin:0;
Â  Â  Â  color:var(--fg);
Â  Â  Â  background: url("/bg.webp") no-repeat center/cover;
Â  Â  Â  background-attachment: scroll;
Â  Â  Â  min-height:100svh;
Â  Â  Â  -webkit-overflow-scrolling:touch;
Â  Â  }
Â  Â  body::before{content:"";position:absolute;inset:0;background:linear-gradient(135deg,rgba(108,92,231,.05),rgba(0,206,201,.05));z-index:-1}

Â  Â  /* DASHBOARD MOBILE ACCORDION - 25/09/2025 */
Â  Â Â 
Â  Â  /* Mobile Accordion Cards */
Â  Â  .dash-card {
Â  Â  Â  border-radius: 12px;
Â  Â  Â  padding: 0;
Â  Â  Â  margin-block: 10px;
Â  Â  Â  overflow: hidden;
Â  Â  Â  border: 1px solid var(--card-border);
Â  Â  Â  background: rgba(255,255,255,0.85);
Â  Â  Â  box-shadow: var(--shadow);
Â  Â  }
Â  Â Â 
Â  Â  .dash-card__header {
Â  Â  Â  min-height: 44px;
Â  Â  Â  padding: 10px 14px;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  gap: 12px;
Â  Â  Â  font-size: 1rem;
Â  Â  Â  font-weight: 600;
Â  Â  Â  cursor: pointer;
Â  Â  Â  background: rgba(255,255,255,0.9);
Â  Â  Â  border-bottom: 1px solid var(--card-border);
Â  Â  Â  list-style: none;
Â  Â  }
Â  Â Â 
Â  Â  .dash-card__header::after {
Â  Â  Â  content: "";
Â  Â  Â  width: 10px;
Â  Â  Â  height: 10px;
Â  Â  Â  border-right: 2px solid currentColor;
Â  Â  Â  border-bottom: 2px solid currentColor;
Â  Â  Â  transform: rotate(-45deg);
Â  Â  Â  transition: transform 0.2s ease;
Â  Â  Â  flex-shrink: 0;
Â  Â  }
Â  Â Â 
Â  Â  .dash-card[open] .dash-card__header::after {
Â  Â  Â  transform: rotate(45deg);
Â  Â  }
Â  Â Â 
Â  Â  .dash-card__title {
Â  Â  Â  flex: 1;
Â  Â  Â  color: var(--fg);
Â  Â  }
Â  Â Â 
Â  Â  .dash-card__actions {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 8px;
Â  Â  Â  align-items: center;
Â  Â  }
Â  Â Â 
Â  Â  .dash-card__content {
Â  Â  Â  padding: 12px 14px;
Â  Â  }
Â  Â Â 
Â  Â  /* Mobile Typography & Layout */
Â  Â  @media (max-width: 480px) {
Â  Â  Â  main.container {
Â  Â  Â  Â  padding-left: 12px;
Â  Â  Â  Â  padding-right: 12px;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .dash-card {
Â  Â  Â  Â  margin-block: 12px;
Â  Â  Â  Â  order: 0;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .dash-card__content {
Â  Â  Â  Â  gap: 10px;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  /* Typography */
Â  Â  Â  h1 {Â 
Â  Â  Â  Â  font-size: clamp(1.2rem, 5.6vw, 1.6rem);
Â  Â  Â  Â  margin: 8px 0;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  h2 {Â 
Â  Â  Â  Â  font-size: clamp(1.05rem, 4.5vw, 1.3rem);
Â  Â  Â  Â  margin: 6px 0;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  /* Form Optimization */
Â  Â  Â  .transaction-form {
Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  Â  gap: 10px;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .form-group input,
Â  Â  Â  .form-group select,
Â  Â  Â  .form-group textarea {
Â  Â  Â  Â  min-height: 44px;
Â  Â  Â  Â  font-size: 16px;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .btn {
Â  Â  Â  Â  min-height: 44px;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  max-width: none;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .advanced-options-fields {
Â  Â  Â  Â  grid-template-columns: 1fr;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  /* Table Responsiveness */
Â  Â  Â  .deadlines-table {
Â  Â  Â  Â  display: block;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  overflow-x: auto;
Â  Â  Â  Â  -webkit-overflow-scrolling: touch;
Â  Â  Â  Â  table-layout: fixed;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .deadlines-table td {
Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  text-overflow: ellipsis;
Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  /* Card Ordering */
Â  Â  Â  main.container {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  #deadlines-section {
Â  Â  Â  Â  order: 1;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .form-section {
Â  Â  Â  Â  order: 2;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  #goals-section {
Â  Â  Â  Â  order: 3;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .dashboard-panel {
Â  Â  Â  Â  order: 4;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .dash-nav {
Â  Â  Â  Â  order: 0;
Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  @media (min-width: 481px) and (max-width: 1024px) {
Â  Â  Â  .dash-card {
Â  Â  Â  Â  margin-block: 14px;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .dash-card__header {
Â  Â  Â  Â  padding: 12px 16px;
Â  Â  Â  Â  font-size: 1.1rem;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .dash-card__content {
Â  Â  Â  Â  padding: 16px;
Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  /* Desktop - Hide accordion behavior */
Â  Â  @media (min-width: 1025px) {
Â  Â  Â  .dash-card {
Â  Â  Â  Â  padding: 24px;
Â  Â  Â  Â  margin-block: 24px;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .dash-card__header {
Â  Â  Â  Â  display: none;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .dash-card__content {
Â  Â  Â  Â  padding: 0;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  .dash-card[open] .dash-card__content,
Â  Â  Â  .dash-card .dash-card__content {
Â  Â  Â  Â  display: block;
Â  Â  Â  }

Â  Â  Â  .deadlines-desktop-title {
Â  Â  Â  Â  Â  display: block !important;
Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  /* ====== IMPROVEMENTS UX DASHBOARD ====== */
Â  Â Â 
Â  Â  /* Deadlines - Enhanced with Edit/Delete buttons */
Â  Â  .deadline-item-enhanced {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  padding: 12px;
Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  background: rgba(255,255,255,0.9);
Â  Â  Â  border-radius: 12px;
Â  Â  Â  border: 1px solid var(--card-border);
Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  animation: slideInUp 0.5s ease;
Â  Â  }
Â  Â Â 
Â  Â  .deadline-item-enhanced:hover {
Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  box-shadow: var(--shadow);
Â  Â  }
Â  Â Â 
Â  Â  .deadline-date-circle {
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  width: 50px;
Â  Â  Â  height: 50px;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  font-weight: bold;
Â  Â  Â  margin-right: 15px;
Â  Â  Â  flex-shrink: 0;
Â  Â  }
Â  Â Â 
Â  Â  .deadline-date-circle.urgent {
Â  Â  Â  background: #fff8e1;
Â  Â  Â  color: var(--warning-color);
Â  Â  Â  border: 2px solid #fdeec9;
Â  Â  }
Â  Â Â 
Â  Â  .deadline-date-circle.overdue {
Â  Â  Â  background: #ffebee;
Â  Â  Â  color: var(--danger-color);
Â  Â  Â  border: 2px solid #ffcdd2;
Â  Â  Â  animation: pulseRed 2s infinite;
Â  Â  }
Â  Â Â 
Â  Â  .deadline-details {
Â  Â  Â  flex: 1;
Â  Â  Â  min-width: 0;
Â  Â  }
Â  Â Â 
Â  Â  .deadline-details h4 {
Â  Â  Â  margin: 0 0 4px 0;
Â  Â  Â  font-weight: 600;
Â  Â  Â  font-size: 1rem;
Â  Â  }
Â  Â Â 
Â  Â  .deadline-details p {
Â  Â  Â  margin: 0;
Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  color: #666;
Â  Â  }
Â  Â Â 
Â  Â  .deadline-amount {
Â  Â  Â  font-size: 1.2rem;
Â  Â  Â  font-weight: bold;
Â  Â  Â  margin: 0 15px;
Â  Â  }
Â  Â Â 
Â  Â  .deadline-amount.expense { color: var(--danger-color); }
Â  Â  .deadline-amount.income { color: var(--success-color); }
Â  Â Â 
Â  Â  .deadline-actions {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 6px;
Â  Â  Â  flex-shrink: 0;
Â  Â  }
Â  Â Â 
Â  Â  .deadline-actions .btn {
Â  Â  Â  padding: 6px 10px;
Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  min-width: auto;
Â  Â  }
Â  Â Â 
Â  Â  .btn-edit {
Â  Â  Â  background: #e3f2fd;
Â  Â  Â  color: #1976d2;
Â  Â  Â  border: 1px solid #bbdefb;
Â  Â  }
Â  Â Â 
Â  Â  .btn-edit:hover {
Â  Â  Â  background: #bbdefb;
Â  Â  Â  transform: translateY(-1px);
Â  Â  }
Â  Â Â 
Â  Â  .btn-delete {
Â  Â  Â  background: #ffebee;
Â  Â  Â  color: var(--danger-color);
Â  Â  Â  border: 1px solid #ffcdd2;
Â  Â  }
Â  Â Â 
Â  Â  .btn-delete:hover {
Â  Â  Â  background: #ffcdd2;
Â  Â  Â  transform: translateY(-1px);
Â  Â  }
Â  Â Â 
Â  Â  /* Form - Enhanced Operation Type Selector */
Â  Â  .operation-type-selector {
Â  Â  Â  background: rgba(248,249,250,0.8);
Â  Â  Â  border-radius: 12px;
Â  Â  Â  padding: 16px;
Â  Â  Â  margin: 16px 0;
Â  Â  Â  border: 1px solid var(--card-border);
Â  Â  }
Â  Â Â 
Â  Â  .operation-type-selector h4 {
Â  Â  Â  margin: 0 0 12px 0;
Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  font-weight: 600;
Â  Â  Â  color: #555;
Â  Â  Â  text-transform: uppercase;
Â  Â  Â  letter-spacing: 0.5px;
Â  Â  }
Â  Â Â 
Â  Â  .operation-type-options {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
Â  Â  Â  gap: 8px;
Â  Â  }
Â  Â Â 
Â  Â  .operation-type-option {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  padding: 10px 12px;
Â  Â  Â  background: #fff;
Â  Â  Â  border: 2px solid #e0e0e0;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: all 0.2s ease;
Â  Â  Â  font-size: 0.9rem;
Â  Â  }
Â  Â Â 
Â  Â  .operation-type-option:hover {
Â  Â  Â  border-color: var(--primary-color);
Â  Â  Â  transform: translateY(-1px);
Â  Â  }
Â  Â Â 
Â  Â  .operation-type-option.selected {
Â  Â  Â  border-color: var(--primary-color);
Â  Â  Â  background: linear-gradient(135deg, rgba(108,92,231,0.1), rgba(0,206,201,0.1));
Â  Â  Â  color: var(--primary-color);
Â  Â  Â  font-weight: 600;
Â  Â  }
Â  Â Â 
Â  Â  .operation-type-option input[type="radio"] {
Â  Â  Â  margin-right: 8px;
Â  Â  }
Â  Â Â 
Â  Â  /* Goals - Compressed with selectors */
Â  Â  .goal-card-compressed {
Â  Â  Â  background: rgba(255,255,255,0.9);
Â  Â  Â  border-radius: 12px;
Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  overflow: hidden;
Â  Â  Â  border: 1px solid var(--card-border);
Â  Â  Â  transition: all 0.3s ease;
Â  Â  }
Â  Â Â 
Â  Â  .goal-card-compressed:hover {
Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  box-shadow: var(--shadow);
Â  Â  }
Â  Â Â 
Â  Â  .goal-card-header-compressed {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  padding: 12px 16px;
Â  Â  Â  background: rgba(108,92,231,0.05);
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: all 0.2s ease;
Â  Â  }
Â  Â Â 
Â  Â  .goal-card-header-compressed:hover {
Â  Â  Â  background: rgba(108,92,231,0.1);
Â  Â  }
Â  Â Â 
Â  Â  .goal-card-header-compressed.expanded {
Â  Â  Â  background: rgba(108,92,231,0.1);
Â  Â  }
Â  Â Â 
Â  Â  .goal-info-compressed {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 12px;
Â  Â  Â  flex: 1;
Â  Â  }
Â  Â Â 
Â  Â  .goal-icon-compressed {
Â  Â  Â  font-size: 1.5rem;
Â  Â  }
Â  Â Â 
Â  Â  .goal-details-compressed h4 {
Â  Â  Â  margin: 0 0 4px 0;
Â  Â  Â  font-size: 1rem;
Â  Â  Â  font-weight: 600;
Â  Â  }
Â  Â Â 
Â  Â  .goal-progress-compressed {
Â  Â  Â  font-size: 0.85rem;
Â  Â  Â  color: #666;
Â  Â  }
Â  Â Â 
Â  Â  .goal-expand-arrow {
Â  Â  Â  transition: transform 0.3s ease;
Â  Â  Â  font-size: 1.2rem;
Â  Â  Â  color: var(--primary-color);
Â  Â  }
Â  Â Â 
Â  Â  .goal-expand-arrow.expanded {
Â  Â  Â  transform: rotate(180deg);
Â  Â  }
Â  Â Â 
Â  Â  .goal-card-content-compressed {
Â  Â  Â  max-height: 0;
Â  Â  Â  overflow: hidden;
Â  Â  Â  transition: max-height 0.3s ease;
Â  Â  }
Â  Â Â 
Â  Â  .goal-card-content-compressed.expanded {
Â  Â  Â  max-height: 500px;
Â  Â  }
Â  Â Â 
Â  Â  .goal-card-content-inner {
Â  Â  Â  padding: 16px;
Â  Â  }
Â  Â Â 
Â  Â  /* Financial Summary - Enhanced animations */
Â  Â  .financial-card-animated {
Â  Â  Â  background: rgba(255,255,255,0.9);
Â  Â  Â  border-radius: 16px;
Â  Â  Â  padding: 20px;
Â  Â  Â  margin-bottom: 16px;
Â  Â  Â  border: 1px solid var(--card-border);
Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  animation: bounceIn 0.8s ease;
Â  Â  }
Â  Â Â 
Â  Â  .financial-card-animated:hover {
Â  Â  Â  transform: translateY(-4px);
Â  Â  Â  box-shadow: var(--shadow);
Â  Â  }
Â  Â Â 
Â  Â  .financial-summary-grid {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
Â  Â  Â  gap: 16px;
Â  Â  Â  margin-bottom: 24px;
Â  Â  }
Â  Â Â 
Â  Â  .summary-stat {
Â  Â  Â  text-align: center;
Â  Â  Â  padding: 16px;
Â  Â  Â  background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(248,249,250,0.9));
Â  Â  Â  border-radius: 12px;
Â  Â  Â  border: 1px solid var(--card-border);
Â  Â  Â  transition: all 0.3s ease;
Â  Â  }
Â  Â Â 
Â  Â  .summary-stat:hover {
Â  Â  Â  transform: scale(1.05);
Â  Â  }
Â  Â Â 
Â  Â  .summary-stat-icon {
Â  Â  Â  font-size: 2rem;
Â  Â  Â  margin-bottom: 8px;
Â  Â  Â  display: block;
Â  Â  }
Â  Â Â 
Â  Â  .summary-stat-value {
Â  Â  Â  font-size: 1.8rem;
Â  Â  Â  font-weight: bold;
Â  Â  Â  margin-bottom: 4px;
Â  Â  Â  transition: all 0.5s ease;
Â  Â  }
Â  Â Â 
Â  Â  .summary-stat-value.income {
Â  Â  Â  color: var(--success-color);
Â  Â  }
Â  Â Â 
Â  Â  .summary-stat-value.expense {
Â  Â  Â  color: var(--danger-color);
Â  Â  }
Â  Â Â 
Â  Â  .summary-stat-label {
Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  color: #666;
Â  Â  Â  text-transform: uppercase;
Â  Â  Â  letter-spacing: 0.5px;
Â  Â  }
Â  Â Â 
Â  Â  /* Animations */
Â  Â  @keyframes slideInUp {
Â  Â  Â  from {
Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  transform: translateY(20px);
Â  Â  Â  }
Â  Â  Â  to {
Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  transform: translateY(0);
Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  @keyframes bounceIn {
Â  Â  Â  0% {
Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  transform: scale(0.3);
Â  Â  Â  }
Â  Â  Â  50% {
Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  transform: scale(1.05);
Â  Â  Â  }
Â  Â  Â  70% {
Â  Â  Â  Â  transform: scale(0.9);
Â  Â  Â  }
Â  Â  Â  100% {
Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  transform: scale(1);
Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  @keyframes pulseRed {
Â  Â  Â  0%, 100% {
Â  Â  Â  Â  box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.4);
Â  Â  Â  }
Â  Â  Â  50% {
Â  Â  Â  Â  box-shadow: 0 0 0 10px rgba(244, 67, 54, 0);
Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  /* Enhanced Progress Bars */
Â  Â  .progress-bar-enhanced {
Â  Â  Â  height: 8px;
Â  Â  Â  background: rgba(0,0,0,0.1);
Â  Â  Â  border-radius: 999px;
Â  Â  Â  overflow: hidden;
Â  Â  Â  margin: 8px 0;
Â  Â  }
Â  Â Â 
Â  Â  .progress-bar-fill {
Â  Â  Â  height: 100%;
Â  Â  Â  border-radius: 999px;
Â  Â  Â  transition: width 1s ease-out;
Â  Â  Â  background: var(--grad);
Â  Â  }
Â  Â Â 
Â  Â  .progress-bar-fill.income {
Â  Â  Â  background: linear-gradient(90deg, var(--success-color), #81c784);
Â  Â  }
Â  Â Â 
Â  Â  .progress-bar-fill.expense {
Â  Â  Â  background: linear-gradient(90deg, var(--danger-color), #ef5350);
Â  Â  }
Â  Â Â 
Â  Â  /* Fix per iOS/Safari su background-attachment: fixed */
Â  Â  @media (pointer: coarse) {
Â  Â  Â  body { background-attachment: scroll !important; }
Â  Â  }

Â  Â  /* ====== TOPBAR ====== */
Â  Â  .topbar{position:fixed;top:0;left:0;right:0;height:60px;padding:0 24px;display:flex;align-items:center;justify-content:space-between;background:var(--glass);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-bottom:1px solid var(--card-border);z-index:100}
Â  Â  .logo-link{display:flex;align-items:center;gap:8px;text-decoration:none}
Â  Â  .logo-text{font-weight:600;color:#fff;font-size:1.1rem;text-shadow:0 1px 2px rgba(0,0,0,.35)}
Â  Â  .top-center{ position: absolute; left: 50%; transform: translateX(-50%); }
Â  Â  .top-actions{display:flex;gap:12px;align-items:center}
Â  Â  .top-link,.top-btn{display:flex;align-items:center;justify-content:center;height:34px;color:#fff;text-decoration:none;padding:6px 12px;border-radius:10px;font-size:.9rem;font-weight:600;background:var(--grad);border:none;box-shadow:0 4px 12px rgba(0,0,0,.15);transition:transform .2s ease,filter .2s ease,box-shadow .2s ease;cursor:pointer; white-space: nowrap;}
Â  Â  .top-link:hover,.top-btn:hover{transform:translateY(-2px);filter:brightness(1.08);box-shadow:0 6px 16px rgba(0,0,0,.20)}

Â  Â  .date-selectors{display:flex;gap:8px}
Â  Â  .select-wrapper{position:relative;display:flex;align-items:center;height:34px;border-radius:10px;background:var(--grad);box-shadow:0 4px 12px rgba(0,0,0,.15);transition:transform .2s ease,filter .2s ease,box-shadow .2s ease}
Â  Â  .select-wrapper:hover{transform:translateY(-2px);filter:brightness(1.08);box-shadow:0 6px 16px rgba(0,0,0,.20)}
Â  Â  .select-wrapper::after{content:'â–¼';font-size:10px;color:rgba(255,255,255,0.8);position:absolute;right:10px;top:50%;transform:translateY(-50%);pointer-events:none}
Â  Â  .topbar-select{appearance:none;background:transparent;color:#fff;border:none;padding:6px 28px 6px 12px;font-size:.9rem;font-weight:600;cursor:pointer}
Â  Â  .topbar-select option{background:#fff;color:#000}
Â  Â  .topbar-select:disabled{opacity:.7}

Â  Â  .notification-bell{position:relative}
Â  Â  #scheduler-btn,#notifications-btn{width:38px;padding:0}
Â  Â  .notification-badge{position:absolute;top:-5px;right:-5px;background:var(--danger-color);color:#fff;border-radius:50%;width:20px;height:20px;font-size:12px;font-weight:bold;display:none;align-items:center;justify-content:center;border:2px solid #fff}
Â  Â  .notification-badge.is-visible{display:flex}

Â  Â  .mobile-menu-toggle{display:none;background:var(--grad);border:none;border-radius:10px;width:40px;height:38px;cursor:pointer;padding:0;z-index:101;box-shadow:0 4px 12px rgba(0,0,0,.15)}
Â  Â  .mobile-menu-toggle svg{width:24px;height:24px;stroke:#fff;stroke-width:2.5;stroke-linecap:round}
Â  Â  .visually-hidden{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border-width:0}

Â  Â  @media (max-width: 1200px) { .top-center { display: none; } }
Â  Â  @media (max-width:960px){
Â  Â  Â  .mobile-menu-toggle{display:block}
Â  Â  Â  .top-actions{position:fixed;top:70px;right:16px;background:rgba(255,255,255,0.9);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border-radius:var(--radius-lg);box-shadow:var(--shadow);padding:16px;flex-direction:column;gap:16px;align-items:stretch;width:220px;transform:translateY(-20px) scale(.95);opacity:0;pointer-events:none;transition:transform .2s ease-out,opacity .2s ease-out;z-index:100;border:1px solid var(--card-border)}
Â  Â  Â  .top-actions.is-open{transform:translateY(0) scale(1);opacity:1;pointer-events:auto}
Â  Â  Â  .top-actions .top-link,.top-actions .top-btn,.top-actions .select-wrapper,.top-actions .date-selectors{width:100%;text-align:center;flex-direction:column}
Â  Â  Â  #scheduler-btn,#notifications-btn{width:100%}
Â  Â  }

Â  Â  /* ====== Contenuto Principale ====== */
Â  Â  main.container{padding:84px 24px 24px;max-width:1280px;margin:0 auto;width:100%}
Â  Â  .dash-nav{display:flex;gap:8px;border-bottom:1px solid rgba(0,0,0,.1);padding-bottom:12px;margin-bottom:24px}
Â  Â  .dash-nav a,.dash-nav button{text-decoration:none;padding:8px 16px;border-radius:10px;font-weight:600;transition:all .2s ease;background:var(--grad);color:#fff;box-shadow:0 4px 12px rgba(0,0,0,.1);border:none;font-family:var(--font-sans);font-size:1rem;cursor:pointer}
Â  Â  .dash-nav a:hover,.dash-nav button:hover{transform:translateY(-2px);filter:brightness(1.08);box-shadow:0 6px 16px rgba(0,0,0,.15)}
Â  Â  .dash-nav a.is-active,.dash-nav button.is-active{filter:brightness(1.15);box-shadow:0 6px 16px rgba(0,0,0,.20),inset 0 1px 2px rgba(255,255,255,0.2)}
Â  Â  .content-section{background:rgba(255,255,255,.85);border-radius:var(--radius-lg);padding:16px;border:1px solid var(--card-border);box-shadow:var(--shadow)}

Â  Â  .dashboard-panel{background:rgba(255,255,255,0.55);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border-radius:var(--radius-lg);padding:24px;border:1px solid var(--card-border);box-shadow:var(--shadow)}
Â  Â  .dashboard-panel .content-section,.dashboard-panel .summary-card{box-shadow:none;border:none}
Â  Â  .dashboard-panel .content-section{background:rgba(255,255,255,0.7)}

Â  Â  /* ====== Layout ====== */
Â  Â  .dashboard-grid{display:grid;grid-template-columns:1fr;gap:24px}
Â  Â  @media(min-width:1024px){.dashboard-grid{grid-template-columns:repeat(2,1fr)}}
Â  Â  .flow-column h2{display:flex;align-items:center;justify-content:space-between;gap:12px;font-size:1.5rem;margin:0 0 16px;padding:0 8px}
Â  Â  .flow-column.income h2{color:var(--success-color)}
Â  Â  .flow-column.expense h2{color:var(--danger-color)}

Â  Â  /* ====== Summary Bars ====== */
Â  Â  .summary-card{background:#fff;padding:16px;border-radius:var(--radius-lg);margin-bottom:16px}
Â  Â  .summary-card h3{display:flex;justify-content:space-between;align-items:center;margin:0 0 12px;font-size:1rem;color:#555}
Â  Â  .summary-total-amount{font-weight:800;font-size:1.2rem}
Â  Â  .income .summary-total-amount{color:var(--success-color)}
Â  Â  .expense .summary-total-amount{color:var(--danger-color)}
Â  Â  .category-summary-bars{display:flex;flex-direction:column;gap:14px;margin-top:16px}
Â  Â  .category-bar-item{display:flex;flex-direction:column;gap:6px}
Â  Â  .category-bar-info{display:flex;justify-content:space-between;align-items:center;font-size:.95rem}
Â  Â  .category-bar-label{display:flex;align-items:center;gap:8px;font-weight:600}
Â  Â  .category-bar-label .icon{font-size:1.1rem}
Â  Â  .category-bar-amount{font-weight:700}
Â  Â  .progress-bar-bg{width:100%;height:10px;background-color:rgba(0,0,0,0.08);border-radius:999px;overflow:hidden}
Â  Â  .progress-bar-fg{height:100%;border-radius:999px;transition:width .5s ease-out}
Â  Â  .income .progress-bar-fg{background:linear-gradient(90deg,#00cec9,#81ecec)}
Â  Â  .expense .progress-bar-fg{background:linear-gradient(90deg,#6c5ce7,#fd79a8)}

Â  Â  /* ====== Form ====== */
Â  Â  .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;font-weight:800;color:#fff;transition:transform .2s ease,filter .2s ease,box-shadow .2s ease}
Â  Â  .btn:hover:not(:disabled){transform:translateY(-2px);filter:brightness(1.08)}
Â  Â  .btn:disabled{opacity:.6;cursor:not-allowed}
Â  Â  .btn-primary{background:var(--grad);box-shadow:0 10px 24px rgba(0,0,0,.18)}
Â  Â  .btn-primary:hover:not(:disabled){box-shadow:0 14px 28px rgba(0,0,0,.22)}
Â  Â  .btn-secondary{background:#f0f0f0;color:#555;border:1px solid #ddd;box-shadow:0 4px 8px rgba(0,0,0,0.05)}
Â  Â  .btn-secondary:hover:not(:disabled){background:#e5e5e5;border-color:#ccc;color:#333}

Â  Â  .transaction-form{display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:flex-end}
Â  Â  .form-group{display:flex;flex-direction:column}
Â  Â  .form-group label{font-weight:600;font-size:.9rem;margin-bottom:6px}
Â  Â  .form-group input,.form-group select{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;background:#fff;font-size:16px}
Â  Â  .form-group.full-width{grid-column:1 / -1}
Â  Â  .form-buttons{grid-column:1 / -1;margin-top:10px}
Â  Â  .form-buttons.is-editing{display:flex;gap:12px}
Â  Â  .form-buttons.is-editing #submit-btn{flex-grow:1}

Â  Â  @media(min-width:1024px){
Â  Â  Â  .transaction-form{grid-template-columns:repeat(6,1fr);gap:16px}
Â  Â  Â  .form-group.kind{grid-column:span 1}
Â  Â  Â  .form-group.note{grid-column:span 3}
Â  Â  Â  .form-group.amount{grid-column:span 2}
Â  Â  Â  .form-group.date{grid-column:span 2}
Â  Â  Â  .form-group.category{grid-column:span 2}
Â  Â  Â  .form-group.subcategory{grid-column:span 2}
Â  Â  }

Â  Â  /* AVANZATE: wrapper sempre visibile */
Â  Â  #advanced-options-wrapper{display:block;grid-column:1 / -1;background:rgba(0,0,0,0.03);padding:12px;border-radius:10px;margin-top:8px}
Â  Â  .advanced-options-controls{display:flex;flex-wrap:wrap;gap:20px;align-items:center;margin-bottom:12px}
Â  Â  .advanced-options-controls label{display:flex;align-items:center;gap:8px;font-weight:600;cursor:pointer}
Â  Â  .advanced-options-fields{display:none;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px}

Â  Â  /* ====== Liste ====== */
Â  Â  .list-title{margin:-16px -16px 16px;padding:12px 16px;font-size:1.1rem;font-weight:700;color:#333;border-bottom:1px solid rgba(0,0,0,0.08);background:rgba(255,255,255,0.4);display:flex;justify-content:space-between;align-items:center}
Â  Â  .list-total-amount{font-weight:800;font-size:1.2rem}
Â  Â  .income .list-total-amount{color:var(--success-color)}
Â  Â  .expense .list-total-amount{color:var(--danger-color)}

Â  Â  .transaction-list .item{display:grid;grid-template-columns:auto 1fr auto auto;gap:12px;align-items:center;padding:12px 4px;border-bottom:1px solid rgba(0,0,0,.05)}
Â  Â  .item:last-child{border-bottom:none}
Â  Â  .item-icon{font-size:1.5rem;flex-shrink:0}
Â  Â  .item-details{display:flex;flex-direction:column;min-width:0}
Â  Â  .item-details .note{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
Â  Â  .item-details .category{font-size:.9rem;color:#555;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
Â  Â  .item-amount{text-align:right;white-space:nowrap;flex-shrink:0}
Â  Â  .item-amount.expense{color:var(--danger-color);font-weight:700}
Â  Â  .item-amount.income{color:var(--success-color);font-weight:700}
Â  Â  .item-actions{display:flex;gap:4px;flex-shrink:0}
Â  Â  .action-btn{background:var(--grad);color:#fff;border:none;border-radius:8px;padding:6px 10px;font-size:.85rem;font-weight:600;cursor:pointer;transition:filter .2s ease,transform .2s ease}
Â  Â  .action-btn:hover{filter:brightness(1.1);transform:translateY(-1px)}
Â  Â  .action-btn.delete{background:var(--grad-danger)}
Â  Â  .empty-state{text-align:center;padding:40px 20px;color:#777;background:rgba(0,0,0,0.02);border-radius:12px}

Â  Â  /* --- NUOVI STILI PER LA LISTA SCADENZE --- */
Â  Â  #deadlines-list .expense-item {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  padding: 12px 4px;
Â  Â  Â  Â  gap: 16px;
Â  Â  Â  Â  border-bottom: 1px solid rgba(0,0,0,.05);
Â  Â  }
Â  Â  Â #deadlines-list .expense-item:last-child {
Â  Â  Â  Â  border-bottom: none;
Â  Â  }

Â  Â  #deadlines-list .expense-details {
Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  min-width: 0; /* Previene problemi di overflow con flexbox */
Â  Â  }
Â  Â Â 
Â  Â  #deadlines-list .expense-details p {
Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  color: #666;
Â  Â  Â  Â  white-space: nowrap;
Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  text-overflow: ellipsis;
Â  Â  }
Â  Â  #deadlines-list .expense-details p:first-child {
Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  color: #333;
Â  Â  }

Â  Â  #deadlines-list .expense-amount {
Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  white-space: nowrap;
Â  Â  }
Â  Â  Â #deadlines-list .expense-amount.expense { color: var(--danger-color); }
Â  Â  Â #deadlines-list .expense-amount.income { color: var(--success-color); }
Â  Â Â 
Â  Â  #deadlines-list .expense-right-section {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  gap: 16px;Â 
Â  Â  Â  Â  text-align: right;
Â  Â  Â  Â  flex-shrink: 0; /* Evita che la sezione si restringa */
Â  Â  }

Â  Â  #deadlines-list .expense-due-date {
Â  Â  Â  Â  background-color: #fff8e1;
Â  Â  Â  Â  color: #f39c12;
Â  Â  Â  Â  padding: 4px 10px;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  border: 1px solid #fdeec9;
Â  Â  Â  Â  white-space: nowrap;Â 
Â  Â  }

Â  Â  #deadlines-list .expense-actual-date {
Â  Â  Â  Â  background-color: #f1f5f9;
Â  Â  Â  Â  color: #334155;
Â  Â  Â  Â  border-radius: 10px;
Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  border: 1px solid #e2e8f0;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  width: 48px;
Â  Â  Â  Â  height: 48px;
Â  Â  Â  Â  flex-shrink: 0;
Â  Â  Â  Â  line-height: 1.1;
Â  Â  }

Â  Â  #deadlines-list .date-day {
Â  Â  Â  Â  font-size: 1rem;
Â  Â  Â  Â  font-weight: 700;
Â  Â  }

Â  Â  #deadlines-list .date-month {
Â  Â  Â  Â  font-size: 0.7rem;
Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  margin-top: 2px;
Â  Â  }
Â  Â  /* --- FINE NUOVI STILI --- */

Â  Â  .btn-action-deadline{padding:8px 12px;font-size:.9rem}
Â  Â  .btn-action-deadline.pay{background:var(--warning-color)}
Â  Â  .btn-action-deadline.receive{background:var(--success-color)}

Â  Â  /* --- NUOVI STILI MODAL EMOZIONANTE --- */
Â  Â  .modal-overlay.is-visible .modal-content-enhanced {
Â  Â  Â  Â  transform: translateY(0) scale(1);
Â  Â  Â  Â  opacity: 1;
Â  Â  }
Â  Â  .modal-content-enhanced {
Â  Â  Â  Â  background: var(--bg);
Â  Â  Â  Â  border-radius: var(--radius-lg);
Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  width: 90%;
Â  Â  Â  Â  max-width: 800px;
Â  Â  Â  Â  max-height: 90vh;
Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  box-shadow: var(--shadow);
Â  Â  Â  Â  transform: translateY(-30px) scale(0.98);
Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  transition: transform .3s cubic-bezier(.22,1,.36,1), opacity .3s ease;
Â  Â  }
Â  Â  .modal-header-enhanced {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  padding: 16px 24px;
Â  Â  Â  Â  background: var(--grad);
Â  Â  Â  Â  color: #fff;
Â  Â  Â  Â  text-shadow: 0 1px 2px rgba(0,0,0,0.2);
Â  Â  Â  Â  flex-shrink: 0;
Â  Â  }
Â  Â  .modal-title-enhanced {
Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  font-size: 1.3rem;
Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  gap: 12px;
Â  Â  }
Â  Â  .modal-body-enhanced {
Â  Â  Â  Â  padding: 8px 24px 24px;
Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  flex-grow: 1;
Â  Â  }

Â  Â  .deadline-item-modal {
Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  grid-template-columns: auto 1fr auto;
Â  Â  Â  Â  grid-template-areas: "date details right" "actions actions actions";
Â  Â  Â  Â  gap: 12px 16px;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  background: rgba(255,255,255,0.7);
Â  Â  Â  Â  padding: 16px;
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  border: 1px solid var(--card-border);
Â  Â  Â  Â  margin-top: 12px;
Â  Â  Â  Â  transition: transform .2s ease, box-shadow .2s ease;
Â  Â  }
Â  Â  .deadline-item-modal:hover {
Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  Â  box-shadow: 0 8px 20px rgba(0,0,0,0.08);
Â  Â  }
Â  Â  .deadline-item-modal .date-box { grid-area: date; background-color: #f1f5f9; color: #334155; border-radius: 10px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 52px; height: 52px; font-weight: 700; line-height: 1.1; }
Â  Â  .deadline-item-modal .date-box .day { font-size: 1.1rem; }
Â  Â  .deadline-item-modal .date-box .month { font-size: 0.75rem; text-transform: uppercase; }
Â  Â  .deadline-item-modal .details { grid-area: details; min-width: 0; }
Â  Â  .deadline-item-modal .details .note { font-weight: 600; font-size: 1rem; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
Â  Â  .deadline-item-modal .details .category { font-size: 0.85rem; color: #555; }
Â  Â  .deadline-item-modal .right-section { grid-area: right; text-align: right; }
Â  Â  .deadline-item-modal .amount { font-size: 1.1rem; font-weight: 800; display: block; margin-bottom: 4px; }
Â  Â  .deadline-item-modal .amount.expense { color: var(--danger-color); }
Â  Â  .deadline-item-modal .amount.income { color: var(--success-color); }
Â  Â  .deadline-item-modal .days-left-badge { display: inline-block; font-size: 0.8rem; font-weight: 700; padding: 4px 10px; border-radius: 999px; color: #fff; }
Â  Â  .deadline-item-modal .days-left-badge.due-soon { background-color: var(--danger-color); }
Â  Â  .deadline-item-modal .days-left-badge.far-off { background-color: var(--warning-color); }
Â  Â  .deadline-item-modal .days-left-badge.very-far { background-color: var(--success-color); }
Â  Â  .deadline-item-modal .actions { grid-area: actions; display: flex; gap: 12px; justify-content: flex-end; padding-top: 12px; margin-top: 12px; border-top: 1px solid rgba(0,0,0,0.08); }


Â  Â  /* ====== Modal base (MODIFICATO PER ESSERE PIÃ™ AMPIO) ====== */
Â  Â  .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:1000;opacity:0;pointer-events:none;transition:opacity .3s ease}
Â  Â  .modal-overlay.is-visible{display:flex;opacity:1;pointer-events:auto}
Â  Â  .modal-content{background:var(--bg);border-radius:var(--radius-lg);padding:24px;width:90%;max-width:800px;max-height:80vh;overflow-y:auto;box-shadow:var(--shadow);transform:scale(.95);transition:transform .3s ease}
Â  Â  .modal-overlay.is-visible .modal-content{transform:scale(1)}
Â  Â  .modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--card-border);padding-bottom:12px;margin-bottom:16px}
Â  Â  .modal-title{margin:0;font-size:1.3rem}
Â  Â  .modal-close{background:none;border:none;font-size:2rem;cursor:pointer;color:#888;line-height:1;padding:0}
Â  Â  .modal-body ul{list-style:none;padding:0;margin:0}
Â  Â  .modal-body li{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--card-border)}
Â  Â  .modal-body li:last-child{border-bottom:none}
Â  Â  .modal-footer{margin-top:20px;display:flex;justify-content:flex-end;gap:12px}
Â  Â  .modal-footer .btn.delete{background:var(--grad-danger);box-shadow:0 8px 20px rgba(211,47,47,.25)}
Â  Â  .modal-footer .btn.delete:hover{box-shadow:0 12px 24px rgba(211,47,47,.3)}
Â  Â  .modal-footer .btn-secondary{background:#f0f0f0;color:#555;border:1px solid #ddd;box-shadow:0 4px 8px rgba(0,0,0,0.05)}
Â  Â  .modal-footer .btn-secondary:hover{background:#e5e5e5;border-color:#ccc;color:#333}

Â  Â  /* ====== Modal Lista Movimenti ====== */
Â  Â  .modal-content-large{max-width:90vw;width:1000px}
Â  Â  .movements-table-container{max-height:60vh;overflow-y:auto}
Â  Â  .movements-table{width:100%;border-collapse:collapse}
Â  Â  .movements-table th,.movements-table td{padding:10px 12px;text-align:left;border-bottom:1px solid var(--card-border);white-space:nowrap}
Â  Â  .movements-table th{font-weight:700;background-color:rgba(0,0,0,0.05);font-size:.9rem;position:sticky;top:0}
Â  Â  .movements-table td{font-size:.95rem}
Â  Â  .movements-table .amount-col{text-align:right;font-weight:700}
Â  Â  .movements-table .income .amount-col{color:var(--success-color)}
Â  Â  .movements-table .expense .amount-col{color:var(--danger-color)}
Â  Â  .movements-summary{margin-top:20px;padding-top:16px;border-top:2px solid var(--card-border);display:flex;justify-content:space-around;font-weight:700}
Â  Â  .summary-item{text-align:center}
Â  Â  .summary-label{font-size:.9rem;color:#555}
Â  Â  .summary-value{font-size:1.2rem}
Â  Â  .summary-value.total-income{color:var(--success-color)}
Â  Â  .summary-value.total-expense{color:var(--danger-color)}
Â  Â  .summary-value.balance{color:var(--fg)}

Â  Â  /* ====== Modal Animazione ====== */
Â  Â  .animation-modal-overlay{position:fixed;inset:0;background:rgba(10,25,47,.85);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:2000;opacity:0;pointer-events:none;transition:opacity .3s ease;overflow:hidden}
Â  Â  .animation-modal-overlay.is-visible{display:flex;opacity:1;pointer-events:auto}
Â  Â  .animation-container{position:relative;width:300px;height:300px;display:flex;align-items:center;justify-content:center}
Â  Â  .animation-bg-image{width:100%;height:100%;object-fit:contain;filter:drop-shadow(0 0 20px rgba(0,0,0,0.4))}
Â  Â  .animation-elements-container{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
Â  Â  .money-element.income{top:-60px;left:50%;transform:translateX(-50%);opacity:0;animation:drop-money-fall 1.8s ease-in forwards}
Â  Â  @keyframes drop-money-fall{0%{transform:translateY(-100px) translateX(-50%) rotate(-20deg);opacity:0}25%{opacity:1}100%{transform:translateY(120px) translateX(-50%) rotate(20deg);opacity:0}}
Â  Â  .money-element.expense{top:50%;left:50%;transform:translate(-50%,-50%);opacity:1;animation:dematerialize-money 2s forwards}
Â  Â  @keyframes dematerialize-money{0%{transform:translate(-50%,-50%) scale(1);opacity:1}100%{transform:translate(-50%,-200%) scale(.3);opacity:0;filter:blur(10px)}}

Â  Â  /* Messaggi stato */
Â  Â  .status-message{padding:12px 16px;border-radius:10px;margin-top:16px;text-align:center;font-weight:600;opacity:0;transition:opacity .3s ease;grid-column:1 / -1}
Â  Â  .status-message.is-visible{opacity:1}
Â  Â  .status-message.success{background-color:var(--success-color);color:#fff}
Â  Â  .status-message.error{background-color:var(--danger-color);color:#fff}
Â  Â Â 
Â  Â  /* ====== GOALS (Layout v2 da Screenshot) ====== */
Â  Â  #goals-section.goals-v2 .header {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  margin-bottom: 8px;
Â  Â  }
Â  Â  #goals-section.goals-v2 .header h3 {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  font-size: 1.2rem;
Â  Â  }
Â  Â  #goals-section.goals-v2 .goal-card {
Â  Â  Â  Â  background: rgba(255,255,255,0.8);
Â  Â  Â  Â  border: 1px solid var(--card-border);
Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  padding: 16px;
Â  Â  Â  Â  box-shadow: 0 4px 15px rgba(0,0,0,0.07);
Â  Â  Â  Â  margin-bottom: 24px;
Â  Â  }
Â  Â  #goals-section.goals-v2 .goal-card-header {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  margin-bottom: 12px;
Â  Â  }
Â  Â  #goals-section.goals-v2 .goal-card-header h4 {
Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  font-size: 1.2rem;
Â  Â  Â  Â  font-weight: 800;
Â  Â  Â  Â  color: #333;
Â  Â  }
Â  Â  #goals-section.goals-v2 .goal-editor {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: repeat(12, 1fr);
Â  Â  Â  gap: 24px;
Â  Â  Â  align-items: flex-end;
Â  Â  }
Â  Â  #goals-section.goals-v2 .editor-group { grid-column: span 12; }
Â  Â  @media (min-width: 992px) {
Â  Â  Â  #goals-section.goals-v2 .editor-group.method-selector { grid-column: span 7; }
Â  Â  Â  #goals-section.goals-v2 .editor-group.quota-editorÂ  Â { grid-column: span 5; }
Â  Â  }

Â  Â  #goals-section.goals-v2 h5 {
Â  Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  color: #555;
Â  Â  Â  Â  margin: 0 0 10px;
Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  letter-spacing: 0.5px;
Â  Â  }
Â  Â  #goals-section.goals-v2 .method-chips {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  gap: 10px;
Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  }
Â  Â  #goals-section.goals-v2 .method-btn-wrapper {
Â  Â  Â  Â  flex: 1;
Â  Â  Â  Â  min-width: 120px;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  position: relative;
Â  Â  }
Â  Â  #goals-section.goals-v2 .chip.method-btn {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  padding: 10px 12px;
Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  border: 1px solid rgba(0,0,0,0.1);
Â  Â  Â  Â  background: #f0f2f5;
Â  Â  }
Â  Â  #goals-section.goals-v2 .chip.method-btn.is-active {
Â  Â  Â  Â  background: var(--grad);
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
Â  Â  Â  Â  border-color: transparent;
Â  Â  }
Â  Â  #goals-section.goals-v2 .method-input {
Â  Â  Â  Â  margin-top: 8px;
Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  display: none;
Â  Â  }
Â  Â  #goals-section.goals-v2 .chip.method-btn.is-active + .method-input {
Â  Â  Â  Â  display: block;
Â  Â  }
Â  Â  #goals-section.goals-v2 .method-input input {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  padding: 8px 12px;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  background: #fff;
Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  font-size: 16px; /* iOS zoom fix */
Â  Â  }
Â  Â  #goals-section.goals-v2 .method-input .arrow-down {
Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  bottom: 100%;
Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  Â  width: 0;
Â  Â  Â  Â  height: 0;
Â  Â  Â  Â  border-left: 8px solid transparent;
Â  Â  Â  Â  border-right: 8px solid transparent;
Â  Â  Â  Â  border-top: 8px solid #ccc;
Â  Â  }

Â  Â  #goals-section.goals-v2 .quota-display {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  gap: 8px;
Â  Â  Â  Â  align-items: center;
Â  Â  }
Â  Â  #goals-section.goals-v2 .quota-value {
Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  padding: 11px 12px;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  background: #fff;
Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  font-size: 1.1rem;
Â  Â  Â  Â  text-align: right;
Â  Â  Â  Â  color: #333;
Â  Â  }
Â  Â  #goals-section.goals-v2 .quota-actions .btn {
Â  Â  Â  Â  padding: 8px 12px;
Â  Â  Â  Â  font-size: 0.85rem;
Â  Â  }
Â  Â  #goals-section.goals-v2 .goal-card.is-locked .quota-actions .save-btn { display: none; }
Â  Â  #goals-section.goals-v2 .goal-card:not(.is-locked) .quota-actions .edit-btn { display: none; }

Â  Â  #goals-section.goals-v2 .goal-card-footer {
Â  Â  Â  Â  margin-top: 16px;
Â  Â  Â  Â  padding-top: 16px;
Â  Â  Â  Â  border-top: 1px solid var(--card-border);
Â  Â  }
Â  Â  #goals-section.goals-v2 .goal-progress-bar-container {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  gap: 8px;
Â  Â  }
Â  Â  #goals-section.goals-v2 .progress-info {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  font-weight: 600;
Â  Â  }
Â  Â  #goals-section.goals-v2 .goal-main-actions {
Â  Â  Â  Â  margin-top: 16px;
Â  Â  Â  Â  padding-top: 16px;
Â  Â  Â  Â  border-top: 1px solid var(--card-border);
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  justify-content: flex-end;
Â  Â  Â  Â  gap: 12px;
Â  Â  }
Â  Â  #goals-section.goals-v2 .goal-card.is-locked .chip:not(.is-active) {
Â  Â  Â  Â  pointer-events: none;
Â  Â  Â  Â  opacity: 0.7;
Â  Â  }
Â  Â  Â #goals-section.goals-v2 .goal-card.is-locked input {
Â  Â  Â  Â  pointer-events: none;
Â  Â  Â  Â  background-color: #f0f2f5 !important;
Â  Â  Â  Â  color: #999;
Â  Â  Â  Â  border-color: #e0e0e0;
Â  Â  }
Â  </style>
</head>
<body>
Â  <div id="boot-loader" style="
Â  Â  position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
Â  Â  background: rgba(244,247,250,.9); z-index: 2000; flex-direction: column; gap: 12px;">
Â  Â  <div class="spinner" style="
Â  Â  Â  width: 36px; height: 36px; border: 3px solid rgba(0,0,0,.15);
Â  Â  Â  border-top-color: #6c5ce7; border-radius: 50%;
Â  Â  Â  animation: spin 1s linear infinite;"></div>
Â  Â  <div id="boot-loader-text" style="font-weight:700;color:#333;">Caricamentoâ€¦</div>
Â  Â  <button id="boot-retry-btn" class="btn btn-primary" style="display:none;">Riprova</button>
Â  </div>
Â  <!-- Topbar -->
Â  <nav class="topbar">
Â  Â  <a href="/it/" class="logo-link">
Â  Â  Â  <img src="/homes.png" alt="Logo" style="height:32px;border-radius:6px">
Â  Â  Â  <span class="logo-text">MyHomesBudget</span>
Â  Â  </a>
Â  Â  <div class="top-center">
Â  Â  Â  Â  <a href="/it/pricing.html" id="subscription-status-btn" class="top-link" style="display: none;"></a>
Â  Â  </div>
Â  Â  <div class="top-nav-right">
Â  Â  Â  <button id="mobile-menu-btn" class="mobile-menu-toggle" aria-label="Apri menu">
Â  Â  Â  Â  <svg viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
Â  Â  Â  Â  <span class="visually-hidden">Menu</span>
Â  Â  Â  </button>
Â  Â  Â  <div class="top-actions">
Â  Â  Â  Â  <div class="date-selectors">
Â  Â  Â  Â  Â  <div class="select-wrapper"><select id="month-selector" class="topbar-select"></select></div>
Â  Â  Â  Â  Â  <div class="select-wrapper"><select id="year-selector" class="topbar-select"></select></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <a href="/it/onboarding.html?edit=1" class="top-link">ğŸ¯ Obiettivo</a>
Â  Â  Â  Â  <button id="scheduler-btn" class="top-btn" aria-label="Apri scadenziario">ğŸ—“ï¸</button>
Â  Â  Â  Â  <button id="notifications-btn" class="top-btn notification-bell" aria-label="Apri notifiche">
Â  Â  Â  Â  Â  <span>ğŸ””</span>
Â  Â  Â  Â  Â  <span id="notification-badge" class="notification-badge"></span>
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <a href="#" id="logout-btn" class="top-link">Esci</a>
Â  Â  Â  </div>
Â  Â  </div>
Â  </nav>

Â  <main class="container">
Â  Â  <nav id="dash-nav" class="dash-nav">
Â  Â  Â  <a href="/it/profile.html">Profilo</a>
Â  Â  Â  <a href="/it/dashboard.html" class="is-active" aria-current="page">Operazioni</a>
Â  Â  Â  <a href="/it/dashboard-riepilogo.html">Riepilogo</a>
Â  Â  Â  <button id="list-movements-btn">Lista Movimenti</button>
Â  Â  </nav>

Â  Â  <!-- Scadenze -->
Â  Â  <details id="deadlines-section" class="dash-card content-section" style="margin-top:12px;display:none;" open>
Â  Â  Â  <summary class="dash-card__header" style="background: linear-gradient(135deg, rgba(243, 156, 18, 0.1), rgba(241, 196, 15, 0.05)); color: var(--warning-color);">
Â  Â  Â  Â  <span class="dash-card__title">ğŸ”” Scadenze & Voci Future (Prossimi 30 giorni)</span>
Â  Â  Â  Â  <div class="dash-card__actions">
Â  Â  Â  Â  Â  <span id="deadlines-count" class="badge" style="background: var(--warning-color); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem;">0</span>
Â  Â  Â  Â  </div>
Â  Â  Â  </summary>
Â  Â  Â  <div class="dash-card__content">
Â  Â  Â  Â  <h2 style="font-size: 1.5rem; margin: 0 0 16px; display:none;" class="deadlines-desktop-title">ğŸ”” Scadenze & Voci Future</h2>
Â  Â  Â  Â  <div id="deadlines-list" class="transaction-list"></div>
Â  Â  Â  </div>
Â  Â  </details>

Â  Â  <!-- Sezione Form -->
Â  Â  <details class="dash-card content-section form-section" open>
Â  Â  Â  <summary class="dash-card__header" style="background: linear-gradient(135deg, rgba(108, 92, 231, 0.1), rgba(0, 206, 201, 0.05)); color: var(--primary-color);">
Â  Â  Â  Â  <span class="dash-card__title">â• Nuova Operazione</span>
Â  Â  Â  </summary>
Â  Â  Â  <div class="dash-card__content">
Â  Â  Â  Â  <h2 id="form-title" style="margin:0 0 16px;">Nuova Operazione</h2>
Â  Â  Â  <form id="transaction-form" class="transaction-form">
Â  Â  Â  Â  <input type="hidden" id="transaction-id" name="transaction-id">
Â  Â  Â  Â  <div class="form-group kind">
Â  Â  Â  Â  Â  <label for="kind">Tipo</label>
Â  Â  Â  Â  Â  <select id="kind" name="kind" required>
Â  Â  Â  Â  Â  Â  <option value="expense">ğŸ’¸ Uscita</option>
Â  Â  Â  Â  Â  Â  <option value="income">ğŸ’° Entrata</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="form-group note">
Â  Â  Â  Â  Â  <label for="note">Descrizione</label>
Â  Â  Â  Â  Â  <input type="text" id="note" name="note" placeholder="Es. Stipendio, Rata Mutuo..." required>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="form-group amount">
Â  Â  Â  Â  Â  <label for="amount">Importo (â‚¬)</label>
Â  Â  Â  Â  Â  <input type="number" id="amount" name="amount" step="0.01" placeholder="0.00" required inputmode="decimal">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="form-group date">
Â  Â  Â  Â  Â  <label for="occurred_at">Data</label>
Â  Â  Â  Â  Â  <input type="date" id="occurred_at" name="occurred_at" required>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="form-group category">
Â  Â  Â  Â  Â  <label for="category_id">Categoria</label>
Â  Â  Â  Â  Â  <select id="category_id" name="category_id" required></select>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="form-group subcategory">
Â  Â  Â  Â  Â  <label for="subcategory_id">Sottocategoria</label>
Â  Â  Â  Â  Â  <select id="subcategory_id" name="subcategory_id">
Â  Â  Â  Â  Â  Â  <option value="">Seleziona sottocategoria...</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="advanced-options-wrapper" class="operation-type-selector">
Â  Â  Â  Â  Â  <h4>ğŸ”§ Tipo di Operazione</h4>
Â  Â  Â  Â  Â  <div class="operation-type-options">
Â  Â  Â  Â  Â  Â  <label class="operation-type-option selected">
Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="transaction_type" value="single" checked>
Â  Â  Â  Â  Â  Â  Â  ğŸ”¸ Operazione Singola
Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  <label class="operation-type-option">
Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="transaction_type" value="recurring">
Â  Â  Â  Â  Â  Â  Â  ğŸ”„ Ricorrente
Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  <label class="operation-type-option">
Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="transaction_type" value="scheduled">
Â  Â  Â  Â  Â  Â  Â  â° Imposta Scadenza
Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  <div id="recurring-options" class="advanced-options-fields" style="margin-top: 12px;">
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  <label for="recurring_frequency">Frequenza</label>
Â  Â  Â  Â  Â  Â  Â  <select id="recurring_frequency" name="recurring_frequency">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="weekly">ğŸ“… Settimanale</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="monthly" selected>ğŸ“… Mensile</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="yearly">ğŸ“… Annuale</option>
Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  <label for="recurring_end_date">Termina il (opzionale)</label>
Â  Â  Â  Â  Â  Â  Â  <input type="date" id="recurring_end_date" name="recurring_end_date">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div id="due-date-options" class="advanced-options-fields" style="margin-top: 12px;">
Â  Â  Â  Â  Â  Â  <div class="form-group full-width">
Â  Â  Â  Â  Â  Â  Â  <label for="due_date">Data di Scadenza/Incasso</label>
Â  Â  Â  Â  Â  Â  Â  <input type="date" id="due_date" name="due_date">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="form-buttons-container" class="form-buttons">
Â  Â  Â  Â  Â  <button type="submit" id="submit-btn" class="btn btn-primary" style="width:100%;">â• Crea Operazione</button>
Â  Â  Â  Â  Â  <button type="button" id="cancel-edit-btn" class="btn btn-secondary" style="display:none;">Annulla</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="status-message" class="status-message" aria-live="polite"></div>
Â  Â  Â  </form>
Â  Â  Â  </div>
Â  Â  </details>

Â  Â  <!-- ğŸ¯ Sezione Obiettivi (Layout v2) -->
Â  Â  <details id="goals-section" class="dash-card content-section goals-v2" style="margin-top:12px;">
Â  Â  Â  <summary class="dash-card__header">
Â  Â  Â  Â  <span class="dash-card__title">ğŸ¯ I Tuoi Obiettivi</span>
Â  Â  Â  Â  <div class="dash-card__actions">
Â  Â  Â  Â  Â  <button id="add-goal-btn" class="btn btn-primary" style="display: none; padding: 6px 12px; font-size: 0.9rem;">+ Aggiungi</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </summary>
Â  Â  Â  <div class="dash-card__content">
Â  Â  Â  Â  <div class="header" style="display:none;">
Â  Â  Â  Â  Â  <h3><span style="font-size: 1.5rem; line-height: 1;">ğŸ¯</span>I Tuoi Obiettivi</h3>
Â  Â  Â  Â  Â  <button id="add-goal-btn" class="btn btn-primary" style="display: none; padding: 6px 12px; font-size: 0.9rem;">+ Aggiungi</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="goals-list">
Â  Â  Â  Â  Â  <!-- Le card degli obiettivi verranno inserite qui dal JS -->
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </details>
Â  Â Â 
Â  Â  <!-- Dati principali -->
Â  Â  <details class="dash-card dashboard-panel" style="margin-top:12px;" open>
Â  Â  Â  <summary class="dash-card__header">
Â  Â  Â  Â  <span class="dash-card__title">ğŸ“Š Riepilogo Mensile</span>
Â  Â  Â  </summary>
Â  Â  Â  <div class="dash-card__content">
Â  Â  Â  Â  <div class="dashboard-grid">
Â  Â  Â  Â  Â  <div class="flow-column income">
Â  Â  Â  Â  Â  Â  <h2>ğŸ’°â€‹ Entrate Recenti</h2>
Â  Â  Â  Â  Â  Â  <div id="income-summary" class="summary-card"></div>
Â  Â  Â  Â  Â  Â  <div id="income-list" class="content-section transaction-list"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="flow-column expense">
Â  Â  Â  Â  Â  Â  <h2>ğŸ’¸â€‹ Uscite Recenti</h2>
Â  Â  Â  Â  Â  Â  <div id="expense-summary" class="summary-card"></div>
Â  Â  Â  Â  Â  Â  <div id="expense-list" class="content-section transaction-list"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </details>
Â  </main>

Â  <!-- Modals -->
Â  <div id="scheduler-modal" class="modal-overlay">
Â  Â  <div class="modal-content modal-content-enhanced">
Â  Â  Â  Â  <div class="modal-header modal-header-enhanced">
Â  Â  Â  Â  Â  Â  <h3 id="scheduler-modal-title" class="modal-title modal-title-enhanced"></h3>
Â  Â  Â  Â  Â  Â  <button class="modal-close" aria-label="Chiudi modale">&times;</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="scheduler-modal-body" class="modal-body-enhanced"></div>
Â  Â  </div>
Â  </div>
Â  <div id="generic-modal" class="modal-overlay"> <div class="modal-content"> <div class="modal-header"> <h3 id="generic-modal-title" class="modal-title"></h3> <button class="modal-close" aria-label="Chiudi modale">&times;</button> </div> <div id="generic-modal-body" class="modal-body"></div> <div id="generic-modal-footer" class="modal-footer"></div> </div> </div>
Â  <div id="animation-modal" class="animation-modal-overlay"> <div class="animation-container"> <img id="animation-bg-image" class="animation-bg-image" src="" alt="Animazione soldi"/> <div class="animation-elements-container"></div> </div> </div>
Â  <div id="movements-modal" class="modal-overlay"> <div class="modal-content modal-content-large"> <div class="modal-header"> <h3 id="movements-modal-title" class="modal-title">Lista Movimenti</h3> <button class="modal-close" aria-label="Chiudi modale">&times;</button> </div> <div id="movements-modal-body" class="modal-body"> <div class="movements-table-container"></div> </div> <div id="movements-modal-footer" class="movements-summary"></div> </div> </div>

Â  <script type="module">
Â  Â  import { supabase } from "/it/supabase-client.js";
Â  Â  window.supabase = supabase;

Â  Â  // --- STATE ---
Â  Â  let user = null;
Â  Â  let allCategories = [];
Â  Â  let allSubcategories = [];
Â  Â  let allTransactions = [];
Â  Â  let userProfile = null;
Â  Â  let goalsData = [];Â 

Â  Â  // --- DOM (originali) ---
Â  Â  const transactionForm = document.getElementById('transaction-form');
Â  Â  const kindSelect = document.getElementById('kind');
Â  Â  const categorySelect = document.getElementById('category_id');
Â  Â  const subcategorySelect = document.getElementById('subcategory_id');
Â  Â  const transactionIdInput = document.getElementById('transaction-id');
Â  Â  const formTitle = document.getElementById('form-title');
Â  Â  const submitBtn = document.getElementById('submit-btn');
Â  Â  const cancelEditBtn = document.getElementById('cancel-edit-btn');
Â  Â  const formButtonsContainer = document.getElementById('form-buttons-container');
Â  Â  const logoutBtn = document.getElementById('logout-btn');
Â  Â  const incomeList = document.getElementById('income-list');
Â  Â  const expenseList = document.getElementById('expense-list');
Â  Â  const incomeSummary = document.getElementById('income-summary');
Â  Â  const expenseSummary = document.getElementById('expense-summary');
Â  Â  const monthSelector = document.getElementById('month-selector');
Â  Â  const yearSelector = document.getElementById('year-selector');
Â  Â  const advancedOptionsWrapper = document.getElementById('advanced-options-wrapper');
Â  Â  const recurringOptions = document.getElementById('recurring-options');
Â  Â  const dueDateOptions = document.getElementById('due-date-options');
Â  Â  const deadlinesSection = document.getElementById('deadlines-section');
Â  Â  const deadlinesList = document.getElementById('deadlines-list');
Â  Â  const schedulerBtn = document.getElementById('scheduler-btn');
Â  Â  const notificationsBtn = document.getElementById('notifications-btn');
Â  Â  const notificationBadge = document.getElementById('notification-badge');
Â  Â  const schedulerModal = document.getElementById('scheduler-modal');
Â  Â  const movementsModal = document.getElementById('movements-modal');
Â  Â  const listMovementsBtn = document.getElementById('list-movements-btn');
Â  Â  const statusMessage = document.getElementById('status-message');
Â  Â  const animationModal = document.getElementById('animation-modal');
Â  Â  const subscriptionStatusBtn = document.getElementById('subscription-status-btn');

Â  Â  // --- DOM (per obiettivi) ---
Â  Â  const goalsSection = document.getElementById('goals-section');
Â  Â  const goalsList = document.getElementById('goals-list');
Â  Â Â 
Â  Â  // --- UTILS ---
Â  Â  function escapeHTML(s){
Â  Â  Â  return String(s ?? '')
Â  Â  Â  Â  .replace(/&/g,'&amp;')
Â  Â  Â  Â  .replace(/</g,'&lt;')
Â  Â  Â  Â  .replace(/>/g,'&gt;')
Â  Â  Â  Â  .replace(/"/g,'&quot;')
Â  Â  Â  Â  .replace(/'/g,'&#39;');
Â  Â  }
Â  Â  function ymdLocal(d = new Date()){
Â  Â  Â  return [
Â  Â  Â  Â  d.getFullYear(),
Â  Â  Â  Â  String(d.getMonth()+1).padStart(2,'0'),
Â  Â  Â  Â  String(d.getDate()).padStart(2,'0')
Â  Â  Â  ].join('-');
Â  Â  }
Â  Â  function addOneMonthSafeUTC(d){
Â  Â  Â  const y = d.getUTCFullYear(), m = d.getUTCMonth(), day = d.getUTCDate();
Â  Â  Â  const lastOfNext=new Date(Date.UTC(y, m+2, 0));
Â  Â  Â  const targetDay=Math.min(day, lastOfNext.getUTCDate());
Â  Â  Â  return new Date(Date.UTC(y, m+1, targetDay));
Â  Â  }
Â  Â  function safeToNumber(v){ const n = (typeof v === 'number') ? v : parseFloat(String(v).replace(',', '.')); return Number.isFinite(n) ? n : 0; }
Â  Â  const fmt = (n) => Number(n || 0).toFixed(2);
Â  Â  const dayMs = 86400000;

Â  Â  function showStatusMessage(message, type='success', duration=3000){
Â  Â  Â  statusMessage.textContent = message;
Â  Â  Â  statusMessage.className = `status-message ${type} is-visible`;
Â  Â  Â  setTimeout(()=>statusMessage.classList.remove('is-visible'), duration);
Â  Â  }

Â  Â  function showModal(title, bodyHtml, buttons=[]){
Â  Â  Â  const modal = document.getElementById('generic-modal');
Â  Â  Â  document.getElementById('generic-modal-title').textContent = title;
Â  Â  Â  document.getElementById('generic-modal-body').innerHTML = bodyHtml;
Â  Â  Â  const footer = document.getElementById('generic-modal-footer');
Â  Â  Â  footer.innerHTML = '';
Â  Â  Â  buttons.forEach(btnInfo=>{
Â  Â  Â  Â  const button = document.createElement('button');
Â  Â  Â  Â  button.innerHTML = btnInfo.text;
Â  Â  Â  Â  button.className = `btn ${btnInfo.class || 'btn-secondary'}`;
Â  Â  Â  Â  button.onclick = ()=>{
Â  Â  Â  Â  Â  if(btnInfo.action) btnInfo.action();
Â  Â  Â  Â  Â  if(!btnInfo.keepOpen) modal.classList.remove('is-visible');
Â  Â  Â  Â  };
Â  Â  Â  Â  footer.appendChild(button);
Â  Â  Â  });
Â  Â  Â  modal.classList.add('is-visible');
Â  Â  }

Â  Â  function showTransactionAnimation(type='income'){ return new Promise(resolve => resolve()); }
Â  Â  function resetFormToCreateMode(){
Â  Â  Â  formTitle.textContent = "Nuova Operazione";
Â  Â  Â  submitBtn.textContent = "Aggiungi";
Â  Â  Â  submitBtn.style.width = '100%';
Â  Â  Â  transactionIdInput.value = "";
Â  Â  Â  cancelEditBtn.style.display = 'none';
Â  Â  Â  formButtonsContainer.classList.remove('is-editing');
Â  Â  Â  transactionForm.reset();
Â  Â  Â  document.getElementById('occurred_at').valueAsDate = new Date();
Â  Â  Â  document.querySelector('input[name="transaction_type"][value="single"]').checked = true;
Â  Â  Â  advancedOptionsWrapper.style.display = 'block';
Â  Â  Â  recurringOptions.style.display = 'none';
Â  Â  Â  dueDateOptions.style.display = 'none';
Â  Â  Â  updateCategoryDropdown();
Â  Â  }
Â  Â Â 
Â  Â  function toLocalMidnight(yyyyMmDd){
Â  Â  Â  if (!yyyyMmDd) return null;
Â  Â  Â  const [y,m,d] = yyyyMmDd.split('-').map(n=>parseInt(n,10));
Â  Â  Â  const dt = new Date();
Â  Â  Â  dt.setFullYear(y, m-1, d);
Â  Â  Â  dt.setHours(0,0,0,0);
Â  Â  Â  return dt;
Â  Â  }

Â  Â  async function loadInitialData(){
Â  Â  Â  try{
Â  Â  Â  Â  const { data: categories, error: cError } = await supabase.from('categories').select('*').eq('created_by', user.id);
Â  Â  Â  Â  if (cError) throw cError;
Â  Â  Â  Â  allCategories = categories || [];
Â  Â  Â  Â  if (allCategories.length){
Â  Â  Â  Â  Â  const ids = allCategories.map(c=>c.id);
Â  Â  Â  Â  Â  const { data: subcategories, error: sError } = await supabase.from('subcategories').select('*').in('category_id', ids);
Â  Â  Â  Â  Â  if (sError) throw sError;
Â  Â  Â  Â  Â  allSubcategories = subcategories || [];
Â  Â  Â  Â  }
Â  Â  Â  } catch (error){
Â  Â  Â  Â  console.error("Errore nel caricamento dei dati iniziali:", error);
Â  Â  Â  Â  showModal('Errore', `<p>Impossibile caricare le categorie. Riprova piÃ¹ tardi.</p>`, [{ text:'Chiudi' }]);
Â  Â  Â  }
Â  Â  }

Â  Â  function updateCategoryDropdown(){
Â  Â  Â  const selectedKind = kindSelect.value;
Â  Â  Â  const filtered = allCategories.filter(cat => cat.kind === selectedKind);
Â  Â  Â  categorySelect.innerHTML = '<option value="">Scegli categoria...</option>';
Â  Â  Â  filtered.forEach(cat => categorySelect.add(new Option(`${cat.icon || ''} ${cat.name}`, cat.id)));
Â  Â  Â  updateSubcategories();
Â  Â  }

Â  Â  function updateSubcategories(selectedSubcategoryId=null){
Â  Â  Â  const categoryId = categorySelect.value;
Â  Â  Â  subcategorySelect.innerHTML = '<option value="">Nessuna</option>';
Â  Â  Â  subcategorySelect.disabled = true;
Â  Â  Â  if (!categoryId) return;
Â  Â  Â  const relevant = allSubcategories.filter(sub => String(sub.category_id) === String(categoryId));
Â  Â  Â  if (relevant.length){
Â  Â  Â  Â  subcategorySelect.disabled = false;
Â  Â  Â  Â  relevant.forEach(sub => subcategorySelect.add(new Option(`${sub.icon || ''} ${sub.name}`, sub.id)));
Â  Â  Â  Â  if (selectedSubcategoryId) subcategorySelect.value = selectedSubcategoryId;
Â  Â  Â  }
Â  Â  }

Â  Â  function renderSummary(items, container, kind){
Â  Â  Â  container.innerHTML = '';
Â  Â  Â  const categoryMap = allCategories.filter(cat => cat.kind === kind).reduce((acc, cat)=>({ ...acc, [cat.id]: { name:cat.name, icon:cat.icon || (kind==='income'?'ğŸ’°':'ğŸ’¸'), total:0 } }),{});
Â  Â  Â  items.forEach(tx => { if (tx.category_id && categoryMap[tx.category_id]) categoryMap[tx.category_id].total += safeToNumber(tx.amount); });
Â  Â  Â  const totalAmount = items.reduce((sum, tx)=> sum + safeToNumber(tx.amount), 0);
Â  Â  Â  const categoriesToRender = Object.values(categoryMap).filter(cat => cat.total > 0).sort((a,b)=> b.total - a.total).slice(0,5);
Â  Â  Â  container.style.display = 'block';
Â  Â  Â  const summaryTitle = kind === 'income' ? 'ğŸ† Top 5 Entrate' : 'ğŸ† Top 5 Uscite';
Â  Â  Â  let barsHTML = categoriesToRender.map(cat=>{ const percentage = totalAmount > 0 ? (cat.total / totalAmount) * 100 : 0; return `<div class="category-bar-item"><div class="category-bar-info"><span class="category-bar-label"><span class="icon">${escapeHTML(cat.icon)}</span><span>${escapeHTML(cat.name)}</span></span><span class="category-bar-amount">${cat.total.toFixed(2)}â‚¬</span></div><div class="progress-bar-bg"><div class="progress-bar-fg" style="width:${percentage}%"></div></div></div>`; }).join('');
Â  Â  Â  const placeholdersNeeded = 5 - categoriesToRender.length;
Â  Â  Â  if (placeholdersNeeded > 0){ const placeholderHTML = `<div class="category-bar-item" aria-hidden="true"><div class="category-bar-info" style="visibility:hidden;"><span class="category-bar-label"><span class="icon">&nbsp;</span><span>-</span></span><span class="category-bar-amount">&nbsp;</span></div><div class="progress-bar-bg" style="visibility:hidden;"><div class="progress-bar-fg" style="width:0%;"></div></div></div>`; barsHTML += placeholderHTML.repeat(placeholdersNeeded); }
Â  Â  Â  container.innerHTML = `<h3><span>${summaryTitle}</span><span class="summary-total-amount">${totalAmount.toFixed(2)}â‚¬</span></h3><div class="category-summary-bars">${barsHTML}</div>`;
Â  Â  }

Â  Â  function renderList(items, container, kind){
Â  Â  Â  container.innerHTML = '';
Â  Â  Â  const totalAmount = items.reduce((sum, tx)=> sum + safeToNumber(tx.amount), 0);
Â  Â  Â  const titleText = kind === 'income' ? 'Movimenti in Entrata' : 'Movimenti in Uscita';
Â  Â  Â  const titleEl = document.createElement('div');
Â  Â  Â  titleEl.className = 'list-title';
Â  Â  Â  titleEl.innerHTML = `<span>${escapeHTML(titleText)}</span><span class="list-total-amount ${kind}">${totalAmount.toFixed(2)}â‚¬</span>`;
Â  Â  Â  container.appendChild(titleEl);
Â  Â  Â  if (!items.length){ container.insertAdjacentHTML('beforeend', `<div class="empty-state"><p>Nessun movimento qui.</p></div>`); return; }
Â  Â  Â  items.forEach(tx=>{
Â  Â  Â  Â  const cat = tx.categories;
Â  Â  Â  Â  const sub = tx.subcategories;
Â  Â  Â  Â  const icon = sub?.icon || cat?.icon || 'ğŸ’¸';
Â  Â  Â  Â  const categoryText = `${escapeHTML(cat?.name || 'N/A')}${(sub ? ` / ${escapeHTML(sub.name)}` : '')}`;
Â  Â  Â  Â  const amountNum = safeToNumber(tx.amount);
Â  Â  Â  Â  const recurringIcon = tx.is_recurring_parent ? ' ğŸ”„' : '';
Â  Â  Â  Â  container.insertAdjacentHTML('beforeend', `<div class="item"><div class="item-icon">${escapeHTML(icon)}</div><div class="item-details"><span class="note">${escapeHTML(tx.note ?? '')}${recurringIcon}</span><span class="category">${categoryText}</span></div><div class="item-amount ${tx.kind}">${tx.kind === 'expense' ? '-' : '+'}${amountNum.toFixed(2)} â‚¬</div><div class="item-actions"><button class="action-btn edit-btn" data-id="${tx.id}">âœğŸ¼ Modifica</button><button class="action-btn delete-btn delete" data-id="${tx.id}" aria-label="Elimina ${escapeHTML(tx.note)}">ğŸ—‘ï¸</button></div></div>`);
Â  Â  Â  });
Â  Â  }

Â  Â  async function getScheduledTransactions(startDate, endDate){
Â  Â  Â  try{
Â  Â  Â  Â  const { data, error } = await supabase.from('transactions').select('*, categories(*), subcategories(*)').eq('created_by', user.id).eq('is_paid', false).gte('due_date', startDate.toISOString().split('T')[0]).lte('due_date', endDate.toISOString().split('T')[0]).order('due_date', { ascending:true });
Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  return data || [];
Â  Â  Â  } catch (error){ console.error("Errore caricamento scadenze:", error); return []; }
Â  Â  }

Â  Â  function renderDeadlinesList(container, transactions) {
Â  Â  Â  Â  // If there are no transactions, display an empty state message and exit.
Â  Â  Â  Â  if (transactions.length === 0) {
Â  Â  Â  Â  Â  Â  container.innerHTML = '<div class="empty-state"><p>Nessuna scadenza in questo periodo.</p></div>';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Clear the container and set up date utilities.
Â  Â  Â  Â  container.innerHTML = '';
Â  Â  Â  Â  const today = new Date();
Â  Â  Â  Â  today.setHours(0, 0, 0, 0);
Â  Â  Â  Â  const monthFormatter = new Intl.DateTimeFormat('it-IT', { month: 'short' });
Â  Â  Â  Â  const isModal = container.closest('.modal-overlay');

Â  Â  Â  Â  // Update the deadlines count badge in the main UI.
Â  Â  Â  Â  const deadlinesCountBadge = document.getElementById('deadlines-count');
Â  Â  Â  Â  if (deadlinesCountBadge) deadlinesCountBadge.textContent = transactions.length;

Â  Â  Â  Â  // Loop through each transaction to create and append its corresponding HTML element.
Â  Â  Â  Â  transactions.forEach((tx, index) => {
Â  Â  Â  Â  Â  Â  let itemHTML = '';

Â  Â  Â  Â  Â  Â  // Common variables for both modal and non-modal views.
Â  Â  Â  Â  Â  Â  const dueDate = new Date(tx.due_date);
Â  Â  Â  Â  Â  Â  const day = dueDate.getDate();
Â  Â  Â  Â  Â  Â  const month = monthFormatter.format(dueDate).toUpperCase().replace('.', '');
Â  Â  Â  Â  Â  Â  const daysDiff = Math.ceil((dueDate - today) / dayMs);
Â  Â  Â  Â  Â  Â  const isIncome = tx.kind === 'income';
Â  Â  Â  Â  Â  Â  const amount = safeToNumber(tx.amount);
Â  Â  Â  Â  Â  Â  const categoryName = tx.categories?.name || 'Categoria';
Â  Â  Â  Â  Â  Â  const subcategoryName = tx.subcategories?.name || '';
Â  Â  Â  Â  Â  Â  const fullCategory = subcategoryName ? `${categoryName} - ${subcategoryName}` : categoryName;
Â  Â  Â  Â  Â  Â  const noteSafe = escapeHTML(tx.note || 'Transazione');
Â  Â  Â  Â  Â  Â  const amountClass = isIncome ? 'income' : 'expense';
Â  Â  Â  Â  Â  Â  const amountSign = isIncome ? '+' : '-';
Â  Â  Â  Â  Â  Â  const buttonClass = isIncome ? 'receive' : 'pay';
Â  Â  Â  Â  Â  Â  const buttonText = isIncome ? 'Ricevi' : 'Paga';

Â  Â  Â  Â  Â  Â  // Conditional rendering based on whether the list is in a modal.
Â  Â  Â  Â  Â  Â  if (isModal) {
Â  Â  Â  Â  Â  Â  Â  Â  // Logic to determine the badge class based on how soon the deadline is.
Â  Â  Â  Â  Â  Â  Â  Â  let daysLeftClass = 'very-far';
Â  Â  Â  Â  Â  Â  Â  Â  if (daysDiff < 0 || daysDiff <= 7) daysLeftClass = 'due-soon';
Â  Â  Â  Â  Â  Â  Â  Â  else if (daysDiff <= 15) daysLeftClass = 'far-off';
Â  Â  Â  Â  Â  Â  Â  Â  const daysLeftText = daysDiff < 0 ? 'Scaduta' : (daysDiff === 0 ? 'Oggi' : `Tra ${daysDiff} giorni`);

Â  Â  Â  Â  Â  Â  Â  Â  itemHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="deadline-item-modal">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="date-box">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="day">${day}</span><span class="month">${month}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="details">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="note">${noteSafe}</p><p class="category">${fullCategory}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="right-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="amount ${amountClass}">${amountSign}${fmt(amount)}â‚¬</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="days-left-badge ${daysLeftClass}">${daysLeftText}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-action-deadline ${buttonClass}" data-id="${tx.id}">${buttonText}</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="action-btn edit-btn" data-id="${tx.id}" aria-label="Modifica ${noteSafe}">âœğŸ¼</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="action-btn delete-btn delete" data-id="${tx.id}" aria-label="Elimina ${noteSafe}">ğŸ—‘ï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Logic for the main dashboard view.
Â  Â  Â  Â  Â  Â  Â  Â  const isOverdue = daysDiff < 0;
Â  Â  Â  Â  Â  Â  Â  Â  const isUrgent = daysDiff <= 3 && daysDiff >= 0;
Â  Â  Â  Â  Â  Â  Â  Â  const urgencyClass = isOverdue ? 'overdue' : (isUrgent ? 'urgent' : '');
Â  Â  Â  Â  Â  Â  Â  Â  let urgencyText = daysDiff > 0 ? `Tra ${daysDiff} giorni` : '';
Â  Â  Â  Â  Â  Â  Â  Â  if (isOverdue) urgencyText = `<p style="color:var(--danger-color);font-size:0.8rem;font-weight:600;">In ritardo di ${Math.abs(daysDiff)} giorni</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  if (daysDiff === 0) urgencyText = `<p style="color:var(--warning-color);font-size:0.8rem;font-weight:600;">Scade oggi!</p>`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  itemHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="deadline-item-enhanced" style="animation-delay: ${index * 100}ms;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="deadline-date-circle ${urgencyClass}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:1.1rem;font-weight:bold;">${day}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size:0.7rem;">${month}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="deadline-details">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4>${noteSafe}</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>${fullCategory}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${urgencyText}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="deadline-amount ${amountClass}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${amountSign}â‚¬${fmt(amount)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="deadline-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-action-deadline ${buttonClass}" data-id="${tx.id}" title="${isIncome ? 'Segna come ricevuto' : 'Segna come pagato'}">${isIncome ? 'ğŸ’° Ricevi' : 'ğŸ’³ Paga'}</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-edit" data-id="${tx.id}" title="Modifica scadenza">âœï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-delete delete" data-id="${tx.id}" title="Elimina scadenza">ğŸ—‘ï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  container.insertAdjacentHTML('beforeend', itemHTML);
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function renderMovementsListModal(transactions, months){
Â  Â  Â  const modalBody = document.getElementById('movements-modal-body').querySelector('.movements-table-container');
Â  Â  Â  const modalFooter = document.getElementById('movements-modal-footer');
Â  Â  Â  const modalTitle = document.getElementById('movements-modal-title');
Â  Â  Â  const selectedMonthName = months[monthSelector.value];
Â  Â  Â  const selectedYear = yearSelector.value;
Â  Â  Â  modalTitle.textContent = `Estratto Conto - ${selectedMonthName} ${selectedYear}`;
Â  Â  Â  if (!transactions || transactions.length === 0){ modalBody.innerHTML = '<div class="empty-state"><p>Nessun movimento per il periodo selezionato.</p></div>'; modalFooter.innerHTML = ''; return; }
Â  Â  Â  const sortedTx = [...transactions].sort((a,b)=> new Date(a.occurred_at) - new Date(b.occurred_at));
Â  Â  Â  let totalIncome = 0, totalExpense = 0;
Â  Â  Â  const rows = sortedTx.map(tx=>{ const amount = safeToNumber(tx.amount); if (tx.kind === 'income') totalIncome += amount; else totalExpense += amount; const date = new Date(tx.occurred_at).toLocaleDateString('it-IT',{day:'2-digit',month:'2-digit',year:'numeric'}); const type = tx.kind === 'income' ? 'Entrata' : 'Uscita'; const note = escapeHTML(tx.note || '-'); const category = escapeHTML(tx.categories?.name || 'N/A'); const subcategory = escapeHTML(tx.subcategories?.name || '-'); const amountFormatted = `${tx.kind==='income'?'+':'-'} ${amount.toFixed(2)} â‚¬`; return `<tr class="${tx.kind}"><td>${date}</td><td>${type}</td><td>${note}</td><td class="amount-col">${amountFormatted}</td><td>${category}</td><td>${subcategory}</td></tr>`; }).join('');
Â  Â  Â  modalBody.innerHTML = `<table class="movements-table"><thead><tr><th scope="col">Data</th><th scope="col">Tipo</th><th scope="col">Nota</th><th scope="col" class="amount-col">Importo</th><th scope="col">Categoria</th><th scope="col">Sottocategoria</th></tr></thead><tbody>${rows}</tbody></table>`;
Â  Â  Â  const balance = totalIncome - totalExpense;
Â  Â  Â  modalFooter.innerHTML = `<div class="summary-item"><div class="summary-label">Totale Entrate</div><div class="summary-value total-income">+ ${totalIncome.toFixed(2)} â‚¬</div></div><div class="summary-item"><div class="summary-label">Totale Uscite</div><div class="summary-value total-expense">- ${totalExpense.toFixed(2)} â‚¬</div></div><div class="summary-item"><div class="summary-label">Saldo</div><div class="summary-value balance">${balance.toFixed(2)} â‚¬</div></div>`;
Â  Â  }

Â  Â  async function updateNotifications(){
Â  Â  Â  const today = new Date();
Â  Â  Â  const futureDate = new Date(); futureDate.setDate(today.getDate()+7);
Â  Â  Â  const upcoming = await getScheduledTransactions(today, futureDate);
Â  Â  Â  if (upcoming.length > 0){ notificationBadge.textContent = upcoming.length; notificationBadge.classList.add('is-visible'); } else { notificationBadge.textContent = ''; notificationBadge.classList.remove('is-visible'); }
Â  Â  }

Â  Â  async function loadAllDataForMonth(){
Â  Â  Â  await loadTransactions();
Â  Â  Â  const today = new Date();
Â  Â  Â  const futureDate = new Date(); futureDate.setDate(today.getDate()+30);
Â  Â  Â  const imminentDeadlines = await getScheduledTransactions(today, futureDate);
Â  Â  Â  if (imminentDeadlines.length > 0){ deadlinesSection.style.display = 'block'; renderDeadlinesList(deadlinesList, imminentDeadlines); } else { deadlinesSection.style.display = 'none'; }
Â  Â  Â  updateNotifications();
Â  Â  }

Â  Â  async function loadTransactions(){
Â  Â  Â  monthSelector.disabled = true;
Â  Â  Â  yearSelector.disabled = true;
Â  Â  Â  renderDashboard([]);
Â  Â  Â  try{
Â  Â  Â  Â  const m = parseInt(monthSelector.value,10);
Â  Â  Â  Â  const y = parseInt(yearSelector.value,10);
Â  Â  Â  Â  const monthStart = new Date(Date.UTC(y, m, 1));
Â  Â  Â  Â  const nextMonthStart = new Date(Date.UTC(y, m+1, 1));
Â  Â  Â  Â  const startStr = monthStart.toISOString().split('T')[0];
Â  Â  Â  Â  const nextStartStr = nextMonthStart.toISOString().split('T')[0];
Â  Â  Â  Â  const { data, error } = await supabase.from('transactions').select('*, categories(*), subcategories(*)').eq('created_by', user.id).gte('occurred_at', startStr).lt('occurred_at', nextStartStr).order('occurred_at', { ascending:false });
Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  allTransactions = data || [];
Â  Â  Â  renderDashboard(allTransactions);
Â  Â  Â  renderDashboard([...allTransactions]); // Clone for safety
Â  Â  Â  animateFinancialSummary(); // Add animations
Â  Â  Â  } catch (error){
Â  Â  Â  Â  console.error("Errore transazioni:", error);
Â  Â  Â  Â  showModal('Errore', `<p>Impossibile caricare le transazioni. Riprova piÃ¹ tardi.</p>`, [{ text:'Chiudi' }]);
Â  Â  Â  } finally {
Â  Â  Â  Â  monthSelector.disabled = false;
Â  Â  Â  Â  yearSelector.disabled = false;
Â  Â  Â  }
Â  Â  }

Â  Â  function handleEdit(id){
Â  Â  Â  const tx = allTransactions.find(t => String(t.id) === String(id)) || {};
Â  Â  Â  if (!tx.id){
Â  Â  Â  Â  supabase.from('transactions').select('*').eq('id', id).single().then(({data, error})=>{ if (error || !data){ showModal('Errore', `<p>Impossibile trovare la transazione da modificare.</p>`, [{ text:'Chiudi' }]); return; } populateAndShowEditForm(data); });
Â  Â  Â  } else { populateAndShowEditForm(tx); }
Â  Â  Â  function populateAndShowEditForm(tx){
Â  Â  Â  Â  if (tx.is_recurring_parent){ showModal('Azione non permessa', `<p>La modifica delle operazioni ricorrenti non Ã¨ ancora supportata. Elimina la serie e creane una nuova.</p>`, [{ text:'Ho capito' }]); return; }
Â  Â  Â  Â  formTitle.textContent = "âœï¸ Modifica Operazione";
Â  Â  Â  Â  submitBtn.textContent = "Aggiorna";
Â  Â  Â  Â  submitBtn.style.width = 'auto';
Â  Â  Â  Â  cancelEditBtn.style.display = 'inline-block';
Â  Â  Â  Â  formButtonsContainer.classList.add('is-editing');
Â  Â  Â  Â  transactionIdInput.value = tx.id;
Â  Â  Â  Â  document.getElementById('kind').value = tx.kind;
Â  Â  Â  Â  document.getElementById('note').value = tx.note ?? '';
Â  Â  Â  Â  document.getElementById('amount').value = safeToNumber(tx.amount);
Â  Â  Â  Â  const dateToUse = tx.is_paid === false ? tx.due_date : tx.occurred_at;
Â  Â  Â  Â  document.getElementById('occurred_at').value = (dateToUse || '').toString().split('T')[0] || '';
Â  Â  Â  Â  const type = tx.is_paid === false ? 'scheduled' : 'single';
Â  Â  Â  Â  document.querySelector(`input[name="transaction_type"][value="${type}"]`).checked = true;
Â  Â  Â  Â  if (type === 'scheduled'){
Â  Â  Â  Â  Â  advancedOptionsWrapper.style.display = 'block';
Â  Â  Â  Â  Â  document.getElementById('due-date-options').style.display = 'grid';
Â  Â  Â  Â  Â  const dd = (tx.due_date || '').toString();
Â  Â  Â  Â  Â  document.getElementById('due_date').value = dd.includes('T') ? dd.split('T')[0] : dd;
Â  Â  Â  Â  Â  recurringOptions.style.display = 'none';
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  document.getElementById('due-date-options').style.display = 'none';
Â  Â  Â  Â  Â  recurringOptions.style.display = 'none';
Â  Â  Â  Â  Â  advancedOptionsWrapper.style.display = 'block';
Â  Â  Â  Â  }
Â  Â  Â  Â  updateCategoryDropdown();
Â  Â  Â  Â  categorySelect.value = tx.category_id ?? '';
Â  Â  Â  Â  updateSubcategories(tx.subcategory_id ?? null);
Â  Â  Â  Â  window.scrollTo({ top:0, behavior:'smooth' });
Â  Â  Â  }
Â  Â  }

Â  Â  async function handleDelete(id){
Â  Â  Â  const { data: txToDelete, error: fetchError } = await supabase.from('transactions').select('is_recurring_parent').eq('id', id).single();
Â  Â  Â  if (fetchError && fetchError.code !== 'PGRST116'){ console.error("Errore recupero transazione da eliminare:", fetchError); showModal('Errore', 'Impossibile trovare l\'operazione da eliminare.', [{ text:'Chiudi' }]); return; }
Â  Â  Â  if (!txToDelete) return;
Â  Â  Â  let message = "<p>Sei sicuro di voler eliminare questa operazione?</p>";
Â  Â  Â  if (txToDelete.is_recurring_parent){ message = "<p>Questa Ã¨ un'operazione ricorrente. Eliminando questa, <strong>verranno rimosse anche tutte le occorrenze future</strong>.</p><p>Vuoi procedere?</p>"; }
Â  Â  Â  showModal("Conferma eliminazione", message, [ { text:'Annulla', class:'btn-secondary' }, { text:'ğŸ—‘ï¸ Elimina', class:'delete', action: async ()=>{ try{ const { error } = await supabase.rpc('delete_transaction_and_children', { transaction_id_to_delete: id }); if (error) throw error; showStatusMessage('Operazione eliminata con successo!', 'success'); loadAllDataForMonth(); } catch (error){ console.error("Errore durante l'eliminazione via RPC:", error); let userMessage = "Impossibile completare l'eliminazione. Riprova."; if (error.message?.includes('permission denied')){ userMessage = "Errore: Permessi non sufficienti. Verifica le RLS sulla funzione e sulla tabella `transactions`."; } showModal('Errore', `<p>${userMessage}</p><p><small>Dettaglio: ${error.message}</small></p>`, [{ text:'Chiudi' }]); } } } ]);
Â  Â  }

Â  Â  async function handleFormSubmit(e){
Â  Â  Â  e.preventDefault();
Â  Â  Â  const formData = new FormData(transactionForm);
Â  Â  Â  const id = formData.get('transaction-id');
Â  Â  Â  const kind = formData.get('kind');
Â  Â  Â  if (id){ const kindText = kind === 'income' ? 'entrata' : 'spesa'; showModal(`Conferma Aggiornamento`, `<p>Sei sicuro di voler aggiornare questa ${kindText}?</p>`, [ { text:'Annulla', class:'btn-secondary' }, { text:'Aggiorna', class:'btn-primary', action:()=>saveTransaction(formData) } ]); } else { saveTransaction(formData); }
Â  Â  }

Â  Â  async function saveTransaction(formData){
Â  Â  Â  const id = formData.get('transaction-id');
Â  Â  Â  const transactionType = formData.get('transaction_type');
Â  Â  Â Â 
Â  Â  Â  const amt = String(formData.get('amount') || '').replace(',', '.');
Â  Â  Â  const parsedAmount = parseFloat(amt);

Â  Â  Â  if (!Number.isFinite(parsedAmount)) {
Â  Â  Â  Â  showModal('Importo non valido', `<p>Controlla l'importo. Puoi usare sia "12.34" che "12,34".</p>`, [{ text:'Chiudi' }]);
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const payload = {
Â  Â  Â  Â  kind: formData.get('kind'),
Â  Â  Â  Â  note: formData.get('note'),
Â  Â  Â  Â  amount: parsedAmount,
Â  Â  Â  Â  occurred_at: formData.get('occurred_at'),
Â  Â  Â  Â  category_id: formData.get('category_id'),
Â  Â  Â  Â  subcategory_id: formData.get('subcategory_id') || null,
Â  Â  Â  Â  created_by: user.id,
Â  Â  Â  Â  is_paid: true,
Â  Â  Â  Â  due_date: null
Â  Â  Â  };

Â  Â  Â  if (transactionType === 'scheduled'){
Â  Â  Â  Â  const dueDate = formData.get('due_date') || formData.get('occurred_at');
Â  Â  Â  Â  if (!dueDate){
Â  Â  Â  Â  Â  showModal('Dati mancanti', `<p>Seleziona una data di scadenza/incasso valida.</p>`, [{ text:'Chiudi' }]);
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  payload.due_date = dueDate;
Â  Â  Â  Â  payload.is_paid = false;
Â  Â  Â  Â  payload.occurred_at = dueDate;
Â  Â  Â  }
Â  Â  Â  try{
Â  Â  Â  Â  let error;
Â  Â  Â  Â  if (transactionType === 'recurring' && !id){
Â  Â  Â  Â  Â  const endDateStr = formData.get('recurring_end_date');
Â  Â  Â  Â  Â  if (!endDateStr){ showModal('Dati mancanti', `<p>Seleziona una data di fine valida per l'operazione ricorrente.</p>`, [{ text:'Chiudi' }]); return; }
Â  Â  Â  Â  Â  payload.is_recurring_parent = true;
Â  Â  Â  Â  Â  const { data: parentData, error: parentError } = await supabase.from('transactions').insert(payload).select().single();
Â  Â  Â  Â  Â  if (parentError) throw parentError;
Â  Â  Â  Â  Â  const [y0,m0,d0] = payload.occurred_at.split('-').map(n=>parseInt(n,10));
Â  Â  Â  Â  Â  const endParts = endDateStr.split('-').map(n=>parseInt(n,10));
Â  Â  Â  Â  Â  const endDate = new Date(Date.UTC(endParts[0], endParts[1]-1, endParts[2]));
Â  Â  Â  Â  Â  let current = new Date(Date.UTC(y0, m0-1, d0));
Â  Â  Â  Â  Â  const children = [];
Â  Â  Â  Â  Â  while (true){
Â  Â  Â  Â  Â  Â  current = addOneMonthSafeUTC(current);
Â  Â  Â  Â  Â  Â  if (current > endDate) break;
Â  Â  Â  Â  Â  Â  const yyyy = current.getUTCFullYear();
Â  Â  Â  Â  Â  Â  const mm = String(current.getUTCMonth()+1).padStart(2,'0');
Â  Â  Â  Â  Â  Â  const dd = String(current.getUTCDate()).padStart(2,'0');
Â  Â  Â  Â  Â  Â  const iso = `${yyyy}-${mm}-${dd}`;
Â  Â  Â  Â  Â  Â  children.push({ ...payload, is_recurring_parent: false, parent_transaction_id: parentData.id, occurred_at: iso, due_date: iso, is_paid: false });
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  if (children.length){ const { error: chErr } = await supabase.from('transactions').insert(children); if (chErr) error = chErr; }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  const query = id ? supabase.from('transactions').update(payload).eq('id', id) : supabase.from('transactions').insert(payload);
Â  Â  Â  Â  Â  const { error: singleError } = await query;
Â  Â  Â  Â  Â  error = singleError;
Â  Â  Â  Â  }
Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  if (!id && transactionType !== 'scheduled'){ if (payload.kind === 'income') await showTransactionAnimation('income'); if (payload.kind === 'expense') await showTransactionAnimation('expense'); }
Â  Â  Â  Â  showStatusMessage(id ? 'Operazione aggiornata!' : 'Operazione aggiunta!', 'success');
Â  Â  Â  Â  resetFormToCreateMode();
Â  Â  Â  Â  loadAllDataForMonth();
Â  Â  Â  } catch (error){
Â  Â  Â  Â  console.error("Errore nel salvataggio:", error);
Â  Â  Â  Â  showModal('Errore di Salvataggio', `<p>Non Ã¨ stato possibile salvare l'operazione. Controlla i dati e riprova.</p><p><small>${error.message}</small></p>`, [{ text:'Chiudi' }]);
Â  Â  Â  }
Â  Â  }

Â  Â  async function handleConfirmDeadline(id){
Â  Â  Â  showModal( 'Conferma Operazione', '<p>Vuoi registrare questa operazione con la data di oggi?</p>', [ { text: 'Annulla', class: 'btn-secondary' }, { text: 'Conferma', class: 'btn-primary', action: async () => { try { const { error } = await supabase.from('transactions').update({ is_paid: true, occurred_at: ymdLocal(new Date()) }).eq('id', id); if (error) throw error; loadAllDataForMonth(); } catch (error) { console.error("Errore nell'aggiornamento dell'operazione:", error); showModal('Errore', `<p>Impossibile aggiornare l'operazione. Riprova.</p>`, [{ text: 'Chiudi' }]); } } } ]);
Â  Â  }

Â  Â  function renderSubscriptionStatus(profile) {
Â  Â  Â  if (!profile || !profile.plan_type) {
Â  Â  Â  Â  Â  subscriptionStatusBtn.style.display = 'none';
Â  Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  let text = '';
Â  Â  Â  let link = '#';
Â  Â  Â  switch(profile.plan_type) {
Â  Â  Â  Â  Â  case 'starter': case 'trial':
Â  Â  Â  Â  Â  Â  Â  if (profile.trial_end) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  const endDate = new Date(profile.trial_end);
Â  Â  Â  Â  Â  Â  Â  Â  Â  const today = new Date(); today.setHours(0,0,0,0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  const diffTime = endDate - today;
Â  Â  Â  Â  Â  Â  Â  Â  Â  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (diffDays >= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (diffDays > 10) text = `âœ¨ Sblocca tutto! ${diffDays} giorni rimasti`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (diffDays > 3) text = `â° L'offerta scade! ${diffDays} giorni rimasti`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else text = diffDays > 1 ? `ğŸ”¥ Affrettati! Solo ${diffDays} giorni` : `ğŸ”¥ Ultimo giorno! Aggiorna ora`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  link = '/it/pricing.html';
Â  Â  Â  Â  Â  Â  Â  Â  Â  } else { text = 'ğŸ˜­ Prova Scaduta. Aggiorna ora!'; link = '/it/pricing.html'; }
Â  Â  Â  Â  Â  Â  Â  } break;
Â  Â  Â  Â  Â  case 'plus': text = 'MyHomesBudget PLUS'; link = '/it/account.html'; break;
Â  Â  Â  Â  Â  case 'pro': text = 'MyHomesBudget PRO'; link = '/it/account.html'; break;
Â  Â  Â  }
Â  Â  Â  if (text) {
Â  Â  Â  Â  Â  subscriptionStatusBtn.textContent = text;
Â  Â  Â  Â  Â  subscriptionStatusBtn.href = link;
Â  Â  Â  Â  Â  subscriptionStatusBtn.style.display = 'flex';
Â  Â  Â  } else {
Â  Â  Â  Â  Â  subscriptionStatusBtn.style.display = 'none';
Â  Â  Â  }
Â  Â  }
Â  Â  function positionSubscriptionButton() {
Â  Â  Â  const topCenter = document.querySelector('.top-center');
Â  Â  Â  const topActions = document.querySelector('.top-actions');
Â  Â  Â  if (!topCenter || !topActions || !subscriptionStatusBtn) return;
Â  Â  Â  if (window.innerWidth <= 1200) {
Â  Â  Â  Â  Â  if (subscriptionStatusBtn.parentElement !== topActions) topActions.prepend(subscriptionStatusBtn);
Â  Â  Â  } else {
Â  Â  Â  Â  Â  if (subscriptionStatusBtn.parentElement !== topCenter) topCenter.appendChild(subscriptionStatusBtn);
Â  Â  Â  }
Â  Â  }

Â  Â  // --- NUOVA LOGICA OBIETTIVI ---
Â  Â  function mapContributionMethodToInternal(method) {
Â  Â  Â  Â  if (method === 'Cifra fissa') return 'fixed';
Â  Â  Â  Â  if (method === 'Percentuale sulle entrate') return 'percent_income';
Â  Â  Â  Â  if (method === 'Importo variabile') return 'variable';
Â  Â  Â  Â  return 'fixed';
Â  Â  }

Â  Â  function mapInternalToContributionMethod(internal) {
Â  Â  Â  Â  if (internal === 'fixed') return 'Cifra fissa';
Â  Â  Â  Â  if (internal === 'percent_income') return 'Percentuale sulle entrate';
Â  Â  Â  Â  if (internal === 'variable') return 'Importo variabile';
Â  Â  Â  Â  return 'Cifra fissa';
Â  Â  }
Â  Â Â 
Â  Â  async function loadAndRenderGoals() {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const { data: profile, error: profileError } = await supabase.from('profiles').select('*').eq('id', user.id).single();
Â  Â  Â  Â  Â  Â  if (profileError) throw profileError;
Â  Â  Â  Â  Â  Â  userProfile = profile;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const allGoals = [];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (profile.goal_name) {
Â  Â  Â  Â  Â  Â  Â  Â  allGoals.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: 'onboarding-goal',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nome_obiettivo: profile.goal_name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  importo_target: profile.goal_target_amount,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  metodo_contribuzione: profile.contribution_method,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  importo_mensile: profile.contribution_amount,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  is_onboarding: true
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (profile.plan_type === 'pro') {
Â  Â  Â  Â  Â  Â  Â  Â  const { data: additionalGoals, error: goalsError } = await supabase.from('obiettivi').select('*').eq('user_id', user.id);
Â  Â  Â  Â  Â  Â  Â  Â  if (goalsError) throw goalsError;
Â  Â  Â  Â  Â  Â  Â  Â  if (additionalGoals) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allGoals.push(...additionalGoals.map(g => ({ ...g, is_onboarding: false })));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  goalsData = allGoals;
Â  Â  Â  Â  Â  Â  renderGoalsUI(allGoals, profile);

Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  console.error('[Goals] Errore caricamento:', err);
Â  Â  Â  Â  Â  Â  goalsList.innerHTML = `<div class="goal-card"><p class="error">Impossibile caricare gli obiettivi.</p></div>`;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function renderGoalsUI(goals, profile) {
Â  Â  Â  Â  goalsList.innerHTML = '';
Â  Â  Â  Â  const isPro = profile && profile.plan_type === 'pro';
Â  Â  Â  Â  const isPlanLimited = profile && (profile.plan_type === 'starter' || profile.plan_type === 'plus');

Â  Â  Â  Â  const header = document.querySelector('#goals-section .header');
Â  Â  Â  Â  let addBtn = document.getElementById('add-goal-btn');

Â  Â  Â  Â  if (!addBtn) {
Â  Â  Â  Â  Â  Â  addBtn = document.createElement('button');
Â  Â  Â  Â  Â  Â  addBtn.id = 'add-goal-btn';
Â  Â  Â  Â  Â  Â  addBtn.className = 'btn btn-primary';
Â  Â  Â  Â  Â  Â  addBtn.style.cssText = 'display: none; padding: 6px 12px; font-size: 0.9rem;';
Â  Â  Â  Â  Â  Â  addBtn.textContent = '+ Aggiungi';
Â  Â  Â  Â  Â  Â  header.appendChild(addBtn);
Â  Â  Â  Â  }

Â  Â  Â  Â  if (isPro) {
Â  Â  Â  Â  Â  Â  addBtn.style.display = 'block';
Â  Â  Â  Â  Â  Â  addBtn.onclick = handleAddGoal;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  addBtn.style.display = 'none';
Â  Â  Â  Â  Â  Â  addBtn.onclick = null;
Â  Â  Â  Â  }

Â  Â  Â  Â  if (goals.length === 0) {
Â  Â  Â  Â  Â  Â  Â goalsList.innerHTML = `<div class="goal-card"><div class="goal-title">ğŸ¯ <span>Obiettivo non impostato</span></div><p class="goal-subtitle">Non hai ancora configurato un obiettivo. Fallo ora per iniziare!</p><div class="goal-confirm" style="text-align:left;"><a class="btn btn-primary" href="/it/onboarding.html">Configura Obiettivo</a></div></div>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  goals.forEach(goal => {
Â  Â  Â  Â  Â  Â  Â  Â  const canDelete = goals.length > 1;
Â  Â  Â  Â  Â  Â  Â  Â  goalsList.insertAdjacentHTML('beforeend', createGoalCardHTML(goal, canDelete, isPlanLimited));
Â  Â  Â  Â  Â  Â  Â  Â  bindGoalEditor(goal);
Â  Â  Â  Â  Â  Â  Â  Â  updateGoalProgress(goal.id, goal.is_onboarding);Â 
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function createGoalCardHTML(goal, canDelete, isPlanLimited) {
Â  Â  Â  Â  const id = goal.id;
Â  Â  Â  Â  const targetAmountHTML = goal.importo_target ? ` / <strong>${fmt(goal.importo_target)}â‚¬</strong>` : '';
Â  Â  Â  Â  const titleSafe = escapeHTML(goal.nome_obiettivo);
Â  Â  Â  Â  const currentAmount = goal.current_amount || 0;
Â  Â  Â  Â  const targetAmount = goal.importo_target || 0;
Â  Â  Â  Â  const progressPercent = targetAmount > 0 ? Math.min((currentAmount / targetAmount) * 100, 100) : 0;

Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  <div id="goal-card-${id}" class="goal-card-compressed">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="goal-card-header-compressed" onclick="toggleGoalCard('${id}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="goal-info-compressed">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="goal-icon-compressed">ğŸ¯</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="goal-details-compressed">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4>${titleSafe}</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="goal-progress-compressed">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â‚¬${fmt(currentAmount)}${targetAmountHTML} (${progressPercent.toFixed(1)}%)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="goal-expand-arrow" id="goal-arrow-${id}">â–¼</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div class="goal-card-content-compressed" id="goal-content-${id}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="goal-card-content-inner">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="goal-editor">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="editor-group method-selector">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h5>SELEZIONE METODO</h5>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="method-chips">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="method-btn-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="chip method-btn" role="button" data-method="fixed" aria-pressed="false">CIFRA FISSA</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="method-input">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="arrow-down"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" step="0.01" class="goal-amount-input" data-method="fixed" readonly inputmode="decimal">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="method-btn-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="chip method-btn" role="button" data-method="variable" aria-pressed="false">CIFRA VARIABILE</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="method-input">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="arrow-down"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" step="0.01" class="goal-amount-input" data-method="variable" readonly inputmode="decimal">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="method-btn-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="chip method-btn" role="button" data-method="percent_income" aria-pressed="false">% ENTRATE</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="method-input">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="arrow-down"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number" step="0.1" class="goal-percentage-input" data-method="percent_income" readonly inputmode="decimal">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="editor-group quota-editor">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h5>QUOTA OBIETTIVO</h5>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="quota-display">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="quota-value">0,00â‚¬</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="quota-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-secondary edit-btn">MODIFICA</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-primary save-btn" style="display:none;">SALVA</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="goal-card-footer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="goal-progress-bar-container">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-info">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>Progresso</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="progress-amount-${id}">0.00â‚¬${targetAmountHTML}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-bar-enhanced">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-bar-fill" id="progress-bar-${id}" style="width:0%; background: var(--grad);"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="goal-main-actions">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-secondary view-savings-btn" data-id="${id}">MODIFICA RISPARMI</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-primary record-saving-btn" data-id="${id}" data-amount="${goal.importo_mensile}">REGISTRA RISPARMIO</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // Enhanced Functions for UX Improvements
Â  Â Â 
Â  Â  // Deadline Management Functions
Â  Â  async function handlePayDeadline(transactionId) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const { error } = await supabase
Â  Â  Â  Â  Â  Â  Â  Â  .from('transactions')
Â  Â  Â  Â  Â  Â  Â  Â  .update({ is_paid: true })
Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', transactionId);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  showStatusMessage('Scadenza pagata!', 'success');
Â  Â  Â  Â  Â  Â  loadAllDataForMonth(); // Refresh data
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error('Errore nel pagare la scadenza:', error);
Â  Â  Â  Â  Â  Â  showStatusMessage('Errore nel pagare la scadenza', 'error');
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  function handleEditDeadline(transactionId) {
Â  Â  Â  Â  // Find transaction in allTransactions and populate form
Â  Â  Â  Â  const transaction = allTransactions.find(tx => tx.id === transactionId);
Â  Â  Â  Â  if (!transaction) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Populate form fields
Â  Â  Â  Â  document.getElementById('transaction-id').value = transaction.id;
Â  Â  Â  Â  document.getElementById('kind').value = transaction.kind;
Â  Â  Â  Â  document.getElementById('note').value = transaction.note || '';
Â  Â  Â  Â  document.getElementById('amount').value = transaction.amount;
Â  Â  Â  Â  document.getElementById('occurred_at').value = transaction.occurred_at;
Â  Â  Â  Â  document.getElementById('due_date').value = transaction.due_date;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Set transaction type to scheduled
Â  Â  Â  Â  document.querySelector('input[name="transaction_type"][value="scheduled"]').checked = true;
Â  Â  Â  Â  document.querySelector('input[name="transaction_type"][value="scheduled"]').closest('label').classList.add('selected');
Â  Â  Â  Â  document.querySelectorAll('.operation-type-option').forEach(opt => {
Â  Â  Â  Â  Â  Â  if (!opt.querySelector('input[value="scheduled"]')) opt.classList.remove('selected');
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Show scheduled options
Â  Â  Â  Â  document.getElementById('due-date-options').style.display = 'grid';
Â  Â  Â  Â  document.getElementById('recurring-options').style.display = 'none';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Update category dropdown and select current category
Â  Â  Â  Â  updateCategoryDropdown();
Â  Â  Â  Â  if (transaction.category_id) {
Â  Â  Â  Â  Â  Â  document.getElementById('category_id').value = transaction.category_id;
Â  Â  Â  Â  Â  Â  updateSubcategories(transaction.subcategory_id);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Update form UI for editing
Â  Â  Â  Â  document.getElementById('form-title').textContent = 'Modifica Scadenza';
Â  Â  Â  Â  document.getElementById('submit-btn').textContent = 'ğŸ’¾ Salva Modifiche';
Â  Â  Â  Â  document.getElementById('cancel-edit-btn').style.display = 'block';
Â  Â  Â  Â  document.getElementById('form-buttons-container').classList.add('is-editing');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Scroll to form
Â  Â  Â  Â  document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
Â  Â  }
Â  Â Â 
Â  Â  async function handleDeleteDeadline(transactionId) {
Â  Â  Â  Â  if (!confirm('Sei sicuro di voler eliminare questa scadenza?')) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const { error } = await supabase
Â  Â  Â  Â  Â  Â  Â  Â  .from('transactions')
Â  Â  Â  Â  Â  Â  Â  Â  .delete()
Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', transactionId);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  showStatusMessage('Scadenza eliminata!', 'success');
Â  Â  Â  Â  Â  Â  loadAllDataForMonth(); // Refresh data
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error('Errore nell\'eliminare la scadenza:', error);
Â  Â  Â  Â  Â  Â  showStatusMessage('Errore nell\'eliminare la scadenza', 'error');
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // Goal Management Functions
Â  Â  function toggleGoalCard(goalId) {
Â  Â  Â  Â  const content = document.getElementById(`goal-content-${goalId}`);
Â  Â  Â  Â  const arrow = document.getElementById(`goal-arrow-${goalId}`);
Â  Â  Â  Â  const header = content.previousElementSibling;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const isExpanded = content.classList.contains('expanded');
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (isExpanded) {
Â  Â  Â  Â  Â  Â  content.classList.remove('expanded');
Â  Â  Â  Â  Â  Â  arrow.classList.remove('expanded');
Â  Â  Â  Â  Â  Â  header.classList.remove('expanded');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  content.classList.add('expanded');
Â  Â  Â  Â  Â  Â  arrow.classList.add('expanded');
Â  Â  Â  Â  Â  Â  header.classList.add('expanded');
Â  Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  // Financial Summary Animations
Â  Â  function animateFinancialSummary() {
Â  Â  Â  Â  const totalIncome = allTransactions
Â  Â  Â  Â  Â  Â  .filter(tx => tx.kind === 'income' && tx.is_paid !== false)
Â  Â  Â  Â  Â  Â  .reduce((sum, tx) => sum + safeToNumber(tx.amount), 0);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const totalExpense = allTransactions
Â  Â  Â  Â  Â  Â  .filter(tx => tx.kind === 'expense' && tx.is_paid !== false)
Â  Â  Â  Â  Â  Â  .reduce((sum, tx) => sum + safeToNumber(tx.amount), 0);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const balance = totalIncome - totalExpense;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Animate counters
Â  Â  Â  Â  animateCounter('total-income-animated', totalIncome, 'â‚¬');
Â  Â  Â  Â  animateCounter('total-expense-animated', totalExpense, 'â‚¬');
Â  Â  Â  Â  animateCounter('balance-animated', balance, 'â‚¬', balance >= 0 ? 'income' : 'expense');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Update goals count
Â  Â  Â  Â  const goalsCount = document.getElementById('goals-count');
Â  Â  Â  Â  if (goalsCount) goalsCount.textContent = goalsData.length;
Â  Â  }
Â  Â Â 
Â  Â  function animateCounter(elementId, targetValue, prefix = '', className = '') {
Â  Â  Â  Â  const element = document.getElementById(elementId);
Â  Â  Â  Â  if (!element) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const duration = 1500;
Â  Â  Â  Â  const steps = 60;
Â  Â  Â  Â  const stepValue = targetValue / steps;
Â  Â  Â  Â  let currentValue = 0;
Â  Â  Â  Â  let currentStep = 0;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const timer = setInterval(() => {
Â  Â  Â  Â  Â  Â  currentStep++;
Â  Â  Â  Â  Â  Â  currentValue += stepValue;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (currentStep >= steps) {
Â  Â  Â  Â  Â  Â  Â  Â  currentValue = targetValue;
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(timer);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  element.textContent = `${prefix}${fmt(currentValue)}`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (className) {
Â  Â  Â  Â  Â  Â  Â  Â  element.className = `summary-stat-value ${className}`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, duration / steps);
Â  Â  }
Â  Â Â 
Â  Â  function bindGoalEditor(goal) {
Â  Â  Â  Â  const id = goal.id;
Â  Â  Â  Â  const card = document.getElementById(`goal-card-${id}`);
Â  Â  Â  Â  if (!card) return;

Â  Â  Â  Â  const methodChips = card.querySelectorAll('.method-btn');
Â  Â  Â  Â  const amountInputs = card.querySelectorAll('.goal-amount-input, .goal-percentage-input');
Â  Â  Â  Â  const quotaValueEl = card.querySelector('.quota-value');
Â  Â  Â  Â  const editBtn = card.querySelector('.edit-btn');
Â  Â  Â  Â  const saveBtn = card.querySelector('.save-btn');
Â  Â  Â  Â  const recordBtn = card.querySelector('.record-saving-btn');
Â  Â  Â  Â Â 
Â  Â  Â  Â  let currentMethod = mapContributionMethodToInternal(goal.metodo_contribuzione);
Â  Â  Â  Â  let isEditing = false;

Â  Â  Â  Â  function computeQuota(method, amountOrPercent){
Â  Â  Â  Â  Â  const totalIncomes = allTransactions
Â  Â  Â  Â  Â  Â  .filter(tx => tx.kind === 'income' && tx.is_paid !== false)
Â  Â  Â  Â  Â  Â  .reduce((s, tx) => s + safeToNumber(tx.amount), 0);
Â  Â  Â  Â  Â  if (method === 'percent_income') {
Â  Â  Â  Â  Â  Â  return (safeToNumber(amountOrPercent) / 100) * totalIncomes;
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  return safeToNumber(amountOrPercent);
Â  Â  Â  Â  }

Â  Â  Â  Â  function refreshQuotaPreview(){
Â  Â  Â  Â  Â  const activeInput = Array.from(amountInputs).find(i => i.dataset.method === currentMethod);
Â  Â  Â  Â  Â  const raw = activeInput?.value ?? goal.importo_mensile;
Â  Â  Â  Â  Â  const numeric = safeToNumber(String(raw).replace(',', '.'));
Â  Â  Â  Â  Â  const q = computeQuota(currentMethod, numeric);
Â  Â  Â  Â  Â  quotaValueEl.textContent = `${fmt(q)}â‚¬`;
Â  Â  Â  Â  Â  recordBtn.dataset.amount = q;
Â  Â  Â  Â  }

Â  Â  Â  Â  const updateUI = () => {
Â  Â  Â  Â  Â  Â  card.classList.toggle('is-locked', !isEditing);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  methodChips.forEach(chip => {
Â  Â  Â  Â  Â  Â  Â  Â  const method = chip.dataset.method;
Â  Â  Â  Â  Â  Â  Â  Â  const isActive = method === currentMethod;
Â  Â  Â  Â  Â  Â  Â  Â  chip.classList.toggle('is-active', isActive);
Â  Â  Â  Â  Â  Â  Â  Â  chip.setAttribute('aria-pressed', String(isActive));
Â  Â  Â  Â  Â  Â  Â  Â  chip.setAttribute('aria-disabled', String(!isEditing && !isActive));
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  amountInputs.forEach(input => {
Â  Â  Â  Â  Â  Â  Â  Â  input.readOnly = !isEditing;
Â  Â  Â  Â  Â  Â  Â  Â  const inputMethod = input.dataset.method;
Â  Â  Â  Â  Â  Â  Â  Â  if(inputMethod === currentMethod) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â input.value = goal.importo_mensile || '';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  editBtn.style.display = isEditing ? 'none' : 'block';
Â  Â  Â  Â  Â  Â  saveBtn.style.display = isEditing ? 'block' : 'none';
Â  Â  Â  Â  Â  Â  refreshQuotaPreview();
Â  Â  Â  Â  };

Â  Â  Â  Â  methodChips.forEach(chip => {
Â  Â  Â  Â  Â  Â  chip.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (isEditing) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentMethod = chip.dataset.method;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateUI();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  amountInputs.forEach(inp=>{
Â  Â  Â  Â  Â  inp.addEventListener('input', ()=>{
Â  Â  Â  Â  Â  Â  if(!isEditing) return;
Â  Â  Â  Â  Â  Â  refreshQuotaPreview();
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });

Â  Â  Â  Â  editBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  isEditing = true;
Â  Â  Â  Â  Â  Â  updateUI();
Â  Â  Â  Â  });

Â  Â  Â  Â  saveBtn.addEventListener('click', async () => {
Â  Â  Â  Â  Â  Â  isEditing = false;

Â  Â  Â  Â  Â  Â  const activeInput = Array.from(amountInputs).find(i => i.dataset.method === currentMethod);
Â  Â  Â  Â  Â  Â  const newAmount = safeToNumber(String(activeInput?.value ?? goal.importo_mensile).replace(',', '.'));

Â  Â  Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  Â  Â  Â  [goal.is_onboarding ? 'contribution_method' : 'metodo_contribuzione']: mapInternalToContributionMethod(currentMethod),
Â  Â  Â  Â  Â  Â  Â  Â  [goal.is_onboarding ? 'contribution_amount' : 'importo_mensile']: newAmount,
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  const table = goal.is_onboarding ? 'profiles' : 'obiettivi';
Â  Â  Â  Â  Â  Â  const { error } = await supabase
Â  Â  Â  Â  Â  Â  Â  Â  .from(table)
Â  Â  Â  Â  Â  Â  Â  Â  .update(payload)
Â  Â  Â  Â  Â  Â  Â  Â  .eq('id', goal.is_onboarding ? user.id : goal.id);

Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  showModal('Errore', `Impossibile salvare le modifiche. Dettaglio: ${error.message}`, [{text:'Chiudi'}]);
Â  Â  Â  Â  Â  Â  Â  Â  isEditing = true;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  showStatusMessage('Obiettivo aggiornato!', 'success');
Â  Â  Â  Â  Â  Â  Â  Â  const idx = goalsData.findIndex(g => String(g.id) === String(id));
Â  Â  Â  Â  Â  Â  Â  Â  if(idx > -1) {
Â  Â  Â  Â  Â  Â  Â  Â 
