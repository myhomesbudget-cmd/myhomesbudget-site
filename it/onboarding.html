<!doctype html>
<html lang="it" data-app="myhomesbudget">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Configurazione Iniziale — MyHomesBudget</title>
  <style>
    /* CSS è quasi identico, con l'aggiunta di .category-columns */
    :root{--fg:#111;--glass:rgba(255,255,255,.58);--card-border:rgba(0,0,0,.08);--shadow:0 10px 30px rgba(0,0,0,.10);--radius-lg:16px;--primary-color:#6c5ce7;}
    *{box-sizing:border-box}
    html,body{font-family:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif}
    a:focus-visible,button:focus-visible,input:focus-visible{outline:2px solid #00cec9; outline-offset:2px; border-radius:8px}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    body{margin:0;color:#fff;background:url("/bg.webp") no-repeat center/cover fixed;min-height:100vh;display:flex;flex-direction:column;align-items:center;}
    body::before{content:"";position:fixed;inset:0;background:rgba(0,0,0,.08);z-index:-1}
    .topbar{position:fixed;top:16px;left:50%;transform:translateX(-50%);width:min(920px,calc(100% - 40px));z-index:20;pointer-events:none;display:flex;align-items:center;justify-content:space-between;}
    .logo-link,.top-actions{pointer-events:auto}
    .logo-link{display:flex;align-items:center;gap:8px;text-decoration:none}
    .logo-image{height:32px;border-radius:6px}
    .logo-text{font-weight:600;color:#fff;font-size:1.05rem;text-shadow:0 1px 2px rgba(0,0,0,.35)}
    .top-actions{display:flex;gap:8px;align-items:center}
    .logout-link{color:#fff;text-decoration:none;padding:6px 10px;border-radius:10px;background:rgba(0,0,0,.28); border:1px solid rgba(255,255,255,.25);}
    .logout-link:hover{background:rgba(0,0,0,.38)}
    main.panel{margin-top:84px;width:min(920px,calc(100% - 40px));background:var(--glass); color:var(--fg); border-radius:var(--radius-lg);padding:clamp(18px,4vw,22px); box-shadow:var(--shadow);display:flex;flex-direction:column;gap:16px;}
    .panel-header{background:rgba(255,255,255,.55);border-radius:12px;padding:14px;border:1px solid var(--card-border)}
    .progress-bar{width:100%;height:8px;background:rgba(0,0,0,.1);border-radius:4px;overflow:hidden}
    .progress-bar-inner{width:0%;height:100%;background:#6c5ce7;transition:width .4s ease}
    .step-indicator{font-size:.9rem;font-weight:600;color:#555;margin-top:8px;text-align:right}
    .step{display:none}
    .step.is-active{display:block;animation:fadeIn .45s ease}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    .step-title{text-align:center;margin:6px 0 8px;font-size:clamp(1.5rem,4vw,1.8rem);color:#111}
    .step-description{text-align:center;color:#333;margin:0 auto 16px;max-width:520px}
    .form-group{margin-bottom:16px}
    .options-grid{display:grid;gap:12px}
    /* NUOVI STILI PER LE COLONNE */
    .category-columns {display: grid; gap: 24px;}
    @media(min-width: 768px) { .category-columns {grid-template-columns: 1fr 1fr;} }
    .column h3 { text-align: center; margin-top: 0; }

    .option-label{display:block;padding:14px;border:2px solid transparent;border-radius:10px;background:rgba(255,255,255,.6);transition:.18s ease;cursor:pointer}
    .option-label:hover{background:#fff}
    input[type="radio"],input[type="checkbox"]{position:absolute;opacity:0;width:1px;height:1px}
    input[type="radio"]:checked + .option-label,
    input[type="checkbox"]:checked + .option-label{border-color:#6c5ce7;background:#fff}
    .option-label strong{display:block;font-size:1.05rem}
    .option-label span{font-size:.92rem;color:#444}
    .error-message{color:#842029;background:#f8d7da;border:1px solid #f5c2c7;border-radius:8px;padding:8px 10px;font-weight:600;text-align:center;display:none}
    .error-message.show{display:block}
    .panel-footer{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .btn{cursor:pointer;border:none;border-radius:12px;padding:12px 16px;font-weight:800}
    .btn-primary{background:#6c5ce7;color:#fff;box-shadow:0 8px 22px rgba(0,0,0,.14)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>
  <nav class="topbar" aria-label="Barra superiore">
    <a href="/it/" class="logo-link" title="MyHomesBudget"><img src="/homes.png" alt="Logo" class="logo-image"><span class="logo-text">MyHomesBudget</span></a>
    <div class="top-actions"><a href="#" id="logout-btn" class="logout-link">Esci</a></div>
  </nav>

  <main class="panel">
    <div class="panel-header"><div class="progress-bar" role="progressbar"><div class="progress-bar-inner"></div></div><div id="step-indicator" class="step-indicator"></div></div>
    <section id="step-1" class="step is-active" data-step="1">...</section>
    <section id="step-2" class="step" data-step="2">...</section>

    <section id="step-3" class="step" data-step="3" aria-describedby="s3d">
      <h1 class="step-title">Scegli le tue categorie</h1>
      <p id="s3d" class="step-description">Seleziona le voci di entrata e uscita che usi più spesso. Potrai sempre modificarle in seguito.</p>
      <fieldset class="form-group">
        <legend class="sr-only">Scegli le categorie</legend>
        <div class="category-columns">
          <div class="column">
            <h3>Entrate</h3>
            <div id="income-category-options" class="options-grid">
              </div>
          </div>
          <div class="column">
            <h3>Uscite</h3>
            <div id="expense-category-options" class="options-grid">
              </div>
          </div>
        </div>
      </fieldset>
    </section>
    
    <div id="error" class="error-message"></div>
    <div class="panel-footer"><button id="back-btn" class="btn btn-secondary">Indietro</button><button id="next-btn" class="btn btn-primary">Avanti</button></div>
  </main>
  
  <script type="module">
    import { supabase } from "/it/supabase-client.js";

    const TOTAL_STEPS = 3;
    const backBtn = document.getElementById('back-btn');
    const nextBtn = document.getElementById('next-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const errorBox = document.getElementById('error');
    const steps = document.querySelectorAll('.step');
    let currentStep = 1;
    const state = { goal: null, saving_method: null, categories: [] };

    // --- FUNZIONI ---

    /**
     * NUOVA FUNZIONE: Carica le categorie DI DEFAULT dal database e le mostra in due colonne.
     */
    async function populateCategoriesFromDB() {
      const incomeContainer = document.getElementById('income-category-options');
      const expenseContainer = document.getElementById('expense-category-options');

      // Se i contenitori sono già pieni, non fare nulla
      if (incomeContainer.childElementCount > 0 || expenseContainer.childElementCount > 0) {
        return;
      }

      const { data: defaultCategories, error } = await supabase
        .from('default_categories')
        .select('name, icon, kind')
        .order('id');
      
      if (error) {
        console.error("Errore caricamento categorie di default:", error);
        showError("Impossibile caricare le categorie.");
        return;
      }

      // Svuota i contenitori prima di popolarli
      incomeContainer.innerHTML = '';
      expenseContainer.innerHTML = '';
      
      defaultCategories.forEach((cat, i) => {
        const id = 'cat-' + i;
        const w = document.createElement('div');
        w.innerHTML = `
          <input type="checkbox" id="${id}" name="category" value='${JSON.stringify(cat)}'>
          <label for="${id}" class="option-label"><strong>${cat.icon} ${cat.name}</strong></label>
        `;

        // Aggiunge l'elemento alla colonna giusta in base al 'kind'
        if (cat.kind === 'income') {
          incomeContainer.appendChild(w);
        } else { // expense e transfer vanno nelle uscite per semplicità visiva
          expenseContainer.appendChild(w);
        }
      });
    }

    // --- Il resto delle funzioni (renderStep, validateAndUpdateState, saveOnboarding...)
    // --- rimane identico a prima, non serve modificarlo.
    // --- La funzione `initializePage` è l'unica altra da aggiornare.

    async function initializePage() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) { location.replace(itPrefix() + "login.html"); return; }
      
      const { data: profile, error: pError } = await supabase.from('profiles').select('*').eq('id', user.id).single();
      const { data: userCategories, error: cError } = await supabase.from('categories').select('*').eq('created_by', user.id);
      if (pError || cError) { showError("Impossibile caricare i dati."); return; }

      const isEditing = new URLSearchParams(location.search).get('edit') === '1';
      if (profile.onboarded && !isEditing) { location.replace(itPrefix() + "dashboard.html"); return; }

      state.goal = profile.onboarding_goal;
      state.saving_method = profile.onboarding_saving_method;
      state.categories = userCategories.map(c => ({ name: c.name, icon: c.icon, kind: c.kind }));
      
      // La nuova funzione per popolare le categorie
      await populateCategoriesFromDB();
      
      // Pre-seleziona i checkbox in base allo stato
      const selectedNames = state.categories.map(c => c.name);
      document.querySelectorAll('input[name="category"]').forEach(checkbox => {
          const catObj = JSON.parse(checkbox.value);
          if (selectedNames.includes(catObj.name)) {
              checkbox.checked = true;
          }
      });
      // (Il resto della pre-selezione per goal e method è invariato...)

      // Il resto della funzione rimane invariato
    }
    
    // Assicurati di includere le altre funzioni (renderStep, validateAndUpdateState, saveOnboarding, etc.)
    // che avevamo definito nel codice precedente.
    document.addEventListener('DOMContentLoaded', initializePage);

  </script>
</body>
</html>
