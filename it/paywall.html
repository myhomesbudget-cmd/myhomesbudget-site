<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fine Periodo di Prova — MyHomesBudget</title>
  <meta name="description" content="Il tuo periodo di prova è terminato. Scegli un piano per continuare a usare MyHomesBudget senza limiti.">
  <meta name="robots" content="noindex, nofollow">
  <meta name="color-scheme" content="light dark">

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
                 img-src 'self' https: data:;
                 style-src 'self' 'unsafe-inline';
                 script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com;
                 connect-src 'self' https://www.google-analytics.com https://region1.google-analytics.com;
                 font-src 'self' https: data:;
                 frame-ancestors 'none';
                 base-uri 'self';
                 form-action 'self'">

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-LSD3V9G957"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-LSD3V9G957', { anonymize_ip: true });
  </script>

  <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
  <link rel="preconnect" href="https://www.google-analytics.com" crossorigin>
  <link rel="icon" href="/favicon.ico">

  <style>
    :root{
      --fg:#111; --glass:rgba(255,255,255,.58); --glass-strong:rgba(255,255,255,.68);
      --card-border:rgba(0,0,0,.06); --shadow:0 10px 30px rgba(0,0,0,.10);
      --radius-lg:16px; --radius-md:12px; --grad:linear-gradient(135deg,#6c5ce7,#00cec9);
    }
    *{box-sizing:border-box}
    html, body { font-family:-apple-system,system-ui,"Segoe UI",Roboto,sans-serif }
    h1,h2,h3,h4,p,a,small,strong,button{font-family:inherit}
    a:focus-visible,button:focus-visible{outline:2px solid #00cec9; outline-offset:2px; border-radius:8px}

    body{
      margin:0; color:#fff; background:url("/bg.webp") no-repeat center center / cover fixed;
      min-height:100vh; display:flex; align-items:center; justify-content:center;
    }
    body::before{content:""; position:fixed; inset:0; background:rgba(0,0,0,.08); z-index:-1}

    /* Topbar allineata alla larghezza del pannello */
    .topbar{
      position:fixed; top:16px; left:50%; transform:translateX(-50%);
      width:min(920px, calc(100% - 40px)); z-index:20; pointer-events:none;
      display:flex; justify-content:flex-start;
    }
    .logo-link{display:flex; align-items:center; gap:8px; text-decoration:none; pointer-events:auto}
    .logo-image{height:32px}
    .logo-text{font-weight:600; color:#fff; font-size:1.05rem; text-shadow:0 1px 2px rgba(0,0,0,.35)}
    .logo-link:hover .logo-text{filter:brightness(1.06)}

    .paywall-panel{
      width:min(920px, calc(100% - 40px)); background:var(--glass);
      backdrop-filter:saturate(1.1) blur(8px); -webkit-backdrop-filter:saturate(1.1) blur(5px);
      color:var(--fg); border-radius:var(--radius-lg); padding:clamp(18px,4vw,26px); box-shadow:var(--shadow);
    }

    .header{text-align:center; margin-bottom:16px}
    .header h1{margin:0; color:#111; font-size:clamp(1.8rem,4.6vw,2.2rem); text-shadow:0 1px 3px rgba(0,0,0,.35)}
    .header p{margin:8px 0 0; color:#111; font-weight:600; font-size:clamp(1rem,2.4vw,1.08rem)}
    .header p::after{content:""; display:block; width:120px; height:2px; margin:10px auto 0; border-radius:999px; background:linear-gradient(90deg,#6c5ce7,#00cec9); opacity:.7}

    .plans{
      background:var(--glass-strong); border:1px solid var(--card-border); border-radius:var(--radius-lg);
      padding:14px; box-shadow:inset 0 0 0 1px rgba(0,0,0,.02);
      display:grid; grid-template-columns:1fr 1fr; gap:14px; margin:14px 0 18px;
    }
    @media(max-width:680px){ .plans{ grid-template-columns:1fr } }

    .price-card{
      background:rgba(255,255,255,.52); border:1px solid var(--card-border); border-radius:var(--radius-md);
      padding:16px; text-align:center; box-shadow:var(--shadow);
      display:flex; flex-direction:column; gap:12px; justify-content:center;
    }
    .plan-title{margin:0; display:flex; gap:.5rem; flex-wrap:wrap; align-items:baseline; justify-content:center; font-size:1.08rem}
    .plan-name{font-weight:700} .sep{opacity:.45}
    .price-inline{font-weight:800; font-size:1.2rem; line-height:1}
    .price-inline small{font-weight:600; font-size:.9rem; color:#333}

    .cta-group{display:flex; flex-direction:column; gap:8px}
    .btn{
      display:flex; align-items:center; justify-content:center; gap:.5rem;
      padding:11px 14px; border-radius:12px; font-weight:700; text-decoration:none;
      box-shadow:0 8px 22px rgba(0,0,0,.14); transition:transform .15s ease, filter .15s ease;
      color:#fff; background:var(--grad); text-shadow:0 1px 0 rgba(0,0,0,.18);
    }
    .btn:hover{filter:brightness(1.07); transform:translateY(-1px)} .btn:is(:active){transform:translateY(0)}

    .secure{
      width:fit-content; margin:8px auto 0; padding:6px 12px; display:flex; align-items:center; gap:8px;
      color:#111; font-weight:600; border-radius:999px;
      background:linear-gradient(var(--glass-strong),var(--glass-strong)) padding-box,
                 linear-gradient(90deg,#6c5ce7,#00cec9) border-box;
      border:1px solid transparent; box-shadow:var(--shadow);
    }
    .secure svg{flex:0 0 16px; color:#6c5ce7; opacity:.95}

    .faq{margin-top:16px; padding-top:0; color:#222; position:relative; border-top:none}
    .faq::before{content:""; display:block; height:2px; margin:14px 0 16px; border-radius:999px; background:linear-gradient(90deg,#6c5ce7,#00cec9); opacity:.85}
    .faq h3{text-align:center; margin:0 0 10px}
    .faq-item{padding:8px 0; border-bottom:1px solid rgba(0,0,0,.06)}
    .faq-item:last-child{border-bottom:none}
    .faq-item strong{color:#111}
    .faq-item p{margin:4px 0 0; color:#444}

    .login{margin-top:14px; background:rgba(255,255,255,.45); border:1px solid var(--card-border); border-radius:12px; padding:12px; text-align:center; color:#222}
    .login a{font-weight:700; text-decoration:none; background:var(--grad); -webkit-background-clip:text; background-clip:text; color:transparent}
    .login a:hover{text-decoration:underline}

    .reveal{opacity:0; transform:translateY(16px); transition:opacity .8s ease, transform .8s cubic-bezier(.22,1,.36,1)}
    .reveal.in{opacity:1; transform:none}
    @media (prefers-reduced-motion:reduce){ .reveal,.reveal.in{transition:none; opacity:1; transform:none} }
  </style>
</head>
<body>

  <!-- Logo allineato al pannello -->
  <nav class="topbar" aria-label="Logo">
    <a href="/it/" class="logo-link" title="myHomesBudget">
      <img src="/homes.png" alt="Logo MyHomesBudget" class="logo-image" loading="lazy">
      <span class="logo-text">MyHomesBudget</span>
    </a>
  </nav>

  <main class="paywall-panel">
    <header class="header reveal">
      <h1>Il tuo periodo di prova è terminato</h1>
      <p>Continua a usare MyHomesBudget senza limiti scegliendo un piano.</p>
    </header>

    <section class="plans reveal" aria-label="Piani disponibili">
      <article class="price-card" aria-label="Piano Mensile 2,99 euro al mese">
        <h2 class="plan-title">
          <span class="plan-name">Piano Mensile</span>
          <span class="sep">—</span>
          <span class="price-inline">2,99€ <small>/ mese</small></span>
        </h2>
        <div class="cta-group">
          <a class="btn" href="/checkout/stripe?plan=monthly&utm_source=paywall" data-plan="monthly" data-method="stripe">Paga con Stripe</a>
          <a class="btn" href="/checkout/paypal?plan=monthly&utm_source=paywall" data-plan="monthly" data-method="paypal">Paga con PayPal</a>
        </div>
      </article>

      <article class="price-card" aria-label="Una Tantum 19,99 euro per sempre">
        <h2 class="plan-title">
          <span class="plan-name">Una Tantum</span>
          <span class="sep">—</span>
          <span class="price-inline">19,99€ <small>/ per sempre</small></span>
        </h2>
        <div class="cta-group">
          <a class="btn" href="/checkout/stripe?plan=lifetime&utm_source=paywall" data-plan="lifetime" data-method="stripe">Paga con Stripe</a>
          <a class="btn" href="/checkout/paypal?plan=lifetime&utm_source=paywall" data-plan="lifetime" data-method="paypal">Paga con PayPal</a>
        </div>
      </article>
    </section>

    <div class="secure reveal" aria-hidden="true">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" focusable="false" aria-hidden="true"><path d="M12 1a5 5 0 0 1 5 5v3h1a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h1V6a5 5 0 0 1 5-5Zm3 8V6a3 3 0 0 0-6 0v3h6Z"/></svg>
      Pagamenti sicuri con Stripe e PayPal
    </div>

    <section class="faq reveal" aria-labelledby="faq-title">
      <h3 id="faq-title">Domande rapide</h3>
      <div class="faq-item">
        <strong>Cosa succede ai dati che ho inserito?</strong>
        <p>I tuoi dati restano al sicuro e si sbloccano subito dopo l’attivazione. Non cancelliamo nulla.</p>
      </div>
      <div class="faq-item">
        <strong>Quali metodi di pagamento accettate?</strong>
        <p>Carta tramite Stripe e pagamenti con conto PayPal. Tutte le transazioni sono sicure.</p>
      </div>
      <div class="faq-item">
        <strong>Posso cancellare il piano mensile quando voglio?</strong>
        <p>Sì, in qualsiasi momento. Continui ad avere accesso fino a fine periodo già pagato.</p>
      </div>
    </section>

    <p class="login reveal">Hai già un abbonamento attivo? <a href="/it/login.html">Accedi qui</a></p>
  </main>

  <script>
    // salva lingua corrente per i prossimi redirect
    try { localStorage.setItem('mhb_lang','it'); } catch(e) {}

    // GA4
    gtag('event','paywall_viewed');

    // Tracciamento checkout
    document.querySelectorAll('a[data-plan][data-method]').forEach(a=>{
      a.addEventListener('click', ()=>{
        gtag('event','checkout_started',{
          plan:a.dataset.plan, payment_method:a.dataset.method, source:'paywall'
        });
      });
    });

    // Reveal top→bottom
    (function(){
      const els=document.querySelectorAll('.reveal');
      if (matchMedia('(prefers-reduced-motion: reduce)').matches){ els.forEach(e=>e.classList.add('in')); return; }
      const ordered=[...els].map(el=>({el,r:el.getBoundingClientRect()}))
        .sort((a,b)=>(a.r.top-b.r.top)||(a.r.left-b.r.left)).map(x=>x.el);
      ordered.forEach((el,i)=> el.style.transitionDelay=(i*0.10)+'s');
      requestAnimationFrame(()=> ordered.forEach(el=> el.classList.add('in')));
    })();
  </script>

  <!-- ✅ AGGIUNTA MINIMA: reindirizzo a Stripe Checkout via Edge Function -->
  <script type="module">
    // Mappa dei prezzi Stripe (forniti da te)
    const PRICES = {
      monthly:  { priceId: "price_1S46IVDB9gH9Ve2rhOcxHGDZ", mode: "subscription" },
      lifetime: { priceId: "price_1S46TQDB9gH9Ve2r5KHZVoTA", mode: "payment" }
    };

    // Intercetta solo i bottoni "Paga con Stripe" (lascia intatti i link PayPal)
    document.querySelectorAll('a[data-method="stripe"][data-plan]').forEach(link => {
      link.addEventListener('click', async (ev) => {
        ev.preventDefault(); // evita la navigazione al vecchio /checkout/stripe?...
        const plan = link.dataset.plan;
        const cfg  = PRICES[plan];
        if (!cfg) { alert("Piano non valido."); return; }

        try {
          const res = await fetch('/functions/v1/create-checkout-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ priceId: cfg.priceId, mode: cfg.mode })
          });

          const { url, error } = await res.json();
          if (error || !url) { alert("Errore pagamento: " + (error || "URL mancante")); return; }
          window.location = url; // redirect alla pagina sicura di Stripe
        } catch (e) {
          alert("Impossibile avviare il pagamento. Riprova.");
        }
      });
    });
  </script>
</body>
</html>
